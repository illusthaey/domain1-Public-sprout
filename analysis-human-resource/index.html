<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>강원도교육청 인사발령 집계/분류</title>

    <!-- ✅ 공통 CSS 유지 -->
    <link rel="stylesheet" href="/static/style.css" />

    <style>
      /* =========================
         이 HTML 전용 보강 스타일
         (공통 /static/style.css 위에 덧씌움)
         ========================= */

      .step-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 0 10px;
      }
      .step-badge {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.95rem;
        color: #fff;
        background: #111;
        flex: 0 0 auto;
      }

      .dropzone {
        margin-top: 12px;
        border: 2px dashed #d4d4d8;
        border-radius: 14px;
        padding: 18px;
        background: #fafafa;
        min-height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: background-color 0.15s ease, border-color 0.15s ease;
        user-select: none;
      }
      .dropzone.dragover {
        background: #eef2ff;
        border-color: #b4b4d0;
      }
      .dropzone strong {
        color: #111;
      }

      .progress-wrap {
        margin-top: 14px;
      }
      .progress-title {
        font-weight: 700;
        color: #111;
        margin-bottom: 8px;
      }
      .progress-bar {
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
        border: 1px solid #e5e5e5;
      }
      .progress-fill {
        width: 0%;
        height: 100%;
        background: #111;
        transition: width 0.1s linear;
      }
      .status-row {
        margin-top: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .file-mini {
        font-size: 0.95rem;
        color: #555;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        font-size: 0.92rem;
        color: #333;
        white-space: nowrap;
      }

      .warn {
        border: 1px solid #f1c0c0;
        background: #fff5f5;
        color: #7a1111;
        padding: 10px 12px;
        border-radius: 12px;
        margin-top: 12px;
        font-size: 0.98rem;
      }

      .ok {
        border: 1px solid #cfe7d1;
        background: #f2fbf3;
        color: #0b5120;
        padding: 10px 12px;
        border-radius: 12px;
        margin-top: 12px;
        font-size: 0.98rem;
      }

      /* ====== 파일 목록 접기 ====== */
      .file-details {
        margin-top: 12px;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        background: #fff;
        padding: 10px 12px;
      }
      .file-details > summary {
        cursor: pointer;
        font-weight: 900;
        color: #111;
        list-style: none;
      }
      .file-details > summary::-webkit-details-marker {
        display: none;
      }
      .file-details > summary::before {
        content: "▸ ";
      }
      .file-details[open] > summary::before {
        content: "▾ ";
      }
      .file-list-wrap {
        margin-top: 10px;
        max-height: 260px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
      }
      .file-list-wrap table {
        min-width: 720px;
        border-collapse: collapse;
      }

      /* ====== KPI ====== */
      .kpi-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        margin-top: 10px;
      }
      .kpi {
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        background: #fff;
        padding: 14px 16px;
        cursor: pointer;
        transition: background-color 0.12s ease;
      }
      .kpi:hover {
        background: #f9fafb;
      }
      .kpi .label {
        font-size: 0.95rem;
        color: #555;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .kpi .value {
        font-size: 1.8rem;
        font-weight: 900;
        color: #111;
        letter-spacing: -0.02em;
      }
      .kpi .hint {
        margin-top: 6px;
        font-size: 0.9rem;
        color: #666;
      }

      .table-scroll {
        max-height: 420px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
      }
      .table-scroll table {
        min-width: 720px;
        border-collapse: collapse;
      }

      .field-label {
        font-size: 0.95rem;
        color: #555;
        font-weight: 700;
        margin-bottom: 6px;
      }
      .grid.four {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .panel-title-row {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .panel-count {
        font-size: 0.95rem;
        color: #666;
        font-weight: 700;
      }

      .mini-note {
        font-size: 0.95rem;
        color: #555;
        margin-top: 8px;
      }

      .records-wrap {
        max-height: 480px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
      }
      .records-wrap table {
        min-width: 980px;
        border-collapse: collapse;
      }

      /* ====== 헤더 틀고정(Sticky) ====== */
      .table-scroll thead th,
      .records-wrap thead th,
      .file-list-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 6;
        background: #f9fafb;
      }

      .to-top {
        position: fixed;
        left: 18px;
        bottom: 18px;
        width: 46px;
        height: 46px;
        border-radius: 999px;
        border: 1px solid #d4d4d8;
        background: #fff;
        font-size: 22px;
        font-weight: 900;
        color: #111;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        z-index: 9999;
      }
      .to-top.show {
        display: inline-flex;
      }

      details.log {
        margin-top: 14px;
      }
      details.log > summary {
        cursor: pointer;
        font-weight: 800;
        color: #111;
      }
      pre.log {
        margin: 10px 0 0;
        padding: 12px;
        border-radius: 12px;
        background: #0b0f17;
        color: #e6edf3;
        overflow: auto;
        font-size: 0.92rem;
        line-height: 1.5;
        max-height: 320px;
      }
    </style>
  </head>

  <body>
    <header class="site-header">
      <div class="shell">
        <h1>강원도교육청 인사발령 집계/분류</h1>
        <p class="subtitle">
          도단위/관내 인사발령 엑셀을 업로드하면 <b>지방공무원·교육공무원·교육공무직</b>을 자동으로 분류/집계합니다.
        </p>
      </div>
    </header>

    <main class="container">
      <!-- =========================
           1) 업로드 섹션
           ========================= -->
      <section id="sec-upload" class="section">
        <div class="step-title">
          <span class="step-badge">1</span>
          <h2 style="margin: 0">인사발령 엑셀파일 업로드</h2>
        </div>

        <p class="sub" style="margin-top: 6px">
          파일은 <b>드래그&드롭</b> 또는 “파일 추가”로 계속 누적 업로드할 수 있습니다. “초기화”로 전부 비웁니다.
        </p>

        <div class="card">
          <div class="row between gap" style="align-items: flex-start">
            <div class="row gap">
              <button class="btn" id="btnAddFiles" type="button">파일 추가</button>
              <button class="btn ghost" id="btnResetFiles" type="button">초기화</button>
            </div>

            <div class="row gap">
              <button class="btn primary" id="btnAnalyze" type="button" disabled>인사정보 집계하기</button>
            </div>
          </div>

          <input id="fileInput" type="file" multiple accept=".xlsx,.xls,.csv" style="display: none" />

          <div id="dropzone" class="dropzone" aria-label="파일 드래그&드롭 영역">
            <div>
              <div style="font-size: 1.05rem; color: #111; font-weight: 800">여기에 엑셀 파일을 드래그해서 올려주세요</div>
              <div class="muted" style="margin-top: 6px">
                지원 확장자: .xlsx / .xls / .csv (여러 개 동시 가능)
              </div>
            </div>
          </div>

          <div class="row between" style="margin-top: 12px">
            <div class="file-mini">
              업로드된 파일: <b id="fileCount">0</b>개
              <span class="muted"> · 중복(이름+용량+수정시간)은 자동으로 건너뜁니다.</span>
            </div>
            <div class="row gap">
              <span class="pill" id="xlsxBadge">XLSX: 로딩 중…</span>
            </div>
          </div>

          <!-- ✅ 파일 목록: 기본 접힘 -->
          <details id="fileDetails" class="file-details">
            <summary id="fileDetailsSummary">업로드한 파일 목록 (0개)</summary>
            <div class="file-list-wrap">
              <table class="sheetlike" id="fileTable">
                <thead>
                  <tr>
                    <th style="min-width: 280px">파일명</th>
                    <th style="min-width: 120px">용량</th>
                    <th style="min-width: 160px">수정</th>
                    <th style="min-width: 90px">삭제</th>
                  </tr>
                </thead>
                <tbody id="fileTableBody">
                  <tr>
                    <td colspan="4" class="muted" style="text-align: center">아직 업로드된 파일이 없습니다.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </details>

          <div class="progress-wrap">
            <div class="progress-title" id="statusTitle">라이브러리(XLSX) 불러오는 중…</div>
            <div class="progress-bar" aria-label="진행 상태바">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-row">
              <div class="muted" id="statusDetail">0%</div>
              <div class="muted" id="statusExtra"></div>
            </div>

            <div id="statusBox" class="muted" style="margin-top: 10px"></div>
          </div>
        </div>
      </section>

      <!-- =========================
           2) 전체 집계 결과
           ========================= -->
      <section id="sec-summary" class="section">
        <div class="row between">
          <div class="step-title" style="margin: 0">
            <span class="step-badge">2</span>
            <h2 style="margin: 0">전체 집계 결과 조회</h2>
          </div>
          <div class="row gap">
            <button class="btn pastel-blue" id="btnDownloadFiltered" type="button" disabled>현재 명단 다운로드</button>
            <button class="btn" id="btnDownloadAll" type="button" disabled>전체 명단 다운로드</button>
          </div>
        </div>

        <p class="sub" style="margin-top: 6px">
          집계는 <b>도·관내 중복(“교육장이 지정하는 부서 근무를 명함” 등)</b>을 자동으로 제거한 결과 기준입니다.
        </p>

        <div class="kpi-grid" id="kpiGrid" aria-label="대시보드 KPI"></div>

        <div class="grid two" style="margin-top: 14px">
          <div>
            <div class="field-label">지역 검색</div>
            <input id="regionSearch" type="text" placeholder="지역 검색 (예: 강릉, 원주)" disabled />
          </div>
          <div>
            <div class="field-label">기관/학교 검색</div>
            <input id="instSearch" type="text" placeholder="기관 검색 (예: 교육지원청, ○○초등학교)" disabled />
          </div>
        </div>

        <div class="grid two" style="margin-top: 12px">
          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">지역별 요약</h3>
              <div class="panel-count" id="regionTableCount">0건</div>
            </div>

            <div class="table-scroll" style="margin-top: 10px">
              <table class="sheetlike" id="regionTable">
                <thead>
                  <tr>
                    <th style="min-width: 180px">지역</th>
                    <th class="numeric" style="min-width: 100px">기관 수</th>
                    <th class="numeric" style="min-width: 100px">전입</th>
                    <th class="numeric" style="min-width: 100px">전출</th>
                    <th class="numeric" style="min-width: 140px">지역변동 없음</th>
                    <th class="numeric" style="min-width: 90px">퇴직</th>
                    <th class="numeric" style="min-width: 90px">인원</th>
                  </tr>
                </thead>
                <tbody id="regionTableBody">
                  <tr>
                    <td colspan="7" class="muted" style="text-align: center">아직 집계 결과가 없습니다.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">기관/학교별 요약</h3>
              <div class="panel-count" id="instTableCount">0건</div>
            </div>

            <div class="table-scroll" style="margin-top: 10px">
              <table class="sheetlike" id="instTable">
                <thead>
                  <tr>
                    <th style="min-width: 160px">지역</th>
                    <th style="min-width: 320px">기관/학교명</th>
                    <th class="numeric" style="min-width: 90px">전입</th>
                    <th class="numeric" style="min-width: 90px">전출</th>
                    <th class="numeric" style="min-width: 90px">인원</th>
                  </tr>
                </thead>
                <tbody id="instTableBody">
                  <tr>
                    <td colspan="5" class="muted" style="text-align: center">아직 집계 결과가 없습니다.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row gap" style="margin-top: 12px; flex-wrap: wrap">
          <button class="btn" id="btnGoEntity" type="button" disabled>학교/기관별 집계로 바로가기</button>
          <button class="btn" id="btnGoRegion" type="button" disabled>지역별 집계로 바로가기</button>
        </div>
      </section>

      <!-- =========================
           3) 상세 내역 (학교/기관)
           ========================= -->
      <section id="sec-entity" class="section">
        <div class="step-title">
          <span class="step-badge">3</span>
          <h2 style="margin: 0">상세 내역 조회 (학교 및 기관별)</h2>
        </div>

        <p class="sub" style="margin-top: 6px">
          드롭박스를 앞에서부터 선택할수록 상세 결과가 자동 갱신됩니다. (항상 오름차순 정렬)
        </p>

        <div class="grid four">
          <div class="field">
            <div class="field-label">1) 구분</div>
            <select id="entityKind" disabled>
              <option value="">선택</option>
              <option value="school">학교</option>
              <option value="inst">기관</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">2) 학교/기관</div>
            <select id="entityName" disabled>
              <option value="">먼저 1) 구분을 선택하세요</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">3) 인사 구분</div>
            <select id="personnelType" disabled>
              <option value="">먼저 2) 학교/기관을 선택하세요</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">4) 직렬/직급/직종</div>
            <select id="jobFilter" disabled>
              <option value="">먼저 3) 인사 구분을 선택하세요</option>
            </select>
          </div>
        </div>

        <!-- ✅ 전출/전입 패널: 위아래 배치 -->
        <div class="card" style="margin-top: 12px">
          <div class="panel-title-row">
            <h3 style="margin: 0">전출자 / 퇴직자</h3>
            <div class="panel-count" id="entityOutCount">0명</div>
          </div>
          <div id="entityOutPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
        </div>

        <div class="card">
          <div class="panel-title-row">
            <h3 style="margin: 0">전입자 / 신규 / 파견</h3>
            <div class="panel-count" id="entityInCount">0명</div>
          </div>
          <div id="entityInPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
        </div>

        <details class="card" id="entityUnknownDetails" style="margin-top: 12px" open>
          <summary style="font-weight: 900; cursor: pointer" id="entityUnknownSummary">미분류 (0명)</summary>
          <div id="entityUnknownPanel" class="muted" style="margin-top: 10px">조회 조건을 선택하면 여기에 표시됩니다.</div>
        </details>

        <div class="mini-note">
          ※ 병설유치원은 원소속 학교로 자동 합산합니다. (예: “동내초등학교 및 병설유치원”)
        </div>
      </section>

      <!-- =========================
           4) 상세 발령 내역 (시군구)
           ========================= -->
      <section id="sec-region" class="section">
        <div class="row between" style="align-items: flex-start">
          <div class="step-title" style="margin: 0">
            <span class="step-badge">4</span>
            <h2 style="margin: 0">상세 발령 내역 (시군구별 조회)</h2>
          </div>

          <div class="row gap">
            <button class="btn" id="btnExportRegionView" type="button" disabled>조회 결과 엑셀로 다운로드</button>
          </div>
        </div>

        <p class="sub" style="margin-top: 6px">
          “속초/양양”은 <b>속초양양</b>으로 통합 집계합니다. “강원도교육청”은 분리/춘천합산을 선택할 수 있습니다.
        </p>

        <div class="grid three">
          <div class="field">
            <div class="field-label">1) 강원도교육청 처리</div>
            <select id="officeMode" disabled>
              <option value="">선택</option>
              <option value="separate">강원도교육청 분리</option>
              <option value="merge">강원도교육청을 춘천에 합산</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">2) 지역 선택</div>
            <select id="regionPick" disabled>
              <option value="">먼저 1) 처리 방식을 선택하세요</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">3) 인사 구분</div>
            <select id="regionPersonnelType" disabled>
              <option value="">먼저 2) 지역을 선택하세요</option>
            </select>
          </div>
        </div>

        <div class="grid three" style="margin-top: 12px">
          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">전출자 / 퇴직자</h3>
              <div class="panel-count" id="regionOutCount">0명</div>
            </div>
            <div id="regionOutPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">전입자 / 신규</h3>
              <div class="panel-count" id="regionInCount">0명</div>
            </div>
            <div id="regionInPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">지역변동 없음</h3>
              <div class="panel-count" id="regionStayCount">0명</div>
            </div>
            <div id="regionStayPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>
        </div>

        <details class="card" id="regionUnknownDetails" style="margin-top: 12px">
          <summary style="font-weight: 900; cursor: pointer" id="regionUnknownSummary">미분류 (0명)</summary>
          <div id="regionUnknownPanel" class="muted" style="margin-top: 10px">조회 조건을 선택하면 여기에 표시됩니다.</div>
        </details>
      </section>

      <!-- 로그 -->
      <details class="log section">
        <summary>시스템 처리 로그 보기</summary>
        <pre class="log" id="logBox"></pre>
      </details>
    </main>

    <button id="toTopBtn" class="to-top" type="button" aria-label="페이지 상단으로">↑</button>

    <footer class="site-footer">
      <div class="shell">
        <p>※ 본 페이지는 업로드한 엑셀 파일을 브라우저에서만 분석합니다. (서버 업로드 없이 로컬 처리)</p>
      </div>
    </footer>

    <!-- =========================
         강원도 내 전체 학교 목록(내장)
         - 업로드 없이 항상 사용 가능
         - 항목: { n: 학교이름, r: 시군구(속초/양양은 속초양양) }
         ========================= -->
    <script>
      const GW_SCHOOL_MASTER_ROWS = [{"n":"가곡고등학교","r":"삼척"},{"n":"가곡중학교","r":"삼척"},{"n":"가람유치원","r":"춘천"},{"n":"가산초등학교","r":"춘천"},{"n":"가온유치원","r":"강릉"},{"n":"가정중학교","r":"춘천"},{"n":"간동고등학교","r":"화천"},{"n":"간동중학교","r":"화천"},{"n":"간성초등학교","r":"고성"},{"n":"간성초병설유치원","r":"고성"},{"n":"갈래초등학교","r":"정선"},{"n":"갈래초병설유치원","r":"정선"},{"n":"갑천고등학교","r":"횡성"},{"n":"갑천중학교","r":"횡성"},{"n":"갑천초등학교","r":"횡성"},{"n":"갑천초병설유치원","r":"횡성"},{"n":"강동초등학교","r":"강릉"},{"n":"강동초병설유치원","r":"강릉"},{"n":"강룡사유치원","r":"홍천"},{"n":"강릉고등학교","r":"강릉"},{"n":"강릉명륜고등학교","r":"강릉"},{"n":"강릉문성고등학교","r":"강릉"},{"n":"강릉여자고등학교","r":"강릉"},{"n":"강릉오성학교","r":"강릉"},{"n":"강릉원주대부설유치원","r":"원주"},{"n":"강릉유치원","r":"강릉"},{"n":"강릉정보공업고등학교","r":"강릉"},{"n":"강릉제일고등학교","r":"강릉"},{"n":"강릉중앙고등학교","r":"강릉"},{"n":"강릉중학교","r":"강릉"},{"n":"강릉초등학교","r":"강릉"},{"n":"강릉초병설유치원","r":"강릉"},{"n":"강릉해람중학교","r":"강릉"},{"n":"강림중학교","r":"횡성"},{"n":"강림초등학교","r":"횡성"},{"n":"강서중학교","r":"춘천"},{"n":"강원고등학교","r":"춘천"},{"n":"강원과학고등학교","r":"원주"},{"n":"강원대학교사범대학부설고등학교","r":"춘천"},{"n":"강원명진학교","r":"춘천"},{"n":"강원생활과학고등학교","r":"홍천"},{"n":"강원애니고등학교","r":"춘천"},{"n":"강원예술고등학교","r":"강릉"},{"n":"강원온라인학교","r":"원주"},{"n":"강원외국어고등학교","r":"양구"},{"n":"강원중학교","r":"춘천"},{"n":"강원체육고등학교","r":"춘천"},{"n":"강원체육중학교","r":"춘천"},{"n":"강일여자고등학교","r":"강릉"},{"n":"강현중학교","r":"속초양양"},{"n":"강현초등학교","r":"속초양양"},{"n":"강현초병설유치원","r":"속초양양"},{"n":"거문초등학교","r":"평창"},{"n":"거문초병설유치원","r":"평창"},{"n":"거성초등학교","r":"고성"},{"n":"거성초병설유치원","r":"고성"},{"n":"거진고등학교","r":"고성"},{"n":"거진중학교","r":"고성"},{"n":"거진초등학교","r":"고성"},{"n":"거진초병설유치원","r":"고성"},{"n":"경포고등학교","r":"강릉"},{"n":"경포대초등학교","r":"강릉"},{"n":"경포대초병설유치원","r":"강릉"},{"n":"경포유치원","r":"강릉"},{"n":"경포중학교","r":"강릉"},{"n":"경포초등학교","r":"강릉"},{"n":"계촌중학교","r":"평창"},{"n":"계촌초등학교","r":"평창"},{"n":"계촌초병설유치원","r":"평창"},{"n":"고산초등학교","r":"원주"},{"n":"고산초병설유치원","r":"원주"},{"n":"고성고등학교","r":"고성"},{"n":"고성중학교","r":"고성"},{"n":"고한고등학교","r":"정선"},{"n":"고한중학교","r":"정선"},{"n":"고한초등학교","r":"정선"},{"n":"고한초병설유치원","r":"정선"},{"n":"공근중학교","r":"횡성"},{"n":"공근초등학교","r":"횡성"},{"n":"공근초병설유치원","r":"횡성"},{"n":"공현진초등학교","r":"고성"},{"n":"공현진초병설유치원","r":"고성"},{"n":"관동중학교","r":"강릉"},{"n":"관설초등학교","r":"원주"},{"n":"광덕초등학교","r":"화천"},{"n":"광덕초병설유치원","r":"화천"},{"n":"광산초등학교","r":"고성"},{"n":"광산초병설유치원","r":"고성"},{"n":"광정초등학교","r":"속초양양"},{"n":"광정초병설유치원","r":"속초양양"},{"n":"광판중학교","r":"춘천"},{"n":"광판초등학교","r":"춘천"},{"n":"광판초병설유치원","r":"춘천"},{"n":"교동초등학교(강릉)","r":"강릉"},{"n":"교동초등학교(속초)","r":"속초양양"},{"n":"교동초등학교(원주)","r":"원주"},{"n":"교동초등학교(춘천)","r":"춘천"},{"n":"교동초병설유치원(강릉)","r":"강릉"},{"n":"교동초병설유치원(원주)","r":"원주"},{"n":"교동초병설유치원(춘천)","r":"춘천"},{"n":"교학초등학교","r":"원주"},{"n":"구곡초등학교","r":"원주"},{"n":"구곡초병설유치원","r":"원주"},{"n":"구래초등학교","r":"영월"},{"n":"구송초등학교","r":"홍천"},{"n":"구송초병설유치원","r":"홍천"},{"n":"구정초등학교","r":"강릉"},{"n":"구정초병설유치원","r":"강릉"},{"n":"귀둔초등학교","r":"인제"},{"n":"귀둔초병설유치원","r":"인제"},{"n":"귀래중학교","r":"원주"},{"n":"귀래초등학교","r":"원주"},{"n":"그린나래유치원","r":"원주"},{"n":"근남초등학교","r":"철원"},{"n":"근남초병설유치원","r":"철원"},{"n":"근덕중학교","r":"삼척"},{"n":"근덕초등학교","r":"삼척"},{"n":"근화초등학교","r":"춘천"},{"n":"금광초등학교","r":"강릉"},{"n":"금광초병설유치원","r":"강릉"},{"n":"금대초등학교","r":"원주"},{"n":"금병초등학교","r":"춘천"},{"n":"금빛유치원","r":"원주"},{"n":"금산초등학교","r":"춘천"},{"n":"금산초병설유치원","r":"춘천"},{"n":"기린고등학교","r":"인제"},{"n":"기린중학교","r":"인제"},{"n":"기린초등학교","r":"인제"},{"n":"기린초병설유치원","r":"인제"},{"n":"기린초진동분교장","r":"인제"},{"n":"김화고등학교","r":"철원"},{"n":"김화여자중학교","r":"철원"},{"n":"김화중학교","r":"철원"},{"n":"김화초등학교","r":"철원"},{"n":"김화초병설유치원","r":"철원"},{"n":"꿈나무유치원","r":"춘천"},{"n":"꿈에그린유치원","r":"춘천"},{"n":"나래유치원","r":"철원"},{"n":"나영유치원","r":"원주"},{"n":"나전중학교","r":"정선"},{"n":"낙산유치원","r":"속초양양"},{"n":"남강초등학교","r":"강릉"},{"n":"남부초등학교","r":"춘천"},{"n":"남산초등학교(강릉)","r":"강릉"},{"n":"남산초등학교(춘천)","r":"춘천"},{"n":"남산초등학교(홍천)","r":"홍천"},{"n":"남산초병설유치원(강릉)","r":"강릉"},{"n":"남산초병설유치원(춘천)","r":"춘천"},{"n":"남산초서천분교장","r":"춘천"},{"n":"남선초등학교","r":"정선"},{"n":"남선초병설유치원","r":"정선"},{"n":"남애초등학교","r":"속초양양"},{"n":"남애초병설유치원","r":"속초양양"},{"n":"남원주중학교","r":"원주"},{"n":"남원주초등학교","r":"원주"},{"n":"남원주초병설유치원","r":"원주"},{"n":"남춘천여자중학교","r":"춘천"},{"n":"남춘천중학교","r":"춘천"},{"n":"남춘천초등학교","r":"춘천"},{"n":"남평초등학교","r":"정선"},{"n":"남평초병설유치원","r":"정선"},{"n":"남호초등학교","r":"동해"},{"n":"남호초병설유치원","r":"동해"},{"n":"내대초등학교","r":"철원"},{"n":"내대초병설유치원","r":"철원"},{"n":"내면고등학교","r":"홍천"},{"n":"내면중학교","r":"홍천"},{"n":"내성초등학교","r":"영월"},{"n":"내성초병설유치원","r":"영월"},{"n":"내촌중학교","r":"홍천"},{"n":"내촌초등학교","r":"홍천"},{"n":"내촌초병설유치원","r":"홍천"},{"n":"너브내유치원","r":"홍천"},{"n":"노란유치원","r":"삼척"},{"n":"노암초등학교","r":"강릉"},{"n":"노암초병설유치원","r":"강릉"},{"n":"노천초등학교","r":"홍천"},{"n":"녹전중학교","r":"영월"},{"n":"녹전초등학교","r":"영월"},{"n":"녹전초병설유치원","r":"영월"},{"n":"늘해랑유치원","r":"강릉"},{"n":"다목초등학교","r":"화천"},{"n":"다목초병설유치원","r":"화천"},{"n":"다솔유치원","r":"삼척"},{"n":"다인유치원","r":"강릉"},{"n":"단계초등학교","r":"원주"},{"n":"단계초병설유치원","r":"원주"},{"n":"단관초등학교","r":"원주"},{"n":"단관초병설유치원","r":"원주"},{"n":"단구중학교","r":"원주"},{"n":"단구초등학교","r":"원주"},{"n":"단구초병설유치원","r":"원주"},{"n":"당림초등학교","r":"춘천"},{"n":"당림초병설유치원","r":"춘천"},{"n":"대곡초등학교","r":"홍천"},{"n":"대곡초병설유치원","r":"홍천"},{"n":"대관령중학교","r":"평창"},{"n":"대관령초등학교","r":"평창"},{"n":"대동여자중학교","r":"횡성"},{"n":"대동유치원","r":"동해"},{"n":"대룡중학교","r":"춘천"},{"n":"대성고등학교","r":"원주"},{"n":"대성중학교","r":"원주"},{"n":"대암중학교","r":"양구"},{"n":"대진고등학교","r":"고성"},{"n":"대진중학교","r":"고성"},{"n":"대진초등학교","r":"고성"},{"n":"대진초병설유치원","r":"고성"},{"n":"대포초등학교","r":"속초양양"},{"n":"대포초병설유치원","r":"속초양양"},{"n":"대화고등학교","r":"평창"},{"n":"대화중학교","r":"평창"},{"n":"대화초등학교","r":"평창"},{"n":"도계고등학교","r":"삼척"},{"n":"도계전산정보고등학교","r":"삼척"},{"n":"도계중학교","r":"삼척"},{"n":"도계초등학교","r":"삼척"},{"n":"도계한빛유치원","r":"삼척"},{"n":"도담유치원","r":"원주"},{"n":"도성초등학교","r":"평창"},{"n":"도성초병설유치원","r":"평창"},{"n":"도창초등학교","r":"철원"},{"n":"도촌초등학교","r":"양구"},{"n":"도촌초병설유치원","r":"양구"},{"n":"도학초등학교","r":"고성"},{"n":"동광산업과학고등학교","r":"고성"},{"n":"동광중학교","r":"고성"},{"n":"동광초등학교","r":"고성"},{"n":"동광초병설유치원","r":"고성"},{"n":"동내초등학교","r":"춘천"},{"n":"동내초병설유치원","r":"춘천"},{"n":"동명중학교","r":"강릉"},{"n":"동명초등학교","r":"강릉"},{"n":"동부초등학교","r":"춘천"},{"n":"동산중학교","r":"춘천"},{"n":"동송초등학교","r":"철원"},{"n":"동점초등학교","r":"태백"},{"n":"동춘천초등학교","r":"춘천"},{"n":"동해광희고등학교","r":"동해"},{"n":"동해광희중학교","r":"동해"},{"n":"동해랑유치원","r":"동해"},{"n":"동해삼육고등학교","r":"동해"},{"n":"동해삼육중학교","r":"동해"},{"n":"동해삼육초등학교","r":"동해"},{"n":"동해상업고등학교","r":"동해"},{"n":"동해중앙초등학교","r":"동해"},{"n":"동해중앙초병설유치원","r":"동해"},{"n":"동해중학교","r":"동해"},{"n":"동해초등학교","r":"동해"},{"n":"동해초병설유치원","r":"동해"},{"n":"동해해솔학교","r":"동해"},{"n":"동호초등학교","r":"동해"},{"n":"동화나라유치원","r":"원주"},{"n":"동화중학교","r":"속초양양"},{"n":"동화초등학교","r":"원주"},{"n":"동화초병설유치원","r":"원주"},{"n":"두란노유치원","r":"춘천"},{"n":"두촌중학교","r":"홍천"},{"n":"두촌초등학교","r":"홍천"},{"n":"두촌초병설유치원","r":"홍천"},{"n":"둔내고등학교","r":"횡성"},{"n":"둔내중학교","r":"횡성"},{"n":"둔내초등학교","r":"횡성"},{"n":"둔내초병설유치원","r":"횡성"},{"n":"둔둔초등학교","r":"원주"},{"n":"둔둔초병설유치원","r":"원주"},{"n":"리라유치원(동해)","r":"동해"},{"n":"마야유치원","r":"홍천"},{"n":"마차고등학교","r":"영월"},{"n":"마차중학교","r":"영월"},{"n":"마차초등학교","r":"영월"},{"n":"마차초병설유치원","r":"영월"},{"n":"만대초등학교","r":"원주"},{"n":"만종초등학교","r":"원주"},{"n":"만종초병설유치원","r":"원주"},{"n":"만천유치원","r":"춘천"},{"n":"만천초등학교","r":"춘천"},{"n":"망상초등학교","r":"동해"},{"n":"매산초등학교","r":"홍천"},{"n":"매산초병설유치원","r":"홍천"},{"n":"매지초등학교","r":"원주"},{"n":"맹방초등학교","r":"삼척"},{"n":"맹방초병설유치원","r":"삼척"},{"n":"메밀꽃유치원","r":"평창"},{"n":"면온초등학교","r":"평창"},{"n":"면온초병설유치원","r":"평창"},{"n":"명덕초등학교","r":"홍천"},{"n":"명덕초병설유치원","r":"홍천"},{"n":"명륜초등학교","r":"원주"},{"n":"명륜초병설유치원","r":"원주"},{"n":"명문유치원","r":"춘천"},{"n":"명주초등학교","r":"강릉"},{"n":"명주초병설유치원","r":"강릉"},{"n":"모곡초등학교","r":"홍천"},{"n":"모산초등학교","r":"강릉"},{"n":"모산초병설유치원","r":"강릉"},{"n":"묘장초등학교","r":"철원"},{"n":"무궁화유치원","r":"춘천"},{"n":"무릉초등학교","r":"영월"},{"n":"무릉초병설유치원","r":"영월"},{"n":"무실빛유치원","r":"원주"},{"n":"무실초등학교","r":"원주"},{"n":"무실초병설유치원","r":"원주"},{"n":"무지개유치원","r":"동해"},{"n":"묵호고등학교","r":"동해"},{"n":"묵호중학교","r":"동해"},{"n":"묵호초등학교","r":"동해"},{"n":"문곡중학교","r":"정선"},{"n":"문막고등학교","r":"원주"},{"n":"문막성모유치원","r":"원주"},{"n":"문막중학교","r":"원주"},{"n":"문막초등학교","r":"원주"},{"n":"문막초병설유치원","r":"원주"},{"n":"문혜초등학교","r":"철원"},{"n":"문혜초병설유치원","r":"철원"},{"n":"미동초등학교","r":"태백"},{"n":"미라유치원","r":"삼척"},{"n":"미래고등학교","r":"원주"},{"n":"미래숲유치원","r":"춘천"},{"n":"미로중학교","r":"삼척"},{"n":"미로초등학교","r":"삼척"},{"n":"미로초병설유치원","r":"삼척"},{"n":"미탄중학교","r":"평창"},{"n":"미탄초등학교","r":"평창"},{"n":"미탄초병설유치원","r":"평창"},{"n":"민족사관고등학교","r":"횡성"},{"n":"반계초등학교","r":"원주"},{"n":"반계초병설유치원","r":"원주"},{"n":"반곡드림유치원","r":"원주"},{"n":"반곡별유치원","r":"원주"},{"n":"반곡중학교","r":"원주"},{"n":"반곡초등학교(원주)","r":"원주"},{"n":"반곡초등학교(홍천)","r":"홍천"},{"n":"반곡초병설유치원(원주)","r":"원주"},{"n":"반야유치원","r":"정선"},{"n":"방림초등학교","r":"평창"},{"n":"방림초병설유치원","r":"평창"},{"n":"방산중학교","r":"양구"},{"n":"방산초등학교","r":"양구"},{"n":"방산초병설유치원","r":"양구"},{"n":"백전초등학교","r":"정선"},{"n":"버들중학교","r":"원주"},{"n":"버들초등학교","r":"원주"},{"n":"버들초병설유치원","r":"원주"},{"n":"벽탄초등학교","r":"정선"},{"n":"보덕유치원","r":"영월"},{"n":"봄내중학교","r":"춘천"},{"n":"봄내초등학교","r":"춘천"},{"n":"봄봄유치원","r":"춘천"},{"n":"봉대가온학교","r":"원주"},{"n":"봉대초등학교","r":"원주"},{"n":"봉대초병설유치원","r":"원주"},{"n":"봉래중학교","r":"영월"},{"n":"봉래초등학교","r":"영월"},{"n":"봉래초병설유치원","r":"영월"},{"n":"봉양초등학교","r":"정선"},{"n":"봉의고등학교","r":"춘천"},{"n":"봉의중학교","r":"춘천"},{"n":"봉의초등학교","r":"춘천"},{"n":"봉의초병설유치원","r":"춘천"},{"n":"봉평고등학교","r":"평창"},{"n":"봉평중학교","r":"평창"},{"n":"봉평초등학교","r":"평창"},{"n":"봉화산숲유치원","r":"원주"},{"n":"부론중학교","r":"원주"},{"n":"부론초등학교","r":"원주"},{"n":"부안초등학교","r":"춘천"},{"n":"부평초등학교","r":"인제"},{"n":"부평초병설유치원","r":"인제"},{"n":"북삼초등학교","r":"동해"},{"n":"북원여자고등학교","r":"원주"},{"n":"북원중학교","r":"원주"},{"n":"북원초등학교","r":"원주"},{"n":"북원초병설유치원","r":"원주"},{"n":"북평고등학교","r":"동해"},{"n":"북평여자고등학교","r":"동해"},{"n":"북평중학교","r":"동해"},{"n":"북평초등학교(동해)","r":"동해"},{"n":"북평초등학교(정선)","r":"정선"},{"n":"비두초등학교","r":"원주"},{"n":"비두초병설유치원","r":"원주"},{"n":"비봉초등학교","r":"양구"},{"n":"비봉초병설유치원","r":"양구"},{"n":"사내고등학교","r":"화천"},{"n":"사내중학교","r":"화천"},{"n":"사내초등학교","r":"화천"},{"n":"사내초병설유치원","r":"화천"},{"n":"사북고등학교","r":"정선"},{"n":"사북중학교","r":"정선"},{"n":"사북초등학교","r":"정선"},{"n":"사북초병설유치원","r":"정선"},{"n":"사천중학교","r":"강릉"},{"n":"사천초등학교","r":"강릉"},{"n":"사천초병설유치원","r":"강릉"},{"n":"산내들유치원","r":"원주"},{"n":"산양초등학교","r":"화천"},{"n":"산양초병설유치원","r":"화천"},{"n":"산현초등학교","r":"원주"},{"n":"산호유치원","r":"속초양양"},{"n":"삼생초등학교","r":"홍천"},{"n":"삼생초병설유치원","r":"홍천"},{"n":"삼성초등학교","r":"태백"},{"n":"삼성초병설유치원","r":"태백"},{"n":"삼운사유치원","r":"춘천"},{"n":"삼일고등학교","r":"삼척"},{"n":"삼일중학교","r":"삼척"},{"n":"삼척고등학교","r":"삼척"},{"n":"삼척남초등학교","r":"동해"},{"n":"삼척누리유치원","r":"동해"},{"n":"삼척여자고등학교","r":"삼척"},{"n":"삼척중앙초등학교","r":"삼척"},{"n":"삼척중학교","r":"삼척"},{"n":"삼척초등학교","r":"삼척"},{"n":"삼포초등학교","r":"홍천"},{"n":"삼포초병설유치원","r":"홍천"},{"n":"삼화초등학교","r":"동해"},{"n":"삼화초병설유치원","r":"동해"},{"n":"상남중학교","r":"인제"},{"n":"상남초등학교","r":"인제"},{"n":"상남초병설유치원","r":"인제"},{"n":"상동고등학교","r":"영월"},{"n":"상동중학교","r":"영월"},{"n":"상서중학교","r":"화천"},{"n":"상승초등학교","r":"화천"},{"n":"상승초병설유치원","r":"화천"},{"n":"상장중학교","r":"태백"},{"n":"상장초등학교","r":"태백"},{"n":"상지대관령고등학교","r":"평창"},{"n":"상지여자고등학교","r":"원주"},{"n":"상지여자중학교","r":"원주"},{"n":"상천초등학교","r":"춘천"},{"n":"상천초병설유치원","r":"춘천"},{"n":"상평초공수전분교장","r":"속초양양"},{"n":"상평초등학교","r":"속초양양"},{"n":"상평초병설유치원","r":"속초양양"},{"n":"상평초오색분교장","r":"속초양양"},{"n":"새들유치원","r":"철원"},{"n":"새봄유치원","r":"춘천"},{"n":"샘마루초등학교","r":"원주"},{"n":"샘마루초병설유치원","r":"원주"},{"n":"서곡초등학교","r":"원주"},{"n":"서곡초병설유치원","r":"원주"},{"n":"서면초등학교","r":"철원"},{"n":"서면초병설유치원","r":"철원"},{"n":"서부초등학교","r":"삼척"},{"n":"서상초등학교","r":"춘천"},{"n":"서상초병설유치원","r":"춘천"},{"n":"서석고등학교","r":"홍천"},{"n":"서석중학교","r":"홍천"},{"n":"서석초등학교","r":"홍천"},{"n":"서석초병설유치원","r":"홍천"},{"n":"서석초청량분교장","r":"홍천"},{"n":"서석초청량분교장병설유치원","r":"홍천"},{"n":"서원주초등학교","r":"원주"},{"n":"서원주초병설유치원","r":"원주"},{"n":"서원중학교","r":"횡성"},{"n":"서원초등학교","r":"횡성"},{"n":"서원초병설유치원","r":"횡성"},{"n":"서화중학교","r":"인제"},{"n":"서화초등학교","r":"인제"},{"n":"서화초병설유치원","r":"인제"},{"n":"석사초등학교","r":"춘천"},{"n":"석정여자고등학교","r":"영월"},{"n":"석정여자중학교","r":"영월"},{"n":"석천중학교","r":"양구"},{"n":"석화초등학교","r":"홍천"},{"n":"설악고등학교","r":"속초양양"},{"n":"설악중학교","r":"속초양양"},{"n":"설악초등학교","r":"속초양양"},{"n":"설악초병설유치원","r":"속초양양"},{"n":"설온중학교","r":"속초양양"},{"n":"섬강고등학교","r":"원주"},{"n":"섬강중학교","r":"원주"},{"n":"섬강초등학교","r":"원주"},{"n":"섬강초병설유치원","r":"원주"},{"n":"섬머힐유치원","r":"춘천"},{"n":"성균관유치원","r":"원주"},{"n":"성남초등학교","r":"횡성"},{"n":"성남초병설유치원","r":"횡성"},{"n":"성덕초등학교","r":"강릉"},{"n":"성림초등학교","r":"춘천"},{"n":"성모유치원","r":"횡성"},{"n":"성무유치원","r":"원주"},{"n":"성북초등학교","r":"횡성"},{"n":"성북초병설유치원","r":"횡성"},{"n":"성불유치원","r":"원주"},{"n":"성산초등학교","r":"강릉"},{"n":"성산초병설유치원","r":"강릉"},{"n":"성수고등학교","r":"춘천"},{"n":"성수여자고등학교","r":"춘천"},{"n":"성심유치원","r":"춘천"},{"n":"성원유치원","r":"강릉"},{"n":"성원초등학교","r":"춘천"},{"n":"성호유치원","r":"동해"},{"n":"세연중학교","r":"태백"},{"n":"소야초등학교","r":"속초양양"},{"n":"소야초병설유치원","r":"속초양양"},{"n":"소양중학교","r":"춘천"},{"n":"소양초등학교","r":"춘천"},{"n":"소초초등학교","r":"원주"},{"n":"소초초병설유치원","r":"원주"},{"n":"소화유치원","r":"강릉"},{"n":"속사초등학교","r":"평창"},{"n":"속사초병설유치원","r":"평창"},{"n":"속초고등학교","r":"속초양양"},{"n":"속초여자고등학교","r":"속초양양"},{"n":"속초유치원","r":"속초양양"},{"n":"속초중학교","r":"속초양양"},{"n":"속초청해학교","r":"속초양양"},{"n":"속초초등학교(속초)","r":"속초양양"},{"n":"속초초등학교(홍천)","r":"속초양양"},{"n":"속초초병설유치원","r":"속초양양"},{"n":"속초해랑중학교","r":"속초양양"},{"n":"손양초등학교","r":"속초양양"},{"n":"손양초병설유치원","r":"속초양양"},{"n":"솔빛유치원","r":"동해"},{"n":"솔샘초등학교","r":"원주"},{"n":"솔샘초병설유치원","r":"원주"},{"n":"솔올중학교","r":"강릉"},{"n":"솔향유치원","r":"강릉"},{"n":"송양초등학교","r":"강릉"},{"n":"송이유치원","r":"원주"},{"n":"송정초등학교","r":"동해"},{"n":"송포초등학교","r":"속초양양"},{"n":"송포초병설유치원","r":"속초양양"},{"n":"송화초등학교","r":"춘천"},{"n":"송화초병설유치원","r":"춘천"},{"n":"수백초등학교","r":"횡성"},{"n":"수백초병설유치원","r":"횡성"},{"n":"숲실초등학교","r":"강릉"},{"n":"스마트유치원","r":"원주"},{"n":"신남고등학교","r":"인제"},{"n":"신남중학교","r":"인제"},{"n":"신남초등학교","r":"춘천"},{"n":"신동초등학교(삼척)","r":"삼척"},{"n":"신동초등학교(춘천)","r":"춘천"},{"n":"신동초병설유치원(춘천)","r":"춘천"},{"n":"신리초등학교","r":"평창"},{"n":"신림중학교","r":"원주"},{"n":"신림초등학교","r":"원주"},{"n":"신영초등학교","r":"강릉"},{"n":"신영초병설유치원","r":"강릉"},{"n":"신왕초등학교","r":"강릉"},{"n":"신왕초병설유치원","r":"강릉"},{"n":"신천초등학교","r":"영월"},{"n":"신천초병설유치원","r":"영월"},{"n":"신철원고등학교","r":"철원"},{"n":"신철원중학교","r":"철원"},{"n":"신철원초등학교","r":"철원"},{"n":"신철원초병설유치원","r":"철원"},{"n":"신평초등학교","r":"원주"},{"n":"신평초병설유치원","r":"원주"},{"n":"신포중학교","r":"춘천"},{"n":"실내초등학교","r":"화천"},{"n":"실내초병설유치원","r":"화천"},{"n":"쌍룡중학교","r":"영월"},{"n":"쌍룡초등학교","r":"영월"},{"n":"쌍룡초병설유치원","r":"영월"},{"n":"아야진초등학교","r":"고성"},{"n":"안미초등학교","r":"평창"},{"n":"안미초병설유치원","r":"평창"},{"n":"안흥고등학교","r":"횡성"},{"n":"안흥중학교","r":"횡성"},{"n":"안흥초덕천분교장","r":"횡성"},{"n":"안흥초등학교","r":"횡성"},{"n":"양구고등학교","r":"양구"},{"n":"양구여자고등학교","r":"양구"},{"n":"양구중학교","r":"양구"},{"n":"양구초등학교","r":"양구"},{"n":"양구초병설유치원","r":"양구"},{"n":"양덕중학교","r":"홍천"},{"n":"양양고등학교","r":"속초양양"},{"n":"양양중학교","r":"속초양양"},{"n":"양양초등학교","r":"속초양양"},{"n":"양양초병설유치원","r":"속초양양"},{"n":"어론초등학교","r":"인제"},{"n":"여량고등학교","r":"정선"},{"n":"여량중학교","r":"정선"},{"n":"여량초등학교","r":"정선"},{"n":"여량초병설유치원","r":"정선"},{"n":"연곡초등학교","r":"강릉"},{"n":"연곡초병설유치원","r":"강릉"},{"n":"연당중학교","r":"영월"},{"n":"연당초등학교","r":"영월"},{"n":"연당초병설유치원","r":"영월"},{"n":"열린유치원","r":"춘천"},{"n":"영동초등학교","r":"강릉"},{"n":"영동초병설유치원","r":"강릉"},{"n":"영랑초등학교","r":"속초양양"},{"n":"영서고등학교","r":"원주"},{"n":"영월고등학교","r":"영월"},{"n":"영월유치원","r":"영월"},{"n":"영월중학교","r":"영월"},{"n":"영월초등학교","r":"영월"},{"n":"영지유치원","r":"원주"},{"n":"예그랑유치원","r":"원주"},{"n":"예람중학교","r":"동해"},{"n":"예미초등학교","r":"정선"},{"n":"예미초병설유치원","r":"정선"},{"n":"예미초운치분교장","r":"정선"},{"n":"예원유치원","r":"춘천"},{"n":"예지유치원","r":"원주"},{"n":"예초유치원","r":"춘천"},{"n":"오덕초등학교","r":"철원"},{"n":"오동초등학교","r":"춘천"},{"n":"오동초병설유치원","r":"춘천"},{"n":"오안초등학교","r":"홍천"},{"n":"오저초등학교","r":"삼척"},{"n":"오저초병설유치원","r":"삼척"},{"n":"오호초등학교","r":"고성"},{"n":"오호초병설유치원","r":"고성"},{"n":"옥계중학교","r":"강릉"},{"n":"옥계초금진분교장","r":"강릉"},{"n":"옥계초금진분교장병설유치원","r":"강릉"},{"n":"옥계초등학교","r":"강릉"},{"n":"옥계초병설유치원","r":"강릉"},{"n":"옥동중학교","r":"영월"},{"n":"옥동초등학교","r":"영월"},{"n":"옥동초병설유치원","r":"영월"},{"n":"옥천초등학교","r":"강릉"},{"n":"옥천초병설유치원","r":"강릉"},{"n":"온의유치원","r":"춘천"},{"n":"온정초등학교","r":"속초양양"},{"n":"온정초병설유치원","r":"속초양양"},{"n":"와수초등학교","r":"철원"},{"n":"와수초병설유치원","r":"철원"},{"n":"왕산중학교","r":"강릉"},{"n":"왕산초등학교","r":"강릉"},{"n":"왕산초병설유치원","r":"강릉"},{"n":"용대초등학교","r":"인제"},{"n":"용대초병설유치원","r":"인제"},{"n":"용암초등학교","r":"화천"},{"n":"용암초병설유치원","r":"화천"},{"n":"용전중학교","r":"평창"},{"n":"용정초등학교","r":"철원"},{"n":"용하중학교","r":"양구"},{"n":"용하초등학교","r":"양구"},{"n":"용하초병설유치원","r":"양구"},{"n":"우리유치원","r":"춘천"},{"n":"우산초등학교","r":"원주"},{"n":"우산초병설유치원","r":"원주"},{"n":"우석중학교","r":"춘천"},{"n":"우석초등학교","r":"춘천"},{"n":"우석초병설유치원","r":"춘천"},{"n":"우천중학교","r":"횡성"},{"n":"우천초등학교","r":"횡성"},{"n":"운산초등학교","r":"강릉"},{"n":"운양초등학교","r":"강릉"},{"n":"원당초등학교(양구)","r":"양구"},{"n":"원당초등학교(홍천)","r":"홍천"},{"n":"원당초병설유치원","r":"양구"},{"n":"원덕고등학교","r":"삼척"},{"n":"원덕중학교","r":"삼척"},{"n":"원주고등학교","r":"원주"},{"n":"원주금융회계고등학교","r":"원주"},{"n":"원주삼육고등학교","r":"원주"},{"n":"원주삼육중학교","r":"원주"},{"n":"원주삼육초등학교","r":"원주"},{"n":"원주여자고등학교","r":"원주"},{"n":"원주여자중학교","r":"원주"},{"n":"원주유치원","r":"원주"},{"n":"원주의료고등학교","r":"원주"},{"n":"원주중학교","r":"원주"},{"n":"원주청원학교","r":"원주"},{"n":"원주초등학교","r":"원주"},{"n":"원주초병설유치원","r":"원주"},{"n":"원천초등학교","r":"화천"},{"n":"원천초병설유치원","r":"화천"},{"n":"원통고등학교","r":"인제"},{"n":"원통중학교","r":"인제"},{"n":"원통초등학교","r":"인제"},{"n":"원통초병설유치원","r":"인제"},{"n":"월학초등학교","r":"인제"},{"n":"월학초병설유치원","r":"인제"},{"n":"유봉여자고등학교","r":"춘천"},{"n":"유봉여자중학교","r":"춘천"},{"n":"유천초등학교","r":"강릉"},{"n":"유천초병설유치원","r":"강릉"},{"n":"유촌초등학교","r":"화천"},{"n":"유촌초병설유치원","r":"화천"},{"n":"유현초등학교","r":"횡성"},{"n":"육민관고등학교","r":"원주"},{"n":"육민관중학교","r":"원주"},{"n":"율곡중학교","r":"강릉"},{"n":"율곡초등학교","r":"강릉"},{"n":"율전초등학교","r":"홍천"},{"n":"율전초병설유치원","r":"홍천"},{"n":"은빛유치원","r":"춘천"},{"n":"이화유치원","r":"원주"},{"n":"인구초등학교","r":"속초양양"},{"n":"인구초병설유치원","r":"속초양양"},{"n":"인제고등학교","r":"인제"},{"n":"인제남초등학교","r":"인제"},{"n":"인제중학교","r":"인제"},{"n":"인제초등학교","r":"인제"},{"n":"인흥초등학교","r":"고성"},{"n":"일산초등학교","r":"원주"},{"n":"일산초병설유치원","r":"원주"},{"n":"임계고등학교","r":"정선"},{"n":"임계중학교","r":"정선"},{"n":"임계초등학교","r":"정선"},{"n":"임계초병설유치원","r":"정선"},{"n":"임당초등학교","r":"양구"},{"n":"임당초병설유치원","r":"양구"},{"n":"임원중학교","r":"삼척"},{"n":"임원초등학교","r":"삼척"},{"n":"임원초병설유치원","r":"삼척"},{"n":"자연유치원(원주)","r":"원주"},{"n":"자연유치원(춘천)","r":"춘천"},{"n":"장성여자고등학교","r":"태백"},{"n":"장성초등학교","r":"태백"},{"n":"장성초병설유치원","r":"태백"},{"n":"장양초등학교","r":"원주"},{"n":"장양초병설유치원","r":"원주"},{"n":"장원초등학교","r":"삼척"},{"n":"장평초등학교","r":"평창"},{"n":"장학초등학교","r":"춘천"},{"n":"장학초병설유치원","r":"춘천"},{"n":"장호초등학교","r":"삼척"},{"n":"장호초병설유치원","r":"삼척"},{"n":"장흥초등학교","r":"철원"},{"n":"전인고등학교","r":"춘천"},{"n":"정금초등학교","r":"횡성"},{"n":"정금초병설유치원","r":"횡성"},{"n":"정동초등학교","r":"강릉"},{"n":"정동초병설유치원","r":"강릉"},{"n":"정라초등학교","r":"삼척"},{"n":"정라초병설유치원","r":"삼척"},{"n":"정선고등학교","r":"정선"},{"n":"정선유치원","r":"정선"},{"n":"정선정보공업고등학교","r":"정선"},{"n":"정선중학교","r":"정선"},{"n":"정선초가수분교장","r":"정선"},{"n":"정선초등학교","r":"정선"},{"n":"제이엠유치원","r":"강릉"},{"n":"제일유치원","r":"원주"},{"n":"조산초등학교","r":"속초양양"},{"n":"조산초병설유치원","r":"속초양양"},{"n":"조양초등학교(속초)","r":"속초양양"},{"n":"조양초등학교(춘천)","r":"춘천"},{"n":"조양초병설유치원","r":"춘천"},{"n":"좋은유치원","r":"강릉"},{"n":"주문진고등학교","r":"강릉"},{"n":"주문진중학교","r":"강릉"},{"n":"주문진초등학교","r":"강릉"},{"n":"주문진초병설유치원","r":"강릉"},{"n":"주봉초등학교","r":"홍천"},{"n":"주봉초병설유치원","r":"홍천"},{"n":"주영초등학교","r":"강릉"},{"n":"주영초병설유치원","r":"강릉"},{"n":"주진초등학교","r":"평창"},{"n":"주천고등학교","r":"영월"},{"n":"주천중학교","r":"영월"},{"n":"주천초등학교","r":"영월"},{"n":"주천초병설유치원","r":"영월"},{"n":"죽리초등학교","r":"양구"},{"n":"죽리초병설유치원","r":"양구"},{"n":"죽왕초등학교","r":"고성"},{"n":"죽왕초병설유치원","r":"고성"},{"n":"중앙유치원","r":"삼척"},{"n":"중앙초등학교(강릉)","r":"강릉"},{"n":"중앙초등학교(속초)","r":"속초양양"},{"n":"중앙초등학교(원주)","r":"원주"},{"n":"중앙초등학교(춘천)","r":"춘천"},{"n":"중앙초병설유치원","r":"원주"},{"n":"증산초등학교","r":"정선"},{"n":"지정샘유치원","r":"원주"},{"n":"지정중학교","r":"원주"},{"n":"지정초등학교","r":"원주"},{"n":"지정초병설유치원","r":"원주"},{"n":"지촌초등학교","r":"춘천"},{"n":"지촌초지암분교장","r":"춘천"},{"n":"지촌초지암분교장병설유치원","r":"춘천"},{"n":"진광고등학교","r":"원주"},{"n":"진광중학교","r":"원주"},{"n":"진부고등학교","r":"평창"},{"n":"진부중학교","r":"평창"},{"n":"진부초등학교","r":"평창"},{"n":"진부초병설유치원","r":"평창"},{"n":"진주초등학교","r":"삼척"},{"n":"진주초병설유치원","r":"삼척"},{"n":"창림초등학교","r":"횡성"},{"n":"창림초병설유치원","r":"횡성"},{"n":"창촌중학교","r":"춘천"},{"n":"창촌초등학교","r":"홍천"},{"n":"창촌초병설유치원","r":"홍천"},{"n":"창호초등학교","r":"동해"},{"n":"천곡초등학교","r":"동해"},{"n":"천곡초병설유치원","r":"동해"},{"n":"천전초등학교","r":"춘천"},{"n":"천전초병설유치원","r":"춘천"},{"n":"천진초등학교","r":"고성"},{"n":"천진초병설유치원","r":"고성"},{"n":"철암고등학교","r":"태백"},{"n":"철암중학교","r":"태백"},{"n":"철암초등학교","r":"태백"},{"n":"철원고등학교","r":"철원"},{"n":"철원여자고등학교","r":"철원"},{"n":"철원여자중학교","r":"철원"},{"n":"철원중학교","r":"철원"},{"n":"철원초등학교","r":"철원"},{"n":"청담유치원(원주)","r":"원주"},{"n":"청대초등학교","r":"속초양양"},{"n":"청대초병설유치원","r":"속초양양"},{"n":"청령포초등학교","r":"영월"},{"n":"청령포초병설유치원","r":"영월"},{"n":"청봉초등학교","r":"속초양양"},{"n":"청아중학교","r":"삼척"},{"n":"청양초등학교","r":"철원"},{"n":"청양초병설유치원","r":"철원"},{"n":"청운초등학교","r":"동해"},{"n":"청일중학교","r":"횡성"},{"n":"청일초등학교","r":"횡성"},{"n":"청일초병설유치원","r":"횡성"},{"n":"청호초등학교","r":"속초양양"},{"n":"청호초병설유치원","r":"속초양양"},{"n":"초당초등학교","r":"강릉"},{"n":"추곡초등학교","r":"춘천"},{"n":"추곡초병설유치원","r":"춘천"},{"n":"춘당초등학교","r":"횡성"},{"n":"춘성중학교","r":"춘천"},{"n":"춘천계성학교","r":"춘천"},{"n":"춘천고등학교","r":"춘천"},{"n":"춘천교육대학부설초등학교","r":"춘천"},{"n":"춘천기계공업고등학교","r":"춘천"},{"n":"춘천동원학교","r":"춘천"},{"n":"춘천삼육초등학교","r":"춘천"},{"n":"춘천여자고등학교","r":"춘천"},{"n":"춘천유치원","r":"춘천"},{"n":"춘천중학교","r":"춘천"},{"n":"춘천초등학교","r":"춘천"},{"n":"춘천한샘고등학교","r":"춘천"},{"n":"치악고등학교","r":"원주"},{"n":"치악중학교","r":"원주"},{"n":"치악초등학교","r":"원주"},{"n":"치악초병설유치원","r":"원주"},{"n":"큰나무유치원","r":"원주"},{"n":"태백라온학교","r":"태백"},{"n":"태백초등학교","r":"태백"},{"n":"태봉초등학교","r":"원주"},{"n":"태봉초병설유치원","r":"원주"},{"n":"태사랑유치원","r":"태백"},{"n":"태서초등학교","r":"태백"},{"n":"태장중학교","r":"원주"},{"n":"태장초등학교","r":"원주"},{"n":"태장초병설유치원","r":"원주"},{"n":"토성초등학교","r":"철원"},{"n":"통리초등학교","r":"태백"},{"n":"통리초병설유치원","r":"태백"},{"n":"퇴계중학교","r":"춘천"},{"n":"퇴계초등학교","r":"춘천"},{"n":"퇴계초병설유치원","r":"춘천"},{"n":"팔렬고등학교","r":"홍천"},{"n":"팔렬중학교","r":"홍천"},{"n":"평원중학교","r":"원주"},{"n":"평원초등학교","r":"원주"},{"n":"평창고등학교","r":"평창"},{"n":"평창중학교","r":"평창"},{"n":"평창초등학교","r":"평창"},{"n":"평창초병설유치원","r":"평창"},{"n":"포남초등학교","r":"강릉"},{"n":"푸른자연유치원","r":"원주"},{"n":"풍산초등학교","r":"화천"},{"n":"풍산초병설유치원","r":"화천"},{"n":"프라임상상유치원","r":"원주"},{"n":"프렌비숲유치원","r":"강릉"},{"n":"하남초등학교","r":"인제"},{"n":"하남초병설유치원","r":"인제"},{"n":"하늘내린유치원","r":"인제"},{"n":"하늘빛유치원","r":"태백"},{"n":"하랑중학교","r":"동해"},{"n":"하슬라유치원","r":"강릉"},{"n":"하슬라중학교","r":"강릉"},{"n":"하장중학교","r":"삼척"},{"n":"하장초등학교","r":"삼척"},{"n":"학림유치원","r":"원주"},{"n":"학성유치원","r":"원주"},{"n":"학성중학교","r":"원주"},{"n":"학성초등학교","r":"원주"},{"n":"한강유치원","r":"원주"},{"n":"한계초등학교","r":"인제"},{"n":"한계초병설유치원","r":"인제"},{"n":"한국소방마이스터고등학교","r":"영월"},{"n":"한국항공고등학교","r":"태백"},{"n":"한남초등학교","r":"속초양양"},{"n":"한남초병설유치원","r":"속초양양"},{"n":"한림유치원","r":"춘천"},{"n":"한서중학교","r":"홍천"},{"n":"한서초등학교","r":"홍천"},{"n":"한서초병설유치원","r":"홍천"},{"n":"한솔초등학교","r":"강릉"},{"n":"한아름유치원","r":"원주"},{"n":"한전초등학교","r":"양구"},{"n":"한전초병설유치원","r":"양구"},{"n":"함백고등학교","r":"정선"},{"n":"함백중학교","r":"정선"},{"n":"함백초등학교","r":"정선"},{"n":"함백초병설유치원","r":"정선"},{"n":"함태중학교","r":"태백"},{"n":"함태초등학교","r":"태백"},{"n":"해밀학교","r":"홍천"},{"n":"해안중학교","r":"양구"},{"n":"해안초등학교","r":"양구"},{"n":"해안초병설유치원","r":"양구"},{"n":"해오름유치원","r":"동해"},{"n":"현남중학교","r":"속초양양"},{"n":"현북중학교","r":"속초양양"},{"n":"현북초등학교","r":"속초양양"},{"n":"현북초병설유치원","r":"속초양양"},{"n":"현성초등학교","r":"속초양양"},{"n":"현성초병설유치원","r":"속초양양"},{"n":"현천고등학교","r":"횡성"},{"n":"협신초등학교","r":"홍천"},{"n":"협신초병설유치원","r":"홍천"},{"n":"호명초등학교","r":"평창"},{"n":"호명초병설유치원","r":"평창"},{"n":"호반초등학교","r":"춘천"},{"n":"호산초등학교","r":"삼척"},{"n":"호산초병설유치원","r":"삼척"},{"n":"호저중학교","r":"원주"},{"n":"호저초등학교","r":"원주"},{"n":"호저초병설유치원","r":"원주"},{"n":"홍천고등학교","r":"홍천"},{"n":"홍천남산유치원","r":"홍천"},{"n":"홍천농업고등학교","r":"홍천"},{"n":"홍천여자고등학교","r":"홍천"},{"n":"홍천여자중학교","r":"홍천"},{"n":"홍천유치원","r":"홍천"},{"n":"홍천중학교","r":"홍천"},{"n":"홍천초등학교","r":"홍천"},{"n":"화계초등학교","r":"홍천"},{"n":"화계초병설유치원","r":"홍천"},{"n":"화동중학교","r":"정선"},{"n":"화동초등학교","r":"정선"},{"n":"화동초병설유치원","r":"정선"},{"n":"화성유치원","r":"횡성"},{"n":"화천고등학교","r":"화천"},{"n":"화천유치원","r":"화천"},{"n":"화천정산고등학교","r":"화천"},{"n":"화천중학교","r":"화천"},{"n":"화천초등학교","r":"화천"},{"n":"화촌중학교","r":"홍천"},{"n":"화촌초등학교","r":"홍천"},{"n":"황둔중학교","r":"원주"},{"n":"황둔초등학교","r":"원주"},{"n":"황둔초병설유치원","r":"원주"},{"n":"황지고등학교","r":"태백"},{"n":"황지정보산업고등학교","r":"태백"},{"n":"황지중앙초등학교","r":"태백"},{"n":"황지중학교","r":"태백"},{"n":"황지초등학교","r":"태백"},{"n":"회룡초등학교","r":"속초양양"},{"n":"회룡초병설유치원","r":"속초양양"},{"n":"횡계초등학교","r":"평창"},{"n":"횡계초병설유치원","r":"평창"},{"n":"횡성고등학교","r":"횡성"},{"n":"횡성여자고등학교","r":"횡성"},{"n":"횡성중학교","r":"횡성"},{"n":"횡성초등학교","r":"횡성"},{"n":"횡성초병설유치원","r":"횡성"},{"n":"효제초등학교","r":"춘천"},{"n":"후평숲속유치원","r":"춘천"},{"n":"후평중학교","r":"춘천"},{"n":"후평초등학교","r":"춘천"},{"n":"흥양초등학교","r":"원주"},{"n":"흥양초병설유치원","r":"원주"},{"n":"흥업초등학교","r":"원주"},{"n":"흥업초병설유치원","r":"원주"},{"n":"흥전초등학교","r":"삼척"}];
    </script>

    <script>
      (function () {
        "use strict";

        /* =========================
           전역 상태
           ========================= */
        const state = {
          files: [],
          xlsxReady: false,
          recordsRaw: [],
          records: [],
          aggregates: {
            kpi: {},
            regionRows: [],
            instRows: [],
          },
          schoolMeta: new Map(), // baseName -> { hasAttached: boolean }
          stats: {
            skippedInvalidName: 0,
            correctedYangToYanggu: 0,
            appliedRegulationFallback: 0,
          },

          // “현재 명단 다운로드”에서 사용할 최근 조회 결과(없으면 전체)
          currentExport: {
            title: "현재 조회 결과",
            rows: [],
          },
        };

        /* =========================
           상수/룰
           ========================= */

        const REGION_18 = [
          "강원도교육청",
          "강릉",
          "고성",
          "동해",
          "삼척",
          "속초양양",
          "양구",
          "영월",
          "원주",
          "인제",
          "정선",
          "철원",
          "춘천",
          "태백",
          "평창",
          "홍천",
          "화천",
          "횡성",
        ];
        const REGION_17 = REGION_18.filter((r) => r !== "강원도교육청");

        const LOCAL_GOV_SERIES = [
          "지방교육행정",
          "지방시설관리",
          "지방시설",
          "지방전산",
          "지방사무운영",
          "지방운전",
          "지방식품위생",
          "지방조리",
          "지방사서",
          "지방공업",
        ];

        const EDU_LABOR_JOBS = Array.from(
          new Set([
            "치료사",
            "장애영아지도사",
            "장애유아지도사",
            "직업지도사",
            "유치원방과후교육사",
            "학교도서관사서",
            "기숙사생활지도원",
            "전문상담사",
            "영양사",
            "교육복지사",
            "평생교육사",
            "사회복지사",
            "진로교육사",
            "학교도서관실무사",
            "특수교육지도사",
            "건강실무사",
            "조리사",
            "조리실무사",
            "교무행정사",
            "발명실무원",
            "통학차량운전원",
            "통학지도원",
            "늘봄학교전담사",
            "초등돌봄전담사",
            "방과후전담사",
            "임상심리사",
            "대안교육전문가",
            "학습클리닉전문가",
            "학부모지원전문가",
            "진학전문지원관",
            "학교운동부지도자",
            "교육지도사",
            "방과후학교지원가",
            "구육성회직원",
          ])
        );

        const TEACHER_CATEGORIES = [
          "유치원교사",
          "초등학교교사",
          "중등학교교사",
          "특수학교교사",
          "실기교사",
          "보건교사",
          "사서교사",
          "전문상담교사",
          "영양교사",
          "교감",
          "교장",
          "원감",
          "원장",
          "수석교사",
          "교사",
        ];

        const GOV_GRADE_ENDINGS = ["서기보시보", "서기보", "서기", "주사보", "주사", "서기관", "사무관"];

        const INTERNAL_OFFICE_DEPTS = [
          "감사관",
          "공보담당관",
          "정책국",
          "교육국",
          "행정국",
          "정책기획과",
          "미래교육과",
          "안전복지과",
          "교육지원과",
          "유초등교육과",
          "중등교육과",
          "인성생활교육과",
          "문화체육특수교육과",
          "총무과",
          "예산과",
          "행정과",
          "시설과",
          "학교지원과",
          "미래학교지원과",
        ];

        const DIRECT_INST_CANON = [
          { match: "교육연구원", canon: "강원특별자치도교육청 교육연구원", region: "춘천" },
          { match: "유아교육원", canon: "강원특별자치도교육청 유아교육원", region: "춘천" },
          { match: "학생교육원", canon: "강원특별자치도교육청 학생교육원", region: "춘천" },
          { match: "춘천교육문화관", canon: "강원특별자치도교육청 춘천교육문화관", region: "춘천" },

          { match: "교육연수원", canon: "강원특별자치도교육청 교육연수원", region: "강릉" },
          { match: "사임당교육원", canon: "강원특별자치도교육청 사임당교육원", region: "강릉" },
          { match: "교직원수련원", canon: "강원특별자치도교육청 교직원수련원", region: "강릉" },
          { match: "강릉교육문화관", canon: "강원특별자치도교육청 강릉교육문화관", region: "강릉" },

          { match: "교육과학정보원", canon: "강원특별자치도교육청 교육과학정보원", region: "원주" },
          { match: "원주교육문화관", canon: "강원특별자치도교육청 원주교육문화관", region: "원주" },

          { match: "진로교육원", canon: "강원특별자치도교육청 진로교육원", region: "속초양양" },
          { match: "속초교육문화관", canon: "강원특별자치도교육청 속초교육문화관", region: "속초양양" },

          { match: "국제교육원", canon: "강원특별자치도교육청 국제교육원", region: "철원" },
          { match: "통일교육원", canon: "강원특별자치도교육청 통일교육원", region: "속초양양" },

          { match: "삼척교육문화관", canon: "강원특별자치도교육청 삼척교육문화관", region: "삼척" },
        ];

        const RETIRE_KW = ["퇴직", "정년", "의원면직", "면직", "해임", "파면", "사망"];
        const PLACEHOLDER_KW = ["교육장이 지정", "부서 근무를 명", "부서근무를명", "교육장이지정"];
        const DISPATCH_KW = ["파견", "파견연장", "파견 복귀", "파견복귀"];
        const LEAVE_KW = ["휴직", "복직", "육아휴직", "질병휴직", "직권휴직", "복귀", "복귀명"];
        const REGULATION_KW = ["조례", "시행규칙"];

        /* =========================
           DOM
           ========================= */
        const $ = (sel) => document.querySelector(sel);

        const el = {
          dropzone: $("#dropzone"),
          fileInput: $("#fileInput"),
          btnAddFiles: $("#btnAddFiles"),
          btnResetFiles: $("#btnResetFiles"),
          btnAnalyze: $("#btnAnalyze"),
          fileCount: $("#fileCount"),
          fileDetailsSummary: $("#fileDetailsSummary"),
          fileTableBody: $("#fileTableBody"),
          xlsxBadge: $("#xlsxBadge"),

          statusTitle: $("#statusTitle"),
          progressFill: $("#progressFill"),
          statusDetail: $("#statusDetail"),
          statusExtra: $("#statusExtra"),
          statusBox: $("#statusBox"),

          btnDownloadAll: $("#btnDownloadAll"),
          btnDownloadFiltered: $("#btnDownloadFiltered"),

          kpiGrid: $("#kpiGrid"),
          regionSearch: $("#regionSearch"),
          instSearch: $("#instSearch"),

          regionTableBody: $("#regionTableBody"),
          instTableBody: $("#instTableBody"),
          regionTableCount: $("#regionTableCount"),
          instTableCount: $("#instTableCount"),

          btnGoEntity: $("#btnGoEntity"),
          btnGoRegion: $("#btnGoRegion"),

          entityKind: $("#entityKind"),
          entityName: $("#entityName"),
          personnelType: $("#personnelType"),
          jobFilter: $("#jobFilter"),

          entityOutPanel: $("#entityOutPanel"),
          entityInPanel: $("#entityInPanel"),
          entityUnknownDetails: $("#entityUnknownDetails"),
          entityUnknownSummary: $("#entityUnknownSummary"),
          entityUnknownPanel: $("#entityUnknownPanel"),
          entityOutCount: $("#entityOutCount"),
          entityInCount: $("#entityInCount"),

          officeMode: $("#officeMode"),
          regionPick: $("#regionPick"),
          regionPersonnelType: $("#regionPersonnelType"),

          regionOutPanel: $("#regionOutPanel"),
          regionInPanel: $("#regionInPanel"),
          regionStayPanel: $("#regionStayPanel"),
          regionUnknownDetails: $("#regionUnknownDetails"),
          regionUnknownSummary: $("#regionUnknownSummary"),
          regionUnknownPanel: $("#regionUnknownPanel"),
          regionOutCount: $("#regionOutCount"),
          regionInCount: $("#regionInCount"),
          regionStayCount: $("#regionStayCount"),

          btnExportRegionView: $("#btnExportRegionView"),

          toTopBtn: $("#toTopBtn"),
          logBox: $("#logBox"),
        };

        /* =========================
           로그
           ========================= */
        const logs = [];
        function log(msg) {
          const ts = new Date().toISOString().replace("T", " ").slice(0, 19);
          logs.push(`[${ts}] ${msg}`);
          el.logBox.textContent = logs.join("\n");
        }

        /* =========================
           유틸
           ========================= */
        function escapeHtml(s) {
          return String(s ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function normalizeText(v) {
          if (v === null || v === undefined) return "";
          if (v instanceof Date) {
            const y = v.getFullYear();
            const m = String(v.getMonth() + 1).padStart(2, "0");
            const d = String(v.getDate()).padStart(2, "0");
            return `${y}.${m}.${d}`;
          }
          const s = String(v);
          return s.replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim();
        }

        function normalizeKey(s) {
          return normalizeText(s).replace(/\s+/g, "").replace(/[·•◆□○●]/g, "").trim();
        }

        function normalizeSchoolKey(s) {
          return normalizeText(s)
            .replace(/\s+/g, "")
            .replace(/[·•◆□○●()（）\[\]{}<>《》"']/g, "")
            .trim();
        }

        function formatBytes(bytes) {
          if (!bytes && bytes !== 0) return "";
          const units = ["B", "KB", "MB", "GB"];
          let i = 0;
          let v = bytes;
          while (v >= 1024 && i < units.length - 1) {
            v /= 1024;
            i++;
          }
          return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
        }

        function sleep(ms) {
          return new Promise((r) => setTimeout(r, ms));
        }

        function setProgress(title, percent, detail = "", extra = "") {
          el.statusTitle.textContent = title;
          el.progressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
          el.statusDetail.textContent = detail || `${Math.round(percent)}%`;
          el.statusExtra.textContent = extra || "";
        }

        function setStatusBox(kind, html) {
          const cls = kind === "warn" ? "warn" : kind === "ok" ? "ok" : "";
          el.statusBox.className = cls;
          el.statusBox.innerHTML = html || "";
        }

        function scrollToId(id) {
          const target = document.getElementById(id);
          if (!target) return;
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        /* =========================
           강원도 내 전체 학교 목록 인덱스
           - 학교명 약칭/변형 → 공식 학교명으로 보정
           - 공식 학교명 → 시군구(주소 기반) 매핑
           ========================= */
        function removeSchoolSuffix(name) {
          const n = normalizeText(name).replace(/\s+/g, "");
          const suffixes = ["초등학교", "중학교", "고등학교", "특수학교", "유치원", "학교"];
          for (const suf of suffixes) {
            if (n.endsWith(suf)) return { stem: n.slice(0, -suf.length), suffix: suf };
          }
          return { stem: n, suffix: "" };
        }

        function buildSchoolMasterIndex(rows) {
          const baseList = [];
          const baseRegion = new Map(); // baseName(공식) -> region(시군구)
          const aliasToBase = new Map(); // aliasKey -> baseName
          const aliasAmbig = new Set();

          function addAlias(alias, base) {
            const k = normalizeSchoolKey(alias);
            if (!k) return;
            if (aliasAmbig.has(k)) return;
            if (aliasToBase.has(k)) {
              if (aliasToBase.get(k) !== base) {
                // 충돌: 애매한 별칭은 제거(오판 방지)
                aliasToBase.delete(k);
                aliasAmbig.add(k);
              }
              return;
            }
            aliasToBase.set(k, base);
          }

          // 1) base 학교(병설유치원 제외) 수집
          for (const it of rows || []) {
            const name = normalizeText(it.n).replace(/\s+/g, "");
            if (!name) continue;
            const isAttached = name.includes("병설유치원") || name.endsWith("병설유");
            if (isAttached) continue;

            baseList.push(name);
            if (it.r) baseRegion.set(name, it.r);
          }

          // 2) stem(접미 제거) 중복 체크 → "stem 단독 별칭"은 유일할 때만 부여
          const stemCount = new Map();
          for (const base of baseList) {
            const { stem } = removeSchoolSuffix(base);
            const sk = normalizeSchoolKey(stem);
            if (!sk) continue;
            stemCount.set(sk, (stemCount.get(sk) || 0) + 1);
          }

          // 3) base 별칭 생성
          for (const base of baseList) {
            addAlias(base, base);

            const { stem, suffix } = removeSchoolSuffix(base);
            const sk = normalizeSchoolKey(stem);

            if (stem && stemCount.get(sk) === 1) addAlias(stem, base);

            if (suffix === "초등학교") {
              addAlias(stem + "초", base);
              addAlias(stem + "초교", base);
              addAlias(stem + "초등", base);
            } else if (suffix === "중학교") {
              addAlias(stem + "중", base);
              addAlias(stem + "중등", base);
            } else if (suffix === "고등학교") {
              addAlias(stem + "고", base);
              addAlias(stem + "고등", base);
            } else if (suffix === "유치원") {
              addAlias(stem + "유", base);
            } else if (suffix === "특수학교") {
              addAlias(stem + "특수", base);
            } else if (suffix === "학교") {
              addAlias(stem + "학교", base);
            }

            // 여자/남자 약칭
            if (base.includes("여자고등학교")) addAlias(base.replace("여자고등학교", "여고"), base);
            if (base.includes("남자고등학교")) addAlias(base.replace("남자고등학교", "남고"), base);
            if (base.includes("여자중학교")) addAlias(base.replace("여자중학교", "여중"), base);
            if (base.includes("남자중학교")) addAlias(base.replace("남자중학교", "남중"), base);

            // 흔한 약칭(추가)
            if (base.includes("상업고등학교")) addAlias(base.replace("상업고등학교", "상고"), base);
            if (base.includes("공업고등학교")) addAlias(base.replace("공업고등학교", "공고"), base);
            if (base.includes("과학고등학교")) addAlias(base.replace("과학고등학교", "과학고"), base);
            if (base.includes("정보고등학교")) addAlias(base.replace("정보고등학교", "정보고"), base);
          }

          // 4) 병설유치원 이름을 base로 매핑 (예: 사천초병설유치원 → 사천초등학교)
          for (const it of rows || []) {
            const nameRaw = normalizeText(it.n).replace(/\s+/g, "");
            if (!nameRaw) continue;
            const isAttached = nameRaw.includes("병설유치원") || nameRaw.endsWith("병설유");
            if (!isAttached) continue;

            let baseTok = nameRaw.replace("병설유치원", "").replace("병설유", "").replace(/및/g, "").trim();
            const base = lookupBase(baseTok);
            if (base) {
              addAlias(nameRaw, base);
              addAlias(baseTok, base);
            }
          }

          function tryHeuristic(tok) {
            const t = normalizeText(tok).replace(/\s+/g, "");
            if (!t) return "";

            const direct = aliasToBase.get(normalizeSchoolKey(t));
            if (direct) return direct;

            // 여고/남고/여중/남중
            if (t.endsWith("여고")) {
              const cand = t.slice(0, -2) + "여자고등학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }
            if (t.endsWith("남고")) {
              const cand = t.slice(0, -2) + "남자고등학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }
            if (t.endsWith("여중")) {
              const cand = t.slice(0, -2) + "여자중학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }
            if (t.endsWith("남중")) {
              const cand = t.slice(0, -2) + "남자중학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }

            // 초/중/고/유
            if (t.endsWith("초")) {
              const cand = t.slice(0, -1) + "초등학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }
            if (t.endsWith("중")) {
              const cand = t.slice(0, -1) + "중학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }
            if (t.endsWith("고")) {
              const cand = t.slice(0, -1) + "고등학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }
            if (t.endsWith("유")) {
              const cand = t.slice(0, -1) + "유치원";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }

            // "초등/중등/고등"만 있는 경우
            if (t.endsWith("초등") || t.endsWith("중등") || t.endsWith("고등")) {
              const cand = t + "학교";
              const v = aliasToBase.get(normalizeSchoolKey(cand));
              if (v) return v;
            }

            return "";
          }

          function lookupBase(text) {
            const k = normalizeSchoolKey(text);
            if (!k) return "";

            const direct = aliasToBase.get(k);
            if (direct) return direct;

            const byH = tryHeuristic(text);
            if (byH) return byH;

            // substring unique match (예: 항공고 → 한국항공고등학교)
            const t = k;
            let found = "";
            for (const base of baseList) {
              const bk = normalizeSchoolKey(base);
              if (!bk) continue;
              if (bk.includes(t) || t.includes(bk)) {
                if (found && found !== base) return "";
                found = base;
              }
            }
            return found;
          }

          return { baseRegion, lookupBase };
        }

        // ✅ 내장 학교 목록 인덱스(한 번만 구축)
        const SCHOOL_MASTER = buildSchoolMasterIndex(GW_SCHOOL_MASTER_ROWS);

        /* =========================
           XLSX 로더(진행률 표시)
           ========================= */

        const XLSX_CDN = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        const XLSX_FALLBACK = "/static/xlsx.full.min.js"; // 서버에 두면 자동 사용

        async function loadScriptTag(src) {
          return new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = src;
            s.async = true;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error(`script load fail: ${src}`));
            document.head.appendChild(s);
          });
        }

        async function loadXlsxWithProgress(url) {
          setProgress("라이브러리(XLSX) 불러오는 중…", 1, "1%");
          log(`XLSX 로드 시도: ${url}`);

          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`fetch 실패 (${res.status})`);

          const totalStr = res.headers.get("content-length");
          const total = totalStr ? Number(totalStr) : 0;

          if (!res.body || !res.body.getReader) {
            let fake = 5;
            const timer = setInterval(() => {
              fake = Math.min(90, fake + 7);
              setProgress("라이브러리(XLSX) 불러오는 중…", fake, `${fake}%`);
            }, 120);

            await loadScriptTag(url);
            clearInterval(timer);
            setProgress("라이브러리 로드 완료", 100, "100%");
            return;
          }

          const reader = res.body.getReader();
          let loaded = 0;
          const chunks = [];
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.byteLength;

            let p;
            if (total) p = Math.min(95, Math.round((loaded / total) * 95));
            else p = Math.min(95, 10 + Math.round(loaded / 50000));

            setProgress(
              "라이브러리(XLSX) 불러오는 중…",
              p,
              `${p}%`,
              total ? `${formatBytes(loaded)} / ${formatBytes(total)}` : formatBytes(loaded)
            );
          }

          const blob = new Blob(chunks, { type: "text/javascript" });
          const blobUrl = URL.createObjectURL(blob);
          await loadScriptTag(blobUrl);
          URL.revokeObjectURL(blobUrl);

          setProgress("라이브러리 로드 완료", 100, "100%");
        }

        async function ensureXlsxReady() {
          if (state.xlsxReady) return true;

          try {
            await loadXlsxWithProgress(XLSX_CDN);
            if (!window.XLSX) throw new Error("XLSX 전역이 없습니다.");
            state.xlsxReady = true;
            el.xlsxBadge.textContent = "XLSX: 준비됨";
            setStatusBox("ok", "라이브러리 로드 완료");
            log("XLSX 로드 완료(CDN)");
            return true;
          } catch (e1) {
            log(`CDN 로드 실패: ${e1.message}`);

            try {
              setStatusBox(
                "warn",
                "CDN 로드에 실패하여 <b>/static/xlsx.full.min.js</b>를 시도합니다. (서버에 파일이 있으면 자동으로 로드됩니다.)"
              );
              await loadXlsxWithProgress(XLSX_FALLBACK);
              if (!window.XLSX) throw new Error("XLSX 전역이 없습니다.");
              state.xlsxReady = true;
              el.xlsxBadge.textContent = "XLSX: 준비됨";
              setStatusBox("ok", "라이브러리 로드 완료(로컬)");
              log("XLSX 로드 완료(로컬 fallback)");
              return true;
            } catch (e2) {
              setStatusBox(
                "warn",
                "XLSX 로드 실패. 네트워크/서버 설정을 확인하세요.<br/>- CDN 차단 시: <b>/static/xlsx.full.min.js</b>를 서버에 배치<br/>- 또는 사내망 허용 CDN으로 URL 교체"
              );
              el.xlsxBadge.textContent = "XLSX: 실패";
              log(`로컬 fallback 로드 실패: ${e2.message}`);
              return false;
            }
          }
        }

        /* =========================
           파일 업로드/관리
           ========================= */
        function fileSig(f) {
          return `${f.name}__${f.size}__${f.lastModified}`;
        }

        function addFiles(fileList) {
          const incoming = Array.from(fileList || []);
          if (!incoming.length) return;

          const before = state.files.length;
          const existing = new Set(state.files.map(fileSig));

          for (const f of incoming) {
            const sig = fileSig(f);
            if (existing.has(sig)) continue;
            existing.add(sig);
            state.files.push(f);
          }

          const added = state.files.length - before;
          if (added > 0) log(`파일 추가: ${added}개 (총 ${state.files.length}개)`);
          renderFileTable();
          updateAnalyzeBtn();
        }

        function removeFileAt(idx) {
          const f = state.files[idx];
          if (!f) return;
          state.files.splice(idx, 1);
          log(`파일 삭제: ${f.name}`);
          renderFileTable();
          updateAnalyzeBtn();
        }

        function resetFiles() {
          state.files = [];
          state.recordsRaw = [];
          state.records = [];
          state.schoolMeta = new Map();
          state.aggregates = { kpi: {}, regionRows: [], instRows: [] };
          state.currentExport = { title: "현재 조회 결과", rows: [] };
          state.stats = { skippedInvalidName: 0, correctedYangToYanggu: 0, appliedRegulationFallback: 0 };

          renderFileTable();
          renderEmptyResults();
          updateAnalyzeBtn();
          lockFilters(true);

          setStatusBox("", "");
          log("초기화 완료");
        }

        function renderFileTable() {
          el.fileCount.textContent = String(state.files.length);
          el.fileDetailsSummary.textContent = `업로드한 파일 목록 (${state.files.length}개)`;

          if (!state.files.length) {
            el.fileTableBody.innerHTML =
              '<tr><td colspan="4" class="muted" style="text-align:center">아직 업로드된 파일이 없습니다.</td></tr>';
            return;
          }

          const rows = state.files
            .slice()
            .sort((a, b) => a.name.localeCompare(b.name, "ko"))
            .map((f, i) => {
              const dt = new Date(f.lastModified);
              const dtStr = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}-${String(dt.getDate()).padStart(
                2,
                "0"
              )} ${String(dt.getHours()).padStart(2, "0")}:${String(dt.getMinutes()).padStart(2, "0")}`;

              return `
              <tr>
                <td>${escapeHtml(f.name)}</td>
                <td class="numeric">${escapeHtml(formatBytes(f.size))}</td>
                <td>${escapeHtml(dtStr)}</td>
                <td style="text-align:center">
                  <button class="btn btn-lightgrey" type="button" data-rm="${i}" aria-label="파일 삭제">삭제</button>
                </td>
              </tr>
            `;
            })
            .join("");

          el.fileTableBody.innerHTML = rows;

          el.fileTableBody.querySelectorAll("button[data-rm]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const idx = Number(btn.getAttribute("data-rm"));
              removeFileAt(idx);
            });
          });
        }

        function updateAnalyzeBtn() {
          el.btnAnalyze.disabled = !state.files.length || !state.xlsxReady;
        }

        /* =========================
           엑셀 파싱/추출(핵심)
           ========================= */

        function regionHintFromFileName(fileName) {
          const m = String(fileName || "").match(/\[([^\]]+)\]/);
          if (!m) return "";
          return canonicalRegionName(m[1]);
        }

        function canonicalRegionName(raw) {
          const s0 = normalizeText(raw).replace(/\s+/g, "");
          if (!s0) return "";

          // 강원도교육청(최우선)
          if (s0.includes("강원도교육청") || s0.includes("강원특별자치도교육청")) return "강원도교육청";

          // 속초/양양 통합
          if (s0.includes("속초양양") || s0.includes("속초/양양")) return "속초양양";
          if (s0.includes("속초") || s0.includes("양양")) return "속초양양";

          // "강원특별자치도" 접두 제거(지역 통합)
          let s = s0.replace(/강원특별자치도/g, "").replace(/강원도/g, "");

          // "강원특별자치도동해" → "동해" 같은 케이스
          s = s.replace(/(시|군|구)$/g, "");

          // 양구 오타/병합 잔상: "양" or "강원특별자치도양" → "양구"
          if (s === "양") {
            state.stats.correctedYangToYanggu += 1;
            return "양구";
          }

          return s;
        }

        function isKnownRegion(r) {
          return REGION_18.includes(r);
        }

        function findDirectInstitution(orgText) {
          const t = normalizeText(orgText);
          if (!t) return null;
          for (const it of DIRECT_INST_CANON) {
            if (t.includes(it.match)) return it;
          }
          return null;
        }

        function isOfficeDept(orgText) {
          const t = normalizeText(orgText);
          if (!t) return false;
          if (t.includes("교육지원청")) return false;
          return INTERNAL_OFFICE_DEPTS.some((k) => t.includes(k));
        }

        function extractEduSupportOffice(orgText) {
          const t = normalizeText(orgText);
          if (!t) return "";
          const m = t.match(/([가-힣]{1,20})\s*교육지원청/);
          if (!m) return "";
          const r = canonicalRegionName(m[1]);
          if (!r) return "";
          return `${r}교육지원청`;
        }

        /* ====== 학교명 정규화(마스터 목록 기반) ====== */

        function stripOrgPrefixForSchool(base) {
          let b = normalizeText(base).replace(/\s+/g, "");
          if (!b) return "";
          if (b.includes("교육지원청")) b = b.split("교육지원청").pop();
          if (b.includes("교육청")) b = b.split("교육청").pop();
          return b;
        }

        function normalizeSchoolCoreName(base) {
          const t = stripOrgPrefixForSchool(base);
          if (!t) return "";
          return SCHOOL_MASTER.lookupBase(t) || "";
        }

        function parseSchoolName(text) {
          const raw = normalizeText(text).replace(/\s+/g, "");
          if (!raw) return null;

          const hasAttached = raw.includes("병설유치원") || raw.includes("병설유");
          if (hasAttached) {
            let base = raw.replace("병설유치원", "").replace("병설유", "").replace(/및/g, "");
            const baseFull = normalizeSchoolCoreName(base);
            if (!baseFull) return null;
            return { baseName: baseFull, canonName: `${baseFull} 및 병설유치원`, hasAttached: true };
          }

          const baseFull = normalizeSchoolCoreName(raw);
          if (!baseFull) return null;
          return { baseName: baseFull, canonName: baseFull, hasAttached: false };
        }

        function looksLikeSchoolToken(token) {
          const t = normalizeText(token).replace(/\s+/g, "");
          if (!t) return false;
          if (t.includes("교육지원청") || t.includes("교육청")) return false;

          if (SCHOOL_MASTER.lookupBase(t)) return true;

          if (t.includes("병설유치원") || t.includes("병설유")) {
            const base = t.replace("병설유치원", "").replace("병설유", "").replace(/및/g, "");
            if (SCHOOL_MASTER.lookupBase(base)) return true;
          }

          return false;
        }

        function normalizeOrgText(text) {
          const t = normalizeText(text);
          if (!t) return "";

          const tokens = t.split(/\s+/).filter(Boolean);
          const out = [];

          for (let i = 0; i < tokens.length; i++) {
            const tok = tokens[i];
            const tk = normalizeText(tok).replace(/\s+/g, "");

            if (looksLikeSchoolToken(tk)) {
              const parsed = parseSchoolName(tk);
              if (parsed) out.push(parsed.canonName);
              else out.push(tok);
            } else {
              out.push(tok);
            }
          }

          return out.join(" ").replace(/\s+/g, " ").trim();
        }

        function extractSchoolEntity(orgText) {
          const t = normalizeText(orgText);
          if (!t) return null;
          const tokens = t.split(/\s+/).filter(Boolean);

          for (let i = tokens.length - 1; i >= 0; i--) {
            const tok = normalizeText(tokens[i]).replace(/\s+/g, "");
            if (!tok) continue;

            // 토큰 자체가 병설유치원 포함
            if (tok.includes("병설유")) {
              const parsed = parseSchoolName(tok);
              if (parsed) return parsed;

              // "병설유치원" 단독 토큰이면 이전 토큰과 결합
              if (tok === "병설유치원" || tok === "병설유") {
                let baseTok = "";
                if (i - 1 >= 0 && normalizeText(tokens[i - 1]) === "및") {
                  if (i - 2 >= 0) baseTok = tokens[i - 2];
                } else if (i - 1 >= 0) {
                  baseTok = tokens[i - 1];
                }
                if (baseTok) {
                  const combined = `${baseTok}병설유치원`;
                  const p2 = parseSchoolName(combined);
                  if (p2) return p2;
                }
              }
              continue;
            }

            if (looksLikeSchoolToken(tok)) {
              const parsed = parseSchoolName(tok);
              if (parsed) return parsed;
            }
          }

          // 공백 없이 붙어있는 케이스(최후 fallback)
          const compact = normalizeText(orgText).replace(/\s+/g, "");
          if (compact.includes("병설유")) {
            const idx = compact.lastIndexOf("병설유");
            const start = Math.max(0, idx - 18);
            const frag = compact.slice(start);
            const parsed = parseSchoolName(frag);
            if (parsed) return parsed;
          }

          return null;
        }

        function detectEntity(orgText, fileRegionHint = "") {
          const t = normalizeText(orgText);
          if (!t) return { kind: "unknown", name: "", baseName: "" };

          // 직속기관
          const direct = findDirectInstitution(t);
          if (direct) return { kind: "inst", name: direct.canon, baseName: "" };

          // 강원도교육청 본청(부서 통합)
          if (t.includes("강원도교육청") || t.includes("강원특별자치도교육청") || isOfficeDept(t)) {
            return { kind: "inst", name: "강원도교육청", baseName: "" };
          }

          // ✅ 학교(마스터 목록 기반) 우선 추출
          const school = extractSchoolEntity(t);
          if (school) return { kind: "school", name: school.canonName, baseName: school.baseName };

          // 교육지원청(기관)
          const sup = extractEduSupportOffice(t);
          if (sup) return { kind: "inst", name: sup, baseName: "" };

          return { kind: "unknown", name: t, baseName: "" };
        }

        function inferRegionFromText(text, fileRegionHint = "") {
          const t = normalizeText(text);
          if (!t) return fileRegionHint || "";

          // 직속기관 위치 매핑
          const direct = findDirectInstitution(t);
          if (direct) return direct.region;

          // 강원도교육청 본청
          if (t.includes("강원도교육청") || t.includes("강원특별자치도교육청") || isOfficeDept(t)) {
            return "강원도교육청";
          }

          // 교육지원청 기반
          const sup = extractEduSupportOffice(t);
          if (sup) {
            const r = canonicalRegionName(sup.replace("교육지원청", ""));
            if (r) return r;
          }

          // "강원특별자치도동해" 같은 문자열도 잡히게 접두 제거 후 검색
          const compact = normalizeText(text).replace(/\s+/g, "");
          const compact2 = compact.replace(/강원특별자치도/g, "").replace(/강원도/g, "");

          // 속초/양양 통합 우선
          if (compact2.includes("속초") || compact2.includes("양양") || compact2.includes("속초양양")) return "속초양양";

          // 지역명 포함 여부
          for (const r of REGION_17) {
            if (r === "속초양양") continue;
            if (compact2.includes(r)) return r;
          }

          // 혹시 "양"이 나오면 양구로 교정
          if (compact2 === "양") {
            state.stats.correctedYangToYanggu += 1;
            return "양구";
          }

          return fileRegionHint || "";
        }

        function regionFromSchoolEntity(ent) {
          if (!ent || ent.kind !== "school" || !ent.baseName) return "";
          return SCHOOL_MASTER.baseRegion.get(ent.baseName) || "";
        }

        function recordHasKeywordText(rec, kwList) {
          const hay = normalizeKey(`${rec.action} ${rec.newOrg} ${rec.newRank} ${rec.curOrg} ${rec.curRank}`);
          return kwList.some((k) => hay.includes(normalizeKey(k)));
        }

        function isRetire(rec) {
          return recordHasKeywordText(rec, RETIRE_KW);
        }

        function isPlaceholder(rec) {
          return recordHasKeywordText(rec, PLACEHOLDER_KW);
        }

        function isLocalGovByRank(text) {
          const t = normalizeKey(text);
          if (!t) return false;
          if (t.startsWith("지방")) return true;
          if (t.includes("지방")) return true;
          return GOV_GRADE_ENDINGS.some((end) => t.endsWith(normalizeKey(end)));
        }

        function localGovSeriesFromRank(text) {
          const t = normalizeText(text).replace(/\s+/g, "");
          if (!t) return "지방교육행정";

          if (t.includes("지방시설관리")) return "지방시설관리";
          if (t.includes("지방시설")) return "지방시설";
          if (t.includes("지방전산")) return "지방전산";
          if (t.includes("지방사무운영")) return "지방사무운영";
          if (t.includes("지방운전")) return "지방운전";
          if (t.includes("지방식품위생")) return "지방식품위생";
          if (t.includes("지방조리")) return "지방조리";
          if (t.includes("지방사서")) return "지방사서";
          if (t.includes("지방공업")) return "지방공업";

          return "지방교육행정";
        }

        function detectPersonnelType(rec) {
          const mix = `${rec.newRank} ${rec.curRank} ${rec.jobRaw} ${rec.fileName} ${rec.sheetName}`;
          const mk = normalizeKey(mix);

          if (isLocalGovByRank(mix)) return "지방공무원";

          if (mk.includes("교육공무직") || EDU_LABOR_JOBS.some((j) => mk.includes(normalizeKey(j)))) return "교육공무직";

          if (mk.includes("교육공무원") || mk.includes("교사") || mk.includes("교감") || mk.includes("교장") || mk.includes("원장") || mk.includes("원감"))
            return "교육공무원";

          return "기타";
        }

        function detectJobKey(rec) {
          const t = rec.personnelType;

          if (t === "지방공무원") {
            return localGovSeriesFromRank(`${rec.newRank} ${rec.curRank}`);
          }

          if (t === "교육공무직") {
            const sheet = normalizeText(rec.sheetName);
            const foundBySheet = EDU_LABOR_JOBS.find((j) => normalizeKey(sheet) === normalizeKey(j));
            if (foundBySheet) return foundBySheet;

            const mix = normalizeKey(`${rec.newRank} ${rec.curRank} ${rec.action} ${rec.jobRaw}`);
            const found = EDU_LABOR_JOBS.find((j) => mix.includes(normalizeKey(j)));
            return found || normalizeText(rec.newRank) || normalizeText(rec.curRank) || "기타";
          }

          if (t === "교육공무원") {
            const mix = normalizeKey(`${rec.newRank} ${rec.curRank} ${rec.jobRaw} ${rec.sheetName} ${rec.fileName}`);
            if (mix.includes("유치원") && mix.includes("교사")) return "유치원교사";
            if (mix.includes("초등") && mix.includes("교사")) return "초등학교교사";
            if (mix.includes("중등") && mix.includes("교사")) return "중등학교교사";
            if (mix.includes("특수") && mix.includes("교사")) return "특수학교교사";
            if (mix.includes("실기")) return "실기교사";
            if (mix.includes("보건교사")) return "보건교사";
            if (mix.includes("사서교사")) return "사서교사";
            if (mix.includes("전문상담교사") || mix.includes("상담교사")) return "전문상담교사";
            if (mix.includes("영양교사")) return "영양교사";
            if (mix.includes("교감")) return "교감";
            if (mix.includes("교장")) return "교장";
            if (mix.includes("원감")) return "원감";
            if (mix.includes("원장")) return "원장";
            if (mix.includes("수석")) return "수석교사";
            if (mix.includes("교사")) return "교사";
            return normalizeText(rec.newRank) || normalizeText(rec.curRank) || "기타";
          }

          return normalizeText(rec.newRank) || normalizeText(rec.curRank) || "기타";
        }

        /* ====== SheetJS merge 채우기 ====== */
        function fillMergedCells(sheet) {
          const merges = sheet && sheet["!merges"];
          if (!merges || !Array.isArray(merges) || merges.length === 0) return;

          for (const m of merges) {
            const startAddr = XLSX.utils.encode_cell({ r: m.s.r, c: m.s.c });
            const startCell = sheet[startAddr];
            if (!startCell) continue;

            for (let r = m.s.r; r <= m.e.r; r++) {
              for (let c = m.s.c; c <= m.e.c; c++) {
                const addr = XLSX.utils.encode_cell({ r, c });
                const cell = sheet[addr];
                if (!cell || cell.v === undefined || cell.v === null || String(cell.v).trim() === "") {
                  sheet[addr] = {
                    t: startCell.t || "s",
                    v: startCell.v,
                    w: startCell.w,
                  };
                }
              }
            }
          }
        }

        function findHeaderRowIndex(rows) {
          const maxScan = Math.min(35, rows.length);
          for (let i = 0; i < maxScan; i++) {
            const row = rows[i] || [];
            for (const cell of row) {
              const s = normalizeText(cell);
              if (/(성\s*명|성명|이름)/.test(s)) return i;
            }
          }
          return -1;
        }

        function decideHeaderDepth(rows, headerIdx) {
          const row2 = rows[headerIdx + 1] || [];
          const hay = normalizeKey(row2.join(" "));
          const looks = ["직급", "부서", "학교", "기관", "근무지", "직종", "직렬", "교육지원청", "시군", "호봉", "비고", "구분"].some((k) =>
            hay.includes(normalizeKey(k))
          );
          return looks ? 2 : 1;
        }

        function buildHeaders(rows, headerIdx, depth) {
          const r1 = rows[headerIdx] || [];
          const r2 = rows[headerIdx + 1] || [];
          const maxCols = Math.max(r1.length, r2.length, 10);

          const headers = [];
          for (let c = 0; c < maxCols; c++) {
            const a = normalizeText(r1[c] ?? "");
            const b = depth === 2 ? normalizeText(r2[c] ?? "") : "";
            const h = normalizeText(`${a} ${b}`.trim());
            headers.push(h);
          }
          return headers;
        }

        function analyzeHeader(header) {
          const h = normalizeKey(header);
          const side = h.includes("현") ? "cur" : h.includes("발령") || h.includes("임용") ? "new" : "other";

          let role = "other";
          if (/(성명|이름)/.test(h)) role = "name";
          else if (/(구분|비고|사유|전소속)/.test(h)) role = "action";
          else if (/(직급|직종|직렬|교과|과목|직위|직명)/.test(h)) role = "rankOrType";
          else if (/(부서|기관|근무지|학교|교육지원청|시군|지역|소속|근무처)/.test(h)) role = "org";

          return { side, role };
        }

        function isValidName(name) {
          const n0 = normalizeText(name).replace(/[◆□○●]/g, "").replace(/\s+/g, "");
          if (!n0) return false;

          // ✅ 특수문자/숫자 포함 이름 제외: 한글 2~6자만 허용
          if (!/^[가-힣]{2,6}$/.test(n0)) return false;

          // ✅ 병합 오류 잔상(지역/교육장) 제외
          if (n0.includes("교육장")) return false;
          if (REGION_17.includes(n0)) return false; // "원주", "홍천" 등이 성명 칸에 들어간 경우 제거

          // 헤더/합계 제거
          if (/(성명|이름|합계|계|연번|일련|번호)/.test(n0)) return false;

          return true;
        }

        function applyRegulationFallback(rec) {
          // 발령/임용 쪽에 조례/시행규칙이 들어가면: 현근무지를 학교/기관명으로 사용
          const need = recordHasKeywordText(rec, REGULATION_KW);
          if (!need) return;

          if (rec.curOrg) {
            rec.newOrg = rec.curOrg;
            if (!rec.newRank && rec.curRank) rec.newRank = rec.curRank;
            state.stats.appliedRegulationFallback += 1;
          }
        }

        function extractRecordsFromSheet(rows, meta) {
          const headerIdx = findHeaderRowIndex(rows);
          if (headerIdx < 0) return [];

          const depth = decideHeaderDepth(rows, headerIdx);
          const headers = buildHeaders(rows, headerIdx, depth);

          let nameCol = -1;
          for (let i = 0; i < headers.length; i++) {
            if (/(성\s*명|성명|이름)/.test(headers[i])) {
              nameCol = i;
              break;
            }
          }
          if (nameCol < 0) return [];

          const colMeta = headers.map((h) => ({ header: h, ...analyzeHeader(h) }));

          const out = [];
          const startRow = headerIdx + depth;
          for (let r = startRow; r < rows.length; r++) {
            const row = rows[r] || [];
            const nameRaw = normalizeText(row[nameCol] ?? "");
            if (!isValidName(nameRaw)) {
              state.stats.skippedInvalidName += 1;
              continue;
            }

            const newRankParts = [];
            const newOrgParts = [];
            const curRankParts = [];
            const curOrgParts = [];
            const actionParts = [];
            const jobRawParts = [];

            for (let c = 0; c < colMeta.length; c++) {
              const v = normalizeText(row[c] ?? "");
              if (!v) continue;

              const m = colMeta[c];

              if (m.role === "action") actionParts.push(v);
              if (m.role === "rankOrType") jobRawParts.push(v);

              if (m.side === "new") {
                if (m.role === "rankOrType") newRankParts.push(v);
                else if (m.role === "org") newOrgParts.push(v);
              } else if (m.side === "cur") {
                if (m.role === "rankOrType") curRankParts.push(v);
                else if (m.role === "org") curOrgParts.push(v);
              }
            }

            const rec = {
              id: `${meta.fileName}__${meta.sheetName}__${r + 1}`,
              fileName: meta.fileName,
              sheetName: meta.sheetName,
              rowIndex: r + 1,

              name: normalizeText(nameRaw).replace(/[◆□○●]/g, "").trim(),
              nameKey: normalizeKey(nameRaw),

              newRank: normalizeText(newRankParts.join(" / ")),
              newOrg: normalizeText(newOrgParts.join(" ")),
              curRank: normalizeText(curRankParts.join(" / ")),
              curOrg: normalizeText(curOrgParts.join(" ")),
              action: normalizeText(actionParts.join(" / ")),
              jobRaw: normalizeText(jobRawParts.join(" / ")),

              fileRegionHint: meta.fileRegionHint || "",
            };

            // ✅ 학교 약칭/병설 표기 정규화(텍스트 단계)
            rec.curOrg = normalizeOrgText(rec.curOrg);
            rec.newOrg = normalizeOrgText(rec.newOrg);

            // ✅ 조례/시행규칙이 발령/임용 쪽에 있으면 newOrg를 curOrg로 대체
            applyRegulationFallback(rec);

            // 엔티티/지역 추정
            rec.newEntity = detectEntity(rec.newOrg, rec.fileRegionHint);
            rec.curEntity = detectEntity(rec.curOrg, rec.fileRegionHint);

            rec.newRegion = canonicalRegionName(inferRegionFromText(rec.newOrg, rec.fileRegionHint));
            rec.curRegion = canonicalRegionName(inferRegionFromText(rec.curOrg, rec.fileRegionHint));

            // ✅ 학교는 "전체 학교 목록" 주소 기반 시군구로 덮어쓰기(고등학교 포함)
            const srN = regionFromSchoolEntity(rec.newEntity);
            if (srN) rec.newRegion = srN;
            const srC = regionFromSchoolEntity(rec.curEntity);
            if (srC) rec.curRegion = srC;

            rec.personnelType = detectPersonnelType(rec);
            rec.isRetire = isRetire(rec);
            rec.isPlaceholder = isPlaceholder(rec);
            rec.jobKey = detectJobKey(rec);

            out.push(rec);
          }

          return out;
        }

        function qualityScore(rec) {
          let s = 0;
          if (rec.name) s += 10;
          if (rec.curOrg) s += 8;
          if (rec.newOrg) s += 10;
          if (!rec.isPlaceholder) s += 30;
          if (rec.newEntity && rec.newEntity.kind !== "unknown") s += 8;
          if (rec.curEntity && rec.curEntity.kind !== "unknown") s += 5;
          if (rec.isPlaceholder) s -= 40;
          if (rec.newEntity && rec.newEntity.kind === "school") s += 4;
          if (rec.newEntity && rec.newEntity.kind === "inst" && rec.newEntity.name.includes("교육지원청")) s += 3;
          return s;
        }

        function dedupeRecords(records) {
          const groups = new Map();

          for (const rec of records) {
            const curKey = normalizeKey(rec.curOrg);
            const newKey = normalizeKey(rec.newOrg);

            const baseKey = curKey ? `${rec.nameKey}|${rec.personnelType}|CUR|${curKey}` : `${rec.nameKey}|${rec.personnelType}|NEW|${newKey}`;

            if (!groups.has(baseKey)) groups.set(baseKey, []);
            groups.get(baseKey).push(rec);
          }

          const picked = [];
          for (const arr of groups.values()) {
            if (arr.length === 1) {
              picked.push(arr[0]);
              continue;
            }

            const nonPlaceholder = arr.filter((r) => !r.isPlaceholder);
            const cand = nonPlaceholder.length ? nonPlaceholder : arr;

            cand.sort((a, b) => qualityScore(b) - qualityScore(a));
            picked.push(cand[0]);
          }

          // 오름차순
          picked.sort((a, b) => {
            const n = a.name.localeCompare(b.name, "ko");
            if (n !== 0) return n;
            const f = a.fileName.localeCompare(b.fileName, "ko");
            if (f !== 0) return f;
            return (a.sheetName || "").localeCompare(b.sheetName || "", "ko");
          });

          return picked;
        }

        function buildSchoolMeta(records) {
          const m = new Map();
          for (const rec of records) {
            for (const ent of [rec.curEntity, rec.newEntity]) {
              if (!ent || ent.kind !== "school" || !ent.baseName) continue;
              if (!m.has(ent.baseName)) m.set(ent.baseName, { hasAttached: false });
              if (normalizeKey(ent.name).includes("병설유")) m.get(ent.baseName).hasAttached = true;
            }
          }
          return m;
        }

        /* =========================
           집계 계산
           ========================= */

        function moveKindByRegions(rec) {
          const curIn = isKnownRegion(rec.curRegion);
          const newIn = isKnownRegion(rec.newRegion);

          if (rec.isRetire) return "퇴직";
          if (curIn && newIn) return "전보/이동";
          if (!curIn && newIn) return "전입만";
          if (curIn && !newIn) return "전출/퇴직만";
          return "기타";
        }

        function instKeyFromEntity(ent) {
          if (!ent) return "";
          if (ent.kind === "school") return ent.baseName || ent.name || "";
          if (ent.kind === "inst") return ent.name || "";
          return ent.name || "";
        }

        function computeAggregates() {
          const personKey = (rec) => rec.nameKey + "|" + rec.personnelType + "|" + normalizeKey(rec.curOrg) + "|" + normalizeKey(rec.newOrg);

          const regionMap = new Map();
          const instMap = new Map();

          function ensureRegion(r) {
            if (!regionMap.has(r)) {
              regionMap.set(r, {
                region: r,
                institutions: new Set(),
                incoming: new Set(),
                outgoing: new Set(),
                stay: new Set(),
                retire: new Set(),
                persons: new Set(),
              });
            }
            return regionMap.get(r);
          }

          function ensureInst(region, instName) {
            const key = `${region}||${instName}`;
            if (!instMap.has(key)) {
              instMap.set(key, {
                region,
                instName,
                incoming: new Set(),
                outgoing: new Set(),
                persons: new Set(),
              });
            }
            return instMap.get(key);
          }

          const kpi = {
            total: 0,
            move: 0,
            inOnly: 0,
            outOrRetireOnly: 0,
            regionCount: 0,
            instCount: 0,
          };

          kpi.total = state.records.length;

          const regionSetAll = new Set();
          const instSetAll = new Set();

          for (const rec of state.records) {
            const pk = personKey(rec);

            const curR = rec.curRegion || "";
            const newR = rec.newRegion || "";

            const curEntKey = instKeyFromEntity(rec.curEntity) || normalizeText(rec.curOrg) || "";
            const newEntKey = instKeyFromEntity(rec.newEntity) || normalizeText(rec.newOrg) || "";

            if (curR) regionSetAll.add(curR);
            if (newR) regionSetAll.add(newR);

            if (curEntKey) instSetAll.add(curEntKey);
            if (newEntKey) instSetAll.add(newEntKey);

            const mk = moveKindByRegions(rec);
            if (mk === "전보/이동") kpi.move++;
            else if (mk === "전입만") kpi.inOnly++;
            else if (mk === "전출/퇴직만" || mk === "퇴직") kpi.outOrRetireOnly++;

            if (curR) {
              const rr = ensureRegion(curR);
              rr.persons.add(pk);
              rr.outgoing.add(pk);
              if (rec.isRetire) rr.retire.add(pk);
              if (curEntKey) rr.institutions.add(curEntKey);

              const inst = ensureInst(curR, curEntKey || "(미상)");
              inst.persons.add(pk);
              inst.outgoing.add(pk);
            }

            if (newR) {
              const rr = ensureRegion(newR);
              rr.persons.add(pk);
              rr.incoming.add(pk);
              if (curR && newR && curR === newR && !rec.isRetire) rr.stay.add(pk);
              if (newEntKey) rr.institutions.add(newEntKey);

              const inst = ensureInst(newR, newEntKey || "(미상)");
              inst.persons.add(pk);
              inst.incoming.add(pk);
            }
          }

          kpi.regionCount = regionSetAll.size;
          kpi.instCount = instSetAll.size;

          const regionRows = Array.from(regionMap.values()).map((r) => ({
            region: r.region,
            instCount: r.institutions.size,
            incoming: r.incoming.size,
            outgoing: r.outgoing.size,
            stay: r.stay.size,
            retire: r.retire.size,
            persons: r.persons.size,
          }));

          const instRows = Array.from(instMap.values()).map((x) => ({
            region: x.region,
            instName: x.instName || "(미상)",
            incoming: x.incoming.size,
            outgoing: x.outgoing.size,
            persons: x.persons.size,
          }));

          regionRows.sort((a, b) => a.region.localeCompare(b.region, "ko"));
          instRows.sort((a, b) => {
            const r = a.region.localeCompare(b.region, "ko");
            if (r !== 0) return r;
            return a.instName.localeCompare(b.instName, "ko");
          });

          state.aggregates = { kpi, regionRows, instRows };
        }

        /* =========================
           렌더링: 결과/대시보드
           ========================= */

        function renderEmptyResults() {
          el.kpiGrid.innerHTML = "";
          el.regionTableBody.innerHTML =
            '<tr><td colspan="7" class="muted" style="text-align:center">아직 집계 결과가 없습니다.</td></tr>';
          el.instTableBody.innerHTML =
            '<tr><td colspan="5" class="muted" style="text-align:center">아직 집계 결과가 없습니다.</td></tr>';
          el.regionTableCount.textContent = "0건";
          el.instTableCount.textContent = "0건";

          el.entityOutPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.entityInPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.entityUnknownPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.entityOutCount.textContent = "0명";
          el.entityInCount.textContent = "0명";
          el.entityUnknownSummary.textContent = "미분류 (0명)";

          el.regionOutPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionInPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionStayPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionUnknownPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionOutCount.textContent = "0명";
          el.regionInCount.textContent = "0명";
          el.regionStayCount.textContent = "0명";
          el.regionUnknownSummary.textContent = "미분류 (0명)";

          el.btnDownloadAll.disabled = true;
          el.btnDownloadFiltered.disabled = true;
          el.btnGoEntity.disabled = true;
          el.btnGoRegion.disabled = true;
          el.btnExportRegionView.disabled = true;
        }

        function lockFilters(lock) {
          el.regionSearch.disabled = lock;
          el.instSearch.disabled = lock;

          el.entityKind.disabled = lock;
          el.entityName.disabled = lock;
          el.personnelType.disabled = lock;
          el.jobFilter.disabled = lock;

          el.officeMode.disabled = lock;
          el.regionPick.disabled = lock;
          el.regionPersonnelType.disabled = lock;
        }

        function renderKpi() {
          const k = state.aggregates.kpi;

          const cards = [
            { label: "전체 인원", value: k.total ?? 0, hint: "중복 제거 후" },
            { label: "전보/이동", value: k.move ?? 0, hint: "강원권 ↔ 강원권" },
            { label: "전입만", value: k.inOnly ?? 0, hint: "강원권 밖 → 강원권" },
            { label: "전출/퇴직만", value: k.outOrRetireOnly ?? 0, hint: "강원권 → 밖/퇴직" },
            { label: "지역 / 기관", value: `${k.regionCount ?? 0} / ${k.instCount ?? 0}`, hint: "등장한 고유 개수" },
          ];

          el.kpiGrid.innerHTML = cards
            .map(
              (c, idx) => `
              <div class="kpi" data-kpi="${idx}">
                <div class="label">${escapeHtml(c.label)}</div>
                <div class="value">${escapeHtml(c.value)}</div>
                <div class="hint">${escapeHtml(c.hint || "")}</div>
              </div>
            `
            )
            .join("");

          el.kpiGrid.querySelectorAll(".kpi").forEach((node, idx) => {
            node.addEventListener("click", () => {
              if (idx === 4) {
                scrollToId("sec-summary");
                return;
              }
              if (idx === 1 || idx === 2 || idx === 3) scrollToId("sec-region");
              else scrollToId("sec-entity");
            });
          });
        }

        function displayInstName(instName) {
          const meta = state.schoolMeta.get(instName);
          if (meta && meta.hasAttached) return `${instName} 및 병설유치원`;
          return instName;
        }

        function renderRegionTable() {
          const q = normalizeText(el.regionSearch.value || "");
          const rows = state.aggregates.regionRows.filter((r) => (q ? r.region.includes(q) : true));

          el.regionTableCount.textContent = `${rows.length}건`;

          if (!rows.length) {
            el.regionTableBody.innerHTML =
              '<tr><td colspan="7" class="muted" style="text-align:center">검색 결과가 없습니다.</td></tr>';
            return;
          }

          el.regionTableBody.innerHTML = rows
            .map(
              (r) => `
              <tr>
                <td>${escapeHtml(r.region)}</td>
                <td class="numeric">${r.instCount}</td>
                <td class="numeric">${r.incoming}</td>
                <td class="numeric">${r.outgoing}</td>
                <td class="numeric">${r.stay}</td>
                <td class="numeric">${r.retire}</td>
                <td class="numeric">${r.persons}</td>
              </tr>
            `
            )
            .join("");
        }

        function renderInstTable() {
          const q = normalizeText(el.instSearch.value || "");
          const rows = state.aggregates.instRows.filter((r) => {
            if (!q) return true;
            return r.region.includes(q) || displayInstName(r.instName).includes(q);
          });

          el.instTableCount.textContent = `${rows.length}건`;

          if (!rows.length) {
            el.instTableBody.innerHTML =
              '<tr><td colspan="5" class="muted" style="text-align:center">검색 결과가 없습니다.</td></tr>';
            return;
          }

          el.instTableBody.innerHTML = rows
            .map(
              (r) => `
              <tr>
                <td>${escapeHtml(r.region)}</td>
                <td>${escapeHtml(displayInstName(r.instName))}</td>
                <td class="numeric">${r.incoming}</td>
                <td class="numeric">${r.outgoing}</td>
                <td class="numeric">${r.persons}</td>
              </tr>
            `
            )
            .join("");
        }

        function renderSummary() {
          renderKpi();
          renderRegionTable();
          renderInstTable();

          el.btnDownloadAll.disabled = false;
          el.btnDownloadFiltered.disabled = false;
          el.btnGoEntity.disabled = false;
          el.btnGoRegion.disabled = false;

          el.regionSearch.disabled = false;
          el.instSearch.disabled = false;
        }

        /* =========================
           섹션3(학교/기관) 필터
           ========================= */

        function buildEntityOptions() {
          const schools = Array.from(state.schoolMeta.entries())
            .map(([baseName, meta]) => ({
              value: baseName,
              label: meta.hasAttached ? `${baseName} 및 병설유치원` : baseName,
            }))
            .sort((a, b) => a.label.localeCompare(b.label, "ko"));

          const instSet = new Set();
          for (const rec of state.records) {
            for (const ent of [rec.curEntity, rec.newEntity]) {
              if (!ent) continue;
              if (ent.kind === "inst" && ent.name) instSet.add(ent.name);
            }
          }
          const insts = Array.from(instSet)
            .sort((a, b) => a.localeCompare(b, "ko"))
            .map((name) => ({ value: name, label: name }));

          return { schools, insts };
        }

        function buildPersonnelTypeOptions() {
          const types = new Set(state.records.map((r) => r.personnelType));
          const list = Array.from(types).sort((a, b) => a.localeCompare(b, "ko"));
          return ["전체", ...list];
        }

        function buildJobOptions(personnelType) {
          if (personnelType === "지방공무원") return ["전체", ...LOCAL_GOV_SERIES];
          if (personnelType === "교육공무직") return ["전체", ...EDU_LABOR_JOBS.slice().sort((a, b) => a.localeCompare(b, "ko"))];
          if (personnelType === "교육공무원") return ["전체", ...TEACHER_CATEGORIES];

          const s = new Set();
          for (const r of state.records) {
            if (personnelType !== "전체" && r.personnelType !== personnelType) continue;
            if (r.jobKey) s.add(r.jobKey);
            if (s.size > 200) break;
          }
          const arr = Array.from(s).sort((a, b) => a.localeCompare(b, "ko"));
          return ["전체", ...arr];
        }

        function setSelectOptions(selectEl, options, placeholder = "선택") {
          const html = options
            .map((o) => {
              if (typeof o === "string") return `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`;
              return `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`;
            })
            .join("");
          selectEl.innerHTML = `<option value="">${escapeHtml(placeholder)}</option>` + html;
        }

        function initEntityFilters() {
          el.entityKind.disabled = false;
          el.entityKind.value = "";

          el.entityName.disabled = true;
          el.personnelType.disabled = true;
          el.jobFilter.disabled = true;

          el.entityName.innerHTML = '<option value="">먼저 1) 구분을 선택하세요</option>';
          el.personnelType.innerHTML = '<option value="">먼저 2) 학교/기관을 선택하세요</option>';
          el.jobFilter.innerHTML = '<option value="">먼저 3) 인사 구분을 선택하세요</option>';

          el.entityKind.onchange = () => {
            const kind = el.entityKind.value;
            if (!kind) {
              el.entityName.disabled = true;
              el.personnelType.disabled = true;
              el.jobFilter.disabled = true;
              el.entityName.innerHTML = '<option value="">먼저 1) 구분을 선택하세요</option>';
              return;
            }

            const { schools, insts } = buildEntityOptions();
            const list = kind === "school" ? schools : insts;

            el.entityName.disabled = false;
            setSelectOptions(el.entityName, [{ value: "__ALL__", label: "전체 조회" }, ...list], "선택");

            el.entityName.value = "__ALL__";
            el.personnelType.disabled = false;
            setSelectOptions(el.personnelType, buildPersonnelTypeOptions(), "선택");
            el.personnelType.value = "전체";

            el.jobFilter.disabled = false;
            setSelectOptions(el.jobFilter, buildJobOptions("전체"), "선택");
            el.jobFilter.value = "전체";

            renderEntityView();
          };

          el.entityName.onchange = () => {
            el.personnelType.disabled = false;
            renderEntityView();
          };

          el.personnelType.onchange = () => {
            const t = el.personnelType.value || "전체";
            el.jobFilter.disabled = false;
            setSelectOptions(el.jobFilter, buildJobOptions(t), "선택");
            el.jobFilter.value = "전체";
            renderEntityView();
          };

          el.jobFilter.onchange = () => {
            renderEntityView();
          };
        }

        function filterByEntityAndType(rec, kind, entityValue) {
          if (!kind) return false;

          const matchEntity = (ent) => {
            if (!ent) return false;

            if (kind === "school") {
              if (ent.kind !== "school") return false;
              if (entityValue === "__ALL__") return true;
              return ent.baseName === entityValue;
            }

            if (ent.kind !== "inst") return false;
            if (entityValue === "__ALL__") return true;
            return ent.name === entityValue;
          };

          return matchEntity(rec.curEntity) || matchEntity(rec.newEntity);
        }

        function filterByPersonnelAndJob(rec, personnelType, jobFilter) {
          const pt = personnelType && personnelType !== "전체" ? personnelType : "";
          const jf = jobFilter && jobFilter !== "전체" ? jobFilter : "";

          if (pt && rec.personnelType !== pt) return false;
          if (jf && rec.jobKey !== jf) return false;

          return true;
        }

        function renderRecordsTable(records) {
          if (!records.length) return '<div class="muted">해당 없음</div>';

          // 오름차순(이름)
          const sorted = records.slice().sort((a, b) => {
            const n = a.name.localeCompare(b.name, "ko");
            if (n !== 0) return n;
            const c = (a.curOrg || "").localeCompare(b.curOrg || "", "ko");
            if (c !== 0) return c;
            return (a.newOrg || "").localeCompare(b.newOrg || "", "ko");
          });

          const rowsHtml = sorted
            .map(
              (r) => `
              <tr>
                <td>${escapeHtml(r.name)}</td>
                <td>${escapeHtml(r.personnelType)}</td>
                <td>${escapeHtml(r.jobKey || "")}</td>
                <td>${escapeHtml(r.curRank || "")}</td>
                <td>${escapeHtml(r.curOrg || "")}</td>
                <td>${escapeHtml(r.newRank || "")}</td>
                <td>${escapeHtml(r.newOrg || "")}</td>
                <td>${escapeHtml(r.curRegion || "")}</td>
                <td>${escapeHtml(r.newRegion || "")}</td>
                <td>${escapeHtml(r.action || "")}</td>
              </tr>
            `
            )
            .join("");

          return `
            <div class="records-wrap">
              <table class="sheetlike">
                <thead>
                  <tr>
                    <th style="min-width:120px">성명</th>
                    <th style="min-width:120px">구분</th>
                    <th style="min-width:140px">직렬/직종</th>
                    <th style="min-width:140px">현직급/직종</th>
                    <th style="min-width:240px">현소속/근무지</th>
                    <th style="min-width:140px">발령직급/직종</th>
                    <th style="min-width:240px">발령소속/근무지</th>
                    <th style="min-width:110px">현지역</th>
                    <th style="min-width:110px">발령지역</th>
                    <th style="min-width:180px">구분/비고</th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;
        }

        function renderEntityView() {
          const kind = el.entityKind.value;
          const entityValue = el.entityName.value || "__ALL__";
          const personnelType = el.personnelType.value || "전체";
          const jobFilter = el.jobFilter.value || "전체";

          if (!kind) return;

          const baseFiltered = state.records.filter(
            (rec) => filterByEntityAndType(rec, kind, entityValue) && filterByPersonnelAndJob(rec, personnelType, jobFilter)
          );

          const matchEntity = (ent) => {
            if (!ent) return false;
            if (kind === "school") {
              if (ent.kind !== "school") return false;
              if (entityValue === "__ALL__") return true;
              return ent.baseName === entityValue;
            }
            if (ent.kind !== "inst") return false;
            if (entityValue === "__ALL__") return true;
            return ent.name === entityValue;
          };

          const outList = [];
          const inList = [];
          const unknownList = [];

          for (const rec of baseFiltered) {
            const curHit = matchEntity(rec.curEntity);
            const newHit = matchEntity(rec.newEntity);

            const sameEntity =
              kind === "school"
                ? rec.curEntity?.baseName && rec.newEntity?.baseName && rec.curEntity.baseName === rec.newEntity.baseName
                : rec.curEntity?.name && rec.newEntity?.name && rec.curEntity.name === rec.newEntity.name;

            const isDispatch = recordHasKeywordText(rec, DISPATCH_KW);

            if (curHit && (!newHit || (newHit && !sameEntity) || rec.isRetire)) {
              outList.push(rec);
              continue;
            }

            if (newHit && (!curHit || (curHit && !sameEntity) || isDispatch)) {
              inList.push(rec);
              continue;
            }

            if (curHit || newHit) unknownList.push(rec);
          }

          el.entityOutCount.textContent = `${outList.length}명`;
          el.entityInCount.textContent = `${inList.length}명`;
          el.entityUnknownSummary.textContent = `미분류 (${unknownList.length}명)`;

          el.entityOutPanel.innerHTML = renderRecordsTable(outList);
          el.entityInPanel.innerHTML = renderRecordsTable(inList);
          el.entityUnknownPanel.innerHTML = renderRecordsTable(unknownList);

          state.currentExport = {
            title: `섹션3 조회 결과 (${kind === "school" ? "학교" : "기관"} / ${entityValue} / ${personnelType} / ${jobFilter})`,
            rows: baseFiltered,
          };

          el.btnDownloadFiltered.disabled = false;
        }

        /* =========================
           섹션4(지역) 필터
           ========================= */

        function initRegionFilters() {
          el.officeMode.disabled = false;
          el.officeMode.value = "";
          el.regionPick.disabled = true;
          el.regionPersonnelType.disabled = true;

          el.regionPick.innerHTML = '<option value="">먼저 1) 처리 방식을 선택하세요</option>';
          el.regionPersonnelType.innerHTML = '<option value="">먼저 2) 지역을 선택하세요</option>';

          el.officeMode.onchange = () => {
            const mode = el.officeMode.value;
            if (!mode) {
              el.regionPick.disabled = true;
              el.regionPersonnelType.disabled = true;
              return;
            }

            el.regionPick.disabled = false;
            const regions = mode === "separate" ? REGION_18 : REGION_17;
            setSelectOptions(el.regionPick, regions, "선택");
            el.regionPick.value = regions[0] || "";

            el.regionPersonnelType.disabled = false;
            setSelectOptions(el.regionPersonnelType, buildPersonnelTypeOptions(), "선택");
            el.regionPersonnelType.value = "전체";

            renderRegionView();
          };

          el.regionPick.onchange = () => {
            el.regionPersonnelType.disabled = false;
            renderRegionView();
          };

          el.regionPersonnelType.onchange = () => {
            renderRegionView();
          };
        }

        function applyOfficeModeToRegion(region, mode) {
          if (!region) return "";
          if (mode === "merge" && region === "강원도교육청") return "춘천";
          return region;
        }

        function renderRegionView() {
          const mode = el.officeMode.value; // separate | merge
          const pick = el.regionPick.value;
          const personnelType = el.regionPersonnelType.value || "전체";
          if (!mode || !pick) return;

          const viewCur = (rec) => applyOfficeModeToRegion(rec.curRegion, mode);
          const viewNew = (rec) => applyOfficeModeToRegion(rec.newRegion, mode);

          const filtered = state.records.filter((rec) => {
            if (personnelType && personnelType !== "전체" && rec.personnelType !== personnelType) return false;
            const c = viewCur(rec);
            const n = viewNew(rec);
            return c === pick || n === pick;
          });

          const outList = [];
          const inList = [];
          const stayList = [];
          const unknownList = [];

          for (const rec of filtered) {
            const c = viewCur(rec);
            const n = viewNew(rec);

            if (c === pick && (rec.isRetire || n !== pick)) {
              outList.push(rec);
              continue;
            }
            if (n === pick && c !== pick) {
              inList.push(rec);
              continue;
            }
            if (c === pick && n === pick && !rec.isRetire) {
              stayList.push(rec);
              continue;
            }
            unknownList.push(rec);
          }

          el.regionOutCount.textContent = `${outList.length}명`;
          el.regionInCount.textContent = `${inList.length}명`;
          el.regionStayCount.textContent = `${stayList.length}명`;
          el.regionUnknownSummary.textContent = `미분류 (${unknownList.length}명)`;

          el.regionOutPanel.innerHTML = renderRecordsTable(outList);
          el.regionInPanel.innerHTML = renderRecordsTable(inList);
          el.regionStayPanel.innerHTML = renderRecordsTable(stayList);
          el.regionUnknownPanel.innerHTML = renderRecordsTable(unknownList);

          state.currentExport = {
            title: `섹션4 조회 결과 (${mode === "separate" ? "도교육청 분리" : "춘천 합산"} / ${pick} / ${personnelType})`,
            rows: filtered,
          };

          el.btnExportRegionView.disabled = false;
          el.btnDownloadFiltered.disabled = false;
        }

        /* =========================
           다운로드(XLSX)
           ========================= */
        function toExportRow(rec) {
          return {
            성명: rec.name,
            구분: rec.personnelType,
            직렬_직종: rec.jobKey,
            현직급_직종: rec.curRank,
            현소속_근무지: rec.curOrg,
            발령직급_직종: rec.newRank,
            발령소속_근무지: rec.newOrg,
            현지역: rec.curRegion,
            발령지역: rec.newRegion,
            구분_비고: rec.action,
          };
        }

        function downloadWorkbookFromRows(rows, filename, sheetName = "명단") {
          if (!state.xlsxReady || !window.XLSX) {
            alert("XLSX 라이브러리가 아직 준비되지 않았습니다.");
            return;
          }
          const wb = XLSX.utils.book_new();
          const data = rows.map(toExportRow);
          const ws = XLSX.utils.json_to_sheet(data);
          XLSX.utils.book_append_sheet(wb, ws, sheetName);

          const safe = filename.replace(/[\\/:*?"<>|]/g, "_");
          XLSX.writeFile(wb, safe);
        }

        function downloadCurrent() {
          const rows = state.currentExport.rows && state.currentExport.rows.length ? state.currentExport.rows : state.records;
          const title = state.currentExport.title || "현재 조회 결과";
          const filename = `${title}.xlsx`;
          downloadWorkbookFromRows(rows, filename, "조회결과");
        }

        function downloadAll() {
          downloadWorkbookFromRows(state.records, "전체_인사발령_명단.xlsx", "전체");
        }

        /* =========================
           분석 실행
           ========================= */

        async function readFileAsArrayBuffer(file) {
          return new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => resolve(fr.result);
            fr.onerror = () => reject(new Error("파일 읽기 실패"));
            fr.readAsArrayBuffer(file);
          });
        }

        async function analyzeAllFiles() {
          if (!state.files.length) return;
          if (!(await ensureXlsxReady())) return;

          // stats reset
          state.stats = { skippedInvalidName: 0, correctedYangToYanggu: 0, appliedRegulationFallback: 0 };

          el.btnAnalyze.disabled = true;
          el.btnAddFiles.disabled = true;
          el.btnResetFiles.disabled = true;
          lockFilters(true);

          setStatusBox("", "");
          setProgress("파일 분석 준비…", 1, "1%");
          log(`분석 시작: ${state.files.length}개 파일`);

          const all = [];
          const filesSorted = state.files.slice().sort((a, b) => a.name.localeCompare(b.name, "ko"));

          for (let i = 0; i < filesSorted.length; i++) {
            const f = filesSorted[i];
            const hint = regionHintFromFileName(f.name);

            const pctBase = Math.round((i / filesSorted.length) * 100);
            setProgress("파일 분석 중…", Math.min(99, pctBase), `${pctBase}%`, `${i + 1}/${filesSorted.length}  ${f.name}`);
            log(`읽는 중: ${f.name}`);

            let wb;
            try {
              const buf = await readFileAsArrayBuffer(f);
              wb = XLSX.read(buf, { type: "array", cellDates: true });
            } catch (e) {
              log(`⚠️ 파일 파싱 실패: ${f.name} (${e.message})`);
              continue;
            }

            const sheets = wb.SheetNames || [];
            for (let s = 0; s < sheets.length; s++) {
              const sheetName = sheets[s];
              const sheet = wb.Sheets[sheetName];
              if (!sheet) continue;

              try {
                fillMergedCells(sheet);

                const rows = XLSX.utils.sheet_to_json(sheet, {
                  header: 1,
                  defval: "",
                  blankrows: false,
                });

                const extracted = extractRecordsFromSheet(rows, {
                  fileName: f.name,
                  sheetName,
                  fileRegionHint: hint,
                });

                if (extracted.length) {
                  all.push(...extracted);
                  log(`  - 시트: ${sheetName} → ${extracted.length}건`);
                }
              } catch (e) {
                log(`⚠️ 시트 처리 실패: ${f.name} / ${sheetName} (${e.message})`);
              }

              if (s % 3 === 2) await sleep(0);
            }

            await sleep(0);
          }

          setProgress("중복 제거 및 집계 중…", 99, "99%");
          log(`원본 추출 건수: ${all.length}건`);

          state.recordsRaw = all;
          state.records = dedupeRecords(all);

          // ✅ 병설유치원 메타(합산/표기)
          state.schoolMeta = buildSchoolMeta(state.records);

          log(`중복 제거 후: ${state.records.length}건`);
          computeAggregates();

          setProgress("완료", 100, "100%");

          setStatusBox(
            "ok",
            `분석 완료: <b>${state.records.length.toLocaleString()}</b>명 (원본 ${state.recordsRaw.length.toLocaleString()}건 → 중복 제거 후)<br/>
             - 성명 오류/병합 잔상 무시: <b>${state.stats.skippedInvalidName.toLocaleString()}</b>건<br/>
             - "양" → "양구" 교정: <b>${state.stats.correctedYangToYanggu.toLocaleString()}</b>건<br/>
             - 조례/시행규칙(현근무지로 대체): <b>${state.stats.appliedRegulationFallback.toLocaleString()}</b>건`
          );

          renderSummary();
          lockFilters(false);

          initEntityFilters();
          initRegionFilters();

          el.btnDownloadAll.disabled = false;
          el.btnDownloadFiltered.disabled = false;
          el.btnGoEntity.disabled = false;
          el.btnGoRegion.disabled = false;

          el.btnAnalyze.disabled = false;
          el.btnAddFiles.disabled = false;
          el.btnResetFiles.disabled = false;

          updateAnalyzeBtn();
        }

        /* =========================
           이벤트 바인딩
           ========================= */

        function initUploadUI() {
          el.btnAddFiles.addEventListener("click", () => el.fileInput.click());
          el.fileInput.addEventListener("change", (e) => {
            addFiles(e.target.files);
            el.fileInput.value = "";
          });

          el.btnResetFiles.addEventListener("click", resetFiles);
          el.btnAnalyze.addEventListener("click", analyzeAllFiles);

          el.dropzone.addEventListener("dragover", (e) => {
            e.preventDefault();
            el.dropzone.classList.add("dragover");
          });
          el.dropzone.addEventListener("dragleave", () => el.dropzone.classList.remove("dragover"));
          el.dropzone.addEventListener("drop", (e) => {
            e.preventDefault();
            el.dropzone.classList.remove("dragover");
            addFiles(e.dataTransfer.files);
          });

          el.regionSearch.addEventListener("input", () => renderRegionTable());
          el.instSearch.addEventListener("input", () => renderInstTable());

          el.btnGoEntity.addEventListener("click", () => scrollToId("sec-entity"));
          el.btnGoRegion.addEventListener("click", () => scrollToId("sec-region"));

          el.btnDownloadAll.addEventListener("click", downloadAll);
          el.btnDownloadFiltered.addEventListener("click", downloadCurrent);
          el.btnExportRegionView.addEventListener("click", downloadCurrent);

          el.toTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
          window.addEventListener("scroll", () => {
            if (window.scrollY > 600) el.toTopBtn.classList.add("show");
            else el.toTopBtn.classList.remove("show");
          });
        }

        async function init() {
          renderEmptyResults();
          renderFileTable();
          initUploadUI();

          const ok = await ensureXlsxReady();
          updateAnalyzeBtn();

          if (ok) {
            el.xlsxBadge.textContent = "XLSX: 준비됨";
            setProgress("라이브러리 로드 완료", 100, "100%");
            log("초기화 완료");
          } else {
            log("XLSX 로드 실패 상태로 시작");
          }
        }

        init();
      })();
    </script>

    <script src="/static/disable-copy.js"></script>
<script src="/static/footer.js"></script>
<script src="/static/global-loader.js?v=1"></script>
    
  </body>
</html>
