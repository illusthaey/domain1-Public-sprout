<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>강원도교육청 인사발령 집계기</title>


    <link rel="stylesheet" href="/static/style.css" />

    <style>
      /* =========================
         이 HTML 전용 보강 스타일
         (공통 /static/style.css 위에 덧씌움)
         ========================= */

      .step-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 0 10px;
      }
      .step-badge {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.95rem;
        color: #fff;
        background: #111;
        flex: 0 0 auto;
      }

      .section h2 {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .dropzone {
        margin-top: 12px;
        border: 2px dashed #d4d4d8;
        border-radius: 14px;
        padding: 18px;
        background: #fafafa;
        min-height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: background-color 0.15s ease, border-color 0.15s ease;
        user-select: none;
      }
      .dropzone.dragover {
        background: #eef2ff;
        border-color: #b4b4d0;
      }
      .dropzone strong {
        color: #111;
      }

      .progress-wrap {
        margin-top: 14px;
      }
      .progress-title {
        font-weight: 700;
        color: #111;
        margin-bottom: 8px;
      }
      .progress-bar {
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
        border: 1px solid #e5e5e5;
      }
      .progress-fill {
        width: 0%;
        height: 100%;
        background: #111;
        transition: width 0.1s linear;
      }
      .status-row {
        margin-top: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .file-mini {
        font-size: 0.95rem;
        color: #555;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        font-size: 0.92rem;
        color: #333;
        white-space: nowrap;
      }

      .kpi-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        margin-top: 10px;
      }
      .kpi {
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        background: #fff;
        padding: 14px 16px;
        cursor: pointer;
        transition: background-color 0.12s ease;
      }
      .kpi:hover {
        background: #f9fafb;
      }
      .kpi .label {
        font-size: 0.95rem;
        color: #555;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .kpi .value {
        font-size: 1.8rem;
        font-weight: 900;
        color: #111;
        letter-spacing: -0.02em;
      }
      .kpi .hint {
        margin-top: 6px;
        font-size: 0.9rem;
        color: #666;
      }

      .table-scroll {
        max-height: 420px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
      }
      .table-scroll table {
        min-width: 720px;
        border-collapse: collapse;
      }

      .field-label {
        font-size: 0.95rem;
        color: #555;
        font-weight: 700;
        margin-bottom: 6px;
      }
      .grid.four {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .panel-title-row {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .panel-count {
        font-size: 0.95rem;
        color: #666;
        font-weight: 700;
      }

      .mini-note {
        font-size: 0.95rem;
        color: #555;
        margin-top: 8px;
      }

      .records-wrap {
        max-height: 480px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
      }
      .records-wrap table {
        min-width: 980px;
        border-collapse: collapse;
      }

      .to-top {
        position: fixed;
        left: 18px;
        bottom: 18px;
        width: 46px;
        height: 46px;
        border-radius: 999px;
        border: 1px solid #d4d4d8;
        background: #fff;
        font-size: 22px;
        font-weight: 900;
        color: #111;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        z-index: 9999;
      }
      .to-top.show {
        display: inline-flex;
      }

      .warn {
        border: 1px solid #f1c0c0;
        background: #fff5f5;
        color: #7a1111;
        padding: 10px 12px;
        border-radius: 12px;
        margin-top: 12px;
        font-size: 0.98rem;
      }

      .ok {
        border: 1px solid #cfe7d1;
        background: #f2fbf3;
        color: #0b5120;
        padding: 10px 12px;
        border-radius: 12px;
        margin-top: 12px;
        font-size: 0.98rem;
      }

      details.log {
        margin-top: 14px;
      }
      details.log > summary {
        cursor: pointer;
        font-weight: 800;
        color: #111;
      }
      pre.log {
        margin: 10px 0 0;
        padding: 12px;
        border-radius: 12px;
        background: #0b0f17;
        color: #e6edf3;
        overflow: auto;
        font-size: 0.92rem;
        line-height: 1.5;
        max-height: 320px;
      }
    </style>
  </head>

  <body>
    <header class="site-header">
      <div class="shell">
        <h1>강원도교육청 인사발령 집계기</h1>
        <p class="subtitle">
          ·도발령 및 관내 인사발령 엑셀 파일 전체 업로드하면 학교/기관별, 지역별 발령자 명단 집계해드림.
        </p>
      </div>
    </header>

    <main class="container">
      <!-- =========================
           1) 업로드 섹션
           ========================= -->
      <section id="sec-upload" class="section">
        <div class="step-title">
          <span class="step-badge">1</span>
          <h2 style="margin: 0">인사발령 엑셀파일 업로드</h2>
        </div>

        <p class="sub" style="margin-top: 6px">
          ·드래그해서 업로드 가능. 
        </p>

        <div class="card">
          <div class="row between gap" style="align-items: flex-start">
            <div class="row gap">
              <button class="btn" id="btnAddFiles" type="button">파일 추가하기</button>
              <button class="btn ghost" id="btnResetFiles" type="button">초기화하기</button>
            </div>

            <div class="row gap">
              <button class="btn primary" id="btnAnalyze" type="button" disabled>인사정보 집계하기</button>
            </div>
          </div>

          <input id="fileInput" type="file" multiple accept=".xlsx,.xls,.csv" style="display: none" />

          <div id="dropzone" class="dropzone" aria-label="파일 드래그&드롭 영역">
            <div>
              <div style="font-size: 1.05rem; color: #111; font-weight: 800">여기에 엑셀 파일을 드래그해서 올려주세요</div>
              <div class="muted" style="margin-top: 6px">
                지원 확장자: .xlsx / .xls / .csv (여러 개 동시 가능)
              </div>
            </div>
          </div>

          <div class="row between" style="margin-top: 12px">
            <div class="file-mini">
              업로드된 파일: <b id="fileCount">0</b>개
              <span class="muted"> ·중복 파일은 제외함.</span>
            </div>
            <div class="row gap">
              <span class="pill" id="xlsxBadge">XLSX: 로딩 중…</span>
            </div>
          </div>

          <div class="table-wrap" style="margin-top: 10px">
            <table class="sheetlike" id="fileTable">
              <thead>
                <tr>
                  <th style="min-width: 280px">파일명</th>
                  <th style="min-width: 120px">용량</th>
                  <th style="min-width: 160px">수정</th>
                  <th style="min-width: 90px">삭제</th>
                </tr>
              </thead>
              <tbody id="fileTableBody">
                <tr>
                  <td colspan="4" class="muted" style="text-align: center">아직 업로드된 파일이 없습니다.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="progress-wrap">
            <div class="progress-title" id="statusTitle">라이브러리(XLSX) 불러오는 중…</div>
            <div class="progress-bar" aria-label="진행 상태바">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-row">
              <div class="muted" id="statusDetail">0%</div>
              <div class="muted" id="statusExtra"></div>
            </div>

            <div id="statusBox" class="muted" style="margin-top: 10px"></div>
          </div>
        </div>
      </section>

      <!-- =========================
           2) 전체 집계 결과
           ========================= -->
      <section id="sec-summary" class="section">
        <div class="row between">
          <div class="step-title" style="margin: 0">
            <span class="step-badge">2</span>
            <h2 style="margin: 0">전체 집계 결과 조회</h2>
          </div>
          <div class="row gap">
            <button class="btn pastel-blue" id="btnDownloadFiltered" type="button" disabled>현재 명단 다운로드</button>
            <button class="btn" id="btnDownloadAll" type="button" disabled>전체 명단 다운로드</button>
          </div>
        </div>

        <p class="sub" style="margin-top: 6px">
          집계는 <b>중복(“교육장이 지정하는 부서 근무를 명함” 같은 도·관내 중복)</b>을 자동으로 제거한 결과 기준입니다.
        </p>

        <div class="kpi-grid" id="kpiGrid" aria-label="대시보드 KPI"></div>

        <div class="grid two" style="margin-top: 14px">
          <div>
            <div class="field-label">지역 검색</div>
            <input id="regionSearch" type="text" placeholder="지역 검색 (예: 강릉, 원주)" disabled />
          </div>
          <div>
            <div class="field-label">기관/학교 검색</div>
            <input id="instSearch" type="text" placeholder="기관 검색 (예: 교육지원청, ○○초)" disabled />
          </div>
        </div>

        <div class="grid two" style="margin-top: 12px">
          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">지역별 요약</h3>
              <div class="panel-count" id="regionTableCount">0건</div>
            </div>

            <div class="table-scroll" style="margin-top: 10px">
              <table class="sheetlike" id="regionTable">
                <thead>
                  <tr>
                    <th style="min-width: 180px">지역</th>
                    <th class="numeric" style="min-width: 100px">기관 수</th>
                    <th class="numeric" style="min-width: 100px">전입</th>
                    <th class="numeric" style="min-width: 100px">전출</th>
                    <th class="numeric" style="min-width: 140px">지역변동 없음</th>
                    <th class="numeric" style="min-width: 90px">퇴직</th>
                    <th class="numeric" style="min-width: 90px">인원</th>
                  </tr>
                </thead>
                <tbody id="regionTableBody">
                  <tr>
                    <td colspan="7" class="muted" style="text-align: center">아직 집계 결과가 없습니다.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">기관/학교별 요약</h3>
              <div class="panel-count" id="instTableCount">0건</div>
            </div>

            <div class="table-scroll" style="margin-top: 10px">
              <table class="sheetlike" id="instTable">
                <thead>
                  <tr>
                    <th style="min-width: 160px">지역</th>
                    <th style="min-width: 320px">기관명</th>
                    <th class="numeric" style="min-width: 90px">전입</th>
                    <th class="numeric" style="min-width: 90px">전출</th>
                    <th class="numeric" style="min-width: 90px">인원</th>
                  </tr>
                </thead>
                <tbody id="instTableBody">
                  <tr>
                    <td colspan="5" class="muted" style="text-align: center">아직 집계 결과가 없습니다.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row gap" style="margin-top: 12px; flex-wrap: wrap">
          <button class="btn" id="btnGoEntity" type="button" disabled>학교/기관별 집계로 바로가기</button>
          <button class="btn" id="btnGoRegion" type="button" disabled>지역별 집계로 바로가기</button>
        </div>
      </section>

      <!-- =========================
           3) 상세 내역 (학교/기관)
           ========================= -->
      <section id="sec-entity" class="section">
        <div class="step-title">
          <span class="step-badge">3</span>
          <h2 style="margin: 0">상세 내역 조회 (학교 및 기관별)</h2>
        </div>

        <p class="sub" style="margin-top: 6px">
          드롭박스를 앞에서부터 선택할수록 상세 결과가 자동 갱신됩니다. (항상 오름차순 정렬)
        </p>

        <div class="grid four">
          <div class="field">
            <div class="field-label">1) 구분</div>
            <select id="entityKind" disabled>
              <option value="">선택</option>
              <option value="school">학교</option>
              <option value="inst">기관</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">2) 학교/기관</div>
            <select id="entityName" disabled>
              <option value="">먼저 1) 구분을 선택하세요</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">3) 인사 구분</div>
            <select id="personnelType" disabled>
              <option value="">먼저 2) 학교/기관을 선택하세요</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">4) 직렬/직급/직종</div>
            <select id="jobFilter" disabled>
              <option value="">먼저 3) 인사 구분을 선택하세요</option>
            </select>
          </div>
        </div>

        <div class="grid two" style="margin-top: 12px">
          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">전출자 / 퇴직자</h3>
              <div class="panel-count" id="entityOutCount">0명</div>
            </div>
            <div id="entityOutPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">전입자 / 신규 / 파견</h3>
              <div class="panel-count" id="entityInCount">0명</div>
            </div>
            <div id="entityInPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>
        </div>

        <details class="card" id="entityUnknownDetails" style="margin-top: 12px" open>
          <summary style="font-weight: 900; cursor: pointer" id="entityUnknownSummary">미분류 (0명)</summary>
          <div id="entityUnknownPanel" class="muted" style="margin-top: 10px">조회 조건을 선택하면 여기에 표시됩니다.</div>
        </details>

        <div class="mini-note">
          ※ 병설유치원은 원소속 초등학교로 자동 합산합니다. (예: “oo초 및 병설유치원”)
        </div>
      </section>

      <!-- =========================
           4) 상세 발령 내역 (시군구)
           ========================= -->
      <section id="sec-region" class="section">
        <div class="row between" style="align-items: flex-start">
          <div class="step-title" style="margin: 0">
            <span class="step-badge">4</span>
            <h2 style="margin: 0">상세 발령 내역 (시군구별 조회)</h2>
          </div>

          <div class="row gap">
            <button class="btn" id="btnExportRegionView" type="button" disabled>조회 결과 엑셀로 다운로드</button>
          </div>
        </div>

        <p class="sub" style="margin-top: 6px">
          “속초/양양”은 <b>속초양양</b>으로 통합 집계합니다. “강원도교육청”은 분리/춘천합산을 선택할 수 있습니다.
        </p>

        <div class="grid three">
          <div class="field">
            <div class="field-label">1) 강원도교육청 처리</div>
            <select id="officeMode" disabled>
              <option value="">선택</option>
              <option value="separate">강원도교육청 분리</option>
              <option value="merge">강원도교육청을 춘천에 합산</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">2) 지역 선택</div>
            <select id="regionPick" disabled>
              <option value="">먼저 1) 처리 방식을 선택하세요</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">3) 인사 구분</div>
            <select id="regionPersonnelType" disabled>
              <option value="">먼저 2) 지역을 선택하세요</option>
            </select>
          </div>
        </div>

        <div class="grid three" style="margin-top: 12px">
          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">전출자 / 퇴직자</h3>
              <div class="panel-count" id="regionOutCount">0명</div>
            </div>
            <div id="regionOutPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">전입자 / 신규</h3>
              <div class="panel-count" id="regionInCount">0명</div>
            </div>
            <div id="regionInPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>

          <div class="card">
            <div class="panel-title-row">
              <h3 style="margin: 0">지역변동 없음</h3>
              <div class="panel-count" id="regionStayCount">0명</div>
            </div>
            <div id="regionStayPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
          </div>
        </div>

        <details class="card" id="regionUnknownDetails" style="margin-top: 12px">
          <summary style="font-weight: 900; cursor: pointer" id="regionUnknownSummary">미분류 (0명)</summary>
          <div id="regionUnknownPanel" class="muted" style="margin-top: 10px">조회 조건을 선택하면 여기에 표시됩니다.</div>
        </details>
      </section>

      <!-- 로그 -->
      <details class="log section">
        <summary>시스템 처리 로그 보기</summary>
        <pre class="log" id="logBox"></pre>
      </details>
    </main>

    <button id="toTopBtn" class="to-top" type="button" aria-label="페이지 상단으로">↑</button>

    <footer class="site-footer">
      <div class="shell">
        <p>※ 본 페이지는 업로드한 엑셀 파일을 브라우저에서만 분석합니다. (서버 업로드 없이 로컬 처리)</p>
      </div>
    </footer>

    <script>
      (function () {
        "use strict";

        /* =========================
           전역 상태
           ========================= */
        const state = {
          files: [],
          xlsxReady: false,
          recordsRaw: [],
          records: [],
          aggregates: {
            kpi: {},
            regionRows: [],
            instRows: [],
          },

          // “현재 명단 다운로드”에서 사용할 최근 조회 결과(없으면 전체)
          currentExport: {
            title: "현재 조회 결과",
            rows: [],
          },
        };

        /* =========================
           상수/룰(요구사항 반영)
           ========================= */

        const REGION_18 = [
          "강원도교육청",
          "강릉",
          "고성",
          "동해",
          "삼척",
          "속초양양",
          "양구",
          "영월",
          "원주",
          "인제",
          "정선",
          "철원",
          "춘천",
          "태백",
          "평창",
          "홍천",
          "화천",
          "횡성",
        ];

        const REGION_17 = REGION_18.filter((r) => r !== "강원도교육청");

        const LOCAL_GOV_SERIES = [
          "지방교육행정",
          "지방시설관리",
          "지방시설",
          "지방전산",
          "지방사무운영",
          "지방운전",
          "지방식품위생",
          "지방조리",
          "지방사서",
          "지방공업",
        ];

        const EDU_LABOR_JOBS = Array.from(
          new Set([
            "치료사",
            "장애영아지도사",
            "장애유아지도사",
            "직업지도사",
            "유치원방과후교육사",
            "학교도서관사서",
            "기숙사생활지도원",
            "전문상담사",
            "영양사",
            "교육복지사",
            "평생교육사",
            "사회복지사",
            "진로교육사",
            "학교도서관실무사",
            "특수교육지도사",
            "건강실무사",
            "조리사",
            "조리실무사",
            "교무행정사",
            "발명실무원",
            "통학차량운전원",
            "통학지도원",
            "늘봄학교전담사",
            "초등돌봄전담사",
            "방과후전담사",
            "임상심리사",
            "대안교육전문가",
            "학습클리닉전문가",
            "학부모지원전문가",
            "진학전문지원관",
            "학교운동부지도자",
            "교육지도사",
            "방과후학교지원가",
            "구육성회직원",
          ])
        );

        const TEACHER_CATEGORIES = [
          "유치원교사",
          "초등학교교사",
          "중등학교교사",
          "특수학교교사",
          "실기교사",
          "보건교사",
          "사서교사",
          "전문상담교사",
          "영양교사",
          "교감",
          "교장",
          "원감",
          "원장",
          "수석교사",
          "교사",
        ];

        const GOV_GRADE_ENDINGS = ["서기보시보", "서기보", "서기", "주사보", "주사", "서기관", "사무관"];

        const INTERNAL_OFFICE_DEPTS = [
          "감사관",
          "공보담당관",
          "정책국",
          "교육국",
          "행정국",
          "정책기획과",
          "미래교육과",
          "안전복지과",
          "교육지원과",
          "유초등교육과",
          "중등교육과",
          "인성생활교육과",
          "문화체육특수교육과",
          "총무과",
          "예산과",
          "행정과",
          "시설과",
          "학교지원과",
          "미래학교지원과",
        ];

        // 직속기관 + 교육문화관 (요구사항 목록)
        const DIRECT_INST_CANON = [
          { match: "교육연구원", canon: "강원특별자치도교육청 교육연구원", region: "춘천" },
          { match: "유아교육원", canon: "강원특별자치도교육청 유아교육원", region: "춘천" },
          { match: "학생교육원", canon: "강원특별자치도교육청 학생교육원", region: "춘천" },
          { match: "춘천교육문화관", canon: "강원특별자치도교육청 춘천교육문화관", region: "춘천" },

          { match: "교육연수원", canon: "강원특별자치도교육청 교육연수원", region: "강릉" },
          { match: "사임당교육원", canon: "강원특별자치도교육청 사임당교육원", region: "강릉" },
          { match: "교직원수련원", canon: "강원특별자치도교육청 교직원수련원", region: "강릉" },
          { match: "강릉교육문화관", canon: "강원특별자치도교육청 강릉교육문화관", region: "강릉" },

          { match: "교육과학정보원", canon: "강원특별자치도교육청 교육과학정보원", region: "원주" },
          { match: "원주교육문화관", canon: "강원특별자치도교육청 원주교육문화관", region: "원주" },

          { match: "진로교육원", canon: "강원특별자치도교육청 진로교육원", region: "속초양양" },
          { match: "속초교육문화관", canon: "강원특별자치도교육청 속초교육문화관", region: "속초양양" },

          { match: "국제교육원", canon: "강원특별자치도교육청 국제교육원", region: "철원" },
          { match: "통일교육원", canon: "강원특별자치도교육청 통일교육원", region: "속초양양" },

          { match: "삼척교육문화관", canon: "강원특별자치도교육청 삼척교육문화관", region: "삼척" },
        ];

        const RETIRE_KW = ["퇴직", "정년", "의원면직", "면직", "해임", "파면", "사망"];
        const PLACEHOLDER_KW = ["교육장이 지정", "부서 근무를 명", "부서근무를명", "교육장이지정"];
        const DISPATCH_KW = ["파견", "파견연장", "파견 복귀", "파견복귀"];
        const LEAVE_KW = ["휴직", "복직", "육아휴직", "질병휴직", "직권휴직", "복귀"];

        /* =========================
           DOM
           ========================= */
        const $ = (sel) => document.querySelector(sel);

        const el = {
          dropzone: $("#dropzone"),
          fileInput: $("#fileInput"),
          btnAddFiles: $("#btnAddFiles"),
          btnResetFiles: $("#btnResetFiles"),
          btnAnalyze: $("#btnAnalyze"),
          fileCount: $("#fileCount"),
          fileTableBody: $("#fileTableBody"),
          xlsxBadge: $("#xlsxBadge"),

          statusTitle: $("#statusTitle"),
          progressFill: $("#progressFill"),
          statusDetail: $("#statusDetail"),
          statusExtra: $("#statusExtra"),
          statusBox: $("#statusBox"),

          btnDownloadAll: $("#btnDownloadAll"),
          btnDownloadFiltered: $("#btnDownloadFiltered"),

          kpiGrid: $("#kpiGrid"),
          regionSearch: $("#regionSearch"),
          instSearch: $("#instSearch"),

          regionTableBody: $("#regionTableBody"),
          instTableBody: $("#instTableBody"),
          regionTableCount: $("#regionTableCount"),
          instTableCount: $("#instTableCount"),

          btnGoEntity: $("#btnGoEntity"),
          btnGoRegion: $("#btnGoRegion"),

          entityKind: $("#entityKind"),
          entityName: $("#entityName"),
          personnelType: $("#personnelType"),
          jobFilter: $("#jobFilter"),

          entityOutPanel: $("#entityOutPanel"),
          entityInPanel: $("#entityInPanel"),
          entityUnknownDetails: $("#entityUnknownDetails"),
          entityUnknownSummary: $("#entityUnknownSummary"),
          entityUnknownPanel: $("#entityUnknownPanel"),
          entityOutCount: $("#entityOutCount"),
          entityInCount: $("#entityInCount"),

          officeMode: $("#officeMode"),
          regionPick: $("#regionPick"),
          regionPersonnelType: $("#regionPersonnelType"),

          regionOutPanel: $("#regionOutPanel"),
          regionInPanel: $("#regionInPanel"),
          regionStayPanel: $("#regionStayPanel"),
          regionUnknownDetails: $("#regionUnknownDetails"),
          regionUnknownSummary: $("#regionUnknownSummary"),
          regionUnknownPanel: $("#regionUnknownPanel"),
          regionOutCount: $("#regionOutCount"),
          regionInCount: $("#regionInCount"),
          regionStayCount: $("#regionStayCount"),

          btnExportRegionView: $("#btnExportRegionView"),

          toTopBtn: $("#toTopBtn"),
          logBox: $("#logBox"),
        };

        /* =========================
           로그
           ========================= */
        const logs = [];
        function log(msg) {
          const ts = new Date().toISOString().replace("T", " ").slice(0, 19);
          logs.push(`[${ts}] ${msg}`);
          el.logBox.textContent = logs.join("\n");
        }

        /* =========================
           유틸
           ========================= */
        function escapeHtml(s) {
          return String(s ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function normalizeText(v) {
          if (v === null || v === undefined) return "";
          if (v instanceof Date) {
            const y = v.getFullYear();
            const m = String(v.getMonth() + 1).padStart(2, "0");
            const d = String(v.getDate()).padStart(2, "0");
            return `${y}.${m}.${d}`;
          }
          const s = String(v);
          return s.replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim();
        }

        function normalizeKey(s) {
          return normalizeText(s).replace(/\s+/g, "").replace(/[·•◆□○●]/g, "").trim();
        }

        function formatBytes(bytes) {
          if (!bytes && bytes !== 0) return "";
          const units = ["B", "KB", "MB", "GB"];
          let i = 0;
          let v = bytes;
          while (v >= 1024 && i < units.length - 1) {
            v /= 1024;
            i++;
          }
          return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
        }

        function sleep(ms) {
          return new Promise((r) => setTimeout(r, ms));
        }

        function setProgress(title, percent, detail = "", extra = "") {
          el.statusTitle.textContent = title;
          el.progressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
          el.statusDetail.textContent = detail || `${Math.round(percent)}%`;
          el.statusExtra.textContent = extra || "";
        }

        function setStatusBox(kind, html) {
          const cls = kind === "warn" ? "warn" : kind === "ok" ? "ok" : "";
          el.statusBox.className = cls;
          el.statusBox.innerHTML = html || "";
        }

        function scrollToId(id) {
          const target = document.getElementById(id);
          if (!target) return;
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        /* =========================
           XLSX 로더(진행률 표시)
           ========================= */

        const XLSX_CDN = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        const XLSX_FALLBACK = "/static/xlsx.full.min.js"; // 서버에 두면 자동 사용

        async function loadScriptTag(src) {
          return new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = src;
            s.async = true;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error(`script load fail: ${src}`));
            document.head.appendChild(s);
          });
        }

        async function loadXlsxWithProgress(url) {
          setProgress("라이브러리(XLSX) 불러오는 중…", 1, "1%");
          log(`XLSX 로드 시도: ${url}`);

          // 스트리밍 fetch로 다운로드 진행률 표시(브라우저 지원 시)
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`fetch 실패 (${res.status})`);

          const totalStr = res.headers.get("content-length");
          const total = totalStr ? Number(totalStr) : 0;

          if (!res.body || !res.body.getReader) {
            // 스트리밍 미지원 → 단순 script 로드 (진행률은 애니메이션)
            let fake = 5;
            const timer = setInterval(() => {
              fake = Math.min(90, fake + 7);
              setProgress("라이브러리(XLSX) 불러오는 중…", fake, `${fake}%`);
            }, 120);

            await loadScriptTag(url);
            clearInterval(timer);
            setProgress("라이브러리 로드 완료", 100, "100%");
            return;
          }

          const reader = res.body.getReader();
          let loaded = 0;
          const chunks = [];
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.byteLength;

            let p;
            if (total) p = Math.min(95, Math.round((loaded / total) * 95));
            else p = Math.min(95, 10 + Math.round(loaded / 50000));

            setProgress("라이브러리(XLSX) 불러오는 중…", p, `${p}%`, total ? `${formatBytes(loaded)} / ${formatBytes(total)}` : formatBytes(loaded));
          }

          const blob = new Blob(chunks, { type: "text/javascript" });
          const blobUrl = URL.createObjectURL(blob);
          await loadScriptTag(blobUrl);
          URL.revokeObjectURL(blobUrl);

          setProgress("라이브러리 로드 완료", 100, "100%");
        }

        async function ensureXlsxReady() {
          if (state.xlsxReady) return true;

          try {
            await loadXlsxWithProgress(XLSX_CDN);
            if (!window.XLSX) throw new Error("XLSX 전역이 없습니다.");
            state.xlsxReady = true;
            el.xlsxBadge.textContent = "XLSX: 준비됨";
            setStatusBox("ok", "라이브러리 로드 완료");
            log("XLSX 로드 완료(CDN)");
            return true;
          } catch (e1) {
            log(`CDN 로드 실패: ${e1.message}`);

            try {
              setStatusBox(
                "warn",
                "CDN 로드에 실패하여 <b>/static/xlsx.full.min.js</b>를 시도합니다. (서버에 파일이 있으면 자동으로 로드됩니다.)"
              );
              await loadXlsxWithProgress(XLSX_FALLBACK);
              if (!window.XLSX) throw new Error("XLSX 전역이 없습니다.");
              state.xlsxReady = true;
              el.xlsxBadge.textContent = "XLSX: 준비됨";
              setStatusBox("ok", "라이브러리 로드 완료(로컬)");
              log("XLSX 로드 완료(로컬 fallback)");
              return true;
            } catch (e2) {
              setStatusBox(
                "warn",
                "XLSX 로드 실패. 네트워크/서버 설정을 확인하세요.<br/>- CDN 차단 시: <b>/static/xlsx.full.min.js</b>를 서버에 배치<br/>- 또는 사내망 허용 CDN으로 URL 교체"
              );
              el.xlsxBadge.textContent = "XLSX: 실패";
              log(`로컬 fallback 로드 실패: ${e2.message}`);
              return false;
            }
          }
        }

        /* =========================
           파일 업로드/관리
           ========================= */
        function fileSig(f) {
          return `${f.name}__${f.size}__${f.lastModified}`;
        }

        function addFiles(fileList) {
          const incoming = Array.from(fileList || []);
          if (!incoming.length) return;

          const before = state.files.length;
          const existing = new Set(state.files.map(fileSig));

          for (const f of incoming) {
            const sig = fileSig(f);
            if (existing.has(sig)) continue;
            existing.add(sig);
            state.files.push(f);
          }

          const added = state.files.length - before;
          if (added > 0) log(`파일 추가: ${added}개 (총 ${state.files.length}개)`);
          renderFileTable();
          updateAnalyzeBtn();
        }

        function removeFileAt(idx) {
          const f = state.files[idx];
          if (!f) return;
          state.files.splice(idx, 1);
          log(`파일 삭제: ${f.name}`);
          renderFileTable();
          updateAnalyzeBtn();
        }

        function resetFiles() {
          state.files = [];
          state.recordsRaw = [];
          state.records = [];
          state.aggregates = { kpi: {}, regionRows: [], instRows: [] };
          state.currentExport = { title: "현재 조회 결과", rows: [] };

          renderFileTable();
          renderEmptyResults();
          updateAnalyzeBtn();
          lockFilters(true);

          setStatusBox("", "");
          log("초기화 완료");
        }

        function renderFileTable() {
          el.fileCount.textContent = String(state.files.length);

          if (!state.files.length) {
            el.fileTableBody.innerHTML =
              '<tr><td colspan="4" class="muted" style="text-align:center">아직 업로드된 파일이 없습니다.</td></tr>';
            return;
          }

          const rows = state.files
            .slice()
            .sort((a, b) => a.name.localeCompare(b.name, "ko"))
            .map((f, i) => {
              const dt = new Date(f.lastModified);
              const dtStr = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}-${String(dt.getDate()).padStart(2, "0")} ${String(
                dt.getHours()
              ).padStart(2, "0")}:${String(dt.getMinutes()).padStart(2, "0")}`;

              return `
              <tr>
                <td>${escapeHtml(f.name)}</td>
                <td class="numeric">${escapeHtml(formatBytes(f.size))}</td>
                <td>${escapeHtml(dtStr)}</td>
                <td style="text-align:center">
                  <button class="btn btn-lightgrey" type="button" data-rm="${i}" aria-label="파일 삭제">삭제</button>
                </td>
              </tr>
            `;
            })
            .join("");

          el.fileTableBody.innerHTML = rows;

          el.fileTableBody.querySelectorAll("button[data-rm]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const idx = Number(btn.getAttribute("data-rm"));
              removeFileAt(idx);
            });
          });
        }

        function updateAnalyzeBtn() {
          el.btnAnalyze.disabled = !state.files.length || !state.xlsxReady;
        }

        /* =========================
           엑셀 파싱/추출(핵심)
           ========================= */

        function regionHintFromFileName(fileName) {
          const m = String(fileName || "").match(/\[([^\]]+)\]/);
          if (!m) return "";
          return canonicalRegionName(m[1]);
        }

        function canonicalRegionName(raw) {
          const s0 = normalizeText(raw).replace(/\s+/g, "");
          if (!s0) return "";

          // 강원도교육청
          if (s0.includes("강원도교육청") || s0.includes("강원특별자치도교육청")) return "강원도교육청";

          // 속초/양양 통합
          if (s0.includes("속초양양") || s0.includes("속초/양양")) return "속초양양";
          if (s0.includes("속초") || s0.includes("양양")) return "속초양양";

          // 시/군/구 제거(있으면)
          const s = s0.replace(/(시|군|구)$/g, "");
          return s;
        }

        function isKnownRegion(r) {
          return REGION_18.includes(r);
        }

        function findDirectInstitution(orgText) {
          const t = normalizeText(orgText);
          if (!t) return null;
          for (const it of DIRECT_INST_CANON) {
            if (t.includes(it.match)) return it;
          }
          return null;
        }

        function isOfficeDept(orgText) {
          const t = normalizeText(orgText);
          if (!t) return false;
          if (t.includes("교육지원청")) return false; // 교육지원청의 "행정과" 등과 구분
          return INTERNAL_OFFICE_DEPTS.some((k) => t.includes(k));
        }

        function extractEduSupportOffice(orgText) {
          const t = normalizeText(orgText);
          if (!t) return "";
          const m = t.match(/([가-힣]{1,10})\s*교육지원청/);
          if (!m) return "";
          const r = canonicalRegionName(m[1]);
          if (!r) return "";
          return `${r}교육지원청`;
        }

        function looksLikeSchoolName(text) {
          const t = normalizeText(text).replace(/\s+/g, "");
          if (!t) return false;

          if (t.includes("병설유치원") || t.includes("병설유")) return true;

          if (/(초등학교|중학교|고등학교|특수학교|유치원|학교)$/.test(t)) return true;
          // 약칭: ○○초/○○중/○○고/○○유
          if (/[가-힣A-Za-z0-9]+(초|중|고|유)$/.test(t)) return true;

          return false;
        }

        function schoolBaseName(schoolName) {
          const t = normalizeText(schoolName).replace(/\s+/g, "");
          if (!t) return "";
          // “oo초병설유”, “oo초병설유치원” 등
          const base = t.replace(/병설유치원/g, "").replace(/병설유/g, "");
          return base;
        }

        function detectEntity(orgText, fileRegionHint = "") {
          const t = normalizeText(orgText);
          if (!t) return { kind: "unknown", name: "", baseName: "" };

          // 직속기관
          const direct = findDirectInstitution(t);
          if (direct) return { kind: "inst", name: direct.canon, baseName: "" };

          // 교육지원청(기관)
          const sup = extractEduSupportOffice(t);
          if (sup && !looksLikeSchoolName(t.split(/\s+/).slice(-1)[0])) {
            // 마지막 토큰이 학교면 학교로 처리(예: “원주교육지원청 부론초”)
            return { kind: "inst", name: sup, baseName: "" };
          }

          // 강원도교육청 본청(부서 통합)
          if (t.includes("강원도교육청") || t.includes("강원특별자치도교육청") || isOfficeDept(t)) {
            if (isOfficeDept(t) || t.includes("국 ") || t.includes("과") || t.includes("관")) {
              return { kind: "inst", name: "강원도교육청", baseName: "" };
            }
            // 그래도 “강원특별자치도교육청”만 있는 경우는 강원도교육청으로
            return { kind: "inst", name: "강원도교육청", baseName: "" };
          }

          // 학교 판단
          const parts = t.split(/\s+/).filter(Boolean);
          const last = parts.length ? parts[parts.length - 1] : t;
          if (looksLikeSchoolName(last) || looksLikeSchoolName(t)) {
            const schoolName = looksLikeSchoolName(last) ? last : t;
            const base = schoolBaseName(schoolName);
            return { kind: "school", name: schoolName, baseName: base || schoolName };
          }

          // 그 외는 기관/학교 불명
          return { kind: "unknown", name: t, baseName: "" };
        }

        function inferRegionFromText(text, fileRegionHint = "") {
          const t = normalizeText(text);
          if (!t) return fileRegionHint || "";

          // 직속기관 위치 매핑
          const direct = findDirectInstitution(t);
          if (direct) return direct.region;

          // 강원도교육청 본청
          if (t.includes("강원도교육청") || t.includes("강원특별자치도교육청") || isOfficeDept(t)) {
            return "강원도교육청";
          }

          // 교육지원청 기반
          const sup = extractEduSupportOffice(t);
          if (sup) {
            const r = canonicalRegionName(sup.replace("교육지원청", ""));
            if (r) return r;
          }

          // 문자열에 지역명이 포함돼 있으면 우선
          for (const r of REGION_18) {
            if (r === "강원도교육청") continue;
            if (r === "속초양양") {
              if (t.includes("속초") || t.includes("양양") || t.includes("속초양양")) return "속초양양";
            } else if (t.includes(r)) return r;
          }

          return fileRegionHint || "";
        }

        function isRetire(record) {
          const hay = normalizeKey(`${record.action} ${record.newOrg} ${record.curOrg}`);
          return RETIRE_KW.some((k) => hay.includes(normalizeKey(k)));
        }

        function isPlaceholder(record) {
          const hay = normalizeKey(`${record.newOrg} ${record.action}`);
          return PLACEHOLDER_KW.some((k) => hay.includes(normalizeKey(k)));
        }

        function isLocalGovByRank(text) {
          const t = normalizeKey(text);
          if (!t) return false;
          if (t.startsWith("지방")) return true;
          if (t.includes("지방")) return true;
          return GOV_GRADE_ENDINGS.some((end) => t.endsWith(normalizeKey(end)));
        }

        function localGovSeriesFromRank(text) {
          const t = normalizeText(text).replace(/\s+/g, "");
          if (!t) return "지방교육행정";

          if (t.includes("지방시설관리")) return "지방시설관리";
          if (t.includes("지방시설")) return "지방시설";
          if (t.includes("지방전산")) return "지방전산";
          if (t.includes("지방사무운영")) return "지방사무운영";
          if (t.includes("지방운전")) return "지방운전";
          if (t.includes("지방식품위생")) return "지방식품위생";
          if (t.includes("지방조리")) return "지방조리";
          if (t.includes("지방사서")) return "지방사서";
          if (t.includes("지방공업")) return "지방공업";

          // 지방교육행정(지방서기관/사무관 포함)
          return "지방교육행정";
        }

        function detectPersonnelType(record) {
          const mix = `${record.newRank} ${record.curRank} ${record.jobRaw} ${record.fileName} ${record.sheetName}`;
          const mk = normalizeKey(mix);

          if (isLocalGovByRank(mix)) return "지방공무원";

          // 교육공무직
          if (mk.includes("교육공무직") || EDU_LABOR_JOBS.some((j) => mk.includes(normalizeKey(j)))) return "교육공무직";

          // 교육공무원(교원)
          if (mk.includes("교육공무원") || mk.includes("교사") || mk.includes("교감") || mk.includes("교장") || mk.includes("원장") || mk.includes("원감"))
            return "교육공무원";

          return "기타";
        }

        function detectJobKey(record) {
          const t = record.personnelType;

          if (t === "지방공무원") {
            const series = localGovSeriesFromRank(`${record.newRank} ${record.curRank}`);
            return series;
          }

          if (t === "교육공무직") {
            // 시트명이 직종인 경우가 많음
            const sheet = normalizeText(record.sheetName);
            const foundBySheet = EDU_LABOR_JOBS.find((j) => normalizeKey(sheet) === normalizeKey(j));
            if (foundBySheet) return foundBySheet;

            const mix = normalizeKey(`${record.newRank} ${record.curRank} ${record.action} ${record.jobRaw}`);
            const found = EDU_LABOR_JOBS.find((j) => mix.includes(normalizeKey(j)));
            return found || normalizeText(record.newRank) || normalizeText(record.curRank) || "기타";
          }

          if (t === "교육공무원") {
            const mix = normalizeKey(`${record.newRank} ${record.curRank} ${record.jobRaw} ${record.sheetName} ${record.fileName}`);
            if (mix.includes("유치원") && mix.includes("교사")) return "유치원교사";
            if (mix.includes("초등") && mix.includes("교사")) return "초등학교교사";
            if (mix.includes("중등") && mix.includes("교사")) return "중등학교교사";
            if (mix.includes("특수") && mix.includes("교사")) return "특수학교교사";
            if (mix.includes("실기")) return "실기교사";
            if (mix.includes("보건교사")) return "보건교사";
            if (mix.includes("사서교사")) return "사서교사";
            if (mix.includes("전문상담교사") || mix.includes("상담교사")) return "전문상담교사";
            if (mix.includes("영양교사")) return "영양교사";
            if (mix.includes("교감")) return "교감";
            if (mix.includes("교장")) return "교장";
            if (mix.includes("원감")) return "원감";
            if (mix.includes("원장")) return "원장";
            if (mix.includes("수석")) return "수석교사";
            if (mix.includes("교사")) return "교사";

            // fallback
            return normalizeText(record.newRank) || normalizeText(record.curRank) || "기타";
          }

          // 기타
          return normalizeText(record.newRank) || normalizeText(record.curRank) || "기타";
        }

        /* ====== SheetJS merge 채우기 ====== */
        function fillMergedCells(sheet) {
          const merges = sheet && sheet["!merges"];
          if (!merges || !Array.isArray(merges) || merges.length === 0) return;

          for (const m of merges) {
            const startAddr = XLSX.utils.encode_cell({ r: m.s.r, c: m.s.c });
            const startCell = sheet[startAddr];
            if (!startCell) continue;

            for (let r = m.s.r; r <= m.e.r; r++) {
              for (let c = m.s.c; c <= m.e.c; c++) {
                const addr = XLSX.utils.encode_cell({ r, c });
                const cell = sheet[addr];
                if (!cell || cell.v === undefined || cell.v === null || String(cell.v).trim() === "") {
                  sheet[addr] = {
                    t: startCell.t || "s",
                    v: startCell.v,
                    w: startCell.w,
                  };
                }
              }
            }
          }
        }

        function findHeaderRowIndex(rows) {
          const maxScan = Math.min(35, rows.length);
          for (let i = 0; i < maxScan; i++) {
            const row = rows[i] || [];
            for (const cell of row) {
              const s = normalizeText(cell);
              if (/(성\s*명|성명|이름)/.test(s)) return i;
            }
          }
          return -1;
        }

        function decideHeaderDepth(rows, headerIdx) {
          // headerIdx 다음 줄이 서브헤더(직급/부서/학교명/직종 등)면 2줄 헤더로 간주
          const row2 = rows[headerIdx + 1] || [];
          const hay = normalizeKey(row2.join(" "));
          const looks = ["직급", "부서", "학교", "기관", "근무지", "직종", "직렬", "교육지원청", "시군", "호봉", "비고", "구분"].some((k) =>
            hay.includes(normalizeKey(k))
          );
          return looks ? 2 : 1;
        }

        function buildHeaders(rows, headerIdx, depth) {
          const r1 = rows[headerIdx] || [];
          const r2 = rows[headerIdx + 1] || [];
          const maxCols = Math.max(r1.length, r2.length, 10);

          const headers = [];
          for (let c = 0; c < maxCols; c++) {
            const a = normalizeText(r1[c] ?? "");
            const b = depth === 2 ? normalizeText(r2[c] ?? "") : "";
            const h = normalizeText(`${a} ${b}`.trim());
            headers.push(h);
          }
          return headers;
        }

        function analyzeHeader(header) {
          const h = normalizeKey(header);
          const side = h.includes("현") ? "cur" : h.includes("발령") || h.includes("임용") ? "new" : "other";

          let role = "other";
          if (/(성명|이름)/.test(h)) role = "name";
          else if (/(구분|비고|사유|전소속)/.test(h)) role = "action";
          else if (/(직급|직종|직렬|교과|과목|직위|직명)/.test(h)) role = "rankOrType";
          else if (/(부서|기관|근무지|학교|교육지원청|시군|지역|소속)/.test(h)) role = "org";

          return { side, role };
        }

        function isValidName(name) {
          const n = normalizeText(name);
          if (!n) return false;
          if (!/[가-힣]/.test(n)) return false;
          if (/(성명|이름|합계|계|연번|일련|번호)/.test(n)) return false;
          return true;
        }

        function extractRecordsFromSheet(rows, meta) {
          const headerIdx = findHeaderRowIndex(rows);
          if (headerIdx < 0) return [];

          const depth = decideHeaderDepth(rows, headerIdx);
          const headers = buildHeaders(rows, headerIdx, depth);

          // name 컬럼 찾기
          let nameCol = -1;
          for (let i = 0; i < headers.length; i++) {
            if (/(성\s*명|성명|이름)/.test(headers[i])) {
              nameCol = i;
              break;
            }
          }
          if (nameCol < 0) return [];

          const colMeta = headers.map((h) => ({ header: h, ...analyzeHeader(h) }));

          const out = [];
          const startRow = headerIdx + depth;
          for (let r = startRow; r < rows.length; r++) {
            const row = rows[r] || [];
            const nameRaw = normalizeText(row[nameCol] ?? "");
            if (!isValidName(nameRaw)) continue;

            // 값 모으기
            const newRankParts = [];
            const newOrgParts = [];
            const curRankParts = [];
            const curOrgParts = [];
            const actionParts = [];
            const jobRawParts = [];

            for (let c = 0; c < colMeta.length; c++) {
              const v = normalizeText(row[c] ?? "");
              if (!v) continue;

              const m = colMeta[c];

              if (m.role === "action") actionParts.push(v);
              if (m.role === "rankOrType") jobRawParts.push(v);

              if (m.side === "new") {
                if (m.role === "rankOrType") newRankParts.push(v);
                else if (m.role === "org") newOrgParts.push(v);
              } else if (m.side === "cur") {
                if (m.role === "rankOrType") curRankParts.push(v);
                else if (m.role === "org") curOrgParts.push(v);
              }
            }

            const rec = {
              id: `${meta.fileName}__${meta.sheetName}__${r + 1}`,
              fileName: meta.fileName,
              sheetName: meta.sheetName,
              rowIndex: r + 1,

              name: normalizeText(nameRaw).replace(/[◆□○●]/g, "").trim(),
              nameKey: normalizeKey(nameRaw),

              // 좌(발령/임용) / 우(현직/현소속)
              newRank: normalizeText(newRankParts.join(" / ")),
              newOrg: normalizeText(newOrgParts.join(" ")),
              curRank: normalizeText(curRankParts.join(" / ")),
              curOrg: normalizeText(curOrgParts.join(" ")),
              action: normalizeText(actionParts.join(" / ")),
              jobRaw: normalizeText(jobRawParts.join(" / ")),

              fileRegionHint: meta.fileRegionHint || "",
            };

            // 엔티티/지역 추정
            rec.newEntity = detectEntity(rec.newOrg, rec.fileRegionHint);
            rec.curEntity = detectEntity(rec.curOrg, rec.fileRegionHint);

            rec.newRegion = inferRegionFromText(rec.newOrg, rec.fileRegionHint);
            rec.curRegion = inferRegionFromText(rec.curOrg, rec.fileRegionHint);

            // 인사 구분/직렬/직종 키
            rec.personnelType = detectPersonnelType(rec);
            rec.jobKey = ""; // 아래에서 채움

            // 중복 제거용/분류용 플래그
            rec.isRetire = isRetire(rec);
            rec.isPlaceholder = isPlaceholder(rec);

            rec.jobKey = detectJobKey(rec);

            out.push(rec);
          }

          return out;
        }

        function qualityScore(rec) {
          let s = 0;
          if (rec.name) s += 10;
          if (rec.curOrg) s += 8;
          if (rec.newOrg) s += 10;
          if (!rec.isPlaceholder) s += 30;
          if (rec.newEntity && rec.newEntity.kind !== "unknown") s += 8;
          if (rec.curEntity && rec.curEntity.kind !== "unknown") s += 5;

          // “교육장이 지정…” 같은 더미를 강하게 페널티
          if (rec.isPlaceholder) s -= 40;

          // 구체적 근무지가 있을수록 가산
          if (rec.newEntity && rec.newEntity.kind === "school") s += 4;
          if (rec.newEntity && rec.newEntity.kind === "inst" && rec.newEntity.name.includes("교육지원청")) s += 3;

          return s;
        }

        function dedupeRecords(records) {
          // 핵심: “교육장이 지정하는 부서 근무를 명함” 같은 더미가 관내발령과 같이 들어오면 더미는 제거
          const groups = new Map();

          for (const rec of records) {
            const curKey = normalizeKey(rec.curOrg);
            const newKey = normalizeKey(rec.newOrg);

            // current가 있으면 current 기준으로 묶고, 없으면 new 기준으로 묶음
            const baseKey = curKey
              ? `${rec.nameKey}|${rec.personnelType}|CUR|${curKey}`
              : `${rec.nameKey}|${rec.personnelType}|NEW|${newKey}`;

            if (!groups.has(baseKey)) groups.set(baseKey, []);
            groups.get(baseKey).push(rec);
          }

          const picked = [];
          for (const arr of groups.values()) {
            if (arr.length === 1) {
              picked.push(arr[0]);
              continue;
            }

            // 같은 사람(동일 name+cur) 그룹 안에서 “더미/placeholder”가 있고, 더미가 아닌 레코드가 있으면 더미 제거
            const nonPlaceholder = arr.filter((r) => !r.isPlaceholder);
            const cand = nonPlaceholder.length ? nonPlaceholder : arr;

            // 점수 높은 것 1개만 사용
            cand.sort((a, b) => qualityScore(b) - qualityScore(a));
            picked.push(cand[0]);
          }

          // 안정적 정렬(오름차순)
          picked.sort((a, b) => {
            const n = a.name.localeCompare(b.name, "ko");
            if (n !== 0) return n;
            const f = a.fileName.localeCompare(b.fileName, "ko");
            if (f !== 0) return f;
            return (a.sheetName || "").localeCompare(b.sheetName || "", "ko");
          });

          return picked;
        }

        /* =========================
           집계 계산
           ========================= */

        function moveKindByRegions(rec) {
          // 전체 KPI용 단위 묶음:
          // - 전보/이동: 강원권(18개) ↔ 강원권(18개)
          // - 전입만: 강원권 밖/미상 → 강원권
          // - 전출/퇴직만: 강원권 → 강원권 밖/미상 또는 퇴직
          const curIn = isKnownRegion(rec.curRegion);
          const newIn = isKnownRegion(rec.newRegion);

          if (rec.isRetire) return "퇴직";

          if (curIn && newIn) return "전보/이동";
          if (!curIn && newIn) return "전입만";
          if (curIn && !newIn) return "전출/퇴직만";
          return "기타";
        }

        function computeAggregates() {
          const personKey = (rec) => rec.nameKey + "|" + rec.personnelType + "|" + normalizeKey(rec.curOrg) + "|" + normalizeKey(rec.newOrg);

          const regionMap = new Map();
          const instMap = new Map();

          function ensureRegion(r) {
            if (!regionMap.has(r)) {
              regionMap.set(r, {
                region: r,
                institutions: new Set(),
                incoming: new Set(),
                outgoing: new Set(),
                stay: new Set(),
                retire: new Set(),
                persons: new Set(),
              });
            }
            return regionMap.get(r);
          }

          function ensureInst(region, instName) {
            const key = `${region}||${instName}`;
            if (!instMap.has(key)) {
              instMap.set(key, {
                region,
                instName,
                incoming: new Set(),
                outgoing: new Set(),
                persons: new Set(),
              });
            }
            return instMap.get(key);
          }

          // KPI 카운트
          const kpi = {
            total: 0,
            move: 0,
            inOnly: 0,
            outOrRetireOnly: 0,
            regionCount: 0,
            instCount: 0,
          };

          // 전체 인원(중복 제거 후)
          kpi.total = state.records.length;

          // 지역/기관 카운트용 set
          const regionSetAll = new Set();
          const instSetAll = new Set();

          for (const rec of state.records) {
            const pk = personKey(rec);

            const curR = rec.curRegion || "";
            const newR = rec.newRegion || "";
            const curEnt = rec.curEntity && rec.curEntity.name ? rec.curEntity.name : normalizeText(rec.curOrg) || "";
            const newEnt = rec.newEntity && rec.newEntity.name ? rec.newEntity.name : normalizeText(rec.newOrg) || "";

            // region set
            if (curR) regionSetAll.add(curR);
            if (newR) regionSetAll.add(newR);

            // inst set (학교/기관 모두 포함)
            if (curEnt) instSetAll.add(curEnt);
            if (newEnt) instSetAll.add(newEnt);

            // KPI 분류
            const mk = moveKindByRegions(rec);
            if (mk === "전보/이동") kpi.move++;
            else if (mk === "전입만") kpi.inOnly++;
            else if (mk === "전출/퇴직만" || mk === "퇴직") kpi.outOrRetireOnly++;

            // 지역별 집계
            if (curR) {
              const rr = ensureRegion(curR);
              rr.persons.add(pk);
              rr.outgoing.add(pk);
              if (rec.isRetire) rr.retire.add(pk);
              if (curEnt) rr.institutions.add(curEnt);

              const inst = ensureInst(curR, curEnt || "(미상)");
              inst.persons.add(pk);
              inst.outgoing.add(pk);
            }

            if (newR) {
              const rr = ensureRegion(newR);
              rr.persons.add(pk);
              rr.incoming.add(pk);
              if (curR && newR && curR === newR && !rec.isRetire) rr.stay.add(pk);
              if (newEnt) rr.institutions.add(newEnt);

              const inst = ensureInst(newR, newEnt || "(미상)");
              inst.persons.add(pk);
              inst.incoming.add(pk);
            }
          }

          kpi.regionCount = regionSetAll.size;
          kpi.instCount = instSetAll.size;

          // 지역 테이블 rows
          const regionRows = Array.from(regionMap.values()).map((r) => ({
            region: r.region,
            instCount: r.institutions.size,
            incoming: r.incoming.size,
            outgoing: r.outgoing.size,
            stay: r.stay.size,
            retire: r.retire.size,
            persons: r.persons.size,
          }));

          // 기관 테이블 rows
          const instRows = Array.from(instMap.values()).map((x) => ({
            region: x.region,
            instName: x.instName || "(미상)",
            incoming: x.incoming.size,
            outgoing: x.outgoing.size,
            persons: x.persons.size,
          }));

          // 오름차순 정렬
          regionRows.sort((a, b) => a.region.localeCompare(b.region, "ko"));
          instRows.sort((a, b) => {
            const r = a.region.localeCompare(b.region, "ko");
            if (r !== 0) return r;
            return a.instName.localeCompare(b.instName, "ko");
          });

          state.aggregates = { kpi, regionRows, instRows };
        }

        /* =========================
           렌더링: 결과/대시보드
           ========================= */

        function renderEmptyResults() {
          el.kpiGrid.innerHTML = "";
          el.regionTableBody.innerHTML =
            '<tr><td colspan="7" class="muted" style="text-align:center">아직 집계 결과가 없습니다.</td></tr>';
          el.instTableBody.innerHTML =
            '<tr><td colspan="5" class="muted" style="text-align:center">아직 집계 결과가 없습니다.</td></tr>';
          el.regionTableCount.textContent = "0건";
          el.instTableCount.textContent = "0건";

          el.entityOutPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.entityInPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.entityUnknownPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.entityOutCount.textContent = "0명";
          el.entityInCount.textContent = "0명";
          el.entityUnknownSummary.textContent = "미분류 (0명)";

          el.regionOutPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionInPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionStayPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionUnknownPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
          el.regionOutCount.textContent = "0명";
          el.regionInCount.textContent = "0명";
          el.regionStayCount.textContent = "0명";
          el.regionUnknownSummary.textContent = "미분류 (0명)";

          el.btnDownloadAll.disabled = true;
          el.btnDownloadFiltered.disabled = true;
          el.btnGoEntity.disabled = true;
          el.btnGoRegion.disabled = true;
          el.btnExportRegionView.disabled = true;
        }

        function lockFilters(lock) {
          el.regionSearch.disabled = lock;
          el.instSearch.disabled = lock;

          el.entityKind.disabled = lock;
          el.entityName.disabled = lock;
          el.personnelType.disabled = lock;
          el.jobFilter.disabled = lock;

          el.officeMode.disabled = lock;
          el.regionPick.disabled = lock;
          el.regionPersonnelType.disabled = lock;
        }

        function renderKpi() {
          const k = state.aggregates.kpi;

          const cards = [
            { label: "전체 인원", value: k.total ?? 0, hint: "중복 제거 후" },
            { label: "전보/이동", value: k.move ?? 0, hint: "강원권 ↔ 강원권" },
            { label: "전입만", value: k.inOnly ?? 0, hint: "강원권 밖 → 강원권" },
            { label: "전출/퇴직만", value: k.outOrRetireOnly ?? 0, hint: "강원권 → 밖/퇴직" },
            { label: "지역 / 기관", value: `${k.regionCount ?? 0} / ${k.instCount ?? 0}`, hint: "등장한 고유 개수" },
          ];

          el.kpiGrid.innerHTML = cards
            .map(
              (c, idx) => `
              <div class="kpi" data-kpi="${idx}">
                <div class="label">${escapeHtml(c.label)}</div>
                <div class="value">${escapeHtml(c.value)}</div>
                <div class="hint">${escapeHtml(c.hint || "")}</div>
              </div>
            `
            )
            .join("");

          // KPI 클릭 → 3,4번 섹션 바로가기(요구사항)
          const kpis = el.kpiGrid.querySelectorAll(".kpi");
          kpis.forEach((node, idx) => {
            node.addEventListener("click", () => {
              if (idx === 4) {
                // 지역/기관 클릭 시: 요약 테이블 상단에 머무르게
                scrollToId("sec-summary");
                return;
              }
              // 전반적으로 3번/4번으로 이동할 수 있게 간단히: 전입/전출 관련 KPI는 4번으로
              if (idx === 1 || idx === 2 || idx === 3) scrollToId("sec-region");
              else scrollToId("sec-entity");
            });
          });
        }

        function renderRegionTable() {
          const q = normalizeText(el.regionSearch.value || "");
          const rows = state.aggregates.regionRows.filter((r) => (q ? r.region.includes(q) : true));

          el.regionTableCount.textContent = `${rows.length}건`;

          if (!rows.length) {
            el.regionTableBody.innerHTML =
              '<tr><td colspan="7" class="muted" style="text-align:center">검색 결과가 없습니다.</td></tr>';
            return;
          }

          el.regionTableBody.innerHTML = rows
            .map(
              (r) => `
              <tr>
                <td>${escapeHtml(r.region)}</td>
                <td class="numeric">${r.instCount}</td>
                <td class="numeric">${r.incoming}</td>
                <td class="numeric">${r.outgoing}</td>
                <td class="numeric">${r.stay}</td>
                <td class="numeric">${r.retire}</td>
                <td class="numeric">${r.persons}</td>
              </tr>
            `
            )
            .join("");
        }

        function renderInstTable() {
          const q = normalizeText(el.instSearch.value || "");
          const rows = state.aggregates.instRows.filter((r) => {
            if (!q) return true;
            return r.region.includes(q) || r.instName.includes(q);
          });

          el.instTableCount.textContent = `${rows.length}건`;

          if (!rows.length) {
            el.instTableBody.innerHTML =
              '<tr><td colspan="5" class="muted" style="text-align:center">검색 결과가 없습니다.</td></tr>';
            return;
          }

          el.instTableBody.innerHTML = rows
            .map(
              (r) => `
              <tr>
                <td>${escapeHtml(r.region)}</td>
                <td>${escapeHtml(r.instName)}</td>
                <td class="numeric">${r.incoming}</td>
                <td class="numeric">${r.outgoing}</td>
                <td class="numeric">${r.persons}</td>
              </tr>
            `
            )
            .join("");
        }

        function renderSummary() {
          renderKpi();
          renderRegionTable();
          renderInstTable();

          el.btnDownloadAll.disabled = false;
          el.btnDownloadFiltered.disabled = false;
          el.btnGoEntity.disabled = false;
          el.btnGoRegion.disabled = false;

          el.regionSearch.disabled = false;
          el.instSearch.disabled = false;
        }

        /* =========================
           렌더링: 섹션3 (학교/기관)
           ========================= */

        function buildEntityOptions() {
          // 학교/기관 목록(인사발령자가 있는 것만)
          const schoolMap = new Map(); // baseName -> {hasAttached:boolean}
          const instSet = new Set();

          for (const rec of state.records) {
            const addSchool = (ent) => {
              if (!ent || ent.kind !== "school" || !ent.baseName) return;
              const base = ent.baseName;
              const hasAttached = normalizeKey(ent.name).includes("병설유");
              if (!schoolMap.has(base)) schoolMap.set(base, { hasAttached: false });
              if (hasAttached) schoolMap.get(base).hasAttached = true;
            };

            const addInst = (ent) => {
              if (!ent) return;
              if (ent.kind === "inst" && ent.name) instSet.add(ent.name);
              // unknown도 기관/학교로 분류되면? 여기서는 기관 목록엔 inst만
            };

            addSchool(rec.curEntity);
            addSchool(rec.newEntity);
            addInst(rec.curEntity);
            addInst(rec.newEntity);
          }

          const schools = Array.from(schoolMap.entries())
            .map(([baseName, meta]) => ({
              value: baseName,
              label: meta.hasAttached ? `${baseName} 및 병설유치원` : baseName,
            }))
            .sort((a, b) => a.label.localeCompare(b.label, "ko"));

          const insts = Array.from(instSet)
            .sort((a, b) => a.localeCompare(b, "ko"))
            .map((name) => ({ value: name, label: name }));

          return { schools, insts };
        }

        function buildPersonnelTypeOptions() {
          const types = new Set(state.records.map((r) => r.personnelType));
          const list = Array.from(types).sort((a, b) => a.localeCompare(b, "ko"));
          return ["전체", ...list];
        }

        function buildJobOptions(personnelType) {
          if (personnelType === "지방공무원") return ["전체", ...LOCAL_GOV_SERIES];
          if (personnelType === "교육공무직") return ["전체", ...EDU_LABOR_JOBS.slice().sort((a, b) => a.localeCompare(b, "ko"))];
          if (personnelType === "교육공무원") return ["전체", ...TEACHER_CATEGORIES];

          // 전체/기타: 데이터에서 고유 jobKey를 수집(너무 길면 문제라 상한)
          const s = new Set();
          for (const r of state.records) {
            if (personnelType !== "전체" && r.personnelType !== personnelType) continue;
            if (r.jobKey) s.add(r.jobKey);
            if (s.size > 200) break;
          }
          const arr = Array.from(s).sort((a, b) => a.localeCompare(b, "ko"));
          return ["전체", ...arr];
        }

        function setSelectOptions(selectEl, options, placeholder = "선택") {
          const html = options
            .map((o) => {
              if (typeof o === "string") return `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`;
              return `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`;
            })
            .join("");

          selectEl.innerHTML = `<option value="">${escapeHtml(placeholder)}</option>` + html;
        }

        function initEntityFilters() {
          el.entityKind.disabled = false;
          el.entityKind.value = "";

          el.entityName.disabled = true;
          el.personnelType.disabled = true;
          el.jobFilter.disabled = true;

          el.entityName.innerHTML = '<option value="">먼저 1) 구분을 선택하세요</option>';
          el.personnelType.innerHTML = '<option value="">먼저 2) 학교/기관을 선택하세요</option>';
          el.jobFilter.innerHTML = '<option value="">먼저 3) 인사 구분을 선택하세요</option>';

          // 1) 구분 변경
          el.entityKind.onchange = () => {
            const kind = el.entityKind.value;
            if (!kind) {
              el.entityName.disabled = true;
              el.personnelType.disabled = true;
              el.jobFilter.disabled = true;
              el.entityName.innerHTML = '<option value="">먼저 1) 구분을 선택하세요</option>';
              return;
            }

            const { schools, insts } = buildEntityOptions();
            const list = kind === "school" ? schools : insts;

            el.entityName.disabled = false;
            setSelectOptions(el.entityName, [{ value: "__ALL__", label: "전체 조회" }, ...list], "선택");

            el.entityName.value = "__ALL__"; // 기본 전체
            el.personnelType.disabled = false;
            setSelectOptions(el.personnelType, buildPersonnelTypeOptions(), "선택");
            el.personnelType.value = "전체";

            el.jobFilter.disabled = false;
            setSelectOptions(el.jobFilter, buildJobOptions("전체"), "선택");
            el.jobFilter.value = "전체";

            renderEntityView();
          };

          // 2) 학교/기관
          el.entityName.onchange = () => {
            el.personnelType.disabled = false;
            renderEntityView();
          };

          // 3) 인사 구분
          el.personnelType.onchange = () => {
            const t = el.personnelType.value || "전체";
            el.jobFilter.disabled = false;
            setSelectOptions(el.jobFilter, buildJobOptions(t), "선택");
            el.jobFilter.value = "전체";
            renderEntityView();
          };

          // 4) 직렬/직종
          el.jobFilter.onchange = () => {
            renderEntityView();
          };
        }

        function filterByEntityAndType(rec, kind, entityValue) {
          // kind: school | inst
          // entityValue: __ALL__ | baseName | instName
          if (!kind) return false;

          const matchEntity = (ent) => {
            if (!ent) return false;
            if (kind === "school") {
              if (ent.kind !== "school") return false;
              if (entityValue === "__ALL__") return true;
              return ent.baseName === entityValue;
            } else {
              if (ent.kind !== "inst") return false;
              if (entityValue === "__ALL__") return true;
              return ent.name === entityValue;
            }
          };

          // 이 엔티티와 관련된 레코드만(현/발령 중 하나라도)
          return matchEntity(rec.curEntity) || matchEntity(rec.newEntity);
        }

        function filterByPersonnelAndJob(rec, personnelType, jobFilter) {
          const pt = personnelType && personnelType !== "전체" ? personnelType : "";
          const jf = jobFilter && jobFilter !== "전체" ? jobFilter : "";

          if (pt && rec.personnelType !== pt) return false;
          if (jf && rec.jobKey !== jf) return false;

          return true;
        }

        function recordHasKeyword(rec, kwList) {
          const hay = normalizeKey(`${rec.action} ${rec.newOrg} ${rec.curOrg}`);
          return kwList.some((k) => hay.includes(normalizeKey(k)));
        }

        function renderRecordsTable(records) {
          if (!records.length) return '<div class="muted">해당 없음</div>';

          // 오름차순(이름)
          const sorted = records.slice().sort((a, b) => {
            const n = a.name.localeCompare(b.name, "ko");
            if (n !== 0) return n;
            const c = (a.curOrg || "").localeCompare(b.curOrg || "", "ko");
            if (c !== 0) return c;
            return (a.newOrg || "").localeCompare(b.newOrg || "", "ko");
          });

          const rowsHtml = sorted
            .map(
              (r) => `
              <tr>
                <td>${escapeHtml(r.name)}</td>
                <td>${escapeHtml(r.personnelType)}</td>
                <td>${escapeHtml(r.jobKey || "")}</td>
                <td>${escapeHtml(r.curRank || "")}</td>
                <td>${escapeHtml(r.curOrg || "")}</td>
                <td>${escapeHtml(r.newRank || "")}</td>
                <td>${escapeHtml(r.newOrg || "")}</td>
                <td>${escapeHtml(r.curRegion || "")}</td>
                <td>${escapeHtml(r.newRegion || "")}</td>
                <td>${escapeHtml(r.action || "")}</td>
                <td>${escapeHtml(r.fileName || "")}</td>
                <td>${escapeHtml(r.sheetName || "")}</td>
              </tr>
            `
            )
            .join("");

          return `
            <div class="records-wrap">
              <table class="sheetlike">
                <thead>
                  <tr>
                    <th style="min-width:120px">성명</th>
                    <th style="min-width:120px">구분</th>
                    <th style="min-width:140px">직렬/직종</th>
                    <th style="min-width:140px">현직급/직종</th>
                    <th style="min-width:220px">현소속/근무지</th>
                    <th style="min-width:140px">발령직급/직종</th>
                    <th style="min-width:220px">발령소속/근무지</th>
                    <th style="min-width:110px">현지역</th>
                    <th style="min-width:110px">발령지역</th>
                    <th style="min-width:160px">구분/비고</th>
                    <th style="min-width:280px">파일</th>
                    <th style="min-width:160px">시트</th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;
        }

        function renderEntityView() {
          const kind = el.entityKind.value;
          const entityValue = el.entityName.value || "__ALL__";
          const personnelType = el.personnelType.value || "전체";
          const jobFilter = el.jobFilter.value || "전체";

          if (!kind) return;

          const baseFiltered = state.records.filter((rec) => filterByEntityAndType(rec, kind, entityValue) && filterByPersonnelAndJob(rec, personnelType, jobFilter));

          // 패널 분류:
          // - 전출/퇴직: 현 엔티티에 있고(또는 전체 조회면 현 엔티티 kind), 발령 엔티티로 나가거나 퇴직
          // - 전입/신규/파견: 발령 엔티티에 들어오고(또는 전체 조회면 발령 kind), 현 엔티티와 다르거나 현이 없음, 또는 파견 키워드
          // - 미분류: 그 외(제자리, 휴직/복직 등)

          const matchEntity = (ent) => {
            if (!ent) return false;
            if (kind === "school") {
              if (ent.kind !== "school") return false;
              if (entityValue === "__ALL__") return true;
              return ent.baseName === entityValue;
            } else {
              if (ent.kind !== "inst") return false;
              if (entityValue === "__ALL__") return true;
              return ent.name === entityValue;
            }
          };

          const outList = [];
          const inList = [];
          const unknownList = [];

          for (const rec of baseFiltered) {
            const curHit = matchEntity(rec.curEntity);
            const newHit = matchEntity(rec.newEntity);

            const sameEntity =
              kind === "school"
                ? rec.curEntity?.baseName && rec.newEntity?.baseName && rec.curEntity.baseName === rec.newEntity.baseName
                : rec.curEntity?.name && rec.newEntity?.name && rec.curEntity.name === rec.newEntity.name;

            const isDispatch = recordHasKeyword(rec, DISPATCH_KW);
            const isLeave = recordHasKeyword(rec, LEAVE_KW);

            // 전출/퇴직
            if (curHit && (!newHit || (newHit && !sameEntity) || rec.isRetire)) {
              outList.push(rec);
              continue;
            }

            // 전입/신규/파견
            if (newHit && (!curHit || (curHit && !sameEntity) || isDispatch)) {
              inList.push(rec);
              continue;
            }

            // 미분류(제자리/휴직/복직/기타)
            if (curHit || newHit) {
              unknownList.push(rec);
              continue;
            }
          }

          el.entityOutCount.textContent = `${outList.length}명`;
          el.entityInCount.textContent = `${inList.length}명`;
          el.entityUnknownSummary.textContent = `미분류 (${unknownList.length}명)`;

          el.entityOutPanel.innerHTML = renderRecordsTable(outList);
          el.entityInPanel.innerHTML = renderRecordsTable(inList);
          el.entityUnknownPanel.innerHTML = renderRecordsTable(unknownList);

          // “현재 명단 다운로드”에 반영(섹션3 조회 결과를 우선)
          state.currentExport = {
            title: `섹션3 조회 결과 (${kind === "school" ? "학교" : "기관"} / ${entityValue} / ${personnelType} / ${jobFilter})`,
            rows: baseFiltered,
          };

          el.btnDownloadFiltered.disabled = false;
        }

        /* =========================
           렌더링: 섹션4 (지역)
           ========================= */

        function initRegionFilters() {
          el.officeMode.disabled = false;
          el.officeMode.value = "";
          el.regionPick.disabled = true;
          el.regionPersonnelType.disabled = true;

          el.regionPick.innerHTML = '<option value="">먼저 1) 처리 방식을 선택하세요</option>';
          el.regionPersonnelType.innerHTML = '<option value="">먼저 2) 지역을 선택하세요</option>';

          el.officeMode.onchange = () => {
            const mode = el.officeMode.value;
            if (!mode) {
              el.regionPick.disabled = true;
              el.regionPersonnelType.disabled = true;
              return;
            }

            el.regionPick.disabled = false;
            const regions = mode === "separate" ? REGION_18 : REGION_17;
            setSelectOptions(el.regionPick, regions, "선택");
            el.regionPick.value = regions[0] || "";

            el.regionPersonnelType.disabled = false;
            setSelectOptions(el.regionPersonnelType, buildPersonnelTypeOptions(), "선택");
            el.regionPersonnelType.value = "전체";

            renderRegionView();
          };

          el.regionPick.onchange = () => {
            el.regionPersonnelType.disabled = false;
            renderRegionView();
          };

          el.regionPersonnelType.onchange = () => {
            renderRegionView();
          };
        }

        function applyOfficeModeToRegion(region, mode) {
          if (!region) return "";
          if (mode === "merge" && region === "강원도교육청") return "춘천";
          return region;
        }

        function renderRegionView() {
          const mode = el.officeMode.value; // separate | merge
          const pick = el.regionPick.value;
          const personnelType = el.regionPersonnelType.value || "전체";
          if (!mode || !pick) return;

          const viewCur = (rec) => applyOfficeModeToRegion(rec.curRegion, mode);
          const viewNew = (rec) => applyOfficeModeToRegion(rec.newRegion, mode);

          const filtered = state.records.filter((rec) => {
            if (personnelType && personnelType !== "전체" && rec.personnelType !== personnelType) return false;

            const c = viewCur(rec);
            const n = viewNew(rec);
            return c === pick || n === pick;
          });

          const outList = [];
          const inList = [];
          const stayList = [];
          const unknownList = [];

          for (const rec of filtered) {
            const c = viewCur(rec);
            const n = viewNew(rec);

            // 1) 전출/퇴직: 현지역이 선택지역이고, 발령지역이 다르거나(또는 미상/밖), 또는 퇴직
            if (c === pick && (rec.isRetire || n !== pick)) {
              outList.push(rec);
              continue;
            }

            // 2) 전입/신규: 발령지역이 선택지역이고, 현지역이 다르거나 미상/밖
            if (n === pick && c !== pick) {
              inList.push(rec);
              continue;
            }

            // 3) 지역변동 없음: 현=발령=선택지역
            if (c === pick && n === pick && !rec.isRetire) {
              stayList.push(rec);
              continue;
            }

            unknownList.push(rec);
          }

          el.regionOutCount.textContent = `${outList.length}명`;
          el.regionInCount.textContent = `${inList.length}명`;
          el.regionStayCount.textContent = `${stayList.length}명`;
          el.regionUnknownSummary.textContent = `미분류 (${unknownList.length}명)`;

          el.regionOutPanel.innerHTML = renderRecordsTable(outList);
          el.regionInPanel.innerHTML = renderRecordsTable(inList);
          el.regionStayPanel.innerHTML = renderRecordsTable(stayList);
          el.regionUnknownPanel.innerHTML = renderRecordsTable(unknownList);

          // “현재 명단 다운로드”는 섹션4 조회 결과가 가장 최근이면 이것으로 덮어씀
          state.currentExport = {
            title: `섹션4 조회 결과 (${mode === "separate" ? "도교육청 분리" : "춘천 합산"} / ${pick} / ${personnelType})`,
            rows: filtered,
          };

          el.btnExportRegionView.disabled = false;
          el.btnDownloadFiltered.disabled = false;
        }

        /* =========================
           다운로드(XLSX)
           ========================= */
        function toExportRow(rec) {
          return {
            성명: rec.name,
            구분: rec.personnelType,
            직렬_직종: rec.jobKey,
            현직급_직종: rec.curRank,
            현소속_근무지: rec.curOrg,
            발령직급_직종: rec.newRank,
            발령소속_근무지: rec.newOrg,
            현지역: rec.curRegion,
            발령지역: rec.newRegion,
            구분_비고: rec.action,
            파일: rec.fileName,
            시트: rec.sheetName,
            행: rec.rowIndex,
          };
        }

        function downloadWorkbookFromRows(rows, filename, sheetName = "명단") {
          if (!state.xlsxReady || !window.XLSX) {
            alert("XLSX 라이브러리가 아직 준비되지 않았습니다.");
            return;
          }

          const wb = XLSX.utils.book_new();
          const data = rows.map(toExportRow);
          const ws = XLSX.utils.json_to_sheet(data);
          XLSX.utils.book_append_sheet(wb, ws, sheetName);

          const safe = filename.replace(/[\\/:*?"<>|]/g, "_");
          XLSX.writeFile(wb, safe);
        }

        function downloadCurrent() {
          const rows = state.currentExport.rows && state.currentExport.rows.length ? state.currentExport.rows : state.records;
          const title = state.currentExport.title || "현재 조회 결과";
          const filename = `${title}.xlsx`;
          downloadWorkbookFromRows(rows, filename, "조회결과");
        }

        function downloadAll() {
          downloadWorkbookFromRows(state.records, "전체_인사발령_명단.xlsx", "전체");
        }

        /* =========================
           분석 실행
           ========================= */

        async function readFileAsArrayBuffer(file) {
          return new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => resolve(fr.result);
            fr.onerror = () => reject(new Error("파일 읽기 실패"));
            fr.readAsArrayBuffer(file);
          });
        }

        async function analyzeAllFiles() {
          if (!state.files.length) return;
          if (!(await ensureXlsxReady())) return;

          // UI 잠금
          el.btnAnalyze.disabled = true;
          el.btnAddFiles.disabled = true;
          el.btnResetFiles.disabled = true;
          lockFilters(true);

          setStatusBox("", "");
          setProgress("파일 분석 준비…", 1, "1%");
          log(`분석 시작: ${state.files.length}개 파일`);

          const all = [];
          const filesSorted = state.files.slice().sort((a, b) => a.name.localeCompare(b.name, "ko"));

          for (let i = 0; i < filesSorted.length; i++) {
            const f = filesSorted[i];
            const hint = regionHintFromFileName(f.name);

            const pctBase = Math.round((i / filesSorted.length) * 100);
            setProgress("파일 분석 중…", Math.min(99, pctBase), `${pctBase}%`, `${i + 1}/${filesSorted.length}  ${f.name}`);
            log(`읽는 중: ${f.name}`);

            let wb;
            try {
              const buf = await readFileAsArrayBuffer(f);
              wb = XLSX.read(buf, { type: "array", cellDates: true });
            } catch (e) {
              log(`⚠️ 파일 파싱 실패: ${f.name} (${e.message})`);
              continue;
            }

            const sheets = wb.SheetNames || [];
            for (let s = 0; s < sheets.length; s++) {
              const sheetName = sheets[s];
              const sheet = wb.Sheets[sheetName];
              if (!sheet) continue;

              try {
                fillMergedCells(sheet);

                const rows = XLSX.utils.sheet_to_json(sheet, {
                  header: 1,
                  defval: "",
                  blankrows: false,
                });

                const extracted = extractRecordsFromSheet(rows, {
                  fileName: f.name,
                  sheetName,
                  fileRegionHint: hint,
                });

                if (extracted.length) {
                  all.push(...extracted);
                  log(`  - 시트: ${sheetName} → ${extracted.length}건`);
                }
              } catch (e) {
                log(`⚠️ 시트 처리 실패: ${f.name} / ${sheetName} (${e.message})`);
              }

              // UI 프리즈 방지(짧게 양보)
              if (s % 3 === 2) await sleep(0);
            }

            await sleep(0);
          }

          setProgress("중복 제거 및 집계 중…", 99, "99%");
          log(`원본 추출 건수: ${all.length}건`);

          state.recordsRaw = all;
          state.records = dedupeRecords(all);
          log(`중복 제거 후: ${state.records.length}건`);

          computeAggregates();

          setProgress("완료", 100, "100%");
          setStatusBox(
            "ok",
            `분석 완료: <b>${state.records.length.toLocaleString()}</b>명 (원본 ${state.recordsRaw.length.toLocaleString()}건 → 중복 제거 후)`
          );

          // UI 활성화
          renderSummary();
          lockFilters(false);

          initEntityFilters();
          initRegionFilters();

          el.btnDownloadAll.disabled = false;
          el.btnDownloadFiltered.disabled = false;
          el.btnGoEntity.disabled = false;
          el.btnGoRegion.disabled = false;

          el.btnAnalyze.disabled = false;
          el.btnAddFiles.disabled = false;
          el.btnResetFiles.disabled = false;

          updateAnalyzeBtn();
        }

        /* =========================
           이벤트 바인딩
           ========================= */

        function initUploadUI() {
          el.btnAddFiles.addEventListener("click", () => el.fileInput.click());
          el.fileInput.addEventListener("change", (e) => {
            addFiles(e.target.files);
            el.fileInput.value = "";
          });

          el.btnResetFiles.addEventListener("click", resetFiles);
          el.btnAnalyze.addEventListener("click", analyzeAllFiles);

          // Drag & Drop
          el.dropzone.addEventListener("dragover", (e) => {
            e.preventDefault();
            el.dropzone.classList.add("dragover");
          });
          el.dropzone.addEventListener("dragleave", () => el.dropzone.classList.remove("dragover"));
          el.dropzone.addEventListener("drop", (e) => {
            e.preventDefault();
            el.dropzone.classList.remove("dragover");
            addFiles(e.dataTransfer.files);
          });

          // 검색
          el.regionSearch.addEventListener("input", () => renderRegionTable());
          el.instSearch.addEventListener("input", () => renderInstTable());

          // 바로가기
          el.btnGoEntity.addEventListener("click", () => scrollToId("sec-entity"));
          el.btnGoRegion.addEventListener("click", () => scrollToId("sec-region"));

          // 다운로드
          el.btnDownloadAll.addEventListener("click", downloadAll);
          el.btnDownloadFiltered.addEventListener("click", downloadCurrent);
          el.btnExportRegionView.addEventListener("click", downloadCurrent);

          // to-top
          el.toTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
          window.addEventListener("scroll", () => {
            if (window.scrollY > 600) el.toTopBtn.classList.add("show");
            else el.toTopBtn.classList.remove("show");
          });
        }

        async function init() {
          renderEmptyResults();
          renderFileTable();
          initUploadUI();

          // XLSX는 페이지 진입 즉시 로드(요구사항: 진행바 표시)
          const ok = await ensureXlsxReady();
          updateAnalyzeBtn();

          if (ok) {
            el.xlsxBadge.textContent = "XLSX: 준비됨";
            setProgress("라이브러리 로드 완료", 100, "100%");
            log("초기화 완료");
          } else {
            log("XLSX 로드 실패 상태로 시작");
          }
        }

        init();
      })();
    </script>
  </body>
</html>
