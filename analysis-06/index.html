<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Human Resource Analysis</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="stylesheet" href="/static/style.css">
<style>
/* =============== Page tweaks =============== */
.container { max-width: 1280px; }
.pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #1f2a44; }
.pill small{opacity:.8}
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
.muted { color: #b9c2d0; }
.grid.four { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
.kpi { display:flex; flex-direction:column; gap:6px; padding:12px; border:1px solid #1f2a44; border-radius:12px; background: rgba(255,255,255,0.02);}
.kpi .v { font-size:20px; font-weight:700;}
.kpi .l { font-size:12px; opacity:.85;}
.table-wrap { overflow:auto; border:1px solid #1f2a44; border-radius:12px; }
table { width:100%; border-collapse:collapse; }
thead th { position:sticky; top:0; background:#0b1220; }
th, td { padding:8px 10px; border-bottom:1px solid #1f2a44; text-align:left; vertical-align:top; }
tr:hover td { background: rgba(255,255,255,0.03);}
.btn-row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.gap { gap:12px; }
.right { margin-left:auto; }
.badge { display:inline-block; padding:2px 8px; border:1px solid #1f2a44; border-radius:999px; background: rgba(255,255,255,0.03); font-size:12px; }
.ok { border-color: #1c7c54; }
.warn { border-color: #b08900; }
.danger { border-color: #a33; }
.logbox { height: 160px; overflow:auto; background:#0b1220; border:1px solid #1f2a44; border-radius:12px; padding:10px; font-size:12px; white-space:pre-wrap; }
.small { font-size:12px; }
.section-title { display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
.section-title h2 { margin:0; }
.section-title .muted { font-size:12px; }
details summary { cursor:pointer; }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Human Resource Analysis</h1>
    <p class="muted">엑셀 파일(인사발령)을 업로드하면, 학교/기관/지역 단위로 전입·전출·이동 명단을 집계·조회할 수 있어요. (외부 서버 업로드 없이 브라우저에서만 처리)</p>
    <div class="btn-row">
      <span class="pill"><strong>상태</strong> <span id="statusBadge" class="badge warn">대기</span></span>
      <span class="pill"><strong>파일</strong> <span id="fileCount" class="badge">0</span></span>
      <span class="pill"><strong>레코드</strong> <span id="recordCount" class="badge">0</span></span>
      <span class="pill"><strong>분석</strong> <span id="analysisBadge" class="badge warn">미실행</span></span>
    </div>
  </div>

  <section class="card" id="sec-upload">
    <div class="section-title">
      <h2>1) 파일 업로드 &amp; 분석</h2>
      <span class="muted">여러 개의 엑셀 파일을 추가한 다음 한 번에 분석합니다.</span>
    </div>
    <div class="row gap" style="margin-top:10px;">
      <input type="file" id="fileInput" multiple accept=".xlsx,.xls" />
      <button id="btnAddFiles">파일 추가</button>
      <button id="btnAnalyze" class="primary" disabled>분석 실행</button>
      <button id="btnResetFiles" disabled>초기화</button>
      <span class="muted small" id="fileHint">.xlsx/.xls만 지원</span>
    </div>
    <div style="margin-top:12px;">
      <div class="muted small">선택된 파일</div>
      <ul id="fileList" class="mono small"></ul>
    </div>
    <div style="margin-top:12px;">
      <div class="muted small">로그</div>
      <div id="logBox" class="logbox mono"></div>
    </div>
  </section>

  <section class="card" id="sec-summary">
    <div class="section-title">
      <h2>2) 전체 요약 &amp; 내보내기</h2>
      <span class="muted">현재 화면에서 필터된 “명단”을 엑셀로 다운로드할 수 있어요.</span>
    </div>
    <div class="row gap">
      <label class="pill" style="cursor:pointer; user-select:none;">
        <input type="checkbox" id="maskNameToggle" style="margin:0;" />
        <span>이름 마스킹(2번째 글자 *)</span>
      </label>
      <button id="btnDownloadCurrent" class="primary" disabled>현재 명단 다운로드</button>
      <button id="btnDownloadAggregates" disabled>전체 통계(집계) 다운로드</button>
      <button id="btnCopySummary" disabled>요약 복사</button>
      <span class="right muted small" id="exportHint">분석 후 활성화</span>
    </div>

    <div class="grid four" style="margin-top:12px;">
      <div class="kpi"><div class="v" id="kpiFiles">0</div><div class="l">파일 수</div></div>
      <div class="kpi"><div class="v" id="kpiRecords">0</div><div class="l">총 레코드</div></div>
      <div class="kpi"><div class="v" id="kpiSchoolHits">0</div><div class="l">학교 매칭(건)</div></div>
      <div class="kpi"><div class="v" id="kpiOfficeHits">0</div><div class="l">기관 매칭(건)</div></div>
      <div class="kpi"><div class="v" id="kpiUnknown">0</div><div class="l">미분류(건)</div></div>
      <div class="kpi"><div class="v" id="kpiLocalGov">0</div><div class="l">지방공무원</div></div>
      <div class="kpi"><div class="v" id="kpiEduWork">0</div><div class="l">교육공무직</div></div>
      <div class="kpi"><div class="v" id="kpiTeacher">0</div><div class="l">교원(정규/기간제)</div></div>
    </div>

    <details style="margin-top:12px;">
      <summary class="muted">집계 기준(보기)</summary>
      <div class="small muted" style="margin-top:8px;">
        <ul style="margin:0; padding-left:18px;">
          <li>기본 분류: <span class="mono">지방공무원 / 교육공무직 / 기간제교원 / 정규교원 / 퇴직 / 기타</span></li>
          <li>학교 매칭: 엑셀 셀에 포함된 학교명(정확/부분)을 <span class="mono">강원도 전체 학교 목록</span>과 비교</li>
          <li>기관 매칭: 엑셀 셀에 포함된 기관명을 <span class="mono">강원교육청/직속기관/교육지원청</span> 목록과 비교</li>
        </ul>
      </div>
    </details>
  </section>

  <section class="card" id="sec-entity">
    <div class="section-title">
      <h2>3) 기관/학교별 조회</h2>
      <span class="muted">기관 또는 학교를 고르면, 전입/전출/판단불가를 나눠서 보여줍니다.</span>
    </div>

    <div class="grid four" style="margin-top:10px;">
      <div class="field">
        <div class="field-label">1) 조회 구분</div>
        <select id="entityKind">
          <option value="">선택</option>
          <option value="school">학교</option>
          <option value="office">기관</option>
        </select>
      </div>
      <div class="field">
        <div class="field-label">2) 기관/학교</div>
        <select id="entityName" disabled>
          <option value="">먼저 1) 조회 구분을 선택하세요</option>
        </select>
      </div>
      <div class="field">
        <div class="field-label">3) 인사 구분</div>
        <select id="personnelType" disabled></select>
      </div>
      <div class="field">
        <div class="field-label">4) 직렬/직급/직종</div>
        <select id="jobFilter" disabled></select>
      </div>
      <div class="field">
        <div class="field-label">5) 지방공무원 직급</div>
        <select id="govGradeFilter" disabled></select>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <span class="badge" id="entityResultBadge">-</span>
      <span class="muted small" id="entityHint">필터를 선택하면 결과가 표시됩니다.</span>
    </div>

    <div class="grid two" style="margin-top:12px;">
      <div class="card">
        <div class="row">
          <strong>전입/부임</strong>
          <span class="badge ok" id="inCountBadge">0</span>
          <span class="right muted small">발령 후(신규) 기준</span>
        </div>
        <div class="table-wrap" style="margin-top:10px;">
          <table id="inTable">
            <thead><tr><th>성명</th><th>현(이전)</th><th>발령(신규)</th><th>구분</th><th>파일</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="row">
          <strong>전출/전보</strong>
          <span class="badge warn" id="outCountBadge">0</span>
          <span class="right muted small">발령 전(현) 기준</span>
        </div>
        <div class="table-wrap" style="margin-top:10px;">
          <table id="outTable">
            <thead><tr><th>성명</th><th>현(이전)</th><th>발령(신규)</th><th>구분</th><th>파일</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row">
        <strong>판단 불가</strong>
        <span class="badge danger" id="unkCountBadge">0</span>
        <span class="right muted small">학교/기관 매칭은 되었지만 방향 판정이 어려운 케이스</span>
      </div>
      <div class="table-wrap" style="margin-top:10px;">
        <table id="unkTable">
          <thead><tr><th>성명</th><th>현(이전)</th><th>발령(신규)</th><th>구분</th><th>파일</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card" id="sec-region">
    <div class="section-title">
      <h2>4) 지역별 조회</h2>
      <span class="muted">교육지원청/본청/직속기관/전체 학교 중 하나를 고르고, 지역을 선택하면 해당 범위의 이동 명단을 볼 수 있어요.</span>
    </div>

    <div class="grid four" style="margin-top:10px;">
      <div class="field">
        <div class="field-label">1) 기관 범위</div>
        <select id="officeMode" disabled>
          <option value="">선택</option>
          <option value="eduOffice">교육지원청</option>
          <option value="hq">본청</option>
          <option value="direct">직속기관</option>
          <option value="school">학교(전체)</option>
        </select>
      </div>
      <div class="field">
        <div class="field-label">2) 지역</div>
        <select id="regionPick" disabled></select>
      </div>
      <div class="field">
        <div class="field-label">3) 인사 구분</div>
        <select id="regionPersonnelType" disabled></select>
      </div>
      <div class="field">
        <div class="field-label">4) 지방공무원 직급</div>
        <select id="regionGovGradeFilter" disabled></select>
      </div>
    </div>

    <div class="row gap" style="margin-top:12px;">
      <input type="text" id="regionSearch" placeholder="검색(성명/기관/학교/비고 등)" style="min-width:260px;" disabled />
      <button id="btnRegionSearchClear" disabled>검색 지우기</button>
      <span class="muted small" id="regionSearchHint"></span>
    </div>

    <div class="row" style="margin-top:12px;">
      <span class="badge" id="regionResultBadge">-</span>
      <span class="right muted small" id="regionHint">필터를 선택하면 결과가 표시됩니다.</span>
    </div>

    <div class="table-wrap" style="margin-top:12px;">
      <table id="regionTable">
        <thead><tr><th>성명</th><th>현(이전)</th><th>발령(신규)</th><th>구분</th><th>지역</th><th>파일</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="sec-note">
    <div class="section-title">
      <h2>5) 분류 기준(메모)</h2>
      <span class="muted">엑셀마다 컬럼명이 조금 달라도 최대한 자동 인식합니다.</span>
    </div>
    <div class="small muted">
      <ul style="margin:0; padding-left:18px;">
        <li>성명은 한글 2~6자(공백 제거) 기준으로 인식합니다.</li>
        <li>지방공무원 여부는 직급 텍스트가 “지방”으로 시작하거나 직급 끝이 <span class="mono">서기보시보/서기보/서기/주사보/주사/서기관/사무관</span>이면 우선 분류합니다.</li>
        <li>학교/기관 매칭은 텍스트 포함 여부로 판정하며, 가장 긴 이름을 우선 매칭합니다.</li>
      </ul>
    </div>
  </section>

</div>

<script src="/static/xlsx.full.min.js"></script>
<script src="/static/filesaver.min.js"></script>
<script>
(function () {
  "use strict";

  /* =========================
     State
  ========================= */
  const state = {
    files: [],
    recordsRaw: [],
    recordsNormalized: [],
    schoolMaster: null,
    officeMaster: null,
    currentExport: { title: "", rows: [] },
    stats: { total: 0, byType: {}, byRegion: {}, schoolHits: 0, officeHits: 0, unknownHits: 0 },
    xlsxReady: false,
    maskNames: false,
    lastView: ""
  };

  /* =========================
     Constants
  ========================= */
  const GOV_GRADE_ENDINGS = ["서기보시보","서기보","서기","주사보","주사","서기관","사무관"];

  const PERSONNEL_TYPE_OPTIONS = ["전체","지방공무원","교육공무직","기간제교원","정규교원","퇴직","기타"];

  const LOCAL_GOV_SERIES = [
    "지방교육행정","지방시설","지방공업","지방전산","지방사서","지방운전","지방조리","지방기록연구",
    "지방공업(운전)","지방시설(운전)","지방시설관리","지방환경","지방보건"
  ];

  const REGION_LABELS = ["춘천","원주","강릉","동해","태백","속초양양","삼척","홍천","횡성","영월","평창","정선","철원","화천","양구","인제","고성"];

  // 전체 학교 목록(강원) - 절대 변경 금지(원본 유지)
  const GW_SCHOOL_MASTER_ROWS = [{"n":"강원온라인학교","r":"원주"},{"n":"가곡고등학교","r":"삼척"},{"n":"가곡중학교","r":"삼척"},{"n":"가람유치원","r":"춘천"},{"n":"가산초등학교","r":"춘천"},{"n":"가온유치원","r":"강릉"},{"n":"가정중학교","r":"춘천"},{"n":"간동고등학교","r":"화천"},{"n":"간동중학교","r":"화천"},{"n":"간성초등학교","r":"고성"},{"n":"간성초병설유치원","r":"고성"},{"n":"갈래초등학교","r":"정선"},{"n":"갈래초병설유치원","r":"정선"},{"n":"갑천고등학교","r":"횡성"},{"n":"갑천중학교","r":"횡성"},{"n":"갑천초등학교","r":"횡성"},{"n":"갑천초병설유치원","r":"횡성"},{"n":"강동초등학교","r":"강릉"},{"n":"강동초병설유치원","r":"강릉"},{"n":"강룡사유치원","r":"홍천"},{"n":"강릉고등학교","r":"강릉"},{"n":"강릉명륜고등학교","r":"강릉"},{"n":"강릉문성고등학교","r":"강릉"},{"n":"강릉여자고등학교","r":"강릉"},{"n":"강릉오성학교","r":"강릉"},{"n":"강릉원주대부설유치원","r":"원주"},{"n":"강릉유치원","r":"강릉"},{"n":"강릉정보공업고등학교","r":"강릉"},{"n":"강릉제일고등학교","r":"강릉"},{"n":"강릉중앙고등학교","r":"강릉"},{"n":"강릉중학교","r":"강릉"},{"n":"강릉초등학교","r":"강릉"},{"n":"강릉초병설유치원","r":"강릉"},{"n":"강릉해람중학교","r":"강릉"},{"n":"강림중학교","r":"횡성"},{"n":"강림초등학교","r":"횡성"},{"n":"강서중학교","r":"춘천"},{"n":"강원고등학교","r":"춘천"},{"n":"강원과학고등학교","r":"원주"},{"n":"강원대학교사범대학부설고등학교","r":"춘천"},{"n":"강원명진학교","r":"춘천"},{"n":"강원생활과학고등학교","r":"홍천"},{"n":"강원애니고등학교","r":"춘천"},{"n":"강원예술고등학교","r":"강릉"},{"n":"강원외국어고등학교","r":"양구"},{"n":"강원중학교","r":"춘천"},{"n":"강원체육고등학교","r":"춘천"},{"n":"강원체육중학교","r":"춘천"},{"n":"강일여자고등학교","r":"강릉"},{"n":"강현중학교","r":"속초양양"},{"n":"강현초등학교","r":"속초양양"},{"n":"강현초병설유치원","r":"속초양양"},{"n":"거문초등학교","r":"평창"},{"n":"거문초병설유치원","r":"평창"},{"n":"거성초등학교","r":"고성"},{"n":"거성초병설유치원","r":"고성"},{"n":"거진고등학교","r":"고성"},{"n":"거진중학교","r":"고성"},{"n":"거진초등학교","r":"고성"},{"n":"거진초병설유치원","r":"고성"},{"n":"경포고등학교","r":"강릉"},{"n":"경포대초등학교","r":"강릉"},{"n":"경포대초병설유치원","r":"강릉"},{"n":"경포유치원","r":"강릉"},{"n":"경포중학교","r":"강릉"},{"n":"경포초등학교","r":"강릉"},{"n":"계촌중학교","r":"평창"},{"n":"계촌초등학교","r":"평창"},{"n":"계촌초병설유치원","r":"평창"},{"n":"고산초등학교","r":"원주"},{"n":"고산초병설유치원","r":"원주"},{"n":"고성고등학교","r":"고성"},{"n":"고성중학교","r":"고성"},{"n":"고한고등학교","r":"정선"},{"n":"고한중학교","r":"정선"},{"n":"고한초등학교","r":"정선"},{"n":"고한초병설유치원","r":"정선"},{"n":"공근중학교","r":"횡성"},{"n":"공근초등학교","r":"횡성"},{"n":"공근초병설유치원","r":"횡성"},{"n":"공현진초등학교","r":"고성"},{"n":"공현진초병설유치원","r":"고성"},{"n":"관동중학교","r":"강릉"},{"n":"관설초등학교","r":"원주"},{"n":"광덕초등학교","r":"화천"},{"n":"광덕초병설유치원","r":"화천"},{"n":"광산초등학교","r":"고성"},{"n":"광산초병설유치원","r":"고성"},{"n":"광정초등학교","r":"속초양양"},{"n":"광정초병설유치원","r":"속초양양"},{"n":"광판중학교","r":"춘천"},{"n":"광판초등학교","r":"춘천"},{"n":"광판초병설유치원","r":"춘천"},{"n":"교동초등학교(강릉)","r":"강릉"},{"n":"교동초등학교(속초)","r":"속초양양"},{"n":"교동초등학교(원주)","r":"원주"},{"n":"교동초등학교(춘천)","r":"춘천"},{"n":"교동초병설유치원(강릉)","r":"강릉"},{"n":"교동초병설유치원(원주)","r":"원주"},{"n":"교동초병설유치원(춘천)","r":"춘천"},{"n":"교학초등학교","r":"원주"},{"n":"구곡초등학교","r":"원주"},{"n":"구곡초병설유치원","r":"원주"},{"n":"구래초등학교","r":"영월"},{"n":"구송초등학교","r":"홍천"},{"n":"구송초병설유치원","r":"홍천"},{"n":"구정초등학교","r":"강릉"},{"n":"구정초병설유치원","r":"강릉"},{"n":"귀둔초등학교","r":"인제"},{"n":"귀둔초병설유치원","r":"인제"},{"n":"귀래중학교","r":"원주"},{"n":"귀래초등학교","r":"원주"},{"n":"그린나래유치원","r":"원주"},{"n":"근남초등학교","r":"철원"},{"n":"근남초병설유치원","r":"철원"},{"n":"근덕중학교","r":"삼척"},{"n":"근덕초등학교","r":"삼척"},{"n":"근화초등학교","r":"춘천"},{"n":"금광초등학교","r":"강릉"},{"n":"금광초병설유치원","r":"강릉"},{"n":"금대초등학교","r":"원주"},{"n":"금병초등학교","r":"춘천"},{"n":"금빛유치원","r":"원주"},{"n":"금산초등학교","r":"춘천"},{"n":"금산초병설유치원","r":"춘천"},{"n":"기린고등학교","r":"인제"},{"n":"기린중학교","r":"인제"},{"n":"기린초등학교","r":"인제"},{"n":"기린초병설유치원","r":"인제"},{"n":"기린초진동분교장","r":"인제"},{"n":"김화고등학교","r":"철원"},{"n":"김화여자중학교","r":"철원"},{"n":"김화중학교","r":"철원"},{"n":"김화초등학교","r":"철원"},{"n":"김화초병설유치원","r":"철원"},{"n":"꿈나무유치원","r":"춘천"},{"n":"꿈에그린유치원","r":"춘천"},{"n":"나래유치원","r":"철원"},{"n":"나영유치원","r":"원주"},{"n":"나전중학교","r":"정선"},{"n":"낙산유치원","r":"속초양양"},{"n":"남강초등학교","r":"강릉"},{"n":"남부초등학교","r":"춘천"},{"n":"남산초등학교(강릉)","r":"강릉"},{"n":"남산초등학교(춘천)","r":"춘천"},{"n":"남산초등학교(홍천)","r":"홍천"},{"n":"남산초병설유치원(강릉)","r":"강릉"},{"n":"남산초병설유치원(춘천)","r":"춘천"},{"n":"남산초서천분교장","r":"춘천"},{"n":"남선초등학교","r":"정선"},{"n":"남선초병설유치원","r":"정선"},{"n":"남애초등학교","r":"속초양양"},{"n":"남애초병설유치원","r":"속초양양"},{"n":"남원주중학교","r":"원주"},{"n":"남원주초등학교","r":"원주"},{"n":"남원주초병설유치원","r":"원주"},{"n":"남춘천여자중학교","r":"춘천"},{"n":"남춘천중학교","r":"춘천"},{"n":"남춘천초등학교","r":"춘천"},{"n":"남평초등학교","r":"정선"},{"n":"남평초병설유치원","r":"정선"},{"n":"남호초등학교","r":"동해"},{"n":"남호초병설유치원","r":"동해"},{"n":"내대초등학교","r":"철원"},{"n":"내대초병설유치원","r":"철원"},{"n":"내면고등학교","r":"홍천"},{"n":"내면중학교","r":"홍천"},{"n":"내성초등학교","r":"영월"},{"n":"내성초병설유치원","r":"영월"},{"n":"내촌중학교","r":"홍천"},{"n":"내촌초등학교","r":"홍천"},{"n":"내촌초병설유치원","r":"홍천"},{"n":"너브내유치원","r":"홍천"},{"n":"노란유치원","r":"삼척"},{"n":"노암초등학교","r":"강릉"},{"n":"노암초병설유치원","r":"강릉"},{"n":"노천초등학교","r":"홍천"},{"n":"녹전중학교","r":"영월"},{"n":"녹전초등학교","r":"영월"},{"n":"녹전초병설유치원","r":"영월"},{"n":"늘해랑유치원","r":"강릉"},{"n":"다목초등학교","r":"화천"},{"n":"다목초병설유치원","r":"화천"},{"n":"다솔유치원","r":"삼척"},{"n":"다인유치원","r":"강릉"},{"n":"단계초등학교","r":"원주"},{"n":"단계초병설유치원","r":"원주"},{"n":"단관초등학교","r":"원주"},{"n":"단관초병설유치원","r":"원주"},{"n":"단구중학교","r":"원주"},{"n":"단구초등학교","r":"원주"},{"n":"단구초병설유치원","r":"원주"},{"n":"당림초등학교","r":"춘천"},{"n":"당림초병설유치원","r":"춘천"},{"n":"대곡초등학교","r":"홍천"},{"n":"대곡초병설유치원","r":"홍천"},{"n":"대관령중학교","r":"평창"},{"n":"대관령초등학교","r":"평창"},{"n":"대동여자중학교","r":"횡성"},{"n":"대동유치원","r":"동해"},{"n":"대룡중학교","r":"춘천"},{"n":"대성고등학교","r":"원주"},{"n":"대성중학교","r":"원주"},{"n":"대암중학교","r":"양구"},{"n":"대진고등학교","r":"고성"},{"n":"대진중학교","r":"고성"},{"n":"대진초등학교","r":"고성"},{"n":"대진초병설유치원","r":"고성"},{"n":"대포초등학교","r":"속초양양"},{"n":"대포초병설유치원","r":"속초양양"},{"n":"대화고등학교","r":"평창"},{"n":"대화중학교","r":"평창"},{"n":"대화초등학교","r":"평창"},{"n":"도계고등학교","r":"삼척"},{"n":"도계전산정보고등학교","r":"삼척"},{"n":"도계중학교","r":"삼척"},{"n":"도계초등학교","r":"삼척"},{"n":"도계한빛유치원","r":"삼척"},{"n":"도담유치원","r":"원주"},{"n":"도성초등학교","r":"평창"},{"n":"도성초병설유치원","r":"평창"},{"n":"도창초등학교","r":"철원"},{"n":"도촌초등학교","r":"양구"},{"n":"도촌초병설유치원","r":"양구"},{"n":"도학초등학교","r":"고성"},{"n":"동광산업과학고등학교","r":"고성"},{"n":"동광중학교","r":"고성"},{"n":"동광초등학교","r":"고성"},{"n":"동광초병설유치원","r":"고성"},{"n":"동내초등학교","r":"춘천"},{"n":"동내초병설유치원","r":"춘천"},{"n":"동명중학교","r":"강릉"},{"n":"동명초등학교","r":"강릉"},{"n":"동부초등학교","r":"춘천"},{"n":"동산중학교","r":"춘천"},{"n":"동송초등학교","r":"철원"},{"n":"동점초등학교","r":"태백"},{"n":"동춘천초등학교","r":"춘천"},{"n":"동해광희고등학교","r":"동해"},{"n":"동해광희중학교","r":"동해"},{"n":"동해랑유치원","r":"동해"},{"n":"동해삼육고등학교","r":"동해"},{"n":"동해삼육중학교","r":"동해"},{"n":"동해삼육초등학교","r":"동해"},{"n":"동해상업고등학교","r":"동해"},{"n":"동해중앙초등학교","r":"동해"},{"n":"동해중앙초병설유치원","r":"동해"},{"n":"동해중학교","r":"동해"},{"n":"동해초등학교","r":"동해"},{"n":"동해초병설유치원","r":"동해"},{"n":"동해해솔학교","r":"동해"},{"n":"동호초등학교","r":"동해"},{"n":"동화나라유치원","r":"원주"},{"n":"동화중학교","r":"홍천"},{"n":"동화초등학교","r":"원주"},{"n":"동화초병설유치원","r":"원주"},{"n":"두란노유치원","r":"춘천"},{"n":"두촌중학교","r":"홍천"},{"n":"두촌초등학교","r":"홍천"},{"n":"두촌초병설유치원","r":"홍천"},{"n":"둔내고등학교","r":"횡성"},{"n":"둔내중학교","r":"횡성"},{"n":"둔내초등학교","r":"횡성"},{"n":"둔내초병설유치원","r":"횡성"},{"n":"둔둔초등학교","r":"원주"},{"n":"둔둔초병설유치원","r":"원주"},{"n":"리라유치원(동해)","r":"동해"},{"n":"마야유치원","r":"홍천"},{"n":"마차고등학교","r":"영월"},{"n":"마차중학교","r":"영월"},{"n":"마차초등학교","r":"영월"},{"n":"마차초병설유치원","r":"영월"},{"n":"만대초등학교","r":"원주"},{"n":"만종초등학교","r":"원주"},{"n":"만종초병설유치원","r":"원주"},{"n":"만천유치원","r":"춘천"},{"n":"만천초등학교","r":"춘천"},{"n":"망상초등학교","r":"동해"},{"n":"매산초등학교","r":"홍천"},{"n":"매산초병설유치원","r":"홍천"},{"n":"매지초등학교","r":"원주"},{"n":"맹방초등학교","r":"삼척"},{"n":"맹방초병설유치원","r":"삼척"},{"n":"메밀꽃유치원","r":"평창"},{"n":"면온초등학교","r":"평창"},{"n":"면온초병설유치원","r":"평창"},{"n":"명덕초등학교","r":"홍천"},{"n":"명덕초병설유치원","r":"홍천"},{"n":"명륜초등학교","r":"원주"},{"n":"명륜초병설유치원","r":"원주"},{"n":"명문유치원","r":"춘천"},{"n":"명주초등학교","r":"강릉"},{"n":"명주초병설유치원","r":"강릉"},{"n":"모곡초등학교","r":"홍천"},{"n":"모산초등학교","r":"강릉"},{"n":"모산초병설유치원","r":"강릉"},{"n":"묘장초등학교","r":"철원"},{"n":"무궁화유치원","r":"춘천"},{"n":"무릉초등학교","r":"영월"},{"n":"무릉초병설유치원","r":"영월"},{"n":"무실빛유치원","r":"원주"},{"n":"무실초등학교","r":"원주"},{"n":"무실초병설유치원","r":"원주"},{"n":"무지개유치원","r":"동해"},{"n":"묵호고등학교","r":"동해"},{"n":"묵호중학교","r":"동해"},{"n":"묵호초등학교","r":"동해"},{"n":"문곡중학교","r":"정선"},{"n":"문막고등학교","r":"원주"},{"n":"문막성모유치원","r":"원주"},{"n":"문막중학교","r":"원주"},{"n":"문막초등학교","r":"원주"},{"n":"문막초병설유치원","r":"원주"},{"n":"문혜초등학교","r":"철원"},{"n":"문혜초병설유치원","r":"철원"},{"n":"미동초등학교","r":"태백"},{"n":"미라유치원","r":"삼척"},{"n":"미래고등학교","r":"원주"},{"n":"미래숲유치원","r":"춘천"},{"n":"미로중학교","r":"삼척"},{"n":"미로초등학교","r":"삼척"},{"n":"미로초병설유치원","r":"삼척"},{"n":"미탄중학교","r":"평창"},{"n":"미탄초등학교","r":"평창"},{"n":"미탄초병설유치원","r":"평창"},{"n":"민족사관고등학교","r":"횡성"},{"n":"반계초등학교","r":"원주"},{"n":"반계초병설유치원","r":"원주"},{"n":"반곡드림유치원","r":"원주"},{"n":"반곡별유치원","r":"원주"},{"n":"반곡중학교","r":"원주"},{"n":"반곡초등학교(원주)","r":"원주"},{"n":"반곡초등학교(홍천)","r":"홍천"},{"n":"반곡초병설유치원(원주)","r":"원주"},{"n":"반야유치원","r":"정선"},{"n":"방림초등학교","r":"평창"},{"n":"방림초병설유치원","r":"평창"},{"n":"방산중학교","r":"양구"},{"n":"방산초등학교","r":"양구"},{"n":"방산초병설유치원","r":"양구"},{"n":"백전초등학교","r":"정선"},{"n":"버들중학교","r":"원주"},{"n":"버들초등학교","r":"원주"},{"n":"버들초병설유치원","r":"원주"},{"n":"벽탄초등학교","r":"정선"},{"n":"보덕유치원","r":"영월"},{"n":"봄내중학교","r":"춘천"},{"n":"봄내초등학교","r":"춘천"},{"n":"봄봄유치원","r":"춘천"},{"n":"봉대가온학교","r":"원주"},{"n":"봉대초등학교","r":"원주"},{"n":"봉대초병설유치원","r":"원주"},{"n":"봉래중학교","r":"영월"},{"n":"봉래초등학교","r":"영월"},{"n":"봉래초병설유치원","r":"영월"},{"n":"봉양초등학교","r":"정선"},{"n":"봉의고등학교","r":"춘천"},{"n":"봉의중학교","r":"춘천"},{"n":"봉의초등학교","r":"춘천"},{"n":"봉의초병설유치원","r":"춘천"},{"n":"봉평고등학교","r":"평창"},{"n":"봉평중학교","r":"평창"},{"n":"봉평초등학교","r":"평창"},{"n":"봉화산숲유치원","r":"원주"},{"n":"부론중학교","r":"원주"},{"n":"부론초등학교","r":"원주"},{"n":"부안초등학교","r":"춘천"},{"n":"부평초등학교","r":"인제"},{"n":"부평초병설유치원","r":"인제"},{"n":"북삼초등학교","r":"동해"},{"n":"북원여자고등학교","r":"원주"},{"n":"북원중학교","r":"원주"},{"n":"북원초등학교","r":"원주"},{"n":"북원초병설유치원","r":"원주"},{"n":"북평고등학교","r":"동해"},{"n":"북평여자고등학교","r":"동해"},{"n":"북평중학교","r":"동해"},{"n":"북평초등학교(동해)","r":"동해"},{"n":"북평초등학교(정선)","r":"정선"},{"n":"비두초등학교","r":"원주"},{"n":"비두초병설유치원","r":"원주"},{"n":"비봉초등학교","r":"양구"},{"n":"비봉초병설유치원","r":"양구"},{"n":"사내고등학교","r":"화천"},{"n":"사내중학교","r":"화천"},{"n":"사내초등학교","r":"화천"},{"n":"사내초병설유치원","r":"화천"},{"n":"사북고등학교","r":"정선"},{"n":"사북중학교","r":"정선"},{"n":"사북초등학교","r":"정선"},{"n":"사북초병설유치원","r":"정선"},{"n":"사천중학교","r":"강릉"},{"n":"사천초등학교","r":"강릉"},{"n":"사천초병설유치원","r":"강릉"},{"n":"산내들유치원","r":"원주"},{"n":"산양초등학교","r":"화천"},{"n":"산양초병설유치원","r":"화천"},{"n":"산현초등학교","r":"원주"},{"n":"산호유치원","r":"속초양양"},{"n":"삼생초등학교","r":"홍천"},{"n":"삼생초병설유치원","r":"홍천"},{"n":"삼성초등학교","r":"태백"},{"n":"삼성초병설유치원","r":"태백"},{"n":"삼운사유치원","r":"춘천"},{"n":"삼일고등학교","r":"삼척"},{"n":"삼일중학교","r":"삼척"},{"n":"삼척고등학교","r":"삼척"},{"n":"삼척남초등학교","r":"삼척"},{"n":"삼척누리유치원","r":"삼척"},{"n":"삼척여자고등학교","r":"삼척"},{"n":"삼척중앙초등학교","r":"삼척"},{"n":"삼척중학교","r":"삼척"},{"n":"삼척초등학교","r":"삼척"},{"n":"삼포초등학교","r":"홍천"},{"n":"삼포초병설유치원","r":"홍천"},{"n":"삼화초등학교","r":"동해"},{"n":"삼화초병설유치원","r":"동해"},{"n":"상남중학교","r":"인제"},{"n":"상남초등학교","r":"인제"},{"n":"상남초병설유치원","r":"인제"},{"n":"상동고등학교","r":"영월"},{"n":"상동중학교","r":"영월"},{"n":"상서중학교","r":"화천"},{"n":"상승초등학교","r":"화천"},{"n":"상승초병설유치원","r":"화천"},{"n":"상장중학교","r":"태백"},{"n":"상장초등학교","r":"태백"},{"n":"상지대관령고등학교","r":"평창"},{"n":"상지여자고등학교","r":"원주"},{"n":"상지여자중학교","r":"원주"},{"n":"상천초등학교","r":"춘천"},{"n":"상천초병설유치원","r":"춘천"},{"n":"상평초공수전분교장","r":"속초양양"},{"n":"상평초등학교","r":"속초양양"},{"n":"상평초병설유치원","r":"속초양양"},{"n":"상평초오색분교장","r":"속초양양"},{"n":"새들유치원","r":"철원"},{"n":"새봄유치원","r":"춘천"},{"n":"샘마루초등학교","r":"원주"},{"n":"샘마루초병설유치원","r":"원주"},{"n":"서곡초등학교","r":"원주"},{"n":"서곡초병설유치원","r":"원주"},{"n":"서면초등학교","r":"철원"},{"n":"서면초병설유치원","r":"철원"},{"n":"서부초등학교","r":"삼척"},{"n":"서상초등학교","r":"춘천"},{"n":"서상초병설유치원","r":"춘천"},{"n":"서석고등학교","r":"홍천"},{"n":"서석중학교","r":"홍천"},{"n":"서석초등학교","r":"홍천"},{"n":"서석초병설유치원","r":"홍천"},{"n":"서석초청량분교장","r":"홍천"},{"n":"서석초청량분교장병설유치원","r":"홍천"},{"n":"서원주초등학교","r":"원주"},{"n":"서원주초병설유치원","r":"원주"},{"n":"서원중학교","r":"횡성"},{"n":"서원초등학교","r":"횡성"},{"n":"서원초병설유치원","r":"횡성"},{"n":"서화중학교","r":"인제"},{"n":"서화초등학교","r":"인제"},{"n":"서화초병설유치원","r":"인제"},{"n":"석사초등학교","r":"춘천"},{"n":"석정여자고등학교","r":"영월"},{"n":"석정여자중학교","r":"영월"},{"n":"석천중학교","r":"양구"},{"n":"석화초등학교","r":"홍천"},{"n":"설악고등학교","r":"속초양양"},{"n":"설악중학교","r":"속초양양"},{"n":"설악초등학교","r":"속초양양"},{"n":"설악초병설유치원","r":"속초양양"},{"n":"설온중학교","r":"속초양양"},{"n":"섬강고등학교","r":"원주"},{"n":"섬강중학교","r":"원주"},{"n":"섬강초등학교","r":"원주"},{"n":"섬강초병설유치원","r":"원주"},{"n":"섬머힐유치원","r":"춘천"},{"n":"성균관유치원","r":"원주"},{"n":"성남초등학교","r":"횡성"},{"n":"성남초병설유치원","r":"횡성"},{"n":"성덕초등학교","r":"강릉"},{"n":"성림초등학교","r":"춘천"},{"n":"성모유치원","r":"횡성"},{"n":"성무유치원","r":"원주"},{"n":"성북초등학교","r":"횡성"},{"n":"성북초병설유치원","r":"횡성"},{"n":"성불유치원","r":"원주"},{"n":"성산초등학교","r":"강릉"},{"n":"성산초병설유치원","r":"강릉"},{"n":"성수고등학교","r":"춘천"},{"n":"성수여자고등학교","r":"춘천"},{"n":"성심유치원","r":"춘천"},{"n":"성원유치원","r":"강릉"},{"n":"성원초등학교","r":"춘천"},{"n":"성호유치원","r":"동해"},{"n":"세연중학교","r":"태백"},{"n":"소야초등학교","r":"속초양양"},{"n":"소야초병설유치원","r":"속초양양"},{"n":"소양중학교","r":"춘천"},{"n":"소양초등학교","r":"춘천"},{"n":"소초초등학교","r":"원주"},{"n":"소초초병설유치원","r":"원주"},{"n":"소화유치원","r":"강릉"},{"n":"속사초등학교","r":"평창"},{"n":"속사초병설유치원","r":"평창"},{"n":"속초고등학교","r":"속초양양"},{"n":"속초여자고등학교","r":"속초양양"},{"n":"속초유치원","r":"속초양양"},{"n":"속초중학교","r":"속초양양"},{"n":"속초청해학교","r":"속초양양"},{"n":"속초초등학교(속초)","r":"속초양양"},{"n":"속초초등학교(홍천)","r":"홍천"},{"n":"속초초병설유치원","r":"홍천"},{"n":"속초해랑중학교","r":"속초양양"},{"n":"손양초등학교","r":"속초양양"},{"n":"손양초병설유치원","r":"속초양양"},{"n":"솔빛유치원","r":"동해"},{"n":"솔샘초등학교","r":"원주"},{"n":"솔샘초병설유치원","r":"원주"},{"n":"솔올중학교","r":"강릉"},{"n":"솔향유치원","r":"강릉"},{"n":"송양초등학교","r":"강릉"},{"n":"송이유치원","r":"원주"},{"n":"송정초등학교","r":"동해"},{"n":"송포초등학교","r":"속초양양"},{"n":"송포초병설유치원","r":"속초양양"},{"n":"송화초등학교","r":"춘천"},{"n":"송화초병설유치원","r":"춘천"},{"n":"수백초등학교","r":"횡성"},{"n":"수백초병설유치원","r":"횡성"},{"n":"숲실초등학교","r":"강릉"},{"n":"스마트유치원","r":"원주"},{"n":"신남고등학교","r":"인제"},{"n":"신남중학교","r":"인제"},{"n":"신남초등학교","r":"춘천"},{"n":"신동초등학교(삼척)","r":"삼척"},{"n":"신동초등학교(춘천)","r":"춘천"},{"n":"신동초병설유치원(춘천)","r":"춘천"},{"n":"신리초등학교","r":"평창"},{"n":"신림중학교","r":"원주"},{"n":"신림초등학교","r":"원주"},{"n":"신영초등학교","r":"강릉"},{"n":"신영초병설유치원","r":"강릉"},{"n":"신왕초등학교","r":"강릉"},{"n":"신왕초병설유치원","r":"강릉"},{"n":"신천초등학교","r":"영월"},{"n":"신천초병설유치원","r":"영월"},{"n":"신철원고등학교","r":"철원"},{"n":"신철원중학교","r":"철원"},{"n":"신철원초등학교","r":"철원"},{"n":"신철원초병설유치원","r":"철원"},{"n":"신평초등학교","r":"원주"},{"n":"신평초병설유치원","r":"원주"},{"n":"신포중학교","r":"춘천"},{"n":"실내초등학교","r":"화천"},{"n":"실내초병설유치원","r":"화천"},{"n":"쌍룡중학교","r":"영월"},{"n":"쌍룡초등학교","r":"영월"},{"n":"쌍룡초병설유치원","r":"영월"},{"n":"아야진초등학교","r":"고성"},{"n":"안미초등학교","r":"평창"},{"n":"안미초병설유치원","r":"평창"},{"n":"안흥고등학교","r":"횡성"},{"n":"안흥중학교","r":"횡성"},{"n":"안흥초덕천분교장","r":"횡성"},{"n":"안흥초등학교","r":"횡성"},{"n":"양구고등학교","r":"양구"},{"n":"양구여자고등학교","r":"양구"},{"n":"양구중학교","r":"양구"},{"n":"양구초등학교","r":"양구"},{"n":"양구초병설유치원","r":"양구"},{"n":"양덕중학교","r":"홍천"},{"n":"양양고등학교","r":"속초양양"},{"n":"양양중학교","r":"속초양양"},{"n":"양양초등학교","r":"속초양양"},{"n":"양양초병설유치원","r":"속초양양"},{"n":"어론초등학교","r":"인제"},{"n":"여량고등학교","r":"정선"},{"n":"여량중학교","r":"정선"},{"n":"여량초등학교","r":"정선"},{"n":"여량초병설유치원","r":"정선"},{"n":"연곡초등학교","r":"강릉"},{"n":"연곡초병설유치원","r":"강릉"},{"n":"연당중학교","r":"영월"},{"n":"연당초등학교","r":"영월"},{"n":"연당초병설유치원","r":"영월"},{"n":"열린유치원","r":"춘천"},{"n":"영동초등학교","r":"강릉"},{"n":"영동초병설유치원","r":"강릉"},{"n":"영랑초등학교","r":"속초양양"},{"n":"영서고등학교","r":"원주"},{"n":"영월고등학교","r":"영월"},{"n":"영월유치원","r":"영월"},{"n":"영월중학교","r":"영월"},{"n":"영월초등학교","r":"영월"},{"n":"영지유치원","r":"원주"},{"n":"예그랑유치원","r":"원주"},{"n":"예람중학교","r":"동해"},{"n":"예미초등학교","r":"정선"},{"n":"예미초병설유치원","r":"정선"},{"n":"예미초운치분교장","r":"정선"},{"n":"예원유치원","r":"춘천"},{"n":"예지유치원","r":"원주"},{"n":"예초유치원","r":"춘천"},{"n":"오덕초등학교","r":"철원"},{"n":"오동초등학교","r":"춘천"},{"n":"오동초병설유치원","r":"춘천"},{"n":"오안초등학교","r":"홍천"},{"n":"오저초등학교","r":"삼척"},{"n":"오저초병설유치원","r":"삼척"},{"n":"오호초등학교","r":"고성"},{"n":"오호초병설유치원","r":"고성"},{"n":"옥계중학교","r":"강릉"},{"n":"옥계초금진분교장","r":"강릉"},{"n":"옥계초금진분교장병설유치원","r":"강릉"},{"n":"옥계초등학교","r":"강릉"},{"n":"옥계초병설유치원","r":"강릉"},{"n":"옥동중학교","r":"영월"},{"n":"옥동초등학교","r":"영월"},{"n":"옥동초병설유치원","r":"영월"},{"n":"옥천초등학교","r":"강릉"},{"n":"옥천초병설유치원","r":"강릉"},{"n":"온의유치원","r":"춘천"},{"n":"온정초등학교","r":"속초양양"},{"n":"온정초병설유치원","r":"속초양양"},{"n":"와수초등학교","r":"철원"},{"n":"와수초병설유치원","r":"철원"},{"n":"왕산중학교","r":"강릉"},{"n":"왕산초등학교","r":"강릉"},{"n":"왕산초병설유치원","r":"강릉"},{"n":"용대초등학교","r":"인제"},{"n":"용대초병설유치원","r":"인제"},{"n":"용암초등학교","r":"화천"},{"n":"용암초병설유치원","r":"화천"},{"n":"용전중학교","r":"평창"},{"n":"용정초등학교","r":"철원"},{"n":"용하중학교","r":"양구"},{"n":"용하초등학교","r":"양구"},{"n":"용하초병설유치원","r":"양구"},{"n":"우리유치원","r":"춘천"},{"n":"우산초등학교","r":"원주"},{"n":"우산초병설유치원","r":"원주"},{"n":"우석중학교","r":"춘천"},{"n":"우석초등학교","r":"춘천"},{"n":"우석초병설유치원","r":"춘천"},{"n":"우천중학교","r":"횡성"},{"n":"우천초등학교","r":"횡성"},{"n":"운산초등학교","r":"강릉"},{"n":"운양초등학교","r":"강릉"},{"n":"원당초등학교(양구)","r":"양구"},{"n":"원당초등학교(홍천)","r":"홍천"},{"n":"원당초병설유치원","r":"양구"},{"n":"원덕고등학교","r":"삼척"},{"n":"원덕중학교","r":"삼척"},{"n":"원주고등학교","r":"원주"},{"n":"원주금융회계고등학교","r":"원주"},{"n":"원주삼육고등학교","r":"원주"},{"n":"원주삼육중학교","r":"원주"},{"n":"원주삼육초등학교","r":"원주"},{"n":"원주여자고등학교","r":"원주"},{"n":"원주여자중학교","r":"원주"},{"n":"원주유치원","r":"원주"},{"n":"원주의료고등학교","r":"원주"},{"n":"원주중학교","r":"원주"},{"n":"원주청원학교","r":"원주"},{"n":"원주초등학교","r":"원주"},{"n":"원주초병설유치원","r":"원주"},{"n":"원천초등학교","r":"화천"},{"n":"원천초병설유치원","r":"화천"},{"n":"원통고등학교","r":"인제"},{"n":"원통중학교","r":"인제"},{"n":"원통초등학교","r":"인제"},{"n":"원통초병설유치원","r":"인제"},{"n":"월학초등학교","r":"인제"},{"n":"월학초병설유치원","r":"인제"},{"n":"유봉여자고등학교","r":"춘천"},{"n":"유봉여자중학교","r":"춘천"},{"n":"유천초등학교","r":"강릉"},{"n":"유천초병설유치원","r":"강릉"},{"n":"유촌초등학교","r":"화천"},{"n":"유촌초병설유치원","r":"화천"},{"n":"유현초등학교","r":"횡성"},{"n":"육민관고등학교","r":"원주"},{"n":"육민관중학교","r":"원주"},{"n":"율곡중학교","r":"강릉"},{"n":"율곡초등학교","r":"강릉"},{"n":"율전초등학교","r":"홍천"},{"n":"율전초병설유치원","r":"홍천"},{"n":"은빛유치원","r":"춘천"},{"n":"이화유치원","r":"원주"},{"n":"인구초등학교","r":"속초양양"},{"n":"인구초병설유치원","r":"속초양양"},{"n":"인제고등학교","r":"인제"},{"n":"인제남초등학교","r":"인제"},{"n":"인제중학교","r":"인제"},{"n":"인제초등학교","r":"인제"},{"n":"인흥초등학교","r":"고성"},{"n":"일산초등학교","r":"원주"},{"n":"일산초병설유치원","r":"원주"},{"n":"임계고등학교","r":"정선"},{"n":"임계중학교","r":"정선"},{"n":"임계초등학교","r":"정선"},{"n":"임계초병설유치원","r":"정선"},{"n":"임당초등학교","r":"양구"},{"n":"임당초병설유치원","r":"양구"},{"n":"임원중학교","r":"삼척"},{"n":"임원초등학교","r":"삼척"},{"n":"임원초병설유치원","r":"삼척"},{"n":"자연유치원(원주)","r":"원주"},{"n":"자연유치원(춘천)","r":"춘천"},{"n":"장성여자고등학교","r":"태백"},{"n":"장성초등학교","r":"태백"},{"n":"장성초병설유치원","r":"태백"},{"n":"장양초등학교","r":"원주"},{"n":"장양초병설유치원","r":"원주"},{"n":"장원초등학교","r":"삼척"},{"n":"장평초등학교","r":"평창"},{"n":"장학초등학교","r":"춘천"},{"n":"장학초병설유치원","r":"춘천"},{"n":"장호초등학교","r":"삼척"},{"n":"장호초병설유치원","r":"삼척"},{"n":"장흥초등학교","r":"철원"},{"n":"전인고등학교","r":"춘천"},{"n":"정금초등학교","r":"횡성"},{"n":"정금초병설유치원","r":"횡성"},{"n":"정동초등학교","r":"강릉"},{"n":"정동초병설유치원","r":"강릉"},{"n":"정라초등학교","r":"삼척"},{"n":"정라초병설유치원","r":"삼척"},{"n":"정선고등학교","r":"정선"},{"n":"정선유치원","r":"정선"},{"n":"정선정보공업고등학교","r":"정선"},{"n":"정선중학교","r":"정선"},{"n":"정선초가수분교장","r":"정선"},{"n":"정선초등학교","r":"정선"},{"n":"제이엠유치원","r":"강릉"},{"n":"제일유치원","r":"원주"},{"n":"조산초등학교","r":"속초양양"},{"n":"조산초병설유치원","r":"속초양양"},{"n":"조양초등학교(속초)","r":"속초양양"},{"n":"조양초등학교(춘천)","r":"춘천"},{"n":"조양초병설유치원","r":"춘천"},{"n":"좋은유치원","r":"강릉"},{"n":"주문진고등학교","r":"강릉"},{"n":"주문진중학교","r":"강릉"},{"n":"주문진초등학교","r":"강릉"},{"n":"주문진초병설유치원","r":"강릉"},{"n":"주봉초등학교","r":"홍천"},{"n":"주봉초병설유치원","r":"홍천"},{"n":"주영초등학교","r":"강릉"},{"n":"주영초병설유치원","r":"강릉"},{"n":"주진초등학교","r":"평창"},{"n":"주천고등학교","r":"영월"},{"n":"주천중학교","r":"영월"},{"n":"주천초등학교","r":"영월"},{"n":"주천초병설유치원","r":"영월"},{"n":"죽리초등학교","r":"양구"},{"n":"죽리초병설유치원","r":"양구"},{"n":"죽왕초등학교","r":"고성"},{"n":"죽왕초병설유치원","r":"고성"},{"n":"중앙유치원","r":"삼척"},{"n":"중앙초등학교(강릉)","r":"강릉"},{"n":"중앙초등학교(속초)","r":"속초양양"},{"n":"중앙초등학교(원주)","r":"원주"},{"n":"중앙초등학교(춘천)","r":"춘천"},{"n":"중앙초병설유치원","r":"원주"},{"n":"증산초등학교","r":"정선"},{"n":"지정샘유치원","r":"원주"},{"n":"지정중학교","r":"원주"},{"n":"지정초등학교","r":"원주"},{"n":"지정초병설유치원","r":"원주"},{"n":"지촌초등학교","r":"춘천"},{"n":"지촌초지암분교장","r":"춘천"},{"n":"지촌초지암분교장병설유치원","r":"춘천"},{"n":"진광고등학교","r":"원주"},{"n":"진광중학교","r":"원주"},{"n":"진부고등학교","r":"평창"},{"n":"진부중학교","r":"평창"},{"n":"진부초등학교","r":"평창"},{"n":"진부초병설유치원","r":"평창"},{"n":"진주초등학교","r":"삼척"},{"n":"진주초병설유치원","r":"삼척"},{"n":"창림초등학교","r":"횡성"},{"n":"창림초병설유치원","r":"횡성"},{"n":"창촌중학교","r":"춘천"},{"n":"창촌초등학교","r":"홍천"},{"n":"창촌초병설유치원","r":"홍천"},{"n":"창호초등학교","r":"동해"},{"n":"천곡초등학교","r":"동해"},{"n":"천곡초병설유치원","r":"동해"},{"n":"천전초등학교","r":"춘천"},{"n":"천전초병설유치원","r":"춘천"},{"n":"천진초등학교","r":"고성"},{"n":"천진초병설유치원","r":"고성"},{"n":"철암고등학교","r":"태백"},{"n":"철암중학교","r":"태백"},{"n":"철암초등학교","r":"태백"},{"n":"철원고등학교","r":"철원"},{"n":"철원여자고등학교","r":"철원"},{"n":"철원여자중학교","r":"철원"},{"n":"철원중학교","r":"철원"},{"n":"철원초등학교","r":"철원"},{"n":"청담유치원(원주)","r":"원주"},{"n":"청대초등학교","r":"속초양양"},{"n":"청대초병설유치원","r":"속초양양"},{"n":"청령포초등학교","r":"영월"},{"n":"청령포초병설유치원","r":"영월"},{"n":"청봉초등학교","r":"속초양양"},{"n":"청아중학교","r":"삼척"},{"n":"청양초등학교","r":"철원"},{"n":"청양초병설유치원","r":"철원"},{"n":"청운초등학교","r":"동해"},{"n":"청일중학교","r":"횡성"},{"n":"청일초등학교","r":"횡성"},{"n":"청일초병설유치원","r":"횡성"},{"n":"청호초등학교","r":"속초양양"},{"n":"청호초병설유치원","r":"속초양양"},{"n":"초당초등학교","r":"강릉"},{"n":"추곡초등학교","r":"춘천"},{"n":"추곡초병설유치원","r":"춘천"},{"n":"춘당초등학교","r":"횡성"},{"n":"춘성중학교","r":"춘천"},{"n":"춘천계성학교","r":"춘천"},{"n":"춘천고등학교","r":"춘천"},{"n":"춘천교육대학부설초등학교","r":"춘천"},{"n":"춘천기계공업고등학교","r":"춘천"},{"n":"춘천동원학교","r":"춘천"},{"n":"춘천삼육초등학교","r":"춘천"},{"n":"춘천여자고등학교","r":"춘천"},{"n":"춘천유치원","r":"춘천"},{"n":"춘천중학교","r":"춘천"},{"n":"춘천초등학교","r":"춘천"},{"n":"춘천한샘고등학교","r":"춘천"},{"n":"치악고등학교","r":"원주"},{"n":"치악중학교","r":"원주"},{"n":"치악초등학교","r":"원주"},{"n":"치악초병설유치원","r":"원주"},{"n":"큰나무유치원","r":"원주"},{"n":"태백라온학교","r":"태백"},{"n":"태백초등학교","r":"태백"},{"n":"태봉초등학교","r":"원주"},{"n":"태봉초병설유치원","r":"원주"},{"n":"태사랑유치원","r":"태백"},{"n":"태서초등학교","r":"태백"},{"n":"태장중학교","r":"원주"},{"n":"태장초등학교","r":"원주"},{"n":"태장초병설유치원","r":"원주"},{"n":"토성초등학교","r":"철원"},{"n":"통리초등학교","r":"태백"},{"n":"통리초병설유치원","r":"태백"},{"n":"퇴계중학교","r":"춘천"},{"n":"퇴계초등학교","r":"춘천"},{"n":"퇴계초병설유치원","r":"춘천"},{"n":"팔렬고등학교","r":"홍천"},{"n":"팔렬중학교","r":"홍천"},{"n":"평원중학교","r":"원주"},{"n":"평원초등학교","r":"원주"},{"n":"평창고등학교","r":"평창"},{"n":"평창중학교","r":"평창"},{"n":"평창초등학교","r":"평창"},{"n":"평창초병설유치원","r":"평창"},{"n":"포남초등학교","r":"강릉"},{"n":"푸른자연유치원","r":"원주"},{"n":"풍산초등학교","r":"화천"},{"n":"풍산초병설유치원","r":"화천"},{"n":"프라임상상유치원","r":"원주"},{"n":"프렌비숲유치원","r":"강릉"},{"n":"하남초등학교","r":"인제"},{"n":"하남초병설유치원","r":"인제"},{"n":"하늘내린유치원","r":"인제"},{"n":"하늘빛유치원","r":"태백"},{"n":"하랑중학교","r":"동해"},{"n":"하슬라유치원","r":"강릉"},{"n":"하슬라중학교","r":"강릉"},{"n":"하장중학교","r":"삼척"},{"n":"하장초등학교","r":"삼척"},{"n":"학림유치원","r":"원주"},{"n":"학성유치원","r":"원주"},{"n":"학성중학교","r":"원주"},{"n":"학성초등학교","r":"원주"},{"n":"한강유치원","r":"원주"},{"n":"한계초등학교","r":"인제"},{"n":"한계초병설유치원","r":"인제"},{"n":"한국소방마이스터고등학교","r":"영월"},{"n":"한국항공고등학교","r":"태백"},{"n":"한남초등학교","r":"속초양양"},{"n":"한남초병설유치원","r":"속초양양"},{"n":"한림유치원","r":"춘천"},{"n":"한서중학교","r":"홍천"},{"n":"한서초등학교","r":"홍천"},{"n":"한서초병설유치원","r":"홍천"},{"n":"한솔초등학교","r":"강릉"},{"n":"한아름유치원","r":"원주"},{"n":"한전초등학교","r":"양구"},{"n":"한전초병설유치원","r":"양구"},{"n":"함백고등학교","r":"정선"},{"n":"함백중학교","r":"정선"},{"n":"함백초등학교","r":"정선"},{"n":"함백초병설유치원","r":"정선"},{"n":"함태중학교","r":"태백"},{"n":"함태초등학교","r":"태백"},{"n":"해밀학교","r":"홍천"},{"n":"해안중학교","r":"양구"},{"n":"해안초등학교","r":"양구"},{"n":"해안초병설유치원","r":"양구"},{"n":"해오름유치원","r":"동해"},{"n":"현남중학교","r":"속초양양"},{"n":"현북중학교","r":"속초양양"},{"n":"현북초등학교","r":"속초양양"},{"n":"현북초병설유치원","r":"속초양양"},{"n":"현성초등학교","r":"속초양양"},{"n":"현성초병설유치원","r":"속초양양"},{"n":"현천고등학교","r":"횡성"},{"n":"협신초등학교","r":"홍천"},{"n":"협신초병설유치원","r":"홍천"},{"n":"호명초등학교","r":"평창"},{"n":"호명초병설유치원","r":"평창"},{"n":"호반초등학교","r":"춘천"},{"n":"호산초등학교","r":"삼척"},{"n":"호산초병설유치원","r":"삼척"},{"n":"호저중학교","r":"원주"},{"n":"호저초등학교","r":"원주"},{"n":"호저초병설유치원","r":"원주"},{"n":"홍천고등학교","r":"홍천"},{"n":"홍천남산유치원","r":"홍천"},{"n":"홍천농업고등학교","r":"홍천"},{"n":"홍천여자고등학교","r":"홍천"},{"n":"홍천여자중학교","r":"홍천"},{"n":"홍천유치원","r":"홍천"},{"n":"홍천중학교","r":"홍천"},{"n":"홍천초등학교","r":"홍천"},{"n":"화계초등학교","r":"홍천"},{"n":"화계초병설유치원","r":"홍천"},{"n":"화동중학교","r":"정선"},{"n":"화동초등학교","r":"정선"},{"n":"화동초병설유치원","r":"정선"},{"n":"화성유치원","r":"횡성"},{"n":"화천고등학교","r":"화천"},{"n":"화천유치원","r":"화천"},{"n":"화천정산고등학교","r":"화천"},{"n":"화천중학교","r":"화천"},{"n":"화천초등학교","r":"화천"},{"n":"화촌중학교","r":"홍천"},{"n":"화촌초등학교","r":"홍천"},{"n":"황둔중학교","r":"원주"},{"n":"황둔초등학교","r":"원주"},{"n":"황둔초병설유치원","r":"원주"},{"n":"황지고등학교","r":"태백"},{"n":"황지정보산업고등학교","r":"태백"},{"n":"황지중앙초등학교","r":"태백"},{"n":"황지중학교","r":"태백"},{"n":"황지초등학교","r":"태백"},{"n":"회룡초등학교","r":"속초양양"},{"n":"회룡초병설유치원","r":"속초양양"},{"n":"횡계초등학교","r":"평창"},{"n":"횡계초병설유치원","r":"평창"},{"n":"횡성고등학교","r":"횡성"},{"n":"횡성여자고등학교","r":"횡성"},{"n":"횡성중학교","r":"횡성"},{"n":"횡성초등학교","r":"횡성"},{"n":"횡성초병설유치원","r":"횡성"},{"n":"효제초등학교","r":"춘천"},{"n":"후평숲속유치원","r":"춘천"},{"n":"후평중학교","r":"춘천"},{"n":"후평초등학교","r":"춘천"},{"n":"흥양초등학교","r":"원주"},{"n":"흥양초병설유치원","r":"원주"},{"n":"흥업초등학교","r":"원주"},{"n":"흥업초병설유치원","r":"원주"},{"n":"흥전초등학교","r":"삼척"}];

  const KNOWN_OFFICES = [
    "강원특별자치도교육청",
    "강원특별자치도교육청교육과학정보원",
    "강원특별자치도교육청교육연구원",
    "강원특별자치도교육청국제교육원",
    "강원특별자치도교육청국제교육원원주분원",
    "강원특별자치도교육청국제교육원진로교육원",
    "강원특별자치도교육청다문화교육센터",
    "강원특별자치도교육청미래교육연구원",
    "강원특별자치도교육청학생교육원",
    "강원특별자치도교육청학생교육원속초분원",
    "강원특별자치도교육청학생교육원영월분원",
    "강원특별자치도교육청유아교육원",
    "강원특별자치도교육청유아교육원남부분원",
    "강원특별자치도교육청유아교육원북부분원",
    "강원특별자치도교육청유아교육원서부분원",
    "강원특별자치도교육청진로교육원",
    "강원특별자치도교육청진로교육원원주분원",
    "강원특별자치도교육청직속기관",
    "강원특별자치도교육청홍보지원실",
    "강원특별자치도교육청감사관",
    "강원특별자치도교육청행정국",
    "강원특별자치도교육청정책국",
    "강원특별자치도교육청교육국",
    "강원특별자치도교육청교육과정과",
    "강원특별자치도교육청교원정책과",
    "강원특별자치도교육청인성생활교육과",
    "강원특별자치도교육청문화체육특기교육과",
    "강원특별자치도교육청민주시민교육과",
    "강원특별자치도교육청유초등교육과",
    "강원특별자치도교육청중등교육과",
    "강원특별자치도교육청미래교육지원과",
    "강원특별자치도교육청교육복지과",
    "강원특별자치도교육청시설과",
    "강원특별자치도교육청총무과",
    "강원특별자치도교육청예산과",
    "강원특별자치도교육청교육재정과",
    "강원특별자치도교육청교육법무담당관",
    "강원특별자치도교육청교육정보화과",
    "강원특별자치도교육청교육안전과",
    "강원특별자치도교육청학생지원과",
    "강원특별자치도교육청학교지원과",
    "춘천교육지원청","원주교육지원청","강릉교육지원청","동해교육지원청","태백교육지원청","속초양양교육지원청","삼척교육지원청",
    "홍천교육지원청","횡성교육지원청","영월교육지원청","평창교육지원청","정선교육지원청","철원교육지원청","화천교육지원청","양구교육지원청","인제교육지원청","고성교육지원청"
  ];

  const EDU_SUPPORT_OFFICES = [
    "춘천교육지원청","원주교육지원청","강릉교육지원청","동해교육지원청","태백교육지원청","속초양양교육지원청","삼척교육지원청",
    "홍천교육지원청","횡성교육지원청","영월교육지원청","평창교육지원청","정선교육지원청","철원교육지원청","화천교육지원청","양구교육지원청","인제교육지원청","고성교육지원청"
  ];

  /* =========================
     DOM Cache
  ========================= */
  const $ = (sel) => document.querySelector(sel);

  const el = {
    statusBadge: $("#statusBadge"),
    fileCount: $("#fileCount"),
    recordCount: $("#recordCount"),
    analysisBadge: $("#analysisBadge"),

    fileInput: $("#fileInput"),
    btnAddFiles: $("#btnAddFiles"),
    btnAnalyze: $("#btnAnalyze"),
    btnResetFiles: $("#btnResetFiles"),
    fileList: $("#fileList"),
    fileHint: $("#fileHint"),
    logBox: $("#logBox"),

    btnDownloadCurrent: $("#btnDownloadCurrent"),
    btnDownloadAggregates: $("#btnDownloadAggregates"),
    btnCopySummary: $("#btnCopySummary"),
    exportHint: $("#exportHint"),

    // KPI
    kpiFiles: $("#kpiFiles"),
    kpiRecords: $("#kpiRecords"),
    kpiSchoolHits: $("#kpiSchoolHits"),
    kpiOfficeHits: $("#kpiOfficeHits"),
    kpiUnknown: $("#kpiUnknown"),
    kpiLocalGov: $("#kpiLocalGov"),
    kpiEduWork: $("#kpiEduWork"),
    kpiTeacher: $("#kpiTeacher"),

    // Patch: name masking toggle
    maskNameToggle: $("#maskNameToggle"),

    // Entity filters
    entityKind: $("#entityKind"),
    entityName: $("#entityName"),
    personnelType: $("#personnelType"),
    jobFilter: $("#jobFilter"),
    // Patch: gov grade
    govGradeFilter: $("#govGradeFilter"),

    entityResultBadge: $("#entityResultBadge"),
    entityHint: $("#entityHint"),
    inCountBadge: $("#inCountBadge"),
    outCountBadge: $("#outCountBadge"),
    unkCountBadge: $("#unkCountBadge"),
    inTableBody: $("#inTable tbody"),
    outTableBody: $("#outTable tbody"),
    unkTableBody: $("#unkTable tbody"),

    // Region filters
    officeMode: $("#officeMode"),
    regionPick: $("#regionPick"),
    regionPersonnelType: $("#regionPersonnelType"),
    // Patch: region gov grade
    regionGovGradeFilter: $("#regionGovGradeFilter"),

    regionSearch: $("#regionSearch"),
    btnRegionSearchClear: $("#btnRegionSearchClear"),
    regionSearchHint: $("#regionSearchHint"),

    regionResultBadge: $("#regionResultBadge"),
    regionHint: $("#regionHint"),
    regionTableBody: $("#regionTable tbody")
  };

  /* =========================
     Utils
  ========================= */
  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function nowTs() {
    const dt = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    const dtStr = `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
    return dtStr;
  }

  function log(msg) {
    const line = `[${nowTs()}] ${msg}`;
    el.logBox.textContent = (el.logBox.textContent ? el.logBox.textContent + "\n" : "") + line;
    el.logBox.scrollTop = el.logBox.scrollHeight;
    // also console for dev
    console.log(line);
  }

  function setText(node, text) {
    if (!node) return;
    node.textContent = text;
  }

  function setHtml(node, html) {
    if (!node) return;
    node.innerHTML = html;
  }

  function setEnabled(node, enabled) {
    if (!node) return;
    node.disabled = !enabled;
  }

  function debounce(fn, wait) {
    let t = null;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  function normalizeText(s) {
    return String(s ?? "")
      .replaceAll(/\s+/g, "")
      .replaceAll("　", "")
      .trim();
  }

  // Patch 2: Name masking (2nd char -> *)
  function maskSecondChar(name) {
    const s = String(name ?? "");
    if (s.length < 2) return s;
    return s.slice(0, 1) + "*" + s.slice(2);
  }

  function isKoreanName(s) {
    const t = normalizeText(s);
    if (!t) return false;
    return /^[가-힣]{2,6}$/.test(t);
  }

  function isLikelyBirth(s) {
    const t = normalizeText(s);
    if (!t) return false;
    if (/^\d{6}$/.test(t)) return true; // 900101
    if (/^\d{8}$/.test(t)) return true; // 19900101
    if (/^\d{4}[-./]\d{1,2}[-./]\d{1,2}$/.test(t)) return true;
    return false;
  }

  function isLikelyPhone(s) {
    const t = String(s ?? "").replaceAll(/\s+/g, "");
    return /^01\d-?\d{3,4}-?\d{4}$/.test(t);
  }

  function stripBracketInfo(s) {
    // remove bracketed segments that can disturb matching
    let t = String(s ?? "");
    // Remove any (...) / [...] / {...} / <...> and common Korean brackets
    t = t.replace(/[\(\[\{\<（【〔［｛《][^\)\]\}\>）】〕］｝》]*[\)\]\}\>）】〕］｝》]/g, " ");
    t = t.replace(/[\(\)\[\]\{\}\<\>（【〕〕［］｛｝《》】]/g, " ");
    return t;
  }

  function isLocalGovByRank(text) {
    const t = normalizeText(stripBracketInfo(text));
    if (!t) return false;
    if (t.startsWith("지방")) return true;
    // 끝이 직급이면 지방으로 간주(우선)
    for (const end of GOV_GRADE_ENDINGS) {
      if (t.endsWith(end)) return true;
    }
    return false;
  }

  function localGovSeriesFromRank(text) {
    const raw = normalizeText(stripBracketInfo(text));
    if (!raw) return "";
    // Remove rank ending (서기보/주사보/...) if present to focus on series
    // but here we just try to find the best matching series
    for (const series of LOCAL_GOV_SERIES) {
      const s = normalizeText(series);
      if (raw.startsWith(s)) return series;
      if (raw.includes(s)) return series;
    }
    return "";
  }

  // Patch 1: gov grade extraction
  function extractGovGradeFromText(text) {
    if (!text) return "";
    const cleaned = stripBracketInfo(text);
    const parts = String(cleaned).split(/[\/／]/).map((p) => p.trim()).filter(Boolean);
    const delims = /[\s·•ㆍ・,，;；:：\-–—_]/g;

    for (const part of parts) {
      const compact = normalizeText(part).replace(delims, "").replaceAll(" ", "");
      if (!compact) continue;

      // scan for occurrences of '지방' inside compact
      let idx = compact.indexOf("지방");
      while (idx !== -1) {
        const sub = compact.slice(idx);
        for (const end of GOV_GRADE_ENDINGS) {
          if (sub.startsWith("지방") && sub.endsWith(end)) return end;
        }
        idx = compact.indexOf("지방", idx + 1);
      }
    }
    return "";
  }

  function detectGovGrade(rec) {
    const candidates = [rec.newRank, rec.curRank, rec.jobRaw];
    for (const c of candidates) {
      const g = extractGovGradeFromText(c);
      if (g) return g;
    }
    return "";
  }

  function detectPersonnelType(rec) {
    // retire has priority
    if (detectIsRetire(rec)) return "퇴직";

    const txt = [rec.newRank, rec.curRank, rec.jobRaw, rec.remark].filter(Boolean).join(" ");
    const t = normalizeText(txt);

    if (isLocalGovByRank(txt)) return "지방공무원";
    if (t.includes("교육공무직") || t.includes("공무직")) return "교육공무직";
    if (t.includes("기간제") || t.includes("시간강사") || t.includes("한시") || t.includes("강사")) return "기간제교원";

    // teacher-ish
    if (t.includes("교사") || t.includes("교감") || t.includes("교장") || t.includes("전문상담") || t.includes("보건") || t.includes("사서교사") || t.includes("영양")) return "정규교원";

    return "기타";
  }

  function detectIsRetire(rec) {
    const txt = [rec.newRank, rec.curRank, rec.jobRaw, rec.remark].filter(Boolean).join(" ");
    const t = normalizeText(txt);
    return t.includes("퇴직") || t.includes("정년") || t.includes("명예퇴직") || t.includes("의원면직") || t.includes("면직") || t.includes("해임");
  }

  function detectJobKey(rec) {
    const t = rec.personnelType;
    const txt = [rec.newRank, rec.curRank, rec.jobRaw].filter(Boolean).join(" ");
    const n = normalizeText(txt);

    if (t === "지방공무원") {
      return localGovSeriesFromRank(txt) || "기타";
    }
    if (t === "교육공무직") {
      if (n.includes("조리")) return "조리";
      if (n.includes("시설")) return "시설";
      if (n.includes("사서")) return "사서";
      if (n.includes("특수")) return "특수";
      return "기타";
    }
    if (t === "기간제교원") {
      return "기간제";
    }
    if (t === "정규교원") {
      if (n.includes("교장")) return "교장";
      if (n.includes("교감")) return "교감";
      if (n.includes("전문상담")) return "전문상담";
      if (n.includes("보건")) return "보건";
      if (n.includes("사서교사")) return "사서교사";
      if (n.includes("영양")) return "영양";
      return "교사";
    }
    if (t === "퇴직") return "퇴직";
    return "기타";
  }

  function normalizeRegionFromText(text) {
    const t = String(text ?? "");
    // direct hits in order
    if (t.includes("속초") || t.includes("양양")) return "속초양양";
    for (const r of REGION_LABELS) {
      if (r === "속초양양") continue;
      if (t.includes(r)) return r;
    }
    return "";
  }

  function summarizeOfficeName(full) {
    const t = normalizeText(full);
    if (!t) return "";
    // normalize common variants
    if (t === "강원도교육청") return "강원특별자치도교육청";
    if (t.startsWith("강원특별자치도교육청")) return "강원특별자치도교육청";
    return full;
  }

  /* =========================
     School/Office Master Index
  ========================= */
  function buildSchoolMasterIndex(rows) {
    const byFull = new Map();
    const byBase = new Map();

    for (const r of rows) {
      const full = r.n;
      const region = r.r;
      const base = full.replace(/\([^\)]*\)$/, "");

      byFull.set(full, { full, region, base });

      const arr = byBase.get(base) || [];
      arr.push({ full, region, base });
      byBase.set(base, arr);
    }

    const fullNamesSorted = [...byFull.keys()].sort((a, b) => b.length - a.length);
    const baseNamesSorted = [...byBase.keys()].sort((a, b) => b.length - a.length);

    return { byFull, byBase, fullNamesSorted, baseNamesSorted };
  }

  function buildOfficeMasterIndex(names) {
    const byFull = new Map();
    for (const n of names) {
      byFull.set(n, { full: n, base: summarizeOfficeName(n), region: normalizeRegionFromText(n) || (n.startsWith("강원특별자치도교육청") ? "춘천" : "") });
    }
    const fullNamesSorted = [...byFull.keys()].sort((a, b) => b.length - a.length);
    return { byFull, fullNamesSorted };
  }

  function parseSchoolNameFromAny(text) {
    const raw = String(text ?? "");
    if (!raw) return "";
    const t = normalizeText(stripBracketInfo(raw));
    if (!t) return "";

    // full match first
    for (const name of state.schoolMaster.fullNamesSorted) {
      const n = normalizeText(name);
      if (t.includes(n)) return name;
    }
    // base match
    for (const base of state.schoolMaster.baseNamesSorted) {
      const b = normalizeText(base);
      if (!b) continue;
      if (t.includes(b)) {
        const candidates = state.schoolMaster.byBase.get(base) || [];
        if (candidates.length === 1) return candidates[0].full;

        // try resolve by region from text
        const regionHint = normalizeRegionFromText(raw);
        if (regionHint) {
          const found = candidates.find((c) => c.region === regionHint);
          if (found) return found.full;
        }
        // fallback: first
        return candidates[0]?.full || "";
      }
    }
    return "";
  }

  function parseOfficeNameFromAny(text) {
    const raw = String(text ?? "");
    if (!raw) return "";
    const t = normalizeText(stripBracketInfo(raw));
    if (!t) return "";

    for (const name of state.officeMaster.fullNamesSorted) {
      const n = normalizeText(name);
      if (t.includes(n)) return name;
    }

    // also handle common abbreviations
    if (t.includes("도교육청") || t.includes("교육청")) return "강원특별자치도교육청";
    return "";
  }

  function schoolRegion(schoolName) {
    const item = state.schoolMaster.byFull.get(schoolName);
    return item ? item.region : "";
  }

  function officeRegion(officeName) {
    const item = state.officeMaster.byFull.get(officeName);
    return item ? item.region : "";
  }

  function supportOfficeByRegion(region) {
    if (!region) return "";
    const target = region + "교육지원청";
    // 속초양양 special
    if (region === "속초양양") return "속초양양교육지원청";
    return EDU_SUPPORT_OFFICES.find((o) => o === target) || "";
  }

  /* =========================
     Excel Parsing
  ========================= */
  function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("파일 읽기 실패"));
      fr.onload = () => resolve(fr.result);
      fr.readAsArrayBuffer(file);
    });
  }

  function parseWorkbookFromArrayBuffer(buf) {
    return XLSX.read(buf, { type: "array" });
  }

  function sheetToRows(ws) {
    return XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, raw: false });
  }

  function detectHeaderRow(rows) {
    // scan first 30 rows for header-like cells
    const maxScan = Math.min(rows.length, 30);
    for (let i = 0; i < maxScan; i++) {
      const row = rows[i] || [];
      const joined = row.map((c) => String(c ?? "")).join(" ");
      if (joined.includes("성명") && (joined.includes("현") || joined.includes("전") || joined.includes("발령"))) return i;
    }
    return 0;
  }

  function buildHeaderMap(headerRow) {
    const map = {};
    for (let ci = 0; ci < headerRow.length; ci++) {
      const h = String(headerRow[ci] ?? "").trim();
      if (!h) continue;
      map[h] = ci;
    }
    return map;
  }

  function findColIndex(map, candidates) {
    for (const c of candidates) {
      if (map[c] !== undefined) return map[c];
    }
    // fuzzy
    for (const key of Object.keys(map)) {
      for (const c of candidates) {
        if (key.includes(c)) return map[key];
      }
    }
    return -1;
  }

  function extractRecordsFromSheet({ fileName, sheetName, rows }) {
    const headerIdx = detectHeaderRow(rows);
    const headerRow = rows[headerIdx] || [];
    const headerMap = buildHeaderMap(headerRow);

    const colName = findColIndex(headerMap, ["성명", "이름"]);
    const colBirth = findColIndex(headerMap, ["생년월일", "생년", "주민", "주민등록번호"]);
    const colCur = findColIndex(headerMap, ["현근무지", "현 근무지", "현", "전입전", "발령전", "전근무지", "현기관"]);
    const colNew = findColIndex(headerMap, ["발령후", "발령 후", "발령", "전입후", "전보후", "신규", "발령기관"]);
    const colCurRank = findColIndex(headerMap, ["현직급", "현 직급", "현직", "전직급", "전 직급", "현직위"]);
    const colNewRank = findColIndex(headerMap, ["발령직급", "발령 직급", "발령직", "신규직급", "신규 직급", "발령직위"]);
    const colJob = findColIndex(headerMap, ["직렬", "직종", "직급", "직위", "직명", "직", "담당"]);
    const colRemark = findColIndex(headerMap, ["비고", "특이", "내용", "발령내용"]);

    const startRow = headerIdx + 1;
    const out = [];

    for (let ri = startRow; ri < rows.length; ri++) {
      const row = rows[ri] || [];
      const nameCell = colName >= 0 ? row[colName] : "";
      if (!isKoreanName(nameCell)) continue;

      const rec = {
        id: `${fileName}::${sheetName}::${ri + 1}`,
        fileName,
        sheetName,
        rowNo: ri + 1,
        name: normalizeText(nameCell),
        birth: colBirth >= 0 ? String(row[colBirth] ?? "").trim() : "",
        curPlaceRaw: colCur >= 0 ? String(row[colCur] ?? "").trim() : "",
        newPlaceRaw: colNew >= 0 ? String(row[colNew] ?? "").trim() : "",
        curRank: colCurRank >= 0 ? String(row[colCurRank] ?? "").trim() : "",
        newRank: colNewRank >= 0 ? String(row[colNewRank] ?? "").trim() : "",
        jobRaw: colJob >= 0 ? String(row[colJob] ?? "").trim() : "",
        remark: colRemark >= 0 ? String(row[colRemark] ?? "").trim() : ""
      };

      // some sheets may split fields across multiple cols; attempt to enrich if empty
      if (!rec.curRank && rec.jobRaw && isLocalGovByRank(rec.jobRaw)) rec.curRank = rec.jobRaw;

      // classify
      rec.personnelType = detectPersonnelType(rec);
      // Patch 1: gov grade computed after personnelType
      rec.govGrade = detectGovGrade(rec);
      rec.isRetire = rec.personnelType === "퇴직";
      rec.jobKey = detectJobKey(rec);

      // match school/office
      rec.curSchool = parseSchoolNameFromAny(rec.curPlaceRaw);
      rec.newSchool = parseSchoolNameFromAny(rec.newPlaceRaw);
      rec.curOffice = parseOfficeNameFromAny(rec.curPlaceRaw);
      rec.newOffice = parseOfficeNameFromAny(rec.newPlaceRaw);

      // derive region: prefer new destination (school > office), fallback to current
      rec.region = "";
      if (rec.newSchool) rec.region = schoolRegion(rec.newSchool);
      else if (rec.newOffice) rec.region = officeRegion(rec.newOffice) || normalizeRegionFromText(rec.newPlaceRaw);
      else if (rec.curSchool) rec.region = schoolRegion(rec.curSchool);
      else if (rec.curOffice) rec.region = officeRegion(rec.curOffice) || normalizeRegionFromText(rec.curPlaceRaw);
      else rec.region = normalizeRegionFromText(rec.curPlaceRaw + " " + rec.newPlaceRaw);

      out.push(rec);
    }

    return out;
  }

  /* =========================
     Stats & Rendering
  ========================= */
  function computeStats(records) {
    const byType = {};
    const byRegion = {};
    let schoolHits = 0;
    let officeHits = 0;
    let unknownHits = 0;

    for (const r of records) {
      byType[r.personnelType] = (byType[r.personnelType] || 0) + 1;
      const reg = r.region || "미분류";
      byRegion[reg] = (byRegion[reg] || 0) + 1;

      if (r.newSchool || r.curSchool) schoolHits++;
      if (r.newOffice || r.curOffice) officeHits++;
      if (!r.newSchool && !r.curSchool && !r.newOffice && !r.curOffice) unknownHits++;
    }

    return { total: records.length, byType, byRegion, schoolHits, officeHits, unknownHits };
  }

  function updateBadges() {
    setText(el.fileCount, String(state.files.length));
    setText(el.recordCount, String(state.recordsNormalized.length));

    if (state.recordsNormalized.length > 0) {
      el.statusBadge.classList.remove("warn");
      el.statusBadge.classList.add("ok");
      setText(el.statusBadge, "준비");
      el.analysisBadge.classList.remove("warn");
      el.analysisBadge.classList.add("ok");
      setText(el.analysisBadge, "완료");
    } else {
      el.statusBadge.classList.remove("ok");
      el.statusBadge.classList.add("warn");
      setText(el.statusBadge, "대기");
      el.analysisBadge.classList.remove("ok");
      el.analysisBadge.classList.add("warn");
      setText(el.analysisBadge, "미실행");
    }
  }

  function renderSummary() {
    setText(el.kpiFiles, String(state.files.length));
    setText(el.kpiRecords, String(state.stats.total || 0));
    setText(el.kpiSchoolHits, String(state.stats.schoolHits || 0));
    setText(el.kpiOfficeHits, String(state.stats.officeHits || 0));
    setText(el.kpiUnknown, String(state.stats.unknownHits || 0));
    setText(el.kpiLocalGov, String(state.stats.byType["지방공무원"] || 0));
    setText(el.kpiEduWork, String(state.stats.byType["교육공무직"] || 0));
    const teacherSum = (state.stats.byType["정규교원"] || 0) + (state.stats.byType["기간제교원"] || 0);
    setText(el.kpiTeacher, String(teacherSum));
  }

  function renderFileList() {
    if (state.files.length === 0) {
      setHtml(el.fileList, "<li class='muted'>선택된 파일이 없습니다.</li>");
      return;
    }
    const items = state.files.map((f, idx) => `<li>${idx + 1}. ${escapeHtml(f.name)} <span class="muted">(${formatBytes(f.size)})</span></li>`).join("");
    setHtml(el.fileList, items);
  }

  function formatBytes(bytes) {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const v = bytes / Math.pow(k, i);
    return `${v.toFixed(i === 0 ? 0 : 1)} ${sizes[i]}`;
  }

  function updateAnalyzeBtn() {
    const ok = state.files.length > 0 && state.xlsxReady;
    setEnabled(el.btnAnalyze, ok);
    setEnabled(el.btnResetFiles, state.files.length > 0);
  }

  function lockFilters(lock) {
    // entity
    el.entityKind.disabled = lock;
    el.entityName.disabled = lock || !el.entityKind.value;
    el.personnelType.disabled = lock || !el.entityName.value;
    el.jobFilter.disabled = lock || !el.entityName.value;
    // Patch: gov grade
    el.govGradeFilter.disabled = lock || !el.entityName.value;

    // region
    el.officeMode.disabled = lock;
    el.regionPick.disabled = lock || !el.officeMode.value;
    el.regionPersonnelType.disabled = lock || !el.officeMode.value;
    // Patch
    el.regionGovGradeFilter.disabled = lock || !el.officeMode.value;
    el.regionSearch.disabled = lock || !el.officeMode.value;
    el.btnRegionSearchClear.disabled = lock || !el.officeMode.value;

    // exports
    el.btnDownloadCurrent.disabled = lock || state.recordsNormalized.length === 0;
    el.btnDownloadAggregates.disabled = lock || state.recordsNormalized.length === 0;
    el.btnCopySummary.disabled = lock || state.recordsNormalized.length === 0;
  }

  function resetViews() {
    // summary
    state.currentExport = { title: "", rows: [] };
    setText(el.exportHint, "분석 후 활성화");

    // entity
    setText(el.entityResultBadge, "-");
    setText(el.inCountBadge, "0");
    setText(el.outCountBadge, "0");
    setText(el.unkCountBadge, "0");
    setHtml(el.inTableBody, "");
    setHtml(el.outTableBody, "");
    setHtml(el.unkTableBody, "");
    setText(el.entityHint, "필터를 선택하면 결과가 표시됩니다.");

    // region
    setText(el.regionResultBadge, "-");
    setHtml(el.regionTableBody, "");
    setText(el.regionHint, "필터를 선택하면 결과가 표시됩니다.");
    setText(el.regionSearchHint, "");
    if (el.regionSearch) el.regionSearch.value = "";
  }

  /* =========================
     Filter option builders
  ========================= */
  function setSelectOptions(selectEl, options, placeholderText = "선택") {
    if (!selectEl) return;
    const opts = [`<option value="">${escapeHtml(placeholderText)}</option>`]
      .concat(options.map((o) => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`));
    selectEl.innerHTML = opts.join("");
  }

  function setGovGradeOptions(selectEl) {
    if (!selectEl) return;
    const opts = ["전체", ...GOV_GRADE_ENDINGS].map((o) => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`);
    selectEl.innerHTML = opts.join("");
  }

  function buildEntityNameOptions(kind) {
    if (kind === "school") {
      // use master list
      return GW_SCHOOL_MASTER_ROWS.map((r) => r.n);
    }
    if (kind === "office") {
      // show known offices (short list: unique)
      return [...new Set(KNOWN_OFFICES)];
    }
    return [];
  }

  function buildJobOptions(personnelType) {
    if (personnelType === "지방공무원") return ["전체", ...LOCAL_GOV_SERIES];
    if (personnelType === "교육공무직") return ["전체", "조리", "시설", "사서", "특수", "기타"];
    if (personnelType === "정규교원") return ["전체", "교사", "교감", "교장", "전문상담", "보건", "사서교사", "영양"];
    if (personnelType === "기간제교원") return ["전체", "기간제", "강사", "시간강사"];
    if (personnelType === "퇴직") return ["전체", "퇴직"];
    return ["전체", "기타"];
  }

  function initEntityFilters() {
    // Personnel type options
    setSelectOptions(el.personnelType, PERSONNEL_TYPE_OPTIONS.filter((x) => x !== ""), "전체");
    el.personnelType.value = "전체";

    // job filter options based on personnel
    setSelectOptions(el.jobFilter, buildJobOptions("전체"), "전체");
    el.jobFilter.value = "전체";

    // Patch: gov grade options
    setGovGradeOptions(el.govGradeFilter);
    el.govGradeFilter.value = "전체";
    el.govGradeFilter.disabled = true;

    el.personnelType.disabled = !el.entityName.value;
    el.jobFilter.disabled = !el.entityName.value;

    renderEntityView();
  }

  function initRegionFilters() {
    setSelectOptions(el.regionPick, REGION_LABELS, "선택");
    el.regionPick.value = "";

    setSelectOptions(el.regionPersonnelType, PERSONNEL_TYPE_OPTIONS, "전체");
    el.regionPersonnelType.value = "전체";

    // Patch: region gov grade options
    setGovGradeOptions(el.regionGovGradeFilter);
    el.regionGovGradeFilter.value = "전체";
    el.regionGovGradeFilter.disabled = true;

    el.regionSearch.disabled = true;
    el.btnRegionSearchClear.disabled = true;
    if (el.regionSearch) el.regionSearch.value = "";
    setText(el.regionSearchHint, "");
  }

  /* =========================
     Rendering: tables
  ========================= */
  function renderRecordsTable(tbody, rows, showRegionCol) {
    if (!tbody) return;
    if (!rows || rows.length === 0) {
      tbody.innerHTML = "<tr><td class='muted' colspan='" + (showRegionCol ? 6 : 5) + "'>결과가 없습니다.</td></tr>";
      return;
    }

    const sorted = [...rows].sort((a, b) => a.name.localeCompare(b.name, "ko"));

    tbody.innerHTML = sorted.map((r) => {
      const shownName = state.maskNames ? maskSecondChar(r.name) : r.name;
      const name = escapeHtml(shownName);
      const cur = escapeHtml(r.curPlaceRaw || r.curSchool || r.curOffice || "-");
      const neo = escapeHtml(r.newPlaceRaw || r.newSchool || r.newOffice || "-");
      const type = escapeHtml(r.personnelType || "-");
      const file = escapeHtml(r.fileName || "-");
      const region = escapeHtml(r.region || "-");

      if (showRegionCol) {
        return `<tr>
          <td>${name}</td>
          <td>${cur}</td>
          <td>${neo}</td>
          <td>${type}</td>
          <td>${region}</td>
          <td>${file}</td>
        </tr>`;
      }

      return `<tr>
        <td>${name}</td>
        <td>${cur}</td>
        <td>${neo}</td>
        <td>${type}</td>
        <td>${file}</td>
      </tr>`;
    }).join("");
  }

  function filterByPersonnelAndJob(rec, personnelType, jobFilter, govGradeFilterVal) {
    if (personnelType && personnelType !== "전체" && rec.personnelType !== personnelType) return false;
    if (jobFilter && jobFilter !== "전체") {
      // local gov uses series, others use jobKey
      if (rec.personnelType === "지방공무원") {
        if (rec.jobKey !== jobFilter) return false;
      } else {
        if (rec.jobKey !== jobFilter) return false;
      }
    }
    // Patch 1: gov grade filter (only when personnelType is 지방공무원)
    if (personnelType === "지방공무원" && govGradeFilterVal && govGradeFilterVal !== "전체") {
      if (rec.personnelType !== "지방공무원") return false;
      if (rec.govGrade !== govGradeFilterVal) return false;
    }
    return true;
  }

  function renderEntityView() {
    const kind = el.entityKind.value;
    const name = el.entityName.value;
    if (!kind || !name) return;

    state.lastView = "entity";

    const personnelType = el.personnelType.value || "전체";
    const jobFilter = el.jobFilter.value || "전체";
    const govGradeVal = el.govGradeFilter.disabled ? "전체" : (el.govGradeFilter.value || "전체");

    // base filter: entity match
    const base = state.recordsNormalized.filter((r) => {
      if (kind === "school") {
        return r.curSchool === name || r.newSchool === name || normalizeText(r.curPlaceRaw).includes(normalizeText(name)) || normalizeText(r.newPlaceRaw).includes(normalizeText(name));
      }
      // office
      return r.curOffice === name || r.newOffice === name || normalizeText(r.curPlaceRaw).includes(normalizeText(name)) || normalizeText(r.newPlaceRaw).includes(normalizeText(name));
    });

    // classify direction
    const inList = [];
    const outList = [];
    const unkList = [];

    for (const r of base) {
      const curHit = (kind === "school") ? (r.curSchool === name) : (r.curOffice === name);
      const newHit = (kind === "school") ? (r.newSchool === name) : (r.newOffice === name);

      if (newHit && !curHit) inList.push(r);
      else if (curHit && !newHit) outList.push(r);
      else unkList.push(r);
    }

    const inFiltered = inList.filter((r) => filterByPersonnelAndJob(r, personnelType, jobFilter, govGradeVal));
    const outFiltered = outList.filter((r) => filterByPersonnelAndJob(r, personnelType, jobFilter, govGradeVal));
    const unkFiltered = unkList.filter((r) => filterByPersonnelAndJob(r, personnelType, jobFilter, govGradeVal));

    setText(el.inCountBadge, String(inFiltered.length));
    setText(el.outCountBadge, String(outFiltered.length));
    setText(el.unkCountBadge, String(unkFiltered.length));

    renderRecordsTable(el.inTableBody, inFiltered, false);
    renderRecordsTable(el.outTableBody, outFiltered, false);
    renderRecordsTable(el.unkTableBody, unkFiltered, false);

    const total = inFiltered.length + outFiltered.length + unkFiltered.length;

    const gradePart = (personnelType === "지방공무원") ? ` / 직급:${govGradeVal}` : "";
    setText(el.entityResultBadge, `${kind === "school" ? "학교" : "기관"}: ${name} / ${personnelType} / ${jobFilter}${gradePart} / ${total}건`);
    setText(el.entityHint, total ? "표 하단 버튼으로 현재 명단을 다운로드할 수 있어요." : "조건에 맞는 결과가 없습니다.");

    // enable grade filter only when 지방공무원 selected
    if (personnelType === "지방공무원") {
      el.govGradeFilter.disabled = false;
      if (!el.govGradeFilter.value) el.govGradeFilter.value = "전체";
    } else {
      el.govGradeFilter.disabled = true;
      el.govGradeFilter.value = "전체";
    }

    // current export (combined)
    const exportRows = [...inFiltered, ...outFiltered, ...unkFiltered];
    const title = `섹션3 조회 결과 (${kind === "school" ? "학교" : "기관"} / ${name} / ${personnelType} / ${jobFilter}${gradePart})`;
    state.currentExport = { title, rows: exportRows };
    setText(el.exportHint, title);
  }

  function renderRegionView() {
    const mode = el.officeMode.value;
    const region = el.regionPick.value;
    if (!mode || !region) return;

    state.lastView = "region";

    const personnelType = el.regionPersonnelType.value || "전체";
    const govGradeVal = el.regionGovGradeFilter.disabled ? "전체" : (el.regionGovGradeFilter.value || "전체");
    const keyword = String(el.regionSearch?.value ?? "").trim();

    let filtered = state.recordsNormalized.filter((r) => {
      // region condition
      const reg = r.region || "";
      if (reg !== region) return false;

      // scope condition by mode
      if (mode === "school") {
        // any school involvement in region
        return (r.curSchool && schoolRegion(r.curSchool) === region) || (r.newSchool && schoolRegion(r.newSchool) === region) || reg === region;
      }
      if (mode === "eduOffice") {
        const office = supportOfficeByRegion(region);
        return r.curOffice === office || r.newOffice === office || normalizeText(r.curPlaceRaw).includes(normalizeText(office)) || normalizeText(r.newPlaceRaw).includes(normalizeText(office));
      }
      if (mode === "hq") {
        // 본청: 교육청 계열
        const hit = (r.curOffice && r.curOffice.startsWith("강원특별자치도교육청")) || (r.newOffice && r.newOffice.startsWith("강원특별자치도교육청")) ||
          normalizeText(r.curPlaceRaw).includes("강원특별자치도교육청") || normalizeText(r.newPlaceRaw).includes("강원특별자치도교육청");
        return hit;
      }
      if (mode === "direct") {
        // 직속기관: known office list excluding 본청/지원청
        const cur = r.curOffice || "";
        const neo = r.newOffice || "";
        const isSupport = (o) => EDU_SUPPORT_OFFICES.includes(o);
        const isHQ = (o) => o.startsWith("강원특별자치도교육청") && !isSupport(o);
        const hitCur = cur && KNOWN_OFFICES.includes(cur) && !isSupport(cur) && !isHQ(cur);
        const hitNew = neo && KNOWN_OFFICES.includes(neo) && !isSupport(neo) && !isHQ(neo);
        return hitCur || hitNew;
      }
      return false;
    });

    // personnel & grade
    filtered = filtered.filter((r) => {
      if (personnelType !== "전체" && r.personnelType !== personnelType) return false;
      if (personnelType === "지방공무원" && govGradeVal !== "전체") {
        if (r.personnelType !== "지방공무원") return false;
        if (r.govGrade !== govGradeVal) return false;
      }
      return true;
    });

    // keyword search
    if (keyword) {
      const kw = normalizeText(keyword);
      filtered = filtered.filter((r) => {
        const hay = normalizeText([r.name, r.curPlaceRaw, r.newPlaceRaw, r.curRank, r.newRank, r.jobRaw, r.remark].join(" "));
        return hay.includes(kw);
      });
      setText(el.regionSearchHint, `검색어: "${keyword}"`);
    } else {
      setText(el.regionSearchHint, "");
    }

    renderRecordsTable(el.regionTableBody, filtered, true);

    const gradePart = (personnelType === "지방공무원") ? ` / 직급:${govGradeVal}` : "";
    const title = `섹션4 조회 결과 (${mode} / ${region} / ${personnelType}${gradePart})`;
    setText(el.regionResultBadge, `${region} / ${mode} / ${personnelType}${gradePart} / ${filtered.length}건`);
    setText(el.regionHint, filtered.length ? "표 하단 버튼으로 현재 명단을 다운로드할 수 있어요." : "조건에 맞는 결과가 없습니다.");

    // enable grade filter only when 지방공무원 selected
    if (personnelType === "지방공무원") {
      el.regionGovGradeFilter.disabled = false;
      if (!el.regionGovGradeFilter.value) el.regionGovGradeFilter.value = "전체";
    } else {
      el.regionGovGradeFilter.disabled = true;
      el.regionGovGradeFilter.value = "전체";
    }

    state.currentExport = { title, rows: filtered };
    setText(el.exportHint, title);
  }

  /* =========================
     Download
  ========================= */
  function toExportRow(r) {
    // NOTE: export uses ORIGINAL name (no masking)
    return {
      "성명": r.name,
      "인사구분": r.personnelType,
      "지방직급": r.govGrade || "",
      "현(이전)": r.curPlaceRaw || r.curSchool || r.curOffice || "",
      "발령(신규)": r.newPlaceRaw || r.newSchool || r.newOffice || "",
      "현직급": r.curRank || "",
      "발령직급": r.newRank || "",
      "직렬/직종": r.jobRaw || "",
      "비고": r.remark || "",
      "지역": r.region || "",
      "파일": r.fileName || "",
      "시트": r.sheetName || "",
      "행": r.rowNo || ""
    };
  }

  function downloadWorkbookFromRows(rows, filenameBase) {
    if (!rows || rows.length === 0) {
      alert("내보낼 데이터가 없습니다.");
      return;
    }
    const safe = String(filenameBase || "export").replace(/[\\/:*?"<>|]/g, "_");
    const filename = safe.endsWith(".xlsx") ? safe : safe + ".xlsx";

    const data = rows.map(toExportRow);
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "data");
    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }), filename);
  }

  function downloadCurrent() {
    if (!state.currentExport.rows || state.currentExport.rows.length === 0) {
      alert("먼저 조회 결과를 만든 뒤 다운로드하세요.");
      return;
    }
    downloadWorkbookFromRows(state.currentExport.rows, state.currentExport.title || "현재명단");
  }

  function downloadAllAggregates() {
    const wb = XLSX.utils.book_new();

    // sheet 1: byType
    const byTypeRows = Object.entries(state.stats.byType || {}).map(([k, v]) => ({ "구분": k, "건수": v }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byTypeRows), "인사구분별");

    // sheet 2: byRegion
    const byRegionRows = Object.entries(state.stats.byRegion || {}).map(([k, v]) => ({ "지역": k, "건수": v }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byRegionRows), "지역별");

    // sheet 3: raw export (optional)
    const allRows = state.recordsNormalized.map(toExportRow);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allRows), "전체명단");

    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }), "전체통계_집계.xlsx");
  }

  async function copySummaryToClipboard() {
    const lines = [];
    lines.push(`파일: ${state.files.length}개`);
    lines.push(`레코드: ${state.stats.total}건`);
    lines.push(`학교 매칭: ${state.stats.schoolHits}건`);
    lines.push(`기관 매칭: ${state.stats.officeHits}건`);
    lines.push(`미분류: ${state.stats.unknownHits}건`);
    lines.push("");
    lines.push("[인사구분별]");
    for (const [k, v] of Object.entries(state.stats.byType || {})) {
      lines.push(`- ${k}: ${v}`);
    }
    lines.push("");
    lines.push("[지역별]");
    for (const [k, v] of Object.entries(state.stats.byRegion || {})) {
      lines.push(`- ${k}: ${v}`);
    }
    const text = lines.join("\n");
    try {
      await navigator.clipboard.writeText(text);
      alert("요약을 클립보드에 복사했습니다.");
    } catch (e) {
      console.error(e);
      prompt("복사에 실패했어요. 아래 텍스트를 수동으로 복사하세요:", text);
    }
  }

  /* =========================
     Main analysis
  ========================= */
  async function analyzeAllFiles() {
    if (!state.xlsxReady) {
      alert("XLSX 라이브러리 로딩이 완료되지 않았습니다.");
      return;
    }
    if (!state.files.length) {
      alert("파일을 추가하세요.");
      return;
    }

    el.btnAnalyze.disabled = true;
    el.btnAddFiles.disabled = true;
    el.btnResetFiles.disabled = true;
    lockFilters(true);

    setText(el.statusBadge, "분석중");
    el.statusBadge.classList.remove("ok");
    el.statusBadge.classList.add("warn");
    log(`분석 시작: ${state.files.length}개 파일`);

    try {
      // build masters
      state.schoolMaster = buildSchoolMasterIndex(GW_SCHOOL_MASTER_ROWS);
      state.officeMaster = buildOfficeMasterIndex(KNOWN_OFFICES);

      const all = [];
      for (const file of state.files) {
        log(`읽는 중: ${file.name}`);
        const buf = await readFileAsArrayBuffer(file);
        const wb = parseWorkbookFromArrayBuffer(buf);
        const sheetNames = wb.SheetNames || [];
        for (const sn of sheetNames) {
          const ws = wb.Sheets[sn];
          if (!ws) continue;
          const rows = sheetToRows(ws);
          if (!rows || rows.length === 0) continue;
          const recs = extractRecordsFromSheet({ fileName: file.name, sheetName: sn, rows });
          if (recs.length) {
            log(`- ${sn}: ${recs.length}건`);
            all.push(...recs);
          }
        }
      }

      state.recordsRaw = all;
      state.recordsNormalized = all; // already normalized in extraction
      state.stats = computeStats(state.recordsNormalized);

      log(`분석 완료: ${state.recordsNormalized.length}건`);
      updateBadges();
      renderSummary();
      resetViews();

      // unlock filters
      lockFilters(false);
      initEntityFilters();
      initRegionFilters();

      // enable exports/buttons
      el.btnDownloadCurrent.disabled = false;
      el.btnDownloadAggregates.disabled = false;
      el.btnCopySummary.disabled = false;
      el.btnResetFiles.disabled = false;
      el.btnAddFiles.disabled = false;

      setText(el.statusBadge, "완료");
      el.statusBadge.classList.remove("warn");
      el.statusBadge.classList.add("ok");

    } catch (err) {
      console.error(err);
      log("오류: " + (err?.message || err));
      alert("분석 중 오류가 발생했습니다: " + (err?.message || err));
    } finally {
      el.btnAnalyze.disabled = false;
      updateAnalyzeBtn();
    }
  }

  function resetFiles() {
    state.files = [];
    state.recordsRaw = [];
    state.recordsNormalized = [];
    state.currentExport = { title: "", rows: [] };
    state.stats = { total: 0, byType: {}, byRegion: {}, schoolHits: 0, officeHits: 0, unknownHits: 0 };
    state.schoolMaster = null;
    state.officeMaster = null;

    if (el.fileInput) el.fileInput.value = "";
    renderFileList();
    renderSummary();
    resetViews();
    updateBadges();

    // reset selects
    el.entityKind.value = "";
    el.entityName.innerHTML = "<option value=''>먼저 1) 조회 구분을 선택하세요</option>";
    el.entityName.disabled = true;
    el.personnelType.disabled = true;
    el.jobFilter.disabled = true;
    el.govGradeFilter.disabled = true;
    el.govGradeFilter.value = "전체";

    el.officeMode.value = "";
    el.regionPick.innerHTML = "<option value=''>선택</option>";
    el.regionPick.disabled = true;
    el.regionPersonnelType.disabled = true;
    el.regionGovGradeFilter.disabled = true;
    el.regionGovGradeFilter.value = "전체";
    el.regionSearch.disabled = true;
    el.btnRegionSearchClear.disabled = true;

    el.btnDownloadCurrent.disabled = true;
    el.btnDownloadAggregates.disabled = true;
    el.btnCopySummary.disabled = true;

    setText(el.statusBadge, "대기");
    el.statusBadge.classList.remove("ok");
    el.statusBadge.classList.add("warn");
    setText(el.analysisBadge, "미실행");
    el.analysisBadge.classList.remove("ok");
    el.analysisBadge.classList.add("warn");

    updateAnalyzeBtn();
    log("초기화 완료");
  }

  /* =========================
     Events
  ========================= */
  function initUploadUI() {
    // XLSX ready check
    state.xlsxReady = !!window.XLSX;
    if (!state.xlsxReady) {
      log("XLSX 라이브러리를 찾을 수 없습니다.");
      setText(el.fileHint, "XLSX 로딩 실패");
      setEnabled(el.btnAnalyze, false);
      return;
    }

    // file add: use file input
    el.btnAddFiles.addEventListener("click", () => {
      el.fileInput.click();
    });

    el.fileInput.addEventListener("change", () => {
      const files = Array.from(el.fileInput.files || []);
      if (!files.length) return;
      // append new files, avoid duplicates by name+size
      const existing = new Set(state.files.map((f) => `${f.name}::${f.size}`));
      let added = 0;
      for (const f of files) {
        const key = `${f.name}::${f.size}`;
        if (existing.has(key)) continue;
        state.files.push(f);
        existing.add(key);
        added++;
      }
      log(`파일 추가: ${added}개 (총 ${state.files.length}개)`);
      renderFileList();
      updateAnalyzeBtn();
      updateBadges();
    });

    el.btnAnalyze.addEventListener("click", analyzeAllFiles);
    el.btnResetFiles.addEventListener("click", resetFiles);

    // Patch 2: name masking toggle
    if (el.maskNameToggle) {
      el.maskNameToggle.checked = state.maskNames;
      el.maskNameToggle.addEventListener("change", () => {
        state.maskNames = !!el.maskNameToggle.checked;
        // refresh current view without breaking export context
        const last = state.lastView;
        if (last === "region") {
          renderEntityView();
          renderRegionView();
        } else {
          renderRegionView();
          renderEntityView();
        }
      });
    }
  }

  function initDownloadUI() {
    el.btnDownloadCurrent.addEventListener("click", downloadCurrent);
    el.btnDownloadAggregates.addEventListener("click", downloadAllAggregates);
    el.btnCopySummary.addEventListener("click", copySummaryToClipboard);
  }

  function initEntityUI() {
    // Kind change
    el.entityKind.addEventListener("change", () => {
      const kind = el.entityKind.value;
      if (!kind) {
        el.entityName.disabled = true;
        el.entityName.innerHTML = "<option value=''>먼저 1) 조회 구분을 선택하세요</option>";
        el.personnelType.disabled = true;
        el.jobFilter.disabled = true;
        el.govGradeFilter.disabled = true;
        return;
      }

      const opts = buildEntityNameOptions(kind);
      setSelectOptions(el.entityName, opts, "선택");
      el.entityName.disabled = false;

      el.personnelType.value = "전체";
      el.jobFilter.value = "전체";
      el.govGradeFilter.value = "전체";
      el.govGradeFilter.disabled = true;

      el.personnelType.disabled = true;
      el.jobFilter.disabled = true;

      renderEntityView();
    });

    el.entityName.addEventListener("change", () => {
      const has = !!el.entityName.value;
      el.personnelType.disabled = !has;
      el.jobFilter.disabled = !has;

      // reset filters
      el.personnelType.value = "전체";
      setSelectOptions(el.jobFilter, buildJobOptions("전체"), "전체");
      el.jobFilter.value = "전체";

      el.govGradeFilter.value = "전체";
      el.govGradeFilter.disabled = true;

      renderEntityView();
    });

    el.personnelType.addEventListener("change", () => {
      const t = el.personnelType.value || "전체";
      // job options
      setSelectOptions(el.jobFilter, buildJobOptions(t), "전체");
      el.jobFilter.value = "전체";

      // Patch 1: enable/disable grade
      if (t === "지방공무원") {
        el.govGradeFilter.disabled = false;
        if (!el.govGradeFilter.value) el.govGradeFilter.value = "전체";
      } else {
        el.govGradeFilter.disabled = true;
        el.govGradeFilter.value = "전체";
      }

      renderEntityView();
    });

    el.jobFilter.addEventListener("change", renderEntityView);
    // Patch 1
    el.govGradeFilter.addEventListener("change", renderEntityView);
  }

  function initRegionUI() {
    el.officeMode.addEventListener("change", () => {
      const mode = el.officeMode.value;
      const enable = !!mode;
      el.regionPick.disabled = !enable;
      el.regionPersonnelType.disabled = !enable;
      el.regionSearch.disabled = !enable;
      el.btnRegionSearchClear.disabled = !enable;

      // reset values
      el.regionPick.value = "";
      el.regionPersonnelType.value = "전체";
      el.regionGovGradeFilter.value = "전체";
      el.regionGovGradeFilter.disabled = true;

      if (el.regionSearch) el.regionSearch.value = "";
      setText(el.regionSearchHint, "");
      renderRegionView();
    });

    el.regionPick.addEventListener("change", renderRegionView);

    el.regionPersonnelType.addEventListener("change", () => {
      const t = el.regionPersonnelType.value || "전체";
      if (t === "지방공무원") {
        el.regionGovGradeFilter.disabled = false;
        if (!el.regionGovGradeFilter.value) el.regionGovGradeFilter.value = "전체";
      } else {
        el.regionGovGradeFilter.disabled = true;
        el.regionGovGradeFilter.value = "전체";
      }
      renderRegionView();
    });

    el.regionGovGradeFilter.addEventListener("change", renderRegionView);

    el.regionSearch.addEventListener("input", debounce(renderRegionView, 120));
    el.btnRegionSearchClear.addEventListener("click", () => {
      if (el.regionSearch) el.regionSearch.value = "";
      renderRegionView();
      el.regionSearch.focus();
    });
  }

  function init() {
    // prebuild masters for select lists only
    state.schoolMaster = buildSchoolMasterIndex(GW_SCHOOL_MASTER_ROWS);
    state.officeMaster = buildOfficeMasterIndex(KNOWN_OFFICES);

    // init selects
    setSelectOptions(el.personnelType, PERSONNEL_TYPE_OPTIONS, "전체");
    setSelectOptions(el.jobFilter, buildJobOptions("전체"), "전체");
    setGovGradeOptions(el.govGradeFilter);
    el.govGradeFilter.value = "전체";
    el.govGradeFilter.disabled = true;

    setSelectOptions(el.regionPick, REGION_LABELS, "선택");
    setSelectOptions(el.regionPersonnelType, PERSONNEL_TYPE_OPTIONS, "전체");
    setGovGradeOptions(el.regionGovGradeFilter);
    el.regionGovGradeFilter.value = "전체";
    el.regionGovGradeFilter.disabled = true;

    // lock until analysis
    lockFilters(false);
    el.officeMode.disabled = false;
    el.regionPick.disabled = true;
    el.regionPersonnelType.disabled = true;
    el.regionGovGradeFilter.disabled = true;
    el.regionSearch.disabled = true;
    el.btnRegionSearchClear.disabled = true;

    initUploadUI();
    initDownloadUI();
    initEntityUI();
    initRegionUI();

    renderFileList();
    renderSummary();
    updateBadges();
    updateAnalyzeBtn();

    log("준비 완료");
  }

  init();
})();
</script>
</body>
</html>
