<!doctype html>

<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>강원특별자치도교육청 인사발령자료 집계 분석기</title>

<link rel="icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />


<style>

  .step-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0 0 10px;
  }
  .step-badge {
    width: 26px;
    height: 26px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 0.95rem;
    color: #fff;
    background: #111;
    flex: 0 0 auto;
  }

  .dropzone {
    margin-top: 12px;
    border: 2px dashed #d4d4d8;
    border-radius: 14px;
    padding: 16px;
    background: #fafafa;
  }
  .dropzone.dragover {
    background: #eef2ff;
    border-color: #818cf8;
  }

  .file-list-wrap {
    margin-top: 12px;
    max-height: 240px;
    overflow: auto;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #fff;
  }
  .file-list-wrap table {
    width: 100%;
    min-width: 720px;
    border-collapse: collapse;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background: #f9fafb;
    font-weight: 800;
    font-size: 0.95rem;
    color: #111;
  }
  .badge.ok {
    background: #ecfdf5;
    border-color: #10b981;
    color: #065f46;
  }
  .badge.warn {
    background: #fff7ed;
    border-color: #fb923c;
    color: #9a3412;
  }

  .status-card {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .progressbar {
    width: 100%;
    height: 12px;
    border-radius: 999px;
    background: #eef2f7;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }
  .progressbar > div {
    height: 100%;
    width: 0%;
    background: #111;
    border-radius: 999px;
    transition: width 0.2s ease;
  }

  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  .kpi {
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    background: #fff;
    padding: 14px 16px;
    cursor: pointer;
    transition: background-color 0.12s ease;
  }
  .kpi:hover {
    background: #f9fafb;
  }
  .kpi .label {
    font-size: 0.95rem;
    color: #555;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .kpi .value {
    font-size: 1.8rem;
    font-weight: 900;
    color: #111;
    letter-spacing: -0.02em;
  }
  .kpi .hint {
    margin-top: 6px;
    font-size: 0.9rem;
    color: #666;
  }

  .table-scroll {
    max-height: 420px;
    overflow: auto;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #fff;
  }
  .table-scroll table {
    min-width: 720px;
    border-collapse: collapse;
  }

  .field-label {
    font-size: 0.95rem;
    color: #555;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .grid.four {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  .panel-title-row {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
  }
  .panel-count {
    font-size: 0.95rem;
    color: #666;
    font-weight: 700;
  }

  .mini-note {
    font-size: 0.95rem;
    color: #555;
    margin-top: 8px;
  }

  .records-wrap {
    max-height: 480px;
    overflow: auto;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #fff;
  }
  .records-wrap table {
    min-width: 980px;
    border-collapse: collapse;
  }

  /* ====== 헤더 틀고정(Sticky) ====== */
  .table-scroll thead th,
  .records-wrap thead th,
  .file-list-wrap thead th {
    position: sticky;
    top: 0;
    z-index: 6;
    background: #f9fafb;
  }

  .to-top {
    position: fixed;
    left: 18px;
    bottom: 18px;
    width: 46px;
    height: 46px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background: #fff;
    font-size: 22px;
    font-weight: 900;
    color: #111;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    z-index: 9999;
  }
  .to-top.show {
    display: inline-flex;
  }

  details.log {
    margin-top: 14px;
  }
  details.log > summary {
    cursor: pointer;
    font-weight: 800;
    color: #111;
  }
  pre.log {
    margin: 10px 0 0;
    padding: 12px;
    border-radius: 12px;
    background: #0b0f17;
    color: #e6edf3;
    overflow: auto;
    font-size: 0.92rem;
    line-height: 1.5;
    max-height: 320px;
  }

  /* ====== 표 1행/1열 틀고정(섹션3/4 레코드 표) ====== */
  .records-wrap table thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 7;
    background: #f9fafb;
  }
  .records-wrap table tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 5;
    background: #fff;
  }

  /* ====== 섹션4: 세로 스택 레이아웃 보강 ====== */
  .stack-fields .field {
    margin-top: 10px;
  }
  .stack-fields .field:first-child {
    margin-top: 0;
  }

  .checkline {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .checkline input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }
</style>


  </head>

  <body>
    <header class="site-header">
      <div class="shell">
        <h1>강원특별자치도교육청 인사발령자료 집계분석기</h1>
        <p class="muted">
          ·도단위/관내 인사발령내역 엑셀을 업로드하면 학교/기관별 전입전출자 자동 집계합니다. 지방공무원·교육공무원·교육공무직 모두 분석 가능.
        </p>
      </div>
    </header>


<main class="container">
  <!-- =========================
       1) 업로드 섹션
       ========================= -->
  <section id="sec-upload" class="section">
    <div class="step-title">
      <span class="step-badge">1</span>
      <h2 style="margin: 0">인사발령 엑셀파일 업로드</h2>
    </div>

    <p class="sub" style="margin-top: 6px">
      ·파일은 드래그&드롭 또는 “파일 추가”로 계속 누적 업로드할 수 있습니다. “초기화”로 전부 비웁니다.
    </p>

    <div class="card">
      <div class="row between gap" style="align-items: flex-start">
        <div class="row gap">
          <button class="btn" id="btnAddFiles" type="button">파일 추가하기</button>
          <button class="btn ghost" id="btnResetFiles" type="button">초기화하기</button>
        </div>

        <div class="row gap">
          <button class="btn primary" id="btnAnalyze" type="button" disabled>데이터 분석하기</button>
        </div>
      </div>

      <input id="fileInput" type="file" multiple accept=".xlsx,.xls,.csv" style="display: none" />

      <div id="dropzone" class="dropzone" aria-label="파일 드래그&드롭 영역">
        <div>
          <div style="font-size: 1.05rem; color: #111; font-weight: 800">여기에 엑셀 파일을 드래그해서 올려주세요</div>
          <div class="muted" style="margin-top: 6px">
            ·지원: .xlsx/.xls/.csv (여러 파일 업로드 가능) ·SheetJS 사용(네트워크 실패 시 /static/xlsx.full.min.js fallback)
          </div>
        </div>
      </div>

      <div style="margin-top: 12px" class="row between gap">
        <div class="row gap" style="flex-wrap: wrap">
          <span class="badge" id="xlsxBadge">XLSX: 로딩중…</span>
          <span class="badge" id="fileCount">업로드 파일: 0개</span>
        </div>
        <div class="muted" style="font-size: 0.95rem">※ 분석 중에는 필터를 잠급니다.</div>
      </div>

      <details class="card" style="margin-top: 12px">
        <summary style="font-weight: 900; cursor: pointer" id="fileDetailsSummary">업로드된 파일 목록 보기</summary>
        <div class="file-list-wrap" style="margin-top: 10px">
          <table class="sheetlike">
            <thead>
              <tr>
                <th style="min-width: 330px">파일명</th>
                <th style="min-width: 160px">용량</th>
                <th style="min-width: 160px">추정 지역 힌트</th>
                <th style="min-width: 160px">추가 시각</th>
              </tr>
            </thead>
            <tbody id="fileTableBody">
              <tr>
                <td colspan="4" class="muted" style="text-align: center">아직 업로드된 파일이 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </details>

      <div class="card status-card" style="margin-top: 12px">
        <div class="panel-title-row">
          <h3 style="margin: 0">처리 진행률</h3>
          <div class="panel-count" id="statusDetail">0%</div>
        </div>
        <div class="progressbar"><div id="progressFill"></div></div>
        <div class="muted" id="statusTitle">대기 중…</div>
        <div class="muted" id="statusExtra"></div>
        <div id="statusBox" class=""></div>
      </div>
    </div>
  </section>

  <!-- =========================
       2) 전체 집계 결과
       ========================= -->
  <section id="sec-summary" class="section">
    <div class="step-title" style="margin: 0">
      <span class="step-badge">2</span>
      <h2 style="margin: 0">전체 집계 결과 조회</h2>
    </div>

    <div class="row between" style="margin-top: 8px; flex-wrap: wrap">
      <label class="checkline" style="user-select: none">
        <input type="checkbox" id="maskNameToggle" />
        <span>이름 마스킹(2번째 글자 *)</span>
      </label>
      <div class="row gap">
        <button class="btn pastel-blue" id="btnDownloadFiltered" type="button" disabled>상세내역 조회로 이동</button>
        <button class="btn" id="btnDownloadAll" type="button" disabled>전체 명단 다운로드</button>
      </div>
    </div>

    <p class="sub" style="margin-top: 6px">
      집계는 <b>도·관내 중복(“교육장이 지정하는 부서 근무를 명함” 등)</b>을 자동으로 제거한 결과 기준입니다.
    </p>

    <div class="kpi-grid" id="kpiGrid" aria-label="대시보드 KPI"></div>

    <div class="grid two" style="margin-top: 14px">
      <div>
        <div class="field-label">지역 검색</div>
        <input id="regionSearch" type="text" placeholder="지역 검색 (예: 강릉, 원주)" disabled />
      </div>
      <div>
        <div class="field-label">기관/학교 검색</div>
        <input id="instSearch" type="text" placeholder="기관 검색 (예: 교육지원청, ○○초등학교)" disabled />
      </div>
    </div>

    <div class="grid two" style="margin-top: 12px">
      <div class="card">
        <div class="panel-title-row">
          <h3 style="margin: 0">지역별 요약</h3>
          <div class="panel-count" id="regionTableCount">0건</div>
        </div>

        <div class="table-scroll" style="margin-top: 10px">
          <table class="sheetlike" id="regionTable">
            <thead>
              <tr>
                <th style="min-width: 180px">지역</th>
                <th class="numeric" style="min-width: 100px">기관 수</th>
                <th class="numeric" style="min-width: 100px">전입</th>
                <th class="numeric" style="min-width: 100px">전출</th>
                <th class="numeric" style="min-width: 140px">지역변동 없음</th>
                <th class="numeric" style="min-width: 90px">퇴직</th>
                <th class="numeric" style="min-width: 90px">인원</th>
              </tr>
            </thead>
            <tbody id="regionTableBody">
              <tr>
                <td colspan="7" class="muted" style="text-align: center">아직 집계 결과가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="panel-title-row">
          <h3 style="margin: 0">기관/학교별 요약</h3>
          <div class="panel-count" id="instTableCount">0건</div>
        </div>

        <div class="table-scroll" style="margin-top: 10px">
          <table class="sheetlike" id="instTable">
            <thead>
              <tr>
                <th style="min-width: 160px">지역</th>
                <th style="min-width: 320px">기관/학교명</th>
                <th class="numeric" style="min-width: 100px">전입</th>
                <th class="numeric" style="min-width: 100px">전출</th>
                <th class="numeric" style="min-width: 90px">인원</th>
              </tr>
            </thead>
            <tbody id="instTableBody">
              <tr>
                <td colspan="5" class="muted" style="text-align: center">아직 집계 결과가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mini-note">
          ※ 학교는 “원소속 학교 + 병설유치원” 합산 표기로 표시될 수 있습니다. (예: “동내초등학교 및 병설유치원”)
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
       3) 상세 내역 (학교/기관)
       ========================= -->
  <section id="sec-entity" class="section">
    <div class="step-title">
      <span class="step-badge">3</span>
      <h2 style="margin: 0">상세 내역 조회 (학교 및 기관별)</h2>
    </div>

    <p class="sub" style="margin-top: 6px">
      드롭박스를 앞에서부터 선택할수록 상세 결과가 자동 갱신됩니다. (항상 오름차순 정렬)
    </p>

    <div style="margin-top: 10px">
      <div class="field-label">드롭박스 항목 검색</div>
      <input id="entitySelectSearch" type="text" placeholder="드롭박스 항목 검색" disabled />
    </div>

    <div class="grid four">
      <div class="field">
        <div class="field-label">1) 구분</div>
        <select id="entityKind" disabled>
          <option value="">선택</option>
          <option value="school">학교</option>
          <option value="inst">기관</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">2) 학교/기관</div>
        <select id="entityName" disabled>
          <option value="">먼저 1) 구분을 선택하세요</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">3) 인사 구분</div>
        <select id="personnelType" disabled>
          <option value="">먼저 2) 학교/기관을 선택하세요</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">4) 직렬/직급/직종</div>
        <select id="jobFilter" disabled>
          <option value="">먼저 3) 인사 구분을 선택하세요</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">5) 지방공무원 직급</div>
        <select id="govGradeFilter" disabled>
          <option value="전체">전체</option>
        </select>
      </div>
    </div>

    <div class="row gap" style="margin-top: 12px; flex-wrap: wrap">
      <button class="btn" id="btnExportEntityDetailXlsx" type="button" disabled>상세 명단 엑셀 다운로드</button>
    </div>

    <!-- ✅ 전출/전입 패널: 위아래 배치 -->
    <div class="card" style="margin-top: 12px">
      <div class="panel-title-row">
        <h3 style="margin: 0">전출자 / 퇴직자</h3>
        <div class="panel-count" id="entityOutCount">0명</div>
      </div>
      <div id="entityOutPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </div>

    <div class="card">
      <div class="panel-title-row">
        <h3 style="margin: 0">전입자 / 신규 / 파견</h3>
        <div class="panel-count" id="entityInCount">0명</div>
      </div>
      <div id="entityInPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </div>

    <details class="card" id="entityUnknownDetails" style="margin-top: 12px" open>
      <summary style="font-weight: 900; cursor: pointer" id="entityUnknownSummary">미분류 (0명)</summary>
      <div id="entityUnknownPanel" class="muted" style="margin-top: 10px">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </details>

    <div class="mini-note">
      ※ 병설유치원은 원소속 학교로 자동 합산합니다. (예: “동내초등학교 및 병설유치원”)
    </div>
  </section>

  <!-- =========================
       4) 상세 발령 내역 (시군구)
       ========================= -->
  <section id="sec-region" class="section">
    <div class="step-title" style="margin: 0">
      <span class="step-badge">4</span>
      <h2 style="margin: 0">상세 발령 내역 (시군구별 조회)</h2>
    </div>

    <div class="row gap" style="margin-top: 8px; flex-wrap: wrap">
      <button class="btn" id="btnExportRegionView" type="button" disabled>조회 결과 엑셀로 다운로드</button>
    </div>

    <p class="sub" style="margin-top: 6px">
      “속초/양양”은 <b>속초양양</b>으로 통합 집계합니다. “강원도교육청”은 분리/춘천합산을 선택할 수 있습니다.
    </p>

    <div class="stack-fields" style="margin-top: 12px">
      <div class="field">
        <div class="field-label">1) 강원도교육청 처리</div>
        <select id="officeMode" disabled>
          <option value="">선택</option>
          <option value="separate">강원도교육청 분리</option>
          <option value="merge">강원도교육청을 춘천에 합산</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">2) 지역 선택</div>
        <select id="regionPick" disabled>
          <option value="">먼저 1) 처리 방식을 선택하세요</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">3) 인사 구분</div>
        <select id="regionPersonnelType" disabled>
          <option value="">먼저 2) 지역을 선택하세요</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">4) 지방공무원 직급</div>
        <select id="regionGovGradeFilter" disabled>
          <option value="전체">전체</option>
        </select>
      </div>
    </div>

    <div class="card" style="margin-top: 12px">
      <div class="panel-title-row">
        <h3 style="margin: 0">전출자 / 퇴직자</h3>
        <div class="panel-count" id="regionOutCount">0명</div>
      </div>
      <div id="regionOutPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </div>

    <div class="card">
      <div class="panel-title-row">
        <h3 style="margin: 0">전입자 / 신규</h3>
        <div class="panel-count" id="regionInCount">0명</div>
      </div>
      <div id="regionInPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </div>

    <div class="card">
      <div class="panel-title-row">
        <h3 style="margin: 0">지역변동 없음</h3>
        <div class="panel-count" id="regionStayCount">0명</div>
      </div>
      <div id="regionStayPanel" style="margin-top: 10px" class="muted">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </div>

    <details class="card" id="regionUnknownDetails" style="margin-top: 12px">
      <summary style="font-weight: 900; cursor: pointer" id="regionUnknownSummary">미분류 (0명)</summary>
      <div id="regionUnknownPanel" class="muted" style="margin-top: 10px">조회 조건을 선택하면 여기에 표시됩니다.</div>
    </details>
  </section>

  <!-- 로그 -->
  <details class="log section">
    <summary>시스템 처리 로그 보기</summary>
    <pre class="log" id="logBox"></pre>
  </details>
</main>

<button id="toTopBtn" class="to-top" type="button" aria-label="페이지 상단으로">↑</button>



<!-- =========================
     강원도 내 전체 학교 목록(내장)
     - 업로드 없이 항상 사용 가능
     - 항목: { n: 학교이름, r: 시군구(속초/양양은 속초양양) }
     ========================= -->
<script>
  const GW_SCHOOL_MASTER_ROWS = [{"n":"가곡고등학교","r":"삼척"},{"n":"가곡중학교","r":"삼척"},{"n":"가람유치원","r":"춘천"},{"n":"가산초등학교","r":"춘천"},{"n":"가온유치원","r":"강릉"},{"n":"가정중학교","r":"춘천"},{"n":"간동고등학교","r":"화천"},{"n":"간동중학교","r":"화천"},{"n":"간성초등학교","r":"고성"},{"n":"간성초병설유치원","r":"고성"},{"n":"갈래초등학교","r":"정선"},{"n":"갈래초병설유치원","r":"정선"},{"n":"갑천고등학교","r":"횡성"},{"n":"갑천중학교","r":"횡성"},{"n":"갑천초등학교","r":"횡성"},{"n":"갑천초병설유치원","r":"횡성"},{"n":"강동초등학교","r":"강릉"},{"n":"강동초병설유치원","r":"강릉"},{"n":"강룡사유치원","r":"홍천"},{"n":"강릉고등학교","r":"강릉"},{"n":"강릉명륜고등학교","r":"강릉"},{"n":"강릉문성고등학교","r":"강릉"},{"n":"강릉여자고등학교","r":"강릉"},{"n":"강릉오성학교","r":"강릉"},{"n":"강릉원주대부설유치원","r":"원주"},{"n":"강릉유치원","r":"강릉"},{"n":"강릉정보공업고등학교","r":"강릉"},{"n":"강릉제일고등학교","r":"강릉"},{"n":"강릉중앙고등학교","r":"강릉"},{"n":"강릉중학교","r":"강릉"},{"n":"강릉초등학교","r":"강릉"},{"n":"강릉초병설유치원","r":"강릉"},{"n":"강릉해람중학교","r":"강릉"},{"n":"강림중학교","r":"횡성"},{"n":"강림초등학교","r":"횡성"},{"n":"강서중학교","r":"춘천"},{"n":"강원고등학교","r":"춘천"},{"n":"강원과학고등학교","r":"원주"},{"n":"강원대학교사범대학부설고등학교","r":"춘천"},{"n":"강원명진학교","r":"춘천"},{"n":"강원생활과학고등학교","r":"홍천"},{"n":"강원애니고등학교","r":"춘천"},{"n":"강원예술고등학교","r":"강릉"},{"n":"강원온라인학교","r":"원주"},{"n":"강원외국어고등학교","r":"양구"},{"n":"강원중학교","r":"춘천"},{"n":"강원체육고등학교","r":"춘천"},{"n":"강원체육중학교","r":"춘천"},{"n":"강일여자고등학교","r":"강릉"},{"n":"강현중학교","r":"속초양양"},{"n":"강현초등학교","r":"속초양양"},{"n":"강현초병설유치원","r":"속초양양"},{"n":"거문초등학교","r":"평창"},{"n":"거문초병설유치원","r":"평창"},{"n":"거성초등학교","r":"고성"},{"n":"거성초병설유치원","r":"고성"},{"n":"거진고등학교","r":"고성"},{"n":"거진중학교","r":"고성"},{"n":"거진초등학교","r":"고성"},{"n":"거진초병설유치원","r":"고성"},{"n":"경포고등학교","r":"강릉"},{"n":"경포대초등학교","r":"강릉"},{"n":"경포대초병설유치원","r":"강릉"},{"n":"경포유치원","r":"강릉"},{"n":"경포중학교","r":"강릉"},{"n":"경포초등학교","r":"강릉"},{"n":"계촌중학교","r":"평창"},{"n":"계촌초등학교","r":"평창"},{"n":"계촌초병설유치원","r":"평창"},{"n":"고산초등학교","r":"원주"},{"n":"고산초병설유치원","r":"원주"},{"n":"고성고등학교","r":"고성"},{"n":"고성중학교","r":"고성"},{"n":"고한고등학교","r":"정선"},{"n":"고한중학교","r":"정선"},{"n":"고한초등학교","r":"정선"},{"n":"고한초병설유치원","r":"정선"},{"n":"공근중학교","r":"횡성"},{"n":"공근초등학교","r":"횡성"},{"n":"공근초병설유치원","r":"횡성"},{"n":"공현진초등학교","r":"고성"},{"n":"공현진초병설유치원","r":"고성"},{"n":"관동중학교","r":"강릉"},{"n":"관설초등학교","r":"원주"},{"n":"광덕초등학교","r":"화천"},{"n":"광덕초병설유치원","r":"화천"},{"n":"광산초등학교","r":"고성"},{"n":"광산초병설유치원","r":"고성"},{"n":"광정초등학교","r":"속초양양"},{"n":"광정초병설유치원","r":"속초양양"},{"n":"광판중학교","r":"춘천"},{"n":"광판초등학교","r":"춘천"},{"n":"광판초병설유치원","r":"춘천"},{"n":"교동초등학교(강릉)","r":"강릉"},{"n":"교동초등학교(속초)","r":"속초양양"},{"n":"교동초등학교(원주)","r":"원주"},{"n":"교동초등학교(춘천)","r":"춘천"},{"n":"교동초병설유치원(강릉)","r":"강릉"},{"n":"교동초병설유치원(원주)","r":"원주"},{"n":"교동초병설유치원(춘천)","r":"춘천"},{"n":"교학초등학교","r":"원주"},{"n":"구곡초등학교","r":"원주"},{"n":"구곡초병설유치원","r":"원주"},{"n":"구래초등학교","r":"영월"},{"n":"구송초등학교","r":"홍천"},{"n":"구송초병설유치원","r":"홍천"},{"n":"구정초등학교","r":"강릉"},{"n":"구정초병설유치원","r":"강릉"},{"n":"귀둔초등학교","r":"인제"},{"n":"귀둔초병설유치원","r":"인제"},{"n":"귀래중학교","r":"원주"},{"n":"귀래초등학교","r":"원주"},{"n":"그린나래유치원","r":"원주"},{"n":"근남초등학교","r":"철원"},{"n":"근남초병설유치원","r":"철원"},{"n":"근덕중학교","r":"삼척"},{"n":"근덕초등학교","r":"삼척"},{"n":"근화초등학교","r":"춘천"},{"n":"금광초등학교","r":"강릉"},{"n":"금광초병설유치원","r":"강릉"},{"n":"금대초등학교","r":"원주"},{"n":"금병초등학교","r":"춘천"},{"n":"금빛유치원","r":"원주"},{"n":"금산초등학교","r":"춘천"},{"n":"금산초병설유치원","r":"춘천"},{"n":"기린고등학교","r":"인제"},{"n":"기린중학교","r":"인제"},{"n":"기린초등학교","r":"인제"},{"n":"기린초병설유치원","r":"인제"},{"n":"기린초진동분교장","r":"인제"},{"n":"김화고등학교","r":"철원"},{"n":"김화여자중학교","r":"철원"},{"n":"김화중학교","r":"철원"},{"n":"김화초등학교","r":"철원"},{"n":"김화초병설유치원","r":"철원"},{"n":"꿈나무유치원","r":"춘천"},{"n":"꿈에그린유치원","r":"춘천"},{"n":"나래유치원","r":"철원"},{"n":"나영유치원","r":"원주"},{"n":"나전중학교","r":"정선"},{"n":"낙산유치원","r":"속초양양"},{"n":"남강초등학교","r":"강릉"},{"n":"남부초등학교","r":"춘천"},{"n":"남산초등학교(강릉)","r":"강릉"},{"n":"남산초등학교(춘천)","r":"춘천"},{"n":"남산초등학교(홍천)","r":"홍천"},{"n":"남산초병설유치원(강릉)","r":"강릉"},{"n":"남산초병설유치원(춘천)","r":"춘천"},{"n":"남산초서천분교장","r":"춘천"},{"n":"남선초등학교","r":"정선"},{"n":"남선초병설유치원","r":"정선"},{"n":"남애초등학교","r":"속초양양"},{"n":"남애초병설유치원","r":"속초양양"},{"n":"남원주중학교","r":"원주"},{"n":"남원주초등학교","r":"원주"},{"n":"남원주초병설유치원","r":"원주"},{"n":"남춘천여자중학교","r":"춘천"},{"n":"남춘천중학교","r":"춘천"},{"n":"남춘천초등학교","r":"춘천"},{"n":"남평초등학교","r":"정선"},{"n":"남평초병설유치원","r":"정선"},{"n":"남호초등학교","r":"동해"},{"n":"남호초병설유치원","r":"동해"},{"n":"내대초등학교","r":"철원"},{"n":"내대초병설유치원","r":"철원"},{"n":"내면고등학교","r":"홍천"},{"n":"내면중학교","r":"홍천"},{"n":"내성초등학교","r":"영월"},{"n":"내성초병설유치원","r":"영월"},{"n":"내촌중학교","r":"홍천"},{"n":"내촌초등학교","r":"홍천"},{"n":"내촌초병설유치원","r":"홍천"},{"n":"너브내유치원","r":"홍천"},{"n":"노란유치원","r":"삼척"},{"n":"노암초등학교","r":"강릉"},{"n":"노암초병설유치원","r":"강릉"},{"n":"노천초등학교","r":"홍천"},{"n":"녹전중학교","r":"영월"},{"n":"녹전초등학교","r":"영월"},{"n":"녹전초병설유치원","r":"영월"},{"n":"늘해랑유치원","r":"강릉"},{"n":"다목초등학교","r":"화천"},{"n":"다목초병설유치원","r":"화천"},{"n":"다솔유치원","r":"삼척"},{"n":"다인유치원","r":"강릉"},{"n":"단계초등학교","r":"원주"},{"n":"단계초병설유치원","r":"원주"},{"n":"단관초등학교","r":"원주"},{"n":"단관초병설유치원","r":"원주"},{"n":"단구중학교","r":"원주"},{"n":"단구초등학교","r":"원주"},{"n":"단구초병설유치원","r":"원주"},{"n":"당림초등학교","r":"춘천"},{"n":"당림초병설유치원","r":"춘천"},{"n":"대곡초등학교","r":"홍천"},{"n":"대곡초병설유치원","r":"홍천"},{"n":"대관령중학교","r":"평창"},{"n":"대관령초등학교","r":"평창"},{"n":"대동여자중학교","r":"횡성"},{"n":"대동유치원","r":"동해"},{"n":"대룡중학교","r":"춘천"},{"n":"대성고등학교","r":"원주"},{"n":"대성중학교","r":"원주"},{"n":"대암중학교","r":"양구"},{"n":"대진고등학교","r":"고성"},{"n":"대진중학교","r":"고성"},{"n":"대진초등학교","r":"고성"},{"n":"대진초병설유치원","r":"고성"},{"n":"대포초등학교","r":"속초양양"},{"n":"대포초병설유치원","r":"속초양양"},{"n":"대화고등학교","r":"평창"},{"n":"대화중학교","r":"평창"},{"n":"대화초등학교","r":"평창"},{"n":"대화초병설유치원","r":"평창"},{"n":"덕두원초등학교","r":"원주"},{"n":"덕두원초병설유치원","r":"원주"},{"n":"덕산초등학교","r":"원주"},{"n":"덕산초병설유치원","r":"원주"},{"n":"덕수학교","r":"춘천"},{"n":"도계고등학교","r":"삼척"},{"n":"도계전정고등학교","r":"삼척"},{"n":"도계중학교","r":"삼척"},{"n":"도계초등학교","r":"삼척"},{"n":"도계초병설유치원","r":"삼척"},{"n":"도원초등학교","r":"원주"},{"n":"도원초병설유치원","r":"원주"},{"n":"동강중학교","r":"영월"},{"n":"동강초등학교","r":"영월"},{"n":"동내초등학교","r":"춘천"},{"n":"동내초병설유치원","r":"춘천"},{"n":"동명초등학교","r":"속초양양"},{"n":"동명초병설유치원","r":"속초양양"},{"n":"동부초등학교","r":"춘천"},{"n":"동산초등학교","r":"춘천"},{"n":"동산초병설유치원","r":"춘천"},{"n":"동송중학교","r":"철원"},{"n":"동송초등학교","r":"철원"},{"n":"동해광희고등학교","r":"동해"},{"n":"동해삼육고등학교","r":"동해"},{"n":"동해삼육중학교","r":"동해"},{"n":"동해삼육초등학교","r":"동해"},{"n":"동해상업고등학교","r":"동해"},{"n":"동해중학교","r":"동해"},{"n":"동해청운초등학교","r":"동해"},{"n":"동해청운초병설유치원","r":"동해"},{"n":"동해초등학교","r":"동해"},{"n":"동해초병설유치원","r":"동해"},{"n":"동해해람고등학교","r":"동해"},{"n":"동호초등학교","r":"춘천"},{"n":"동호초병설유치원","r":"춘천"},{"n":"둔내고등학교","r":"횡성"},{"n":"둔내중학교","r":"횡성"},{"n":"둔내초등학교","r":"횡성"},{"n":"둔내초병설유치원","r":"횡성"},{"n":"라온유치원(원주)","r":"원주"},{"n":"마차초등학교","r":"영월"},{"n":"마차초병설유치원","r":"영월"},{"n":"만천초등학교","r":"춘천"},{"n":"만천초병설유치원","r":"춘천"},{"n":"맹방초등학교","r":"삼척"},{"n":"맹방초병설유치원","r":"삼척"},{"n":"명덕초등학교","r":"춘천"},{"n":"명륜초등학교","r":"춘천"},{"n":"명륜초병설유치원","r":"춘천"},{"n":"모산초등학교","r":"원주"},{"n":"모산초병설유치원","r":"원주"},{"n":"묵호고등학교","r":"동해"},{"n":"묵호중학교","r":"동해"},{"n":"묵호초등학교","r":"동해"},{"n":"묵호초병설유치원","r":"동해"},{"n":"문막고등학교","r":"원주"},{"n":"문막중학교","r":"원주"},{"n":"문막초등학교","r":"원주"},{"n":"문막초병설유치원","r":"원주"},{"n":"문산초등학교","r":"춘천"},{"n":"문산초병설유치원","r":"춘천"},{"n":"문성중학교","r":"강릉"},{"n":"미동초등학교","r":"태백"},{"n":"미동초병설유치원","r":"태백"},{"n":"미래유치원","r":"원주"},{"n":"미로초등학교","r":"삼척"},{"n":"미로초병설유치원","r":"삼척"},{"n":"미산초등학교","r":"양구"},{"n":"미산초병설유치원","r":"양구"},{"n":"미탄초등학교","r":"평창"},{"n":"미탄초병설유치원","r":"평창"},{"n":"반곡초등학교","r":"원주"},{"n":"반곡초병설유치원","r":"원주"},{"n":"반곡중학교","r":"원주"},{"n":"방림초등학교","r":"평창"},{"n":"방림초병설유치원","r":"평창"},{"n":"백산중학교","r":"정선"},{"n":"백산초등학교","r":"정선"},{"n":"백산초병설유치원","r":"정선"},{"n":"백운초등학교","r":"정선"},{"n":"백운초병설유치원","r":"정선"},{"n":"버들유치원","r":"춘천"},{"n":"보광중학교","r":"평창"},{"n":"봉대초등학교","r":"원주"},{"n":"봉대초병설유치원","r":"원주"},{"n":"봉대초소초분교장","r":"원주"},{"n":"봉대초소초분교장병설유치원","r":"원주"},{"n":"봉평고등학교","r":"평창"},{"n":"봉평중학교","r":"평창"},{"n":"봉평초등학교","r":"평창"},{"n":"북방중학교","r":"홍천"},{"n":"북방초등학교","r":"홍천"},{"n":"북방초병설유치원","r":"홍천"},{"n":"북삼초등학교","r":"동해"},{"n":"북삼초병설유치원","r":"동해"},{"n":"북원여자중학교","r":"원주"},{"n":"북원중학교","r":"원주"},{"n":"북평중학교","r":"동해"},{"n":"북평초등학교","r":"동해"},{"n":"북평초병설유치원","r":"동해"},{"n":"사내고등학교","r":"화천"},{"n":"사내중학교","r":"화천"},{"n":"사내초등학교","r":"화천"},{"n":"사내초병설유치원","r":"화천"},{"n":"사북중학교","r":"정선"},{"n":"사북초등학교","r":"정선"},{"n":"사북초병설유치원","r":"정선"},{"n":"사북초예미분교장","r":"정선"},{"n":"사북초예미분교장병설유치원","r":"정선"},{"n":"사임당유치원","r":"강릉"},{"n":"산돌유치원","r":"원주"},{"n":"산수유치원","r":"춘천"},{"n":"산천초등학교","r":"홍천"},{"n":"산천초병설유치원","r":"홍천"},{"n":"삼일중학교","r":"속초양양"},{"n":"삼일초등학교","r":"속초양양"},{"n":"삼일초병설유치원","r":"속초양양"},{"n":"삼척고등학교","r":"삼척"},{"n":"삼척마이스터고등학교","r":"삼척"},{"n":"삼척미로중학교","r":"삼척"},{"n":"삼척여자고등학교","r":"삼척"},{"n":"삼척중학교","r":"삼척"},{"n":"삼척초등학교","r":"삼척"},{"n":"상지여자고등학교","r":"원주"},{"n":"상지여자중학교","r":"원주"},{"n":"상지초등학교","r":"원주"},{"n":"샘물유치원","r":"춘천"},{"n":"샘터유치원","r":"원주"},{"n":"샘터유치원(삼척)","r":"삼척"},{"n":"샘터유치원(춘천)","r":"춘천"},{"n":"샘터유치원(태백)","r":"태백"},{"n":"서석중학교","r":"홍천"},{"n":"서석초등학교","r":"홍천"},{"n":"서석초병설유치원","r":"홍천"},{"n":"서원주초등학교","r":"원주"},{"n":"서원주초병설유치원","r":"원주"},{"n":"서울유치원","r":"춘천"},{"n":"석사유치원","r":"춘천"},{"n":"석사초등학교","r":"춘천"},{"n":"석사초병설유치원","r":"춘천"},{"n":"석정초등학교","r":"원주"},{"n":"석정초병설유치원","r":"원주"},{"n":"설악고등학교","r":"속초양양"},{"n":"설악중학교","r":"속초양양"},{"n":"설악초등학교","r":"속초양양"},{"n":"설악초병설유치원","r":"속초양양"},{"n":"성덕초등학교","r":"강릉"},{"n":"성덕초병설유치원","r":"강릉"},{"n":"성수고등학교","r":"원주"},{"n":"성수중학교","r":"원주"},{"n":"성수초등학교","r":"원주"},{"n":"성수초병설유치원","r":"원주"},{"n":"성일초등학교","r":"원주"},{"n":"성일초병설유치원","r":"원주"},{"n":"성지초등학교","r":"춘천"},{"n":"성지초병설유치원","r":"춘천"},{"n":"속초고등학교","r":"속초양양"},{"n":"속초설악중학교","r":"속초양양"},{"n":"속초여자고등학교","r":"속초양양"},{"n":"속초여자중학교","r":"속초양양"},{"n":"속초중학교","r":"속초양양"},{"n":"속초청대초등학교","r":"속초양양"},{"n":"속초초등학교","r":"속초양양"},{"n":"송암초등학교","r":"춘천"},{"n":"송암초병설유치원","r":"춘천"},{"n":"송양초등학교","r":"원주"},{"n":"송양초병설유치원","r":"원주"},{"n":"수동중학교","r":"춘천"},{"n":"수리유치원","r":"원주"},{"n":"수북초등학교","r":"철원"},{"n":"수북초병설유치원","r":"철원"},{"n":"수산초등학교","r":"양구"},{"n":"수산초병설유치원","r":"양구"},{"n":"수주초등학교","r":"속초양양"},{"n":"수주초병설유치원","r":"속초양양"},{"n":"신남초등학교","r":"철원"},{"n":"신남초병설유치원","r":"철원"},{"n":"신동중학교","r":"정선"},{"n":"신동초등학교","r":"정선"},{"n":"신동초병설유치원","r":"정선"},{"n":"신림중학교","r":"원주"},{"n":"신림초등학교","r":"원주"},{"n":"신림초병설유치원","r":"원주"},{"n":"신리초등학교","r":"원주"},{"n":"신리초병설유치원","r":"원주"},{"n":"신영초등학교","r":"원주"},{"n":"신영초병설유치원","r":"원주"},{"n":"신철원초등학교","r":"철원"},{"n":"신철원초병설유치원","r":"철원"},{"n":"신천초등학교","r":"원주"},{"n":"신천초병설유치원","r":"원주"},{"n":"신평초등학교","r":"홍천"},{"n":"신평초병설유치원","r":"홍천"},{"n":"심석초등학교","r":"홍천"},{"n":"심석초병설유치원","r":"홍천"},{"n":"양구고등학교","r":"양구"},{"n":"양구중학교","r":"양구"},{"n":"양구초등학교","r":"양구"},{"n":"양구초병설유치원","r":"양구"},{"n":"양덕중학교","r":"원주"},{"n":"양덕초등학교","r":"원주"},{"n":"양덕초병설유치원","r":"원주"},{"n":"양양고등학교","r":"속초양양"},{"n":"양양중학교","r":"속초양양"},{"n":"양양초등학교","r":"속초양양"},{"n":"양양초병설유치원","r":"속초양양"},{"n":"언양초등학교","r":"춘천"},{"n":"언양초병설유치원","r":"춘천"},{"n":"여량중학교","r":"정선"},{"n":"여량초등학교","r":"정선"},{"n":"여량초병설유치원","r":"정선"},{"n":"연곡초등학교","r":"강릉"},{"n":"연곡초병설유치원","r":"강릉"},{"n":"연당중학교","r":"영월"},{"n":"연당초등학교","r":"영월"},{"n":"연당초병설유치원","r":"영월"},{"n":"열린유치원","r":"춘천"},{"n":"영동초등학교","r":"강릉"},{"n":"영동초병설유치원","r":"강릉"},{"n":"영랑초등학교","r":"속초양양"},{"n":"영서고등학교","r":"원주"},{"n":"영월고등학교","r":"영월"},{"n":"영월유치원","r":"영월"},{"n":"영월중학교","r":"영월"},{"n":"영월초등학교","r":"영월"},{"n":"영지유치원","r":"원주"},{"n":"예그랑유치원","r":"원주"},{"n":"예람중학교","r":"동해"},{"n":"예미초등학교","r":"정선"},{"n":"예미초병설유치원","r":"정선"},{"n":"예미초운치분교장","r":"정선"},{"n":"예원유치원","r":"춘천"},{"n":"예지유치원","r":"원주"},{"n":"예초유치원","r":"춘천"},{"n":"오덕초등학교","r":"철원"},{"n":"오동초등학교","r":"춘천"},{"n":"오동초병설유치원","r":"춘천"},{"n":"오안초등학교","r":"홍천"},{"n":"오저초등학교","r":"삼척"},{"n":"오저초병설유치원","r":"삼척"},{"n":"오호초등학교","r":"고성"},{"n":"오호초병설유치원","r":"고성"},{"n":"옥계중학교","r":"강릉"},{"n":"옥계초금진분교장","r":"강릉"},{"n":"옥계초금진분교장병설유치원","r":"강릉"},{"n":"옥계초등학교","r":"강릉"},{"n":"옥계초병설유치원","r":"강릉"},{"n":"옥동중학교","r":"영월"},{"n":"옥동초등학교","r":"영월"},{"n":"옥동초병설유치원","r":"영월"},{"n":"옥천초등학교","r":"강릉"},{"n":"옥천초병설유치원","r":"강릉"},{"n":"온의유치원","r":"춘천"},{"n":"온정초등학교","r":"속초양양"},{"n":"온정초병설유치원","r":"속초양양"},{"n":"와수초등학교","r":"철원"},{"n":"와수초병설유치원","r":"철원"},{"n":"왕산중학교","r":"강릉"},{"n":"왕산초등학교","r":"강릉"},{"n":"왕산초병설유치원","r":"강릉"},{"n":"용대초등학교","r":"인제"},{"n":"용대초병설유치원","r":"인제"},{"n":"용암초등학교","r":"화천"},{"n":"용암초병설유치원","r":"화천"},{"n":"용전중학교","r":"평창"},{"n":"용정초등학교","r":"철원"},{"n":"용하중학교","r":"양구"},{"n":"용하초등학교","r":"양구"},{"n":"용하초병설유치원","r":"양구"},{"n":"우리유치원","r":"춘천"},{"n":"우산초등학교","r":"원주"},{"n":"우산초병설유치원","r":"원주"},{"n":"우석중학교","r":"춘천"},{"n":"우석초등학교","r":"춘천"},{"n":"우석초병설유치원","r":"춘천"},{"n":"우천중학교","r":"횡성"},{"n":"우천초등학교","r":"횡성"},{"n":"운산초등학교","r":"강릉"},{"n":"운양초등학교","r":"강릉"},{"n":"원당초등학교(양구)","r":"양구"},{"n":"원당초등학교(홍천)","r":"홍천"},{"n":"원당초병설유치원","r":"양구"},{"n":"원덕고등학교","r":"삼척"},{"n":"원덕중학교","r":"삼척"},{"n":"원주고등학교","r":"원주"},{"n":"원주금융회계고등학교","r":"원주"},{"n":"원주삼육고등학교","r":"원주"},{"n":"원주삼육중학교","r":"원주"},{"n":"원주삼육초등학교","r":"원주"},{"n":"원주여자고등학교","r":"원주"},{"n":"원주여자중학교","r":"원주"},{"n":"원주유치원","r":"원주"},{"n":"원주의료고등학교","r":"원주"},{"n":"원주중학교","r":"원주"},{"n":"원주청원학교","r":"원주"},{"n":"원주초등학교","r":"원주"},{"n":"원주초병설유치원","r":"원주"},{"n":"원천초등학교","r":"화천"},{"n":"원천초병설유치원","r":"화천"},{"n":"원통고등학교","r":"인제"},{"n":"원통중학교","r":"인제"},{"n":"원통초등학교","r":"인제"},{"n":"원통초병설유치원","r":"인제"},{"n":"월학초등학교","r":"인제"},{"n":"월학초병설유치원","r":"인제"},{"n":"유봉여자고등학교","r":"춘천"},{"n":"유봉여자중학교","r":"춘천"},{"n":"유천초등학교","r":"강릉"},{"n":"유천초병설유치원","r":"강릉"},{"n":"유촌초등학교","r":"화천"},{"n":"유촌초병설유치원","r":"화천"},{"n":"유현초등학교","r":"횡성"},{"n":"육민관고등학교","r":"원주"},{"n":"육민관중학교","r":"원주"},{"n":"율곡중학교","r":"강릉"},{"n":"율곡초등학교","r":"강릉"},{"n":"율전초등학교","r":"홍천"},{"n":"율전초병설유치원","r":"홍천"},{"n":"은빛유치원","r":"춘천"},{"n":"이화유치원","r":"원주"},{"n":"인구초등학교","r":"속초양양"},{"n":"인구초병설유치원","r":"속초양양"},{"n":"인제고등학교","r":"인제"},{"n":"인제남초등학교","r":"인제"},{"n":"인제중학교","r":"인제"},{"n":"인제초등학교","r":"인제"},{"n":"인흥초등학교","r":"고성"},{"n":"일산초등학교","r":"원주"},{"n":"일산초병설유치원","r":"원주"},{"n":"임계고등학교","r":"정선"},{"n":"임계중학교","r":"정선"},{"n":"임계초등학교","r":"정선"},{"n":"임계초병설유치원","r":"정선"},{"n":"임당초등학교","r":"양구"},{"n":"임당초병설유치원","r":"양구"},{"n":"임원중학교","r":"삼척"},{"n":"임원초등학교","r":"삼척"},{"n":"임원초병설유치원","r":"삼척"},{"n":"자연유치원(원주)","r":"원주"},{"n":"자연유치원(춘천)","r":"춘천"},{"n":"장성여자고등학교","r":"태백"},{"n":"장성초등학교","r":"태백"},{"n":"장성초병설유치원","r":"태백"},{"n":"장양초등학교","r":"원주"},{"n":"장양초병설유치원","r":"원주"},{"n":"장원초등학교","r":"삼척"},{"n":"장평초등학교","r":"평창"},{"n":"장학초등학교","r":"춘천"},{"n":"장학초병설유치원","r":"춘천"},{"n":"장호초등학교","r":"삼척"},{"n":"장호초병설유치원","r":"삼척"},{"n":"장흥초등학교","r":"철원"},{"n":"전인고등학교","r":"춘천"},{"n":"정금초등학교","r":"횡성"},{"n":"정금초병설유치원","r":"횡성"},{"n":"정동초등학교","r":"강릉"},{"n":"정동초병설유치원","r":"강릉"},{"n":"정라초등학교","r":"삼척"},{"n":"정라초병설유치원","r":"삼척"},{"n":"정선고등학교","r":"정선"},{"n":"정선유치원","r":"정선"},{"n":"정선정보공업고등학교","r":"정선"},{"n":"정선중학교","r":"정선"},{"n":"정선초가수분교장","r":"정선"},{"n":"정선초등학교","r":"정선"},{"n":"제이엠유치원","r":"강릉"},{"n":"제일유치원","r":"원주"},{"n":"조산초등학교","r":"속초양양"},{"n":"조산초병설유치원","r":"속초양양"},{"n":"조양초등학교(속초)","r":"속초양양"},{"n":"조양초등학교(춘천)","r":"춘천"},{"n":"조양초병설유치원","r":"춘천"},{"n":"좋은유치원","r":"강릉"},{"n":"주문진고등학교","r":"강릉"},{"n":"주문진중학교","r":"강릉"},{"n":"주문진초등학교","r":"강릉"},{"n":"주문진초병설유치원","r":"강릉"},{"n":"주봉초등학교","r":"홍천"},{"n":"주봉초병설유치원","r":"홍천"},{"n":"주영초등학교","r":"강릉"},{"n":"주영초병설유치원","r":"강릉"},{"n":"주진초등학교","r":"평창"},{"n":"주천고등학교","r":"영월"},{"n":"주천중학교","r":"영월"},{"n":"주천초등학교","r":"영월"},{"n":"주천초병설유치원","r":"영월"},{"n":"죽리초등학교","r":"양구"},{"n":"죽리초병설유치원","r":"양구"},{"n":"죽왕초등학교","r":"고성"},{"n":"죽왕초병설유치원","r":"고성"},{"n":"중앙유치원","r":"삼척"},{"n":"중앙초등학교(강릉)","r":"강릉"},{"n":"중앙초등학교(속초)","r":"속초양양"},{"n":"중앙초등학교(원주)","r":"원주"},{"n":"중앙초등학교(춘천)","r":"춘천"},{"n":"중앙초병설유치원","r":"원주"},{"n":"증산초등학교","r":"정선"},{"n":"지정샘유치원","r":"원주"},{"n":"지정중학교","r":"원주"},{"n":"지정초등학교","r":"원주"},{"n":"지정초병설유치원","r":"원주"},{"n":"지촌초등학교","r":"춘천"},{"n":"지촌초지암분교장","r":"춘천"},{"n":"지촌초지암분교장병설유치원","r":"춘천"},{"n":"진광고등학교","r":"원주"},{"n":"진광중학교","r":"원주"},{"n":"진부고등학교","r":"평창"},{"n":"진부중학교","r":"평창"},{"n":"진부초등학교","r":"평창"},{"n":"진부초병설유치원","r":"평창"},{"n":"진주초등학교","r":"삼척"},{"n":"진주초병설유치원","r":"삼척"},{"n":"창림초등학교","r":"횡성"},{"n":"창림초병설유치원","r":"횡성"},{"n":"창촌중학교","r":"춘천"},{"n":"창촌초등학교","r":"홍천"},{"n":"창촌초병설유치원","r":"홍천"},{"n":"창호초등학교","r":"동해"},{"n":"천곡초등학교","r":"동해"},{"n":"천곡초병설유치원","r":"동해"},{"n":"천전초등학교","r":"춘천"},{"n":"천전초병설유치원","r":"춘천"},{"n":"천진초등학교","r":"고성"},{"n":"천진초병설유치원","r":"고성"},{"n":"철암고등학교","r":"태백"},{"n":"철암중학교","r":"태백"},{"n":"철암초등학교","r":"태백"},{"n":"철원고등학교","r":"철원"},{"n":"철원여자고등학교","r":"철원"},{"n":"철원여자중학교","r":"철원"},{"n":"철원중학교","r":"철원"},{"n":"철원초등학교","r":"철원"},{"n":"청담유치원(원주)","r":"원주"},{"n":"청대초등학교","r":"속초양양"},{"n":"청대초병설유치원","r":"속초양양"},{"n":"청령포초등학교","r":"영월"},{"n":"청령포초병설유치원","r":"영월"},{"n":"청봉초등학교","r":"속초양양"},{"n":"청아중학교","r":"삼척"},{"n":"청양초등학교","r":"철원"},{"n":"청양초병설유치원","r":"철원"},{"n":"청운초등학교","r":"동해"},{"n":"청일중학교","r":"횡성"},{"n":"청일초등학교","r":"횡성"},{"n":"청일초병설유치원","r":"횡성"},{"n":"청호초등학교","r":"속초양양"},{"n":"청호초병설유치원","r":"속초양양"},{"n":"초당초등학교","r":"강릉"},{"n":"추곡초등학교","r":"춘천"},{"n":"추곡초병설유치원","r":"춘천"},{"n":"춘당초등학교","r":"횡성"},{"n":"춘성중학교","r":"춘천"},{"n":"춘천계성학교","r":"춘천"},{"n":"춘천고등학교","r":"춘천"},{"n":"춘천교육대학부설초등학교","r":"춘천"},{"n":"춘천기계공업고등학교","r":"춘천"},{"n":"춘천동원학교","r":"춘천"},{"n":"춘천삼육초등학교","r":"춘천"},{"n":"춘천여자고등학교","r":"춘천"},{"n":"춘천유치원","r":"춘천"},{"n":"춘천중학교","r":"춘천"},{"n":"춘천초등학교","r":"춘천"},{"n":"춘천한샘고등학교","r":"춘천"},{"n":"치악고등학교","r":"원주"},{"n":"치악중학교","r":"원주"},{"n":"치악초등학교","r":"원주"},{"n":"치악초병설유치원","r":"원주"},{"n":"큰나무유치원","r":"원주"},{"n":"태백라온학교","r":"태백"},{"n":"태백초등학교","r":"태백"},{"n":"태봉초등학교","r":"원주"},{"n":"태봉초병설유치원","r":"원주"},{"n":"태사랑유치원","r":"태백"},{"n":"태서초등학교","r":"태백"},{"n":"태장중학교","r":"원주"},{"n":"태장초등학교","r":"원주"},{"n":"태장초병설유치원","r":"원주"},{"n":"토성초등학교","r":"철원"},{"n":"통리초등학교","r":"태백"},{"n":"통리초병설유치원","r":"태백"},{"n":"퇴계중학교","r":"춘천"},{"n":"퇴계초등학교","r":"춘천"},{"n":"퇴계초병설유치원","r":"춘천"},{"n":"팔렬고등학교","r":"홍천"},{"n":"팔렬중학교","r":"홍천"},{"n":"평원중학교","r":"원주"},{"n":"평원초등학교","r":"원주"},{"n":"평창고등학교","r":"평창"},{"n":"평창중학교","r":"평창"},{"n":"평창초등학교","r":"평창"},{"n":"평창초병설유치원","r":"평창"},{"n":"포남초등학교","r":"강릉"},{"n":"푸른자연유치원","r":"원주"},{"n":"풍산초등학교","r":"화천"},{"n":"풍산초병설유치원","r":"화천"},{"n":"프라임상상유치원","r":"원주"},{"n":"프렌비숲유치원","r":"강릉"},{"n":"하남초등학교","r":"인제"},{"n":"하남초병설유치원","r":"인제"},{"n":"하늘내린유치원","r":"인제"},{"n":"하늘빛유치원","r":"태백"},{"n":"하랑중학교","r":"동해"},{"n":"하슬라유치원","r":"강릉"},{"n":"하슬라중학교","r":"강릉"},{"n":"하장중학교","r":"삼척"},{"n":"하장초등학교","r":"삼척"},{"n":"학림유치원","r":"원주"},{"n":"학성유치원","r":"원주"},{"n":"학성중학교","r":"원주"},{"n":"학성초등학교","r":"원주"},{"n":"한강유치원","r":"원주"},{"n":"한계초등학교","r":"인제"},{"n":"한계초병설유치원","r":"인제"},{"n":"한국소방마이스터고등학교","r":"영월"},{"n":"한국항공고등학교","r":"태백"},{"n":"한남초등학교","r":"속초양양"},{"n":"한남초병설유치원","r":"속초양양"},{"n":"한림유치원","r":"춘천"},{"n":"한서중학교","r":"홍천"},{"n":"한서초등학교","r":"홍천"},{"n":"한서초병설유치원","r":"홍천"},{"n":"한솔초등학교","r":"강릉"},{"n":"한아름유치원","r":"원주"},{"n":"한전초등학교","r":"양구"},{"n":"한전초병설유치원","r":"양구"},{"n":"함백고등학교","r":"정선"},{"n":"함백중학교","r":"정선"},{"n":"함백초등학교","r":"정선"},{"n":"함백초병설유치원","r":"정선"},{"n":"함태중학교","r":"태백"},{"n":"함태초등학교","r":"태백"},{"n":"해밀학교","r":"홍천"},{"n":"해안중학교","r":"양구"},{"n":"해안초등학교","r":"양구"},{"n":"해안초병설유치원","r":"양구"},{"n":"해오름유치원","r":"동해"},{"n":"현남중학교","r":"속초양양"},{"n":"현북중학교","r":"속초양양"},{"n":"현북초등학교","r":"속초양양"},{"n":"현북초병설유치원","r":"속초양양"},{"n":"현성초등학교","r":"속초양양"},{"n":"현성초병설유치원","r":"속초양양"},{"n":"현천고등학교","r":"횡성"},{"n":"협신초등학교","r":"홍천"},{"n":"협신초병설유치원","r":"홍천"},{"n":"호명초등학교","r":"평창"},{"n":"호명초병설유치원","r":"평창"},{"n":"호반초등학교","r":"춘천"},{"n":"호산초등학교","r":"삼척"},{"n":"호산초병설유치원","r":"삼척"},{"n":"호저중학교","r":"원주"},{"n":"호저초등학교","r":"원주"},{"n":"호저초병설유치원","r":"원주"},{"n":"홍천고등학교","r":"홍천"},{"n":"홍천남산유치원","r":"홍천"},{"n":"홍천농업고등학교","r":"홍천"},{"n":"홍천여자고등학교","r":"홍천"},{"n":"홍천여자중학교","r":"홍천"},{"n":"홍천유치원","r":"홍천"},{"n":"홍천중학교","r":"홍천"},{"n":"홍천초등학교","r":"홍천"},{"n":"화계초등학교","r":"홍천"},{"n":"화계초병설유치원","r":"홍천"},{"n":"화동중학교","r":"정선"},{"n":"화동초등학교","r":"정선"},{"n":"화동초병설유치원","r":"정선"},{"n":"화성유치원","r":"횡성"},{"n":"화천고등학교","r":"화천"},{"n":"화천유치원","r":"화천"},{"n":"화천정산고등학교","r":"화천"},{"n":"화천중학교","r":"화천"},{"n":"화천초등학교","r":"화천"},{"n":"화촌중학교","r":"홍천"},{"n":"화촌초등학교","r":"홍천"},{"n":"황둔중학교","r":"원주"},{"n":"황둔초등학교","r":"원주"},{"n":"황둔초병설유치원","r":"원주"},{"n":"황지고등학교","r":"태백"},{"n":"황지정보산업고등학교","r":"태백"},{"n":"황지중앙초등학교","r":"태백"},{"n":"황지중학교","r":"태백"},{"n":"황지초등학교","r":"태백"},{"n":"회룡초등학교","r":"속초양양"},{"n":"회룡초병설유치원","r":"속초양양"},{"n":"횡계초등학교","r":"평창"},{"n":"횡계초병설유치원","r":"평창"},{"n":"횡성고등학교","r":"횡성"},{"n":"횡성여자고등학교","r":"횡성"},{"n":"횡성중학교","r":"횡성"},{"n":"횡성초등학교","r":"횡성"},{"n":"횡성초병설유치원","r":"횡성"},{"n":"효제초등학교","r":"춘천"},{"n":"후평숲속유치원","r":"춘천"},{"n":"후평중학교","r":"춘천"},{"n":"후평초등학교","r":"춘천"},{"n":"흥양초등학교","r":"원주"},{"n":"흥양초병설유치원","r":"원주"},{"n":"흥업초등학교","r":"원주"},{"n":"흥업초병설유치원","r":"원주"},{"n":"흥전초등학교","r":"삼척"}];
</script>

<script>
  (function () {
    "use strict";

    /* =========================
       전역 상태
       ========================= */
    const state = {
      files: [],
      xlsxReady: false,
      recordsRaw: [],
      records: [],
      aggregates: {
        kpi: {},
        regionRows: [],
        instRows: [],
      },
      schoolMeta: new Map(), // baseName -> { hasAttached: boolean }
      stats: {
        skippedInvalidName: 0,
        correctedYangToYanggu: 0,
        appliedRegulationFallback: 0,
      },

      maskNames: false,

      // “현재 명단 다운로드”에서 사용할 최근 조회 결과(없으면 전체)
      currentExport: {
        title: "현재 조회 결과",
        rows: [],
      },
    };

    /* =========================
       상수/룰
       ========================= */

    const REGION_18 = [
      "강원도교육청",
      "강릉",
      "고성",
      "동해",
      "삼척",
      "속초양양",
      "양구",
      "영월",
      "원주",
      "인제",
      "정선",
      "철원",
      "춘천",
      "태백",
      "평창",
      "홍천",
      "화천",
      "횡성",
    ];
    const REGION_17 = REGION_18.filter((r) => r !== "강원도교육청");

    const LOCAL_GOV_SERIES = [
      "지방교육행정",
      "지방시설관리",
      "지방시설",
      "지방전산",
      "지방사무운영",
      "지방운전",
      "지방식품위생",
      "지방조리",
      "지방사서",
      "지방공업",
    ];

    const EDU_LABOR_JOBS = Array.from(
      new Set([
        "치료사",
        "장애영아지도사",
        "장애유아지도사",
        "직업지도사",
        "유치원방과후교육사",
        "학교도서관사서",
        "기숙사생활지도원",
        "전문상담사",
        "영양사",
        "교육복지사",
        "평생교육사",
        "사회복지사",
        "진로교육사",
        "학교도서관실무사",
        "특수교육지도사",
        "건강실무사",
        "조리사",
        "조리실무사",
        "교무행정사",
        "발명실무원",
        "통학차량운전원",
        "통학지도원",
        "늘봄학교전담사",
        "초등돌봄전담사",
        "방과후전담사",
        "임상심리사",
        "대안교육전문가",
        "학습클리닉전문가",
        "학부모지원전문가",
        "진학전문지원관",
        "학교운동부지도자",
        "교육지도사",
        "방과후학교지원가",
        "구육성회직원",
      ])
    );

    const TEACHER_CATEGORIES = [
      "유치원교사",
      "초등학교교사",
      "중등학교교사",
      "특수학교교사",
      "실기교사",
      "보건교사",
      "사서교사",
      "전문상담교사",
      "영양교사",
      "교장",
      "교감",
      "원장",
      "원감",
      "수석교사",
      "교사",
    ];

    const GOV_GRADE_ENDINGS = ["서기보시보", "서기보", "서기", "주사보", "주사", "서기관", "사무관"];

    const INTERNAL_OFFICE_DEPTS = [
      "감사관",
      "공보담당관",
      "정책국",
      "교육국",
      "행정국",
      "정책기획과",
      "미래교육과",
      "안전복지과",
      "교육지원과",
      "유초등교육과",
      "중등교육과",
      "인성생활교육과",
      "문화체육특수교육과",
      "총무과",
      "예산과",
      "행정과",
      "시설과",
      "학교지원과",
      "미래학교지원과",
    ];

    const DIRECT_INST_CANON = [
      { match: "교육연구원", canon: "강원특별자치도교육청 교육연구원", region: "춘천" },
      { match: "유아교육원", canon: "강원특별자치도교육청 유아교육원", region: "춘천" },
      { match: "학생교육원", canon: "강원특별자치도교육청 학생교육원", region: "춘천" },
      { match: "춘천교육문화관", canon: "강원특별자치도교육청 춘천교육문화관", region: "춘천" },

      { match: "교육연수원", canon: "강원특별자치도교육청 교육연수원", region: "강릉" },
      { match: "사임당교육원", canon: "강원특별자치도교육청 사임당교육원", region: "강릉" },
      { match: "교직원수련원", canon: "강원특별자치도교육청 교직원수련원", region: "강릉" },
      { match: "강릉교육문화관", canon: "강원특별자치도교육청 강릉교육문화관", region: "강릉" },

      { match: "교육과학정보원", canon: "강원특별자치도교육청 교육과학정보원", region: "원주" },
      { match: "원주교육문화관", canon: "강원특별자치도교육청 원주교육문화관", region: "원주" },

      { match: "진로교육원", canon: "강원특별자치도교육청 진로교육원", region: "속초양양" },
      { match: "속초교육문화관", canon: "강원특별자치도교육청 속초교육문화관", region: "속초양양" },

      { match: "국제교육원", canon: "강원특별자치도교육청 국제교육원", region: "철원" },
      { match: "통일교육원", canon: "강원특별자치도교육청 통일교육원", region: "속초양양" },

      { match: "삼척교육문화관", canon: "강원특별자치도교육청 삼척교육문화관", region: "삼척" },
    ];

    const RETIRE_KW = ["퇴직", "정년", "의원면직", "면직", "해임", "파면", "사망"];
    const PLACEHOLDER_KW = ["교육장이 지정", "부서 근무를 명", "부서근무를명", "교육장이지정"];
    const DISPATCH_KW = ["파견", "파견연장", "파견 복귀", "파견복귀"];
    const LEAVE_KW = ["휴직", "복직", "육아휴직", "질병휴직", "직권휴직", "복귀", "복귀명"];
    const REGULATION_KW = ["조례", "시행규칙"];

    /* =========================
       DOM
       ========================= */
    const $ = (sel) => document.querySelector(sel);

    const el = {
      dropzone: $("#dropzone"),
      fileInput: $("#fileInput"),
      btnAddFiles: $("#btnAddFiles"),
      btnResetFiles: $("#btnResetFiles"),
      btnAnalyze: $("#btnAnalyze"),
      fileCount: $("#fileCount"),
      fileDetailsSummary: $("#fileDetailsSummary"),
      fileTableBody: $("#fileTableBody"),
      xlsxBadge: $("#xlsxBadge"),

      statusTitle: $("#statusTitle"),
      progressFill: $("#progressFill"),
      statusDetail: $("#statusDetail"),
      statusExtra: $("#statusExtra"),
      statusBox: $("#statusBox"),

      btnDownloadAll: $("#btnDownloadAll"),
      btnDownloadFiltered: $("#btnDownloadFiltered"),

      kpiGrid: $("#kpiGrid"),
      regionSearch: $("#regionSearch"),
      instSearch: $("#instSearch"),

      regionTableBody: $("#regionTableBody"),
      instTableBody: $("#instTableBody"),
      regionTableCount: $("#regionTableCount"),
      instTableCount: $("#instTableCount"),

      maskNameToggle: $("#maskNameToggle"),

      entityKind: $("#entityKind"),
      entitySelectSearch: $("#entitySelectSearch"),
      entityName: $("#entityName"),
      personnelType: $("#personnelType"),
      jobFilter: $("#jobFilter"),
      govGradeFilter: $("#govGradeFilter"),
      btnExportEntityDetailXlsx: $("#btnExportEntityDetailXlsx"),

      entityOutPanel: $("#entityOutPanel"),
      entityInPanel: $("#entityInPanel"),
      entityUnknownDetails: $("#entityUnknownDetails"),
      entityUnknownSummary: $("#entityUnknownSummary"),
      entityUnknownPanel: $("#entityUnknownPanel"),
      entityOutCount: $("#entityOutCount"),
      entityInCount: $("#entityInCount"),

      officeMode: $("#officeMode"),
      regionPick: $("#regionPick"),
      regionPersonnelType: $("#regionPersonnelType"),
      regionGovGradeFilter: $("#regionGovGradeFilter"),

      regionOutPanel: $("#regionOutPanel"),
      regionInPanel: $("#regionInPanel"),
      regionStayPanel: $("#regionStayPanel"),
      regionUnknownDetails: $("#regionUnknownDetails"),
      regionUnknownSummary: $("#regionUnknownSummary"),
      regionUnknownPanel: $("#regionUnknownPanel"),
      regionOutCount: $("#regionOutCount"),
      regionInCount: $("#regionInCount"),
      regionStayCount: $("#regionStayCount"),

      btnExportRegionView: $("#btnExportRegionView"),

      toTopBtn: $("#toTopBtn"),
      logBox: $("#logBox"),
    };

    /* =========================
       로그
       ========================= */
    function log(msg) {
      const time = new Date();
      const t = time.toLocaleTimeString("ko-KR", { hour12: false });
      el.logBox.textContent += `[${t}] ${msg}\n`;
      el.logBox.scrollTop = el.logBox.scrollHeight;
    }

    /* =========================
       유틸
       ========================= */
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function maskSecondChar(name) {
      const s = String(name ?? "");
      if (s.length < 2) return s;
      return s.slice(0, 1) + "*" + s.slice(2);
    }

    function normalizeText(v) {
      if (v === null || v === undefined) return "";
      if (v instanceof Date) {
        const y = v.getFullYear();
        const m = String(v.getMonth() + 1).padStart(2, "0");
        const d = String(v.getDate()).padStart(2, "0");
        return `${y}.${m}.${d}`;
      }
      const s = String(v);
      return s.replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim();
    }

    function normalizeKey(s) {
      return normalizeText(s).replace(/\s+/g, "").replace(/[·•◆□○●]/g, "").trim();
    }

    function normalizeSchoolKey(s) {
      return normalizeText(s)
        .replace(/\s+/g, "")
        .replace(/[·•◆□○●()（）\[\]{}<>《》"']/g, "")
        .trim();
    }

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return "";
      const units = ["B", "KB", "MB", "GB"];
      let i = 0;
      let v = bytes;
      while (v >= 1024 && i < units.length - 1) {
        v /= 1024;
        i++;
      }
      return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    function sleep(ms) {
      return new Promise((r) => setTimeout(r, ms));
    }

    function setProgress(title, percent, detail = "", extra = "") {
      el.statusTitle.textContent = title;
      el.progressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
      el.statusDetail.textContent = detail || `${Math.round(percent)}%`;
      el.statusExtra.textContent = extra || "";
    }

    function setStatusBox(kind, html) {
      const cls = kind === "warn" ? "warn" : kind === "ok" ? "ok" : "";
      el.statusBox.className = cls;
      el.statusBox.innerHTML = html || "";
    }

    function scrollToId(id) {
      const target = document.getElementById(id);
      if (!target) return;
      target.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function canonicalRegionName(region) {
      const r = normalizeText(region);
      if (!r) return "";
      if (r.includes("속초") || r.includes("양양") || r.includes("속초양양")) return "속초양양";
      if (r === "양") {
        state.stats.correctedYangToYanggu += 1;
        return "양구";
      }
      return r;
    }

    function displayInstName(name) {
      if (!name) return "";
      if (name === "강원도교육청") return "강원도교육청(본청)";
      return name;
    }

    /* =========================
       학교 마스터(내장)
       ========================= */
    const SCHOOL_MASTER = (function buildSchoolMaster() {
      const baseRegion = new Map(); // baseName -> region
      const variants = new Map(); // normalizedKey -> baseName

      for (const row of GW_SCHOOL_MASTER_ROWS) {
        const n = row.n;
        const r = row.r;
        const base = n.replace(/병설유치원/g, "").trim();

        if (!baseRegion.has(base)) baseRegion.set(base, r);

        // 주요 변형 키 등록
        const keys = new Set();
        keys.add(normalizeSchoolKey(n));
        keys.add(normalizeSchoolKey(base));
        keys.add(normalizeSchoolKey(base.replace(/초등학교/g, "초")));
        keys.add(normalizeSchoolKey(base.replace(/중학교/g, "중")));
        keys.add(normalizeSchoolKey(base.replace(/고등학교/g, "고")));
        for (const k of keys) variants.set(k, base);
      }

      return { baseRegion, variants };
    })();

    function resolveSchoolBaseName(text) {
      const key = normalizeSchoolKey(text);
      if (!key) return "";
      return SCHOOL_MASTER.variants.get(key) || "";
    }

    function isSchoolLike(text) {
      const t = normalizeText(text);
      return t.includes("초등") || t.includes("중학") || t.includes("고등") || t.includes("유치원") || t.includes("학교") || t.includes("분교");
    }

    function normalizeOrgText(s) {
      let t = normalizeText(s);
      if (!t) return "";

      // 괄호/특수괄호 내용 제거
      t = t.replace(/\([^)]*\)/g, "");
      t = t.replace(/（[^）]*）/g, "");
      t = t.replace(/\[[^\]]*\]/g, "");
      t = t.replace(/【[^】]*】/g, "");
      t = t.replace(/《[^》]*》/g, "");

      // 병설유치원 문구 통일
      t = t.replace(/병설 유치원/g, "병설유치원").replace(/병설유치원/g, "병설유치원");

      // "및 병설유치원" 형태 정리
      t = t.replace(/\s+및\s+병설유치원/g, " 및 병설유치원");

      return t.replace(/\s+/g, " ").trim();
    }

    function isOfficeDept(text) {
      const t = normalizeText(text);
      if (!t) return false;
      return INTERNAL_OFFICE_DEPTS.some((d) => t.includes(d));
    }

    function regionHintFromFileName(fileName) {
      const n = normalizeText(fileName);
      if (!n) return "";
      if (n.includes("속초") || n.includes("양양") || n.includes("속초양양")) return "속초양양";
      for (const r of REGION_17) {
        if (r === "속초양양") continue;
        if (n.includes(r)) return r;
      }
      return "";
    }

    function detectEntity(orgText, fileRegionHint) {
      const org = normalizeText(orgText);
      if (!org) return { kind: "unknown", name: "" };

      // 1) 직접기관 캐논
      for (const d of DIRECT_INST_CANON) {
        if (org.includes(d.match)) return { kind: "inst", name: d.canon, region: d.region };
      }

      // 2) 교육청/지원청
      if (org.includes("강원특별자치도교육청") || org.includes("강원도교육청") || org.includes("도교육청")) {
        // 본청 부서
        if (isOfficeDept(org)) return { kind: "inst", name: "강원도교육청", region: "강원도교육청" };
        // 지원기관/직속기관은 위에서 캐논 처리
        return { kind: "inst", name: "강원도교육청", region: "강원도교육청" };
      }

      if (org.includes("교육지원청")) {
        // 예: "강릉교육지원청"
        const m = org.match(/([가-힣]+)교육지원청/);
        const region = m ? canonicalRegionName(m[1]) : "";
        const name = m ? `${m[1]}교육지원청` : "교육지원청";
        return { kind: "inst", name, region: region || fileRegionHint || "" };
      }

      // 3) 학교(마스터 매칭)
      const baseName = resolveSchoolBaseName(org);
      if (baseName) return { kind: "school", baseName };

      // 4) 기타 기관
      if (org.includes("교육문화관") || org.includes("교육연수원") || org.includes("교육연구원") || org.includes("교육원") || org.includes("도서관")) {
        return { kind: "inst", name: org, region: fileRegionHint || "" };
      }

      // 5) fallback: 학교처럼 보이면 baseName 힌트
      if (isSchoolLike(org)) {
        const key = normalizeSchoolKey(org);
        const b = SCHOOL_MASTER.variants.get(key) || "";
        if (b) return { kind: "school", baseName: b };
      }

      return { kind: "unknown", name: org };
    }

    function inferRegionFromText(text, fileRegionHint) {
      const s = normalizeText(text);
      if (!s) return fileRegionHint || "";

      const compact = s.replace(/\s+/g, "");
      const compact2 = compact.replace(/[()（）\[\]{}<>《》"']/g, "");

      // 속초/양양 통합 우선
      if (compact2.includes("속초") || compact2.includes("양양") || compact2.includes("속초양양")) return "속초양양";

      // 지역명 포함 여부
      for (const r of REGION_17) {
        if (r === "속초양양") continue;
        if (compact2.includes(r)) return r;
      }

      // 혹시 "양"이 나오면 양구로 교정
      if (compact2 === "양") {
        state.stats.correctedYangToYanggu += 1;
        return "양구";
      }

      return fileRegionHint || "";
    }

    function regionFromSchoolEntity(ent) {
      if (!ent || ent.kind !== "school" || !ent.baseName) return "";
      return SCHOOL_MASTER.baseRegion.get(ent.baseName) || "";
    }

    function recordHasKeywordText(rec, kwList) {
      const hay = normalizeKey(`${rec.action} ${rec.newOrg} ${rec.newRank} ${rec.curOrg} ${rec.curRank}`);
      return kwList.some((k) => hay.includes(normalizeKey(k)));
    }

    function isRetire(rec) {
      return recordHasKeywordText(rec, RETIRE_KW);
    }

    function isPlaceholder(rec) {
      return recordHasKeywordText(rec, PLACEHOLDER_KW);
    }

    function isLocalGovByRank(text) {
      const t = normalizeKey(text);
      if (!t) return false;
      if (t.startsWith("지방")) return true;
      if (t.includes("지방")) return true;
      return GOV_GRADE_ENDINGS.some((end) => t.endsWith(normalizeKey(end)));
    }

    function localGovSeriesFromRank(text) {
      const t = normalizeText(text).replace(/\s+/g, "");
      if (!t) return "지방교육행정";

      if (t.includes("지방시설관리")) return "지방시설관리";
      if (t.includes("지방시설")) return "지방시설";
      if (t.includes("지방전산")) return "지방전산";
      if (t.includes("지방사무운영")) return "지방사무운영";
      if (t.includes("지방운전")) return "지방운전";
      if (t.includes("지방식품위생")) return "지방식품위생";
      if (t.includes("지방조리")) return "지방조리";
      if (t.includes("지방사서")) return "지방사서";
      if (t.includes("지방공업")) return "지방공업";

      return "지방교육행정";
    }

    function stripBracketContents(text) {
      let s = normalizeText(text);
      if (!s) return "";
      // 괄호/대괄호/특수괄호 내용 제거(판정 방해 제거)
      s = s.replace(/\([^)]*\)/g, "");
      s = s.replace(/（[^）]*）/g, "");
      s = s.replace(/\[[^\]]*\]/g, "");
      s = s.replace(/\{[^}]*\}/g, "");
      s = s.replace(/<[^>]*>/g, "");
      s = s.replace(/《[^》]*》/g, "");
      s = s.replace(/【[^】]*】/g, "");
      return s;
    }

    function extractGovGradeFromText(text) {
      const s0 = stripBracketContents(text);
      if (!s0) return "";

      const compact = String(s0).replace(/[\s\/]/g, "");
      if (compact.startsWith("지방")) {
        for (const end of GOV_GRADE_ENDINGS) {
          if (compact.endsWith(end)) return end;
        }
      }

      const tokens = s0
        .replace(/[\/·•]/g, " ")
        .split(/\s+/)
        .filter(Boolean);

      for (const tok of tokens) {
        const t = String(tok || "").replace(/[\s\/\.,]/g, "");
        if (!t) continue;
        if (!t.startsWith("지방")) continue;
        for (const end of GOV_GRADE_ENDINGS) {
          if (t.endsWith(end)) return end;
        }
      }
      return "";
    }

    function detectGovGrade(rec) {
      const a = extractGovGradeFromText(rec.newRank);
      if (a) return a;
      const b = extractGovGradeFromText(rec.curRank);
      if (b) return b;
      const c = extractGovGradeFromText(rec.jobRaw);
      return c || "";
    }

    function detectPersonnelType(rec) {
      const mix = `${rec.newRank} ${rec.curRank} ${rec.jobRaw} ${rec.fileName} ${rec.sheetName}`;
      const mk = normalizeKey(mix);

      if (isLocalGovByRank(mix)) return "지방공무원";

      if (mk.includes("교육공무직") || EDU_LABOR_JOBS.some((j) => mk.includes(normalizeKey(j)))) return "교육공무직";

      if (mk.includes("교육공무원") || mk.includes("교사") || mk.includes("교감") || mk.includes("교장") || mk.includes("원장") || mk.includes("원감"))
        return "교육공무원";

      return "기타";
    }

    function detectJobKey(rec) {
      const t = rec.personnelType;

      if (t === "지방공무원") {
        return localGovSeriesFromRank(`${rec.newRank} ${rec.curRank}`);
      }

      if (t === "교육공무직") {
        const sheet = normalizeText(rec.sheetName);
        const foundBySheet = EDU_LABOR_JOBS.find((j) => normalizeKey(sheet) === normalizeKey(j));
        if (foundBySheet) return foundBySheet;

        const mix = normalizeKey(`${rec.newRank} ${rec.curRank} ${rec.action} ${rec.jobRaw}`);
        const found = EDU_LABOR_JOBS.find((j) => mix.includes(normalizeKey(j)));
        return found || normalizeText(rec.newRank) || normalizeText(rec.curRank) || "기타";
      }

      if (t === "교육공무원") {
        const mix = normalizeKey(`${rec.newRank} ${rec.curRank} ${rec.jobRaw} ${rec.sheetName} ${rec.fileName}`);
        if (mix.includes("유치원") && mix.includes("교사")) return "유치원교사";
        if (mix.includes("초등") && mix.includes("교사")) return "초등학교교사";
        if (mix.includes("중등") && mix.includes("교사")) return "중등학교교사";
        if (mix.includes("특수") && mix.includes("교사")) return "특수학교교사";
        if (mix.includes("실기")) return "실기교사";
        if (mix.includes("보건교사")) return "보건교사";
        if (mix.includes("사서교사")) return "사서교사";
        if (mix.includes("전문상담교사") || mix.includes("상담교사")) return "전문상담교사";
        if (mix.includes("영양교사")) return "영양교사";
        if (mix.includes("교감")) return "교감";
        if (mix.includes("교장")) return "교장";
        if (mix.includes("원감")) return "원감";
        if (mix.includes("원장")) return "원장";
        if (mix.includes("수석")) return "수석교사";
        if (mix.includes("교사")) return "교사";
        return normalizeText(rec.newRank) || normalizeText(rec.curRank) || "기타";
      }

      return normalizeText(rec.newRank) || normalizeText(rec.curRank) || "기타";
    }

    function fillMergedCells(sheet) {
      const merges = sheet["!merges"] || [];
      if (!merges.length) return;

      for (const m of merges) {
        const startRow = m.s.r;
        const endRow = m.e.r;
        const startCol = m.s.c;
        const endCol = m.e.c;

        const startAddr = XLSX.utils.encode_cell({ r: startRow, c: startCol });
        const baseCell = sheet[startAddr];
        const v = baseCell ? baseCell.v : "";

        for (let r = startRow; r <= endRow; r++) {
          for (let c = startCol; c <= endCol; c++) {
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!sheet[addr]) sheet[addr] = { t: "s", v };
          }
        }
      }
    }

    function applyRegulationFallback(rec) {
      // "조례/시행규칙"이 발령/임용 쪽에 섞여 있으면 newOrg를 curOrg로 대체
      const nk = normalizeKey(rec.newOrg);
      const mk = normalizeKey(rec.action);
      const rk = normalizeKey(rec.newRank);

      const isReg = (s) => REGULATION_KW.some((k) => normalizeKey(s).includes(normalizeKey(k)));

      if ((isReg(nk) || isReg(mk) || isReg(rk)) && rec.curOrg && !rec.newOrg) {
        rec.newOrg = rec.curOrg;
        state.stats.appliedRegulationFallback += 1;
      }
    }

    function extractRecordsFromSheet(rows, meta) {
      const out = [];
      if (!rows || !rows.length) return out;

      // 헤더 탐색(최대한 관대하게)
      // 기대 컬럼: 성명 / 발령 / 현임용 / 구분 / 비고(직렬 등)
      // 기존 구조 유지: 표준화된 파싱

      for (let r = 0; r < rows.length; r++) {
        const row = rows[r] || [];
        const line = row.map((v) => normalizeText(v));

        // 빈줄 스킵
        if (line.every((v) => !v)) continue;

        // 성명 후보
        const name = normalizeText(line[0] || "");
        if (!name || name.length < 2) {
          // 일부 파일에서 1열이 번호일 수 있음: 간단히 스킵
          continue;
        }
        if (/\d/.test(name)) {
          state.stats.skippedInvalidName += 1;
          continue;
        }

        // 나머지 컬럼들: 최대한 원본 구조에 맞추어 묶기
        const curOrgParts = [];
        const curRankParts = [];
        const newOrgParts = [];
        const newRankParts = [];
        const actionParts = [];
        const jobRawParts = [];

        // 행 전체 스캔
        for (let c = 1; c < line.length; c++) {
          const v = line[c];
          if (!v) continue;

          const k = normalizeKey(v);
          // 추정 규칙(기존 코드 스타일 유지)
          if (k.includes("현") && (k.includes("소속") || k.includes("근무"))) curOrgParts.push(v);
          else if (k.includes("현") && (k.includes("직") || k.includes("급") || k.includes("직종"))) curRankParts.push(v);
          else if (k.includes("발령") && (k.includes("소속") || k.includes("근무"))) newOrgParts.push(v);
          else if (k.includes("발령") && (k.includes("직") || k.includes("급") || k.includes("직종"))) newRankParts.push(v);
          else if (k.includes("구분") || k.includes("비고") || k.includes("발령구분")) actionParts.push(v);
          else jobRawParts.push(v);
        }

        const rec = {
          id: `${meta.fileName}__${meta.sheetName}__${r + 1}`,
          fileName: meta.fileName || "",
          sheetName: meta.sheetName || "",
          rowIndex: r + 1,

          name,
          nameKey: normalizeKey(name),

          newRank: normalizeText(newRankParts.join(" / ")),
          newOrg: normalizeText(newOrgParts.join(" ")),
          curRank: normalizeText(curRankParts.join(" / ")),
          curOrg: normalizeText(curOrgParts.join(" ")),
          action: normalizeText(actionParts.join(" / ")),
          jobRaw: normalizeText(jobRawParts.join(" / ")),

          fileRegionHint: meta.fileRegionHint || "",
        };

        // ✅ 학교 약칭/병설 표기 정규화(텍스트 단계)
        rec.curOrg = normalizeOrgText(rec.curOrg);
        rec.newOrg = normalizeOrgText(rec.newOrg);

        // ✅ 조례/시행규칙이 발령/임용 쪽에 있으면 newOrg를 curOrg로 대체
        applyRegulationFallback(rec);

        // 엔티티/지역 추정
        rec.newEntity = detectEntity(rec.newOrg, rec.fileRegionHint);
        rec.curEntity = detectEntity(rec.curOrg, rec.fileRegionHint);

        rec.newRegion = canonicalRegionName(inferRegionFromText(rec.newOrg, rec.fileRegionHint));
        rec.curRegion = canonicalRegionName(inferRegionFromText(rec.curOrg, rec.fileRegionHint));

        // ✅ 학교는 "전체 학교 목록" 주소 기반 시군구로 덮어쓰기(고등학교 포함)
        const srN = regionFromSchoolEntity(rec.newEntity);
        if (srN) rec.newRegion = srN;
        const srC = regionFromSchoolEntity(rec.curEntity);
        if (srC) rec.curRegion = srC;

        rec.personnelType = detectPersonnelType(rec);
        rec.govGrade = rec.personnelType === "지방공무원" ? detectGovGrade(rec) : "";
        rec.isRetire = isRetire(rec);
        rec.isPlaceholder = isPlaceholder(rec);
        rec.jobKey = detectJobKey(rec);

        out.push(rec);
      }

      return out;
    }

    function qualityScore(rec) {
      let s = 0;
      if (rec.name) s += 10;
      if (rec.curOrg) s += 8;
      if (rec.newOrg) s += 10;
      if (!rec.isPlaceholder) s += 30;
      if (rec.newEntity && rec.newEntity.kind !== "unknown") s += 8;
      if (rec.curEntity && rec.curEntity.kind !== "unknown") s += 5;
      if (rec.isPlaceholder) s -= 40;
      if (rec.newEntity && rec.newEntity.kind === "school") s += 4;
      if (rec.curEntity && rec.curEntity.kind === "school") s += 2;
      return s;
    }

    function dedupeRecords(records) {
      const best = new Map();

      for (const rec of records) {
        if (!rec || !rec.nameKey) continue;

        // placeholder는 강하게 제끼되, 대체가 없으면 남길 수 있도록 점수로 처리
        const curKey = normalizeKey(rec.curOrg);
        const newKey = normalizeKey(rec.newOrg);
        const baseKey = curKey ? `${rec.nameKey}|${rec.personnelType}|CUR|${curKey}` : `${rec.nameKey}|${rec.personnelType}|NEW|${newKey}`;

        const prev = best.get(baseKey);
        if (!prev) {
          best.set(baseKey, rec);
          continue;
        }
        if (qualityScore(rec) > qualityScore(prev)) best.set(baseKey, rec);
      }

      return Array.from(best.values());
    }

    function buildSchoolMeta(records) {
      const meta = new Map(); // baseName -> { hasAttached }
      for (const r of records) {
        const ent = r.curEntity?.kind === "school" ? r.curEntity : r.newEntity;
        if (!ent || ent.kind !== "school") continue;
        const base = ent.baseName;
        if (!base) continue;

        if (!meta.has(base)) meta.set(base, { hasAttached: false });
        const m = meta.get(base);
        const orgText = `${r.curOrg} ${r.newOrg}`;
        if (orgText.includes("병설유치원")) m.hasAttached = true;
      }
      return meta;
    }

    function computeAggregates() {
      const kpi = {
        total: state.records.length,
        retire: 0,
        inOnly: 0,
        outOnly: 0,
        move: 0,
      };

      const regionAgg = new Map(); // region -> { instSet, incoming, outgoing, stay, retire, persons }
      const instAgg = new Map(); // region|inst -> { incoming, outgoing, persons }

      const personKey = (rec) => rec.nameKey + "|" + rec.personnelType + "|" + normalizeKey(rec.curOrg) + "|" + normalizeKey(rec.newOrg);

      const seenPeople = new Set();

      for (const rec of state.records) {
        const pk = personKey(rec);
        if (seenPeople.has(pk)) continue;
        seenPeople.add(pk);

        const curR = rec.curRegion || "";
        const newR = rec.newRegion || "";
        const curInst = rec.curEntity?.kind === "inst" ? rec.curEntity.name : rec.curEntity?.kind === "school" ? rec.curEntity.baseName : "";
        const newInst = rec.newEntity?.kind === "inst" ? rec.newEntity.name : rec.newEntity?.kind === "school" ? rec.newEntity.baseName : "";

        const curRegion = curR || newR || "";
        const newRegion = newR || curR || "";

        const isSameRegion = curRegion && newRegion && curRegion === newRegion;

        // KPI 계산
        if (rec.isRetire) kpi.retire += 1;

        if (!curRegion && newRegion) kpi.inOnly += 1;
        else if (curRegion && !newRegion) kpi.outOnly += 1;
        else if (curRegion && newRegion && !rec.isRetire) {
          if (curRegion === newRegion) kpi.move += 1;
          else {
            kpi.inOnly += 1;
            kpi.outOnly += 1;
          }
        }

        // 지역 요약
        const addRegion = (region) => {
          if (!region) return;
          if (!regionAgg.has(region)) regionAgg.set(region, { instSet: new Set(), incoming: 0, outgoing: 0, stay: 0, retire: 0, persons: 0 });
          regionAgg.get(region).persons += 1;
        };

        // 인사 규칙: 출발/도착
        if (curRegion) addRegion(curRegion);
        if (newRegion && newRegion !== curRegion) addRegion(newRegion);

        if (curRegion) {
          if (!regionAgg.has(curRegion)) regionAgg.set(curRegion, { instSet: new Set(), incoming: 0, outgoing: 0, stay: 0, retire: 0, persons: 0 });
          const a = regionAgg.get(curRegion);
          if (curInst) a.instSet.add(curInst);
          if (rec.isRetire) a.retire += 1;
          else if (newRegion && newRegion !== curRegion) a.outgoing += 1;
          else a.stay += 1;
        }

        if (newRegion) {
          if (!regionAgg.has(newRegion)) regionAgg.set(newRegion, { instSet: new Set(), incoming: 0, outgoing: 0, stay: 0, retire: 0, persons: 0 });
          const a = regionAgg.get(newRegion);
          if (newInst) a.instSet.add(newInst);
          if (!rec.isRetire && curRegion !== newRegion) a.incoming += 1;
        }

        // 기관/학교 요약: 현/발령 둘다 반영
        const addInst = (region, instName, incoming, outgoing) => {
          if (!region || !instName) return;
          const key = `${region}||${instName}`;
          if (!instAgg.has(key)) instAgg.set(key, { region, instName, incoming: 0, outgoing: 0, persons: 0 });
          const a = instAgg.get(key);
          a.incoming += incoming;
          a.outgoing += outgoing;
          a.persons += 1;
        };

        if (curRegion && curInst) {
          const outgoing = rec.isRetire ? 0 : newRegion && newRegion !== curRegion ? 1 : 0;
          addInst(curRegion, curInst, 0, outgoing);
        }
        if (newRegion && newInst) {
          const incoming = rec.isRetire ? 0 : curRegion !== newRegion ? 1 : 0;
          addInst(newRegion, newInst, incoming, 0);
        }
      }

      const regionRows = Array.from(regionAgg.entries())
        .map(([region, a]) => ({
          region,
          instCount: a.instSet.size,
          incoming: a.incoming,
          outgoing: a.outgoing,
          stay: a.stay,
          retire: a.retire,
          persons: a.persons,
        }))
        .sort((a, b) => a.region.localeCompare(b.region, "ko"));

      const instRows = Array.from(instAgg.values()).sort((a, b) => {
        const r = a.region.localeCompare(b.region, "ko");
        if (r !== 0) return r;
        return a.instName.localeCompare(b.instName, "ko");
      });

      state.aggregates = { kpi, regionRows, instRows };
    }

    /* =========================
       파일 업로드 UI
       ========================= */
    function updateAnalyzeBtn() {
      el.btnAnalyze.disabled = !state.files.length || !state.xlsxReady;
      el.btnAnalyze.textContent = state.files.length ? `데이터 분석하기 (${state.files.length}개)` : "데이터 분석하기";
    }

    function renderFileTable() {
      el.fileCount.textContent = `업로드 파일: ${state.files.length}개`;

      if (!state.files.length) {
        el.fileTableBody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center">아직 업로드된 파일이 없습니다.</td></tr>';
        el.fileDetailsSummary.textContent = "업로드된 파일 목록 보기";
        return;
      }

      const rows = state.files
        .map((f) => {
          const hint = regionHintFromFileName(f.name);
          const time = new Date(f._addedAt || Date.now()).toLocaleString("ko-KR");
          return `
            <tr>
              <td>${escapeHtml(f.name)}</td>
              <td>${escapeHtml(formatBytes(f.size))}</td>
              <td>${escapeHtml(hint || "-")}</td>
              <td>${escapeHtml(time)}</td>
            </tr>
          `;
        })
        .join("");

      el.fileTableBody.innerHTML = rows;
      el.fileDetailsSummary.textContent = `업로드된 파일 목록 보기 (${state.files.length}개)`;
    }

    function addFiles(fileList) {
      const arr = Array.from(fileList || []);
      if (!arr.length) return;

      for (const f of arr) {
        if (!f) continue;
        const ext = (f.name || "").toLowerCase();
        if (!ext.endsWith(".xlsx") && !ext.endsWith(".xls") && !ext.endsWith(".csv")) continue;
        f._addedAt = Date.now();
        state.files.push(f);
      }

      renderFileTable();
      updateAnalyzeBtn();
    }

    function resetFiles() {
      state.files = [];
      state.recordsRaw = [];
      state.records = [];
      state.aggregates = { kpi: {}, regionRows: [], instRows: [] };
      state.currentExport = { title: "현재 조회 결과", rows: [] };

      renderFileTable();
      renderEmptyResults();
      updateAnalyzeBtn();
      setStatusBox("", "");
      setProgress("대기 중…", 0, "0%");
      log("초기화 완료");
    }

    /* =========================
       SheetJS 로더(요구사항 유지)
       - CDN 로드 + /static/xlsx.full.min.js fallback
       ========================= */
    async function ensureXlsxReady() {
      if (state.xlsxReady && window.XLSX) return true;

      const loadScript = (src) =>
        new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = true;
          s.onload = () => resolve(true);
          s.onerror = () => reject(new Error("script load failed"));
          document.head.appendChild(s);
        });

      try {
        setProgress("XLSX 라이브러리 로드 중…", 2, "2%");
        await loadScript("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js");
        state.xlsxReady = true;
        return true;
      } catch (e) {
        log("⚠️ CDN 로드 실패 → /static/xlsx.full.min.js fallback 시도");
      }

      try {
        await loadScript("/static/xlsx.full.min.js");
        state.xlsxReady = true;
        return true;
      } catch (e) {
        setStatusBox("warn", "XLSX 라이브러리를 불러오지 못했습니다. 네트워크/정책/경로를 확인해주세요.");
        state.xlsxReady = false;
        return false;
      }
    }

    /* =========================
       렌더링: 결과/대시보드
       ========================= */

    function renderEmptyResults() {
      el.kpiGrid.innerHTML = "";
      el.regionTableBody.innerHTML =
        '<tr><td colspan="7" class="muted" style="text-align:center">아직 집계 결과가 없습니다.</td></tr>';
      el.instTableBody.innerHTML =
        '<tr><td colspan="5" class="muted" style="text-align:center">아직 집계 결과가 없습니다.</td></tr>';
      el.regionTableCount.textContent = "0건";
      el.instTableCount.textContent = "0건";

      el.entityOutPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.entityInPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.entityUnknownPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.entityOutCount.textContent = "0명";
      el.entityInCount.textContent = "0명";
      el.entityUnknownSummary.textContent = "미분류 (0명)";

      el.regionOutPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.regionInPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.regionStayPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.regionUnknownPanel.textContent = "조회 조건을 선택하면 여기에 표시됩니다.";
      el.regionOutCount.textContent = "0명";
      el.regionInCount.textContent = "0명";
      el.regionStayCount.textContent = "0명";
      el.regionUnknownSummary.textContent = "미분류 (0명)";

      el.btnDownloadAll.disabled = true;
      el.btnDownloadFiltered.disabled = true;
      el.btnExportEntityDetailXlsx.disabled = true;
      el.btnExportRegionView.disabled = true;

      el.entitySelectSearch.disabled = true;
    }

    function lockFilters(lock) {
      el.regionSearch.disabled = lock;
      el.instSearch.disabled = lock;

      el.maskNameToggle.disabled = lock;

      el.entityKind.disabled = lock;
      el.entitySelectSearch.disabled = lock;
      el.entityName.disabled = lock;
      el.personnelType.disabled = lock;
      el.jobFilter.disabled = lock;
      el.govGradeFilter.disabled = lock;
      el.btnExportEntityDetailXlsx.disabled = lock;

      el.officeMode.disabled = lock;
      el.regionPick.disabled = lock;
      el.regionPersonnelType.disabled = lock;
      el.regionGovGradeFilter.disabled = lock;
    }

    function renderKpi() {
      const k = state.aggregates.kpi;

      const cards = [
        { label: "전체 인원", value: k.total ?? 0, hint: "중복 제거 후" },
        { label: "전보/이동", value: k.move ?? 0, hint: "강원권 ↔ 강원권" },
        { label: "전입만", value: k.inOnly ?? 0, hint: "강원권 밖 → 강원권" },
        { label: "전출만", value: k.outOnly ?? 0, hint: "강원권 → 강원권 밖" },
        { label: "퇴직", value: k.retire ?? 0, hint: "정년/의원면직 등" },
      ];

      el.kpiGrid.innerHTML = cards
        .map(
          (c, idx) => `
        <div class="kpi" data-kpi="${idx}">
          <div class="label">${escapeHtml(c.label)}</div>
          <div class="value">${Number(c.value || 0).toLocaleString()}</div>
          <div class="hint">${escapeHtml(c.hint || "")}</div>
        </div>
      `
        )
        .join("");

      el.kpiGrid.querySelectorAll(".kpi").forEach((node) => {
        node.addEventListener("click", () => {
          const i = Number(node.getAttribute("data-kpi") || "0");
          // KPI 클릭은 섹션 이동만
          if (i === 0) scrollToId("sec-summary");
          else if (i === 4) scrollToId("sec-entity");
          else scrollToId("sec-entity");
        });
      });
    }

    function renderRegionTable() {
      const q = normalizeText(el.regionSearch.value).toLowerCase();
      const rows = state.aggregates.regionRows.filter((r) => (!q ? true : r.region.toLowerCase().includes(q)));

      el.regionTableCount.textContent = `${rows.length}건`;

      if (!rows.length) {
        el.regionTableBody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center">검색 결과가 없습니다.</td></tr>';
        return;
      }

      el.regionTableBody.innerHTML = rows
        .map(
          (r) => `
          <tr>
            <td>${escapeHtml(r.region)}</td>
            <td class="numeric">${r.instCount}</td>
            <td class="numeric">${r.incoming}</td>
            <td class="numeric">${r.outgoing}</td>
            <td class="numeric">${r.stay}</td>
            <td class="numeric">${r.retire}</td>
            <td class="numeric">${r.persons}</td>
          </tr>
        `
        )
        .join("");
    }

    function renderInstTable() {
      const q = normalizeText(el.instSearch.value).toLowerCase();
      const rows = state.aggregates.instRows.filter((r) => (!q ? true : `${r.region} ${r.instName}`.toLowerCase().includes(q)));

      el.instTableCount.textContent = `${rows.length}건`;

      if (!rows.length) {
        el.instTableBody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center">검색 결과가 없습니다.</td></tr>';
        return;
      }

      el.instTableBody.innerHTML = rows
        .map(
          (r) => `
          <tr>
            <td>${escapeHtml(r.region)}</td>
            <td>${escapeHtml(displayInstName(r.instName))}</td>
            <td class="numeric">${r.incoming}</td>
            <td class="numeric">${r.outgoing}</td>
            <td class="numeric">${r.persons}</td>
          </tr>
        `
        )
        .join("");
    }

    function renderSummary() {
      renderKpi();
      renderRegionTable();
      renderInstTable();

      el.btnDownloadAll.disabled = false;
      el.btnDownloadFiltered.disabled = false;

      el.regionSearch.disabled = false;
      el.instSearch.disabled = false;
    }

    /* =========================
       섹션3(학교/기관) 필터
       ========================= */

    function buildEntityOptions() {
      const schools = Array.from(state.schoolMeta.entries())
        .map(([baseName, meta]) => ({
          value: baseName,
          label: meta.hasAttached ? `${baseName} 및 병설유치원` : baseName,
        }))
        .sort((a, b) => a.label.localeCompare(b.label, "ko"));

      // 기관: records에서 추출
      const instSet = new Set();
      for (const r of state.records) {
        const add = (ent) => {
          if (!ent) return;
          if (ent.kind !== "inst") return;
          if (!ent.name) return;
          instSet.add(ent.name);
        };
        add(r.curEntity);
        add(r.newEntity);
      }

      const insts = Array.from(instSet)
        .map((x) => ({ value: x, label: displayInstName(x) }))
        .sort((a, b) => a.label.localeCompare(b.label, "ko"));

      return { schools, insts };
    }

    function buildPersonnelTypeOptions() {
      const types = new Set(["전체"]);
      for (const r of state.records) {
        if (r.personnelType) types.add(r.personnelType);
      }
      return Array.from(types);
    }

    function buildJobOptions(personnelType) {
      if (personnelType === "지방공무원") return ["전체", ...LOCAL_GOV_SERIES];
      if (personnelType === "교육공무직") return ["전체", ...EDU_LABOR_JOBS.slice().sort((a, b) => a.localeCompare(b, "ko"))];
      if (personnelType === "교육공무원") return ["전체", ...TEACHER_CATEGORIES];

      const s = new Set();
      for (const r of state.records) {
        if (personnelType !== "전체" && r.personnelType !== personnelType) continue;
        if (r.jobKey) s.add(r.jobKey);
        if (s.size > 200) break;
      }
      const arr = Array.from(s).sort((a, b) => a.localeCompare(b, "ko"));
      return ["전체", ...arr];
    }

    function setSelectOptions(selectEl, options, placeholder = "선택") {
      const all = options.map((o) => {
        if (typeof o === "string") return { value: o, label: o };
        return { value: o.value, label: o.label };
      });
      selectEl._allOptions = all;
      selectEl._hasPlaceholder = true;
      selectEl._placeholder = placeholder;

      const html = all.map((o) => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");
      selectEl.innerHTML = `<option value="">${escapeHtml(placeholder)}</option>` + html;
    }

    function setSelectOptionsExact(selectEl, options, defaultValue = "전체") {
      const all = options.map((o) => ({ value: o, label: o }));
      selectEl._allOptions = all;
      selectEl._hasPlaceholder = false;
      selectEl._placeholder = "";

      const html = all.map((o) => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");
      selectEl.innerHTML = html;
      if (defaultValue !== undefined && defaultValue !== null) selectEl.value = defaultValue;
    }

    function applyEntitySelectSearch() {
      if (!el.entitySelectSearch) return;
      const q = normalizeText(el.entitySelectSearch.value).toLowerCase();
      const targets = [el.entityKind, el.entityName, el.personnelType, el.jobFilter, el.govGradeFilter];
      for (const sel of targets) {
        if (!sel || !sel._allOptions) continue;
        const prev = sel.value;

        let list = sel._allOptions;
        if (q) {
          list = list.filter((o) => String(o.label || "").toLowerCase().includes(q));
          if (prev && !list.some((o) => String(o.value) === String(prev))) {
            const keep = sel._allOptions.find((o) => String(o.value) === String(prev));
            if (keep) list = [keep, ...list];
          }
        }

        const html = list.map((o) => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");
        if (sel._hasPlaceholder) {
          const ph = sel._placeholder || "선택";
          sel.innerHTML = `<option value="">${escapeHtml(ph)}</option>` + html;
        } else {
          sel.innerHTML = html;
        }

        if (prev && [...sel.options].some((o) => o.value === prev)) sel.value = prev;
      }
    }

    function initEntityFilters() {
      el.entityKind.disabled = false;
      setSelectOptions(
        el.entityKind,
        [
          { value: "school", label: "학교" },
          { value: "inst", label: "기관" },
        ],
        "선택"
      );
      el.entityKind.value = "";

      el.entitySelectSearch.disabled = false;
      if (!el.entitySelectSearch.value) el.entitySelectSearch.value = "";
      el.entitySelectSearch.oninput = () => applyEntitySelectSearch();

      setSelectOptionsExact(el.govGradeFilter, ["전체", ...GOV_GRADE_ENDINGS], "전체");
      el.govGradeFilter.disabled = true;

      el.btnExportEntityDetailXlsx.disabled = false;

      el.entityName.disabled = true;
      el.personnelType.disabled = true;
      el.jobFilter.disabled = true;

      el.entityName.innerHTML = '<option value="">먼저 1) 구분을 선택하세요</option>';
      el.personnelType.innerHTML = '<option value="">먼저 2) 학교/기관을 선택하세요</option>';
      el.jobFilter.innerHTML = '<option value="">먼저 3) 인사 구분을 선택하세요</option>';

      const syncGovGradeFilter = () => {
        const pt = el.personnelType.value || "";
        if (pt === "지방공무원") {
          el.govGradeFilter.disabled = false;
          if (!el.govGradeFilter.value) el.govGradeFilter.value = "전체";
        } else {
          el.govGradeFilter.disabled = true;
          el.govGradeFilter.value = "전체";
        }
      };

      el.entityKind.onchange = () => {
        const kind = el.entityKind.value;
        if (!kind) {
          el.entityName.disabled = true;
          el.personnelType.disabled = true;
          el.jobFilter.disabled = true;
          el.govGradeFilter.disabled = true;
          el.govGradeFilter.value = "전체";
          el.entityName.innerHTML = '<option value="">먼저 1) 구분을 선택하세요</option>';
          return;
        }

        const { schools, insts } = buildEntityOptions();
        const list = kind === "school" ? schools : insts;

        el.entityName.disabled = false;
        setSelectOptions(el.entityName, [{ value: "__ALL__", label: "전체 조회" }, ...list], "선택");

        el.entityName.value = "__ALL__";
        el.personnelType.disabled = false;
        setSelectOptions(el.personnelType, buildPersonnelTypeOptions(), "선택");
        el.personnelType.value = "전체";

        el.jobFilter.disabled = false;
        setSelectOptions(el.jobFilter, buildJobOptions("전체"), "선택");
        el.jobFilter.value = "전체";

        syncGovGradeFilter();
        if (el.entitySelectSearch.value) applyEntitySelectSearch();

        renderEntityView();
      };

      el.entityName.onchange = () => {
        el.personnelType.disabled = false;
        renderEntityView();
      };

      el.personnelType.onchange = () => {
        const t = el.personnelType.value || "전체";
        el.jobFilter.disabled = false;
        setSelectOptions(el.jobFilter, buildJobOptions(t), "선택");
        el.jobFilter.value = "전체";
        syncGovGradeFilter();
        if (el.entitySelectSearch.value) applyEntitySelectSearch();
        renderEntityView();
      };

      el.jobFilter.onchange = () => {
        renderEntityView();
      };

      el.govGradeFilter.onchange = () => {
        renderEntityView();
      };
    }

    function filterByEntityAndType(rec, kind, entityValue) {
      if (!kind) return false;

      const matchEntity = (ent) => {
        if (!ent) return false;

        if (kind === "school") {
          if (ent.kind !== "school") return false;
          if (entityValue === "__ALL__") return true;
          return ent.baseName === entityValue;
        }

        if (ent.kind !== "inst") return false;
        if (entityValue === "__ALL__") return true;
        return ent.name === entityValue;
      };

      return matchEntity(rec.curEntity) || matchEntity(rec.newEntity);
    }

    function filterByPersonnelAndJob(rec, personnelType, jobFilter) {
      const pt = personnelType && personnelType !== "전체" ? personnelType : "";
      const jf = jobFilter && jobFilter !== "전체" ? jobFilter : "";

      if (pt && rec.personnelType !== pt) return false;
      if (jf && rec.jobKey !== jf) return false;

      return true;
    }

    function filterByGovGrade(rec, personnelType, govGrade) {
      if (personnelType === "지방공무원" && govGrade && govGrade !== "전체") {
        return rec.personnelType === "지방공무원" && rec.govGrade === govGrade;
      }
      return true;
    }

    function renderRecordsTable(records) {
      if (!records.length) return '<div class="muted">해당 없음</div>';

      // 오름차순(이름)
      const sorted = records.slice().sort((a, b) => {
        const n = a.name.localeCompare(b.name, "ko");
        if (n !== 0) return n;
        return (a.newOrg || "").localeCompare(b.newOrg || "", "ko");
      });

      const rowsHtml = sorted
        .map(
          (r) => `
          <tr>
            <td>${escapeHtml(state.maskNames ? maskSecondChar(r.name) : r.name)}</td>
            <td>${escapeHtml(r.personnelType)}</td>
            <td>${escapeHtml(r.jobKey || "")}</td>
            <td>${escapeHtml(r.curRank || "")}</td>
            <td>${escapeHtml(r.curOrg || "")}</td>
            <td>${escapeHtml(r.newRank || "")}</td>
            <td>${escapeHtml(r.newOrg || "")}</td>
            <td>${escapeHtml(r.curRegion || "")}</td>
            <td>${escapeHtml(r.newRegion || "")}</td>
            <td>${escapeHtml(r.action || "")}</td>
          </tr>
        `
        )
        .join("");

      return `
        <div class="records-wrap">
          <table class="sheetlike">
            <thead>
              <tr>
                <th style="min-width:120px">성명</th>
                <th style="min-width:120px">구분</th>
                <th style="min-width:140px">직렬/직종</th>
                <th style="min-width:140px">현직급/직종</th>
                <th style="min-width:240px">현소속/근무지</th>
                <th style="min-width:140px">발령직급/직종</th>
                <th style="min-width:240px">발령소속/근무지</th>
                <th style="min-width:110px">현지역</th>
                <th style="min-width:110px">발령지역</th>
                <th style="min-width:180px">구분/비고</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderEntityView() {
      const kind = el.entityKind.value;
      const entityValue = el.entityName.value || "__ALL__";
      const personnelType = el.personnelType.value || "전체";
      const jobFilter = el.jobFilter.value || "전체";
      const govGrade = el.govGradeFilter.value || "전체";

      if (!kind) return;

      const baseFiltered = state.records.filter(
        (rec) =>
          filterByEntityAndType(rec, kind, entityValue) &&
          filterByPersonnelAndJob(rec, personnelType, jobFilter) &&
          filterByGovGrade(rec, personnelType, govGrade)
      );

      const matchEntity = (ent) => {
        if (!ent) return false;
        if (kind === "school") {
          if (ent.kind !== "school") return false;
          if (entityValue === "__ALL__") return true;
          return ent.baseName === entityValue;
        }
        if (ent.kind !== "inst") return false;
        if (entityValue === "__ALL__") return true;
        return ent.name === entityValue;
      };

      const outList = [];
      const inList = [];
      const unknownList = [];

      for (const rec of baseFiltered) {
        const curHit = matchEntity(rec.curEntity);
        const newHit = matchEntity(rec.newEntity);

        const sameEntity =
          kind === "school"
            ? rec.curEntity?.baseName && rec.newEntity?.baseName && rec.curEntity.baseName === rec.newEntity.baseName
            : rec.curEntity?.name && rec.newEntity?.name && rec.curEntity.name === rec.newEntity.name;

        const isDispatch = recordHasKeywordText(rec, DISPATCH_KW);

        if (curHit && (!newHit || (newHit && !sameEntity) || rec.isRetire)) {
          outList.push(rec);
          continue;
        }

        if (newHit && (!curHit || (curHit && !sameEntity) || isDispatch)) {
          inList.push(rec);
          continue;
        }

        if (curHit || newHit) unknownList.push(rec);
      }

      el.entityOutCount.textContent = `${outList.length}명`;
      el.entityInCount.textContent = `${inList.length}명`;
      el.entityUnknownSummary.textContent = `미분류 (${unknownList.length}명)`;

      el.entityOutPanel.innerHTML = renderRecordsTable(outList);
      el.entityInPanel.innerHTML = renderRecordsTable(inList);
      el.entityUnknownPanel.innerHTML = renderRecordsTable(unknownList);

      state.currentExport = {
        title: `섹션3 조회 결과 (${kind === "school" ? "학교" : "기관"} / ${entityValue} / ${personnelType} / ${jobFilter}${personnelType === "지방공무원" && govGrade && govGrade !== "전체" ? ` / ${govGrade}` : ""})`,
        rows: baseFiltered,
      };

      el.btnDownloadFiltered.disabled = false;
    }

    /* =========================
       섹션4(지역) 필터
       ========================= */

    function initRegionFilters() {
      el.officeMode.disabled = false;
      el.officeMode.value = "";
      el.regionPick.disabled = true;
      el.regionPersonnelType.disabled = true;

      setSelectOptionsExact(el.regionGovGradeFilter, ["전체", ...GOV_GRADE_ENDINGS], "전체");
      el.regionGovGradeFilter.disabled = true;

      el.regionPick.innerHTML = '<option value="">먼저 1) 처리 방식을 선택하세요</option>';
      el.regionPersonnelType.innerHTML = '<option value="">먼저 2) 지역을 선택하세요</option>';

      const syncRegionGovGradeFilter = () => {
        const pt = el.regionPersonnelType.value || "";
        if (pt === "지방공무원") {
          el.regionGovGradeFilter.disabled = false;
          if (!el.regionGovGradeFilter.value) el.regionGovGradeFilter.value = "전체";
        } else {
          el.regionGovGradeFilter.disabled = true;
          el.regionGovGradeFilter.value = "전체";
        }
      };

      el.officeMode.onchange = () => {
        const mode = el.officeMode.value;
        if (!mode) {
          el.regionPick.disabled = true;
          el.regionPersonnelType.disabled = true;
          el.regionGovGradeFilter.disabled = true;
          el.regionGovGradeFilter.value = "전체";
          return;
        }

        el.regionPick.disabled = false;
        const regions = mode === "separate" ? REGION_18 : REGION_17;
        setSelectOptions(el.regionPick, regions, "선택");
        el.regionPick.value = regions[0] || "";

        el.regionPersonnelType.disabled = false;
        setSelectOptions(el.regionPersonnelType, buildPersonnelTypeOptions(), "선택");
        el.regionPersonnelType.value = "전체";

        syncRegionGovGradeFilter();

        renderRegionView();
      };

      el.regionPick.onchange = () => {
        el.regionPersonnelType.disabled = false;
        renderRegionView();
      };

      el.regionPersonnelType.onchange = () => {
        syncRegionGovGradeFilter();
        renderRegionView();
      };

      el.regionGovGradeFilter.onchange = () => {
        renderRegionView();
      };
    }

    function applyOfficeModeToRegion(region, mode) {
      if (!region) return "";
      if (mode === "merge" && region === "강원도교육청") return "춘천";
      return region;
    }

    function renderRegionView() {
      const mode = el.officeMode.value; // separate | merge
      const pick = el.regionPick.value;
      const personnelType = el.regionPersonnelType.value || "전체";
      const govGrade = el.regionGovGradeFilter.value || "전체";
      if (!mode || !pick) return;

      const viewCur = (rec) => applyOfficeModeToRegion(rec.curRegion, mode);
      const viewNew = (rec) => applyOfficeModeToRegion(rec.newRegion, mode);

      const filtered = state.records.filter((rec) => {
        if (personnelType && personnelType !== "전체" && rec.personnelType !== personnelType) return false;
        if (personnelType === "지방공무원" && govGrade && govGrade !== "전체" && rec.govGrade !== govGrade) return false;
        const c = viewCur(rec);
        const n = viewNew(rec);
        return c === pick || n === pick;
      });

      const outList = [];
      const inList = [];
      const stayList = [];
      const unknownList = [];

      for (const rec of filtered) {
        const c = viewCur(rec);
        const n = viewNew(rec);

        if (c === pick && (rec.isRetire || n !== pick)) {
          outList.push(rec);
          continue;
        }
        if (n === pick && c !== pick) {
          inList.push(rec);
          continue;
        }
        if (c === pick && n === pick && !rec.isRetire) {
          stayList.push(rec);
          continue;
        }
        unknownList.push(rec);
      }

      el.regionOutCount.textContent = `${outList.length}명`;
      el.regionInCount.textContent = `${inList.length}명`;
      el.regionStayCount.textContent = `${stayList.length}명`;
      el.regionUnknownSummary.textContent = `미분류 (${unknownList.length}명)`;

      el.regionOutPanel.innerHTML = renderRecordsTable(outList);
      el.regionInPanel.innerHTML = renderRecordsTable(inList);
      el.regionStayPanel.innerHTML = renderRecordsTable(stayList);
      el.regionUnknownPanel.innerHTML = renderRecordsTable(unknownList);

      state.currentExport = {
        title: `섹션4 조회 결과 (${mode === "separate" ? "도교육청 분리" : "춘천 합산"} / ${pick} / ${personnelType}${personnelType === "지방공무원" && govGrade && govGrade !== "전체" ? ` / ${govGrade}` : ""})`,
        rows: filtered,
      };

      el.btnExportRegionView.disabled = false;
      el.btnDownloadFiltered.disabled = false;
    }

    /* =========================
       다운로드(XLSX)
       ========================= */
    function toExportRow(rec) {
      return {
        성명: rec.name,
        구분: rec.personnelType,
        직렬_직종: rec.jobKey,
        현직급_직종: rec.curRank,
        현소속_근무지: rec.curOrg,
        발령직급_직종: rec.newRank,
        발령소속_근무지: rec.newOrg,
        현지역: rec.curRegion,
        발령지역: rec.newRegion,
        구분_비고: rec.action,
      };
    }

    function downloadWorkbookFromRows(rows, filename, sheetName = "명단") {
      if (!state.xlsxReady || !window.XLSX) {
        alert("XLSX 라이브러리가 아직 준비되지 않았습니다.");
        return;
      }
      const wb = XLSX.utils.book_new();
      const data = rows.map(toExportRow);
      const ws = XLSX.utils.json_to_sheet(data);
      // 가능하면 1행/1열 틀고정(지원되지 않는 환경에서는 무시될 수 있음)
      try {
        ws["!freeze"] = { xSplit: 1, ySplit: 1, topLeftCell: "B2", activePane: "bottomRight", state: "frozen" };
      } catch (e) {}
      XLSX.utils.book_append_sheet(wb, ws, sheetName);

      const safe = filename.replace(/[\\/:*?"<>|]/g, "_");
      XLSX.writeFile(wb, safe);
    }

    function downloadCurrent() {
      const rows = state.currentExport.rows && state.currentExport.rows.length ? state.currentExport.rows : state.records;
      const title = state.currentExport.title || "현재 조회 결과";
      const filename = `${title}.xlsx`;
      downloadWorkbookFromRows(rows, filename, "조회결과");
    }

    function downloadAll() {
      downloadWorkbookFromRows(state.records, "전체_인사발령_명단.xlsx", "전체");
    }

    function downloadWorkbookMultiSheets(sheets, filename) {
      if (!state.xlsxReady || !window.XLSX) {
        alert("XLSX 라이브러리가 아직 준비되지 않았습니다.");
        return;
      }

      const wb = XLSX.utils.book_new();
      for (const s of sheets) {
        const data = (s.rows || []).map(toExportRow);
        const ws = XLSX.utils.json_to_sheet(data);
        try {
          ws["!freeze"] = { xSplit: 1, ySplit: 1, topLeftCell: "B2", activePane: "bottomRight", state: "frozen" };
        } catch (e) {}
        XLSX.utils.book_append_sheet(wb, ws, s.name);
      }

      const safe = String(filename).replace(/[\\/:*?"<>|]/g, "_");
      XLSX.writeFile(wb, safe);
    }

    function exportEntityDetailXlsx() {
      const kind = el.entityKind.value;
      const entityValue = el.entityName.value || "__ALL__";
      const personnelType = el.personnelType.value || "전체";
      const jobFilter = el.jobFilter.value || "전체";
      const govGrade = el.govGradeFilter.value || "전체";

      if (!kind) {
        alert("먼저 섹션3 조회 조건을 선택하세요.");
        return;
      }

      const baseFiltered = state.records.filter(
        (rec) =>
          filterByEntityAndType(rec, kind, entityValue) &&
          filterByPersonnelAndJob(rec, personnelType, jobFilter) &&
          filterByGovGrade(rec, personnelType, govGrade)
      );

      const matchEntity = (ent) => {
        if (!ent) return false;
        if (kind === "school") {
          if (ent.kind !== "school") return false;
          if (entityValue === "__ALL__") return true;
          return ent.baseName === entityValue;
        }
        if (ent.kind !== "inst") return false;
        if (entityValue === "__ALL__") return true;
        return ent.name === entityValue;
      };

      const outList = [];
      const inList = [];
      const unknownList = [];

      for (const rec of baseFiltered) {
        const curHit = matchEntity(rec.curEntity);
        const newHit = matchEntity(rec.newEntity);

        const sameEntity =
          kind === "school"
            ? rec.curEntity?.baseName && rec.newEntity?.baseName && rec.curEntity.baseName === rec.newEntity.baseName
            : rec.curEntity?.name && rec.newEntity?.name && rec.curEntity.name === rec.newEntity.name;

        const isDispatch = recordHasKeywordText(rec, DISPATCH_KW);

        if (curHit && (!newHit || (newHit && !sameEntity) || rec.isRetire)) {
          outList.push(rec);
          continue;
        }
        if (newHit && (!curHit || (curHit && !sameEntity) || isDispatch)) {
          inList.push(rec);
          continue;
        }
        if (curHit || newHit) unknownList.push(rec);
      }

      const inRealList = inList.filter((rec) => !recordHasKeywordText(rec, DISPATCH_KW) && !recordHasKeywordText(rec, LEAVE_KW));

      const seen = new Set();
      const dispatchOrUnknownList = [];
      const pushUnique = (rec) => {
        const k = rec.id || `${rec.nameKey}|${rec.curOrg}|${rec.newOrg}`;
        if (seen.has(k)) return;
        seen.add(k);
        dispatchOrUnknownList.push(rec);
      };
      for (const rec of baseFiltered) {
        if (recordHasKeywordText(rec, DISPATCH_KW) || recordHasKeywordText(rec, LEAVE_KW)) pushUnique(rec);
      }
      for (const rec of unknownList) pushUnique(rec);

      const titleBase = `섹션3 조회 결과 (${kind === "school" ? "학교" : "기관"} / ${entityValue} / ${personnelType} / ${jobFilter}${personnelType === "지방공무원" && govGrade && govGrade !== "전체" ? ` / ${govGrade}` : ""})`;
      const filename = `${titleBase}_상세명단.xlsx`;

      downloadWorkbookMultiSheets(
        [
          { name: "전체 인사발령자 명단", rows: baseFiltered },
          { name: "전출 및 퇴직자 명단", rows: outList },
          { name: "전입 및 신규 발령", rows: inRealList },
          { name: "파견 및 미분류 건", rows: dispatchOrUnknownList },
        ],
        filename
      );
    }

    /* =========================
       분석 실행
       ========================= */

    async function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = () => reject(new Error("파일 읽기 실패"));
        fr.readAsArrayBuffer(file);
      });
    }

    async function analyzeAllFiles() {
      if (!state.files.length) return;
      if (!(await ensureXlsxReady())) return;

      // stats reset
      state.stats = { skippedInvalidName: 0, correctedYangToYanggu: 0, appliedRegulationFallback: 0 };

      el.btnAnalyze.disabled = true;
      el.btnAddFiles.disabled = true;
      el.btnResetFiles.disabled = true;
      lockFilters(true);

      setStatusBox("", "");
      setProgress("파일 분석 준비…", 1, "1%");
      log(`분석 시작: ${state.files.length}개 파일`);

      const all = [];
      const filesSorted = state.files.slice().sort((a, b) => a.name.localeCompare(b.name, "ko"));

      for (let i = 0; i < filesSorted.length; i++) {
        const f = filesSorted[i];
        const hint = regionHintFromFileName(f.name);

        const pctBase = Math.round((i / filesSorted.length) * 100);
        setProgress("파일 분석 중…", Math.min(99, pctBase), `${pctBase}%`, `${i + 1}/${filesSorted.length}  ${f.name}`);
        log(`읽는 중: ${f.name}`);

        let wb;
        try {
          const buf = await readFileAsArrayBuffer(f);
          wb = XLSX.read(buf, { type: "array", cellDates: true });
        } catch (e) {
          log(`⚠️ 파일 파싱 실패: ${f.name} (${e.message})`);
          continue;
        }

        const sheets = wb.SheetNames || [];
        for (let s = 0; s < sheets.length; s++) {
          const sheetName = sheets[s];
          const sheet = wb.Sheets[sheetName];
          if (!sheet) continue;

          try {
            fillMergedCells(sheet);

            const rows = XLSX.utils.sheet_to_json(sheet, {
              header: 1,
              defval: "",
              blankrows: false,
            });

            const extracted = extractRecordsFromSheet(rows, {
              fileName: f.name,
              sheetName,
              fileRegionHint: hint,
            });

            if (extracted.length) {
              all.push(...extracted);
              log(`  - 시트: ${sheetName} → ${extracted.length}건`);
            }
          } catch (e) {
            log(`⚠️ 시트 처리 실패: ${f.name} / ${sheetName} (${e.message})`);
          }

          if (s % 3 === 2) await sleep(0);
        }
      }

      setProgress("중복 제거 및 집계 중…", 99, "99%");
      log(`원본 추출 건수: ${all.length}건`);

      state.recordsRaw = all;
      state.records = dedupeRecords(all);

      // ✅ 병설유치원 메타(합산/표기)
      state.schoolMeta = buildSchoolMeta(state.records);

      log(`중복 제거 후: ${state.records.length}건`);
      computeAggregates();

      setProgress("완료", 100, "100%");

      setStatusBox(
        "ok",
        `분석 완료: <b>${state.records.length.toLocaleString()}</b>명 (원본 ${state.recordsRaw.length.toLocaleString()}건 → 중복 제거 후)<br/>
         - 성명 오류/병합 잔상 무시: <b>${state.stats.skippedInvalidName.toLocaleString()}</b>건<br/>
         - "양" → "양구" 교정: <b>${state.stats.correctedYangToYanggu.toLocaleString()}</b>건<br/>
         - 조례/시행규칙(현근무지로 대체): <b>${state.stats.appliedRegulationFallback.toLocaleString()}</b>건`
      );

      renderSummary();
      lockFilters(false);

      initEntityFilters();
      initRegionFilters();

      el.btnDownloadAll.disabled = false;
      el.btnDownloadFiltered.disabled = false;

      el.btnAnalyze.disabled = false;
      el.btnAddFiles.disabled = false;
      el.btnResetFiles.disabled = false;

      updateAnalyzeBtn();
    }

    /* =========================
       이벤트 바인딩
       ========================= */

    function initUploadUI() {
      el.btnAddFiles.addEventListener("click", () => el.fileInput.click());
      el.fileInput.addEventListener("change", (e) => {
        addFiles(e.target.files);
        el.fileInput.value = "";
      });

      el.btnResetFiles.addEventListener("click", resetFiles);
      el.btnAnalyze.addEventListener("click", analyzeAllFiles);

      el.dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        el.dropzone.classList.add("dragover");
      });
      el.dropzone.addEventListener("dragleave", () => el.dropzone.classList.remove("dragover"));
      el.dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        el.dropzone.classList.remove("dragover");
        addFiles(e.dataTransfer.files);
      });

      el.regionSearch.addEventListener("input", () => renderRegionTable());
      el.instSearch.addEventListener("input", () => renderInstTable());

      el.maskNameToggle.addEventListener("change", () => {
        state.maskNames = !!el.maskNameToggle.checked;
        renderEntityView();
        renderRegionView();
      });

      el.btnDownloadAll.addEventListener("click", downloadAll);
      el.btnDownloadFiltered.addEventListener("click", () => scrollToId("sec-entity"));
      el.btnExportEntityDetailXlsx.addEventListener("click", exportEntityDetailXlsx);
      el.btnExportRegionView.addEventListener("click", () => {
        renderRegionView();
        downloadCurrent();
      });

      el.toTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      window.addEventListener("scroll", () => {
        if (window.scrollY > 600) el.toTopBtn.classList.add("show");
        else el.toTopBtn.classList.remove("show");
      });
    }

    async function init() {
      renderEmptyResults();
      renderFileTable();
      initUploadUI();

      const ok = await ensureXlsxReady();
      updateAnalyzeBtn();

      if (ok) {
        el.xlsxBadge.textContent = "XLSX: 준비됨";
        setProgress("라이브러리 로드 완료", 100, "100%");
        log("초기화 완료");
      } else {
        log("XLSX 로드 실패 상태로 시작");
      }
    }

    init();
  })();
</script>

<script src="/static/footer.js"></script>
<script src="/static/global-loader.js?v=1"></script>

  </body>
</html>
