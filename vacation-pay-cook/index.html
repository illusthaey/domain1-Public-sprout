<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>겨울방학중 급식소 청소 인건비 계산기 (조리사/조리실무사)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .muted{ color:#666; }
    .hint{ color:#666; font-size:0.95rem; }
    .note{ color:#555; font-size:0.95rem; }
    .small{ font-size:0.9rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .grid-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media (max-width: 860px){
      .grid-3,.grid-2{ grid-template-columns:1fr; }
    }
    .inline{ display:flex; flex-wrap:wrap; align-items:center; gap:10px 14px; }
    .inline label{ margin:0; }
    .pill{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid #e5e5e5;
      background:#fafafa;
      font-size:0.9rem;
      color:#444;
    }

    /* 캘린더 */
    .cal-wrap{ display:flex; flex-direction:column; gap:12px; }
    .cal-month{
      border:1px solid #e9e9e9;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .cal-head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .cal-title{ font-weight:800; }
    .cal-legend{ display:flex; gap:10px; flex-wrap:wrap; font-size:0.9rem; color:#555; }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      display:inline-block;
      vertical-align:middle;
      margin-right:6px;
      border:1px solid #d0d0d0;
    }
    .dot.clean{ background:#e8f4ff; border-color:#b9dbff; }
    .dot.train{ background:#f1e8ff; border-color:#d6c3ff; }
    .dot.paid{ background:#ffe8e8; border-color:#ffc8c8; }
    .dot.weekly{ background:#fff7b0; border-color:#ffe27a; }
    .dot.off{ background:#fafafa; }

    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }
    .cal-dow{
      font-size:0.85rem;
      color:#666;
      text-align:center;
      padding:2px 0 6px;
      font-weight:700;
    }
    .cal-dow.sun{ color:#d11a2a; }
    .cal-dow.sat{ color:#1d4ed8; }

    .cal-day{
      border:1px solid #e6e6e6;
      border-radius:12px;
      padding:8px 6px;
      min-height:60px;
      text-align:center;
      background:#fafafa;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .cal-day[aria-disabled="true"]{
      opacity:0.35;
      cursor:not-allowed;
    }
    .cal-day .num{ font-weight:900; display:block; line-height:1; }
    .cal-day .sub{ font-size:0.78rem; color:#666; margin-top:6px; display:block; }
    .cal-day .badge{
      display:inline-block;
      margin-top:6px;
      font-size:0.72rem;
      padding:1px 6px;
      border-radius:999px;
      border:1px solid #e5e5e5;
      background:#fff;
      color:#555;
    }

    .cal-day.is-clean{ background:#e8f4ff; border-color:#b9dbff; }
    .cal-day.is-train{ background:#f1e8ff; border-color:#d6c3ff; }
    .cal-day.is-paid{ background:#ffe8e8; border-color:#ffc8c8; }
    .cal-day.is-weekly{ background:#fff7b0; border-color:#ffe27a; }

    .cal-day.is-sun .num{ color:#d11a2a; }
    .cal-day.is-sat .num{ color:#1d4ed8; }
    .cal-day.is-holidayText .num{ color:#d11a2a; }

    .cal-day.is-today{ outline:2px solid rgba(0,0,0,0.12); outline-offset:1px; }

    /* 결과 */
    .result-grid{ display:flex; flex-direction:column; gap:14px; }
    .result-block{ border-top:1px solid #eee; padding-top:10px; }
    .result-block:first-of-type{ border-top:none; padding-top:0; }
    .result-title{ font-weight:900; margin-bottom:6px; }
    .result-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin:4px 0;
    }
    .result-label{ font-weight:700; }
    .result-value{ min-width:160px; text-align:right; }
    .danger{ color:#b00020; font-weight:900; }
    .btn-row{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <main class="container" style="max-width:1080px; margin:0 auto; padding:24px 16px;">
    <header class="site-header">
      <div class="shell">
        <h1>겨울방학중 급식소 청소 인건비 계산기 (조리사/조리실무사)</h1>
        <p class="muted">
          ·학교 지급분 산정: <b>청소수당 + 주휴수당(토/일)</b><br/>
          ·주휴수당(겨울방학 급식소 청소 기준):
          <span class="mono">(기본급 + 정액급식비 + 위험수당) ÷ 월일수(토요일 포함) × 주휴일수(토/일)</span><br/>
          ·주휴 발생 판단(방학중 청소 기준): <b>해당 주 인정근무시간 합계 15시간 이상</b> + <b>다음 주(월~금) 근무/유급휴일 예정</b>
        </p>
      </div>
    </header>

    <section class="card">
      <h2>1) 기본 정보</h2>

      <div class="grid-3">
        <div class="form-row">
          <label for="cookCount">조리사 인원</label>
          <input id="cookCount" type="number" min="0" step="1" value="1" />
          <p class="hint">0명이면 조리사 계산 제외</p>
        </div>

        <div class="form-row">
          <label for="helperCount">조리실무사 인원</label>
          <input id="helperCount" type="number" min="0" step="1" value="0" />
          <p class="hint">0명이면 조리실무사 계산 제외</p>
        </div>

        <div class="form-row">
          <label>3~11월 주휴수당 분리(지원청 지급분)</label>
          <div class="inline">
            <input id="splitSupport" type="checkbox" checked />
            <label for="splitSupport" style="display:inline;">3~11월 발생분은 학교 합계에서 제외</label>
          </div>
          <p class="hint">겨울방학 청소로 인해 3월 이후 주휴가 발생하면 지원청 급여로 지급되는 경우를 분리</p>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div class="form-row">
          <label for="startDate">방학(비근무) 기간 시작일</label>
          <input id="startDate" type="date" />
        </div>
        <div class="form-row">
          <label for="endDate">방학(비근무) 기간 종료일</label>
          <input id="endDate" type="date" />
        </div>
      </div>

      <div class="form-row" style="margin-top:8px;">
        <label>방학 종료 후 다음 주 근무 예정(개학 등)</label>
        <div class="inline">
          <input id="afterSemesterWork" type="checkbox" checked />
          <label for="afterSemesterWork" style="display:inline;">마지막 주 주휴(토/일) 발생 판단에 사용</label>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) 일정 선택</h2>

      <div class="inline" style="margin:8px 0 10px;">
        <span class="pill">선택 모드</span>
        <select id="pickMode" style="max-width:260px;">
          <option value="clean" selected>청소일(수당 대상)</option>
          <option value="train">산업안전보건교육(주휴 판단용)</option>
          <option value="erase">해제(삭제)</option>
        </select>

        <span class="pill">기본 근무시간</span>
        <label>청소일: <input id="defaultCleanHours" type="number" min="0" step="0.5" value="8" style="width:110px; display:inline-block;" />시간</label>
        <label>교육일: <input id="defaultTrainHours" type="number" min="0" step="0.5" value="8" style="width:110px; display:inline-block;" />시간</label>

        <button type="button" class="btn" id="clearAllBtn">전체 해제</button>
      </div>

      <div class="inline" style="margin:10px 0 6px;">
        <span class="pill">설연휴(유급휴일, 고정)</span>
        <label>설 전날 <input id="seollalEve" type="date" style="width:170px; display:inline-block;" value="2026-02-16" /></label>
        <label>설 당일 <input id="seollalDay" type="date" style="width:170px; display:inline-block;" value="2026-02-17" /></label>
        <button type="button" class="btn" id="applySeollalBtn">캘린더에 반영</button>
        <span class="hint">설 전날/설 당일은 <b>유급휴일(1일 8시간 근무간주)</b>로 자동 고정되며 체크 해제 불가</span>
      </div>

      <div class="cal-legend" style="margin:10px 0 6px;">
        <span><span class="dot clean"></span>청소일</span>
        <span><span class="dot train"></span>산업안전보건교육</span>
        <span><span class="dot paid"></span>유급휴일(설 등)</span>
        <span><span class="dot weekly"></span>주휴일(토/일, 계산결과)</span>
        <span><span class="dot off"></span>미선택</span>
      </div>

      <div class="cal-wrap" id="calendar"></div>

      <h3 style="margin-top:16px;">선택된 날짜 목록</h3>
      <div class="grid-2">
        <div>
          <h4 style="margin:0 0 8px;">청소일(수당 대상)</h4>
          <div class="table-wrap" id="cleanListWrap"></div>
        </div>
        <div>
          <h4 style="margin:0 0 8px;">산업안전보건교육/유급휴일(주휴 판단용)</h4>
          <div class="table-wrap" id="trainListWrap"></div>
        </div>
      </div>

      <p class="note small" style="margin-top:10px;">
        ·<b>산업안전보건교육/유급휴일</b>은 이 계산기에서 “주휴 발생 판단(15시간/다음주)”에만 반영합니다.<br/>
        ·설 전날/설 당일은 <b>유급휴일(근무간주 8시간)</b>로 고정되며, 필요 시 위 날짜를 바꾸고 “반영”을 누르세요.
      </p>
    </section>

    <section class="card">
      <h2>3) 주휴수당 일할계산 기준(기본급+정액급식비+위험수당)</h2>
      <p class="muted">
        주휴수당(토/일) = <span class="mono">(기본급 + 정액급식비 + 위험수당) ÷ 월일수(토요일 포함) × 주휴일수</span><br/>
        아래 값은 예시 자동채움(2025 기준)이며, <b>2026 기준표에 맞게 월별로 수정</b>해서 사용하세요.
      </p>

      <div class="inline" style="margin:8px 0 10px;">
        <button type="button" class="btn" id="fillPayBtn">월별 급여 자동 채우기(예시값)</button>
        <span class="hint">예시: 정액급식비 150,000 / 위험수당 50,000 / 기본급은 2025 예시(필요시 수정)</span>
      </div>

      <div class="table-wrap" id="monthPayWrap"></div>
    </section>

    <section class="card">
      <div class="btn-row" style="margin-bottom:10px;">
        <button type="button" class="btn" id="calcBtn">계산하기</button>
      </div>

      <h2>4) 계산 결과</h2>

      <div class="result-grid">
        <div class="result-block">
          <div class="result-title">일정/주휴일</div>

          <div class="result-row">
            <div class="result-label">청소일수</div>
            <div class="result-value" id="resCleanDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">청소 총 근무시간</div>
            <div class="result-value" id="resCleanHours">-</div>
          </div>

          <div class="result-row">
            <div class="result-label">교육/유급휴일 일수</div>
            <div class="result-value" id="resTrainDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">교육/유급휴일 인정시간 합계</div>
            <div class="result-value" id="resTrainHours">-</div>
          </div>

          <div class="result-row" style="margin-top:8px;">
            <div class="result-label">학교 지급분 주휴일(토/일) 수</div>
            <div class="result-value" id="resSchoolHolidayDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">학교 지급분 주휴일 날짜</div>
            <div class="result-value" id="resSchoolHolidayDates">-</div>
          </div>

          <div class="result-row" style="margin-top:8px;">
            <div class="result-label">지원청 지급분(3~11월) 주휴일 수</div>
            <div class="result-value" id="resSupportHolidayDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">지원청 지급분 주휴일 날짜</div>
            <div class="result-value" id="resSupportHolidayDates">-</div>
          </div>

          <p class="note small" id="resCondHint" style="margin-top:8px;">
            주휴 발생 판단(요약): 해당 주 인정근무시간 합계 15시간 이상 + 다음 주(월~금) 근무/유급휴일 예정
          </p>
        </div>

        <div class="result-block">
          <div class="result-title">금액(학교 지급분)</div>

          <div class="table-wrap" id="resPayTableWrap"></div>

          <p class="note small" id="resMonthBreakdown" style="margin-top:10px;">-</p>
          <p class="note small" id="resSupportInfo" style="margin-top:6px;">-</p>
        </div>
      </div>

      <p class="note small" style="margin-top:10px;">
        ·청소수당: 1일 근무시간 기준 <b>4시간 이하 10,000원 / 4시간 초과 20,000원</b><br/>
        ·달력의 <b>노란색(주휴일)</b>은 계산 결과이며, 선택/해제는 청소일/교육일 입력을 바꾸면 자동 갱신됩니다.
      </p>
    </section>

    <div class="btns">
      <a class="btn" href="/">메인으로 돌아가기</a>
    </div>
  </main>

  <script>
    const pad2 = (n) => String(n).padStart(2, '0');
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const fromYMD = (s) => {
      if (!s) return null;
      const [y,m,d] = s.split('-').map(Number);
      if (!y || !m || !d) return null;
      const dt = new Date(y, m-1, d);
      dt.setHours(0,0,0,0);
      return dt;
    };
    const addDays = (d, n) => {
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      x.setHours(0,0,0,0);
      return x;
    };
    const dayNames = ['일','월','화','수','목','금','토'];
    const fmtKRW = (v) => {
      if (v === null || v === undefined || isNaN(v)) return '-';
      return Math.round(v).toLocaleString('ko-KR') + '원';
    };
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const ymKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const parseYmKey = (k) => {
      const m = /^(\d{4})-(\d{2})$/.exec(k);
      if (!m) return null;
      return { y:+m[1], m:+m[2] };
    };

    function startOfWeekMon(date){
      const d = new Date(date);
      const dow = d.getDay();
      const diff = (dow === 0) ? -6 : (1 - dow);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }
    function weekKey(date){ return toYMD(startOfWeekMon(date)); }
    function nextWeekKey(wk){
      const mon = fromYMD(wk);
      if (!mon) return '';
      return toYMD(addDays(mon, 7));
    }
    function monthKeysBetween(start, end){
      const keys=[];
      const cur = new Date(start.getFullYear(), start.getMonth(), 1);
      const last = new Date(end.getFullYear(), end.getMonth(), 1);
      while(cur <= last){
        keys.push(ymKey(cur));
        cur.setMonth(cur.getMonth()+1);
      }
      return keys;
    }
    function daysInMonth(year, monthIndex0){
      return new Date(year, monthIndex0+1, 0).getDate();
    }
    function nextWeekdayAfter(dateObj){
      let d = addDays(dateObj, 1);
      while(d.getDay() === 0 || d.getDay() === 6){
        d = addDays(d, 1);
      }
      return d;
    }

    function publicHolidaySetForYear(y){
      const set = new Set();
      const fixed = [
        `${y}-01-01`,`${y}-03-01`,`${y}-05-05`,`${y}-06-06`,
        `${y}-08-15`,`${y}-10-03`,`${y}-10-09`,`${y}-12-25`,
      ];
      fixed.forEach(ds => set.add(ds));

      const subTargets = ['03-01','08-15','10-03','10-09'];
      subTargets.forEach(mmdd=>{
        const dt = fromYMD(`${y}-${mmdd}`);
        if (!dt) return;
        const dow = dt.getDay();
        if (dow === 0) set.add(toYMD(addDays(dt, 1)));
        if (dow === 6) set.add(toYMD(addDays(dt, 2)));
      });

      const child = fromYMD(`${y}-05-05`);
      if (child){
        const dow = child.getDay();
        if (dow === 0) set.add(toYMD(addDays(child, 1)));
        if (dow === 6) set.add(toYMD(addDays(child, 2)));
      }
      return set;
    }

    const state = {
      dateMap: new Map(),
      monthPayMap: new Map(),
      weeklyHolidaySet: new Set(),
      publicHolidaySet: new Set(),
      lockedHolidaySet: new Set(),
    };

    const els = {
      cookCount: document.getElementById('cookCount'),
      helperCount: document.getElementById('helperCount'),
      splitSupport: document.getElementById('splitSupport'),
      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),
      afterSemesterWork: document.getElementById('afterSemesterWork'),

      pickMode: document.getElementById('pickMode'),
      defaultCleanHours: document.getElementById('defaultCleanHours'),
      defaultTrainHours: document.getElementById('defaultTrainHours'),
      clearAllBtn: document.getElementById('clearAllBtn'),

      seollalEve: document.getElementById('seollalEve'),
      seollalDay: document.getElementById('seollalDay'),
      applySeollalBtn: document.getElementById('applySeollalBtn'),

      calendar: document.getElementById('calendar'),
      cleanListWrap: document.getElementById('cleanListWrap'),
      trainListWrap: document.getElementById('trainListWrap'),

      fillPayBtn: document.getElementById('fillPayBtn'),
      monthPayWrap: document.getElementById('monthPayWrap'),

      calcBtn: document.getElementById('calcBtn'),

      resCleanDays: document.getElementById('resCleanDays'),
      resCleanHours: document.getElementById('resCleanHours'),
      resTrainDays: document.getElementById('resTrainDays'),
      resTrainHours: document.getElementById('resTrainHours'),

      resSchoolHolidayDays: document.getElementById('resSchoolHolidayDays'),
      resSchoolHolidayDates: document.getElementById('resSchoolHolidayDates'),
      resSupportHolidayDays: document.getElementById('resSupportHolidayDays'),
      resSupportHolidayDates: document.getElementById('resSupportHolidayDates'),
      resCondHint: document.getElementById('resCondHint'),

      resPayTableWrap: document.getElementById('resPayTableWrap'),
      resMonthBreakdown: document.getElementById('resMonthBreakdown'),
      resSupportInfo: document.getElementById('resSupportInfo'),
    };

    function getRange(){
      const s = fromYMD(els.startDate.value);
      const e = fromYMD(els.endDate.value);
      if (!(s && e && e >= s)) return null;
      return { s, e };
    }
    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    function syncLockedHolidays(){
      const range = getRange();
      state.lockedHolidaySet = new Set();

      const eve = els.seollalEve.value;
      const day = els.seollalDay.value;
      [eve, day].forEach(ds=>{ if (ds) state.lockedHolidaySet.add(ds); });

      for(const [ds, rec] of Array.from(state.dateMap.entries())){
        if (rec?.kind === 'holiday' && rec?.locked){
          if (!state.lockedHolidaySet.has(ds)) state.dateMap.delete(ds);
        }
      }

      if (!range) return;

      for(const ds of Array.from(state.lockedHolidaySet.values())){
        const d = fromYMD(ds);
        if (!d) continue;
        if (d < range.s || d > range.e) continue;
        state.dateMap.set(ds, { kind:'holiday', hours:8, locked:true });
      }
    }

    function refreshPublicHolidays(){
      state.publicHolidaySet = new Set();
      const range = getRange();
      if (!range) return;
      const ys = range.s.getFullYear();
      const ye = range.e.getFullYear();
      for(let y=ys; y<=ye; y++){
        const setY = publicHolidaySetForYear(y);
        for(const ds of setY) state.publicHolidaySet.add(ds);
      }
    }

    function setDateKind(dateStr, kind){
      const cur = state.dateMap.get(dateStr);
      if (cur?.locked) return;

      if (!kind){
        state.dateMap.delete(dateStr);
        return;
      }
      if (kind === 'clean'){
        const defH = Math.max(0, parseFloat(els.defaultCleanHours.value) || 0);
        state.dateMap.set(dateStr, { kind:'clean', hours: cur?.hours ?? defH, locked:false });
      } else if (kind === 'train'){
        const defH = Math.max(0, parseFloat(els.defaultTrainHours.value) || 0);
        state.dateMap.set(dateStr, { kind:'train', hours: cur?.hours ?? defH, locked:false });
      }
    }
    function toggleDate(dateStr){
      const range = getRange();
      if (!range) return;
      const mode = els.pickMode.value;
      const cur = state.dateMap.get(dateStr);
      if (cur?.locked) return;

      if (mode === 'erase'){ state.dateMap.delete(dateStr); return; }
      if (mode === 'clean'){
        if (cur?.kind === 'clean') state.dateMap.delete(dateStr);
        else setDateKind(dateStr, 'clean');
        return;
      }
      if (mode === 'train'){
        if (cur?.kind === 'train') state.dateMap.delete(dateStr);
        else setDateKind(dateStr, 'train');
        return;
      }
    }

    function cleanPayPerDay(hours){
      const h = Math.max(0, parseFloat(hours)||0);
      if (h <= 0) return 0;
      return (h <= 4) ? 10000 : 20000;
    }

    function computeWeekendHolidays(events, range, afterSemesterWork){
      const weeks = new Map();
      events.forEach(ev=>{
        if (!ev?.date) return;
        const h = Math.max(0, parseFloat(ev.hours)||0);
        if (h <= 0) return;
        const wk = weekKey(ev.date);
        const rec = weeks.get(wk) || { mon: startOfWeekMon(ev.date), totalHours:0, hasWeekdayPlan:false };
        rec.totalHours += h;
        const dow = ev.date.getDay();
        if (dow >= 1 && dow <= 5) rec.hasWeekdayPlan = true;
        weeks.set(wk, rec);
      });

      let resumeWeek = '';
      if (afterSemesterWork && range){
        const resumeDate = nextWeekdayAfter(range.e);
        resumeWeek = weekKey(resumeDate);
      }

      const holidayDates = [];
      const keys = Array.from(weeks.keys()).sort();

      keys.forEach(wk=>{
        const rec = weeks.get(wk);
        if (!rec) return;
        if (rec.totalHours < 15) return;

        const nextK = nextWeekKey(wk);
        let hasNextWeekPlan = false;

        const nextRec = weeks.get(nextK);
        if (nextRec && nextRec.hasWeekdayPlan){
          hasNextWeekPlan = true;
        } else {
          if (afterSemesterWork && resumeWeek && nextK === resumeWeek){
            hasNextWeekPlan = true;
          }
        }

        if (hasNextWeekPlan){
          holidayDates.push(addDays(rec.mon, 5), addDays(rec.mon, 6));
        }
      });

      const uniq = new Map();
      holidayDates.forEach(d=>{
        if (!range) return;
        if (d < range.s || d > range.e) return;
        uniq.set(toYMD(d), d);
      });
      return Array.from(uniq.values()).sort((a,b)=>a-b);
    }

    function inferBasePay(role, dateObj){
      const cut = new Date(2025, 2, 1);
      const isAfter = dateObj >= cut;
      if (role === 'cook') return isAfter ? 2169300 : 2085300;
      return isAfter ? 2066000 : 1986000;
    }

    function ensureMonthPayDefaults(force=false){
      const range = getRange();
      if (!range) return;

      const keys = monthKeysBetween(range.s, range.e);
      keys.forEach(mk=>{
        const ym = parseYmKey(mk);
        if (!ym) return;
        const monthStart = new Date(ym.y, ym.m-1, 1);
        const autoDays = daysInMonth(ym.y, ym.m-1);

        const defaults = {
          monthDays: autoDays,
          mealAllow: 150000,
          hazardAllow: 50000,
          baseCook: inferBasePay('cook', monthStart),
          baseHelper: inferBasePay('helper', monthStart),
        };

        const prev = state.monthPayMap.get(mk);
        if (force || !prev){
          state.monthPayMap.set(mk, { ...defaults, manual:false });
          return;
        }
        if (prev.manual){
          const fixed = { ...prev };
          if (!(fixed.monthDays > 0)) fixed.monthDays = autoDays;
          state.monthPayMap.set(mk, fixed);
          return;
        }
        state.monthPayMap.set(mk, { ...prev, ...defaults, monthDays: (prev.monthDays>0?prev.monthDays:autoDays), manual:false });
      });

      const keySet = new Set(keys);
      for (const existingKey of Array.from(state.monthPayMap.keys())){
        if (!keySet.has(existingKey)) state.monthPayMap.delete(existingKey);
      }
    }

    function buildMonthPayTable(){
      els.monthPayWrap.innerHTML = '';
      const range = getRange();
      if (!range){
        els.monthPayWrap.innerHTML = '<p class="hint" style="padding:10px 12px;">방학 기간을 입력하면 월별 급여 항목이 생성됩니다.</p>';
        return;
      }
      ensureMonthPayDefaults(false);
      const keys = monthKeysBetween(range.s, range.e);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ['월(YYYY-MM)','월 일수(분모, 토 포함)','정액급식비(월)','위험수당(월)','조리사 기본급(월)','조리실무사 기본급(월)']
        .forEach(t=>{ const th=document.createElement('th'); th.textContent=t; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      keys.forEach(mk=>{
        const ym = parseYmKey(mk);
        if (!ym) return;
        const autoDays = daysInMonth(ym.y, ym.m-1);
        const saved = state.monthPayMap.get(mk) || { monthDays:autoDays, mealAllow:0, hazardAllow:0, baseCook:0, baseHelper:0, manual:false };

        const row = document.createElement('tr');
        const td0=document.createElement('td'); td0.textContent = mk; row.appendChild(td0);

        function makeInp(value, cls, step='10'){
          const td=document.createElement('td');
          const inp=document.createElement('input');
          inp.type='number';
          inp.min='0';
          inp.step=step;
          inp.className=cls;
          inp.value = String(value ?? 0);
          td.appendChild(inp);
          return { td, inp };
        }

        const daysCell = makeInp(saved.monthDays ?? autoDays, 'monthDays', '1');
        daysCell.inp.max = '31';
        row.appendChild(daysCell.td);

        const meal = makeInp(saved.mealAllow ?? 0, 'mealAllow');
        row.appendChild(meal.td);

        const haz = makeInp(saved.hazardAllow ?? 0, 'hazardAllow');
        row.appendChild(haz.td);

        const bc = makeInp(saved.baseCook ?? 0, 'baseCook');
        row.appendChild(bc.td);

        const bh = makeInp(saved.baseHelper ?? 0, 'baseHelper');
        row.appendChild(bh.td);

        const saveRow = ()=>{
          state.monthPayMap.set(mk, {
            monthDays: clamp(parseInt(daysCell.inp.value,10)||autoDays, 1, 31),
            mealAllow: Math.max(0, parseFloat(meal.inp.value)||0),
            hazardAllow: Math.max(0, parseFloat(haz.inp.value)||0),
            baseCook: Math.max(0, parseFloat(bc.inp.value)||0),
            baseHelper: Math.max(0, parseFloat(bh.inp.value)||0),
            manual:true
          });
        };
        [daysCell.inp, meal.inp, haz.inp, bc.inp, bh.inp].forEach(inp=>inp.addEventListener('change', saveRow));

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      els.monthPayWrap.appendChild(table);
    }

    function getMonthPay(mk){
      const ym = parseYmKey(mk);
      if (!ym) return null;
      const autoDays = daysInMonth(ym.y, ym.m-1);
      const rec = state.monthPayMap.get(mk);
      if (!rec) return { monthDays:autoDays, mealAllow:0, hazardAllow:0, baseCook:0, baseHelper:0 };
      return {
        monthDays: rec.monthDays ?? autoDays,
        mealAllow: rec.mealAllow ?? 0,
        hazardAllow: rec.hazardAllow ?? 0,
        baseCook: rec.baseCook ?? 0,
        baseHelper: rec.baseHelper ?? 0,
      };
    }

    function collectEvents(){
      const clean = [];
      const train = [];
      const hol = [];
      for(const [ds, rec] of Array.from(state.dateMap.entries())){
        const d = fromYMD(ds);
        if (!d) continue;
        if (rec.kind === 'clean') clean.push({ date:d, hours: Math.max(0, parseFloat(rec.hours)||0) });
        else if (rec.kind === 'train') train.push({ date:d, hours: Math.max(0, parseFloat(rec.hours)||0) });
        else if (rec.kind === 'holiday') hol.push({ date:d, hours: 8 });
      }
      clean.sort((a,b)=>a.date-b.date);
      train.sort((a,b)=>a.date-b.date);
      hol.sort((a,b)=>a.date-b.date);
      return { clean, train, hol };
    }

    function updateWeeklyHolidaySet(){
      state.weeklyHolidaySet = new Set();
      const range = getRange();
      if (!range) return;

      const afterSemester = !!els.afterSemesterWork.checked;
      const ev = collectEvents();
      const allEvents = [...ev.clean, ...ev.train, ...ev.hol];

      const holidayWeekend = computeWeekendHolidays(allEvents, range, afterSemester);
      const workLikeSet = new Set(allEvents.map(x=>toYMD(x.date)));
      const holidayFinal = holidayWeekend.filter(d=>!workLikeSet.has(toYMD(d)));

      holidayFinal.forEach(d=>state.weeklyHolidaySet.add(toYMD(d)));
    }

    function buildCalendar(){
      els.calendar.innerHTML = '';
      const range = getRange();
      if (!range){
        els.calendar.innerHTML = '<p class="hint">방학 시작/종료일을 입력하면 달력이 생성됩니다.</p>';
        return;
      }
      const { s, e } = range;
      const keys = monthKeysBetween(s, e);

      const today = new Date(); today.setHours(0,0,0,0);

      keys.forEach(k=>{
        const ym = parseYmKey(k);
        if (!ym) return;
        const year = ym.y;
        const month = ym.m - 1;

        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month+1, 0);

        const wrap = document.createElement('div');
        wrap.className = 'cal-month';

        const head = document.createElement('div');
        head.className = 'cal-head';
        const title = document.createElement('div');
        title.className = 'cal-title';
        title.textContent = `${year}년 ${month+1}월`;
        const sub = document.createElement('div');
        sub.className = 'hint';
        sub.textContent = '날짜 클릭 → 선택 모드에 따라 기록(주휴일은 자동 표시)';
        head.appendChild(title);
        head.appendChild(sub);
        wrap.appendChild(head);

        const grid = document.createElement('div');
        grid.className = 'cal-grid';

        const dows = ['일','월','화','수','목','금','토'];
        dows.forEach((dn, idx)=>{
          const el = document.createElement('div');
          el.className = 'cal-dow';
          if (idx === 0) el.classList.add('sun');
          if (idx === 6) el.classList.add('sat');
          el.textContent = dn;
          grid.appendChild(el);
        });

        const firstDow = monthStart.getDay();
        for(let i=0;i<firstDow;i++){
          const blank = document.createElement('div');
          blank.className = 'cal-day';
          blank.setAttribute('aria-disabled','true');
          blank.style.visibility='hidden';
          grid.appendChild(blank);
        }

        const dim = monthEnd.getDate();
        for(let day=1; day<=dim; day++){
          const d = new Date(year, month, day);
          d.setHours(0,0,0,0);

          const dateStr = toYMD(d);
          const inPickRange = (d >= s && d <= e);

          const cell = document.createElement('div');
          cell.className = 'cal-day';
          cell.dataset.date = dateStr;
          cell.setAttribute('role','button');
          cell.setAttribute('tabindex', inPickRange ? '0' : '-1');
          cell.setAttribute('aria-disabled', inPickRange ? 'false' : 'true');

          const num = document.createElement('span');
          num.className = 'num';
          num.textContent = String(day);
          cell.appendChild(num);

          const subText = document.createElement('span');
          subText.className = 'sub';
          subText.textContent = dayNames[d.getDay()];
          cell.appendChild(subText);

          if (d.getDay() === 0) cell.classList.add('is-sun');
          if (d.getDay() === 6) cell.classList.add('is-sat');
          if (state.publicHolidaySet.has(dateStr)) cell.classList.add('is-holidayText');

          const st = state.dateMap.get(dateStr);
          if (st?.kind === 'clean') cell.classList.add('is-clean');
          if (st?.kind === 'train') cell.classList.add('is-train');
          if (st?.kind === 'holiday') cell.classList.add('is-paid');

          if (st?.kind === 'holiday'){
            const b = document.createElement('span');
            b.className = 'badge';
            b.textContent = '유급휴일';
            cell.appendChild(b);
          } else if (!st && state.weeklyHolidaySet.has(dateStr)){
            cell.classList.add('is-weekly');
            const b = document.createElement('span');
            b.className = 'badge';
            b.textContent = '주휴';
            cell.appendChild(b);
          }

          if (isSameDay(d, today)) cell.classList.add('is-today');

          if (inPickRange){
            const locked = !!st?.locked;
            if (!locked){
              cell.addEventListener('click', ()=>{
                toggleDate(dateStr);
                syncLockedHolidays();
                renderLists();
                updateWeeklyHolidaySet();
                buildCalendar();
              });
              cell.addEventListener('keydown', (ev)=>{
                if (ev.key==='Enter' || ev.key===' '){
                  ev.preventDefault();
                  toggleDate(dateStr);
                  syncLockedHolidays();
                  renderLists();
                  updateWeeklyHolidaySet();
                  buildCalendar();
                }
              });
            } else {
              cell.style.cursor = 'not-allowed';
            }
          } else {
            cell.style.cursor = 'not-allowed';
          }

          grid.appendChild(cell);
        }

        wrap.appendChild(grid);
        els.calendar.appendChild(wrap);
      });
    }

    function renderLists(){
      const cleanDates = Array.from(state.dateMap.entries())
        .filter(([ds, v]) => v.kind === 'clean')
        .map(([ds, v]) => ({ ds, hours: v.hours ?? 0 }))
        .sort((a,b)=>a.ds.localeCompare(b.ds));

      const trainDates = Array.from(state.dateMap.entries())
        .filter(([ds, v]) => v.kind === 'train' || v.kind === 'holiday')
        .map(([ds, v]) => ({ ds, kind: v.kind, hours: v.hours ?? 0, locked: !!v.locked }))
        .sort((a,b)=>a.ds.localeCompare(b.ds));

      if (cleanDates.length === 0){
        els.cleanListWrap.innerHTML = '<p class="hint" style="padding:10px 12px;">청소일이 없습니다. “선택 모드: 청소일”로 날짜를 클릭하세요.</p>';
      } else {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['날짜','요일','근무시간','청소수당(자동)','삭제'].forEach(t=>{
          const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        cleanDates.forEach(it=>{
          const d = fromYMD(it.ds);
          const tr = document.createElement('tr');

          const td1=document.createElement('td'); td1.textContent=it.ds; tr.appendChild(td1);
          const td2=document.createElement('td'); td2.textContent=d?dayNames[d.getDay()]:'-'; tr.appendChild(td2);

          const td3=document.createElement('td');
          const inp=document.createElement('input');
          inp.type='number'; inp.min='0'; inp.step='0.5';
          inp.value=String(it.hours);
          inp.addEventListener('change', ()=>{
            const v=Math.max(0, parseFloat(inp.value)||0);
            const rec=state.dateMap.get(it.ds);
            if (rec && rec.kind==='clean') rec.hours=v;
            td4.textContent = fmtKRW(cleanPayPerDay(v));
            updateWeeklyHolidaySet();
            buildCalendar();
          });
          td3.appendChild(inp);
          tr.appendChild(td3);

          const td4=document.createElement('td');
          td4.textContent = fmtKRW(cleanPayPerDay(it.hours));
          tr.appendChild(td4);

          const td5=document.createElement('td');
          const btn=document.createElement('button');
          btn.type='button'; btn.className='btn'; btn.textContent='삭제';
          btn.addEventListener('click', ()=>{
            state.dateMap.delete(it.ds);
            syncLockedHolidays();
            renderLists();
            updateWeeklyHolidaySet();
            buildCalendar();
          });
          td5.appendChild(btn);
          tr.appendChild(td5);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        els.cleanListWrap.innerHTML='';
        els.cleanListWrap.appendChild(table);
      }

      if (trainDates.length === 0){
        els.trainListWrap.innerHTML = '<p class="hint" style="padding:10px 12px;">산업안전보건교육/유급휴일이 없습니다.</p>';
      } else {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['날짜','요일','구분','인정시간','삭제'].forEach(t=>{
          const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        trainDates.forEach(it=>{
          const d = fromYMD(it.ds);
          const tr = document.createElement('tr');

          const td1=document.createElement('td'); td1.textContent=it.ds; tr.appendChild(td1);
          const td2=document.createElement('td'); td2.textContent=d?dayNames[d.getDay()]:'-'; tr.appendChild(td2);

          const td3=document.createElement('td');
          td3.textContent = (it.kind==='holiday') ? '유급휴일(근무간주)' : '산업안전보건교육';
          tr.appendChild(td3);

          const td4=document.createElement('td');
          const inp=document.createElement('input');
          inp.type='number'; inp.min='0'; inp.step='0.5';
          inp.value = String(it.hours ?? 0);
          if (it.kind==='holiday'){
            inp.disabled = true;
          } else {
            inp.addEventListener('change', ()=>{
              const v=Math.max(0, parseFloat(inp.value)||0);
              const rec=state.dateMap.get(it.ds);
              if (rec && rec.kind==='train') rec.hours=v;
              updateWeeklyHolidaySet();
              buildCalendar();
            });
          }
          td4.appendChild(inp);
          tr.appendChild(td4);

          const td5=document.createElement('td');
          if (it.kind==='holiday' && it.locked){
            td5.textContent = '-';
          } else {
            const btn=document.createElement('button');
            btn.type='button'; btn.className='btn'; btn.textContent='삭제';
            btn.addEventListener('click', ()=>{
              state.dateMap.delete(it.ds);
              syncLockedHolidays();
              renderLists();
              updateWeeklyHolidaySet();
              buildCalendar();
            });
            td5.appendChild(btn);
          }
          tr.appendChild(td5);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        els.trainListWrap.innerHTML='';
        els.trainListWrap.appendChild(table);
      }
    }

    function calculate(){
      const range = getRange();
      if (!range){
        alert('방학 시작/종료일을 입력하세요.');
        return;
      }
      syncLockedHolidays();
      ensureMonthPayDefaults(false);

      const cookN = Math.max(0, parseInt(els.cookCount.value,10)||0);
      const helperN = Math.max(0, parseInt(els.helperCount.value,10)||0);
      const splitSupport = !!els.splitSupport.checked;
      const afterSemester = !!els.afterSemesterWork.checked;

      const ev = collectEvents();

      const cleanPayPerPerson = ev.clean.reduce((sum,it)=>sum + cleanPayPerDay(it.hours), 0);
      const cleanHoursSum = ev.clean.reduce((sum,it)=>sum + it.hours, 0);
      const trainDays = ev.train.length + ev.hol.length;
      const trainHoursSum = ev.train.reduce((sum,it)=>sum + it.hours, 0) + ev.hol.reduce((sum,it)=>sum + it.hours, 0);

      const allEvents = [...ev.clean, ...ev.train, ...ev.hol];
      const holidayWeekend = computeWeekendHolidays(allEvents, range, afterSemester);

      const workLikeSet = new Set(allEvents.map(x=>toYMD(x.date)));
      const holidayFinal = holidayWeekend.filter(d=>!workLikeSet.has(toYMD(d)));

      const isSupportMonth = (d)=>{
        const m = d.getMonth()+1;
        return (m >= 3 && m <= 11);
      };

      const schoolHolidays = [];
      const supportHolidays = [];
      holidayFinal.forEach(d=>{
        if (splitSupport && isSupportMonth(d)) supportHolidays.push(d);
        else schoolHolidays.push(d);
      });

      const countByMonth = (dates)=>{
        const m = new Map();
        dates.forEach(d=>{
          const k = ymKey(d);
          m.set(k, (m.get(k)||0)+1);
        });
        return m;
      };

      const schoolByMonth = countByMonth(schoolHolidays);
      const supportByMonth = countByMonth(supportHolidays);

      function calcWeeklyPayPerPerson(byMonthMap, role){
        let sum = 0;
        const details = [];
        Array.from(byMonthMap.keys()).sort().forEach(mk=>{
          const cnt = byMonthMap.get(mk)||0;
          if (cnt<=0) return;

          const mp = getMonthPay(mk);
          if (!mp) return;

          const base = (role==='cook' ? mp.baseCook : mp.baseHelper) + mp.mealAllow + mp.hazardAllow;
          const md = mp.monthDays;
          if (!(base > 0 && md > 0)){
            details.push({ month: mk, days: cnt, perDay: 0, amount: 0, note: '입력 필요' });
            return;
          }

          const perDay = base / md;
          const amount = Math.round(perDay * cnt);
          sum += amount;
          details.push({ month: mk, days: cnt, perDay: perDay, amount: amount, note: '' });
        });
        return { sum, details };
      }

      const cookSchool = calcWeeklyPayPerPerson(schoolByMonth, 'cook');
      const helperSchool = calcWeeklyPayPerPerson(schoolByMonth, 'helper');
      const cookSupport = calcWeeklyPayPerPerson(supportByMonth, 'cook');
      const helperSupport = calcWeeklyPayPerPerson(supportByMonth, 'helper');

      const cookPerPersonSchool = cleanPayPerPerson + cookSchool.sum;
      const helperPerPersonSchool = cleanPayPerPerson + helperSchool.sum;

      const cookTotalSchool = cookN * cookPerPersonSchool;
      const helperTotalSchool = helperN * helperPerPersonSchool;
      const kitchenTotalSchool = cookTotalSchool + helperTotalSchool;

      els.resCleanDays.textContent = `${ev.clean.length}일`;
      els.resCleanHours.textContent = `${cleanHoursSum.toFixed(1)}시간`;
      els.resTrainDays.textContent = `${trainDays}일`;
      els.resTrainHours.textContent = `${trainHoursSum.toFixed(1)}시간`;

      els.resSchoolHolidayDays.textContent = `${schoolHolidays.length}일`;
      els.resSchoolHolidayDates.textContent = schoolHolidays.length ? schoolHolidays.map(toYMD).join(', ') : '-';

      els.resSupportHolidayDays.textContent = `${supportHolidays.length}일`;
      els.resSupportHolidayDates.textContent = supportHolidays.length ? supportHolidays.map(toYMD).join(', ') : '-';

      els.resCondHint.innerHTML = `주휴 발생 판단(요약): 해당 주 인정근무시간 합계 <b>15시간 이상</b> + 다음 주(월~금) <b>근무/유급휴일 예정</b>`;

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ['구분','인원','청소수당(1인)','주휴수당(1인, 학교)','1인 합계(학교)','총액(학교지급)']
        .forEach(t=>{ const th=document.createElement('th'); th.textContent=t; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      function addRow(label, n, perClean, perHol, perSum, total){
        const tr=document.createElement('tr');
        const cells=[label, `${n}명`, fmtKRW(perClean), fmtKRW(perHol), fmtKRW(perSum), fmtKRW(total)];
        cells.forEach((v,i)=>{
          const td=document.createElement('td');
          td.textContent=v;
          if (i>=2) td.style.textAlign='right';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }

      if (cookN>0) addRow('조리사', cookN, cleanPayPerPerson, cookSchool.sum, cookPerPersonSchool, cookTotalSchool);
      if (helperN>0) addRow('조리실무사', helperN, cleanPayPerPerson, helperSchool.sum, helperPerPersonSchool, helperTotalSchool);

      const trSum = document.createElement('tr');
      trSum.style.fontWeight='900';
      const td0=document.createElement('td'); td0.textContent='조리실 합계'; trSum.appendChild(td0);
      const td1=document.createElement('td'); td1.textContent=`${cookN+helperN}명`; trSum.appendChild(td1);
      const td2=document.createElement('td'); td2.textContent='-'; td2.style.textAlign='right'; trSum.appendChild(td2);
      const td3=document.createElement('td'); td3.textContent='-'; td3.style.textAlign='right'; trSum.appendChild(td3);
      const td4=document.createElement('td'); td4.textContent='-'; td4.style.textAlign='right'; trSum.appendChild(td4);
      const td5=document.createElement('td'); td5.textContent=fmtKRW(kitchenTotalSchool); td5.style.textAlign='right'; trSum.appendChild(td5);
      tbody.appendChild(trSum);

      table.appendChild(tbody);
      els.resPayTableWrap.innerHTML = '';
      els.resPayTableWrap.appendChild(table);

      const lines = [];
      if (schoolByMonth.size){
        Array.from(schoolByMonth.keys()).sort().forEach(mk=>{
          const cnt = schoolByMonth.get(mk)||0;
          if (!cnt) return;

          const mp = getMonthPay(mk);
          const baseCook = (mp.baseCook + mp.mealAllow + mp.hazardAllow);
          const baseHelper = (mp.baseHelper + mp.mealAllow + mp.hazardAllow);
          const perCook = (mp.monthDays>0 && baseCook>0) ? (baseCook/mp.monthDays) : 0;
          const perHelper = (mp.monthDays>0 && baseHelper>0) ? (baseHelper/mp.monthDays) : 0;

          const part = [`${mk}: 주휴 ${cnt}일`];
          if (cookN>0 && perCook>0) part.push(`조리사(1일≈${Math.round(perCook).toLocaleString('ko-KR')}원)=${fmtKRW(Math.round(perCook*cnt))}`);
          if (helperN>0 && perHelper>0) part.push(`조리실무사(1일≈${Math.round(perHelper).toLocaleString('ko-KR')}원)=${fmtKRW(Math.round(perHelper*cnt))}`);
          lines.push(part.join(' / '));
        });
      }
      els.resMonthBreakdown.textContent = lines.length ? ('월별 주휴수당(학교지급) 요약: ' + lines.join(' | ')) : '-';

      if (splitSupport){
        const infoParts = [];
        if (supportHolidays.length){
          if (cookN>0) infoParts.push(`조리사 지원청 주휴(1인) ${fmtKRW(cookSupport.sum)}`);
          if (helperN>0) infoParts.push(`조리실무사 지원청 주휴(1인) ${fmtKRW(helperSupport.sum)}`);
          els.resSupportInfo.textContent = `참고(지원청 지급분): ${infoParts.join(' / ')} (학교 합계에는 미포함)`;
        } else {
          els.resSupportInfo.textContent = '참고(지원청 지급분): 해당 없음';
        }
      } else {
        els.resSupportInfo.textContent = '※ 3~11월 분리를 해제하면 주휴수당은 모두 “학교 지급분”으로 합산됩니다.';
      }

      updateWeeklyHolidaySet();
      buildCalendar();
    }

    function clearAll(){
      for(const [ds, rec] of Array.from(state.dateMap.entries())){
        if (rec?.locked) continue;
        state.dateMap.delete(ds);
      }
      syncLockedHolidays();
      renderLists();
      updateWeeklyHolidaySet();
      buildCalendar();
    }

    function applySeollal(){
      syncLockedHolidays();
      renderLists();
      updateWeeklyHolidaySet();
      buildCalendar();
    }

    [els.startDate, els.endDate].forEach(el=>{
      el.addEventListener('change', ()=>{
        const range = getRange();
        if (range){
          for(const [ds, rec] of Array.from(state.dateMap.entries())){
            const d = fromYMD(ds);
            if (!d) { state.dateMap.delete(ds); continue; }
            if (rec?.locked) continue;
            if (d < range.s || d > range.e) state.dateMap.delete(ds);
          }
        } else {
          state.dateMap.clear();
        }
        refreshPublicHolidays();
        syncLockedHolidays();
        ensureMonthPayDefaults(false);
        buildMonthPayTable();
        renderLists();
        updateWeeklyHolidaySet();
        buildCalendar();
      });
    });

    els.afterSemesterWork.addEventListener('change', ()=>{
      updateWeeklyHolidaySet();
      buildCalendar();
    });

    els.clearAllBtn.addEventListener('click', clearAll);
    els.applySeollalBtn.addEventListener('click', applySeollal);

    els.fillPayBtn.addEventListener('click', ()=>{
      ensureMonthPayDefaults(true);
      buildMonthPayTable();
    });

    els.calcBtn.addEventListener('click', calculate);

    (function init(){
      if (!els.startDate.value) els.startDate.value = '2026-01-03';
      if (!els.endDate.value) els.endDate.value = '2026-03-02';

      refreshPublicHolidays();
      syncLockedHolidays();
      ensureMonthPayDefaults(false);

      buildMonthPayTable();
      renderLists();
      updateWeeklyHolidaySet();
      buildCalendar();
    })();
  </script>

  <script src="/static/global-loader.js?v=1"></script>
  <script src="/static/footer.js"></script>
  <script src="/static/disable-copy.js"></script>
</body>
</html>