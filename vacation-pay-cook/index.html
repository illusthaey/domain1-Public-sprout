<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>겨울방학중 급식소 청소 인건비 계산기</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .muted{ color:#666; }
    .hint{ color:#666; font-size:0.95rem; }
    .note{ color:#555; font-size:0.95rem; }
    .small{ font-size:0.9rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .grid-3{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    @media (max-width: 860px){
      .grid-3{ grid-template-columns:1fr; }
    }

    .form-row label{
      display:block;
      font-weight:700;
      margin:0 0 6px;
      color:#222;
    }

    .inline{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px 14px;
    }
    .inline label{ margin:0; }

    /* 캘린더 */
    .cal-wrap{ display:flex; flex-direction:column; gap:12px; }
    .cal-month{
      border:1px solid #e9e9e9;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .cal-head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .cal-title{ font-weight:800; }
    .cal-legend{ display:flex; gap:10px; flex-wrap:wrap; font-size:0.9rem; color:#555; }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      display:inline-block;
      vertical-align:middle;
      margin-right:6px;
      border:1px solid #d0d0d0;
    }
    .dot.clean{ background:#e8f4ff; border-color:#b9dbff; }
    .dot.work{ background:#f1e8ff; border-color:#d6c3ff; }
    .dot.holiday{ background:#fff7cc; border-color:#ffe08a; }
    .dot.off{ background:#fafafa; }

    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }
    .cal-dow{
      font-size:0.85rem;
      color:#666;
      text-align:center;
      padding:2px 0 6px;
    }
    .cal-day{
      border:1px solid #e6e6e6;
      border-radius:12px;
      padding:8px 6px;
      min-height:56px;
      text-align:center;
      background:#fafafa;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .cal-day[aria-disabled="true"]{
      opacity:0.35;
      cursor:not-allowed;
    }
    .cal-day .num{ font-weight:800; display:block; line-height:1; }
    .cal-day .sub{ font-size:0.78rem; color:#666; margin-top:6px; display:block; }

    /* 색상 규칙 */
    .cal-day.is-clean{ background:#e8f4ff; border-color:#b9dbff; }
    .cal-day.is-work{ background:#f1e8ff; border-color:#d6c3ff; }
    .cal-day.is-holiday{ background:#fff7cc; border-color:#ffe08a; }

    .cal-day.is-seollal::after{
      content:"설";
      position:absolute;
      top:6px;
      right:6px;
      font-size:0.72rem;
      font-weight:800;
      color:#5b21b6;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(91,33,182,0.25);
      background:rgba(241,232,255,0.85);
    }

    .cal-day.is-today{ outline:2px solid rgba(0,0,0,0.12); outline-offset:1px; }

    /* 결과 */
    .result-grid{ display:flex; flex-direction:column; gap:14px; }
    .result-block{ border-top:1px solid #eee; padding-top:10px; }
    .result-block:first-of-type{ border-top:none; padding-top:0; }
    .result-title{ font-weight:800; margin-bottom:6px; }
    .result-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin:4px 0;
    }
    .result-label{ font-weight:650; }
    .result-value{ min-width:140px; text-align:right; }
    .result-total{ font-size:1.15rem; font-weight:900; text-align:right; }

    .pill{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid #e5e5e5;
      background:#fafafa;
      font-size:0.9rem;
      color:#444;
    }
    .danger{ color:#b00020; font-weight:800; }

    .btn-row{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
    .badge-mini{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e5e5e5;
      background:#fff;
      font-size:0.85rem;
      color:#444;
    }
  </style>
</head>
<body>
  <main class="container" style="max-width:1020px; margin:0 auto; padding:24px 16px;">
    <header class="site-header">
      <div class="shell">
        <h1>겨울방학중 급식소 청소 인건비 계산기</h1>
        <p class="muted">
          ·학교 지급분: <b>방학중근무수당(청소)</b> + <b>주휴수당(토/일)</b><br/>
          ·주휴 산정: <b>주별 근무(근무간주 포함) 시간 합계 ≥ 15시간</b> + <b>다음 주 근무 예정</b> → 해당 주 <b>토/일</b> 주휴 발생<br/>
          ·주휴수당 일할 기준: <span class="mono">(월 기본급 + 정액급식비) ÷ 월력일수(토요일 포함)</span><br/>
          <span class="small">※ 방학 종료 후(예: 3월) 발생 주휴일은 이 계산기 합계에서 제외(참고로만 표기)</span>
        </p>
      </div>
    </header>

    <section class="card">
      <h2>1) 기본 정보</h2>

      <div class="grid-3">
        <div class="form-row">
          <label for="role">직종</label>
          <select id="role">
            <option value="cook" selected>조리사</option>
            <option value="cookHelper">조리실무사</option>
          </select>
        </div>

        <div class="form-row">
          <label for="orgName">소속(학교)</label>
          <input id="orgName" type="text" placeholder="예: 문막초" />
        </div>

        <div class="form-row">
          <label for="workerName">성명</label>
          <input id="workerName" type="text" placeholder="예: 홍길동" />
        </div>
      </div>

      <div class="grid two" style="margin-top:8px;">
        <div class="form-row">
          <label for="payDate">지급일</label>
          <input id="payDate" type="date" />
        </div>
        <div class="form-row">
          <label for="afterSemesterWork">방학 종료 후 다음 주에 학기중 근무 예정</label>
          <div class="inline">
            <input id="afterSemesterWork" type="checkbox" checked />
            <label for="afterSemesterWork" style="display:inline;">개학 등으로 다음 주부터 다시 근무함 (주휴 발생 판단)</label>
          </div>
        </div>
      </div>

      <div class="grid two" style="margin-top:8px;">
        <div class="form-row">
          <label for="startDate">방학 시작일</label>
          <input id="startDate" type="date" />
        </div>
        <div class="form-row">
          <label for="endDate">방학 종료일</label>
          <input id="endDate" type="date" />
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) 일정 선택</h2>

      <div class="inline" style="margin:8px 0 10px;">
        <span class="pill">선택 모드</span>
        <select id="pickMode" style="max-width:260px;">
          <option value="clean" selected>급식소 청소일(학교 수당)</option>
          <option value="work">기타 근무일자(주휴 산정용)</option>
          <option value="erase">해제(삭제)</option>
        </select>

        <span class="pill">기본 시간</span>
        <label class="badge-mini">청소일: <input id="defaultCleanHours" type="number" min="0" step="0.5" value="8" style="width:90px; display:inline-block;" /> 시간</label>
        <label class="badge-mini">기타근무: <input id="defaultWorkHours" type="number" min="0" step="0.5" value="8" style="width:90px; display:inline-block;" /> 시간</label>

        <button type="button" class="btn" id="clearAllBtn">전체 해제</button>
      </div>

      <p class="hint">
        ·캘린더에서 날짜를 클릭하면, 위 “선택 모드”에 따라 <b>청소일(파랑)</b> 또는 <b>기타 근무일자(보라)</b>로 기록됩니다.<br/>
        ·<b>유급 주휴일(토/일)</b>은 자동 산출되어 <b>노란색</b>으로 표시됩니다.<br/>
        ·설 연휴(유급휴일, 근무간주)는 아래에서 날짜 지정 후 “캘린더에 반영”을 누르세요. (각 1일 8시간 근무로 간주)
      </p>

      <div class="inline" style="margin:10px 0 6px;">
        <span class="pill">설연휴(유급휴일·근무간주)</span>
        <label>설 전날 <input id="seollalEve" type="date" style="width:170px; display:inline-block;" /></label>
        <label>설 당일 <input id="seollalDay" type="date" style="width:170px; display:inline-block;" /></label>
        <button type="button" class="btn" id="applySeollalBtn">캘린더에 반영</button>
      </div>

      <div class="cal-legend" style="margin-bottom:6px;">
        <span><span class="dot clean"></span>청소일(학교 수당)</span>
        <span><span class="dot work"></span>기타 근무/설(주휴 산정용)</span>
        <span><span class="dot holiday"></span>유급 주휴일(토/일)</span>
        <span><span class="dot off"></span>미선택</span>
      </div>

      <div class="cal-wrap" id="calendar"></div>

      <h3 style="margin-top:16px;">선택된 날짜 목록</h3>
      <div class="grid two">
        <div>
          <h4 style="margin:0 0 8px;">청소일(학교 지급: 방학중근무수당)</h4>
          <div class="table-wrap" id="cleanListWrap"></div>
        </div>
        <div>
          <h4 style="margin:0 0 8px;">기타 근무일자/설(주휴 산정용)</h4>
          <div class="table-wrap" id="workListWrap"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3) 주휴수당 산정용 월 기본급/정액급식비</h2>
      <p class="muted">
        ·방학중 청소 주휴수당은 <b>기본급+정액급식비만</b>으로 일할 계산합니다(명절휴가비/상여/위험/근속 등 제외).<br/>
        ·분모는 <b>월력일수(토요일 포함)</b> 기본값입니다. (필요 시 수정 가능)
      </p>

      <div class="inline" style="margin:8px 0 10px;">
        <button type="button" class="btn" id="fillPayBtn">월별 값 자동 채우기(예시)</button>
        <span class="hint">예시 자동값: 정액급식비 150,000원 / 기본급은 직종별 2025 예시(필요 시 반드시 수정)</span>
      </div>

      <div class="table-wrap" id="monthPayWrap"></div>
      <p class="hint">※ 방학 기간에 걸친 월만 생성됩니다.</p>
    </section>

    <section class="card">
      <div class="btn-row" style="margin-bottom:10px;">
        <button type="button" class="btn primary" id="calcBtn">계산하기</button>
        <button type="button" class="btn" id="payslipBtn">임금명세서(인쇄/PDF)</button>
      </div>

      <h2>4) 계산 결과</h2>
      <div class="result-grid">
        <div class="result-block">
          <div class="result-title">일정/주휴일</div>

          <div class="result-row">
            <div class="result-label">청소일수</div>
            <div class="result-value" id="resCleanDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">청소 총 근무시간</div>
            <div class="result-value" id="resCleanHours">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">기타 근무/설(주휴 산정용) 일수</div>
            <div class="result-value" id="resWorkDays">-</div>
          </div>

          <div class="result-row" style="margin-top:8px;">
            <div class="result-label">방학 기간 내 유급 주휴일(토/일)</div>
            <div class="result-value" id="resHolidayDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">주휴일(방학 기간 내) 날짜</div>
            <div class="result-value" id="resHolidayDates">-</div>
          </div>

          <div class="result-row" style="margin-top:8px;">
            <div class="result-label">방학 기간 밖 주휴일(참고)</div>
            <div class="result-value" id="resHolidayOutDays">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">주휴일(방학 기간 밖) 날짜</div>
            <div class="result-value" id="resHolidayOutDates">-</div>
          </div>

          <p class="result-help small" id="resCondHint">
            주휴 발생 요건: 주별 근무(근무간주 포함) 시간 합계 ≥ 15시간 + 다음 주 근무 예정 → 토/일 주휴 발생
          </p>
        </div>

        <div class="result-block">
          <div class="result-title">학교 지급 금액</div>

          <div class="result-row">
            <div class="result-label">방학중근무수당(청소) 합계</div>
            <div class="result-value" id="resCleanPay">-</div>
          </div>
          <div class="result-row">
            <div class="result-label">주휴수당 합계(토/일, 방학 기간 내)</div>
            <div class="result-value" id="resHolidayPay">-</div>
          </div>

          <div class="result-row" style="margin-top:6px;">
            <div class="result-label">총 학교 지급</div>
            <div class="result-total" id="resGrand">-</div>
          </div>

          <p class="result-help small" id="resMonthBreakdown">-</p>
        </div>
      </div>

      <p class="note small">
        ·방학중근무수당(청소): 4시간 이하 10,000원 / 4시간 초과 20,000원(청소일별 근무시간 기준).<br/>
        ·주휴수당(학교 지급)은 방학 기간 내에 발생한 주휴일(토/일)만 합산합니다. 방학 종료 후(예: 3월) 주휴일은 참고로만 표시합니다.<br/>
        ·지원청 지급분(월정액 일할계산 기본급/정액급식비)은 이 계산기 합계에 포함하지 않습니다(주휴 산정의 기준값으로만 사용).
      </p>
    </section>

    <div class="btns">
      <a class="btn" href="/">메인으로 돌아가기</a>
    </div>
  </main>

  <script>
    const pad2 = (n) => String(n).padStart(2, '0');
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const fromYMD = (s) => {
      if (!s) return null;
      const [y,m,d] = s.split('-').map(Number);
      if (!y || !m || !d) return null;
      const dt = new Date(y, m-1, d);
      dt.setHours(0,0,0,0);
      return dt;
    };
    const addDays = (d, n) => {
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      x.setHours(0,0,0,0);
      return x;
    };
    const ymKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const parseYmKey = (k) => {
      const m = /^(\d{4})-(\d{2})$/.exec(k);
      if (!m) return null;
      return { y:+m[1], m:+m[2] };
    };
    const dayNames = ['일','월','화','수','목','금','토'];
    const fmtKRW = (v) => (v===null||v===undefined||isNaN(v)) ? '-' : (Math.round(v).toLocaleString('ko-KR') + '원');
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

    function startOfWeekMon(date){
      const d = new Date(date);
      const dow = d.getDay();
      const diff = (dow === 0) ? -6 : (1 - dow);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }
    function weekKey(date){ return toYMD(startOfWeekMon(date)); }
    function nextWeekKey(wk){
      const mon = fromYMD(wk);
      if (!mon) return '';
      return toYMD(addDays(mon, 7));
    }
    function monthKeysBetween(start, end){
      const keys=[];
      const cur = new Date(start.getFullYear(), start.getMonth(), 1);
      const last = new Date(end.getFullYear(), end.getMonth(), 1);
      while(cur <= last){
        keys.push(ymKey(cur));
        cur.setMonth(cur.getMonth()+1);
      }
      return keys;
    }
    function countMonthDays(year, monthIndex0){
      return new Date(year, monthIndex0+1, 0).getDate();
    }
    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    const state = {
      dateMap: new Map(),
      monthPayMap: new Map(),
      lastCalc: null,
    };

    const els = {
      role: document.getElementById('role'),
      orgName: document.getElementById('orgName'),
      workerName: document.getElementById('workerName'),
      payDate: document.getElementById('payDate'),
      afterSemesterWork: document.getElementById('afterSemesterWork'),

      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),

      pickMode: document.getElementById('pickMode'),
      defaultCleanHours: document.getElementById('defaultCleanHours'),
      defaultWorkHours: document.getElementById('defaultWorkHours'),
      clearAllBtn: document.getElementById('clearAllBtn'),

      seollalEve: document.getElementById('seollalEve'),
      seollalDay: document.getElementById('seollalDay'),
      applySeollalBtn: document.getElementById('applySeollalBtn'),

      calendar: document.getElementById('calendar'),
      cleanListWrap: document.getElementById('cleanListWrap'),
      workListWrap: document.getElementById('workListWrap'),

      fillPayBtn: document.getElementById('fillPayBtn'),
      monthPayWrap: document.getElementById('monthPayWrap'),

      calcBtn: document.getElementById('calcBtn'),
      payslipBtn: document.getElementById('payslipBtn'),

      resCleanDays: document.getElementById('resCleanDays'),
      resCleanHours: document.getElementById('resCleanHours'),
      resWorkDays: document.getElementById('resWorkDays'),
      resHolidayDays: document.getElementById('resHolidayDays'),
      resHolidayDates: document.getElementById('resHolidayDates'),
      resHolidayOutDays: document.getElementById('resHolidayOutDays'),
      resHolidayOutDates: document.getElementById('resHolidayOutDates'),
      resCondHint: document.getElementById('resCondHint'),

      resCleanPay: document.getElementById('resCleanPay'),
      resHolidayPay: document.getElementById('resHolidayPay'),
      resGrand: document.getElementById('resGrand'),
      resMonthBreakdown: document.getElementById('resMonthBreakdown'),
    };

    function getRange(){
      const s = fromYMD(els.startDate.value);
      const e = fromYMD(els.endDate.value);
      if (!(s && e && e >= s)) return null;
      return { s, e };
    }

    function setDateKind(dateStr, kind){
      if (!kind){ state.dateMap.delete(dateStr); return; }
      const cur = state.dateMap.get(dateStr);
      if (kind === 'clean'){
        const defH = Math.max(0, parseFloat(els.defaultCleanHours.value) || 0);
        state.dateMap.set(dateStr, { kind:'clean', hours: cur?.kind==='clean' ? (cur.hours ?? defH) : defH });
        return;
      }
      if (kind === 'work'){
        const defH = Math.max(0, parseFloat(els.defaultWorkHours.value) || 0);
        state.dateMap.set(dateStr, { kind:'work', hours: cur?.kind==='work' ? (cur.hours ?? defH) : defH });
        return;
      }
      if (kind === 'seollal'){
        state.dateMap.set(dateStr, { kind:'seollal', hours: 8 });
        return;
      }
    }

    function toggleDate(dateStr){
      const range = getRange();
      if (!range) return;

      const mode = els.pickMode.value;
      const cur = state.dateMap.get(dateStr);

      if (mode === 'erase'){ state.dateMap.delete(dateStr); return; }
      if (mode === 'clean'){
        if (cur?.kind === 'clean') state.dateMap.delete(dateStr);
        else setDateKind(dateStr, 'clean');
        return;
      }
      if (mode === 'work'){
        if (cur?.kind === 'work') state.dateMap.delete(dateStr);
        else setDateKind(dateStr, 'work');
        return;
      }
    }

    function getWorkLikeEntries(){
      const out=[];
      for (const [ds, v] of state.dateMap.entries()){
        const date = fromYMD(ds);
        if (!date) continue;
        if (v.kind === 'clean' || v.kind === 'work' || v.kind === 'seollal'){
          out.push({ ds, date, kind:v.kind, hours: Math.max(0, parseFloat(v.hours)||0) });
        }
      }
      out.sort((a,b)=>a.ds.localeCompare(b.ds));
      return out;
    }

    function computeWeekendHolidays(workLikeEntries, rangeEnd, afterSemesterWork){
      const weeks = new Map(); // wk -> { mon, hours }
      workLikeEntries.forEach((it)=>{
        const wk = weekKey(it.date);
        const rec = weeks.get(wk) || { mon: startOfWeekMon(it.date), hours:0 };
        rec.hours += (it.hours || 0);
        weeks.set(wk, rec);
      });

      const holidayDates=[];
      Array.from(weeks.keys()).sort().forEach((wk)=>{
        const rec = weeks.get(wk);
        if (!rec) return;
        if (rec.hours < 15) return;

        const nextK = nextWeekKey(wk);
        const nextRec = weeks.get(nextK);
        const nextMon = fromYMD(nextK);

        const hasNextWork = (nextRec && nextRec.hours > 0)
          || (afterSemesterWork && nextMon && nextMon > rangeEnd);

        if (!hasNextWork) return;
        holidayDates.push(addDays(rec.mon,5), addDays(rec.mon,6));
      });

      const uniq=new Map();
      holidayDates.forEach(d=>uniq.set(toYMD(d), d));
      return Array.from(uniq.values()).sort((a,b)=>a-b);
    }

    function computeDerived(range){
      if (!range) return {
        holidayAll: [], holidayInRange: [], holidayOutRange: [],
        holidayInSet:new Set(), holidayOutSet:new Set(), workLikeSet:new Set(),
      };

      const afterSemesterWork = !!els.afterSemesterWork.checked;
      const workLike = getWorkLikeEntries();
      const workLikeSet = new Set(workLike.map(x=>x.ds));

      const holidayAll = computeWeekendHolidays(workLike, range.e, afterSemesterWork)
        .filter(d => !workLikeSet.has(toYMD(d)));

      const holidayInRange = holidayAll.filter(d => d>=range.s && d<=range.e);
      const holidayOutRange = holidayAll.filter(d => d<range.s || d>range.e);

      return {
        holidayAll,
        holidayInRange,
        holidayOutRange,
        holidayInSet: new Set(holidayInRange.map(toYMD)),
        holidayOutSet: new Set(holidayOutRange.map(toYMD)),
        workLikeSet
      };
    }

    function buildCalendar(){
      els.calendar.innerHTML = '';
      const range = getRange();
      if (!range){
        els.calendar.innerHTML = '<p class="hint">방학 시작/종료일을 입력하면 달력이 생성됩니다.</p>';
        return;
      }
      const { s, e } = range;
      const endPlus7 = addDays(e, 7);
      const keys = monthKeysBetween(s, endPlus7);

      const today = new Date(); today.setHours(0,0,0,0);
      const derived = computeDerived(range);

      keys.forEach((k)=>{
        const ym = parseYmKey(k);
        if (!ym) return;

        const year = ym.y;
        const month = ym.m - 1;

        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month+1, 0);

        const wrap = document.createElement('div');
        wrap.className = 'cal-month';

        const head = document.createElement('div');
        head.className = 'cal-head';
        const title = document.createElement('div');
        title.className = 'cal-title';
        title.textContent = `${year}년 ${month+1}월`;
        const sub = document.createElement('div');
        sub.className = 'hint';
        sub.textContent = '날짜 클릭 → 선택 모드에 따라 기록';
        head.appendChild(title);
        head.appendChild(sub);
        wrap.appendChild(head);

        const grid = document.createElement('div');
        grid.className = 'cal-grid';

        ['일','월','화','수','목','금','토'].forEach((dn)=>{
          const el = document.createElement('div');
          el.className = 'cal-dow';
          el.textContent = dn;
          grid.appendChild(el);
        });

        const firstDow = monthStart.getDay();
        for(let i=0;i<firstDow;i++){
          const blank = document.createElement('div');
          blank.className = 'cal-day';
          blank.setAttribute('aria-disabled','true');
          blank.style.visibility='hidden';
          grid.appendChild(blank);
        }

        const daysInMonth = monthEnd.getDate();
        for(let day=1; day<=daysInMonth; day++){
          const d = new Date(year, month, day);
          d.setHours(0,0,0,0);

          const dateStr = toYMD(d);
          const inPickRange = (d >= s && d <= e);
          const inViewRange = (d >= s && d <= endPlus7);

          const cell = document.createElement('div');
          cell.className = 'cal-day';
          cell.dataset.date = dateStr;
          cell.setAttribute('role','button');
          cell.setAttribute('tabindex', inPickRange ? '0' : '-1');
          cell.setAttribute('aria-disabled', inPickRange ? 'false' : 'true');

          const num = document.createElement('span');
          num.className = 'num';
          num.textContent = String(day);
          cell.appendChild(num);

          const subText = document.createElement('span');
          subText.className = 'sub';
          subText.textContent = dayNames[d.getDay()];
          cell.appendChild(subText);

          const st = state.dateMap.get(dateStr);
          if (st?.kind === 'clean') cell.classList.add('is-clean');
          if (st?.kind === 'work' || st?.kind === 'seollal') cell.classList.add('is-work');
          if (st?.kind === 'seollal') cell.classList.add('is-seollal');

          if (derived.holidayInSet.has(dateStr)) cell.classList.add('is-holiday');
          else if (!inPickRange && inViewRange && derived.holidayOutSet.has(dateStr)) cell.classList.add('is-holiday');

          if (isSameDay(d, today)) cell.classList.add('is-today');

          if (inPickRange){
            cell.addEventListener('click', ()=>{
              toggleDate(dateStr);
              renderLists();
              buildCalendar();
            });
            cell.addEventListener('keydown', (ev)=>{
              if (ev.key==='Enter' || ev.key===' '){
                ev.preventDefault();
                toggleDate(dateStr);
                renderLists();
                buildCalendar();
              }
            });
          } else {
            cell.style.opacity = inViewRange ? '0.35' : '0.15';
            cell.style.cursor = 'not-allowed';
          }

          grid.appendChild(cell);
        }

        wrap.appendChild(grid);
        els.calendar.appendChild(wrap);
      });
    }

    function cleanPayPerDay(hours){
      const h = Math.max(0, parseFloat(hours)||0);
      if (h <= 0) return 0;
      return (h <= 4) ? 10000 : 20000;
    }

    function renderLists(){
      const cleanDates = Array.from(state.dateMap.entries())
        .filter(([ds, v]) => v.kind === 'clean')
        .map(([ds, v]) => ({ ds, hours: v.hours ?? 0 }))
        .sort((a,b)=>a.ds.localeCompare(b.ds));

      const workDates = Array.from(state.dateMap.entries())
        .filter(([ds, v]) => v.kind === 'work' || v.kind === 'seollal')
        .map(([ds, v]) => ({ ds, kind: v.kind, hours: v.hours ?? 0 }))
        .sort((a,b)=>a.ds.localeCompare(b.ds));

      if (cleanDates.length === 0){
        els.cleanListWrap.innerHTML = '<p class="hint" style="padding:10px 12px;">청소일이 없습니다. “선택 모드: 급식소 청소일”로 날짜를 클릭하세요.</p>';
      } else {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['날짜','요일','근무시간','수당(자동)','삭제'].forEach((t)=>{
          const th=document.createElement('th');
          th.textContent=t;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        cleanDates.forEach((it)=>{
          const d = fromYMD(it.ds);
          const tr = document.createElement('tr');

          const td1=document.createElement('td'); td1.textContent=it.ds; tr.appendChild(td1);
          const td2=document.createElement('td'); td2.textContent=d?dayNames[d.getDay()]:'-'; tr.appendChild(td2);

          const td3=document.createElement('td');
          const inp=document.createElement('input');
          inp.type='number'; inp.min='0'; inp.step='0.5';
          inp.value=String(it.hours);
          inp.addEventListener('change', ()=>{
            const v=Math.max(0, parseFloat(inp.value)||0);
            const rec=state.dateMap.get(it.ds);
            if (rec && rec.kind==='clean') rec.hours=v;
            td4.textContent = fmtKRW(cleanPayPerDay(v));
          });
          td3.appendChild(inp);
          tr.appendChild(td3);

          const td4=document.createElement('td');
          td4.textContent = fmtKRW(cleanPayPerDay(it.hours));
          tr.appendChild(td4);

          const td5=document.createElement('td');
          const btn=document.createElement('button');
          btn.type='button'; btn.className='btn'; btn.textContent='삭제';
          btn.addEventListener('click', ()=>{
            state.dateMap.delete(it.ds);
            renderLists();
            buildCalendar();
          });
          td5.appendChild(btn);
          tr.appendChild(td5);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        els.cleanListWrap.innerHTML='';
        els.cleanListWrap.appendChild(table);
      }

      if (workDates.length === 0){
        els.workListWrap.innerHTML = '<p class="hint" style="padding:10px 12px;">기타 근무/설(주휴 산정용) 날짜가 없습니다. “선택 모드: 기타 근무일자”로 날짜를 클릭하거나, 설 날짜를 반영하세요.</p>';
      } else {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['날짜','요일','구분','근무시간(주휴요건)','삭제'].forEach((t)=>{
          const th=document.createElement('th');
          th.textContent=t;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        workDates.forEach((it)=>{
          const d = fromYMD(it.ds);
          const tr = document.createElement('tr');

          const td1=document.createElement('td'); td1.textContent=it.ds; tr.appendChild(td1);
          const td2=document.createElement('td'); td2.textContent=d?dayNames[d.getDay()]:'-'; tr.appendChild(td2);

          const td3=document.createElement('td');
          td3.textContent = (it.kind==='seollal') ? '설(유급휴일·근무간주)' : '기타 근무일자';
          tr.appendChild(td3);

          const td4=document.createElement('td');
          if (it.kind === 'seollal'){
            const inp=document.createElement('input');
            inp.type='number'; inp.value='8'; inp.disabled=true;
            td4.appendChild(inp);
          } else {
            const inp=document.createElement('input');
            inp.type='number'; inp.min='0'; inp.step='0.5';
            inp.value=String(it.hours ?? 0);
            inp.addEventListener('change', ()=>{
              const v=Math.max(0, parseFloat(inp.value)||0);
              const rec=state.dateMap.get(it.ds);
              if (rec && rec.kind==='work') rec.hours=v;
            });
            td4.appendChild(inp);
          }
          tr.appendChild(td4);

          const td5=document.createElement('td');
          const btn=document.createElement('button');
          btn.type='button'; btn.className='btn'; btn.textContent='삭제';
          btn.addEventListener('click', ()=>{
            state.dateMap.delete(it.ds);
            renderLists();
            buildCalendar();
          });
          td5.appendChild(btn);
          tr.appendChild(td5);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        els.workListWrap.innerHTML='';
        els.workListWrap.appendChild(table);
      }
    }

    function inferBasePay(role, dateObj){
      const cut = new Date(2025, 2, 1);
      const isAfter = dateObj >= cut;
      if (role === 'cook') return isAfter ? 2169300 : 2085300;
      return isAfter ? 2066000 : 1986000;
    }

    function ensureMonthPayDefaults(force=false){
      const range = getRange();
      if (!range) return;

      const { s, e } = range;
      const keys = monthKeysBetween(s, e);
      const role = els.role.value;

      keys.forEach((mk)=>{
        const ym = parseYmKey(mk);
        if (!ym) return;
        const monthStart = new Date(ym.y, ym.m-1, 1);
        const autoDays = countMonthDays(ym.y, ym.m-1);

        const defaults = {
          monthDays: autoDays,
          basePay: inferBasePay(role, monthStart),
          mealAllow: 150000,
        };

        const prev = state.monthPayMap.get(mk);
        if (force || !prev){
          state.monthPayMap.set(mk, { ...defaults, manual:false });
          return;
        }
        if (prev.manual){
          const fixed = { ...prev };
          if (!(fixed.monthDays > 0)) fixed.monthDays = autoDays;
          state.monthPayMap.set(mk, fixed);
          return;
        }
        state.monthPayMap.set(mk, { ...prev, ...defaults, monthDays: (prev.monthDays>0)?prev.monthDays:autoDays, manual:false });
      });

      const keySet = new Set(keys);
      for (const k of Array.from(state.monthPayMap.keys())){
        if (!keySet.has(k)) state.monthPayMap.delete(k);
      }
    }

    function buildMonthPayTable(){
      els.monthPayWrap.innerHTML='';
      const range = getRange();
      if (!range){
        els.monthPayWrap.innerHTML = '<p class="hint" style="padding:10px 12px;">방학 기간을 입력하면 월별 항목이 생성됩니다.</p>';
        return;
      }
      ensureMonthPayDefaults(false);

      const { s, e } = range;
      const keys = monthKeysBetween(s, e);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ['월(YYYY-MM)','월력일수(토요일 포함)','기본급(월정액)','정액급식비(월정액)'].forEach(t=>{
        const th=document.createElement('th'); th.textContent=t; trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      keys.forEach((mk)=>{
        const ym = parseYmKey(mk);
        if (!ym) return;
        const autoDays = countMonthDays(ym.y, ym.m-1);
        const saved = state.monthPayMap.get(mk) || { monthDays:autoDays, basePay:0, mealAllow:150000, manual:false };

        const row = document.createElement('tr');

        const td0=document.createElement('td'); td0.textContent=mk; row.appendChild(td0);

        const tdDays=document.createElement('td');
        const inpDays=document.createElement('input');
        inpDays.type='number'; inpDays.min='1'; inpDays.max='31'; inpDays.step='1';
        inpDays.value=String(saved.monthDays ?? autoDays);
        tdDays.appendChild(inpDays); row.appendChild(tdDays);

        const tdBase=document.createElement('td');
        const inpBase=document.createElement('input');
        inpBase.type='number'; inpBase.min='0'; inpBase.step='10';
        inpBase.value=String(saved.basePay ?? 0);
        tdBase.appendChild(inpBase); row.appendChild(tdBase);

        const tdMeal=document.createElement('td');
        const inpMeal=document.createElement('input');
        inpMeal.type='number'; inpMeal.min='0'; inpMeal.step='10';
        inpMeal.value=String(saved.mealAllow ?? 0);
        tdMeal.appendChild(inpMeal); row.appendChild(tdMeal);

        const saveRow = ()=>{
          const prev = state.monthPayMap.get(mk) || {};
          state.monthPayMap.set(mk, {
            ...prev,
            monthDays: clamp(parseInt(inpDays.value,10)||autoDays, 1, 31),
            basePay: Math.max(0, parseFloat(inpBase.value)||0),
            mealAllow: Math.max(0, parseFloat(inpMeal.value)||0),
            manual:true
          });
        };
        [inpDays, inpBase, inpMeal].forEach(inp=>inp.addEventListener('change', saveRow));

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      els.monthPayWrap.appendChild(table);
    }

    function getMonthPay(mk){
      const ym = parseYmKey(mk);
      if (!ym) return null;
      const autoDays = countMonthDays(ym.y, ym.m-1);
      const rec = state.monthPayMap.get(mk);
      if (!rec) return { monthDays:autoDays, basePay:0, mealAllow:0 };
      return { monthDays: rec.monthDays ?? autoDays, basePay: rec.basePay ?? 0, mealAllow: rec.mealAllow ?? 0 };
    }

    function calculate(){
      const range = getRange();
      if (!range){
        alert('방학 시작/종료일을 입력하세요.');
        return null;
      }
      ensureMonthPayDefaults(false);

      const derived = computeDerived(range);

      const cleanDates = Array.from(state.dateMap.entries())
        .filter(([ds, v]) => v.kind==='clean')
        .map(([ds, v]) => ({ ds, date: fromYMD(ds), hours: Math.max(0, parseFloat(v.hours)||0) }))
        .filter(x=>x.date && x.hours>0)
        .sort((a,b)=>a.ds.localeCompare(b.ds));

      const workDates = Array.from(state.dateMap.entries())
        .filter(([ds, v]) => v.kind==='work' || v.kind==='seollal')
        .map(([ds, v]) => ({ ds, date: fromYMD(ds), kind:v.kind, hours: Math.max(0, parseFloat(v.hours)||0) }))
        .filter(x=>x.date && x.hours>0)
        .sort((a,b)=>a.ds.localeCompare(b.ds));

      const cleanPay = cleanDates.reduce((s,it)=>s+cleanPayPerDay(it.hours),0);

      const holidayIn = derived.holidayInRange;
      const holidayOut = derived.holidayOutRange;

      const holByMonth = new Map();
      holidayIn.forEach(d=>{
        const k = ymKey(d);
        holByMonth.set(k,(holByMonth.get(k)||0)+1);
      });

      let holidayPay = 0;
      const breakdownLines = [];

      Array.from(holByMonth.keys()).sort().forEach((mk)=>{
        const cnt = holByMonth.get(mk)||0;
        if (cnt<=0) return;
        const mp = getMonthPay(mk);
        const base = mp.basePay + mp.mealAllow;
        const mdays = mp.monthDays;

        if (base<=0 || mdays<=0){
          breakdownLines.push(`${mk}: 주휴 ${cnt}일 → 기본급/급식비 또는 월력일수 입력 필요`);
          return;
        }
        const perDay = base/mdays;
        const sub = Math.round(perDay*cnt);
        holidayPay += sub;
        breakdownLines.push(`${mk}: 주휴 ${cnt}일 × (${Math.round(perDay).toLocaleString('ko-KR')}원/일) ≈ ${fmtKRW(sub)}`);
      });

      const grand = cleanPay + holidayPay;

      els.resCleanDays.textContent = `${cleanDates.length}일`;
      els.resCleanHours.textContent = `${cleanDates.reduce((s,x)=>s+x.hours,0).toFixed(1)}시간`;
      els.resWorkDays.textContent = `${workDates.length}일`;

      els.resHolidayDays.textContent = `${holidayIn.length}일`;
      els.resHolidayDates.textContent = holidayIn.length ? holidayIn.map(toYMD).join(', ') : '-';

      els.resHolidayOutDays.textContent = `${holidayOut.length}일`;
      els.resHolidayOutDates.textContent = holidayOut.length ? holidayOut.map(toYMD).join(', ') : '-';

      els.resCleanPay.textContent = fmtKRW(cleanPay);
      els.resHolidayPay.textContent = fmtKRW(holidayPay);
      els.resGrand.textContent = fmtKRW(grand);

      els.resMonthBreakdown.textContent = breakdownLines.length ? ('월별 주휴수당: ' + breakdownLines.join(' / ')) : '-';

      state.lastCalc = { cleanPay, holidayPay, grand };
      return state.lastCalc;
    }

    function applySeollal(){
      const range = getRange();
      if (!range){ alert('방학 기간을 먼저 입력하세요.'); return; }
      const { s, e } = range;

      const eve = fromYMD(els.seollalEve.value);
      const day = fromYMD(els.seollalDay.value);

      const applyOne = (dt)=>{
        if (!dt) return;
        if (dt < s || dt > e) return;
        setDateKind(toYMD(dt), 'seollal');
      };
      applyOne(eve);
      applyOne(day);

      renderLists();
      buildCalendar();
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function buildPayslipHTML(calc){
      // 간단히: 현재 화면의 계산을 다시 수행
      const r = getRange();
      const calcNow = calculate();
      if (!r || !calcNow) return '';

      const title = '겨울방학중 급식소 청소 인건비 임금명세서';
      const org = (els.orgName.value||'').trim() || '-';
      const name = (els.workerName.value||'').trim() || '-';
      const role = els.role.value==='cook' ? '조리사' : '조리실무사';
      const payDate = els.payDate.value || '-';
      const rangeText = `${els.startDate.value} ~ ${els.endDate.value}`;

      return `
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>${escapeHtml(title)}</title>
<style>
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "맑은 고딕", sans-serif; margin:18px; color:#111; }
  h1{ font-size:20px; margin:0 0 12px; text-align:center; }
  .btnbar{ display:flex; gap:8px; justify-content:flex-end; margin:10px 0 14px; }
  button{ padding:10px 14px; border:1px solid #111; border-radius:10px; background:#fff; cursor:pointer; font-weight:700; }
  button:hover{ background:#f3f4f6; }
  .sheet{ border:1px solid #e5e5e5; border-radius:12px; padding:14px; background:#fff; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid #e5e7eb; padding:8px 10px; vertical-align:top; }
  th{ background:#f9fafb; text-align:left; }
  .right{ text-align:right; }
  .total{ font-size:18px; font-weight:900; }
  @media print{
    .btnbar{ display:none; }
    body{ margin:0; }
    .sheet{ border:none; padding:0; }
  }
</style>
</head>
<body>
  <div class="btnbar">
    <button onclick="window.print()">인쇄 / PDF 저장</button>
    <button onclick="window.close()">닫기</button>
  </div>

  <div class="sheet">
    <h1>${escapeHtml(title)}</h1>

    <table>
      <tr>
        <th style="width:18%;">소속</th><td style="width:32%;">${escapeHtml(org)}</td>
        <th style="width:18%;">지급일</th><td style="width:32%;">${escapeHtml(payDate)}</td>
      </tr>
      <tr>
        <th>성명</th><td>${escapeHtml(name)}</td>
        <th>직종</th><td>${escapeHtml(role)}</td>
      </tr>
      <tr>
        <th>방학기간</th><td colspan="3">${escapeHtml(rangeText)}</td>
      </tr>
    </table>

    <div style="height:10px;"></div>

    <table>
      <tr>
        <th style="width:28%;">임금항목</th>
        <th>산출 내역</th>
        <th style="width:18%;" class="right">금액</th>
      </tr>
      <tr>
        <td><b>방학중근무수당(청소)</b></td>
        <td>결과 화면의 합계 기준</td>
        <td class="right">${Math.round(calcNow.cleanPay).toLocaleString('ko-KR')}원</td>
      </tr>
      <tr>
        <td><b>주휴수당(토/일)</b></td>
        <td>결과 화면의 합계 기준</td>
        <td class="right">${Math.round(calcNow.holidayPay).toLocaleString('ko-KR')}원</td>
      </tr>
      <tr>
        <td colspan="2" class="right total">총 학교 지급</td>
        <td class="right total">${Math.round(calcNow.grand).toLocaleString('ko-KR')}원</td>
      </tr>
    </table>
  </div>
</body>
</html>
      `.trim();
    }

    function openPayslip(){
      const calc = calculate();
      if (!calc) return;

      const html = buildPayslipHTML(calc);
      const w = window.open('', '_blank');
      if (!w){
        alert('팝업이 차단되어 임금명세서를 열 수 없습니다. 팝업 허용 후 다시 시도하세요.');
        return;
      }
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    function clearAll(){
      state.dateMap.clear();
      renderLists();
      buildCalendar();
    }

    [els.startDate, els.endDate].forEach((el)=>{
      el.addEventListener('change', ()=>{
        const range = getRange();
        if (range){
          const { s, e } = range;
          for(const ds of Array.from(state.dateMap.keys())){
            const d = fromYMD(ds);
            if (!d || d < s || d > e) state.dateMap.delete(ds);
          }
        } else {
          state.dateMap.clear();
        }
        renderLists();
        buildCalendar();
        buildMonthPayTable();
      });
    });

    els.afterSemesterWork.addEventListener('change', buildCalendar);
    els.clearAllBtn.addEventListener('click', clearAll);
    els.applySeollalBtn.addEventListener('click', applySeollal);

    els.fillPayBtn.addEventListener('click', ()=>{
      ensureMonthPayDefaults(true);
      buildMonthPayTable();
    });

    els.role.addEventListener('change', ()=>{
      ensureMonthPayDefaults(false);
      buildMonthPayTable();
    });

    els.calcBtn.addEventListener('click', calculate);
    els.payslipBtn.addEventListener('click', openPayslip);

    (function init(){
      const today = new Date(); today.setHours(0,0,0,0);
      els.payDate.value = toYMD(today);

      els.seollalEve.value = '2026-02-16';
      els.seollalDay.value = '2026-02-17';

      buildCalendar();
      renderLists();
      buildMonthPayTable();
    })();
  </script>

  <script src="/static/global-loader.js?v=1"></script>
  <script src="/static/footer.js"></script>
  <script src="/static/disable-copy.js"></script>
</body>
</html>