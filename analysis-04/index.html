<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>강원도교육청 인사발령 집계/분류</title>

  <!-- 공통 CSS 유지 -->
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    /* ===== 이 페이지 전용 최소 보강 ===== */
    .section { scroll-margin-top: 18px; }
    .hint { font-size: 0.95rem; color:#666; margin: 8px 0 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#fafafa; font-size:0.9rem; color:#444; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; font-size:0.95rem; }
    .pill b { color:#111; }

    .dropzone {
      border: 2px dashed #d1d5db;
      border-radius: 14px;
      padding: 18px;
      background: #fafafa;
      transition: background-color .15s ease, border-color .15s ease;
    }
    .dropzone.dragover {
      background: #eef2ff;
      border-color: #93c5fd;
    }
    .dropzone .row { gap: 10px; }
    .file-input { display:none; }

    .progress-wrap { margin: 10px 0 14px; }
    .progress-line {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #eef2f7;
      border: 1px solid #e5e7eb;
      overflow:hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: #111;
      transition: width .15s ease;
    }
    .progress-meta { display:flex; justify-content:space-between; gap:10px; margin: 6px 0 0; }
    .progress-meta .muted { margin:0; }
    .progress-meta .mono { font-size:0.95rem; color:#444; }

    .file-list {
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
    }
    .file-item {
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      margin: 8px 0;
    }
    .file-item .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 560px; }
    @media (max-width: 640px) { .file-item .name { max-width: 240px; } }

    .kpi-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .kpi {
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      padding: 14px 14px;
      background: #fff;
      cursor: default;
    }
    .kpi.clickable { cursor:pointer; }
    .kpi:hover.clickable { background:#f9fafb; }
    .kpi .label { font-size:0.95rem; color:#666; margin:0 0 8px; }
    .kpi .value { font-size:1.7rem; font-weight:800; color:#111; margin:0; }
    .kpi .sub { font-size:0.95rem; color:#555; margin:6px 0 0; }

    .toolbar {
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .toolbar .left, .toolbar .right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .field { display:flex; flex-direction:column; gap:6px; min-width: 180px; }
    .field label { font-size:0.95rem; color:#444; }
    .filters { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); margin-top: 10px; }

    .panel {
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      background: #fff;
      padding: 14px 14px;
      margin-top: 14px;
    }
    .panel h4 { margin: 0 0 8px; }
    .panel .meta { margin: 0 0 10px; color:#666; font-size:0.95rem; }

    /* 헤더 틀고정 */
    table.sheetlike.sticky thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #f9fafb;
    }

    /* 스크롤 따라다니는 상단 이동 버튼(왼쪽 하단) */
    #toTopBtn {
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 999;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: rgba(255,255,255,0.92);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      user-select:none;
    }
    #toTopBtn:hover { background: #eef2ff; }
    #toTopBtn span { font-size: 20px; line-height: 1; color:#111; }

    details.compact {
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #fafafa;
      padding: 10px 12px;
      margin-top: 12px;
    }
    details.compact > summary {
      cursor:pointer;
      font-weight: 800;
      color:#111;
      list-style:none;
    }
    details.compact > summary::-webkit-details-marker { display:none; }
    details.compact > summary::before { content:"▸ "; }
    details.compact[open] > summary::before { content:"▾ "; }
    .warn {
      border: 1px solid #fca5a5;
      background: #fff1f2;
      color:#7f1d1d;
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0 0;
      font-size: 0.98rem;
    }
    .ok {
      border: 1px solid #86efac;
      background: #f0fdf4;
      color:#14532d;
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0 0;
      font-size: 0.98rem;
    }
    .small { font-size: 0.95rem; color:#555; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="shell">
      <h1>강원도교육청 인사발령 집계/분류</h1>
      <p class="subtitle">도단위 + 관내 인사발령 엑셀(또는 ZIP) 업로드 → 전체 집계 + 학교/기관별 + 시군구별 상세 조회</p>
    </div>
  </header>

  <main class="container">
    <!-- 1. 업로드 -->
    <section class="section" id="sec-upload">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0;">1) 인사발령 엑셀파일 업로드</h2>
          <span class="badge" id="libBadge">라이브러리 로딩중…</span>
        </div>
      </div>
      <hr />

      <div class="progress-wrap">
        <div class="progress-line" aria-label="진행률">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-meta">
          <p class="muted" id="progressText">라이브러리(XLSX) 불러오는 중…</p>
          <div class="mono" id="progressPct">0%</div>
        </div>
      </div>

      <div class="card">
        <div class="dropzone" id="dropzone" role="button" tabindex="0" aria-label="파일 업로드 드래그 앤 드롭">
          <div class="row between">
            <div>
              <p style="margin:0; font-weight:800; color:#111;">여기로 파일을 드래그해서 업로드</p>
              <p class="hint">
                .xlsx / .xls / .zip 지원 (ZIP 안에 엑셀 여러 개 들어있어도 자동 분석)
              </p>
            </div>
            <div class="row">
              <button class="btn ghost" id="pickFilesBtn" type="button">파일 선택</button>
              <input class="file-input" id="fileInput" type="file" multiple
                     accept=".xlsx,.xls,.zip,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/zip" />
            </div>
          </div>
        </div>

        <div class="row between" style="margin-top:12px;">
          <div class="row gap">
            <button class="btn primary" id="analyzeBtn" type="button" disabled>인사정보 집계하기</button>
            <button class="btn" id="resetBtn" type="button">초기화</button>
          </div>
          <div class="pill" title="현재 업로드된 파일 수">
            <span>업로드</span>
            <b id="fileCount">0</b>
            <span>개</span>
          </div>
        </div>

        <details class="compact" id="filesDetails">
          <summary>업로드한 파일 목록 보기</summary>
          <ul class="file-list" id="fileList"></ul>
          <p class="small" style="margin:10px 0 0;">
            ※ 파일은 계속 추가 업로드 가능하며, 분석은 <b>“인사정보 집계하기”</b> 버튼을 눌러야 시작됩니다.
          </p>
        </details>

        <div id="schoolMasterStatus" class="warn" style="display:none;"></div>
      </div>
    </section>

    <!-- 2. 전체 집계 -->
    <section class="section" id="sec-dashboard">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0;">2) 전체 집계 결과 조회</h2>
        </div>
      </div>
      <hr />

      <div id="dashboardEmpty" class="card">
        <p style="margin:0;">
          먼저 <b>엑셀/ZIP</b>을 업로드하고 <b>인사정보 집계하기</b>를 눌러주세요.
        </p>
        <p class="hint">집계 결과는 도단위/관내 파일이 섞여도 중복(특히 “교육장이 지정하는 부서…”)을 최대한 제거하도록 설계했습니다.</p>
      </div>

      <div id="dashboardWrap" style="display:none;">
        <div class="kpi-grid" id="kpiGrid"></div>

        <div class="card" style="margin-top:12px;">
          <div class="row between">
            <h3 style="margin:0;">시군구 지역별 집계 (오름차순)</h3>
            <div class="row">
              <button class="btn pastel-blue" type="button" id="jumpSchoolOrg">학교/기관별 상세로</button>
              <button class="btn pastel-yellow" type="button" id="jumpRegion">지역별 상세로</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="sheetlike sticky" id="regionSummaryTable">
              <thead>
                <tr>
                  <th>지역</th>
                  <th class="numeric">전입</th>
                  <th class="numeric">전출</th>
                  <th class="numeric">지역변동없음</th>
                  <th class="numeric">퇴직/면직</th>
                  <th class="numeric">신규/임용</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p class="hint">행(지역)을 클릭하면 4번 “시군구별 조회”로 이동하며 해당 지역을 자동 선택합니다.</p>
        </div>
      </div>
    </section>

    <!-- 3. 학교/기관별 상세 -->
    <section class="section" id="sec-org">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0;">3) 상세 내역 조회 (학교 및 기관별)</h2>
        </div>
        <div class="right">
          <button class="btn" id="downloadOrgBtn" type="button" disabled>조회 결과 엑셀로 다운로드</button>
        </div>
      </div>
      <hr />

      <div class="card">
        <div class="filters">
          <div class="field">
            <label for="orgKindSel">구분</label>
            <select id="orgKindSel" disabled>
              <option value="">(선택)</option>
              <option value="학교">학교</option>
              <option value="기관">기관</option>
            </select>
          </div>
          <div class="field">
            <label for="orgNameSel">학교/기관</label>
            <select id="orgNameSel" disabled></select>
          </div>
          <div class="field">
            <label for="orgTypeSel">직군</label>
            <select id="orgTypeSel" disabled>
              <option value="전체">전체</option>
              <option value="지방공무원">지방공무원</option>
              <option value="교육공무원">교육공무원</option>
              <option value="교육공무직">교육공무직</option>
              <option value="미분류">미분류</option>
            </select>
          </div>
          <div class="field">
            <label for="orgJobSel">직렬/직급/직종</label>
            <select id="orgJobSel" disabled></select>
          </div>
        </div>

        <div id="orgResultNote" class="hint" style="margin-top:10px;">
          집계 후 드롭박스를 선택하면 자동으로 아래 패널이 갱신됩니다.
        </div>
      </div>

      <div id="orgPanels" style="display:none;">
        <div class="panel">
          <h4>패널 1) 전출자 / 퇴직자</h4>
          <p class="meta" id="orgPanel1Meta"></p>
          <div class="table-wrap">
            <table class="sheetlike sticky" id="orgPanel1Table">
              <thead>
                <tr>
                  <th>성명</th>
                  <th>직군</th>
                  <th>직렬/직급/직종</th>
                  <th>현소속(발령 전)</th>
                  <th>발령(임용) 후</th>
                  <th>전지역</th>
                  <th>후지역</th>
                  <th>비고</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h4>패널 2) 전입자 / 신규 발령자 / 파견 근무자</h4>
          <p class="meta" id="orgPanel2Meta"></p>
          <div class="table-wrap">
            <table class="sheetlike sticky" id="orgPanel2Table">
              <thead>
                <tr>
                  <th>성명</th>
                  <th>직군</th>
                  <th>직렬/직급/직종</th>
                  <th>현소속(발령 전)</th>
                  <th>발령(임용) 후</th>
                  <th>전지역</th>
                  <th>후지역</th>
                  <th>비고</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <details class="compact">
          <summary>미분류/기타(접기 기본) 보기</summary>
          <div class="panel" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">미분류/기타</h4>
            <p class="meta" id="orgPanel3Meta"></p>
            <div class="table-wrap">
              <table class="sheetlike sticky" id="orgPanel3Table">
                <thead>
                  <tr>
                    <th>성명</th>
                    <th>직군</th>
                    <th>직렬/직급/직종</th>
                    <th>현소속(발령 전)</th>
                    <th>발령(임용) 후</th>
                    <th>전지역</th>
                    <th>후지역</th>
                    <th>비고</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- 4. 시군구별 상세 -->
    <section class="section" id="sec-region">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0;">4) 상세 발령 내역 (시군구별 조회)</h2>
        </div>
        <div class="right">
          <button class="btn" id="downloadRegionBtn" type="button" disabled>조회 결과 엑셀로 다운로드</button>
        </div>
      </div>
      <hr />

      <div class="card">
        <div class="filters">
          <div class="field">
            <label for="regionModeSel">강원도교육청 처리</label>
            <select id="regionModeSel" disabled>
              <option value="">(선택)</option>
              <option value="분리">강원도교육청을 시군구와 분리</option>
              <option value="합산">강원도교육청을 춘천에 합산</option>
            </select>
          </div>
          <div class="field">
            <label for="regionSel">지역</label>
            <select id="regionSel" disabled></select>
          </div>
          <div class="field">
            <label for="regionTypeSel">직군</label>
            <select id="regionTypeSel" disabled>
              <option value="전체">전체</option>
              <option value="지방공무원">지방공무원</option>
              <option value="교육공무원">교육공무원</option>
              <option value="교육공무직">교육공무직</option>
              <option value="미분류">미분류</option>
            </select>
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          ※ “속초/양양”은 <b>속초양양</b>으로 합산 집계합니다. “강원특별자치도동해/원주/태백/홍천/화천” 등도 해당 시군구로 통합합니다.
        </div>
      </div>

      <div id="regionPanels" style="display:none;">
        <div class="panel">
          <h4>패널 1) 전출자 / 퇴직자</h4>
          <p class="meta" id="regionPanel1Meta"></p>
          <div class="table-wrap">
            <table class="sheetlike sticky" id="regionPanel1Table">
              <thead>
                <tr>
                  <th>성명</th>
                  <th>직군</th>
                  <th>직렬/직급/직종</th>
                  <th>현소속(발령 전)</th>
                  <th>발령(임용) 후</th>
                  <th>전지역</th>
                  <th>후지역</th>
                  <th>비고</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h4>패널 2) 전입자 / 신규 발령자</h4>
          <p class="meta" id="regionPanel2Meta"></p>
          <div class="table-wrap">
            <table class="sheetlike sticky" id="regionPanel2Table">
              <thead>
                <tr>
                  <th>성명</th>
                  <th>직군</th>
                  <th>직렬/직급/직종</th>
                  <th>현소속(발령 전)</th>
                  <th>발령(임용) 후</th>
                  <th>전지역</th>
                  <th>후지역</th>
                  <th>비고</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h4>패널 3) 지역변동 없는 사람들(관내 이동/제자리/부서간 이동/휴·복직/파견 연장 등)</h4>
          <p class="meta" id="regionPanel3Meta"></p>
          <div class="table-wrap">
            <table class="sheetlike sticky" id="regionPanel3Table">
              <thead>
                <tr>
                  <th>성명</th>
                  <th>직군</th>
                  <th>직렬/직급/직종</th>
                  <th>현소속(발령 전)</th>
                  <th>발령(임용) 후</th>
                  <th>전지역</th>
                  <th>후지역</th>
                  <th>비고</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <details class="compact">
          <summary>미분류/기타(접기 기본) 보기</summary>
          <div class="panel" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">미분류/기타</h4>
            <p class="meta" id="regionPanel4Meta"></p>
            <div class="table-wrap">
              <table class="sheetlike sticky" id="regionPanel4Table">
                <thead>
                  <tr>
                    <th>성명</th>
                    <th>직군</th>
                    <th>직렬/직급/직종</th>
                    <th>현소속(발령 전)</th>
                    <th>발령(임용) 후</th>
                    <th>전지역</th>
                    <th>후지역</th>
                    <th>비고</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </details>
      </div>
    </section>

    <footer class="site-footer">
      <div class="shell">
        <p>※ 이름/발령지/근무지 등은 마스킹 없이 표시되도록 구성되었습니다.</p>
        <p>※ 셀 병합/줄바꿈/특수문자에 최대한 강인하게 처리하지만, 극단적으로 깨진 양식은 “미분류”로 떨어질 수 있습니다.</p>
      </div>
    </footer>
  </main>

  <button id="toTopBtn" type="button" title="맨 위로">
    <span>↑</span>
  </button>

  <script>
    /**********************************************************************
     * 0) 라이브러리 로더 (XLSX + JSZip) + 상태바 표시
     *********************************************************************/
    const ui = {
      libBadge: document.getElementById('libBadge'),
      progressBar: document.getElementById('progressBar'),
      progressText: document.getElementById('progressText'),
      progressPct: document.getElementById('progressPct'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      resetBtn: document.getElementById('resetBtn'),
      fileCount: document.getElementById('fileCount'),
      fileList: document.getElementById('fileList'),
      filesDetails: document.getElementById('filesDetails'),
      schoolMasterStatus: document.getElementById('schoolMasterStatus'),

      dashboardEmpty: document.getElementById('dashboardEmpty'),
      dashboardWrap: document.getElementById('dashboardWrap'),
      kpiGrid: document.getElementById('kpiGrid'),
      regionSummaryTable: document.getElementById('regionSummaryTable').querySelector('tbody'),
      jumpSchoolOrg: document.getElementById('jumpSchoolOrg'),
      jumpRegion: document.getElementById('jumpRegion'),

      orgKindSel: document.getElementById('orgKindSel'),
      orgNameSel: document.getElementById('orgNameSel'),
      orgTypeSel: document.getElementById('orgTypeSel'),
      orgJobSel: document.getElementById('orgJobSel'),
      downloadOrgBtn: document.getElementById('downloadOrgBtn'),
      orgPanels: document.getElementById('orgPanels'),
      orgPanel1Meta: document.getElementById('orgPanel1Meta'),
      orgPanel2Meta: document.getElementById('orgPanel2Meta'),
      orgPanel3Meta: document.getElementById('orgPanel3Meta'),
      orgPanel1Table: document.getElementById('orgPanel1Table').querySelector('tbody'),
      orgPanel2Table: document.getElementById('orgPanel2Table').querySelector('tbody'),
      orgPanel3Table: document.getElementById('orgPanel3Table').querySelector('tbody'),

      regionModeSel: document.getElementById('regionModeSel'),
      regionSel: document.getElementById('regionSel'),
      regionTypeSel: document.getElementById('regionTypeSel'),
      downloadRegionBtn: document.getElementById('downloadRegionBtn'),
      regionPanels: document.getElementById('regionPanels'),
      regionPanel1Meta: document.getElementById('regionPanel1Meta'),
      regionPanel2Meta: document.getElementById('regionPanel2Meta'),
      regionPanel3Meta: document.getElementById('regionPanel3Meta'),
      regionPanel4Meta: document.getElementById('regionPanel4Meta'),
      regionPanel1Table: document.getElementById('regionPanel1Table').querySelector('tbody'),
      regionPanel2Table: document.getElementById('regionPanel2Table').querySelector('tbody'),
      regionPanel3Table: document.getElementById('regionPanel3Table').querySelector('tbody'),
      regionPanel4Table: document.getElementById('regionPanel4Table').querySelector('tbody'),
    };

    function setProgress(pct, text) {
      const p = Math.max(0, Math.min(100, pct));
      ui.progressBar.style.width = p + '%';
      ui.progressPct.textContent = Math.round(p) + '%';
      if (text) ui.progressText.textContent = text;
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('스크립트 로드 실패: ' + src));
        document.head.appendChild(s);
      });
    }

    async function loadLibs() {
      ui.libBadge.textContent = '라이브러리 로딩중…';
      setProgress(2, '라이브러리(XLSX) 불러오는 중…');

      // “초반 %” 느낌을 주기 위한 약한 가짜 진행
      let fake = 2;
      const timer = setInterval(() => {
        fake = Math.min(fake + 3, 18);
        setProgress(fake);
      }, 120);

      try {
        await loadScript('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');
        await loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js');

        clearInterval(timer);
        setProgress(100, '라이브러리 로드 완료');
        ui.libBadge.textContent = '라이브러리 로드 완료';
        ui.libBadge.classList.add('badge');
        enableAnalyzeIfReady();
      } catch (e) {
        clearInterval(timer);
        setProgress(100, '라이브러리 로드 실패 (네트워크/차단 확인 필요)');
        ui.libBadge.textContent = '라이브러리 로드 실패';
        ui.schoolMasterStatus.style.display = 'block';
        ui.schoolMasterStatus.textContent =
          '라이브러리(XLSX/JSZip) 로드에 실패했습니다. 사내망/보안정책으로 CDN이 차단된 경우, 로컬에 라이브러리를 호스팅해야 합니다.';
        console.error(e);
      }
    }

    /**********************************************************************
     * 1) 업로드 UI + 상태
     *********************************************************************/
    const dropzone = document.getElementById('dropzone');
    const pickFilesBtn = document.getElementById('pickFilesBtn');
    const fileInput = document.getElementById('fileInput');
    const toTopBtn = document.getElementById('toTopBtn');

    // 파일 저장소
    /** @type {{file: File, id: string}[]} */
    let fileStore = [];
    let storeSeq = 0;

    function addFiles(files) {
      const arr = Array.from(files || []);
      if (!arr.length) return;

      for (const f of arr) {
        const id = 'f_' + (++storeSeq);
        fileStore.push({ file: f, id });
      }
      renderFileList();
      enableAnalyzeIfReady();
    }

    function removeFile(id) {
      fileStore = fileStore.filter(x => x.id !== id);
      renderFileList();
      enableAnalyzeIfReady();
    }

    function resetAll() {
      fileStore = [];
      storeSeq = 0;

      state = makeEmptyState();
      renderFileList();

      // 결과 UI 초기화
      ui.dashboardEmpty.style.display = 'block';
      ui.dashboardWrap.style.display = 'none';

      ui.orgPanels.style.display = 'none';
      ui.downloadOrgBtn.disabled = true;
      ui.orgKindSel.disabled = true;
      ui.orgNameSel.disabled = true;
      ui.orgTypeSel.disabled = true;
      ui.orgJobSel.disabled = true;

      ui.regionPanels.style.display = 'none';
      ui.downloadRegionBtn.disabled = true;
      ui.regionModeSel.disabled = true;
      ui.regionSel.disabled = true;
      ui.regionTypeSel.disabled = true;

      ui.schoolMasterStatus.style.display = 'none';
      ui.schoolMasterStatus.textContent = '';

      setProgress(100, '라이브러리 로드 완료');
    }

    function renderFileList() {
      ui.fileCount.textContent = String(fileStore.length);
      ui.fileList.innerHTML = '';

      // 기본 접힘
      ui.filesDetails.open = false;

      const sorted = [...fileStore].sort((a,b) => (a.file.name||'').localeCompare(b.file.name||'', 'ko'));
      for (const item of sorted) {
        const li = document.createElement('li');
        li.className = 'file-item';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.style.gap = '2px';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.file.name;

        const meta = document.createElement('div');
        meta.className = 'muted';
        meta.style.fontSize = '0.9rem';
        meta.textContent = `${formatBytes(item.file.size)} · ${guessExt(item.file.name).toUpperCase()}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement('div');
        right.className = 'row';
        const btn = document.createElement('button');
        btn.className = 'btn btn-lightgrey';
        btn.type = 'button';
        btn.textContent = '삭제';
        btn.onclick = () => removeFile(item.id);
        right.appendChild(btn);

        li.appendChild(left);
        li.appendChild(right);
        ui.fileList.appendChild(li);
      }
    }

    function enableAnalyzeIfReady() {
      const libsOk = (typeof XLSX !== 'undefined') && (typeof JSZip !== 'undefined');
      ui.analyzeBtn.disabled = !(libsOk && fileStore.length > 0);
    }

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return '';
      const units = ['B','KB','MB','GB'];
      let b = bytes, i = 0;
      while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
      return `${b.toFixed(i ? 1 : 0)} ${units[i]}`;
    }

    function guessExt(name) {
      const m = (name || '').toLowerCase().match(/\.(xlsx|xls|zip)$/);
      return m ? m[1] : 'file';
    }

    // drag/drop
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      addFiles(e.dataTransfer.files);
    });
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') fileInput.click();
    });

    pickFilesBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      addFiles(e.target.files);
      fileInput.value = '';
    });

    ui.resetBtn.addEventListener('click', resetAll);

    // toTop
    window.addEventListener('scroll', () => {
      const y = window.scrollY || document.documentElement.scrollTop;
      toTopBtn.style.display = (y > 400) ? 'flex' : 'none';
    });
    toTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    ui.jumpSchoolOrg.addEventListener('click', () => document.getElementById('sec-org').scrollIntoView({behavior:'smooth'}));
    ui.jumpRegion.addEventListener('click', () => document.getElementById('sec-region').scrollIntoView({behavior:'smooth'}));

    /**********************************************************************
     * 2) 도메인 규칙(직군/직렬/직종/기관/지역)
     *********************************************************************/
    const REGION_LIST_18 = [
      '강원도교육청',
      '강릉','고성','동해','삼척','속초양양','양구','영월','원주','인제','정선','철원','춘천','태백','평창','홍천','화천','횡성',
    ];
    const REGION_LIST_17 = [
      '강릉','고성','동해','삼척','속초양양','양구','영월','원주','인제','정선','철원','춘천','태백','평창','홍천','화천','횡성',
    ];

    const LOCAL_RANK_SUFFIX = ['서기보시보','서기보','서기','주사보','주사','서기관','사무관'];
    const LOCAL_SERIES = [
      '지방교육행정','지방시설관리','지방시설','지방전산','지방사무운영','지방운전','지방식품위생','지방조리','지방사서','지방공업'
    ];

    const EDU_WORKER_JOBS = Array.from(new Set([
      '치료사','장애영아지도사','장애유아지도사','직업지도사','유치원방과후교육사','학교도서관사서','기숙사생활지도원','전문상담사','영양사','교육복지사',
      '평생교육사','사회복지사','진로교육사','학교도서관실무사','특수교육지도사','건강실무사','조리사','조리실무사','교무행정사','발명실무원','통학차량운전원',
      '통학지도원','늘봄학교전담사','초등돌봄전담사','방과후전담사','임상심리사','대안교육전문가','학습클리닉전문가','학부모지원전문가','진학전문지원관',
      '학교운동부지도자','교육지도사','방과후학교지원가','구육성회직원'
    ]));

    const EDU_TEACHER_KEYWORDS = [
      '유치원교사','초등학교교사','중등학교교사','특수학교교사','실기교사','보건교사','사서교사','전문상담교사','영양교사',
      '초등학교 교사','중학교 교사','고등학교 교사','특수학교 교사','교사','교감','교장'
    ];

    const GWEO_DEPT_KEYWORDS = [
      '감사관','공보담당관','정책국','교육국','행정국',
      '정책기획과','미래교육과','안전복지과','교육지원과',
      '유초등교육과','중등교육과','인성생활교육과','문화체육특수교육과',
      '총무과','예산과','행정과','시설과','학교지원과',
    ];

    const DIRECT_INSTITUTES = [
      '강원특별자치도교육청 교육연구원','강원특별자치도교육청 교육연수원','강원특별자치도교육청 교육과학정보원','강원특별자치도교육청 진로교육원',
      '강원특별자치도교육청 국제교육원','강원특별자치도교육청 유아교육원','강원특별자치도교육청 사임당교육원','강원특별자치도교육청 학생교육원',
      '강원특별자치도교육청 통일교육원','강원특별자치도교육청 교직원수련원','강원특별자치도교육청 춘천교육문화관','강원특별자치도교육청 원주교육문화관',
      '강원특별자치도교육청 강릉교육문화관','강원특별자치도교육청 속초교육문화관','강원특별자치도교육청 삼척교육문화관'
    ];
    const DIRECT_INSTITUTE_REGION = new Map([
      ['강원특별자치도교육청 교육연구원','춘천'],
      ['강원특별자치도교육청 유아교육원','춘천'],
      ['강원특별자치도교육청 학생교육원','춘천'],
      ['강원특별자치도교육청 춘천교육문화관','춘천'],

      ['강원특별자치도교육청 교육연수원','강릉'],
      ['강원특별자치도교육청 사임당교육원','강릉'],
      ['강원특별자치도교육청 교직원수련원','강릉'],
      ['강원특별자치도교육청 강릉교육문화관','강릉'],

      ['강원특별자치도교육청 교육과학정보원','원주'],
      ['강원특별자치도교육청 원주교육문화관','원주'],

      ['강원특별자치도교육청 진로교육원','속초양양'],
      ['강원특별자치도교육청 속초교육문화관','속초양양'],

      // 사용자 메모: 국제교육원: 철원 / 통일교육원: 양양
      ['강원특별자치도교육청 국제교육원','철원'],
      ['강원특별자치도교육청 통일교육원','속초양양'],

      ['강원특별자치도교육청 삼척교육문화관','삼척'],
    ]);

    /**********************************************************************
     * 3) 상태(집계 데이터)
     *********************************************************************/
    function makeEmptyState() {
      return {
        schoolMasterLoaded: false,
        schoolNameToRegion: new Map(),  // canonical school name -> region
        schoolCanonToFull: new Map(),   // canonical key -> full original name
        schoolFullSet: new Set(),       // full school names

        records: [],                    // 최종 레코드
        aggregates: null,               // 대시보드/지역 집계
        orgIndex: null,                 // 학교/기관 리스트
      };
    }
    let state = makeEmptyState();

    /**********************************************************************
     * 4) 문자열/정규화 유틸
     *********************************************************************/
    function cleanText(v) {
      if (v === null || v === undefined) return '';
      let s = String(v);
      // 줄바꿈/탭 → 공백
      s = s.replace(/[\r\n\t]+/g, ' ');
      // 특수한 공백 다듬기
      s = s.replace(/\u00A0/g, ' ');
      // 다중 공백 축소
      s = s.replace(/\s{2,}/g, ' ');
      return s.trim();
    }

    function stripAllSpaces(s) {
      return cleanText(s).replace(/\s+/g, '');
    }

    function isKoreanName(s) {
      const t = cleanText(s);
      if (!t) return false;

      // 숫자/특수문자 포함 시 제외
      if (/[^가-힣]/.test(t)) return false;

      // 2~5자 한글 이름만 통과(보수적으로)
      if (!/^[가-힣]{2,5}$/.test(t)) return false;

      // 아래 단어가 이름 칸에 들어가면 무시(셀병합 과집계 방지)
      const banWords = ['강원특별자치도','강원도','교육장', ...REGION_LIST_18];
      if (banWords.some(w => t.includes(w))) return false;

      return true;
    }

    function normalizeRegionText(s) {
      let t = stripAllSpaces(s);
      t = t.replace(/^강원특별자치도/,'').replace(/^강원도/,'');
      // "속초", "양양"은 합산
      if (t === '속초' || t === '양양') return '속초양양';
      // "강원특별자치도동해" 같은 것 처리
      if (t.startsWith('속초양양')) return '속초양양';
      // 18개 지역 매칭
      for (const r of REGION_LIST_18) {
        if (t === stripAllSpaces(r)) return r;
      }
      return '';
    }

    function looksLikeOrg(s) {
      const t = cleanText(s);
      if (!t) return false;
      // 지역명 단독은 제외(조합일 수도 있으니 완전 배제는 X, 점수로 처리)
      // 기관/학교 흔한 패턴
      if (/(유치원|초등학교|중학교|고등학교|학교|교육지원청|교육청|교육문화관|교육연구원|교육연수원|교육과학정보원|진로교육원|국제교육원|유아교육원|사임당교육원|학생교육원|통일교육원|교직원수련원)/.test(t)) return true;
      // 축약형(…초/…중/…고)도 허용
      if (/[가-힣]{2,}(초|중|고)$/.test(t)) return true;
      if (/병설유치원/.test(t)) return true;
      return false;
    }

    function normalizeSchoolShortName(s) {
      // "남호초" -> "남호초등학교", "북원중" -> "북원중학교", "가곡고" -> "가곡고등학교"
      const t = cleanText(s);
      if (!t) return '';
      if (t.includes('교육지원청') || t.includes('교육청')) return t;

      // 이미 완전표기
      if (/(유치원|초등학교|중학교|고등학교|학교)/.test(t)) return t;

      // "동내초 및 병설유치원" 유형 처리(아래에서 다시 한번)
      // 축약형
      const m1 = t.match(/^(.+?)(초|중|고)$/);
      if (m1) {
        const base = m1[1];
        const tail = m1[2];
        if (tail === '초') return base + '초등학교';
        if (tail === '중') return base + '중학교';
        if (tail === '고') return base + '고등학교';
      }
      return t;
    }

    function normalizeOfficeDeptToOne(org) {
      const t = cleanText(org);
      if (!t) return '';
      // 강원특별자치도교육청/강원도교육청 표기 통일
      const compact = stripAllSpaces(t);
      if (compact.includes('강원특별자치도교육청') || compact.includes('강원도교육청')) {
        // 부서 키워드가 있으면 본청으로 통합
        if (GWEO_DEPT_KEYWORDS.some(k => compact.includes(stripAllSpaces(k)))) return '강원도교육청';
        // "강원특별자치도교육청" 자체도 통합
        return '강원도교육청';
      }
      // 부서명만 찍힌 경우도 통합
      if (GWEO_DEPT_KEYWORDS.some(k => stripAllSpaces(t).includes(stripAllSpaces(k)))) return '강원도교육청';
      return t;
    }

    function normalizeOrgName(raw) {
      let t = cleanText(raw);
      if (!t) return '';

      // 흔한 접두/불필요 구분
      t = t.replace(/^\[|\]$/g,'');
      t = t.replace(/\(.*?\)/g, (m) => m); // 괄호는 유지(단, 필요시 추후 조정)
      t = t.replace(/강원특별자치도\s*/g, '강원특별자치도'); // 붙여쓰기/띄어쓰기 흔들림 안정

      // 본청 통합
      t = normalizeOfficeDeptToOne(t);

      // 직속기관 이름도 공백 흔들림 보정
      for (const inst of DIRECT_INSTITUTES) {
        if (stripAllSpaces(t) === stripAllSpaces(inst)) return inst;
      }

      // "동내초 및 병설유치원" 류
      const annexPattern = /^(.+?)(초등학교|초)\s*및\s*병설유치원$/;
      const m = t.match(annexPattern);
      if (m) {
        const base = m[1] + '초등학교';
        return base + ' 및 병설유치원';
      }

      // 병설유치원 자체명/초등학교 축약 보정
      t = normalizeSchoolShortName(t);

      // "…초병설유치원" 같이 붙어있으면 공백 보정 없이도 인식 가능
      // (표시는 그룹 단계에서 합산 처리)

      return t;
    }

    function isAnnexKindergarten(org) {
      const t = cleanText(org);
      return /병설유치원/.test(t) || /및\s*병설유치원/.test(t);
    }

    function annexBaseSchool(org) {
      // "문막초병설유치원" -> "문막초등학교"
      // "문막초등학교 및 병설유치원" -> "문막초등학교"
      const t = cleanText(org);
      if (!t) return '';
      if (/및\s*병설유치원/.test(t)) return cleanText(t.replace(/\s*및\s*병설유치원/g,''));
      if (/병설유치원/.test(t)) {
        const base = t.replace(/병설유치원/g,'');
        return normalizeSchoolShortName(base);
      }
      return '';
    }

    function normalizeCombinedAnnexLabel(baseSchool) {
      // baseSchool는 "…초등학교"라고 가정
      const b = cleanText(baseSchool);
      if (!b) return '';
      if (b.includes('및 병설유치원')) return b;
      if (/초등학교$/.test(b)) return b + ' 및 병설유치원';
      // 혹시 base가 축약이면 확장
      return normalizeSchoolShortName(b) + ' 및 병설유치원';
    }

    function detectEmployeeType(texts) {
      const t = stripAllSpaces(texts.join(' '));

      // 지방공무원 판별: "지방" 시작 or 특정 직급 suffix
      if (t.includes('지방')) return '지방공무원';
      for (const suf of LOCAL_RANK_SUFFIX) {
        if (t.endsWith(suf) || t.includes(suf)) return '지방공무원';
      }

      // 교육공무직: 직종 목록 포함
      for (const job of EDU_WORKER_JOBS) {
        if (t.includes(stripAllSpaces(job))) return '교육공무직';
      }

      // 교육공무원: 교사/교감/교장 등 키워드
      for (const kw of EDU_TEACHER_KEYWORDS) {
        if (t.includes(stripAllSpaces(kw))) return '교육공무원';
      }

      return '미분류';
    }

    function detectLocalSeries(texts) {
      const t = stripAllSpaces(texts.join(' '));
      for (const s of LOCAL_SERIES) {
        if (t.includes(stripAllSpaces(s))) return s;
      }
      // "지방교육행정주사" 등: "지방교육행정" 포함으로 잡히는 편
      return '';
    }

    function detectEduWorkerJob(texts) {
      const t = stripAllSpaces(texts.join(' '));
      for (const job of EDU_WORKER_JOBS) {
        if (t.includes(stripAllSpaces(job))) return job;
      }
      return '';
    }

    function detectTeacherRole(texts) {
      // 교과목이 들어오는 경우(예: "국어", "수학")까지 완벽히 커버는 어렵지만,
      // 표에 있는 키워드를 최대한 보존해서 jobLabel로 사용
      const joined = cleanText(texts.join(' '));
      for (const kw of EDU_TEACHER_KEYWORDS) {
        if (joined.includes(kw)) return kw;
      }
      // "초등학교 교사" 같은 형태
      const m = joined.match(/(유치원|초등학교|중학교|고등학교|특수학교)\s*교사/);
      if (m) return m[0].replace(/\s{2,}/g,' ').trim();
      // "보건교사" 등
      const m2 = joined.match(/(보건교사|영양교사|사서교사|전문상담교사)/);
      if (m2) return m2[0];
      return '';
    }

    function detectFlags(texts) {
      const t = stripAllSpaces(texts.join(' '));
      const flags = {
        isRetire: /퇴직|면직|정년|명예퇴직|의원면직|사직|해임/.test(t),
        isNew: /신규|신규임용|신규발령|임용/.test(t),
        isDispatch: /파견/.test(t),
        isLeave: /휴직/.test(t),
        isReturn: /복직/.test(t),
        isExtend: /연장/.test(t),
        hasOrdinanceRule: /조례|시행규칙/.test(t),
        isPlaceholder: /교육장[이가]지정|교육장이 지정|교육장지정/.test(t),
      };
      return flags;
    }

    function scoreOrgCandidate(v, schoolMap) {
      const s = cleanText(v);
      if (!s) return -999;
      let score = 0;

      const r = normalizeRegionText(s);
      if (r) score -= 6;

      if (looksLikeOrg(s)) score += 6;
      if (schoolMap && schoolMap.has(canonSchoolKey(s))) score += 4;

      // 너무 짧으면 감점
      if (stripAllSpaces(s).length <= 1) score -= 5;

      return score;
    }

    function canonSchoolKey(name) {
      // 마스터 매칭을 위한 canonical key
      let t = normalizeOrgName(name);
      t = t.replace(/\s+/g,'');
      // 통일된 교육청 표기
      t = t.replace(/강원특별자치도교육청/g,'강원도교육청');
      // 병설유치원은 base로도 키 생성 가능하지만, 일단 원문 유지
      return t;
    }

    function isLikelySchoolName(org) {
      const t = cleanText(org);
      if (!t) return false;
      if (/교육지원청|교육청|교육문화관|교육연구원|교육연수원|교육과학정보원|진로교육원|국제교육원|유아교육원|사임당교육원|학생교육원|통일교육원|교직원수련원/.test(t)) return false;
      return /(유치원|초등학교|중학교|고등학교|학교|병설유치원)/.test(t) || /[가-힣]{2,}(초|중|고)$/.test(t) || /및\s*병설유치원/.test(t);
    }

    function isLikelyInstitution(org) {
      const t = cleanText(org);
      if (!t) return false;
      if (/교육지원청|교육청/.test(t)) return true;
      for (const inst of DIRECT_INSTITUTES) {
        if (stripAllSpaces(t) === stripAllSpaces(inst)) return true;
      }
      if (t === '강원도교육청') return true;
      // 기타 기관명 패턴
      if (/(교육문화관|교육연구원|교육연수원|교육과학정보원|진로교육원|국제교육원|유아교육원|사임당교육원|학생교육원|통일교육원|교직원수련원)/.test(t)) return true;
      return false;
    }

    function inferRegionFromOrg(org, schoolMap) {
      const t = cleanText(org);
      if (!t) return '';

      // 본청
      if (t === '강원도교육청') return '강원도교육청';

      // 직속기관
      for (const inst of DIRECT_INSTITUTES) {
        if (stripAllSpaces(t) === stripAllSpaces(inst)) return DIRECT_INSTITUTE_REGION.get(inst) || '';
      }

      // 교육지원청은 앞 지역에서 추론
      for (const r of REGION_LIST_17) {
        if (stripAllSpaces(t).includes(stripAllSpaces(r) + '교육지원청')) return r;
      }

      // "강원특별자치도동해" 같은 꼴
      const r0 = normalizeRegionText(t);
      if (r0) return r0;

      // 학교 마스터로 매칭
      const key = canonSchoolKey(t);
      if (schoolMap && schoolMap.has(key)) return schoolMap.get(key);

      // 이름에 지역이 노골적으로 포함된 경우
      for (const r of REGION_LIST_17) {
        if (stripAllSpaces(t).includes(stripAllSpaces(r))) return r;
      }

      return '';
    }

    /**********************************************************************
     * 5) XLSX 시트 -> 2D Array 확장(셀병합 반영)
     *********************************************************************/
    function sheetToArray(ws) {
      const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', blankrows: false, raw: false });
      // merges 반영
      const merges = ws['!merges'] || [];
      for (const m of merges) {
        const r1 = m.s.r, c1 = m.s.c, r2 = m.e.r, c2 = m.e.c;
        const topLeft = (raw[r1] && raw[r1][c1] !== undefined) ? raw[r1][c1] : '';
        for (let r = r1; r <= r2; r++) {
          raw[r] = raw[r] || [];
          for (let c = c1; c <= c2; c++) {
            if (raw[r][c] === undefined || raw[r][c] === '') raw[r][c] = topLeft;
          }
        }
      }
      // 공백 채우기
      const maxLen = raw.reduce((m, row) => Math.max(m, row.length), 0);
      for (const row of raw) {
        while (row.length < maxLen) row.push('');
      }
      return raw;
    }

    function findHeaderRow(data) {
      // 첫 60줄 정도에서 헤더 후보 탐색
      const limit = Math.min(60, data.length);
      let best = { idx: -1, score: -1 };
      for (let i = 0; i < limit; i++) {
        const row = data[i].map(cleanText);
        const joined = row.join(' ');
        let score = 0;

        const keys = ['성명','이름','임용','발령','현','근무','소속','직급','직종','직렬','학교명','부서','구분','비고','임용일자','발령일자'];
        for (const k of keys) if (joined.includes(k)) score += 2;

        // 너무 짧은 행은 감점
        const nonEmpty = row.filter(x => x).length;
        if (nonEmpty < 3) score -= 2;

        // 숫자만 잔뜩이면 감점
        if (row.every(x => !x || /^[0-9]+$/.test(x))) score -= 3;

        if (score > best.score) best = { idx: i, score };
      }
      // 최소 점수 미달이면 -1
      if (best.score < 4) return -1;
      return best.idx;
    }

    function buildColLabels(mainRow, subRow) {
      const labels = [];
      let carry = '';
      for (let c = 0; c < mainRow.length; c++) {
        let main = cleanText(mainRow[c]);
        const sub = cleanText(subRow ? subRow[c] : '');
        // merged header carry
        if (!main) main = carry;
        else carry = main;

        let label = main;
        if (sub && sub !== main) label = (main ? (main + ' ' + sub) : sub);

        labels.push(cleanText(label));
      }
      return labels;
    }

    function pickNameFromRow(row, nameCol) {
      // 1) 헤더 기반 nameCol 우선
      if (nameCol >= 0) {
        const v = cleanText(row[nameCol]);
        if (isKoreanName(v)) return v;
      }
      // 2) 전체 셀에서 이름 후보 탐색(첫번째 한글 이름)
      for (const cell of row) {
        const v = cleanText(cell);
        if (isKoreanName(v)) return v;
      }
      return '';
    }

    function pickOrgNearCols(row, cols, preferRight, schoolMap) {
      // cols 주변(-1, 0, +1)도 같이 스캔
      const cand = [];
      const set = new Set();
      for (const c0 of cols) {
        for (const dc of [-1,0,1]) {
          const c = c0 + dc;
          if (c < 0 || c >= row.length) continue;
          if (set.has(c)) continue;
          set.add(c);
          cand.push(c);
        }
      }
      // 후보가 없으면 전체에서 org 패턴 스캔
      const scanCols = cand.length ? cand : Array.from({length: row.length}, (_,i) => i);

      let best = { col: -1, score: -999, val: '' };
      for (const c of scanCols) {
        const v = cleanText(row[c]);
        if (!v) continue;
        const sc = scoreOrgCandidate(v, schoolMap);
        if (sc > best.score || (sc === best.score && best.col !== -1 && (preferRight ? c > best.col : c < best.col))) {
          best = { col: c, score: sc, val: v };
        }
      }
      if (best.score < 0) return '';

      // 만약 region 단독이면, 인접에 학교/기관명이 있으면 그쪽을 우선
      const asRegion = normalizeRegionText(best.val);
      if (asRegion) {
        const neigh = preferRight ? [best.col+1, best.col-1] : [best.col-1, best.col+1];
        for (const n of neigh) {
          if (n < 0 || n >= row.length) continue;
          const v2 = cleanText(row[n]);
          if (!v2) continue;
          const r2 = normalizeRegionText(v2);
          if (r2) continue; // 둘 다 지역이면 패스
          if (looksLikeOrg(v2) || (schoolMap && schoolMap.has(canonSchoolKey(v2)))) return v2;
        }
      }

      return best.val;
    }

    function findColsByLabel(labels, predicates) {
      const cols = [];
      for (let i = 0; i < labels.length; i++) {
        const L = labels[i] || '';
        if (predicates.every(fn => fn(L))) cols.push(i);
      }
      return cols;
    }

    function includesAny(label, arr) {
      return arr.some(k => label.includes(k));
    }

    function extractRecordsFromSheet(ws, sheetName, fileName, schoolMap) {
      const data = sheetToArray(ws).map(row => row.map(cleanText));

      const headerIdx = findHeaderRow(data);
      let mainRow = null, subRow = null, dataStart = 0;

      if (headerIdx >= 0) {
        mainRow = data[headerIdx];
        // 바로 아래 줄이 "직급/학교명/부서/근무처..." 같은 서브헤더일 확률이 높음
        const next = data[headerIdx + 1] || [];
        const nextJoined = next.join(' ');
        const hasSub = /(직급|직종|직렬|학교명|부서|근무처|근무지|호봉)/.test(nextJoined) && !/(성명|이름)/.test(nextJoined);
        subRow = hasSub ? next : null;
        dataStart = headerIdx + (hasSub ? 2 : 1);
      } else {
        // 헤더 못 찾으면 처음부터 스캔(보수적으로)
        mainRow = data[0] || [];
        subRow = null;
        dataStart = 1;
      }

      const labels = buildColLabels(mainRow, subRow);

      const nameCols = findColsByLabel(labels, [
        L => includesAny(L, ['성명','성 명','이름'])
      ]);
      const nameCol = nameCols.length ? nameCols[0] : -1;

      // 임용/발령쪽 (왼쪽) org 후보
      const toOrgCols = findColsByLabel(labels, [
        L => includesAny(L, ['임용','발령','임용사항','발령사항']),
        L => includesAny(L, ['근무','근무지','근무처','부서','학교명'])
      ]);
      // 현소속(오른쪽) org 후보
      const fromOrgCols = findColsByLabel(labels, [
        L => includesAny(L, ['현','현소속','현근무','현 직','현직','종전','전 소속','전근무']),
        L => includesAny(L, ['근무','근무지','근무처','부서','학교명'])
      ]);

      // 직급/직종/직렬
      const toPosCols = findColsByLabel(labels, [
        L => includesAny(L, ['임용','발령','임용사항','발령사항']),
        L => includesAny(L, ['직급','직종','직렬','직위'])
      ]);
      const fromPosCols = findColsByLabel(labels, [
        L => includesAny(L, ['현','현소속','현근무','현 직','현직','종전','전 소속','전근무']),
        L => includesAny(L, ['직급','직종','직렬','직위'])
      ]);

      // 구분/비고/발령사항 텍스트
      const noteCols = findColsByLabel(labels, [
        L => includesAny(L, ['구분','비고','발령','임용','전보','전입','전출'])
      ]);

      const dateCols = findColsByLabel(labels, [
        L => includesAny(L, ['일자','임용일자','발령일자'])
      ]);

      /** @type {any[]} */
      const out = [];

      for (let r = dataStart; r < data.length; r++) {
        const row = data[r];
        if (!row || !row.length) continue;

        // 빈 행 제외
        const nonEmpty = row.filter(v => cleanText(v)).length;
        if (nonEmpty < 2) continue;

        const name = pickNameFromRow(row, nameCol);
        if (!name) continue;

        // 집계 제외 조건: 성명 칸에 지역/교육장 등 들어간 경우는 isKoreanName에서 걸러짐

        const toOrgRaw = pickOrgNearCols(row, toOrgCols.length ? toOrgCols : [Math.floor(row.length/3)], false, schoolMap);
        const fromOrgRaw = pickOrgNearCols(row, fromOrgCols.length ? fromOrgCols : [Math.floor(row.length*2/3)], true, schoolMap);

        const toPos = toPosCols.length ? cleanText(row[toPosCols[0]]) : '';
        const fromPos = fromPosCols.length ? cleanText(row[fromPosCols[fromPosCols.length-1]]) : '';

        // notes는 가능한 많이 합치되, 너무 장황해지지 않게 중요한 col만
        const noteParts = [];
        for (const c of noteCols) {
          const v = cleanText(row[c]);
          if (v) noteParts.push(v);
        }
        // 날짜 (있으면)
        let date = '';
        for (const c of dateCols) {
          const v = cleanText(row[c]);
          if (v && /[0-9]{4}\.?/.test(v)) { date = v; break; }
        }

        const allTexts = [
          name, toOrgRaw, fromOrgRaw, toPos, fromPos, date,
          ...noteParts,
          ...row.filter(v => v && v.length <= 30) // 짧은 셀만 약간 추가(키워드 잡기)
        ];

        const flags = detectFlags(allTexts);

        // 조례/시행규칙 포함이면 "발령받는 학교/기관명"을 현근무지로 써라 → toOrg를 fromOrg로 대체
        let toOrg = normalizeOrgName(toOrgRaw);
        let fromOrg = normalizeOrgName(fromOrgRaw);

        if (flags.hasOrdinanceRule && fromOrg) toOrg = fromOrg;

        // 둘 다 비면 스킵
        if (!toOrg && !fromOrg) continue;

        // 직군
        const empType = detectEmployeeType([toPos, fromPos, ...noteParts, toOrg, fromOrg]);

        // 직렬/직종/직급 라벨(드롭박스 4용)
        let jobLabel = '';
        if (empType === '지방공무원') {
          jobLabel = detectLocalSeries([toPos, fromPos, ...noteParts]) || '기타(지방)';
        } else if (empType === '교육공무직') {
          jobLabel = detectEduWorkerJob([toPos, fromPos, ...noteParts]) || (toPos || fromPos || '기타(공무직)');
        } else if (empType === '교육공무원') {
          jobLabel = detectTeacherRole([toPos, fromPos, ...noteParts]) || (toPos || fromPos || '기타(교원)');
        } else {
          jobLabel = toPos || fromPos || '미상';
        }

        // 비고/구분 텍스트는 너무 길면 조금 줄이기
        const note = cleanText(noteParts.join(' / ')).slice(0, 160);

        out.push({
          name,
          empType,
          jobLabel: cleanText(jobLabel),
          toOrgRaw: toOrgRaw,
          fromOrgRaw: fromOrgRaw,
          toOrg,
          fromOrg,
          date,
          note,
          flags,
          sheetName,
          fileName,
        });
      }

      return out;
    }

    /**********************************************************************
     * 6) 학교 마스터(강원도 내 전체 학교 목록.xlsx) 파싱
     *********************************************************************/
    function inferRegionFromAddress(addr) {
      const a = cleanText(addr);
      if (!a) return '';
      // 시/군 기반 매칭(속초/양양 합산)
      const candidates = [
        ['강릉','강릉시'], ['고성','고성군'], ['동해','동해시'], ['삼척','삼척시'],
        ['속초양양','속초시'], ['속초양양','양양군'],
        ['양구','양구군'], ['영월','영월군'], ['원주','원주시'], ['인제','인제군'],
        ['정선','정선군'], ['철원','철원군'], ['춘천','춘천시'], ['태백','태백시'],
        ['평창','평창군'], ['홍천','홍천군'], ['화천','화천군'], ['횡성','횡성군'],
      ];
      const compact = stripAllSpaces(a.replace(/^강원특별자치도/,'').replace(/^강원도/,''));
      for (const [region, token] of candidates) {
        if (compact.includes(stripAllSpaces(token))) return region;
      }
      // 혹시 "양구"가 "양"으로 잘리는 문제 방지: 단일 '양'은 매칭 금지
      for (const r of REGION_LIST_17) {
        if (compact.includes(stripAllSpaces(r))) return r; // fallback (풀네임만)
      }
      return '';
    }

    function parseSchoolMasterWorkbook(wb) {
      // 어떤 시트든 첫 시트에서 "학교이름" 컬럼 기반으로 파싱
      const sn = wb.SheetNames[0];
      const ws = wb.Sheets[sn];
      const arr = sheetToArray(ws).map(row => row.map(cleanText));
      if (!arr.length) return { loaded:false };

      // 헤더 탐색: "학교이름" 포함된 행
      let header = -1;
      for (let i = 0; i < Math.min(20, arr.length); i++) {
        const j = arr[i].join(' ');
        if (j.includes('학교이름') || j.includes('학교명')) { header = i; break; }
      }
      if (header < 0) header = 0;

      const headRow = arr[header];
      const nameIdx = headRow.findIndex(x => x.includes('학교이름') || x.includes('학교명'));
      const addrIdx = headRow.findIndex(x => x.includes('주소'));
      if (nameIdx < 0) return { loaded:false };

      const schoolNameToRegion = new Map();
      const schoolCanonToFull = new Map();
      const schoolFullSet = new Set();

      for (let r = header + 1; r < arr.length; r++) {
        const row = arr[r];
        const name = cleanText(row[nameIdx]);
        if (!name) continue;
        const addr = addrIdx >= 0 ? cleanText(row[addrIdx]) : '';

        const fullName = normalizeOrgName(name);
        const canon = canonSchoolKey(fullName);
        const region = inferRegionFromAddress(addr);

        schoolNameToRegion.set(canon, region || '');
        schoolCanonToFull.set(canon, fullName);
        schoolFullSet.add(fullName);

        // 축약키도 같이 등록: "...초등학교" -> "...초", "...중학교" -> "...중", "...고등학교" -> "...고"
        if (fullName.endsWith('초등학교')) {
          schoolNameToRegion.set(canonSchoolKey(fullName.replace(/초등학교$/, '초')), region || '');
        } else if (fullName.endsWith('중학교')) {
          schoolNameToRegion.set(canonSchoolKey(fullName.replace(/중학교$/, '중')), region || '');
        } else if (fullName.endsWith('고등학교')) {
          schoolNameToRegion.set(canonSchoolKey(fullName.replace(/고등학교$/, '고')), region || '');
        }
      }

      return { loaded:true, schoolNameToRegion, schoolCanonToFull, schoolFullSet };
    }

    /**********************************************************************
     * 7) 레코드 후처리: 병설유치원 합산/지역 추론/중복 제거/기관-학교 분류
     *********************************************************************/
    function postProcessRecords(rawRecords) {
      // 1) 병설유치원 존재 기반: base 학교들 표시
      const baseWithAnnex = new Set();
      for (const rec of rawRecords) {
        const t1 = rec.toOrg, t2 = rec.fromOrg;
        for (const org of [t1, t2]) {
          if (!org) continue;
          if (isAnnexKindergarten(org)) {
            const base = annexBaseSchool(org);
            if (base) baseWithAnnex.add(base);
          }
        }
      }

      // 2) org 그룹 라벨 반영
      for (const rec of rawRecords) {
        rec.toOrg = normalizeOrgName(rec.toOrg);
        rec.fromOrg = normalizeOrgName(rec.fromOrg);

        // 병설유치원은 base로 합산
        if (isAnnexKindergarten(rec.toOrg)) {
          const base = annexBaseSchool(rec.toOrg);
          if (base) rec.toOrg = normalizeCombinedAnnexLabel(base);
        } else {
          // base 학교도 annex가 하나라도 있으면 라벨을 "… 및 병설유치원"로 통일
          const base = annexBaseSchool(rec.toOrg);
          // base가 아닌 경우는 baseWithAnnex에서 바로 확인
          if (baseWithAnnex.has(rec.toOrg)) rec.toOrg = normalizeCombinedAnnexLabel(rec.toOrg);
        }

        if (isAnnexKindergarten(rec.fromOrg)) {
          const base = annexBaseSchool(rec.fromOrg);
          if (base) rec.fromOrg = normalizeCombinedAnnexLabel(base);
        } else {
          if (baseWithAnnex.has(rec.fromOrg)) rec.fromOrg = normalizeCombinedAnnexLabel(rec.fromOrg);
        }
      }

      // 3) 지역 추론 + 조직 타입
      for (const rec of rawRecords) {
        const schoolMap = state.schoolNameToRegion;
        rec.toRegion = inferRegionFromOrg(rec.toOrg, schoolMap);
        rec.fromRegion = inferRegionFromOrg(rec.fromOrg, schoolMap);

        // 발령/임용 후가 비었는데 전이 있으면 후를 전으로 채우기(보수적으로)
        if (!rec.toOrg && rec.fromOrg) rec.toOrg = rec.fromOrg;
        if (!rec.toRegion && rec.toOrg) rec.toRegion = inferRegionFromOrg(rec.toOrg, schoolMap);
        if (!rec.fromRegion && rec.fromOrg) rec.fromRegion = inferRegionFromOrg(rec.fromOrg, schoolMap);

        rec.toKind = isLikelySchoolName(rec.toOrg) ? '학교' : (isLikelyInstitution(rec.toOrg) ? '기관' : (rec.toOrg ? '기관' : ''));
        rec.fromKind = isLikelySchoolName(rec.fromOrg) ? '학교' : (isLikelyInstitution(rec.fromOrg) ? '기관' : (rec.fromOrg ? '기관' : ''));
      }

      // 4) 중복 제거:
      //    - 교육장이 지정… placeholder는 같은 이름에서 "더 구체적인" 레코드가 있으면 제거
      const byName = new Map();
      for (const rec of rawRecords) {
        if (!byName.has(rec.name)) byName.set(rec.name, []);
        byName.get(rec.name).push(rec);
      }
      const filtered = [];
      for (const [name, list] of byName.entries()) {
        const hasNonPlaceholder = list.some(r => !r.flags.isPlaceholder);
        for (const r of list) {
          if (hasNonPlaceholder && r.flags.isPlaceholder) continue;
          filtered.push(r);
        }
      }

      //    - 최종 키 기반 de-dup (셀병합/중복시트 등 방지)
      const seen = new Set();
      const unique = [];
      for (const r of filtered) {
        const key = [
          r.name,
          r.empType,
          stripAllSpaces(r.fromOrg || ''),
          stripAllSpaces(r.toOrg || ''),
          stripAllSpaces(r.jobLabel || ''),
          // retire/new/dispatch 같은 큰 성격도 포함
          r.flags.isRetire ? 'R' : '',
          r.flags.isNew ? 'N' : '',
          r.flags.isDispatch ? 'D' : '',
          r.flags.isLeave ? 'L' : '',
          r.flags.isReturn ? 'B' : '',
        ].join('|');
        if (seen.has(key)) continue;
        seen.add(key);
        unique.push(r);
      }

      // 5) 이동 분류
      for (const r of unique) {
        // 지역 비교 기반 기본
        const fr = r.fromRegion || '';
        const tr = r.toRegion || '';
        if (r.flags.isRetire) r.moveType = '퇴직/면직';
        else if (r.flags.isNew && (!fr || fr === '')) r.moveType = '신규/임용';
        else if (fr && tr && fr !== tr) r.moveType = '지역이동';
        else if (fr && tr && fr === tr) r.moveType = '지역변동없음';
        else r.moveType = '미분류';
      }

      // 6) 오름차순 정렬(기본)
      unique.sort((a,b) => {
        const ak = (a.name||'').localeCompare(b.name||'', 'ko');
        if (ak !== 0) return ak;
        const ok = (a.toOrg||'').localeCompare(b.toOrg||'', 'ko');
        if (ok !== 0) return ok;
        return (a.fromOrg||'').localeCompare(b.fromOrg||'', 'ko');
      });

      return unique;
    }

    /**********************************************************************
     * 8) 집계(대시보드/지역표/조직 목록)
     *********************************************************************/
    function buildAggregates(records) {
      const total = records.length;

      const countsByMove = { in:0, out:0, stay:0, retire:0, newly:0, unknown:0 };

      // 지역별
      /** @type {Map<string, {in:number,out:number,stay:number,retire:number,newly:number}>} */
      const regionMap = new Map();
      function ensureRegion(r) {
        if (!regionMap.has(r)) regionMap.set(r, {in:0,out:0,stay:0,retire:0,newly:0});
        return regionMap.get(r);
      }

      // “전입/전출”을 지역 기준으로 계산
      for (const r of records) {
        const fr = r.fromRegion || '';
        const tr = r.toRegion || '';

        // retire
        if (r.flags.isRetire) {
          countsByMove.retire++;
          if (fr) ensureRegion(fr).retire++;
          continue;
        }

        // new
        if (r.moveType === '신규/임용') {
          countsByMove.newly++;
          if (tr) ensureRegion(tr).newly++;
          // 신규는 전입으로도 볼 수 있지만, 표에는 별도 칸이 있으니 in은 추가로 올리지 않음(원하면 아래 줄 켜기)
          // if (tr) ensureRegion(tr).in++;
          continue;
        }

        if (fr && tr && fr !== tr) {
          countsByMove.in++;
          countsByMove.out++;
          ensureRegion(fr).out++;
          ensureRegion(tr).in++;
        } else if (fr && tr && fr === tr) {
          countsByMove.stay++;
          ensureRegion(fr).stay++;
        } else {
          countsByMove.unknown++;
        }
      }

      // 조직 목록(학교/기관)
      const orgSetSchool = new Set();
      const orgSetInst = new Set();

      for (const r of records) {
        if (r.toOrg) {
          if (isLikelySchoolName(r.toOrg)) orgSetSchool.add(r.toOrg);
          else orgSetInst.add(r.toOrg);
        }
        if (r.fromOrg) {
          if (isLikelySchoolName(r.fromOrg)) orgSetSchool.add(r.fromOrg);
          else orgSetInst.add(r.fromOrg);
        }
      }

      const schools = Array.from(orgSetSchool).sort((a,b) => a.localeCompare(b,'ko'));
      const insts = Array.from(orgSetInst).sort((a,b) => a.localeCompare(b,'ko'));

      return {
        total,
        countsByMove,
        regionMap,
        orgIndex: { schools, insts }
      };
    }

    /**********************************************************************
     * 9) UI 렌더: 대시보드 / 지역표 / 드롭박스 / 패널
     *********************************************************************/
    function renderDashboard() {
      ui.dashboardEmpty.style.display = 'none';
      ui.dashboardWrap.style.display = 'block';

      const agg = state.aggregates;
      ui.kpiGrid.innerHTML = '';

      const kpis = [
        { label: '전체 인사발령자(중복 제거 후)', value: agg.total, sub: '도단위+관내 파일 합산' },
        { label: '전입(지역 기준)', value: agg.countsByMove.in, sub: 'from≠to (to 지역)' },
        { label: '전출(지역 기준)', value: agg.countsByMove.out, sub: 'from≠to (from 지역)' },
        { label: '지역변동 없음', value: agg.countsByMove.stay, sub: 'from=to' },
        { label: '퇴직/면직', value: agg.countsByMove.retire, sub: '키워드 기반' },
        { label: '신규/임용', value: agg.countsByMove.newly, sub: '키워드 기반' },
      ];

      for (const k of kpis) {
        const div = document.createElement('div');
        div.className = 'kpi';
        div.innerHTML = `
          <p class="label">${escapeHtml(k.label)}</p>
          <p class="value">${escapeHtml(String(k.value))}</p>
          <p class="sub">${escapeHtml(k.sub)}</p>
        `;
        ui.kpiGrid.appendChild(div);
      }

      // 지역표(오름차순)
      const rows = Array.from(agg.regionMap.entries())
        .filter(([r,_]) => r) // 빈 지역 제외
        .sort((a,b) => a[0].localeCompare(b[0],'ko'));

      ui.regionSummaryTable.innerHTML = '';
      for (const [region, c] of rows) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.innerHTML = `
          <td>${escapeHtml(region)}</td>
          <td class="numeric">${c.in}</td>
          <td class="numeric">${c.out}</td>
          <td class="numeric">${c.stay}</td>
          <td class="numeric">${c.retire}</td>
          <td class="numeric">${c.newly}</td>
        `;
        tr.addEventListener('click', () => {
          // 4번으로 이동 + 지역 자동 선택
          ui.regionModeSel.value = ui.regionModeSel.value || '분리';
          populateRegionDropdown();
          ui.regionSel.value = region;
          updateRegionPanels();
          document.getElementById('sec-region').scrollIntoView({behavior:'smooth'});
        });
        ui.regionSummaryTable.appendChild(tr);
      }
    }

    function enableFilters() {
      // 3번
      ui.orgKindSel.disabled = false;
      ui.orgTypeSel.disabled = false;
      ui.orgJobSel.disabled = false;

      // 기본값
      ui.orgKindSel.value = '';
      ui.orgNameSel.innerHTML = '<option value="">(구분을 먼저 선택)</option>';
      ui.orgNameSel.disabled = true;

      ui.orgTypeSel.value = '전체';
      ui.orgJobSel.innerHTML = '<option value="전체">전체</option>';
      ui.orgJobSel.value = '전체';

      // 4번
      ui.regionModeSel.disabled = false;
      ui.regionSel.disabled = false;
      ui.regionTypeSel.disabled = false;

      ui.regionModeSel.value = '';
      ui.regionSel.innerHTML = '<option value="">(강원도교육청 처리 먼저 선택)</option>';
      ui.regionTypeSel.value = '전체';

      ui.downloadOrgBtn.disabled = false;
      ui.downloadRegionBtn.disabled = false;
    }

    function populateOrgDropdowns() {
      const idx = state.orgIndex;
      const kind = ui.orgKindSel.value;

      ui.orgNameSel.disabled = !kind;
      ui.orgNameSel.innerHTML = '';

      if (!kind) {
        ui.orgNameSel.innerHTML = '<option value="">(구분을 먼저 선택)</option>';
        return;
      }

      const list = (kind === '학교') ? idx.schools : idx.insts;

      ui.orgNameSel.appendChild(new Option('전체', '전체'));
      for (const org of list) {
        ui.orgNameSel.appendChild(new Option(org, org));
      }
      ui.orgNameSel.value = '전체';
    }

    function populateOrgJobDropdown() {
      // 4번째 드롭박스: 직렬/직급/직종
      const kind = ui.orgKindSel.value;
      const org = ui.orgNameSel.value;
      const type = ui.orgTypeSel.value;

      // 필터 후보집합 만들기
      let pool = state.records;

      if (kind === '학교') pool = pool.filter(r => isLikelySchoolName(r.toOrg) || isLikelySchoolName(r.fromOrg));
      if (kind === '기관') pool = pool.filter(r => !isLikelySchoolName(r.toOrg) || !isLikelySchoolName(r.fromOrg) || isLikelyInstitution(r.toOrg) || isLikelyInstitution(r.fromOrg)); // 대충 기관쪽 포함

      if (org && org !== '전체') pool = pool.filter(r => r.toOrg === org || r.fromOrg === org);
      if (type && type !== '전체') pool = pool.filter(r => r.empType === type);

      ui.orgJobSel.disabled = false;
      ui.orgJobSel.innerHTML = '';
      ui.orgJobSel.appendChild(new Option('전체', '전체'));

      // 지방공무원 선택이면 직렬 고정 리스트
      if (type === '지방공무원') {
        for (const s of LOCAL_SERIES) ui.orgJobSel.appendChild(new Option(s, s));
        ui.orgJobSel.appendChild(new Option('기타(지방)', '기타(지방)'));
        ui.orgJobSel.value = '전체';
        return;
      }

      // 그 외는 pool에서 고유 jobLabel 수집
      const set = new Set();
      for (const r of pool) {
        const jl = cleanText(r.jobLabel);
        if (jl) set.add(jl);
      }
      const items = Array.from(set).sort((a,b) => a.localeCompare(b,'ko'));
      for (const it of items) ui.orgJobSel.appendChild(new Option(it, it));
      ui.orgJobSel.value = '전체';
    }

    function populateRegionDropdown() {
      const mode = ui.regionModeSel.value;
      ui.regionSel.innerHTML = '';
      if (!mode) {
        ui.regionSel.appendChild(new Option('(강원도교육청 처리 먼저 선택)', ''));
        ui.regionSel.disabled = true;
        return;
      }
      ui.regionSel.disabled = false;

      const list = (mode === '분리') ? REGION_LIST_18 : REGION_LIST_17;

      ui.regionSel.appendChild(new Option('전체', '전체'));
      // 사용자가 명시한 순서를 유지(드롭다운 자체는 순서 고정)
      for (const r of list) ui.regionSel.appendChild(new Option(r, r));
      ui.regionSel.value = '전체';
    }

    function adjustRegion(region, mode) {
      if (!region) return '';
      if (mode === '합산' && region === '강원도교육청') return '춘천';
      return region;
    }

    function renderTableRows(tbody, rows) {
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.empType)}</td>
          <td>${escapeHtml(r.jobLabel || '')}</td>
          <td>${escapeHtml(r.fromOrg || '')}</td>
          <td>${escapeHtml(r.toOrg || '')}</td>
          <td>${escapeHtml(r.fromRegion || '')}</td>
          <td>${escapeHtml(r.toRegion || '')}</td>
          <td>${escapeHtml(r.note || '')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function sortRecordsAsc(rows) {
      return rows.slice().sort((a,b) => {
        // 오름차순: (발령후/현소속/성명) 기준
        const aKey = `${a.toOrg||''} ${a.fromOrg||''} ${a.name||''}`.trim();
        const bKey = `${b.toOrg||''} ${b.fromOrg||''} ${b.name||''}`.trim();
        return aKey.localeCompare(bKey, 'ko');
      });
    }

    function updateOrgPanels() {
      const kind = ui.orgKindSel.value;
      const org = ui.orgNameSel.value;
      const type = ui.orgTypeSel.value;
      const job = ui.orgJobSel.value;

      let pool = state.records;

      if (kind === '학교') {
        pool = pool.filter(r => isLikelySchoolName(r.toOrg) || isLikelySchoolName(r.fromOrg));
      } else if (kind === '기관') {
        pool = pool.filter(r => isLikelyInstitution(r.toOrg) || isLikelyInstitution(r.fromOrg) || r.toOrg === '강원도교육청' || r.fromOrg === '강원도교육청');
      } else {
        ui.orgPanels.style.display = 'none';
        return;
      }

      if (org && org !== '전체') pool = pool.filter(r => r.toOrg === org || r.fromOrg === org);
      if (type && type !== '전체') pool = pool.filter(r => r.empType === type);
      if (job && job !== '전체') pool = pool.filter(r => (r.jobLabel || '') === job);

      // 패널 분류
      const p1 = [], p2 = [], p3 = [];
      for (const r of pool) {
        const isOut = (org && org !== '전체') ? (r.fromOrg === org && r.toOrg !== org) : false;
        const isIn  = (org && org !== '전체') ? (r.toOrg === org && r.fromOrg !== org) : false;
        const isStay = (org && org !== '전체') ? (r.fromOrg === org && r.toOrg === org) : false;

        if (r.flags.isRetire) {
          // 퇴직자는 보통 현소속 기준
          if (!org || org === '전체' || r.fromOrg === org) p1.push(r);
          else p3.push(r);
        } else if (r.flags.isDispatch) {
          // 파견은 패널2로
          p2.push(r);
        } else if (r.moveType === '신규/임용') {
          // 신규는 패널2로
          p2.push(r);
        } else if (org && org !== '전체') {
          if (isOut) p1.push(r);
          else if (isIn) p2.push(r);
          else if (isStay) p3.push(r);
          else p3.push(r);
        } else {
          // 전체 조회는 “전출/전입” 개념이 약하니, 퇴직 제외하고는 패널2 중심, 나머지 p3
          if (r.flags.isLeave || r.flags.isReturn || r.flags.isExtend || r.moveType === '지역변동없음') p3.push(r);
          else p2.push(r);
        }
      }

      const p1s = sortRecordsAsc(p1);
      const p2s = sortRecordsAsc(p2);
      const p3s = sortRecordsAsc(p3);

      ui.orgPanel1Meta.textContent = `건수: ${p1s.length} (오름차순 정렬)`;
      ui.orgPanel2Meta.textContent = `건수: ${p2s.length} (오름차순 정렬)`;
      ui.orgPanel3Meta.textContent = `건수: ${p3s.length} (오름차순 정렬)`;

      renderTableRows(ui.orgPanel1Table, p1s);
      renderTableRows(ui.orgPanel2Table, p2s);
      renderTableRows(ui.orgPanel3Table, p3s);

      ui.orgPanels.style.display = 'block';

      // 다운로드용 캐시
      state._lastOrgView = { kind, org, type, job, rows: sortRecordsAsc(pool) };
    }

    function updateRegionPanels() {
      const mode = ui.regionModeSel.value;
      const region = ui.regionSel.value;
      const type = ui.regionTypeSel.value;

      if (!mode || !region) {
        ui.regionPanels.style.display = 'none';
        return;
      }

      let pool = state.records;
      if (type && type !== '전체') pool = pool.filter(r => r.empType === type);

      // region 조정
      const adj = (r) => ({
        ...r,
        adjFrom: adjustRegion(r.fromRegion || '', mode),
        adjTo: adjustRegion(r.toRegion || '', mode),
      });

      const enriched = pool.map(adj);

      let focus = enriched;
      if (region !== '전체') {
        focus = enriched.filter(r => r.adjFrom === region || r.adjTo === region || (r.adjFrom === region && r.adjTo === region));
      }

      const p1 = [], p2 = [], p3 = [], p4 = [];

      for (const r of focus) {
        const fr = r.adjFrom || '';
        const tr = r.adjTo || '';

        const inRegion = (region === '전체') ? true : (tr === region);
        const outRegion = (region === '전체') ? true : (fr === region);

        if (r.flags.isRetire) {
          if (outRegion) p1.push(r);
          else p4.push(r);
          continue;
        }

        // 신규: 전입 패널로(요구사항에 따라)
        if (r.moveType === '신규/임용') {
          if (inRegion) p2.push(r);
          else if (region === '전체') p2.push(r);
          else p4.push(r);
          continue;
        }

        // 전출: from=region, to!=region
        if (region !== '전체' && fr === region && tr !== region) {
          p1.push(r);
          continue;
        }
        // 전입: to=region, from!=region
        if (region !== '전체' && tr === region && fr !== region) {
          p2.push(r);
          continue;
        }

        // 지역변동 없음 + 기타(휴복직/파견연장/부서간 이동 등)
        const stay = (fr && tr && fr === tr);
        if (stay || r.flags.isLeave || r.flags.isReturn || r.flags.isExtend || r.flags.isDispatch) {
          // region 전체면 여기에 묶기
          if (region === '전체') p3.push(r);
          else if (fr === region && tr === region) p3.push(r);
          else p4.push(r);
          continue;
        }

        // region 전체일 때 나머지
        if (region === '전체') {
          // fr != tr 케이스를 전입/전출로 굳이 나누기 어렵지만, 그래도 표시
          if (fr && tr && fr !== tr) p2.push(r);
          else p4.push(r);
        } else {
          p4.push(r);
        }
      }

      const p1s = sortRecordsAsc(p1.map(r => ({...r, fromRegion: r.adjFrom, toRegion: r.adjTo})));
      const p2s = sortRecordsAsc(p2.map(r => ({...r, fromRegion: r.adjFrom, toRegion: r.adjTo})));
      const p3s = sortRecordsAsc(p3.map(r => ({...r, fromRegion: r.adjFrom, toRegion: r.adjTo})));
      const p4s = sortRecordsAsc(p4.map(r => ({...r, fromRegion: r.adjFrom, toRegion: r.adjTo})));

      ui.regionPanel1Meta.textContent = `건수: ${p1s.length} (오름차순 정렬)`;
      ui.regionPanel2Meta.textContent = `건수: ${p2s.length} (오름차순 정렬)`;
      ui.regionPanel3Meta.textContent = `건수: ${p3s.length} (오름차순 정렬)`;
      ui.regionPanel4Meta.textContent = `건수: ${p4s.length} (오름차순 정렬)`;

      renderTableRows(ui.regionPanel1Table, p1s);
      renderTableRows(ui.regionPanel2Table, p2s);
      renderTableRows(ui.regionPanel3Table, p3s);
      renderTableRows(ui.regionPanel4Table, p4s);

      ui.regionPanels.style.display = 'block';

      // 다운로드용 캐시
      state._lastRegionView = { mode, region, type, rows: sortRecordsAsc(focus.map(r => ({...r, fromRegion:r.adjFrom, toRegion:r.adjTo}))) };
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    /**********************************************************************
     * 10) 엑셀 다운로드(3번/4번)
     *********************************************************************/
    function downloadAsXlsx(rows, filenameBase) {
      if (!rows || !rows.length) {
        alert('다운로드할 데이터가 없습니다.');
        return;
      }
      const header = ['성명','직군','직렬/직급/직종','현소속(발령 전)','발령(임용) 후','전지역','후지역','비고'];
      const aoa = [header];

      for (const r of rows) {
        aoa.push([
          r.name || '',
          r.empType || '',
          r.jobLabel || '',
          r.fromOrg || '',
          r.toOrg || '',
          r.fromRegion || '',
          r.toRegion || '',
          r.note || '',
        ]);
      }

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      // 간단 폭
      ws['!cols'] = [
        {wch:10},{wch:12},{wch:20},{wch:28},{wch:28},{wch:10},{wch:10},{wch:40},
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '결과');

      const safe = filenameBase.replace(/[\\/:*?"<>|]/g,'_');
      XLSX.writeFile(wb, safe + '.xlsx');
    }

    ui.downloadOrgBtn.addEventListener('click', () => {
      const v = state._lastOrgView;
      if (!v) return alert('먼저 조회 조건을 선택하세요.');
      const name = `학교기관_조회결과_${v.kind || '미선택'}_${(v.org || '전체')}_${(v.type || '전체')}`;
      downloadAsXlsx(v.rows, name);
    });

    ui.downloadRegionBtn.addEventListener('click', () => {
      const v = state._lastRegionView;
      if (!v) return alert('먼저 조회 조건을 선택하세요.');
      const name = `지역_조회결과_${(v.mode || '미선택')}_${(v.region || '전체')}_${(v.type || '전체')}`;
      downloadAsXlsx(v.rows, name);
    });

    /**********************************************************************
     * 11) 이벤트 연결(드롭다운 자동 연동)
     *********************************************************************/
    ui.orgKindSel.addEventListener('change', () => {
      populateOrgDropdowns();
      // 구분 선택 후에야 2번 활성화
      ui.orgNameSel.disabled = !ui.orgKindSel.value;
      populateOrgJobDropdown();
      updateOrgPanels();
    });

    ui.orgNameSel.addEventListener('change', () => {
      populateOrgJobDropdown();
      updateOrgPanels();
    });

    ui.orgTypeSel.addEventListener('change', () => {
      populateOrgJobDropdown();
      updateOrgPanels();
    });

    ui.orgJobSel.addEventListener('change', updateOrgPanels);

    ui.regionModeSel.addEventListener('change', () => {
      populateRegionDropdown();
      updateRegionPanels();
    });
    ui.regionSel.addEventListener('change', updateRegionPanels);
    ui.regionTypeSel.addEventListener('change', updateRegionPanels);

    /**********************************************************************
     * 12) 분석 실행: ZIP/엑셀 읽기 → 마스터 파싱 → 레코드 추출/후처리/집계/렌더
     *********************************************************************/
    ui.analyzeBtn.addEventListener('click', async () => {
      if (typeof XLSX === 'undefined' || typeof JSZip === 'undefined') {
        alert('라이브러리가 로드되지 않았습니다.');
        return;
      }
      if (!fileStore.length) {
        alert('업로드된 파일이 없습니다.');
        return;
      }

      ui.analyzeBtn.disabled = true;
      setProgress(0, '파일 분석 준비중…');

      try {
        // 1) 파일을 모두 ArrayBuffer로 읽되, ZIP은 내부 엑셀로 펼치기
        const expanded = [];
        let step = 0;
        const totalFiles = fileStore.length;

        // 먼저: 학교 마스터 후보 탐색(파일명 기준)
        // - "강원도 내 전체 학교 목록.xlsx" 같이 업로드돼 있으면 최우선 파싱
        let masterWb = null;

        for (const item of fileStore) {
          step++;
          const pct = (step / totalFiles) * 25; // 0~25%는 파일 읽기
          setProgress(pct, `파일 읽는 중… (${step}/${totalFiles})`);

          const f = item.file;
          const ext = guessExt(f.name);

          const buf = await f.arrayBuffer();

          if (ext === 'zip') {
            const zip = await JSZip.loadAsync(buf);
            const entries = Object.keys(zip.files)
              .filter(p => !zip.files[p].dir)
              .filter(p => /\.(xlsx|xls)$/i.test(p))
              .sort((a,b) => a.localeCompare(b,'ko'));

            for (const p of entries) {
              const fileData = await zip.files[p].async('arraybuffer');
              expanded.push({
                name: `${f.name}::${p}`,
                ext: (p.toLowerCase().endsWith('.xls') ? 'xls' : 'xlsx'),
                buf: fileData,
              });
            }
          } else if (ext === 'xlsx' || ext === 'xls') {
            expanded.push({ name: f.name, ext, buf });
          }
          // UI breathing
          await new Promise(r => setTimeout(r, 0));
        }

        // 2) 학교 마스터 찾기/파싱 (확장 목록 중 파일명에 "학교 목록" 포함)
        //    없으면 경고만 띄우고 진행(단, 고등학교 지역 매칭이 일부 약해질 수 있음)
        const masterCand = expanded.find(x => /학교\s*목록/.test(x.name) || /전체\s*학교/.test(x.name));
        if (masterCand) {
          setProgress(26, '학교 목록(마스터) 파싱 중…');
          masterWb = XLSX.read(masterCand.buf, { type: 'array' });
          const parsed = parseSchoolMasterWorkbook(masterWb);

          if (parsed.loaded) {
            state.schoolMasterLoaded = true;
            state.schoolNameToRegion = parsed.schoolNameToRegion;
            state.schoolCanonToFull = parsed.schoolCanonToFull;
            state.schoolFullSet = parsed.schoolFullSet;

            ui.schoolMasterStatus.style.display = 'block';
            ui.schoolMasterStatus.className = 'ok';
            ui.schoolMasterStatus.textContent =
              `학교 목록 파일 인식됨: 학교 ${state.schoolFullSet.size}개 지역 매핑 로드 완료`;
          } else {
            ui.schoolMasterStatus.style.display = 'block';
            ui.schoolMasterStatus.className = 'warn';
            ui.schoolMasterStatus.textContent =
              '학교 목록 파일을 업로드했지만 파싱에 실패했습니다. (헤더/형식 확인 필요) 그래도 분석은 진행합니다.';
          }
        } else {
          ui.schoolMasterStatus.style.display = 'block';
          ui.schoolMasterStatus.className = 'warn';
          ui.schoolMasterStatus.textContent =
            '학교 목록(강원도 내 전체 학교 목록.xlsx) 파일이 감지되지 않았습니다. 고등학교/직속기관 등 “지역 추론” 정확도가 일부 떨어질 수 있습니다.';
        }

        // 3) 본 분석: 모든 엑셀에서 레코드 추출
        setProgress(30, `시트 분석 시작… (대상 엑셀 ${expanded.length}개)`);

        const rawRecords = [];
        let done = 0;
        const totalExpanded = expanded.length;

        for (const item of expanded) {
          done++;
          const pct = 30 + (done / totalExpanded) * 60; // 30~90% 분석
          setProgress(pct, `엑셀 분석 중… (${done}/${totalExpanded})`);

          // 학교마스터로 쓰인 파일은 레코드 추출에서 제외
          if (masterCand && item.name === masterCand.name) continue;

          let wb;
          try {
            wb = XLSX.read(item.buf, { type: 'array' });
          } catch (e) {
            console.warn('엑셀 읽기 실패:', item.name, e);
            continue;
          }

          for (const sn of wb.SheetNames) {
            const ws = wb.Sheets[sn];
            if (!ws || !ws['!ref']) continue;
            const recs = extractRecordsFromSheet(ws, sn, item.name, state.schoolNameToRegion);
            rawRecords.push(...recs);
          }

          await new Promise(r => setTimeout(r, 0));
        }

        // 4) 후처리 + 최종 집계
        setProgress(92, '후처리(중복 제거/병설유치원 합산/지역 추론) 중…');
        const finalRecords = postProcessRecords(rawRecords);

        state.records = finalRecords;
        state.aggregates = buildAggregates(finalRecords);
        state.orgIndex = state.aggregates.orgIndex;

        // 5) UI 업데이트
        setProgress(98, '화면 갱신 중…');
        renderDashboard();
        enableFilters();
        populateRegionDropdown(); // mode 선택 전이라 (선택)만 보임
        ui.orgPanels.style.display = 'none';
        ui.regionPanels.style.display = 'none';

        // 3번/4번 초기 드롭다운 활성만
        ui.orgKindSel.value = '';
        ui.orgNameSel.disabled = true;
        ui.orgNameSel.innerHTML = '<option value="">(구분을 먼저 선택)</option>';
        ui.orgTypeSel.value = '전체';
        ui.orgJobSel.innerHTML = '<option value="전체">전체</option>';
        ui.orgJobSel.value = '전체';

        ui.regionModeSel.value = '';
        ui.regionSel.innerHTML = '<option value="">(강원도교육청 처리 먼저 선택)</option>';
        ui.regionSel.disabled = true;
        ui.regionTypeSel.value = '전체';

        setProgress(100, `완료! 최종 집계 ${finalRecords.length}건`);
      } catch (e) {
        console.error(e);
        alert('분석 중 오류가 발생했습니다. 콘솔 로그를 확인해주세요.');
        setProgress(100, '분석 실패');
      } finally {
        ui.analyzeBtn.disabled = false;
        enableAnalyzeIfReady();
      }
    });

    /**********************************************************************
     * 시작: 라이브러리 로드
     *********************************************************************/
    loadLibs();
  </script>
</body>
</html>
