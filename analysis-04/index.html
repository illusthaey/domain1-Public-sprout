<!doctype html>

<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>강원도교육청 인사발령 집계/분류</title>  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9ecff;
      --muted:#b7c0ff;
      --line:rgba(255,255,255,.12);
      --line2:rgba(255,255,255,.08);
      --good:#28c76f;
      --warn:#ff9f43;
      --bad:#ea5455;
      --accent:#7367f0;
      --accent2:#00cfe8;
      --chip:rgba(115,103,240,.16);
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial, sans-serif;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(900px 600px at 15% 0%, rgba(0,207,232,.15), transparent 60%),
                  radial-gradient(900px 600px at 85% 0%, rgba(115,103,240,.18), transparent 55%),
                  linear-gradient(180deg, #070a14 0%, var(--bg) 100%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1240px;margin:0 auto;padding:18px 16px 72px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--line);border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:30;
      backdrop-filter: blur(8px);
    }
    header .title{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:-.2px}
    header .sub{color:rgba(233,236,255,.72);font-size:12px}
    header nav{display:flex;gap:10px;flex-wrap:wrap}
    header nav a{
      text-decoration:none;border:1px solid var(--line2);padding:8px 10px;border-radius:10px;
      background:rgba(255,255,255,.03);
    }
    header nav a:hover{border-color:rgba(255,255,255,.2)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    section{
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    section .hd{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;border-bottom:1px solid var(--line2);
      background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,0));
    }
    section .hd h2{margin:0;font-size:15px}
    section .bd{padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .row > * {flex:1 1 auto}
    .card-row{display:grid;grid-template-columns:repeat(4, minmax(180px,1fr));gap:10px}
    @media (max-width: 980px){ .card-row{grid-template-columns:repeat(2, minmax(180px,1fr))}}
    @media (max-width: 520px){ .card-row{grid-template-columns:1fr}}
    .stat{
      border:1px solid var(--line2);
      border-radius:12px;padding:12px 12px;background:rgba(0,0,0,.12);
    }
    .stat .k{color:rgba(233,236,255,.78);font-size:12px;margin-bottom:6px}
    .stat .v{font-size:20px;font-weight:800;letter-spacing:-.3px}
    .stat .s{color:rgba(233,236,255,.7);font-size:12px;margin-top:6px}
    label{display:block;font-size:12px;color:rgba(233,236,255,.8);margin:0 0 6px}
    input[type="file"], input[type="text"], select, textarea, button{
      font-family:var(--sans);
    }
    input[type="text"], select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.2);
      color:var(--text);
      padding:10px 10px;
      outline:none;
    }
    select:disabled, input:disabled{opacity:.55; cursor:not-allowed}
    textarea{
      min-height:120px; resize:vertical; font-family:var(--mono); font-size:12px; line-height:1.4;
    }
    button{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(115,103,240,.98), rgba(115,103,240,.78));
      color:white;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      box-shadow:0 10px 24px rgba(115,103,240,.25);
    }
    button.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      color:var(--text);
    }
    button.danger{
      background:linear-gradient(180deg, rgba(234,84,85,.95), rgba(234,84,85,.75));
      border-color:rgba(234,84,85,.5);
      box-shadow:0 10px 24px rgba(234,84,85,.18);
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .note{font-size:12px;color:rgba(233,236,255,.72);line-height:1.5}
    .pill{
      display:inline-flex;align-items:center;gap:7px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid var(--line2);
      font-size:12px;color:rgba(233,236,255,.78);
      white-space:nowrap;
    }
    .pill .dot{width:9px;height:9px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .progress{
      width:100%;height:10px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.09);
      overflow:hidden;
    }
    .progress > i{
      display:block;height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--accent2), var(--accent));
      border-radius:999px;
      transition:width .15s ease;
    }
    .table-wrap{
      border:1px solid var(--line2);
      border-radius:12px;
      overflow:auto;
      background:rgba(0,0,0,.18);
      max-height:520px;
    }
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px}
    thead th{
      position:sticky;top:0;z-index:2;
      background:linear-gradient(180deg, rgba(17,26,51,.98), rgba(17,26,51,.86));
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      font-size:12px;
      vertical-align:top;
    }
    tbody tr:hover td{background:rgba(255,255,255,.03)}
    .muted{color:rgba(233,236,255,.65)}
    .mono{font-family:var(--mono)}
    .chip{
      display:inline-block;padding:4px 8px;border-radius:999px;
      background:var(--chip);border:1px solid rgba(115,103,240,.25);
      font-size:12px; white-space:nowrap;
    }
    .chip2{
      display:inline-block;padding:4px 8px;border-radius:999px;
      background:rgba(0,207,232,.12);border:1px solid rgba(0,207,232,.22);
      font-size:12px; white-space:nowrap;
    }
    .split{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr}}
    .tri{
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;
    }
    @media (max-width: 1150px){ .tri{grid-template-columns:1fr}}
    .danger-box{
      border:1px dashed rgba(234,84,85,.45);
      background:rgba(234,84,85,.08);
      border-radius:12px;padding:10px 12px;
      color:rgba(233,236,255,.82);
      font-size:12px;
    }
    .ok-box{
      border:1px dashed rgba(40,199,111,.45);
      background:rgba(40,199,111,.08);
      border-radius:12px;padding:10px 12px;
      color:rgba(233,236,255,.82);
      font-size:12px;
    }
    .float-top{
      position:fixed;right:14px;bottom:14px;z-index:40;
      width:46px;height:46px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(17,26,51,.75);
      backdrop-filter: blur(10px);
      cursor:pointer;
      box-shadow:var(--shadow);
      color:var(--text);
      user-select:none;
    }
    .float-top:hover{border-color:rgba(255,255,255,.28)}
    .kbd{
      font-family:var(--mono);font-size:11px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      border-bottom-color:rgba(255,255,255,.26);
      padding:2px 6px;border-radius:8px;
      color:rgba(233,236,255,.85);
    }
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .inline{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .inline .spacer{flex:1 1 auto}
    .small{font-size:12px}
    .hidden{display:none!important}
  </style>
</head><body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>강원도교육청 인사발령 집계/분류</h1>
      <span class="sub">브라우저에서만 동작 · 누적 업로드 · 중복 제거 · 집계/상세/다운로드</span>
    </div>
    <nav>
      <a href="#sec-upload">업로드</a>
      <a href="#sec-summary">요약</a>
      <a href="#sec-entity">학교/기관</a>
      <a href="#sec-region">시군구</a>
    </nav>
  </header>  <div class="grid">
    <!-- 섹션1: 업로드 -->
    <section id="sec-upload">
      <div class="hd">
        <h2>1) 파일 업로드</h2>
        <div class="inline">
          <span class="pill"><span class="dot warn" id="xlsxDot"></span><span id="xlsxStatus">SheetJS 로딩 대기</span></span>
          <span class="pill"><span class="dot good"></span><span class="mono" id="appClock">--:--:--</span></span>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <div style="flex:2 1 520px">
            <label>엑셀 파일(.xlsx/.xls) 누적 업로드</label>
            <input id="fileInput" type="file" multiple accept=".xlsx,.xls" />
            <div class="note" style="margin-top:8px">
              중복 파일은 자동 스킵됩니다. (키: <span class="kbd">파일명+크기+수정시간</span>)<br/>
              파싱 중에는 진행률이 표시됩니다.
            </div>
          </div>
          <div style="flex:1 1 260px">
            <div class="btns">
              <button id="btnParse" class="secondary" disabled>선택 파일 파싱</button>
              <button id="btnClear" class="danger" disabled>전체 초기화</button>
            </div>
            <div style="margin-top:10px">
              <div class="progress" title="전체 진행률">
                <i id="globalProgress"></i>
              </div>
              <div class="inline small muted" style="margin-top:6px">
                <span id="globalProgressText">대기</span>
                <span class="spacer"></span>
                <span id="globalCounts" class="mono">files:0 rec:0</span>
              </div>
            </div>
          </div>
        </div><div class="hr"></div>

    <div class="split">
      <div>
        <div class="inline">
          <div class="pill"><span class="dot good"></span><span>파일 목록</span></div>
          <span class="spacer"></span>
          <span class="note">드래그&드롭 지원</span>
        </div>
        <div class="table-wrap" style="max-height:300px;margin-top:10px">
          <table id="fileTable">
            <thead>
              <tr>
                <th style="min-width:240px">파일</th>
                <th style="min-width:90px">크기</th>
                <th style="min-width:120px">상태</th>
                <th style="min-width:90px">레코드</th>
                <th style="min-width:160px">키</th>
              </tr>
            </thead>
            <tbody id="fileTbody">
              <tr><td colspan="5" class="muted">아직 업로드된 파일이 없습니다.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="inline">
          <div class="pill"><span class="dot warn"></span><span>로그</span></div>
          <span class="spacer"></span>
          <button id="btnCopyLog" class="secondary" title="로그 복사">로그 복사</button>
          <button id="btnClearLog" class="secondary" title="로그 비우기">비우기</button>
        </div>
        <textarea id="logBox" spellcheck="false" placeholder="여기에 처리 로그가 표시됩니다."></textarea>
      </div>
    </div>
  </div>
</section>

<!-- 섹션2: 요약 -->
<section id="sec-summary">
  <div class="hd">
    <h2>2) 요약 집계</h2>
    <div class="inline">
      <span class="pill"><span class="dot good"></span><span id="dataStatus">데이터 없음</span></span>
      <span class="pill"><span class="dot warn"></span><span class="mono" id="dedupStatus">dedup:0</span></span>
    </div>
  </div>
  <div class="bd">
    <div class="card-row">
      <div class="stat">
        <div class="k">업로드 파일</div>
        <div class="v mono" id="statFiles">0</div>
        <div class="s muted">누적 업로드 기준</div>
      </div>
      <div class="stat">
        <div class="k">원본 레코드</div>
        <div class="v mono" id="statRaw">0</div>
        <div class="s muted">시트/행 기반 추출</div>
      </div>
      <div class="stat">
        <div class="k">중복 제거 후</div>
        <div class="v mono" id="statUniq">0</div>
        <div class="s muted">품질 점수 기반 유지</div>
      </div>
      <div class="stat">
        <div class="k">학교/기관 매핑</div>
        <div class="v mono" id="statMapped">0%</div>
        <div class="s muted">학교 마스터 기반</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="split">
      <div>
        <div class="inline">
          <div class="pill"><span class="dot good"></span><span>인사구분별</span></div>
          <span class="spacer"></span>
          <button class="secondary" id="btnDlSummaryByType">다운로드</button>
        </div>
        <div class="table-wrap" style="max-height:320px;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>인사구분</th>
                <th>건수</th>
                <th>비율</th>
              </tr>
            </thead>
            <tbody id="summaryByTypeTbody">
              <tr><td colspan="3" class="muted">데이터 없음</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="inline">
          <div class="pill"><span class="dot good"></span><span>시군구별(관련 지역)</span></div>
          <span class="spacer"></span>
          <button class="secondary" id="btnDlSummaryByRegion">다운로드</button>
        </div>
        <div class="table-wrap" style="max-height:320px;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>시군구</th>
                <th>건수</th>
                <th>비율</th>
              </tr>
            </thead>
            <tbody id="summaryByRegionTbody">
              <tr><td colspan="3" class="muted">데이터 없음</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 섹션3: 학교/기관별 상세 조회 -->
<section id="sec-entity">
  <div class="hd">
    <h2>3) 학교/기관별 상세 조회</h2>
    <div class="inline">
      <span class="pill"><span class="dot good"></span><span id="entityStatus">대기</span></span>
      <span class="spacer"></span>
      <button id="btnDlEntity" class="secondary" disabled>현재 보기 다운로드</button>
    </div>
  </div>
  <div class="bd">
    <div class="row">
      <div style="flex:1 1 220px">
        <label>1) 보기 기준</label>
        <select id="entityViewMode">
          <option value="both">전출+전입(기본)</option>
          <option value="out">전출(종전기관 기준)</option>
          <option value="in">전입(신규기관 기준)</option>
          <option value="any">관련(둘 중 하나)</option>
        </select>
      </div>
      <div style="flex:2 1 420px">
        <label>2) 학교/기관 선택</label>
        <select id="entityPick" disabled>
          <option value="">(데이터를 업로드하면 목록이 생성됩니다)</option>
        </select>
      </div>
      <div style="flex:1 1 240px">
        <label>3) 검색(학교/기관/직렬/직급/비고)</label>
        <input id="jobKeyword" type="text" placeholder="예: 교육행정, 전산, 주사보, 교무, 행정실..." />
      </div>
      <div style="flex:1 1 200px">
        <label>4) 인사구분</label>
        <select id="personnelType" disabled>
          <option value="전체">전체</option>
          <option value="교육공무원">교육공무원</option>
          <option value="지방공무원">지방공무원</option>
          <option value="교육공무직">교육공무직</option>
          <option value="기타">기타</option>
        </select>
      </div>
      <div style="flex:1 1 220px">
        <label>5) 지방공무원 직급</label>
        <select id="govGradeFilter" disabled>
          <!-- initEntityFilters()에서 GOV_GRADE_ENDINGS로 옵션 구성 -->
        </select>
      </div>
    </div>

    <div class="note" style="margin-top:10px">
      <span class="chip">중요</span>
      <span class="muted">
        “지방공무원 직급” 필터는 인사구분이 <span class="kbd">지방공무원</span>일 때만 활성화됩니다.
        직급 판정은 (발령직급 → 현직급 → 원문 직렬/직급) 순서로 토큰을 탐색해 <span class="kbd">지방*</span> + 특정 끝단(서기보~사무관) 매칭으로 추출합니다.
      </span>
    </div>

    <div class="hr"></div>

    <div class="tri">
      <div>
        <div class="inline">
          <div class="pill"><span class="dot warn"></span><span>전출(종전기관)</span></div>
          <span class="spacer"></span>
          <span class="mono muted" id="outCount">0</span>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table id="outTable">
            <thead>
              <tr>
                <th style="min-width:90px">인사구분</th>
                <th style="min-width:70px">직급</th>
                <th style="min-width:90px">성명</th>
                <th style="min-width:220px">종전기관</th>
                <th style="min-width:120px">종전지역</th>
                <th style="min-width:220px">신규기관</th>
                <th style="min-width:120px">신규지역</th>
                <th style="min-width:180px">직렬/직종(원문)</th>
                <th style="min-width:160px">출처</th>
              </tr>
            </thead>
            <tbody id="outTbody">
              <tr><td colspan="9" class="muted">대기</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="inline">
          <div class="pill"><span class="dot good"></span><span>전입(신규기관)</span></div>
          <span class="spacer"></span>
          <span class="mono muted" id="inCount">0</span>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table id="inTable">
            <thead>
              <tr>
                <th style="min-width:90px">인사구분</th>
                <th style="min-width:70px">직급</th>
                <th style="min-width:90px">성명</th>
                <th style="min-width:220px">신규기관</th>
                <th style="min-width:120px">신규지역</th>
                <th style="min-width:220px">종전기관</th>
                <th style="min-width:120px">종전지역</th>
                <th style="min-width:180px">직렬/직종(원문)</th>
                <th style="min-width:160px">출처</th>
              </tr>
            </thead>
            <tbody id="inTbody">
              <tr><td colspan="9" class="muted">대기</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="inline">
          <div class="pill"><span class="dot bad"></span><span>미분류/기타</span></div>
          <span class="spacer"></span>
          <span class="mono muted" id="unkCount">0</span>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table id="unkTable">
            <thead>
              <tr>
                <th style="min-width:90px">인사구분</th>
                <th style="min-width:70px">직급</th>
                <th style="min-width:90px">성명</th>
                <th style="min-width:240px">기관(원문)</th>
                <th style="min-width:120px">지역</th>
                <th style="min-width:220px">직렬/직종(원문)</th>
                <th style="min-width:220px">비고</th>
                <th style="min-width:160px">출처</th>
              </tr>
            </thead>
            <tbody id="unkTbody">
              <tr><td colspan="8" class="muted">대기</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- 섹션4: 시군구별 상세 조회 -->
<section id="sec-region">
  <div class="hd">
    <h2>4) 시군구별 상세 조회</h2>
    <div class="inline">
      <span class="pill"><span class="dot good"></span><span id="regionStatus">대기</span></span>
      <span class="spacer"></span>
      <button id="btnDlRegion" class="secondary" disabled>현재 보기 다운로드</button>
    </div>
  </div>
  <div class="bd">
    <div class="row">
      <div style="flex:1 1 240px">
        <label>1) 기준(지역)</label>
        <select id="regionOfficeMode" disabled>
          <option value="related">관련 지역(둘 중 하나)</option>
          <option value="from">전출 기준(종전지역)</option>
          <option value="to">전입 기준(신규지역)</option>
        </select>
      </div>
      <div style="flex:1 1 240px">
        <label>2) 시군구 선택</label>
        <select id="regionPick" disabled>
          <option value="">(데이터 업로드 후 선택)</option>
        </select>
      </div>
      <div style="flex:1 1 240px">
        <label>3) 인사구분</label>
        <select id="regionPersonnelType" disabled>
          <option value="전체">전체</option>
          <option value="교육공무원">교육공무원</option>
          <option value="지방공무원">지방공무원</option>
          <option value="교육공무직">교육공무직</option>
          <option value="기타">기타</option>
        </select>
      </div>
      <div style="flex:1 1 240px">
        <label>4) 지방공무원 직급</label>
        <select id="regionGovGradeFilter" disabled></select>
      </div>
      <div style="flex:1 1 240px">
        <label>5) 검색(기관/직렬/직급/비고)</label>
        <input id="regionKeyword" type="text" placeholder="예: 행정, 전산, 조리, 사무관..." disabled />
      </div>
    </div>

    <div class="hr"></div>

    <div class="split">
      <div>
        <div class="inline">
          <div class="pill"><span class="dot good"></span><span>레코드 목록</span></div>
          <span class="spacer"></span>
          <span class="mono muted" id="regionCount">0</span>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table id="regionTable">
            <thead>
              <tr>
                <th style="min-width:90px">인사구분</th>
                <th style="min-width:70px">직급</th>
                <th style="min-width:90px">성명</th>
                <th style="min-width:220px">종전기관</th>
                <th style="min-width:110px">종전지역</th>
                <th style="min-width:220px">신규기관</th>
                <th style="min-width:110px">신규지역</th>
                <th style="min-width:180px">직렬/직종(원문)</th>
                <th style="min-width:220px">비고</th>
                <th style="min-width:160px">출처</th>
              </tr>
            </thead>
            <tbody id="regionTbody">
              <tr><td colspan="10" class="muted">대기</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="pill"><span class="dot warn"></span><span>필터/모드 안내</span></div>
        <div class="note" style="margin-top:10px;line-height:1.6">
          <div class="ok-box">
            <div><b>속초양양 통합</b>: 속초/양양은 <span class="kbd">속초양양</span>으로 집계됩니다.</div>
            <div style="margin-top:6px"><b>병설유치원 합산</b>: “병설유치원” 표기는 기준 학교명으로 정규화됩니다.</div>
          </div>
          <div class="danger-box" style="margin-top:10px">
            <div><b>주의</b>: 엑셀 양식/헤더가 다양한 경우 일부 열은 추정 매핑됩니다. 누락/오인식 레코드는 “미분류/기타”로 남을 수 있습니다.</div>
          </div>
          <div class="hr"></div>
          <div class="pill"><span class="dot good"></span><span>다운로드</span></div>
          <div class="note" style="margin-top:8px">
            “현재 보기 다운로드”는 <span class="kbd">현재 필터</span> 결과만 내보냅니다.<br/>
            파일명에는 인사구분/지역/직급 조건이 반영됩니다.
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

  </div>
</div><div class="float-top" id="btnTop" title="맨위로">↑</div><script>
/* ============================
   내장 학교 마스터
   ============================ */
const GW_SCHOOL_MASTER_ROWS = [{"n":"강원온라인학교","k":"강원온라인학교","r":"원주"},{"n":"가곡고등학교","k":"가곡고등학교","r":"삼척"},{"n":"한국항공고등학교","k":"한국항공고등학교","r":"태백"},{"n":"소양고등학교","k":"소양고등학교","r":"춘천"},{"n":"가곡중학교","k":"가곡중학교","r":"삼척"},{"n":"한국주얼리고등학교","k":"한국주얼리고등학교","r":"원주"},{"n":"한내초등학교","k":"한내초등학교","r":"춘천"},{"n":"가곡초등학교","k":"가곡초등학교","r":"삼척"},{"n":"한국학교(교도소)","k":"한국학교교도소","r":"원주"},{"n":"한림초등학교","k":"한림초등학교","r":"춘천"},{"n":"삼척여자고등학교","k":"삼척여자고등학교","r":"삼척"},{"n":"한림중학교","k":"한림중학교","r":"춘천"},{"n":"삼척고등학교","k":"삼척고등학교","r":"삼척"},{"n":"한림중학교병설유치원","k":"한림중학교병설유치원","r":"춘천"},{"n":"삼척초등학교","k":"삼척초등학교","r":"삼척"},{"n":"한림초병설유치원","k":"한림초병설유치원","r":"춘천"},{"n":"삼척중학교","k":"삼척중학교","r":"삼척"},{"n":"한빛초등학교","k":"한빛초등학교","r":"춘천"},{"n":"삼척중앙초등학교","k":"삼척중앙초등학교","r":"삼척"},{"n":"한빛유치원","k":"한빛유치원","r":"춘천"},{"n":"삼척중앙초병설유치원","k":"삼척중앙초병설유치원","r":"삼척"},{"n":"한빛초병설유치원","k":"한빛초병설유치원","r":"춘천"},{"n":"삼척해양초등학교","k":"삼척해양초등학교","r":"삼척"},{"n":"한사랑유치원","k":"한사랑유치원","r":"춘천"},{"n":"삼척해양초병설유치원","k":"삼척해양초병설유치원","r":"삼척"},{"n":"한샘유치원","k":"한샘유치원","r":"춘천"},{"n":"삼척해양중학교","k":"삼척해양중학교","r":"삼척"},{"n":"한울유치원","k":"한울유치원","r":"춘천"},{"n":"삼척해양고등학교","k":"삼척해양고등학교","r":"삼척"},{"n":"한울초등학교","k":"한울초등학교","r":"춘천"},{"n":"삼척해양고등학교부설방송통신고등학교","k":"삼척해양고등학교부설방송통신고등학교","r":"삼척"},{"n":"한울초병설유치원","k":"한울초병설유치원","r":"춘천"},{"n":"삼척해양고부설방송통신고등학교","k":"삼척해양고부설방송통신고등학교","r":"삼척"},{"n":"한울중학교","k":"한울중학교","r":"춘천"},{"n":"삼척해양고등학교부설방송통신중학교","k":"삼척해양고등학교부설방송통신중학교","r":"삼척"},{"n":"한울중학교병설유치원","k":"한울중학교병설유치원","r":"춘천"},{"n":"삼척해양고부설방송통신중학교","k":"삼척해양고부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원","k":"한울초등학교병설유치원","r":"춘천"},{"n":"삼척해양고등학교병설유치원","k":"삼척해양고등학교병설유치원","r":"삼척"},{"n":"한울초병설유치원(신동초병설유치원)","k":"한울초병설유치원신동초병설유치원","r":"춘천"},{"n":"삼척해양유치원","k":"삼척해양유치원","r":"삼척"},{"n":"한울초병설유치원(청량초병설유치원)","k":"한울초병설유치원청량초병설유치원","r":"춘천"},{"n":"삼척해양초등학교병설유치원","k":"삼척해양초등학교병설유치원","r":"삼척"},{"n":"한울초병설유치원(창촌초병설유치원)","k":"한울초병설유치원창촌초병설유치원","r":"춘천"},{"n":"삼척해양중학교병설유치원","k":"삼척해양중학교병설유치원","r":"삼척"},{"n":"한울초병설유치원(신북초병설유치원)","k":"한울초병설유치원신북초병설유치원","r":"춘천"},{"n":"삼척해양초등학교부설방송통신중학교","k":"삼척해양초등학교부설방송통신중학교","r":"삼척"},{"n":"한울초병설유치원(신북초등학교병설유치원)","k":"한울초병설유치원신북초등학교병설유치원","r":"춘천"},{"n":"삼척해양초부설방송통신중학교","k":"삼척해양초부설방송통신중학교","r":"삼척"},{"n":"한울초병설유치원(신북중학교병설유치원)","k":"한울초병설유치원신북중학교병설유치원","r":"춘천"},{"n":"삼척해양중학교부설방송통신중학교","k":"삼척해양중학교부설방송통신중학교","r":"삼척"},{"n":"한울초병설유치원(신북중학교)","k":"한울초병설유치원신북중학교","r":"춘천"},{"n":"삼척해양중부설방송통신중학교","k":"삼척해양중부설방송통신중학교","r":"삼척"},{"n":"한울초병설유치원(서면초병설유치원)","k":"한울초병설유치원서면초병설유치원","r":"춘천"},{"n":"삼척해양중학교부설방송통신고등학교","k":"삼척해양중학교부설방송통신고등학교","r":"삼척"},{"n":"한울초병설유치원(서상초병설유치원)","k":"한울초병설유치원서상초병설유치원","r":"춘천"},{"n":"삼척해양중부설방송통신고등학교","k":"삼척해양중부설방송통신고등학교","r":"삼척"},{"n":"한울초병설유치원(서상초등학교병설유치원)","k":"한울초병설유치원서상초등학교병설유치원","r":"춘천"},{"n":"삼척해양고등학교부설유치원","k":"삼척해양고등학교부설유치원","r":"삼척"},{"n":"한울초병설유치원(서상초등학교)","k":"한울초병설유치원서상초등학교","r":"춘천"},{"n":"삼척해양고부설유치원","k":"삼척해양고부설유치원","r":"삼척"},{"n":"한울초병설유치원(서상중학교병설유치원)","k":"한울초병설유치원서상중학교병설유치원","r":"춘천"},{"n":"삼척해양중학교부설유치원","k":"삼척해양중학교부설유치원","r":"삼척"},{"n":"한울초병설유치원(서상중학교)","k":"한울초병설유치원서상중학교","r":"춘천"},{"n":"삼척해양중부설유치원","k":"삼척해양중부설유치원","r":"삼척"},{"n":"한울초병설유치원(강촌초병설유치원)","k":"한울초병설유치원강촌초병설유치원","r":"춘천"},{"n":"삼척해양초등학교부설유치원","k":"삼척해양초등학교부설유치원","r":"삼척"},{"n":"한울초병설유치원(강촌초등학교병설유치원)","k":"한울초병설유치원강촌초등학교병설유치원","r":"춘천"},{"n":"삼척해양초부설유치원","k":"삼척해양초부설유치원","r":"삼척"},{"n":"한울초병설유치원(강촌초등학교)","k":"한울초병설유치원강촌초등학교","r":"춘천"},{"n":"삼척해양고등학교부설방송통신중학교부설유치원","k":"삼척해양고등학교부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초병설유치원(강촌중학교병설유치원)","k":"한울초병설유치원강촌중학교병설유치원","r":"춘천"},{"n":"삼척해양고부설방송통신중학교부설유치원","k":"삼척해양고부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초병설유치원(강촌중학교)","k":"한울초병설유치원강촌중학교","r":"춘천"},{"n":"삼척해양중학교부설방송통신중학교부설유치원","k":"삼척해양중학교부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산초병설유치원)","k":"한울초등학교병설유치원남산초병설유치원","r":"춘천"},{"n":"삼척해양중부설방송통신중학교부설유치원","k":"삼척해양중부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산초등학교병설유치원)","k":"한울초등학교병설유치원남산초등학교병설유치원","r":"춘천"},{"n":"삼척해양중학교부설방송통신고등학교부설유치원","k":"삼척해양중학교부설방송통신고등학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산초등학교)","k":"한울초등학교병설유치원남산초등학교","r":"춘천"},{"n":"삼척해양중부설방송통신고등학교부설유치원","k":"삼척해양중부설방송통신고등학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양초등학교병설유치원)","k":"삼척해양유치원삼척해양초등학교병설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교)","k":"한울초등학교병설유치원남산중학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양초병설유치원)","k":"삼척해양유치원삼척해양초병설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산고등학교병설유치원)","k":"한울초등학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교병설유치원)","k":"삼척해양유치원삼척해양중학교병설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산고등학교)","k":"한울초등학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중병설유치원)","k":"삼척해양유치원삼척해양중병설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교)","k":"한울초등학교병설유치원남산중학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양고등학교부설유치원)","k":"삼척해양유치원삼척해양고등학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산초등학교)","k":"한울초등학교병설유치원남산초등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양고부설유치원)","k":"삼척해양유치원삼척해양고부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양고등학교병설유치원)","k":"삼척해양유치원삼척해양고등학교병설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산초병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산초병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양고병설유치원)","k":"삼척해양유치원삼척해양고병설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산초등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산초등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양고등학교부설방송통신중학교부설유치원)","k":"삼척해양유치원삼척해양고등학교부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산초등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산초등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양고부설방송통신중학교부설유치원)","k":"삼척해양유치원삼척해양고부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산중학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산중학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교부설방송통신중학교부설유치원)","k":"삼척해양유치원삼척해양중학교부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중부설방송통신중학교부설유치원)","k":"삼척해양유치원삼척해양중부설방송통신중학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교부설방송통신고등학교부설유치원)","k":"삼척해양유치원삼척해양중학교부설방송통신고등학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중부설방송통신고등학교부설유치원)","k":"삼척해양유치원삼척해양중부설방송통신고등학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양초등학교부설유치원)","k":"삼척해양유치원삼척해양초등학교부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양초부설유치원)","k":"삼척해양유치원삼척해양초부설유치원","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양고등학교부설방송통신중학교)","k":"삼척해양유치원삼척해양고등학교부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양고부설방송통신중학교)","k":"삼척해양유치원삼척해양고부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교부설방송통신중학교)","k":"삼척해양유치원삼척해양중학교부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중부설방송통신중학교)","k":"삼척해양유치원삼척해양중부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교부설방송통신고등학교)","k":"삼척해양유치원삼척해양중학교부설방송통신고등학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중부설방송통신고등학교)","k":"삼척해양유치원삼척해양중부설방송통신고등학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양초등학교부설방송통신중학교)","k":"삼척해양유치원삼척해양초등학교부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양초부설방송통신중학교)","k":"삼척해양유치원삼척해양초부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교부설방송통신중학교)","k":"삼척해양유치원삼척해양중학교부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중부설방송통신중학교)","k":"삼척해양유치원삼척해양중부설방송통신중학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"삼척해양유치원(삼척해양중학교부설방송통신고등학교)","k":"삼척해양유치원삼척해양중학교부설방송통신고등학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교병설유치원)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교병설유치원","r":"춘천"},{"n":"삼척해양유치원(삼척해양중부설방송통신고등학교)","k":"삼척해양유치원삼척해양중부설방송통신고등학교","r":"삼척"},{"n":"한울초등학교병설유치원(남산중학교병설유치원-남산고등학교)","k":"한울초등학교병설유치원남산중학교병설유치원남산고등학교","r":"춘천"},{"n":"섬강고등학교","k":"섬강고등학교","r":"원주"},{"n":"강릉여자고등학교","k":"강릉여자고등학교","r":"강릉"},{"n":"비두초병설유치원","k":"비두초병설유치원","r":"원주"},{"n":"비봉초등학교","k":"비봉초등학교","r":"양구"},{"n":"다인유치원","k":"다인유치원","r":"강릉"}];
/* NOTE: 위 배열은 내장 마스터 일부 예시로 시작됩니다.
   실제 운영에서는 GW_SCHOOL_MASTER_ROWS 전체 목록(강원도 내 전체 학교 목록)을 포함해야 합니다. */

/* ============================
   전역 상수 / 상태
   ============================ */
const GOV_GRADE_ENDINGS = ["서기보시보","서기보","서기","주사보","주사","서기관","사무관"];

const REGIONS_ORDER = [
  "춘천","원주","강릉","동해","태백","삼척",
  "홍천","횡성","영월","평창","정선",
  "철원","화천","양구","인제","고성","속초양양"
];

const state = {
  files: [],                 // {file, key, status, recCount, err}
  fileKeySet: new Set(),
  rawRecords: [],
  records: [],               // deduped
  dedupRemoved: 0,
  stats: {
    mappedOrg: 0,
    mappedOrgTotal: 0,
  },
  indexes: {
    byEntity: new Map(),     // entity -> [recIds]
    byRegion: new Map(),     // region -> [recIds]
  },
  currentExport: { title: "export", rows: [], sheetName: "data" },
};

const el = {
  xlsxDot: null,
  xlsxStatus: null,
  appClock: null,
  fileInput: null,
  btnParse: null,
  btnClear: null,
  globalProgress: null,
  globalProgressText: null,
  globalCounts: null,
  fileTbody: null,
  logBox: null,
  btnCopyLog: null,
  btnClearLog: null,

  dataStatus: null,
  dedupStatus: null,
  statFiles: null,
  statRaw: null,
  statUniq: null,
  statMapped: null,
  summaryByTypeTbody: null,
  summaryByRegionTbody: null,
  btnDlSummaryByType: null,
  btnDlSummaryByRegion: null,

  entityStatus: null,
  btnDlEntity: null,
  entityViewMode: null,
  entityPick: null,
  jobKeyword: null,
  personnelType: null,
  govGradeFilter: null,
  outTbody: null,
  inTbody: null,
  unkTbody: null,
  outCount: null,
  inCount: null,
  unkCount: null,

  regionStatus: null,
  btnDlRegion: null,
  regionOfficeMode: null,
  regionPick: null,
  regionPersonnelType: null,
  regionGovGradeFilter: null,
  regionKeyword: null,
  regionTbody: null,
  regionCount: null,

  btnTop: null,
};

function $(id){ return document.getElementById(id); }

function nowStr(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,'0');
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function log(line, level="info"){
  const t = new Date();
  const pad=n=>String(n).padStart(2,'0');
  const stamp = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())} ${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`;
  const prefix = level==="error"?"[ERR]":level==="warn"?"[WRN]":"[INF]";
  el.logBox.value += `${stamp} ${prefix} ${line}\n`;
  el.logBox.scrollTop = el.logBox.scrollHeight;
  try{ console[level==="info"?"log":level](line); } catch(e){}
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function fmtBytes(b){
  if (b==null) return "-";
  const u=["B","KB","MB","GB"];
  let i=0; let v=b;
  while(v>=1024 && i<u.length-1){ v/=1024; i++; }
  return `${v.toFixed(i?1:0)} ${u[i]}`;
}

function safeText(v){
  if (v==null) return "";
  if (typeof v==="string") return v.trim();
  if (typeof v==="number") return String(v);
  if (v instanceof Date) return v.toISOString().slice(0,10);
  return String(v).trim();
}

/* ============================
   SheetJS 로더 (CDN + 로컬 fallback + 진행률 UI)
   ============================ */
async function loadSheetJS(){
  if (window.XLSX) return true;

  el.xlsxDot.className = "dot warn";
  el.xlsxStatus.textContent = "SheetJS 로딩 중(CDN)…";
  let p = 0;
  let timer = setInterval(() => {
    p = clamp(p + 3, 0, 92);
    setGlobalProgress(p, `라이브러리 로드 중… ${p}%`);
  }, 60);

  const cdn = "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js";
  const local = "/static/xlsx.full.min.js";

  const loadScript = (src) => new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.onload = () => resolve(true);
    s.onerror = () => reject(new Error(`load fail: ${src}`));
    document.head.appendChild(s);
  });

  try{
    await loadScript(cdn);
    clearInterval(timer);
    setGlobalProgress(100, "라이브러리 로드 완료");
    el.xlsxDot.className = "dot good";
    el.xlsxStatus.textContent = "SheetJS 준비 완료(CDN)";
    log("SheetJS CDN 로드 완료");
    return true;
  }catch(e1){
    log("SheetJS CDN 로드 실패 → 로컬 fallback 시도", "warn");
    el.xlsxStatus.textContent = "SheetJS 로딩 중(로컬)…";
    try{
      await loadScript(local);
      clearInterval(timer);
      setGlobalProgress(100, "라이브러리 로드 완료");
      el.xlsxDot.className = "dot good";
      el.xlsxStatus.textContent = "SheetJS 준비 완료(로컬)";
      log("SheetJS 로컬 fallback 로드 완료");
      return true;
    }catch(e2){
      clearInterval(timer);
      setGlobalProgress(0, "라이브러리 로드 실패");
      el.xlsxDot.className = "dot bad";
      el.xlsxStatus.textContent = "SheetJS 로드 실패";
      log("SheetJS 로드 실패: /static/xlsx.full.min.js 존재 여부 확인 필요", "error");
      return false;
    }
  }
}

function setGlobalProgress(percent, text){
  el.globalProgress.style.width = `${clamp(percent,0,100)}%`;
  if (text) el.globalProgressText.textContent = text;
}

/* ============================
   학교 마스터 인덱스 / 정규화
   ============================ */
const masterIndex = (() => {
  const byKey = new Map();
  const byName = new Map();
  for (const row of GW_SCHOOL_MASTER_ROWS){
    if (!row || !row.k) continue;
    byKey.set(row.k, row);
    byName.set(row.n, row);
  }
  return { byKey, byName };
})();

function normOrgKey(s){
  let t = safeText(s);
  if (!t) return "";
  t = t.replace(/\u00A0/g, " "); // NBSP
  t = t.replace(/\s+/g, "");
  t = t.replace(/[\/·\-\–\—_.,:;"'`~!@#$%^&*+=|\\?<>{}\[\]（）()]/g, "");
  return t;
}

function normalizeOrgName(raw){
  const orig = safeText(raw);
  if (!orig) return { name:"", region:"", matched:false, key:"" };

  // 병설유치원 합산: "OO초병설유치원" -> "OO초"
  let s = orig.replace(/\s+/g, " ").trim();
  let s2 = s.replace(/병설유치원/g, "").replace(/\s+/g," ").trim();

  // 흔한 표기 정리
  s2 = s2.replace(/강원특별자치도교육청|강원도교육청/g, "강원도교육청");
  s2 = s2.replace(/교육지원청/g, "교육지원청"); // 유지

  const key = normOrgKey(s2);

  let hit = masterIndex.byKey.get(key);
  if (!hit && s2 !== s) hit = masterIndex.byKey.get(normOrgKey(s));
  if (!hit && masterIndex.byName.has(s2)) hit = masterIndex.byName.get(s2);

  if (hit){
    return { name: hit.n, region: normalizeRegion(hit.r), matched:true, key: hit.k };
  }

  // 교육지원청 / 직속기관 등 추정 지역
  const region = inferRegionFromOrgName(s2);
  return { name: s2, region, matched:false, key };
}

function normalizeRegion(r){
  let s = safeText(r);
  if (!s) return "";
  s = s.replace(/(특별자치도|광역시|특별시|도|시|군)$/g, "");
  if (s === "속초" || s === "양양") return "속초양양";
  return s;
}

function inferRegionFromOrgName(orgName){
  const s = safeText(orgName);
  if (!s) return "";
  // 정규식으로 지역 토큰 찾기
  for (const r of REGIONS_ORDER){
    if (s.includes(r)) return r;
  }
  // 주소처럼 "원주시", "양구군"
  const m = s.match(/([가-힣]+?)(시|군)/);
  if (m) return normalizeRegion(m[0]);
  return "";
}

/* ============================
   지방공무원 직급 추출 (요구사항 정확 적용)
   ============================ */
function extractLocalGovGrade(text){
  if (!text) return "";
  const src = String(text);

  // "/" 등으로 합쳐진 값은 토큰 분리 후 탐색
  const tokens = src.split(/[\/\n,;|]+/g);

  for (let tok of tokens){
    if (!tok) continue;

    // 공백/슬래시 등을 제거한 값
    const cleaned = tok
      .replace(/\u00A0/g, "")
      .replace(/[\/\s]+/g, "")
      .replace(/[·\-\–\—_.,:;"'`~!@#$%^&*+=|\\?<>{}（）()]/g, "");

    if (!cleaned) continue;
    if (!cleaned.startsWith("지방")) continue;

    for (const ending of GOV_GRADE_ENDINGS){
      if (cleaned.endsWith(ending)){
        return ending;
      }
    }
  }
  return "";
}

function extractLocalGovGradeFromRec(rec){
  // 우선순위: (발령직급 newRank) → (현직급 curRank) → (jobRaw) 순
  const v1 = extractLocalGovGrade(rec?.newRank);
  if (v1) return v1;
  const v2 = extractLocalGovGrade(rec?.curRank);
  if (v2) return v2;
  const v3 = extractLocalGovGrade(rec?.jobRaw);
  if (v3) return v3;
  return "";
}

/* ============================
   엑셀 파싱(헤더 추정 + 레코드 생성)
   ============================ */
const HEADER_SYNONYMS = {
  name: ["성명","이름","성 명","성명(한글)","성명(한)","성명(국문)","성명(성)"],
  fromOrg: ["종전기관","전출기관","발령전","이전기관","현기관","현근무지","전임기관","전임학교","종전학교","전출학교","기존기관","전근전","원소속"],
  toOrg: ["신규기관","전입기관","발령후","변경기관","신임기관","전입학교","신규학교","전보후","전근후","발령기관","현소속","이동후"],
  curRank: ["현직급","현직","현직위","현직급(계급)","현 직급","현재직급","현임","현직급/직"],
  newRank: ["발령직급","직급","발령직급(계급)","발령 직급","신규직급","임용직급","전보직급"],
  jobRaw: ["직렬","직종","직명","담당","담당업무","직위","직렬/직종","직종(직렬)","직종/직급","직렬(직종)","직렬(직급)","직종(직급)"],
  type: ["구분","인사구분","직종구분","직군","분류","대상","직종(구분)","공무원구분"],
  remark: ["비고","참고","특기사항","메모","기타","설명"],
};

function hnorm(s){
  return safeText(s).replace(/\s+/g,"").replace(/[·\-\–\—_.,:;"'`~!@#$%^&*+=|\\?<>{}\[\]（）()]/g, "");
}
function buildHeaderMap(headerRow){
  const map = new Map();
  for (let i=0;i<headerRow.length;i++){
    const h = hnorm(headerRow[i]);
    if (!h) continue;
    map.set(h, i);
  }
  return map;
}
function pickColIdx(hmap, synonyms){
  for (const syn of synonyms){
    const k = hnorm(syn);
    if (hmap.has(k)) return hmap.get(k);
  }
  // 느슨한 매칭(부분 포함)
  for (const [hk, idx] of hmap.entries()){
    for (const syn of synonyms){
      const k = hnorm(syn);
      if (hk.includes(k) || k.includes(hk)) return idx;
    }
  }
  return -1;
}

function isLikelyHeaderRow(row){
  const cells = row.map(hnorm).filter(Boolean);
  if (cells.length < 3) return false;
  const hasName = cells.some(c => HEADER_SYNONYMS.name.some(s => c.includes(hnorm(s))));
  const hasOrg = cells.some(c => HEADER_SYNONYMS.fromOrg.some(s => c.includes(hnorm(s))) || HEADER_SYNONYMS.toOrg.some(s => c.includes(hnorm(s))));
  return hasName && hasOrg;
}

function detectPersonnelType(rawType, jobRaw, curRank, newRank){
  const t = (safeText(rawType)+" "+safeText(jobRaw)+" "+safeText(curRank)+" "+safeText(newRank)).replace(/\s+/g,"");
  if (!t) return "기타";
  if (t.includes("교육공무직") || t.includes("공무직") || t.includes("조리실무사") || t.includes("행정실무사") || t.includes("특수교육실무사")) return "교육공무직";
  if (t.includes("지방공무원") || t.includes("지방") && GOV_GRADE_ENDINGS.some(e => t.includes(e))) return "지방공무원";
  if (t.includes("교원") || t.includes("교사") || t.includes("교감") || t.includes("교장") || t.includes("장학") || t.includes("교육공무원")) return "교육공무원";
  return "기타";
}

function placeholderRow(name, fromOrg, toOrg){
  const n = safeText(name);
  const f = safeText(fromOrg);
  const t = safeText(toOrg);
  if (!n && !f && !t) return true;
  if (/^(합계|계|총계)$/i.test(n)) return true;
  if (n && (n.includes("합계") || n.includes("총계"))) return true;
  return false;
}

function computeQualityScore(rec){
  let s=0;
  if (rec.name) s+=4;
  if (rec.fromOrg) s+=2;
  if (rec.toOrg) s+=2;
  if (rec.newRank) s+=1;
  if (rec.curRank) s+=1;
  if (rec.jobRaw) s+=1;
  if (rec.personnelType) s+=1;
  if (rec.fromRegion || rec.toRegion) s+=1;
  if (rec.govGrade) s+=1;
  return s;
}

function recordKey(rec){
  // 중복 제거 키(양식 다양성 고려: 핵심 필드)
  const parts = [
    rec.personnelType || "",
    rec.name || "",
    rec.fromOrgNorm || rec.fromOrg || "",
    rec.toOrgNorm || rec.toOrg || "",
    rec.newRank || "",
    rec.curRank || "",
    rec.jobRaw || "",
    rec.remark || ""
  ].map(x => safeText(x).replace(/\s+/g,""));
  return parts.join("|");
}

function splitRecordsByEntity(recs, entityName, viewMode){
  const out=[], inn=[], unk=[];
  const en = safeText(entityName);
  for (const rec of recs){
    const f = rec.fromOrgNorm || rec.fromOrg;
    const t = rec.toOrgNorm || rec.toOrg;

    const isFrom = f && (f === en);
    const isTo = t && (t === en);

    if (viewMode === "out"){
      if (isFrom) out.push(rec);
      continue;
    }
    if (viewMode === "in"){
      if (isTo) inn.push(rec);
      continue;
    }
    if (viewMode === "both"){
      if (isFrom) out.push(rec);
      if (isTo) inn.push(rec);
      if (!isFrom && !isTo && (rec.orgAnyNorm===en || rec.orgAny===en)) unk.push(rec);
      continue;
    }
    // any: 관련(둘 중 하나)
    if (isFrom) out.push(rec);
    else if (isTo) inn.push(rec);
    else if ((rec.orgAnyNorm===en || rec.orgAny===en)) unk.push(rec);
  }
  return { out, inn, unk };
}

function keywordPass(rec, kw){
  const k = safeText(kw);
  if (!k) return true;
  const hay = [
    rec.name, rec.fromOrg, rec.toOrg, rec.fromOrgNorm, rec.toOrgNorm,
    rec.jobRaw, rec.newRank, rec.curRank, rec.remark, rec.sourceFile, rec.sheetName,
    rec.fromRegion, rec.toRegion, rec.govGrade
  ].map(safeText).join(" ").toLowerCase();
  return hay.includes(k.toLowerCase());
}

/* ============================
   요구사항: filterByPersonnelAndJob()에 govGrade 조건 추가
   ============================ */
function filterByPersonnelAndJob(recs, personnelType, kw, govGradeOpt){
  const pt = personnelType || "전체";
  const gg = govGradeOpt || "전체";
  return recs.filter(rec => {
    // 인사구분
    if (pt !== "전체" && rec.personnelType !== pt) return false;

    // 직급 필터(지방공무원일 때만)
    if (pt === "지방공무원" && gg !== "전체"){
      if (!(rec.personnelType === "지방공무원" && rec.govGrade === gg)) return false;
    }

    // 키워드
    if (!keywordPass(rec, kw)) return false;

    return true;
  });
}

/* ============================
   UI 초기화 / 이벤트
   ============================ */
function cacheDom(){
  el.xlsxDot = $("xlsxDot");
  el.xlsxStatus = $("xlsxStatus");
  el.appClock = $("appClock");
  el.fileInput = $("fileInput");
  el.btnParse = $("btnParse");
  el.btnClear = $("btnClear");
  el.globalProgress = $("globalProgress");
  el.globalProgressText = $("globalProgressText");
  el.globalCounts = $("globalCounts");
  el.fileTbody = $("fileTbody");
  el.logBox = $("logBox");
  el.btnCopyLog = $("btnCopyLog");
  el.btnClearLog = $("btnClearLog");

  el.dataStatus = $("dataStatus");
  el.dedupStatus = $("dedupStatus");
  el.statFiles = $("statFiles");
  el.statRaw = $("statRaw");
  el.statUniq = $("statUniq");
  el.statMapped = $("statMapped");
  el.summaryByTypeTbody = $("summaryByTypeTbody");
  el.summaryByRegionTbody = $("summaryByRegionTbody");
  el.btnDlSummaryByType = $("btnDlSummaryByType");
  el.btnDlSummaryByRegion = $("btnDlSummaryByRegion");

  el.entityStatus = $("entityStatus");
  el.btnDlEntity = $("btnDlEntity");
  el.entityViewMode = $("entityViewMode");
  el.entityPick = $("entityPick");
  el.jobKeyword = $("jobKeyword");
  el.personnelType = $("personnelType");
  el.govGradeFilter = $("govGradeFilter");
  el.outTbody = $("outTbody");
  el.inTbody = $("inTbody");
  el.unkTbody = $("unkTbody");
  el.outCount = $("outCount");
  el.inCount = $("inCount");
  el.unkCount = $("unkCount");

  el.regionStatus = $("regionStatus");
  el.btnDlRegion = $("btnDlRegion");
  el.regionOfficeMode = $("regionOfficeMode");
  el.regionPick = $("regionPick");
  el.regionPersonnelType = $("regionPersonnelType");
  el.regionGovGradeFilter = $("regionGovGradeFilter");
  el.regionKeyword = $("regionKeyword");
  el.regionTbody = $("regionTbody");
  el.regionCount = $("regionCount");

  el.btnTop = $("btnTop");
}

function initClock(){
  el.appClock.textContent = nowStr();
  setInterval(()=>el.appClock.textContent = nowStr(), 1000);
}

function initDnd(){
  const zone = $("sec-upload");
  zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.style.outline = "2px dashed rgba(0,207,232,.65)"; zone.style.outlineOffset="6px"; });
  zone.addEventListener("dragleave", ()=>{ zone.style.outline=""; zone.style.outlineOffset=""; });
  zone.addEventListener("drop", (e)=>{
    e.preventDefault();
    zone.style.outline=""; zone.style.outlineOffset="";
    if (e.dataTransfer?.files?.length){
      addFiles(e.dataTransfer.files);
    }
  });
}

function initButtons(){
  el.btnTop.addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}));
  el.btnCopyLog.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(el.logBox.value || "");
      log("로그를 클립보드에 복사했습니다.");
    }catch(e){
      log("로그 복사 실패(브라우저 권한/HTTPS 확인)", "warn");
    }
  });
  el.btnClearLog.addEventListener("click", ()=>{
    el.logBox.value = "";
  });

  el.btnClear.addEventListener("click", resetAll);

  el.btnParse.addEventListener("click", async ()=>{
    const ok = await loadSheetJS();
    if (!ok) return;
    await parseAllQueuedFiles();
  });

  el.fileInput.addEventListener("change", ()=>{
    if (el.fileInput.files?.length){
      addFiles(el.fileInput.files);
      el.fileInput.value = "";
    }
  });

  el.btnDlSummaryByType.addEventListener("click", ()=>{
    const rows = buildSummaryByTypeRows();
    downloadAsXlsxOrCsv("summary_by_type", rows, "summary_by_type");
  });
  el.btnDlSummaryByRegion.addEventListener("click", ()=>{
    const rows = buildSummaryByRegionRows();
    downloadAsXlsxOrCsv("summary_by_region", rows, "summary_by_region");
  });
}

function initEntityFilters(){
  // GOV_GRADE_ENDINGS 기반 옵션 구성(중복 하드코딩 금지)
  const makeGovGradeOptions = (sel) => {
    sel.innerHTML = "";
    const opts = ["전체", ...GOV_GRADE_ENDINGS];
    for (const o of opts){
      const op = document.createElement("option");
      op.value = o;
      op.textContent = o;
      sel.appendChild(op);
    }
    sel.value = "전체";
  };
  makeGovGradeOptions(el.govGradeFilter);

  const toggleGovGrade = () => {
    const pt = el.personnelType.value;
    if (pt === "지방공무원"){
      el.govGradeFilter.disabled = false;
    }else{
      el.govGradeFilter.disabled = true;
      el.govGradeFilter.value = "전체";
    }
  };

  el.entityViewMode.addEventListener("change", renderEntityView);
  el.entityPick.addEventListener("change", renderEntityView);
  el.jobKeyword.addEventListener("input", debounce(renderEntityView, 120));
  el.personnelType.addEventListener("change", ()=>{
    toggleGovGrade();
    renderEntityView();
  });
  el.govGradeFilter.addEventListener("change", renderEntityView);

  toggleGovGrade();
}

function initRegionFilters(){
  const makeGovGradeOptions = (sel) => {
    sel.innerHTML = "";
    const opts = ["전체", ...GOV_GRADE_ENDINGS];
    for (const o of opts){
      const op = document.createElement("option");
      op.value = o;
      op.textContent = o;
      sel.appendChild(op);
    }
    sel.value = "전체";
  };
  makeGovGradeOptions(el.regionGovGradeFilter);

  const toggleGovGrade = () => {
    const pt = el.regionPersonnelType.value;
    if (pt === "지방공무원"){
      el.regionGovGradeFilter.disabled = false;
    }else{
      el.regionGovGradeFilter.disabled = true;
      el.regionGovGradeFilter.value = "전체";
    }
  };

  el.regionOfficeMode.addEventListener("change", renderRegionView);
  el.regionPick.addEventListener("change", renderRegionView);
  el.regionPersonnelType.addEventListener("change", ()=>{
    toggleGovGrade();
    renderRegionView();
  });
  el.regionGovGradeFilter.addEventListener("change", renderRegionView);
  el.regionKeyword.addEventListener("input", debounce(renderRegionView, 120));

  toggleGovGrade();
}

function debounce(fn, ms){
  let t=null;
  return function(...args){
    clearTimeout(t);
    t=setTimeout(()=>fn.apply(this,args), ms);
  };
}

/* ============================
   파일 누적 업로드 / 중복스킵 / 목록
   ============================ */
function fileKeyOf(file){
  return `${file.name}__${file.size}__${file.lastModified}`;
}

function addFiles(fileList){
  const arr = Array.from(fileList || []);
  let added=0, skipped=0;

  for (const file of arr){
    const key = fileKeyOf(file);
    if (state.fileKeySet.has(key)){
      skipped++;
      continue;
    }
    state.fileKeySet.add(key);
    state.files.push({ file, key, status:"대기", recCount:0, err:"" });
    added++;
  }

  if (added){
    log(`파일 추가: ${added}개 (중복 스킵: ${skipped}개)`);
  }else{
    log(`추가된 파일 없음 (중복 스킵: ${skipped}개)`, "warn");
  }

  renderFileTable();
  updateButtons();
  setGlobalProgress(0, "대기");
}

function renderFileTable(){
  if (!state.files.length){
    el.fileTbody.innerHTML = `<tr><td colspan="5" class="muted">아직 업로드된 파일이 없습니다.</td></tr>`;
    el.globalCounts.textContent = `files:0 rec:${state.rawRecords.length}`;
    return;
  }
  const rows = state.files.map(f => {
    const statusChip = f.status === "완료"
      ? `<span class="chip2">${escapeHtml(f.status)}</span>`
      : f.status === "오류"
        ? `<span class="chip" style="background:rgba(234,84,85,.12);border-color:rgba(234,84,85,.25)">${escapeHtml(f.status)}</span>`
        : `<span class="chip">${escapeHtml(f.status)}</span>`;

    const err = f.err ? `<div class="muted" style="margin-top:4px">${escapeHtml(f.err)}</div>` : "";
    return `<tr>
      <td>
        <div><b>${escapeHtml(f.file.name)}</b></div>
        <div class="muted mono">${new Date(f.file.lastModified).toISOString().slice(0,19).replace("T"," ")}</div>
        ${err}
      </td>
      <td class="mono">${fmtBytes(f.file.size)}</td>
      <td>${statusChip}</td>
      <td class="mono">${f.recCount || 0}</td>
      <td class="mono">${escapeHtml(f.key)}</td>
    </tr>`;
  }).join("");
  el.fileTbody.innerHTML = rows;
  el.globalCounts.textContent = `files:${state.files.length} rec:${state.rawRecords.length}`;
}

function updateButtons(){
  const hasFiles = state.files.length > 0;
  const anyPending = state.files.some(f => f.status === "대기");
  el.btnParse.disabled = !(hasFiles && anyPending);
  el.btnClear.disabled = !hasFiles && state.rawRecords.length===0;
}

/* ============================
   파싱 / 중복제거 / 인덱싱
   ============================ */
async function parseAllQueuedFiles(){
  if (!window.XLSX){
    log("SheetJS가 준비되지 않았습니다.", "error");
    return;
  }
  const pending = state.files.filter(f => f.status === "대기");
  if (!pending.length){
    log("파싱할 대기 파일이 없습니다.", "warn");
    return;
  }

  el.btnParse.disabled = true;
  el.btnClear.disabled = true;

  let done=0;
  const total = pending.length;

  for (const f of pending){
    f.status = "파싱중";
    f.err = "";
    renderFileTable();

    try{
      const recs = await parseOneFile(f.file, (p, msg) => {
        const base = (done/total)*100;
        const local = (p/100)*(100/total);
        setGlobalProgress(clamp(base+local,0,99), `${msg}`);
      });
      f.recCount = recs.length;
      f.status = "완료";
      state.rawRecords.push(...recs);
      log(`파싱 완료: ${f.file.name} → ${recs.length}건`);
    }catch(e){
      f.status = "오류";
      f.err = e?.message ? String(e.message) : "unknown error";
      log(`파싱 오류: ${f.file.name} (${f.err})`, "error");
    }
    done++;
    renderFileTable();
  }

  setGlobalProgress(100, "파싱 완료. 집계 중…");
  await new Promise(r=>setTimeout(r, 10));

  dedupAndReindex();
  refreshAllViews();

  setGlobalProgress(0, "대기");
  el.btnClear.disabled = false;
  updateButtons();
}

async function parseOneFile(file, onProgress){
  const buf = await file.arrayBuffer();
  onProgress?.(8, "엑셀 로드 중…");
  await new Promise(r=>setTimeout(r,0));

  const wb = XLSX.read(buf, { type:"array", cellDates:true, dense:false });
  const recs = [];
  const sheetNames = wb.SheetNames || [];
  const totalSheets = sheetNames.length || 1;

  for (let si=0; si<sheetNames.length; si++){
    const sn = sheetNames[si];
    const sheet = wb.Sheets[sn];
    if (!sheet) continue;

    onProgress?.(10 + (si/totalSheets)*70, `시트 파싱: ${sn}…`);
    const aoa = XLSX.utils.sheet_to_json(sheet, { header:1, defval:"", raw:false, blankrows:false });
    if (!aoa || !aoa.length) continue;

    // 헤더 탐색
    let headerRowIdx = -1;
    const scanMax = Math.min(aoa.length, 30);
    for (let i=0;i<scanMax;i++){
      if (isLikelyHeaderRow(aoa[i])){
        headerRowIdx = i;
        break;
      }
    }
    if (headerRowIdx < 0){
      // fallback: 첫 행을 헤더로 취급
      headerRowIdx = 0;
    }
    const header = aoa[headerRowIdx] || [];
    const hmap = buildHeaderMap(header);

    const idx = {
      name: pickColIdx(hmap, HEADER_SYNONYMS.name),
      fromOrg: pickColIdx(hmap, HEADER_SYNONYMS.fromOrg),
      toOrg: pickColIdx(hmap, HEADER_SYNONYMS.toOrg),
      curRank: pickColIdx(hmap, HEADER_SYNONYMS.curRank),
      newRank: pickColIdx(hmap, HEADER_SYNONYMS.newRank),
      jobRaw: pickColIdx(hmap, HEADER_SYNONYMS.jobRaw),
      type: pickColIdx(hmap, HEADER_SYNONYMS.type),
      remark: pickColIdx(hmap, HEADER_SYNONYMS.remark),
    };

    const start = headerRowIdx + 1;
    for (let r = start; r < aoa.length; r++){
      const row = aoa[r];
      if (!row || !row.length) continue;

      const name = idx.name>=0 ? safeText(row[idx.name]) : "";
      const fromOrg = idx.fromOrg>=0 ? safeText(row[idx.fromOrg]) : "";
      const toOrg = idx.toOrg>=0 ? safeText(row[idx.toOrg]) : "";
      const curRank = idx.curRank>=0 ? safeText(row[idx.curRank]) : "";
      const newRank = idx.newRank>=0 ? safeText(row[idx.newRank]) : "";
      const jobRaw = idx.jobRaw>=0 ? safeText(row[idx.jobRaw]) : "";
      const rawType = idx.type>=0 ? safeText(row[idx.type]) : "";
      const remark = idx.remark>=0 ? safeText(row[idx.remark]) : "";

      if (placeholderRow(name, fromOrg, toOrg)) continue;

      const fromN = normalizeOrgName(fromOrg);
      const toN = normalizeOrgName(toOrg);

      // 기관/지역 매핑 통계
      if (fromOrg){ state.stats.mappedOrgTotal++; if (fromN.matched) state.stats.mappedOrg++; }
      if (toOrg){ state.stats.mappedOrgTotal++; if (toN.matched) state.stats.mappedOrg++; }

      const personnelType = detectPersonnelType(rawType, jobRaw, curRank, newRank);

      const rec = {
        sourceFile: file.name,
        sheetName: sn,
        rowNumber: r+1,

        // 원문
        rawType,
        name,
        fromOrg,
        toOrg,
        curRank,
        newRank,
        jobRaw,
        remark,

        // 정규화
        personnelType,
        fromOrgNorm: fromN.name,
        toOrgNorm: toN.name,
        fromRegion: fromN.region,
        toRegion: toN.region,

        // (미분류용) 단일 기관/지역 보조
        orgAny: fromOrg || toOrg,
        orgAnyNorm: fromN.name || toN.name,
        regionAny: fromN.region || toN.region,

        // 품질 점수
        q: 0,

        // 추가 필드(요구사항)
        govGrade: "",
      };

      // rec.personnelType 판별 이후 rec.govGrade 할당 (요구사항)
      if (rec.personnelType === "지방공무원"){
        rec.govGrade = extractLocalGovGradeFromRec(rec);
      }

      rec.q = computeQualityScore(rec);
      recs.push(rec);

      if (r % 250 === 0){
        const frac = (r / aoa.length) * 100;
        onProgress?.(10 + (si/totalSheets)*70 + (frac/100)*(70/totalSheets), `행 처리: ${sn} (${r}/${aoa.length})…`);
        await new Promise(res=>setTimeout(res, 0));
      }
    }
  }

  onProgress?.(95, "마무리…");
  await new Promise(r=>setTimeout(r,0));
  return recs;
}

function dedupAndReindex(){
  const m = new Map();
  let removed = 0;

  for (const rec of state.rawRecords){
    const k = recordKey(rec);
    const prev = m.get(k);
    if (!prev){
      m.set(k, rec);
    }else{
      // 품질 점수 방식 그대로(높은 점수 유지)
      if ((rec.q||0) > (prev.q||0)){
        m.set(k, rec);
      }
      removed++;
    }
  }

  state.records = Array.from(m.values());
  state.dedupRemoved = removed;

  // 인덱스 구성
  state.indexes.byEntity.clear();
  state.indexes.byRegion.clear();

  for (let i=0;i<state.records.length;i++){
    const rec = state.records[i];

    // entity index(종전/신규/기타 모두 포함)
    const entities = new Set();
    if (rec.fromOrgNorm) entities.add(rec.fromOrgNorm);
    if (rec.toOrgNorm) entities.add(rec.toOrgNorm);
    if (!entities.size && rec.orgAnyNorm) entities.add(rec.orgAnyNorm);

    for (const e of entities){
      if (!state.indexes.byEntity.has(e)) state.indexes.byEntity.set(e, []);
      state.indexes.byEntity.get(e).push(i);
    }

    // region index(관련 지역)
    const regions = new Set();
    if (rec.fromRegion) regions.add(rec.fromRegion);
    if (rec.toRegion) regions.add(rec.toRegion);
    if (!regions.size && rec.regionAny) regions.add(rec.regionAny);
    for (const r of regions){
      if (!state.indexes.byRegion.has(r)) state.indexes.byRegion.set(r, []);
      state.indexes.byRegion.get(r).push(i);
    }
  }

  log(`중복 제거 완료: 원본 ${state.rawRecords.length} → 유니크 ${state.records.length} (제거 ${removed})`);
}

/* ============================
   렌더링: 요약/상세
   ============================ */
function refreshAllViews(){
  // 요약
  renderSummary();

  // 필터 활성화 및 옵션 구성
  populateEntityPick();
  populateRegionPick();

  el.entityPick.disabled = state.records.length===0;
  el.personnelType.disabled = state.records.length===0;
  el.btnDlEntity.disabled = state.records.length===0;
  el.regionOfficeMode.disabled = state.records.length===0;
  el.regionPick.disabled = state.records.length===0;
  el.regionPersonnelType.disabled = state.records.length===0;
  el.regionKeyword.disabled = state.records.length===0;
  el.btnDlRegion.disabled = state.records.length===0;

  // 상세 뷰
  renderEntityView();
  renderRegionView();

  // 상태 표시
  el.dataStatus.textContent = state.records.length ? "데이터 준비됨" : "데이터 없음";
  el.dedupStatus.textContent = `dedup:${state.dedupRemoved}`;
}

function renderSummary(){
  el.statFiles.textContent = String(state.files.length);
  el.statRaw.textContent = String(state.rawRecords.length);
  el.statUniq.textContent = String(state.records.length);

  const mappedPct = state.stats.mappedOrgTotal ? Math.round((state.stats.mappedOrg / state.stats.mappedOrgTotal) * 100) : 0;
  el.statMapped.textContent = `${mappedPct}%`;

  // by type
  const rowsType = buildSummaryByTypeRows();
  if (!rowsType.length){
    el.summaryByTypeTbody.innerHTML = `<tr><td colspan="3" class="muted">데이터 없음</td></tr>`;
  }else{
    const total = rowsType.reduce((a,b)=>a+(b.count||0),0) || 1;
    el.summaryByTypeTbody.innerHTML = rowsType.map(r=>{
      const pct = ((r.count/total)*100).toFixed(1) + "%";
      return `<tr><td><b>${escapeHtml(r.personnelType)}</b></td><td class="mono">${r.count}</td><td class="mono">${pct}</td></tr>`;
    }).join("");
  }

  // by region
  const rowsRegion = buildSummaryByRegionRows();
  if (!rowsRegion.length){
    el.summaryByRegionTbody.innerHTML = `<tr><td colspan="3" class="muted">데이터 없음</td></tr>`;
  }else{
    const total = rowsRegion.reduce((a,b)=>a+(b.count||0),0) || 1;
    el.summaryByRegionTbody.innerHTML = rowsRegion.map(r=>{
      const pct = ((r.count/total)*100).toFixed(1) + "%";
      return `<tr><td><b>${escapeHtml(r.region)}</b></td><td class="mono">${r.count}</td><td class="mono">${pct}</td></tr>`;
    }).join("");
  }
}

function buildSummaryByTypeRows(){
  if (!state.records.length) return [];
  const c = new Map();
  for (const rec of state.records){
    const k = rec.personnelType || "기타";
    c.set(k, (c.get(k)||0)+1);
  }
  const order = ["교육공무원","지방공무원","교육공무직","기타"];
  const rows = Array.from(c.entries()).map(([k,v])=>({ personnelType:k, count:v }));
  rows.sort((a,b)=> (order.indexOf(a.personnelType)-order.indexOf(b.personnelType)) || (b.count-a.count));
  return rows;
}

function buildSummaryByRegionRows(){
  if (!state.records.length) return [];
  const c = new Map();
  for (const rec of state.records){
    const set = new Set();
    if (rec.fromRegion) set.add(rec.fromRegion);
    if (rec.toRegion) set.add(rec.toRegion);
    if (!set.size && rec.regionAny) set.add(rec.regionAny);
    for (const r of set){
      const rr = r || "미상";
      c.set(rr, (c.get(rr)||0)+1);
    }
  }
  const rows = Array.from(c.entries()).map(([k,v])=>({ region:k, count:v }));
  rows.sort((a,b)=> (REGIONS_ORDER.indexOf(a.region)-REGIONS_ORDER.indexOf(b.region)) || (b.count-a.count));
  return rows;
}

function populateEntityPick(){
  const prev = el.entityPick.value;
  el.entityPick.innerHTML = "";
  const names = Array.from(state.indexes.byEntity.keys()).filter(Boolean);
  names.sort((a,b)=> a.localeCompare(b, "ko"));

  const op0 = document.createElement("option");
  op0.value = "";
  op0.textContent = "(선택)";
  el.entityPick.appendChild(op0);

  for (const n of names){
    const op = document.createElement("option");
    op.value = n;
    op.textContent = n;
    el.entityPick.appendChild(op);
  }
  el.entityPick.value = names.includes(prev) ? prev : "";
  el.entityStatus.textContent = state.records.length ? `기관 ${names.length}개` : "대기";
}

function populateRegionPick(){
  const prev = el.regionPick.value;
  el.regionPick.innerHTML = "";

  const regions = Array.from(state.indexes.byRegion.keys()).filter(Boolean);
  regions.sort((a,b)=> {
    const ia = REGIONS_ORDER.indexOf(a);
    const ib = REGIONS_ORDER.indexOf(b);
    if (ia>=0 && ib>=0) return ia-ib;
    if (ia>=0) return -1;
    if (ib>=0) return 1;
    return a.localeCompare(b,"ko");
  });

  const op0 = document.createElement("option");
  op0.value = "";
  op0.textContent = "(선택)";
  el.regionPick.appendChild(op0);

  for (const r of regions){
    const op = document.createElement("option");
    op.value = r;
    op.textContent = r;
    el.regionPick.appendChild(op);
  }
  el.regionPick.value = regions.includes(prev) ? prev : "";
  el.regionStatus.textContent = state.records.length ? `시군구 ${regions.length}개` : "대기";
}

function renderEntityView(){
  if (!state.records.length){
    el.outTbody.innerHTML = `<tr><td colspan="9" class="muted">대기</td></tr>`;
    el.inTbody.innerHTML = `<tr><td colspan="9" class="muted">대기</td></tr>`;
    el.unkTbody.innerHTML = `<tr><td colspan="8" class="muted">대기</td></tr>`;
    el.outCount.textContent = "0";
    el.inCount.textContent = "0";
    el.unkCount.textContent = "0";
    el.btnDlEntity.disabled = true;
    return;
  }

  const entity = el.entityPick.value;
  const viewMode = el.entityViewMode.value;
  const pt = el.personnelType.value;
  const kw = el.jobKeyword.value;
  const gg = el.govGradeFilter.value;

  let recs = state.records;

  // (선택된 기관 필터)
  if (entity){
    const ids = state.indexes.byEntity.get(entity) || [];
    recs = ids.map(i => state.records[i]);
  }else{
    // 기관 미선택 시, 키워드/인사구분만으로 표가 의미없으므로 빈 처리
    el.outTbody.innerHTML = `<tr><td colspan="9" class="muted">기관을 선택하세요.</td></tr>`;
    el.inTbody.innerHTML = `<tr><td colspan="9" class="muted">기관을 선택하세요.</td></tr>`;
    el.unkTbody.innerHTML = `<tr><td colspan="8" class="muted">기관을 선택하세요.</td></tr>`;
    el.outCount.textContent = "0";
    el.inCount.textContent = "0";
    el.unkCount.textContent = "0";
    el.btnDlEntity.disabled = true;
    el.entityStatus.textContent = "기관 미선택";
    return;
  }

  // (요구사항) filterByPersonnelAndJob에서 govGrade 조건 포함
  recs = filterByPersonnelAndJob(recs, pt, kw, gg);

  const parts = splitRecordsByEntity(recs, entity, viewMode);

  renderEntityTables(parts);

  // currentExport.title에 직급 조건 포함(요구사항)
  const titleBits = [
    "entity",
    entity,
    viewMode,
    pt,
    (pt==="지방공무원" ? `직급-${gg}` : null),
    kw ? `kw-${kw}` : null
  ].filter(Boolean).map(s => safeFileNamePart(s));
  state.currentExport.title = titleBits.join("_");
  state.currentExport.sheetName = "entity_view";
  state.currentExport.rows = buildExportRowsFromEntityParts(parts);

  el.btnDlEntity.disabled = false;
  el.entityStatus.textContent = `${entity} · ${pt}${pt==="지방공무원" && gg!=="전체" ? ` · ${gg}`:""} · ${recs.length}건(관련)`;
}

function renderEntityTables({out, inn, unk}){
  el.outCount.textContent = String(out.length);
  el.inCount.textContent = String(inn.length);
  el.unkCount.textContent = String(unk.length);

  el.outTbody.innerHTML = out.length ? out.map(r=>entityRowHtml(r, "out")).join("") : `<tr><td colspan="9" class="muted">0건</td></tr>`;
  el.inTbody.innerHTML  = inn.length ? inn.map(r=>entityRowHtml(r, "in")).join("") : `<tr><td colspan="9" class="muted">0건</td></tr>`;
  el.unkTbody.innerHTML = unk.length ? unk.map(r=>entityRowHtml(r, "unk")).join("") : `<tr><td colspan="8" class="muted">0건</td></tr>`;
}

function entityRowHtml(rec, mode){
  const pt = safeText(rec.personnelType);
  const grade = pt==="지방공무원" ? (rec.govGrade || "") : "";
  const src = `${safeText(rec.sourceFile)} / ${safeText(rec.sheetName)} #${rec.rowNumber}`;

  if (mode==="out"){
    return `<tr>
      <td><span class="chip">${escapeHtml(pt||"")}</span></td>
      <td class="mono">${escapeHtml(grade)}</td>
      <td><b>${escapeHtml(rec.name)}</b></td>
      <td>${escapeHtml(rec.fromOrgNorm||rec.fromOrg)}</td>
      <td>${escapeHtml(rec.fromRegion)}</td>
      <td>${escapeHtml(rec.toOrgNorm||rec.toOrg)}</td>
      <td>${escapeHtml(rec.toRegion)}</td>
      <td class="muted">${escapeHtml(rec.jobRaw)}<div class="mono muted">${escapeHtml(rec.newRank||rec.curRank)}</div></td>
      <td class="mono muted">${escapeHtml(src)}</td>
    </tr>`;
  }
  if (mode==="in"){
    return `<tr>
      <td><span class="chip">${escapeHtml(pt||"")}</span></td>
      <td class="mono">${escapeHtml(grade)}</td>
      <td><b>${escapeHtml(rec.name)}</b></td>
      <td>${escapeHtml(rec.toOrgNorm||rec.toOrg)}</td>
      <td>${escapeHtml(rec.toRegion)}</td>
      <td>${escapeHtml(rec.fromOrgNorm||rec.fromOrg)}</td>
      <td>${escapeHtml(rec.fromRegion)}</td>
      <td class="muted">${escapeHtml(rec.jobRaw)}<div class="mono muted">${escapeHtml(rec.newRank||rec.curRank)}</div></td>
      <td class="mono muted">${escapeHtml(src)}</td>
    </tr>`;
  }
  // unk
  return `<tr>
    <td><span class="chip">${escapeHtml(pt||"")}</span></td>
    <td class="mono">${escapeHtml(grade)}</td>
    <td><b>${escapeHtml(rec.name)}</b></td>
    <td>${escapeHtml(rec.orgAnyNorm||rec.orgAny||"")}</td>
    <td>${escapeHtml(rec.regionAny||"")}</td>
    <td class="muted">${escapeHtml(rec.jobRaw)}<div class="mono muted">${escapeHtml(rec.newRank||rec.curRank)}</div></td>
    <td class="muted">${escapeHtml(rec.remark||"")}</td>
    <td class="mono muted">${escapeHtml(src)}</td>
  </tr>`;
}

function renderRegionView(){
  if (!state.records.length){
    el.regionTbody.innerHTML = `<tr><td colspan="10" class="muted">대기</td></tr>`;
    el.regionCount.textContent = "0";
    el.btnDlRegion.disabled = true;
    return;
  }

  const region = el.regionPick.value;
  const officeMode = el.regionOfficeMode.value;
  const pt = el.regionPersonnelType.value;
  const gg = el.regionGovGradeFilter.value;
  const kw = el.regionKeyword.value;

  if (!region){
    el.regionTbody.innerHTML = `<tr><td colspan="10" class="muted">시군구를 선택하세요.</td></tr>`;
    el.regionCount.textContent = "0";
    el.btnDlRegion.disabled = true;
    el.regionStatus.textContent = "시군구 미선택";
    return;
  }

  let recs = (state.indexes.byRegion.get(region) || []).map(i=>state.records[i]);

  // officeMode 유지 + 직급 필터 AND 추가(요구사항)
  recs = recs.filter(rec => {
    if (officeMode === "from") return rec.fromRegion === region;
    if (officeMode === "to") return rec.toRegion === region;
    // related
    return rec.fromRegion === region || rec.toRegion === region || rec.regionAny === region;
  });

  // 인사구분 + 키워드 + (지방공무원 직급) 필터
  recs = filterByPersonnelAndJob(recs, pt, kw, gg);

  // render
  el.regionCount.textContent = String(recs.length);
  el.regionTbody.innerHTML = recs.length ? recs.map(regionRowHtml).join("") : `<tr><td colspan="10" class="muted">0건</td></tr>`;

  // currentExport.title에 직급 조건 포함(요구사항)
  const titleBits = [
    "region",
    region,
    officeMode,
    pt,
    (pt==="지방공무원" ? `직급-${gg}` : null),
    kw ? `kw-${kw}` : null
  ].filter(Boolean).map(s => safeFileNamePart(s));
  state.currentExport.title = titleBits.join("_");
  state.currentExport.sheetName = "region_view";
  state.currentExport.rows = buildExportRows(recs);

  el.btnDlRegion.disabled = false;
  el.regionStatus.textContent = `${region} · ${officeMode} · ${pt}${pt==="지방공무원" && gg!=="전체" ? ` · ${gg}`:""} · ${recs.length}건`;
}

function regionRowHtml(rec){
  const pt = safeText(rec.personnelType);
  const grade = pt==="지방공무원" ? (rec.govGrade || "") : "";
  const src = `${safeText(rec.sourceFile)} / ${safeText(rec.sheetName)} #${rec.rowNumber}`;
  return `<tr>
    <td><span class="chip">${escapeHtml(pt||"")}</span></td>
    <td class="mono">${escapeHtml(grade)}</td>
    <td><b>${escapeHtml(rec.name)}</b></td>
    <td>${escapeHtml(rec.fromOrgNorm||rec.fromOrg)}</td>
    <td>${escapeHtml(rec.fromRegion)}</td>
    <td>${escapeHtml(rec.toOrgNorm||rec.toOrg)}</td>
    <td>${escapeHtml(rec.toRegion)}</td>
    <td class="muted">${escapeHtml(rec.jobRaw)}<div class="mono muted">${escapeHtml(rec.newRank||rec.curRank)}</div></td>
    <td class="muted">${escapeHtml(rec.remark||"")}</td>
    <td class="mono muted">${escapeHtml(src)}</td>
  </tr>`;
}

/* ============================
   다운로드 (SheetJS)
   ============================ */
function safeFileNamePart(s){
  return safeText(s)
    .replace(/\s+/g,"")
    .replace(/[\\/:*?"<>|]/g,"-")
    .slice(0, 40);
}

function buildExportRows(recs){
  return recs.map(rec => ({
    personnelType: rec.personnelType || "",
    govGrade: rec.personnelType==="지방공무원" ? (rec.govGrade||"") : "",
    name: rec.name || "",
    fromOrg: rec.fromOrgNorm || rec.fromOrg || "",
    fromRegion: rec.fromRegion || "",
    toOrg: rec.toOrgNorm || rec.toOrg || "",
    toRegion: rec.toRegion || "",
    curRank: rec.curRank || "",
    newRank: rec.newRank || "",
    jobRaw: rec.jobRaw || "",
    remark: rec.remark || "",
    sourceFile: rec.sourceFile || "",
    sheetName: rec.sheetName || "",
    rowNumber: rec.rowNumber || "",
    quality: rec.q || 0,
  }));
}

function buildExportRowsFromEntityParts({out, inn, unk}){
  const tag = (arr, label) => arr.map(r => ({ view: label, ...buildExportRows([r])[0] }));
  return [
    ...tag(out, "전출"),
    ...tag(inn, "전입"),
    ...tag(unk, "미분류"),
  ];
}

function downloadAsXlsxOrCsv(baseName, rows, sheetName="data"){
  if (!window.XLSX){
    log("다운로드 실패: SheetJS가 준비되지 않았습니다.", "error");
    return;
  }
  const ts = new Date();
  const pad=n=>String(n).padStart(2,'0');
  const stamp = `${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}`;
  const fileBase = `${safeFileNamePart(baseName)}_${stamp}`;

  // XLSX
  try{
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName.slice(0, 31));
    const wbout = XLSX.write(wb, { bookType:"xlsx", type:"array" });
    const blob = new Blob([wbout], { type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    triggerDownload(blob, `${fileBase}.xlsx`);
    log(`다운로드 생성: ${fileBase}.xlsx (${rows.length}행)`);
  }catch(e){
    log("XLSX 생성 실패 → CSV로 대체", "warn");
    downloadCSV(fileBase, rows);
  }
}

function downloadCSV(fileBase, rows){
  const cols = rows.length ? Object.keys(rows[0]) : [];
  const esc = (v) => {
    const s = (v==null) ? "" : String(v);
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const lines = [];
  lines.push(cols.join(","));
  for (const r of rows){
    lines.push(cols.map(c=>esc(r[c])).join(","));
  }
  const blob = new Blob(["\uFEFF"+lines.join("\n")], { type:"text/csv;charset=utf-8" });
  triggerDownload(blob, `${fileBase}.csv`);
  log(`다운로드 생성: ${fileBase}.csv (${rows.length}행)`);
}

function triggerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    URL.revokeObjectURL(url);
    a.remove();
  }, 0);
}

/* ============================
   기타 유틸
   ============================ */
function escapeHtml(s){
  return safeText(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function resetAll(){
  state.files = [];
  state.fileKeySet.clear();
  state.rawRecords = [];
  state.records = [];
  state.dedupRemoved = 0;
  state.stats.mappedOrg = 0;
  state.stats.mappedOrgTotal = 0;
  state.indexes.byEntity.clear();
  state.indexes.byRegion.clear();
  state.currentExport = { title:"export", rows:[], sheetName:"data" };

  renderFileTable();
  renderSummary();
  refreshAllViews();
  updateButtons();

  el.entityPick.innerHTML = `<option value="">(데이터를 업로드하면 목록이 생성됩니다)</option>`;
  el.regionPick.innerHTML = `<option value="">(데이터 업로드 후 선택)</option>`;
  el.entityPick.disabled = true;
  el.personnelType.disabled = true;
  el.btnDlEntity.disabled = true;
  el.regionOfficeMode.disabled = true;
  el.regionPick.disabled = true;
  el.regionPersonnelType.disabled = true;
  el.regionGovGradeFilter.disabled = true;
  el.regionKeyword.disabled = true;
  el.btnDlRegion.disabled = true;

  el.dataStatus.textContent = "데이터 없음";
  el.dedupStatus.textContent = "dedup:0";
  setGlobalProgress(0, "대기");
  log("전체 초기화 완료");
}

function refreshAllViewsSoft(){
  renderSummary();
  renderEntityView();
  renderRegionView();
}

function wireDownloads(){
  el.btnDlEntity.addEventListener("click", ()=>{
    const { title, rows, sheetName } = state.currentExport;
    if (!rows?.length){
      log("다운로드할 데이터가 없습니다.", "warn");
      return;
    }
    downloadAsXlsxOrCsv(title, rows, sheetName);
  });

  el.btnDlRegion.addEventListener("click", ()=>{
    const { title, rows, sheetName } = state.currentExport;
    if (!rows?.length){
      log("다운로드할 데이터가 없습니다.", "warn");
      return;
    }
    downloadAsXlsxOrCsv(title, rows, sheetName);
  });
}

/* ============================
   앱 시작
   ============================ */
function init(){
  cacheDom();
  initClock();
  initDnd();
  initButtons();
  initEntityFilters();
  initRegionFilters();
  wireDownloads();

  renderFileTable();
  renderSummary();
  refreshAllViewsSoft();
  updateButtons();

  // 라이브러리 로드(사용자가 파싱 버튼 누르기 전에 미리 준비)
  loadSheetJS().then(ok=>{
    if (ok){
      updateButtons();
      log("준비 완료: 파일을 업로드한 뒤 ‘선택 파일 파싱’을 눌러주세요.");
    }
  });

  // 엔티티/리전 필터: 지방공무원 아닐 때 직급 필터 disabled 유지 로직 보강
  el.personnelType.addEventListener("change", refreshAllViewsSoft);
  el.regionPersonnelType.addEventListener("change", refreshAllViewsSoft);
}

document.addEventListener("DOMContentLoaded", init);
</script><!-- 유지 필수 스크립트 --><script src="/static/disable-copy.js"></script><script src="/static/footer.js"></script><script src="/static/global-loader.js?v=1"></script></body>
</html>
