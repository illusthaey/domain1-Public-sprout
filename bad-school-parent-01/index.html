<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>에듀파인 미수납 → 미납안내문/문자 생성기</title>

  <!-- (선택) 한글 폰트 로드: 막히면 시스템 폰트로 자동 대체 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS (XLSX 파싱) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- JSZip (PNG 여러장 ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- jsPDF (여러장 PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    /* ====== 파스텔 블루 테마 ====== */
    :root{
      --bg: #EAF6FF;
      --card: #FFFFFF;
      --border: #B8D9F2;
      --text: #0F172A;
      --muted: #475569;
      --accent: #4AA3FF;
      --accent-2: #2D8CFF;
      --soft: #D9EEFF;       /* 라벨/헤더 셀 배경(안내문) */
      --soft-2: #F2FAFF;     /* 입력 배경 */
      --danger: #EF4444;
      --ok: #10B981;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "맑은 고딕", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      word-break: keep-all;
    }

    a{ color: inherit; text-decoration: none; }

    .shell{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    header{
      background: linear-gradient(180deg, #FFFFFF 0%, rgba(255,255,255,0.75) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 16px;
      box-shadow: 0 6px 24px rgba(15, 23, 42, 0.06);
    }

    h1{
      margin: 0 0 6px;
      font-size: 1.55rem;
      font-weight: 800;
      letter-spacing: -0.2px;
    }
    .sub{
      margin: 0;
      color: var(--muted);
      font-size: 0.98rem;
    }

    .grid{
      display: grid;
      gap: 14px;
      margin-top: 14px;
    }
    @media (min-width: 980px){
      .grid.two{
        grid-template-columns: 1.05fr 0.95fr;
        align-items: start;
      }
    }

    .section{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 14px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
    }
    .section h2{
      margin: 0 0 10px;
      font-size: 1.15rem;
      font-weight: 800;
    }

    details{
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      margin-top: 10px;
    }
    summary{
      cursor: pointer;
      font-weight: 800;
      color: #0b3a68;
    }
    .muted{ color: var(--muted); }

    label{
      display:block;
      font-weight: 700;
      font-size: 0.95rem;
      margin: 10px 0 6px;
    }

    input[type="text"], input[type="date"], textarea, select{
      width: 100%;
      border: 1px solid #cfe6f8;
      background: var(--soft-2);
      border-radius: 14px;
      padding: 10px 12px;
      outline: none;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.02);
      font: inherit;
    }
    input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus{
      background: #fff;
      border-color: #8ec7f2;
      box-shadow: 0 0 0 3px rgba(74, 163, 255, 0.18);
    }
    textarea{ min-height: 170px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .row > * { flex: 1 1 180px; }

    .btnbar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    button{
      font: inherit;
      cursor: pointer;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 10px 14px;
      font-weight: 800;
      background: #fff;
    }
    button:hover{ background:#f8fbff; }
    button.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    button.primary:hover{ background: var(--accent-2); border-color: var(--accent-2); }
    button.ghost{
      border-color: #cfe6f8;
      background: #f7fbff;
      color: #0b3a68;
    }
    button.danger{
      background: #fff5f5;
      border-color: #fecaca;
      color: #991b1b;
      font-weight: 900;
    }

    .status{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #cfe6f8;
      background: #f8fbff;
      color: var(--muted);
      font-size: 0.95rem;
      white-space: pre-line;
    }
    .status.ok{ border-color: #bbf7d0; background: #f0fdf4; color:#065f46; }
    .status.err{ border-color: #fecaca; background: #fff1f2; color:#9f1239; }

    .tablewrap{
      overflow:auto;
      border: 1px solid #cfe6f8;
      border-radius: 14px;
      background: #fff;
    }
    table{
      border-collapse: collapse;
      width: 100%;
      min-width: 820px;
      font-size: 0.95rem;
    }
    th, td{
      border: 1px solid #e6f2fb;
      padding: 8px 10px;
      vertical-align: top;
    }
    th{
      background: #f3faff;
      text-align:left;
      font-weight: 900;
      color: #0b3a68;
    }
    td.num{ text-align: right; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #cfe6f8;
      background: #f3faff;
      color: #0b3a68;
      font-size: 0.85rem;
      font-weight: 800;
      margin-left: 6px;
    }

    .preview{
      display:grid;
      gap: 12px;
    }
    @media (min-width: 980px){
      .preview.two{
        grid-template-columns: 1fr 1fr;
        align-items: start;
      }
    }
    .canvasbox{
      border: 1px solid #cfe6f8;
      border-radius: 16px;
      background: #fff;
      padding: 10px;
    }
    canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 12px;
      background: #fff;
    }

    .hint{
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .small{
      font-size: 0.9rem;
      color: var(--muted);
    }
    .footer{
      margin-top: 18px;
      color: #64748b;
      text-align: center;
      font-size: 0.9rem;
    }
    code.k{
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      border-radius: 10px;
      padding: 2px 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.92em;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>에듀파인 미수납대상(.xlsx) → 미납 안내 문자 + 미납안내문(PNG/PDF)</h1>
      <p class="sub">
        엑셀에서 <b>학년/반/이름/납입금명/미납액</b>만 추출합니다.
        <span class="pill">추출 제외 정리: 주간 · 야간 · _ · -</span>
      </p>

      <details open>
        <summary>안내(접기/펼치기)</summary>
        <div class="small" style="margin-top:8px">
          <ul style="margin:8px 0 0; padding-left: 18px;">
            <li>업로드 즉시 분석합니다. 헤더는 샘플 기준 <code class="k">주야_계열_학년</code>, <code class="k">학과_반</code>, <code class="k">이름</code>, <code class="k">납입금명</code>, <code class="k">미납액</code>을 우선 탐색합니다.</li>
            <li>보호자연락처/학적구분/수납방법/미납일수/납입기한/결재상태 등은 <b>무시</b>합니다(표시/다운로드/문구 생성에 사용하지 않음).</li>
            <li>‘미납안내문’은 캔버스로 그려서 PNG로 만들고, 원하면 여러 장을 PDF로도 묶습니다.</li>
          </ul>
        </div>
      </details>
    </header>

    <div class="grid two">
      <!-- 좌측: 파일/결과 -->
      <div class="section">
        <h2>1) 엑셀 업로드</h2>
        <label>에듀파인 엑셀(.xlsx)</label>
        <input id="excelFile" type="file" accept=".xlsx,.xls" />

        <div class="status" id="statusBox">대기중… 엑셀을 올리면 자동으로 추출합니다.</div>

        <hr style="border:none;border-top:1px solid #e6f2fb;margin:14px 0;">

        <h2>2) 추출 결과 (행 단위)</h2>
        <p class="small" style="margin:0 0 10px;">
          아래 표는 <b>학년/반/이름/납입금명/미납액</b>만 보여줍니다.
        </p>
        <div class="tablewrap" id="rawTableWrap">
          <table>
            <thead>
              <tr>
                <th>학년</th>
                <th>반</th>
                <th>이름</th>
                <th>납입금명</th>
                <th style="text-align:right;">미납액</th>
              </tr>
            </thead>
            <tbody id="rawTbody">
              <tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>
            </tbody>
          </table>
        </div>

        <hr style="border:none;border-top:1px solid #e6f2fb;margin:14px 0;">

        <h2>3) 학생별 통합(문자/안내문 생성 단위)</h2>
        <div class="tablewrap" id="caseTableWrap">
          <table>
            <thead>
              <tr>
                <th>학년</th>
                <th>반</th>
                <th>이름</th>
                <th>납입금명(요약)</th>
                <th style="text-align:right;">총 미납액</th>
              </tr>
            </thead>
            <tbody id="caseTbody">
              <tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 우측: 설정/미리보기/다운로드 -->
      <div class="section">
        <h2>설정</h2>

        <div class="row">
          <div>
            <label>학교명</label>
            <input id="schoolName" type="text" placeholder="예) 문막초등학교" value="" />
          </div>
          <div>
            <label>은행명</label>
            <input id="bankName" type="text" placeholder="예) 농협" value="" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>계좌번호</label>
            <input id="accountNumber" type="text" placeholder="예) 000-0000-0000-00" value="" />
          </div>
          <div>
            <label>차수(문자용) — 엑셀에서 추출하지 않음</label>
            <input id="roundText" type="text" placeholder="예) 2025년 2학기" value="" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>안내문 비고(표시용, 선택)</label>
            <input id="noticeRemark" type="text" placeholder="예) 2025년 2학기" value="" />
            <div class="hint">안내문 표의 ‘비고’ 칸에 표시됩니다. (엑셀에서 추출하지 않음)</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>납부 기한(안내문 문구용)</label>
            <input id="dueDate" type="date" />
          </div>
          <div>
            <label>안내문 작성일(하단 날짜)</label>
            <input id="docDate" type="date" />
          </div>
        </div>

        <label>문자 템플릿 (대괄호 치환)</label>
        <textarea id="smsTemplate"></textarea>
        <div class="hint">
          치환: <code class="k">[학교명]</code> <code class="k">[학년]</code> <code class="k">[반]</code>
          <code class="k">[이름]</code> <code class="k">[차수]</code> <code class="k">[납입금명]</code>
          <code class="k">[은행명]</code> <code class="k">[계좌번호]</code> <code class="k">[미납액]</code><br/>
          ※ 요청대로 <b>번호는 엑셀에서 추출/사용하지 않습니다.</b> 템플릿에 <code class="k">[번호]</code>가 있으면 빈칸 처리됩니다.
        </div>

        <div class="btnbar">
          <button class="ghost" id="btnReset">초기화</button>
          <button class="primary" id="btnDownloadCSV" disabled>문자/명단 CSV 다운로드</button>
          <button class="primary" id="btnDownloadZip" disabled>안내문 PNG ZIP 다운로드</button>
          <button class="primary" id="btnDownloadPDF" disabled>안내문 PDF 다운로드</button>
        </div>

        <hr style="border:none;border-top:1px solid #e6f2fb;margin:14px 0;">

        <h2>미리보기</h2>
        <label>학생 선택</label>
        <select id="caseSelect" disabled>
          <option value="">먼저 엑셀을 업로드하세요</option>
        </select>

        <div class="preview two" style="margin-top:12px;">
          <div>
            <div class="canvasbox">
              <canvas id="previewCanvas" width="1080" height="1350"></canvas>
              <div class="hint">안내문 미리보기(파스텔 블루 라벨). 다운로드 시 같은 내용으로 생성됩니다.</div>
              <div class="btnbar">
                <button class="ghost" id="btnOnePng" disabled>선택 학생 안내문 PNG 1장 다운로드</button>
                <button class="ghost" id="btnCopySms" disabled>선택 학생 문자 문구 복사</button>
              </div>
            </div>
          </div>

          <div>
            <label>선택 학생 문자 문구</label>
            <textarea id="smsPreview" readonly style="min-height: 300px;"></textarea>
            <div class="hint">복사 버튼으로 클립보드에 바로 복사됩니다.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      ※ 브라우저에서만 동작하는 정적 페이지입니다(서버 업로드 불필요). 엑셀은 로컬에서만 읽습니다.
    </div>
  </div>

  <script>
    /***********************
     * 0) 기본 템플릿 세팅
     ***********************/
    const DEFAULT_SMS_TEMPLATE =
`안녕하세요,
[학교명] 행정실입니다.

[학년] [반] [번호] [이름] 학생 [차수] [납입금명] 미납 금액 이체 안내드립니다.

이체하실 계좌: [은행명] [계좌번호] [학교명]
이체하실 금액: [미납액]

원활한 업무처리를 위하여 반드시 학생 이름으로 이체 부탁드립니다.

감사합니다.`;

    const el = (id) => document.getElementById(id);

    el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;

    // 날짜 기본값: 작성일=오늘
    (function initDates(){
      const now = new Date();
      const iso = toISODate(now);
      el("docDate").value = iso;
    })();

    /***********************
     * 1) 전역 상태
     ***********************/
    let rawRows = [];   // 행 단위(추출 5개 컬럼만)
    let cases = [];     // 학생별 통합
    let selectedCaseKey = "";

    /***********************
     * 2) 유틸
     ***********************/
    function setStatus(msg, kind=""){
      const box = el("statusBox");
      box.className = "status" + (kind ? " " + kind : "");
      box.textContent = msg;
    }

    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function parseDateInput(value){
      if(!value) return null;
      const [y,m,d] = value.split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }

    function fmtKoreanDate(d, pad=false){
      if(!d) return "";
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      const day = d.getDate();
      if(pad){
        return `${y}년 ${String(m).padStart(2,"0")}월 ${String(day).padStart(2,"0")}일`;
      }
      return `${y}년 ${m}월 ${day}일`;
    }

    // 파일명 안전화
    function safeFilename(s){
      return String(s || "").replace(/[\/\\?%*:|"<>]/g, "_").replace(/\s+/g, " ").trim();
    }

    // CSV 셀 이스케이프
    function csvEscape(value){
      const s = String(value ?? "");
      if(/[",\n]/.test(s)){
        return `"${s.replace(/"/g,'""')}"`;
      }
      return s;
    }

    // 학년/반 문자열 정리: "주간", "야간", "_", "-" 제거
    function cleanSchoolToken(s){
      return String(s ?? "")
        .replace(/주간/g, "")
        .replace(/야간/g, "")
        .replace(/[_-]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function toIntMoney(v){
      if(v === null || v === undefined || v === "") return 0;
      const n = Number(v);
      if(Number.isFinite(n)) return Math.round(n);
      // 문자열 금액(콤마)
      const s = String(v).replace(/,/g,"").trim();
      const nn = Number(s);
      return Number.isFinite(nn) ? Math.round(nn) : 0;
    }

    // 한글 숫자(“일만오천칠백일십”) 생성 — 샘플 양식처럼 1도 “일십/일백/일천” 형태로 표시
    const DIG_KOR = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];
    function fourToKor(n){
      const s = String(n).padStart(4,"0");
      const units = ["천","백","십",""];
      let out = "";
      for(let i=0;i<4;i++){
        const d = Number(s[i]);
        if(d === 0) continue;
        out += DIG_KOR[d] + units[i];
      }
      return out;
    }
    function numberToKor(n){
      n = Math.floor(Math.abs(Number(n) || 0));
      if(n === 0) return "영";
      const big = ["", "만", "억", "조", "경"];
      let idx = 0;
      let out = "";
      while(n > 0){
        const part = n % 10000;
        if(part > 0){
          out = fourToKor(part) + big[idx] + out;
        }
        n = Math.floor(n/10000);
        idx++;
      }
      return out;
    }

    function normalizeSpacesPerLine(text){
      return String(text ?? "")
        .split("\n")
        .map(line => line.replace(/[ \t]+/g, " ").replace(/\s+$/g,""))
        .join("\n")
        .trim();
    }

    /***********************
     * 3) XLSX 파싱 (필요 5개만)
     ***********************/
    function normalizeHeader(h){
      return String(h ?? "")
        .trim()
        .replace(/\s+/g,"")
        .replace(/[_-]/g,"_"); // 비교 편의
    }

    function findHeaderRow(rows){
      // 상단 20행 내에서 "이름"+"납입금명"+"미납액"이 함께 있는 행을 헤더로 판단
      const limit = Math.min(rows.length, 20);
      for(let i=0;i<limit;i++){
        const row = (rows[i] || []).map(normalizeHeader);
        const hasName = row.some(x => x.includes("이름"));
        const hasItem = row.some(x => x.includes("납입금명"));
        const hasAmt  = row.some(x => x.includes("미납액"));
        if(hasName && hasItem && hasAmt) return i;
      }
      return 0;
    }

    function pickIndex(headers, patterns){
      // patterns: 정규식 배열. 먼저 매칭되는 인덱스를 반환
      for(const re of patterns){
        const idx = headers.findIndex(h => re.test(h));
        if(idx !== -1) return idx;
      }
      return -1;
    }

    function parseXlsx(arrayBuffer){
      const wb = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

      if(!rows || rows.length === 0){
        throw new Error("시트에 데이터가 없습니다.");
      }

      const headerRowIdx = findHeaderRow(rows);
      const header = (rows[headerRowIdx] || []).map(normalizeHeader);

      // 샘플 기준 우선 탐색:
      // 주야_계열_학년, 학과_반, 이름, 납입금명, 미납액
      const idxGrade = pickIndex(header, [
        /주야.*학년/i, /계열.*학년/i, /^주야_계열_학년$/i, /학년/
      ]);
      const idxClass = pickIndex(header, [
        /^학과_반$/i, /학과.*반/i, /^반$/i, /반/
      ]);
      const idxName  = pickIndex(header, [
        /^이름$/i, /성명/i
      ]);
      const idxItem  = pickIndex(header, [
        /^납입금명$/i, /납입.*명/i
      ]);
      const idxAmt   = pickIndex(header, [
        /^미납액$/i, /미납.*금/i
      ]);

      if([idxGrade, idxClass, idxName, idxItem, idxAmt].some(x => x === -1)){
        throw new Error(
          "필수 컬럼을 찾지 못했습니다.\n" +
          "필요: 주야_계열_학년(또는 학년), 학과_반(또는 반), 이름, 납입금명, 미납액"
        );
      }

      const out = [];
      for(let r=headerRowIdx+1; r<rows.length; r++){
        const row = rows[r] || [];
        const gradeRaw = row[idxGrade];
        const classRaw = row[idxClass];
        const nameRaw  = row[idxName];
        const itemRaw  = row[idxItem];
        const amtRaw   = row[idxAmt];

        const grade = cleanSchoolToken(gradeRaw);
        const cls   = cleanSchoolToken(classRaw);
        const name  = String(nameRaw ?? "").trim();
        const item  = String(itemRaw ?? "").trim();
        const amt   = toIntMoney(amtRaw);

        // 완전 빈행 스킵
        if(!grade && !cls && !name && !item && !amt) continue;

        // 최소 요건(이름/납입금명/미납액) 없으면 스킵
        if(!name || !item) continue;

        out.push({
          학년: grade,
          반: cls,
          이름: name,
          납입금명: item,
          미납액: amt
        });
      }

      return out;
    }

    /***********************
     * 4) 학생별 통합(문자/안내문 단위)
     ***********************/
    function buildCasesFromRaw(rows){
      const map = new Map();
      for(const rr of rows){
        const key = `${rr.학년}||${rr.반}||${rr.이름}`;
        if(!map.has(key)){
          map.set(key, {
            key,
            학년: rr.학년,
            반: rr.반,
            이름: rr.이름,
            items: [],
            total: 0
          });
        }
        const c = map.get(key);
        c.items.push({ 납입금명: rr.납입금명, 미납액: rr.미납액 });
        c.total += rr.미납액;
      }

      const list = Array.from(map.values());

      // 납입금명 요약(중복 제거)
      for(const c of list){
        const uniq = [];
        const seen = new Set();
        for(const it of c.items){
          const nm = it.납입금명;
          if(!seen.has(nm)){
            seen.add(nm);
            uniq.push(nm);
          }
        }
        c.납입금명요약 = uniq.join(", ");
      }

      // 정렬: 학년/반/이름
      list.sort((a,b) => {
        const ag = a.학년 || "";
        const bg = b.학년 || "";
        if(ag !== bg) return ag.localeCompare(bg, "ko");
        const ac = a.반 || "";
        const bc = b.반 || "";
        if(ac !== bc) return ac.localeCompare(bc, "ko");
        return (a.이름 || "").localeCompare((b.이름 || ""), "ko");
      });

      return list;
    }

    /***********************
     * 5) 문자 생성
     ***********************/
    function buildSmsForCase(c){
      const schoolName = el("schoolName").value.trim();
      const bankName   = el("bankName").value.trim();
      const accountNum = el("accountNumber").value.trim();
      const roundText  = el("roundText").value.trim(); // [차수]
      const template   = el("smsTemplate").value;

      const repl = {
        "[학교명]": schoolName,
        "[학년]": c.학년,
        "[반]": c.반,
        "[이름]": c.이름,
        "[차수]": roundText,
        "[납입금명]": c.납입금명요약,
        "[은행명]": bankName,
        "[계좌번호]": accountNum,
        "[미납액]": c.total.toLocaleString("ko-KR"),
        // 요청: 번호는 추출하지 않음 → 빈칸 처리
        "[번호]": ""
      };

      let msg = String(template ?? "");
      for(const k of Object.keys(repl)){
        msg = msg.split(k).join(repl[k] ?? "");
      }

      // 남은 [무언가] 토큰은 그대로 두되, 줄/공백 정리
      msg = normalizeSpacesPerLine(msg);

      return msg;
    }

    /***********************
     * 6) 안내문 렌더링(캔버스 → PNG/PDF)
     *    - 업로드된 샘플 ‘미납안내문’ 구조를 캔버스로 재현
     ***********************/
    function renderNoticeToCanvas(c, canvas, opts={}){
      const W = opts.width || canvas.width || 1080;
      const H = opts.height || canvas.height || 1350;

      canvas.width = W;
      canvas.height = H;

      const ctx = canvas.getContext("2d");
      const fontFamily = `"Noto Sans KR","맑은 고딕",system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo",sans-serif`;

      // 설정
      const schoolName = el("schoolName").value.trim();
      const remarkText = el("noticeRemark").value.trim();
      const dueDate = parseDateInput(el("dueDate").value);
      const docDate = parseDateInput(el("docDate").value) || new Date();

      const principalTitle = schoolName ? (schoolName + "장") : "학교장";

      // 색상(파스텔 블루)
      const labelBg = getComputedStyle(document.documentElement).getPropertyValue("--soft").trim() || "#D9EEFF";
      const stroke = "#111";

      // 기본 배경
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,H);

      const m = Math.round(W * 0.055); // 1080 기준 60
      const x0 = m, y0 = m;
      const bw = W - 2*m;
      const bh = H - 2*m;

      // 외곽 테두리
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 2;
      ctx.strokeRect(x0, y0, bw, bh);

      let y = y0 + Math.round(H * 0.06);

      // 제목
      ctx.fillStyle = "#111";
      ctx.textAlign = "center";
      ctx.textBaseline = "alphabetic";
      ctx.font = `700 ${Math.round(W*0.05)}px ${fontFamily}`; // 1080 기준 54
      ctx.fillText("미 납 안 내 문", W/2, y);

      // 제목 밑줄
      y += Math.round(H*0.018);
      ctx.beginPath();
      ctx.lineWidth = 2;
      const ulw = Math.round(bw * 0.36);
      ctx.moveTo(W/2 - ulw/2, y);
      ctx.lineTo(W/2 + ulw/2, y);
      ctx.stroke();

      y += Math.round(H*0.03);

      // 상단 2행 테이블(학번/이름)
      const rowH = Math.round(H * 0.06);   // 1080x1350 기준 ~81
      const labelW = Math.round(bw * 0.28);

      function cell(x, y, w, h, fill){
        if(fill){
          ctx.fillStyle = fill;
          ctx.fillRect(x,y,w,h);
        }
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 1.5;
        ctx.strokeRect(x,y,w,h);
      }

      // "학   번" / "이   름"
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#111";
      ctx.font = `700 ${Math.round(W*0.028)}px ${fontFamily}`; // ~30

      // 1행
      cell(x0, y, labelW, rowH, labelBg);
      cell(x0+labelW, y, bw-labelW, rowH, "#fff");
      ctx.fillStyle="#111";
      ctx.fillText("학   번", x0 + labelW/2, y + rowH/2);

      // 값(학년 반) — 번호는 추출하지 않음
      ctx.textAlign = "left";
      ctx.font = `600 ${Math.round(W*0.027)}px ${fontFamily}`;
      ctx.fillText(`${c.학년} ${c.반}`.trim(), x0 + labelW + 16, y + rowH/2);

      // 2행
      y += rowH;
      ctx.textAlign = "center";
      ctx.font = `700 ${Math.round(W*0.028)}px ${fontFamily}`;
      cell(x0, y, labelW, rowH, labelBg);
      cell(x0+labelW, y, bw-labelW, rowH, "#fff");
      ctx.fillStyle="#111";
      ctx.fillText("이   름", x0 + labelW/2, y + rowH/2);

      ctx.textAlign="left";
      ctx.font = `600 ${Math.round(W*0.027)}px ${fontFamily}`;
      ctx.fillText(String(c.이름 || ""), x0 + labelW + 16, y + rowH/2);

      y += rowH;

      // "일금 ... 원정" 행
      const moneyRowH = Math.round(H*0.055);
      cell(x0, y, bw, moneyRowH, "#fff");
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.font = `600 ${Math.round(W*0.026)}px ${fontFamily}`;
      const korMoney = numberToKor(c.total);
      ctx.fillStyle="#111";
      ctx.fillText(`일금 ${korMoney} 원정`, x0 + bw/2, y + moneyRowH/2);

      y += moneyRowH;

      // 큰 표(구분/금액/비고)
      const headH = Math.round(H*0.055);
      const itemH = Math.round(H*0.047);
      const blankRows = 10;
      const sumH = Math.round(H*0.055);

      const col1 = Math.round(bw*0.42);
      const col2 = Math.round(bw*0.28);
      const col3 = bw - col1 - col2;

      // 헤더행
      cell(x0, y, col1, headH, labelBg);
      cell(x0+col1, y, col2, headH, labelBg);
      cell(x0+col1+col2, y, col3, headH, labelBg);

      ctx.fillStyle="#111";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.font = `700 ${Math.round(W*0.026)}px ${fontFamily}`;
      ctx.fillText("구   분", x0 + col1/2, y + headH/2);
      ctx.fillText("금   액", x0 + col1 + col2/2, y + headH/2);
      ctx.fillText("비   고", x0 + col1 + col2 + col3/2, y + headH/2);

      y += headH;

      // 항목 행(고정 10행)
      ctx.font = `600 ${Math.round(W*0.024)}px ${fontFamily}`;
      for(let i=0;i<blankRows;i++){
        cell(x0, y, col1, itemH, "#fff");
        cell(x0+col1, y, col2, itemH, "#fff");
        cell(x0+col1+col2, y, col3, itemH, "#fff");

        const it = c.items[i];
        if(it){
          // 구분
          ctx.fillStyle="#111";
          ctx.textAlign="left";
          ctx.textBaseline="middle";
          wrapText(ctx, String(it.납입금명 || ""), x0 + 12, y + itemH/2, col1 - 24, Math.round(itemH*0.72));

          // 금액
          ctx.textAlign="right";
          ctx.fillText((it.미납액 || 0).toLocaleString("ko-KR"), x0 + col1 + col2 - 12, y + itemH/2);

          // 비고(선택)
          ctx.textAlign="left";
          if(remarkText){
            wrapText(ctx, remarkText, x0 + col1 + col2 + 12, y + itemH/2, col3 - 24, Math.round(itemH*0.72));
          }
        }
        y += itemH;
      }

      // 합계행
      cell(x0, y, col1, sumH, "#fff");
      cell(x0+col1, y, col2, sumH, "#fff");
      cell(x0+col1+col2, y, col3, sumH, "#fff");

      ctx.fillStyle="#111";
      ctx.textBaseline="middle";
      ctx.font = `700 ${Math.round(W*0.026)}px ${fontFamily}`;
      ctx.textAlign="left";
      ctx.fillText("합   계", x0 + 12, y + sumH/2);

      ctx.textAlign="right";
      ctx.fillText(c.total.toLocaleString("ko-KR"), x0 + col1 + col2 - 12, y + sumH/2);

      y += sumH;

      // 안내문 하단 문구
      const noteY = y + Math.round(H*0.02);
      ctx.font = `600 ${Math.round(W*0.022)}px ${fontFamily}`;
      ctx.textAlign="left";
      ctx.textBaseline="alphabetic";

      ctx.fillText("※ 위의 금액이 미납되어 있습니다.", x0 + 10, noteY);

      const dueLine = dueDate
        ? `${fmtKoreanDate(dueDate, false)} 까지 금액을 납부하여 주십시오.`
        : "납부 기한을 입력하면 여기에 표시됩니다.";

      ctx.fillText(dueLine, x0 + 10, noteY + Math.round(H*0.03));

      // 최하단 날짜/학교장
      const bottomDate = fmtKoreanDate(docDate, true);
      ctx.textAlign="center";
      ctx.font = `600 ${Math.round(W*0.024)}px ${fontFamily}`;
      ctx.fillText(bottomDate, x0 + bw/2, y0 + bh - Math.round(H*0.11));

      ctx.font = `700 ${Math.round(W*0.03)}px ${fontFamily}`;
      ctx.fillText(principalTitle, x0 + bw/2, y0 + bh - Math.round(H*0.07));

      ctx.restore();
      return canvas;
    }

    // 간단한 줄바꿈(캔버스)
    function wrapText(ctx, text, x, yMid, maxWidth, lineHeight){
      const t = String(text ?? "").trim();
      if(!t) return;

      // 1줄로 되면 그냥 출력
      if(ctx.measureText(t).width <= maxWidth){
        ctx.fillText(t, x, yMid);
        return;
      }

      // 단어 단위 분리(한글은 공백이 없을 수 있으니 문자 단위 fallback)
      const tokens = t.includes(" ") ? t.split(" ") : Array.from(t);
      const lines = [];
      let cur = "";

      for(const tok of tokens){
        const probe = cur ? (cur + (t.includes(" ") ? " " : "") + tok) : tok;
        if(ctx.measureText(probe).width <= maxWidth){
          cur = probe;
        }else{
          if(cur) lines.push(cur);
          cur = tok;
        }
      }
      if(cur) lines.push(cur);

      // 최대 2줄까지만(표 셀 높이 한계)
      const maxLines = 2;
      const outLines = lines.slice(0, maxLines);

      const totalH = outLines.length * lineHeight;
      let y = yMid - totalH/2 + lineHeight/2;
      for(const ln of outLines){
        ctx.fillText(ln, x, y);
        y += lineHeight;
      }
    }

    function canvasToBlob(canvas, type="image/png", quality){
      return new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), type, quality);
      });
    }

    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function downloadText(text, filename, mime="text/plain;charset=utf-8"){
      const blob = new Blob([text], { type: mime });
      downloadBlob(blob, filename);
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    /***********************
     * 7) UI 렌더(표/셀렉트/미리보기)
     ***********************/
    function renderRawTable(){
      const tbody = el("rawTbody");
      tbody.innerHTML = "";

      if(!rawRows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }

      for(const r of rawRows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.학년)}</td>
          <td>${escapeHtml(r.반)}</td>
          <td>${escapeHtml(r.이름)}</td>
          <td>${escapeHtml(r.납입금명)}</td>
          <td class="num">${(r.미납액||0).toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderCaseTable(){
      const tbody = el("caseTbody");
      tbody.innerHTML = "";

      if(!cases.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }

      for(const c of cases){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(c.학년)}</td>
          <td>${escapeHtml(c.반)}</td>
          <td>${escapeHtml(c.이름)}</td>
          <td>${escapeHtml(c.납입금명요약)}</td>
          <td class="num">${c.total.toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function populateCaseSelect(){
      const sel = el("caseSelect");
      sel.innerHTML = "";

      if(!cases.length){
        sel.disabled = true;
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "먼저 엑셀을 업로드하세요";
        sel.appendChild(opt);
        return;
      }

      sel.disabled = false;
      for(const c of cases){
        const opt = document.createElement("option");
        opt.value = c.key;
        opt.textContent = `${c.학년} ${c.반} ${c.이름} (${c.total.toLocaleString("ko-KR")}원)`;
        sel.appendChild(opt);
      }

      selectedCaseKey = cases[0].key;
      sel.value = selectedCaseKey;
    }

    function getSelectedCase(){
      return cases.find(x => x.key === selectedCaseKey) || null;
    }

    function updatePreview(){
      const c = getSelectedCase();
      const canvas = el("previewCanvas");

      if(!c){
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);
        el("smsPreview").value = "";
        el("btnOnePng").disabled = true;
        el("btnCopySms").disabled = true;
        return;
      }

      renderNoticeToCanvas(c, canvas, { width: 1080, height: 1350 });
      el("smsPreview").value = buildSmsForCase(c);
      el("btnOnePng").disabled = false;
      el("btnCopySms").disabled = false;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function enableDownloads(enable){
      el("btnDownloadCSV").disabled = !enable;
      el("btnDownloadZip").disabled = !enable;
      el("btnDownloadPDF").disabled = !enable;
    }

    /***********************
     * 8) 다운로드 기능
     ***********************/
    function downloadCSV(){
      // BOM 포함(엑셀 호환)
      // ※ 요청한 “추출 5개” + 생성된 문자 문구까지 포함한 CSV 제공
      const lines = [];
      lines.push(["학년","반","이름","납입금명(요약)","총미납액","문자문구"].map(csvEscape).join(","));
      for(const c of cases){
        const row = [
          c.학년,
          c.반,
          c.이름,
          c.납입금명요약,
          c.total,
          buildSmsForCase(c)
        ];
        lines.push(row.map(csvEscape).join(","));
      }
      const text = "\ufeff" + lines.join("\n");
      const d = parseDateInput(el("docDate").value) || new Date();
      downloadText(text, `미납문자_명단_${toISODate(d)}.csv`, "text/csv;charset=utf-8");
    }

    async function downloadZipPng(){
      const zip = new JSZip();
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      const tempCanvas = document.createElement("canvas");

      setStatus(`안내문 PNG 생성중… (0/${cases.length})`, "");
      for(let i=0;i<cases.length;i++){
        const c = cases[i];
        renderNoticeToCanvas(c, tempCanvas, { width: 1080, height: 1350 });
        const blob = await canvasToBlob(tempCanvas, "image/png");

        const fname = safeFilename(`${dateISO}_${c.학년}${c.반}_${c.이름}_미납안내문.png`);
        zip.file(fname, blob);

        setStatus(`안내문 PNG 생성중… (${i+1}/${cases.length})`, "");
        await sleep(0);
      }

      const zipBlob = await zip.generateAsync({ type: "blob" });
      downloadBlob(zipBlob, `미납안내문_PNG_${dateISO}.zip`);
      setStatus("PNG ZIP 다운로드 준비 완료 ✅", "ok");
    }

    async function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      const tempCanvas = document.createElement("canvas");
      renderNoticeToCanvas(cases[0], tempCanvas, { width: 1080, height: 1350 });

      const W = tempCanvas.width;
      const H = tempCanvas.height;

      const doc = new jsPDF({ orientation: "portrait", unit: "px", format: [W, H] });

      setStatus(`안내문 PDF 생성중… (0/${cases.length})`, "");
      for(let i=0;i<cases.length;i++){
        const c = cases[i];
        renderNoticeToCanvas(c, tempCanvas, { width: 1080, height: 1350 });

        // 용량 고려: JPEG로 넣기(가독성 유지)
        const imgData = tempCanvas.toDataURL("image/jpeg", 0.92);

        if(i > 0) doc.addPage([W, H], "portrait");
        doc.addImage(imgData, "JPEG", 0, 0, W, H);

        setStatus(`안내문 PDF 생성중… (${i+1}/${cases.length})`, "");
        await sleep(0);
      }

      doc.save(`미납안내문_${dateISO}.pdf`);
      setStatus("PDF 다운로드 준비 완료 ✅", "ok");
    }

    async function downloadOnePng(){
      const c = getSelectedCase();
      if(!c) return;

      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      const canvas = document.createElement("canvas");
      renderNoticeToCanvas(c, canvas, { width: 1080, height: 1350 });
      const blob = await canvasToBlob(canvas, "image/png");
      const fname = safeFilename(`${dateISO}_${c.학년}${c.반}_${c.이름}_미납안내문.png`);
      downloadBlob(blob, fname);
    }

    async function copySelectedSms(){
      const c = getSelectedCase();
      if(!c) return;
      const msg = buildSmsForCase(c);
      try{
        await navigator.clipboard.writeText(msg);
        setStatus("선택 학생 문자 문구를 클립보드에 복사했습니다 ✅", "ok");
      }catch(e){
        // clipboard 권한이 막히는 환경 대비: 프롬프트
        el("smsPreview").focus();
        el("smsPreview").select();
        document.execCommand("copy");
        setStatus("복사 완료(대체 방식) ✅", "ok");
      }
    }

    /***********************
     * 9) 이벤트
     ***********************/
    el("excelFile").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if(!file){
        setStatus("대기중… 엑셀을 올리면 자동으로 추출합니다.", "");
        return;
      }

      try{
        setStatus("엑셀 읽는 중…", "");
        const buf = await file.arrayBuffer();

        rawRows = parseXlsx(buf);
        if(!rawRows.length){
          throw new Error("추출된 데이터가 없습니다. (이름/납입금명/미납액이 있는 행을 확인하세요)");
        }

        cases = buildCasesFromRaw(rawRows);

        renderRawTable();
        renderCaseTable();
        populateCaseSelect();
        updatePreview();

        enableDownloads(true);
        el("btnOnePng").disabled = false;
        el("btnCopySms").disabled = false;

        setStatus(
          `추출 완료 ✅\n- 행 단위: ${rawRows.length}건\n- 학생별 통합: ${cases.length}건`,
          "ok"
        );
      }catch(err){
        console.error(err);
        rawRows = [];
        cases = [];
        selectedCaseKey = "";
        renderRawTable();
        renderCaseTable();
        populateCaseSelect();
        updatePreview();
        enableDownloads(false);
        el("btnOnePng").disabled = true;
        el("btnCopySms").disabled = true;

        setStatus(String(err?.message || err), "err");
      }
    });

    el("caseSelect").addEventListener("change", (ev) => {
      selectedCaseKey = ev.target.value;
      updatePreview();
    });

    // 설정값 바뀌면 미리보기 갱신
    ["schoolName","bankName","accountNumber","roundText","noticeRemark","dueDate","docDate","smsTemplate"].forEach(id => {
      el(id).addEventListener("input", () => updatePreview());
      el(id).addEventListener("change", () => updatePreview());
    });

    el("btnReset").addEventListener("click", () => {
      el("excelFile").value = "";
      rawRows = [];
      cases = [];
      selectedCaseKey = "";
      el("schoolName").value = "";
      el("bankName").value = "";
      el("accountNumber").value = "";
      el("roundText").value = "";
      el("noticeRemark").value = "";
      el("dueDate").value = "";
      el("docDate").value = toISODate(new Date());
      el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;

      renderRawTable();
      renderCaseTable();
      populateCaseSelect();
      updatePreview();
      enableDownloads(false);

      el("btnOnePng").disabled = true;
      el("btnCopySms").disabled = true;

      setStatus("초기화 완료. 엑셀을 다시 업로드하세요.", "");
    });

    el("btnDownloadCSV").addEventListener("click", () => {
      if(!cases.length) return;
      downloadCSV();
    });

    el("btnDownloadZip").addEventListener("click", async () => {
      if(!cases.length) return;
      try{
        await downloadZipPng();
      }catch(e){
        console.error(e);
        setStatus("PNG ZIP 생성 중 오류: " + (e?.message || e), "err");
      }
    });

    el("btnDownloadPDF").addEventListener("click", async () => {
      if(!cases.length) return;
      try{
        await downloadPDF();
      }catch(e){
        console.error(e);
        setStatus("PDF 생성 중 오류: " + (e?.message || e), "err");
      }
    });

    el("btnOnePng").addEventListener("click", async () => {
      try{
        await downloadOnePng();
      }catch(e){
        console.error(e);
        setStatus("단일 PNG 생성 중 오류: " + (e?.message || e), "err");
      }
    });

    el("btnCopySms").addEventListener("click", async () => {
      await copySelectedSms();
    });

    // 최초 미리보기(빈 화면)
    updatePreview();
  </script>
</body>
</html>
