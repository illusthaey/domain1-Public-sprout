<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>미수납 → 미납안내문/문자 생성기</title>

  <!-- ✅ 사이트 공통 CSS 그대로 -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- 라이브러리(CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    /* ===========================================
       페이지 전용: 공통 style.css를 해치지 않는 선에서만 최소 보강
       =========================================== */

    /* 파일 입력도 공통 인풋 톤에 맞추기 */
    input[type="file"]{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9e3;
      border-radius: 12px;
      background: #f9fafb;
      outline: none;
      min-width: 0;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.02);
    }
    input[type="file"]:focus{
      border-color: #b4b4d0;
      box-shadow: 0 0 0 2px rgba(180, 180, 208, 0.25);
      background: #fff;
    }

    /* 상태 박스: 공통 card 느낌으로 */
    .status-box{
      white-space: pre-line;
      font-size: 1rem;
      color: #333;
    }
    .status-ok{
      border-color: #bbf7d0 !important;
      background: #f0fdf4 !important;
    }
    .status-err{
      border-color: #fecaca !important;
      background: #fff1f2 !important;
    }

    /* 미리보기 캔버스 박스 */
    .canvasbox{
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #fff;
      padding: 12px;
    }
    canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #e5e5e5;
    }

    /* 미리보기 2열(넓을 때만) */
    .preview-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .preview-grid{
        grid-template-columns: 1fr 1fr;
        align-items: start;
      }
    }

    /* 버튼 간격: 공통 .row gap 사용 권장(추가 보정 최소) */
    .row.gap{ gap: 10px; }

    /* 고급설정 input 폭 */
    .mini-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-top: 10px;
    }

    /* details UI: style.css의 shot-details/shot-summary 톤 활용 */
    details.shot-details{
      margin-top: 12px;
    }
  </style>
</head>

<body>
  <!-- (선택) 페이지 상단 홈 링크: 기존 사이트 다른 페이지들과 동일 패턴 -->
  <div class="home-link-wrap">
    <a class="btn-home" href="/">← 메인으로</a>
  </div>

  <main class="container">
    <h1>미수납대상(.xlsx) → 미납 안내 문자 + 미납안내문(PNG/PDF)</h1>
    <p class="subtitle">
      엑셀에서 <b>학년/반/이름/납입금명/미납액</b>만 추출합니다.
      (제외 정리: <b>주간</b>, <b>야간</b>, <b>_</b>, <b>-</b>)
    </p>

    <!-- 1) 업로드 -->
    <section class="section">
      <div class="row between">
        <h2 class="local-h2 local-tight" style="margin:0;">엑셀 업로드</h2>
        <div class="row gap">
          <button class="btn ghost" id="btnLoadSample" type="button">샘플 데이터</button>
          <button class="btn ghost" id="btnReset" type="button">초기화</button>
        </div>
      </div>

      <p class="muted local-tight">
        보호자 연락처 / 학적구분 / 수납방법 / 미납일수 / 납입기한 / 결재상태 등은 <b>무시</b>합니다.
      </p>

      <div class="grid two">
        <div class="field">
          <label>에듀파인 엑셀(.xlsx)</label>
          <input id="excelFile" type="file" accept=".xlsx,.xls" />
        </div>

        <div class="field">
          <label>상태</label>
          <div id="statusBox" class="card status-box">
            대기중… 엑셀을 올리면 자동으로 추출합니다.
          </div>
        </div>
      </div>
    </section>

    <!-- 2) 설정 -->
    <section class="section">
      <div class="row between">
        <h2 class="local-h2 local-tight" style="margin:0;">기본 설정</h2>
        <div class="row gap">
          <button class="btn" id="btnApplySamplePreset" type="button">샘플 프리셋 적용</button>
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>학교명</label>
          <input id="schoolName" type="text" placeholder="예) 문막초등학교" />
        </div>
        <div class="field">
          <label>차수(문자용 / 안내문 비고 기본값)</label>
          <input id="roundText" type="text" placeholder="예) 2025년 2학기" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>은행명</label>
          <input id="bankName" type="text" placeholder="예) 농협" />
        </div>
        <div class="field">
          <label>계좌번호</label>
          <input id="accountNumber" type="text" placeholder="예) 000-0000-0000-00" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>안내문 비고(선택)</label>
          <input id="noticeRemark" type="text" placeholder="비어있으면 ‘차수’ 자동 입력" />
          <p class="note">샘플 안내문 비고 칸 값입니다.</p>
        </div>
        <div class="field">
          <label>안내문 라벨 색상</label>
          <select id="labelTheme">
            <option value="gray" selected>샘플(회색)</option>
            <option value="blue">파스텔 블루</option>
          </select>
          <p class="note">샘플 프리셋 기본은 회색입니다.</p>
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>납부 기한(안내문 문구)</label>
          <input id="dueDate" type="date" />
        </div>
        <div class="field">
          <label>안내문 작성일(하단 날짜)</label>
          <input id="docDate" type="date" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>내보내기 배율(선명도)</label>
          <select id="exportScale">
            <option value="1" selected>1x (기본)</option>
            <option value="2">2x (더 선명)</option>
          </select>
        </div>
      </div>

      <!-- 고급설정: 기존 페이지 접기/펼치기 UI와 통일 -->
      <details class="shot-details">
        <summary class="shot-summary">고급 설정(미세 조정)</summary>

        <div class="mini-grid">
          <div class="field">
            <label>박스 여백(px)</label>
            <input id="cfg_boxMargin" type="number" min="20" max="140" step="1">
          </div>
          <div class="field">
            <label>박스 하단 여백(px)</label>
            <input id="cfg_boxBottomMargin" type="number" min="20" max="160" step="1">
          </div>
          <div class="field">
            <label>제목 위 여백(px)</label>
            <input id="cfg_titleTop" type="number" min="10" max="120" step="1">
          </div>
          <div class="field">
            <label>밑줄→박스 간격(px)</label>
            <input id="cfg_boxTopGap" type="number" min="10" max="140" step="1">
          </div>

          <div class="field">
            <label>외곽선 굵기</label>
            <input id="cfg_outerLine" type="number" min="1" max="4" step="0.1">
          </div>
          <div class="field">
            <label>내부선 굵기</label>
            <input id="cfg_innerLine" type="number" min="0.8" max="3" step="0.1">
          </div>

          <div class="field">
            <label>상단 2행 높이(px)</label>
            <input id="cfg_topRowH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>일금 행 높이(px)</label>
            <input id="cfg_moneyRowH" type="number" min="40" max="90" step="1">
          </div>

          <div class="field">
            <label>표 헤더 높이(px)</label>
            <input id="cfg_headH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>표 본문 행 높이(px)</label>
            <input id="cfg_rowH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>합계 행 높이(px)</label>
            <input id="cfg_sumH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>표 슬롯(빈줄 포함)</label>
            <input id="cfg_slots" type="number" min="6" max="20" step="1">
          </div>

          <div class="field">
            <label>구분 칸 비율(0~1)</label>
            <input id="cfg_col1" type="number" min="0.30" max="0.60" step="0.01">
          </div>
          <div class="field">
            <label>금액 칸 비율(0~1)</label>
            <input id="cfg_col2" type="number" min="0.18" max="0.40" step="0.01">
          </div>

          <div class="field">
            <label>제목 크기(px)</label>
            <input id="cfg_titleSize" type="number" min="38" max="70" step="1">
          </div>
          <div class="field">
            <label>제목 자간(px)</label>
            <input id="cfg_titleSpacing" type="number" min="0" max="24" step="1">
          </div>

          <div class="field">
            <label>라벨 글자 크기(px)</label>
            <input id="cfg_labelSize" type="number" min="20" max="40" step="1">
          </div>
          <div class="field">
            <label>값 글자 크기(px)</label>
            <input id="cfg_valueSize" type="number" min="20" max="40" step="1">
          </div>
          <div class="field">
            <label>표 글자 크기(px)</label>
            <input id="cfg_tableSize" type="number" min="18" max="36" step="1">
          </div>
          <div class="field">
            <label>하단 날짜 크기(px)</label>
            <input id="cfg_dateSize" type="number" min="18" max="36" step="1">
          </div>
        </div>
      </details>
    </section>

    <!-- 3) 문자 템플릿 + 다운로드 -->
    <section class="section">
      <h2 class="local-h2 local-tight">문자 템플릿 & 다운로드</h2>
      <p class="muted">
        치환: [학교명] [학년] [반] [이름] [차수] [납입금명] [은행명] [계좌번호] [미납액]<br>
        ※ [번호]는 추출하지 않으므로 빈칸 처리
      </p>

      <textarea id="smsTemplate"></textarea>

      <div class="row gap" style="margin-top:12px; flex-wrap:wrap;">
        <button class="btn ghost" id="btnDownloadCSV" type="button" disabled>문자/명단 CSV</button>
        <button class="btn primary" id="btnDownloadZip" type="button" disabled>안내문 PNG ZIP</button>
        <button class="btn ghost" id="btnDownloadPDF" type="button" disabled>안내문 PDF</button>
      </div>

      <p class="note">보통은 PNG ZIP이 가장 많이 쓰입니다.</p>
    </section>

    <!-- 4) 추출 결과 -->
    <section class="section">
      <h2 class="local-h2 local-tight">추출 결과</h2>

      <h3 class="local-h3 local-tight">행 단위(추출 5개만)</h3>
      <div class="table-wrap">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>학년</th>
              <th>반</th>
              <th>이름</th>
              <th>납입금명</th>
              <th class="numeric">미납액</th>
            </tr>
          </thead>
          <tbody id="rawTbody">
            <tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <h3 class="local-h3 local-tight" style="margin-top:18px;">학생별 통합(안내문/문자 생성 단위)</h3>
      <div class="table-wrap">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>학년</th>
              <th>반</th>
              <th>이름</th>
              <th>납입금명(요약)</th>
              <th class="numeric">총 미납액</th>
            </tr>
          </thead>
          <tbody id="caseTbody">
            <tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 5) 미리보기 -->
    <section class="section">
      <h2 class="local-h2 local-tight">미리보기</h2>

      <div class="grid two">
        <div class="field">
          <label>학생 선택</label>
          <select id="caseSelect" disabled>
            <option value="">먼저 엑셀을 업로드하세요</option>
          </select>
        </div>
        <div class="field">
          <label>선택 학생 작업</label>
          <div class="row gap" style="flex-wrap:wrap;">
            <button class="btn ghost" id="btnOnePng" type="button" disabled>안내문 PNG 1장</button>
            <button class="btn ghost" id="btnCopySms" type="button" disabled>문자 복사</button>
          </div>
        </div>
      </div>

      <div class="preview-grid" style="margin-top:12px;">
        <div class="canvasbox">
          <canvas id="previewCanvas" width="1080" height="1350"></canvas>
          <p class="note">샘플 “미납안내문” 양식 구조로 렌더링됩니다. :contentReference[oaicite:1]{index=1}</p>
        </div>

        <div class="card">
          <h3 class="local-h3 local-tight">선택 학생 문자 문구</h3>
          <textarea id="smsPreview" readonly style="min-height: 320px;"></textarea>
          <p class="note">‘문자 복사’ 버튼으로 클립보드에 저장됩니다.</p>
        </div>
      </div>
    </section>

    <p class="muted" style="margin-top:18px;">
      ※ 정적 페이지: 브라우저에서만 동작합니다. 엑셀은 로컬에서만 읽습니다.
    </p>
  </main>

  <script>
    /***********************
     * 공통
     ***********************/
    const STORAGE_KEY = "eduFine_unpaid_notice_stylecss_final";

    const DEFAULT_SMS_TEMPLATE =
`안녕하세요,
[학교명] 행정실입니다.

[학년] [반] [번호] [이름] 학생 [차수] [납입금명] 미납 금액 이체 안내드립니다.

이체하실 계좌: [은행명] [계좌번호] [학교명]
이체하실 금액: [미납액]

원활한 업무처리를 위하여 반드시 학생 이름으로 이체 부탁드립니다.

감사합니다.`;

    const el = (id) => document.getElementById(id);

    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function parseDateInput(value){
      if(!value) return null;
      const [y,m,d] = value.split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
    function fmtKoreanDate(d, pad=false){
      if(!d) return "";
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      const day = d.getDate();
      if(pad){
        return `${y}년 ${String(m).padStart(2,"0")}월 ${String(day).padStart(2,"0")}일`;
      }
      return `${y}년 ${m}월 ${day}일`;
    }

    function setStatus(msg, kind=""){
      const box = el("statusBox");
      box.classList.remove("status-ok","status-err");
      if(kind === "ok") box.classList.add("status-ok");
      if(kind === "err") box.classList.add("status-err");
      box.textContent = msg;
    }

    function saveSettings(){
      const ids = [
        "schoolName","bankName","accountNumber","roundText","noticeRemark",
        "dueDate","docDate","labelTheme","exportScale","smsTemplate",
        "cfg_boxMargin","cfg_boxBottomMargin","cfg_titleTop","cfg_boxTopGap",
        "cfg_outerLine","cfg_innerLine","cfg_topRowH","cfg_moneyRowH",
        "cfg_headH","cfg_rowH","cfg_sumH","cfg_slots",
        "cfg_col1","cfg_col2","cfg_titleSize","cfg_titleSpacing",
        "cfg_labelSize","cfg_valueSize","cfg_tableSize","cfg_dateSize"
      ];
      const obj = {};
      for(const id of ids){
        obj[id] = el(id)?.value ?? "";
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        for(const [k,v] of Object.entries(obj)){
          if(el(k) && v !== null && v !== undefined) el(k).value = v;
        }
        return true;
      }catch(_){
        return false;
      }
    }

    /***********************
     * ✅ 샘플 프리셋(기본 고정)
     * - 미납안내문 샘플 양식에 맞춘 “기본값”
     ***********************/
    const SAMPLE_PRESET = {
      labelTheme: "gray",
      exportScale: "1",

      // 박스/제목 배치
      cfg_boxMargin: "86",
      cfg_boxBottomMargin: "78",
      cfg_titleTop: "38",
      cfg_boxTopGap: "28",

      // 선 굵기(샘플처럼 외곽이 좀 더 굵음)
      cfg_outerLine: "2.2",
      cfg_innerLine: "1.1",

      // 행 높이
      cfg_topRowH: "62",
      cfg_moneyRowH: "56",
      cfg_headH: "56",
      cfg_rowH: "56",
      cfg_sumH: "56",
      cfg_slots: "10",

      // 표 칸 비율(샘플 감각)
      cfg_col1: "0.44",
      cfg_col2: "0.28",

      // 타이포
      cfg_titleSize: "52",
      cfg_titleSpacing: "12",
      cfg_labelSize: "28",
      cfg_valueSize: "28",
      cfg_tableSize: "26",
      cfg_dateSize: "26",
    };

    function applyPreset(preset, save=true){
      for(const [k,v] of Object.entries(preset)){
        if(el(k)) el(k).value = v;
      }
      updatePreview();
      if(save) saveSettings();
    }

    /***********************
     * 상태
     ***********************/
    let rawRows = [];
    let cases = [];
    let selectedCaseKey = "";

    /***********************
     * 추출/정리 유틸
     ***********************/
    function toIntMoney(v){
      if(v === null || v === undefined || v === "") return 0;
      const n = Number(v);
      if(Number.isFinite(n)) return Math.round(n);
      const s = String(v).replace(/,/g,"").trim();
      const nn = Number(s);
      return Number.isFinite(nn) ? Math.round(nn) : 0;
    }

    // ✅ 제외: 주간 야간 _ -
    // + "2번" 같은 토큰 제거(학년/반 문자열에 섞여 들어오는 경우)
    function cleanSchoolToken(s){
      let out = String(s ?? "")
        .replace(/주간/g, "")
        .replace(/야간/g, "")
        .replace(/[_-]/g, "")
        .replace(/\s+/g, " ")
        .trim();
      out = out.replace(/\b\d+\s*번\b/g, "").replace(/\s+/g," ").trim();
      return out;
    }

    // 학년/반 섞임 보정: "1학년 달반" 같은 경우 분리
    function normalizeGradeClass(gradeIn, classIn){
      let g = cleanSchoolToken(gradeIn);
      let c = cleanSchoolToken(classIn);

      const gHas = /(\d+)\s*학년/.test(g);
      const cHas = /(\d+)\s*학년/.test(c);
      if(!gHas && cHas){
        const tmp = g; g = c; c = tmp;
      }

      const m = g.match(/(\d+)\s*학년/);
      if(m){
        const gradePart = `${m[1]}학년`;
        let rest = g.replace(m[0], "").trim().replace(/\s+/g," ");
        g = gradePart;
        if(rest){
          if(!c) c = rest;
          else if(!c.includes(rest)) c = `${rest} ${c}`.trim();
        }
      }
      return { 학년: g, 반: c };
    }

    function normalizeSpacesPerLine(text){
      return String(text ?? "")
        .split("\n")
        .map(line => line.replace(/[ \t]+/g, " ").replace(/\s+$/g,""))
        .join("\n")
        .trim();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    /***********************
     * XLSX 파싱(필요 5개만)
     ***********************/
    function normalizeHeader(h){
      return String(h ?? "").trim().replace(/\s+/g,"").replace(/[_-]/g,"_");
    }

    function findHeaderRow(rows){
      const limit = Math.min(rows.length, 20);
      for(let i=0;i<limit;i++){
        const row = (rows[i] || []).map(normalizeHeader);
        const hasName = row.some(x => x.includes("이름"));
        const hasItem = row.some(x => x.includes("납입금명"));
        const hasAmt  = row.some(x => x.includes("미납액"));
        if(hasName && hasItem && hasAmt) return i;
      }
      return 0;
    }

    function pickIndex(headers, patterns){
      for(const re of patterns){
        const idx = headers.findIndex(h => re.test(h));
        if(idx !== -1) return idx;
      }
      return -1;
    }

    function parseXlsx(arrayBuffer){
      const wb = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

      if(!rows || rows.length === 0){
        throw new Error("시트에 데이터가 없습니다.");
      }

      const headerRowIdx = findHeaderRow(rows);
      const header = (rows[headerRowIdx] || []).map(normalizeHeader);

      const idxGrade = pickIndex(header, [/주야.*학년/i, /계열.*학년/i, /^주야_계열_학년$/i, /학년/]);
      const idxClass = pickIndex(header, [/^학과_반$/i, /학과.*반/i, /^반$/i, /반/]);
      const idxName  = pickIndex(header, [/^이름$/i, /성명/i]);
      const idxItem  = pickIndex(header, [/^납입금명$/i, /납입.*명/i]);
      const idxAmt   = pickIndex(header, [/^미납액$/i, /미납.*금/i]);

      if([idxGrade, idxClass, idxName, idxItem, idxAmt].some(x => x === -1)){
        throw new Error(
          "필수 컬럼을 찾지 못했습니다.\n" +
          "필요: (주야_계열_학년 또는 학년), (학과_반 또는 반), 이름, 납입금명, 미납액"
        );
      }

      const out = [];
      for(let r=headerRowIdx+1; r<rows.length; r++){
        const row = rows[r] || [];
        const norm = normalizeGradeClass(row[idxGrade], row[idxClass]);
        const name = String(row[idxName] ?? "").trim();
        const item = String(row[idxItem] ?? "").trim();
        const amt  = toIntMoney(row[idxAmt]);

        if(!norm.학년 && !norm.반 && !name && !item && !amt) continue;
        if(!name || !item) continue;

        // ✅ 추출 5개만
        out.push({ 학년: norm.학년, 반: norm.반, 이름: name, 납입금명: item, 미납액: amt });
      }
      return out;
    }

    function buildCasesFromRaw(rows){
      const map = new Map();
      for(const rr of rows){
        const key = `${rr.학년}||${rr.반}||${rr.이름}`;
        if(!map.has(key)){
          map.set(key, { key, 학년: rr.학년, 반: rr.반, 이름: rr.이름, items: [], total: 0 });
        }
        const c = map.get(key);
        c.items.push({ 납입금명: rr.납입금명, 미납액: rr.미납액 });
        c.total += rr.미납액;
      }

      const list = Array.from(map.values());
      for(const c of list){
        const uniq = [];
        const seen = new Set();
        for(const it of c.items){
          if(!seen.has(it.납입금명)){
            seen.add(it.납입금명);
            uniq.push(it.납입금명);
          }
        }
        c.납입금명요약 = uniq.join(", ");
      }

      list.sort((a,b) => {
        const ag = a.학년 || "", bg = b.학년 || "";
        if(ag !== bg) return ag.localeCompare(bg, "ko");
        const ac = a.반 || "", bc = b.반 || "";
        if(ac !== bc) return ac.localeCompare(bc, "ko");
        return (a.이름||"").localeCompare((b.이름||""), "ko");
      });

      return list;
    }

    /***********************
     * 문자 생성
     ***********************/
    function buildSmsForCase(c){
      const schoolName = el("schoolName").value.trim();
      const bankName   = el("bankName").value.trim();
      const accountNum = el("accountNumber").value.trim();
      const roundText  = el("roundText").value.trim();
      const template   = el("smsTemplate").value;

      const repl = {
        "[학교명]": schoolName,
        "[학년]": c.학년,
        "[반]": c.반,
        "[이름]": c.이름,
        "[차수]": roundText,
        "[납입금명]": c.납입금명요약,
        "[은행명]": bankName,
        "[계좌번호]": accountNum,
        "[미납액]": c.total.toLocaleString("ko-KR"),
        "[번호]": "" // ✅ 추출하지 않음
      };

      let msg = String(template ?? "");
      for(const k of Object.keys(repl)){
        msg = msg.split(k).join(repl[k] ?? "");
      }
      return normalizeSpacesPerLine(msg);
    }

    /***********************
     * 안내문 렌더링(캔버스) - 샘플 양식 기반 :contentReference[oaicite:2]{index=2}
     ***********************/
    const DIG_KOR = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];
    function fourToKor(n){
      const s = String(n).padStart(4,"0");
      const units = ["천","백","십",""];
      let out = "";
      for(let i=0;i<4;i++){
        const d = Number(s[i]);
        if(d === 0) continue;
        out += DIG_KOR[d] + units[i];
      }
      return out;
    }
    function numberToKor(n){
      n = Math.floor(Math.abs(Number(n) || 0));
      if(n === 0) return "영";
      const big = ["", "만", "억", "조", "경"];
      let idx = 0;
      let out = "";
      while(n > 0){
        const part = n % 10000;
        if(part > 0){
          out = fourToKor(part) + big[idx] + out;
        }
        n = Math.floor(n/10000);
        idx++;
      }
      return out;
    }

    function getNoticeLabelColor(){
      const theme = el("labelTheme").value;
      if(theme === "gray") return "#BFBFBF"; // 샘플 느낌
      return "#D9EEFF";                      // 파스텔 블루
    }

    function num(id, fallback){
      const v = Number(el(id)?.value);
      return Number.isFinite(v) ? v : fallback;
    }

    function drawSpacedText(ctx, text, centerX, yBaseline, spacingPx){
      const chars = Array.from(String(text || ""));
      const widths = chars.map(ch => ctx.measureText(ch).width);
      const total = widths.reduce((a,b)=>a+b,0) + spacingPx * Math.max(0, chars.length-1);
      let x = centerX - total/2;
      for(let i=0;i<chars.length;i++){
        ctx.fillText(chars[i], x, yBaseline);
        x += widths[i] + spacingPx;
      }
      return total;
    }

    function renderNoticeToCanvas(caseObj, canvas, opts={}){
      const baseW = opts.baseW || 1080;
      const baseH = opts.baseH || 1350;
      const scale = opts.scale || 1;

      canvas.width = Math.round(baseW * scale);
      canvas.height = Math.round(baseH * scale);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(scale, 0, 0, scale, 0, 0);

      const family = `"맑은 고딕","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif`;

      const schoolName = el("schoolName").value.trim();
      const roundText = el("roundText").value.trim();
      const remarkRaw = el("noticeRemark").value.trim();
      const remarkText = remarkRaw || roundText;

      const dueDate = parseDateInput(el("dueDate").value);
      const docDate = parseDateInput(el("docDate").value) || new Date();

      const principalTitle = schoolName ? (schoolName + "장") : "학교장";

      const boxMargin = num("cfg_boxMargin", 86);
      const boxBottomMargin = num("cfg_boxBottomMargin", 78);
      const titleTop = num("cfg_titleTop", 38);
      const boxTopGap = num("cfg_boxTopGap", 28);

      const outerLine = num("cfg_outerLine", 2.2);
      const innerLine = num("cfg_innerLine", 1.1);

      const topRowH = num("cfg_topRowH", 62);
      const moneyRowH = num("cfg_moneyRowH", 56);

      const headH = num("cfg_headH", 56);
      const rowH = num("cfg_rowH", 56);
      const sumH = num("cfg_sumH", 56);
      const slots = Math.max(6, Math.min(20, Math.floor(num("cfg_slots", 10))));

      const col1Ratio = Math.max(0.30, Math.min(0.60, num("cfg_col1", 0.44)));
      const col2Ratio = Math.max(0.18, Math.min(0.40, num("cfg_col2", 0.28)));

      const titleSize = num("cfg_titleSize", 52);
      const titleSpacing = num("cfg_titleSpacing", 12);

      const labelSize = num("cfg_labelSize", 28);
      const valueSize = num("cfg_valueSize", 28);
      const tableSize = num("cfg_tableSize", 26);
      const dateSize = num("cfg_dateSize", 26);

      const labelBg = getNoticeLabelColor();
      const stroke = "#222";

      // 배경
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,baseW,baseH);

      // 제목 + 밑줄
      ctx.fillStyle = "#111";
      ctx.textAlign = "center";
      ctx.textBaseline = "alphabetic";
      ctx.font = `800 ${Math.round(titleSize)}px ${family}`;
      const titleBaseline = titleTop + titleSize + 6;
      const titleWidth = drawSpacedText(ctx, "미납안내문", baseW/2, titleBaseline, titleSpacing);

      const underlineY = titleBaseline + 14;
      ctx.strokeStyle = stroke;
      ctx.lineWidth = outerLine;
      ctx.beginPath();
      ctx.moveTo(baseW/2 - titleWidth/2, underlineY);
      ctx.lineTo(baseW/2 + titleWidth/2, underlineY);
      ctx.stroke();

      // 박스
      const boxX = boxMargin;
      const boxY = underlineY + boxTopGap;
      const boxW = baseW - boxMargin*2;
      const boxH = baseH - boxY - boxBottomMargin;

      ctx.lineWidth = outerLine;
      ctx.strokeStyle = stroke;
      ctx.strokeRect(boxX, boxY, boxW, boxH);

      function cell(x, y, w, h, fill){
        if(fill){
          ctx.fillStyle = fill;
          ctx.fillRect(x,y,w,h);
        }
        ctx.strokeStyle = stroke;
        ctx.lineWidth = innerLine;
        ctx.strokeRect(x,y,w,h);
      }

      let y = boxY;

      // 라벨 너비(샘플 느낌)
      const labelWRatio = 0.34;
      const labelW = Math.round(boxW * labelWRatio);
      const valW = boxW - labelW;

      ctx.textBaseline = "middle";

      // 1행: 학번
      cell(boxX, y, labelW, topRowH, labelBg);
      cell(boxX+labelW, y, valW, topRowH, "#fff");
      ctx.fillStyle="#111";
      ctx.textAlign="center";
      ctx.font = `700 ${labelSize}px ${family}`;
      ctx.fillText("학   번", boxX + labelW/2, y + topRowH/2);

      ctx.textAlign="left";
      const classLine = `${caseObj.학년} ${caseObj.반}`.trim();
      let curSize = valueSize;
      ctx.font = `600 ${curSize}px ${family}`;
      while(curSize > 18 && ctx.measureText(classLine).width > (valW - 36)){
        curSize -= 1;
        ctx.font = `600 ${curSize}px ${family}`;
      }
      ctx.fillText(classLine, boxX + labelW + 18, y + topRowH/2);
      y += topRowH;

      // 2행: 이름
      cell(boxX, y, labelW, topRowH, labelBg);
      cell(boxX+labelW, y, valW, topRowH, "#fff");
      ctx.textAlign="center";
      ctx.font = `700 ${labelSize}px ${family}`;
      ctx.fillText("이   름", boxX + labelW/2, y + topRowH/2);

      ctx.textAlign="left";
      ctx.font = `600 ${valueSize}px ${family}`;
      ctx.fillText(String(caseObj.이름||""), boxX + labelW + 18, y + topRowH/2);
      y += topRowH;

      // 일금
      cell(boxX, y, boxW, moneyRowH, "#fff");
      ctx.textAlign="center";
      ctx.font = `600 ${valueSize}px ${family}`;
      ctx.fillText(`일금 ${numberToKor(caseObj.total)} 원정`, boxX + boxW/2, y + moneyRowH/2);
      y += moneyRowH;

      // 표(구분/금액/비고)
      const col1 = Math.round(boxW * col1Ratio);
      const col2 = Math.round(boxW * col2Ratio);
      const col3 = boxW - col1 - col2;

      cell(boxX, y, col1, headH, labelBg);
      cell(boxX+col1, y, col2, headH, labelBg);
      cell(boxX+col1+col2, y, col3, headH, labelBg);

      ctx.textAlign="center";
      ctx.font = `700 ${tableSize}px ${family}`;
      ctx.fillText("구   분", boxX + col1/2, y + headH/2);
      ctx.fillText("금   액", boxX + col1 + col2/2, y + headH/2);
      ctx.fillText("비   고", boxX + col1 + col2 + col3/2, y + headH/2);
      y += headH;

      for(let i=0;i<slots;i++){
        cell(boxX, y, col1, rowH, "#fff");
        cell(boxX+col1, y, col2, rowH, "#fff");
        cell(boxX+col1+col2, y, col3, rowH, "#fff");

        const it = caseObj.items[i];
        if(it){
          let nm = String(it.납입금명||"");
          let s = tableSize;
          ctx.textAlign="center";
          ctx.font = `600 ${s}px ${family}`;
          while(s > 16 && ctx.measureText(nm).width > (col1 - 18)){
            s -= 1;
            ctx.font = `600 ${s}px ${family}`;
          }
          ctx.fillText(nm, boxX + col1/2, y + rowH/2);

          ctx.textAlign="right";
          ctx.font = `600 ${tableSize}px ${family}`;
          ctx.fillText((it.미납액||0).toLocaleString("ko-KR"), boxX + col1 + col2 - 14, y + rowH/2);

          if(remarkText){
            ctx.textAlign="center";
            ctx.fillText(remarkText, boxX + col1 + col2 + col3/2, y + rowH/2);
          }
        }
        y += rowH;
      }

      // 합계
      cell(boxX, y, col1, sumH, "#fff");
      cell(boxX+col1, y, col2, sumH, "#fff");
      cell(boxX+col1+col2, y, col3, sumH, "#fff");

      ctx.font = `700 ${tableSize}px ${family}`;
      ctx.textAlign="center";
      ctx.fillText("합   계", boxX + col1/2, y + sumH/2);

      ctx.textAlign="right";
      ctx.fillText(caseObj.total.toLocaleString("ko-KR"), boxX + col1 + col2 - 14, y + sumH/2);
      y += sumH;

      // 하단 문구
      ctx.font = `600 23px ${family}`;
      ctx.textAlign="left";
      ctx.textBaseline="alphabetic";
      ctx.fillText("※ 위의 금액이 미납되어 있습니다.", boxX + 10, y + 34);

      const dueLine = dueDate
        ? `${fmtKoreanDate(dueDate, false)} 까지 금액을 납부하여 주십시오.`
        : "납부 기한을 입력하면 여기에 표시됩니다.";
      ctx.fillText(dueLine, boxX + 10, y + 66);

      // 날짜/학교장
      const boxBottom = boxY + boxH;
      ctx.textAlign="center";
      ctx.font = `600 ${dateSize}px ${family}`;
      ctx.fillText(fmtKoreanDate(docDate, true), boxX + boxW/2, boxBottom - 150);

      ctx.font = `800 34px ${family}`;
      ctx.fillText(principalTitle, boxX + boxW/2, boxBottom - 92);

      ctx.restore();
      return canvas;
    }

    /***********************
     * 테이블 렌더/선택/프리뷰
     ***********************/
    function renderRawTable(){
      const tbody = el("rawTbody");
      tbody.innerHTML = "";
      if(!rawRows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }
      for(const r of rawRows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.학년)}</td>
          <td>${escapeHtml(r.반)}</td>
          <td>${escapeHtml(r.이름)}</td>
          <td>${escapeHtml(r.납입금명)}</td>
          <td class="numeric">${(r.미납액||0).toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderCaseTable(){
      const tbody = el("caseTbody");
      tbody.innerHTML = "";
      if(!cases.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }
      for(const c of cases){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(c.학년)}</td>
          <td>${escapeHtml(c.반)}</td>
          <td>${escapeHtml(c.이름)}</td>
          <td>${escapeHtml(c.납입금명요약)}</td>
          <td class="numeric">${c.total.toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function populateCaseSelect(){
      const sel = el("caseSelect");
      sel.innerHTML = "";
      if(!cases.length){
        sel.disabled = true;
        selectedCaseKey = "";
        sel.innerHTML = `<option value="">먼저 엑셀을 업로드하세요</option>`;
        return;
      }
      sel.disabled = false;
      for(const c of cases){
        const opt = document.createElement("option");
        opt.value = c.key;
        opt.textContent = `${c.학년} ${c.반} ${c.이름} (${c.total.toLocaleString("ko-KR")}원)`;
        sel.appendChild(opt);
      }
      selectedCaseKey = cases[0].key;
      sel.value = selectedCaseKey;
    }

    function getSelectedCase(){
      return cases.find(x => x.key === selectedCaseKey) || null;
    }

    function enableDownloads(enable){
      el("btnDownloadCSV").disabled = !enable;
      el("btnDownloadZip").disabled = !enable;
      el("btnDownloadPDF").disabled = !enable;
      el("btnOnePng").disabled = !enable;
      el("btnCopySms").disabled = !enable;
    }

    function updatePreview(){
      const c = getSelectedCase();
      const canvas = el("previewCanvas");
      if(!c){
        canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
        el("smsPreview").value = "";
        return;
      }
      renderNoticeToCanvas(c, canvas, { baseW: 1080, baseH: 1350, scale: 1 });
      el("smsPreview").value = buildSmsForCase(c);
    }

    function renderAll(){
      renderRawTable();
      renderCaseTable();
      populateCaseSelect();
      enableDownloads(!!cases.length);
      updatePreview();
    }

    /***********************
     * 다운로드
     ***********************/
    function csvEscape(value){
      const s = String(value ?? "");
      if(/[",\n]/.test(s)){
        return `"${s.replace(/"/g,'""')}"`;
      }
      return s;
    }

    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function downloadText(text, filename, mime="text/plain;charset=utf-8"){
      const blob = new Blob([text], { type: mime });
      downloadBlob(blob, filename);
    }

    function canvasToBlob(canvas, type="image/png", quality){
      return new Promise((resolve) => canvas.toBlob(b => resolve(b), type, quality));
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    function downloadCSV(){
      const lines = [];
      lines.push(["학년","반","이름","납입금명(요약)","총미납액","문자문구"].map(csvEscape).join(","));
      for(const c of cases){
        const row = [c.학년, c.반, c.이름, c.납입금명요약, c.total, buildSmsForCase(c)];
        lines.push(row.map(csvEscape).join(","));
      }
      const text = "\ufeff" + lines.join("\n");
      const d = parseDateInput(el("docDate").value) || new Date();
      downloadText(text, `미납문자_명단_${toISODate(d)}.csv`, "text/csv;charset=utf-8");
    }

    async function downloadZipPng(){
      const zip = new JSZip();
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      const tempCanvas = document.createElement("canvas");
      const scale = Number(el("exportScale").value) || 1;

      setStatus(`안내문 PNG 생성중… (0/${cases.length})`, "");
      for(let i=0;i<cases.length;i++){
        const c = cases[i];
        const slots = Math.max(6, Math.min(20, Math.floor(num("cfg_slots", 10))));
        const clipped = { ...c, items: c.items.slice(0, slots) };

        renderNoticeToCanvas(clipped, tempCanvas, { baseW: 1080, baseH: 1350, scale });
        const blob = await canvasToBlob(tempCanvas, "image/png");

        const fname = `${dateISO}_${c.학년}${c.반}_${c.이름}_미납안내문.png`
          .replace(/[\/\\?%*:|"<>]/g, "_").replace(/\s+/g, " ").trim();
        zip.file(fname, blob);

        setStatus(`안내문 PNG 생성중… (${i+1}/${cases.length})`, "");
        await sleep(0);
      }

      const zipBlob = await zip.generateAsync({ type: "blob" });
      downloadBlob(zipBlob, `미납안내문_PNG_${dateISO}.zip`);
      setStatus("PNG ZIP 다운로드 준비 완료 ✅", "ok");
    }

    async function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      const pageW = 1080, pageH = 1350;
      const doc = new jsPDF({ orientation: "portrait", unit: "px", format: [pageW, pageH] });

      const tempCanvas = document.createElement("canvas");
      const scale = Number(el("exportScale").value) || 1;

      setStatus(`안내문 PDF 생성중… (0/${cases.length})`, "");
      for(let i=0;i<cases.length;i++){
        const c = cases[i];
        const slots = Math.max(6, Math.min(20, Math.floor(num("cfg_slots", 10))));
        const clipped = { ...c, items: c.items.slice(0, slots) };

        renderNoticeToCanvas(clipped, tempCanvas, { baseW: pageW, baseH: pageH, scale });
        const imgData = tempCanvas.toDataURL("image/jpeg", 0.92);

        if(i > 0) doc.addPage([pageW, pageH], "portrait");
        doc.addImage(imgData, "JPEG", 0, 0, pageW, pageH);

        setStatus(`안내문 PDF 생성중… (${i+1}/${cases.length})`, "");
        await sleep(0);
      }

      doc.save(`미납안내문_${dateISO}.pdf`);
      setStatus("PDF 다운로드 준비 완료 ✅", "ok");
    }

    async function downloadOnePng(){
      const c = getSelectedCase();
      if(!c) return;

      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const scale = Number(el("exportScale").value) || 1;

      const canvas = document.createElement("canvas");
      const slots = Math.max(6, Math.min(20, Math.floor(num("cfg_slots", 10))));
      const clipped = { ...c, items: c.items.slice(0, slots) };

      renderNoticeToCanvas(clipped, canvas, { baseW: 1080, baseH: 1350, scale });
      const blob = await canvasToBlob(canvas, "image/png");

      const fname = `${dateISO}_${c.학년}${c.반}_${c.이름}_미납안내문.png`
        .replace(/[\/\\?%*:|"<>]/g, "_").replace(/\s+/g, " ").trim();
      downloadBlob(blob, fname);
    }

    async function copySelectedSms(){
      const c = getSelectedCase();
      if(!c) return;
      const msg = buildSmsForCase(c);
      try{
        await navigator.clipboard.writeText(msg);
        setStatus("선택 학생 문자 문구를 클립보드에 복사했습니다 ✅", "ok");
      }catch(_){
        el("smsPreview").focus();
        el("smsPreview").select();
        document.execCommand("copy");
        setStatus("복사 완료(대체 방식) ✅", "ok");
      }
    }

    /***********************
     * 이벤트
     ***********************/
    el("btnApplySamplePreset").addEventListener("click", () => {
      applyPreset(SAMPLE_PRESET, true);
      setStatus("샘플 프리셋 적용 완료 ✅", "ok");
    });

    el("excelFile").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if(!file){
        setStatus("대기중… 엑셀을 올리면 자동으로 추출합니다.", "");
        return;
      }
      try{
        setStatus("엑셀 읽는 중…", "");
        const buf = await file.arrayBuffer();
        rawRows = parseXlsx(buf);

        if(!rawRows.length){
          throw new Error("추출된 데이터가 없습니다. (이름/납입금명/미납액이 있는 행을 확인하세요)");
        }

        cases = buildCasesFromRaw(rawRows);
        renderAll();

        setStatus(`추출 완료 ✅\n- 행 단위: ${rawRows.length}건\n- 학생별 통합: ${cases.length}건`, "ok");
        saveSettings();
      }catch(err){
        console.error(err);
        rawRows = [];
        cases = [];
        selectedCaseKey = "";
        renderAll();
        el("smsPreview").value = "";
        setStatus(String(err?.message || err), "err");
      }
    });

    el("caseSelect").addEventListener("change", (ev) => {
      selectedCaseKey = ev.target.value;
      updatePreview();
      saveSettings();
    });

    el("btnLoadSample").addEventListener("click", () => {
      rawRows = [
        { 학년:"1학년", 반:"달반", 이름:"김가온", 납입금명:"우유급식비", 미납액:15710 },
        { 학년:"3학년", 반:"별반", 이름:"김민지", 납입금명:"우유급식비", 미납액:36290 },
        { 학년:"3학년", 반:"별반", 이름:"김민지", 납입금명:"우유급식비", 미납액:44170 },
      ];
      cases = buildCasesFromRaw(rawRows);
      renderAll();
      setStatus("샘플 데이터 로드 완료 ✅", "ok");
      saveSettings();
    });

    el("btnReset").addEventListener("click", () => {
      el("excelFile").value = "";
      rawRows = [];
      cases = [];
      selectedCaseKey = "";

      el("schoolName").value = "";
      el("bankName").value = "";
      el("accountNumber").value = "";
      el("roundText").value = "";
      el("noticeRemark").value = "";
      el("dueDate").value = "";
      el("docDate").value = toISODate(new Date());
      el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;

      // 샘플 프리셋 기본값 복귀
      applyPreset(SAMPLE_PRESET, false);

      localStorage.removeItem(STORAGE_KEY);
      saveSettings();

      renderAll();
      el("previewCanvas").getContext("2d").clearRect(0,0,el("previewCanvas").width, el("previewCanvas").height);
      el("smsPreview").value = "";
      setStatus("초기화 완료. 엑셀을 다시 업로드하세요.", "");
    });

    el("btnDownloadCSV").addEventListener("click", () => cases.length && downloadCSV());
    el("btnDownloadZip").addEventListener("click", async () => cases.length && downloadZipPng());
    el("btnDownloadPDF").addEventListener("click", async () => cases.length && downloadPDF());
    el("btnOnePng").addEventListener("click", async () => downloadOnePng());
    el("btnCopySms").addEventListener("click", async () => copySelectedSms());

    // 변경 감지 → 미리보기 업데이트 + 저장
    const watchIds = [
      "schoolName","bankName","accountNumber","roundText","noticeRemark",
      "dueDate","docDate","labelTheme","exportScale","smsTemplate",
      "cfg_boxMargin","cfg_boxBottomMargin","cfg_titleTop","cfg_boxTopGap",
      "cfg_outerLine","cfg_innerLine","cfg_topRowH","cfg_moneyRowH",
      "cfg_headH","cfg_rowH","cfg_sumH","cfg_slots",
      "cfg_col1","cfg_col2","cfg_titleSize","cfg_titleSpacing",
      "cfg_labelSize","cfg_valueSize","cfg_tableSize","cfg_dateSize"
    ];
    for(const id of watchIds){
      el(id).addEventListener("input", () => { updatePreview(); saveSettings(); });
      el(id).addEventListener("change", () => { updatePreview(); saveSettings(); });
    }

    // 초기 세팅: 저장값이 없으면 샘플 프리셋을 기본 적용
    const hasSaved = loadSettings();
    if(!el("smsTemplate").value.trim()) el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;
    if(!el("docDate").value) el("docDate").value = toISODate(new Date());
    if(!hasSaved){
      applyPreset(SAMPLE_PRESET, false);
      saveSettings();
    }

    enableDownloads(false);
    renderAll();
    setStatus("대기중… 엑셀 업로드 또는 샘플 데이터로 시작하세요.", "");
  </script>

  <!-- ✅ 요청하신 공통 JS (</body> 직전) -->
  <script src="/static/disable-copy.js"></script>
  <script src="/static/footer.js"></script>
  <script src="/static/global-loader.js?v=1"></script>
</body>
</html>
