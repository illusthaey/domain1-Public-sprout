<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>세입 미납자 문자 발송 문구 및 고지내역 자동 생성기</title>

  <!-- ✅ 사이트 공통 CSS 그대로 -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- 라이브러리(CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    /* ===========================================
       페이지 전용: 공통 style.css를 해치지 않는 선에서 최소 보강
       =========================================== */

    /* 드롭존 */
    .dropzone{
      border: 2px dashed #d4d4d8;
      background: #fafafa;
      border-radius: 12px;
      padding: 14px 16px;
      cursor: pointer;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
    }
    .dropzone:hover{ background:#f9fafb; }
    .dropzone:active{ transform: scale(0.998); }
    .dropzone.is-dragover{
      border-color: #6b7280;
      background: #eef2ff;
    }
    .dropzone .dz-title{
      font-weight: 700;
      color: #111;
      margin: 0 0 6px;
      font-size: 1.02rem;
    }
    .dropzone .dz-sub{
      margin: 0;
      color: #555;
      font-size: 0.95rem;
    }
    .dropzone .dz-sub code{
      background:#fff;
      border:1px solid #e5e7eb;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.92rem;
    }

    /* 상태 박스 */
    .status-box{
      white-space: pre-line;
      font-size: 1rem;
      color: #333;
    }
    .status-ok{
      border-color: #bbf7d0 !important;
      background: #f0fdf4 !important;
    }
    .status-err{
      border-color: #fecaca !important;
      background: #fff1f2 !important;
    }

    /* 미리보기 캔버스 박스 */
    .canvasbox{
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #fff;
      padding: 12px;
    }
    canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #e5e5e5;
    }

    /* 미리보기 2열(넓을 때만) */
    .preview-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .preview-grid{
        grid-template-columns: 1fr 1fr;
        align-items: start;
      }
    }

    /* 고급설정 그리드 */
    .mini-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-top: 10px;
    }

    /* 버튼 바(공통 row 기반, 보조로 wrap) */
    .btnbar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    /* 업로드 input 숨김 */
    #excelFile{ display:none; }

    /* 작은 배지 */
    .pill{
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #f3f4f6;
      font-size: 0.9rem;
      color: #333;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="home-link-wrap">
    <a class="btn-home" href="/">메인으로 돌아가기</a>
  </div>

  <main class="container">
    <h1>세입 미납자 문자 발송 문구 및 고지내역 자동 생성기</h1>
    <p class="subtitle">
      ·미수납 조회에서 엑셀 파일 다운로드하고 업로드하면 미납 독촉 문자 발송에 쓸 문구와 미납내역을 pdf와 이미지파일로 일괄 생성해드립니다. 
    </p>

    <!-- 1) 업로드 -->
    <section class="section">
      <div class="row between">
        <h2 class="local-h2 local-tight" style="margin:0;">1. 미수납자 현황 데이터 취합</h2>
        <div class="row gap">
          <button class="btn ghost" id="btnLoadSample" type="button">샘플 데이터 적용</button>
          <button class="btn ghost" id="btnReset" type="button">입력 내용 초기화하기</button>
        </div>
      </div>

      <p class="muted local-tight">
        ·미취합 항목: 보호자 연락처, 학적구분, 수납방법, 미납일수, 납입기한, 결재상태
      </p>

      <input id="excelFile" type="file" accept=".xlsx,.xls" />

      <div id="dropZone" class="dropzone" role="button" tabindex="0" aria-label="엑셀 파일 업로드">
        <p class="dz-title">파일을 드래그하여 업로드해주십시오.</p>
        <p class="dz-sub">
          클릭해도 파일 선택 창 열려서 업로드 가능함함 <code>.xlsx</code>
        </p>
      </div>

      <div id="statusBox" class="card status-box" style="margin-top:12px;">
        ·기다리시오
      </div>
    </section>

    <!-- 2) 설정 -->
    <section class="section">
      <div class="row between">
        <h2 class="local-h2 local-tight" style="margin:0;">2. 기준 정보 입력하기</h2>
        <div class="row gap">
          <button class="btn ghost" id="btnApplySamplePreset" type="button">샘플 프리셋 적용</button>
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>학교명</label>
          <input id="schoolName" type="text" placeholder="예) 문막초등학교" />
        </div>
        <div class="field">
          <label>차수(문자용 / 안내문 비고 기본값)</label>
          <input id="roundText" type="text" placeholder="예) 2025년 2학기" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>은행명</label>
          <input id="bankName" type="text" placeholder="예) 농협" />
        </div>
        <div class="field">
          <label>계좌번호</label>
          <input id="accountNumber" type="text" placeholder="예) 000-0000-0000-00" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>안내문 비고(선택)</label>
          <input id="noticeRemark" type="text" placeholder="비어있으면 ‘차수’ 자동 입력" />
          <p class="note">샘플 안내문 비고 칸 값입니다.</p>
        </div>
        <div class="field">
          <label>안내문 라벨 색상</label>
          <select id="labelTheme">
            <option value="gray" selected>샘플(회색)</option>
            <option value="blue">파스텔 블루</option>
          </select>
          <p class="note">기본은 샘플처럼 회색입니다.</p>
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>납부 기한(안내문 문구)</label>
          <input id="dueDate" type="date" />
        </div>
        <div class="field">
          <label>안내문 작성일(하단 날짜)</label>
          <input id="docDate" type="date" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>내보내기 배율(선명도)</label>
          <select id="exportScale">
            <option value="1" selected>1x (기본)</option>
            <option value="2">2x (더 선명)</option>
          </select>
        </div>
      </div>

      <!-- 고급설정: 기존 페이지 접기/펼치기 UI와 통일 -->
      <details class="shot-details">
        <summary class="shot-summary">고급 설정(미세 조정)</summary>

        <div class="mini-grid">
          <div class="field">
            <label>박스 여백(px)</label>
            <input id="cfg_boxMargin" type="number" min="20" max="140" step="1">
          </div>
          <div class="field">
            <label>박스 하단 여백(px)</label>
            <input id="cfg_boxBottomMargin" type="number" min="20" max="160" step="1">
          </div>
          <div class="field">
            <label>제목 위 여백(px)</label>
            <input id="cfg_titleTop" type="number" min="10" max="120" step="1">
          </div>
          <div class="field">
            <label>밑줄→박스 간격(px)</label>
            <input id="cfg_boxTopGap" type="number" min="10" max="140" step="1">
          </div>

          <div class="field">
            <label>외곽선 굵기</label>
            <input id="cfg_outerLine" type="number" min="1" max="4" step="0.1">
          </div>
          <div class="field">
            <label>내부선 굵기</label>
            <input id="cfg_innerLine" type="number" min="0.8" max="3" step="0.1">
          </div>

          <div class="field">
            <label>상단 2행 높이(px)</label>
            <input id="cfg_topRowH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>일금 행 높이(px)</label>
            <input id="cfg_moneyRowH" type="number" min="40" max="90" step="1">
          </div>

          <div class="field">
            <label>표 헤더 높이(px)</label>
            <input id="cfg_headH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>표 본문 행 높이(px)</label>
            <input id="cfg_rowH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>합계 행 높이(px)</label>
            <input id="cfg_sumH" type="number" min="40" max="90" step="1">
          </div>
          <div class="field">
            <label>표 슬롯(빈줄 포함)</label>
            <input id="cfg_slots" type="number" min="6" max="20" step="1">
          </div>

          <div class="field">
            <label>구분 칸 비율(0~1)</label>
            <input id="cfg_col1" type="number" min="0.30" max="0.60" step="0.01">
          </div>
          <div class="field">
            <label>금액 칸 비율(0~1)</label>
            <input id="cfg_col2" type="number" min="0.18" max="0.40" step="0.01">
          </div>

          <div class="field">
            <label>제목 크기(px)</label>
            <input id="cfg_titleSize" type="number" min="38" max="70" step="1">
          </div>
          <div class="field">
            <label>제목 자간(px)</label>
            <input id="cfg_titleSpacing" type="number" min="0" max="24" step="1">
          </div>

          <div class="field">
            <label>라벨 글자 크기(px)</label>
            <input id="cfg_labelSize" type="number" min="20" max="40" step="1">
          </div>
          <div class="field">
            <label>값 글자 크기(px)</label>
            <input id="cfg_valueSize" type="number" min="20" max="40" step="1">
          </div>
          <div class="field">
            <label>표 글자 크기(px)</label>
            <input id="cfg_tableSize" type="number" min="18" max="36" step="1">
          </div>
          <div class="field">
            <label>하단 날짜 크기(px)</label>
            <input id="cfg_dateSize" type="number" min="18" max="36" step="1">
          </div>
        </div>
      </details>
    </section>

    <!-- 3) 문자 템플릿 + 대표 다운로드 -->
    <section class="section">
      <h2 class="local-h2 local-tight">3) 문자 템플릿 & 결과 다운로드</h2>
      <p class="muted">
        치환: [학교명] [학년] [반] [번호] [이름] [차수] [납입금명] [은행명] [계좌번호] [미납액]
      </p>

      <textarea id="smsTemplate"></textarea>

      <!-- ✅ 정돈: 대표 버튼 1개 + 보조 버튼은 접기 -->
      <div class="btnbar">
        <button class="btn primary" id="btnDownloadAllZip" type="button" disabled>
          전체 결과 ZIP 다운로드 (문구 엑셀 + PNG + PDF)
        </button>
        <button class="btn ghost" id="btnCopyAllSms" type="button" disabled>
          전체 문자 문구 복사(줄바꿈 포함)
        </button>
      </div>

      <details class="shot-details" style="margin-top:12px;">
        <summary class="shot-summary">개별 다운로드(선택)</summary>
        <div class="btnbar">
          <button class="btn ghost" id="btnDownloadXlsxOnly" type="button" disabled>문구 엑셀만(.xlsx)</button>
          <button class="btn ghost" id="btnDownloadPngZipOnly" type="button" disabled>안내문 PNG ZIP만</button>
          <button class="btn ghost" id="btnDownloadPdfOnly" type="button" disabled>안내문 PDF만</button>
        </div>
        <p class="note">보통은 “전체 결과 ZIP” 하나로 끝납니다.</p>
      </details>
    </section>

    <!-- 4) 추출 결과 -->
    <section class="section">
      <h2 class="local-h2 local-tight">4) 추출 결과</h2>

      <h3 class="local-h3 local-tight">행 단위(추출 6개만)</h3>
      <div class="table-wrap">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>학년</th>
              <th>반</th>
              <th>번호</th>
              <th>이름</th>
              <th>납입금명</th>
              <th class="numeric">미납액</th>
            </tr>
          </thead>
          <tbody id="rawTbody">
            <tr><td colspan="6" class="muted">아직 데이터가 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <h3 class="local-h3 local-tight" style="margin-top:18px;">학생별 통합(안내문/문자 생성 단위)</h3>
      <div class="table-wrap">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>학년</th>
              <th>반</th>
              <th>번호</th>
              <th>이름</th>
              <th>납입금명(요약)</th>
              <th class="numeric">총 미납액</th>
            </tr>
          </thead>
          <tbody id="caseTbody">
            <tr><td colspan="6" class="muted">아직 데이터가 없습니다.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 5) 미리보기 -->
    <section class="section">
      <h2 class="local-h2 local-tight">5) 학생 개인별 미리보기</h2>

      <div class="grid two">
        <div class="field">
          <label>학생 선택</label>
          <select id="caseSelect" disabled>
            <option value="">먼저 엑셀을 업로드하세요</option>
          </select>
        </div>
        <div class="field">
          <label>선택 학생 작업</label>
          <div class="btnbar">
            <button class="btn ghost" id="btnOnePng" type="button" disabled>안내문 PNG 1장</button>
            <button class="btn ghost" id="btnCopySms" type="button" disabled>문자 복사</button>
          </div>
        </div>
      </div>

      <div class="preview-grid" style="margin-top:12px;">
        <div class="canvasbox">
          <canvas id="previewCanvas" width="1080" height="1350"></canvas>
          <p class="note">양식 구조는 샘플 “미납안내문” 기준으로 렌더링됩니다.</p>
        </div>

        <div class="card">
          <h3 class="local-h3 local-tight">선택 학생 문자 문구</h3>
          <textarea id="smsPreview" readonly style="min-height: 320px;"></textarea>
          <p class="note">‘문자 복사’ 버튼으로 클립보드에 저장됩니다.</p>
        </div>
      </div>
    </section>

    <p class="muted" style="margin-top:18px;">
      ※ 정적 페이지: 브라우저에서만 동작합니다. 엑셀은 로컬에서만 읽습니다.
    </p>
  </main>

  <script>
    /***********************
     * 공통
     ***********************/
    const STORAGE_KEY = "eduFine_unpaid_notice_allinone_v1";

    const DEFAULT_SMS_TEMPLATE =
`안녕하세요,
[학교명] 행정실입니다.

[학년] [반] [번호] [이름] 학생 [차수] [납입금명] 미납 금액 이체 안내드립니다.

이체하실 계좌: [은행명] [계좌번호] [학교명]
이체하실 금액: [미납액]

원활한 업무처리를 위하여 반드시 학생 이름으로 이체 부탁드립니다.

감사합니다.`;

    const el = (id) => document.getElementById(id);

    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function parseDateInput(value){
      if(!value) return null;
      const [y,m,d] = value.split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
    function fmtKoreanDate(d, pad=false){
      if(!d) return "";
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      const day = d.getDate();
      if(pad){
        return `${y}년 ${String(m).padStart(2,"0")}월 ${String(day).padStart(2,"0")}일`;
      }
      return `${y}년 ${m}월 ${day}일`;
    }

    function setStatus(msg, kind=""){
      const box = el("statusBox");
      box.classList.remove("status-ok","status-err");
      if(kind === "ok") box.classList.add("status-ok");
      if(kind === "err") box.classList.add("status-err");
      box.textContent = msg;
    }

    function disableWhile(btn, on=true){
      if(!btn) return;
      if(on){
        btn.dataset._oldText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "처리중…";
      }else{
        btn.disabled = false;
        if(btn.dataset._oldText) btn.textContent = btn.dataset._oldText;
        delete btn.dataset._oldText;
      }
    }

    function saveSettings(){
      const ids = [
        "schoolName","bankName","accountNumber","roundText","noticeRemark",
        "dueDate","docDate","labelTheme","exportScale","smsTemplate",
        "cfg_boxMargin","cfg_boxBottomMargin","cfg_titleTop","cfg_boxTopGap",
        "cfg_outerLine","cfg_innerLine","cfg_topRowH","cfg_moneyRowH",
        "cfg_headH","cfg_rowH","cfg_sumH","cfg_slots",
        "cfg_col1","cfg_col2","cfg_titleSize","cfg_titleSpacing",
        "cfg_labelSize","cfg_valueSize","cfg_tableSize","cfg_dateSize"
      ];
      const obj = {};
      for(const id of ids){
        obj[id] = el(id)?.value ?? "";
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        for(const [k,v] of Object.entries(obj)){
          if(el(k) && v !== null && v !== undefined) el(k).value = v;
        }
        return true;
      }catch(_){
        return false;
      }
    }

    /***********************
     * ✅ 샘플 프리셋(기본)
     ***********************/
    const SAMPLE_PRESET = {
      labelTheme: "gray",
      exportScale: "1",
      cfg_boxMargin: "86",
      cfg_boxBottomMargin: "78",
      cfg_titleTop: "38",
      cfg_boxTopGap: "28",
      cfg_outerLine: "2.2",
      cfg_innerLine: "1.1",
      cfg_topRowH: "62",
      cfg_moneyRowH: "56",
      cfg_headH: "56",
      cfg_rowH: "56",
      cfg_sumH: "56",
      cfg_slots: "10",
      cfg_col1: "0.44",
      cfg_col2: "0.28",
      cfg_titleSize: "52",
      cfg_titleSpacing: "12",
      cfg_labelSize: "28",
      cfg_valueSize: "28",
      cfg_tableSize: "26",
      cfg_dateSize: "26",
    };

    function applyPreset(preset, save=true){
      for(const [k,v] of Object.entries(preset)){
        if(el(k)) el(k).value = v;
      }
      updatePreview();
      if(save) saveSettings();
    }

    /***********************
     * 상태 데이터
     ***********************/
    let rawRows = [];   // {학년, 반, 번호, 이름, 납입금명, 미납액}
    let cases = [];     // 학생별 통합
    let selectedCaseKey = "";

    /***********************
     * 유틸
     ***********************/
    function toIntMoney(v){
      if(v === null || v === undefined || v === "") return 0;
      const n = Number(v);
      if(Number.isFinite(n)) return Math.round(n);
      const s = String(v).replace(/,/g,"").trim();
      const nn = Number(s);
      return Number.isFinite(nn) ? Math.round(nn) : 0;
    }

    // ✅ 제외: 주간 야간 _ -
    function cleanSchoolToken(s){
      let out = String(s ?? "")
        .replace(/주간/g, "")
        .replace(/야간/g, "")
        .replace(/[_-]/g, "")
        .replace(/\s+/g, " ")
        .trim();
      out = out.replace(/\b\d+\s*번\b/g, "").replace(/\s+/g," ").trim();
      return out;
    }

    function normalizeGradeClass(gradeIn, classIn){
      let g = cleanSchoolToken(gradeIn);
      let c = cleanSchoolToken(classIn);

      const gHas = /(\d+)\s*학년/.test(g);
      const cHas = /(\d+)\s*학년/.test(c);
      if(!gHas && cHas){
        const tmp = g; g = c; c = tmp;
      }

      const m = g.match(/(\d+)\s*학년/);
      if(m){
        const gradePart = `${m[1]}학년`;
        let rest = g.replace(m[0], "").trim().replace(/\s+/g," ");
        g = gradePart;
        if(rest){
          if(!c) c = rest;
          else if(!c.includes(rest)) c = `${rest} ${c}`.trim();
        }
      }
      return { 학년: g, 반: c };
    }

    function parseStudentNo(v){
      const s = String(v ?? "").trim();
      const m = s.match(/(\d{1,3})/);
      return m ? Number(m[1]) : null;
    }

    function normalizeSpacesPerLine(text){
      return String(text ?? "")
        .split("\n")
        .map(line => line.replace(/[ \t]+/g, " ").replace(/\s+$/g,""))
        .join("\n")
        .trim();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function num(id, fallback){
      const v = Number(el(id)?.value);
      return Number.isFinite(v) ? v : fallback;
    }

    function getSlots(){
      return Math.max(6, Math.min(20, Math.floor(num("cfg_slots", 10))));
    }

    function enableActions(enable){
      el("btnDownloadAllZip").disabled = !enable;
      el("btnCopyAllSms").disabled = !enable;

      el("btnDownloadXlsxOnly").disabled = !enable;
      el("btnDownloadPngZipOnly").disabled = !enable;
      el("btnDownloadPdfOnly").disabled = !enable;

      el("btnOnePng").disabled = !enable;
      el("btnCopySms").disabled = !enable;
    }

    /***********************
     * XLSX 파싱(필수 6개만)
     ***********************/
    function normalizeHeader(h){
      return String(h ?? "").trim().replace(/\s+/g,"").replace(/[_-]/g,"_");
    }

    function findHeaderRow(rows){
      const limit = Math.min(rows.length, 30);
      for(let i=0;i<limit;i++){
        const row = (rows[i] || []).map(normalizeHeader);
        const hasName = row.some(x => x.includes("이름"));
        const hasItem = row.some(x => x.includes("납입금명"));
        const hasAmt  = row.some(x => x.includes("미납액"));
        const hasNo   = row.some(x => x === "번호" || x.includes("번호"));
        if(hasName && hasItem && hasAmt && hasNo) return i;
      }
      // fallback (번호가 없더라도 헤더 찾기)
      for(let i=0;i<limit;i++){
        const row = (rows[i] || []).map(normalizeHeader);
        const hasName = row.some(x => x.includes("이름"));
        const hasItem = row.some(x => x.includes("납입금명"));
        const hasAmt  = row.some(x => x.includes("미납액"));
        if(hasName && hasItem && hasAmt) return i;
      }
      return 0;
    }

    function pickIndex(headers, patterns){
      for(const re of patterns){
        const idx = headers.findIndex(h => re.test(h));
        if(idx !== -1) return idx;
      }
      return -1;
    }

    function parseXlsx(arrayBuffer){
      const wb = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
      if(!rows || rows.length === 0) throw new Error("시트에 데이터가 없습니다.");

      const headerRowIdx = findHeaderRow(rows);
      const header = (rows[headerRowIdx] || []).map(normalizeHeader);

      const idxGrade = pickIndex(header, [/주야_계열_학년/i, /주야.*학년/i, /계열.*학년/i, /학년/]);
      const idxClass = pickIndex(header, [/학과_반/i, /^반$/i, /반/]);
      const idxNo    = pickIndex(header, [/^번호$/i, /학번/i, /번호/]);
      const idxName  = pickIndex(header, [/^이름$/i, /성명/i]);
      const idxItem  = pickIndex(header, [/^납입금명$/i, /납입.*명/i]);
      const idxAmt   = pickIndex(header, [/^미납액$/i, /미납.*금/i]);

      if([idxGrade, idxClass, idxNo, idxName, idxItem, idxAmt].some(x => x === -1)){
        throw new Error(
          "필수 컬럼을 찾지 못했습니다.\n" +
          "필요: 주야_계열_학년(또는 학년), 학과_반(또는 반), 번호, 이름, 납입금명, 미납액"
        );
      }

      const out = [];
      for(let r=headerRowIdx+1; r<rows.length; r++){
        const row = rows[r] || [];
        const norm = normalizeGradeClass(row[idxGrade], row[idxClass]);
        const no = parseStudentNo(row[idxNo]);
        const name = String(row[idxName] ?? "").trim();
        const item = String(row[idxItem] ?? "").trim();
        const amt  = toIntMoney(row[idxAmt]);

        if(!norm.학년 && !norm.반 && (no===null) && !name && !item && !amt) continue;
        if(!name || !item) continue;

        out.push({ 학년: norm.학년, 반: norm.반, 번호: no, 이름: name, 납입금명: item, 미납액: amt });
      }
      return out;
    }

    function buildCasesFromRaw(rows){
      const map = new Map();
      for(const rr of rows){
        const key = `${rr.학년}||${rr.반}||${rr.번호 ?? ""}||${rr.이름}`;
        if(!map.has(key)){
          map.set(key, {
            key,
            학년: rr.학년,
            반: rr.반,
            번호: rr.번호,
            이름: rr.이름,
            items: [],
            total: 0
          });
        }
        const c = map.get(key);
        c.items.push({ 납입금명: rr.납입금명, 미납액: rr.미납액 });
        c.total += rr.미납액;
      }

      const list = Array.from(map.values());
      for(const c of list){
        // 항목 요약(중복 제거)
        const uniq = [];
        const seen = new Set();
        for(const it of c.items){
          if(!seen.has(it.납입금명)){
            seen.add(it.납입금명);
            uniq.push(it.납입금명);
          }
        }
        c.납입금명요약 = uniq.join(", ");
      }

      function gradeNum(g){
        const m = String(g||"").match(/(\d+)/);
        return m ? Number(m[1]) : 999;
      }

      list.sort((a,b) => {
        const ag = gradeNum(a.학년), bg = gradeNum(b.학년);
        if(ag !== bg) return ag - bg;
        const ac = (a.반||"").localeCompare(b.반||"", "ko");
        if(ac !== 0) return ac;
        const an = (a.번호 ?? 999) - (b.번호 ?? 999);
        if(an !== 0) return an;
        return (a.이름||"").localeCompare((b.이름||""), "ko");
      });

      return list;
    }

    /***********************
     * 문자 생성
     ***********************/
    function buildSmsForCase(c){
      const schoolName = el("schoolName").value.trim();
      const bankName   = el("bankName").value.trim();
      const accountNum = el("accountNumber").value.trim();
      const roundText  = el("roundText").value.trim();
      const template   = el("smsTemplate").value;

      const repl = {
        "[학교명]": schoolName,
        "[학년]": c.학년 ?? "",
        "[반]": c.반 ?? "",
        "[번호]": (c.번호 ?? "") ? `${c.번호}번` : "",
        "[이름]": c.이름 ?? "",
        "[차수]": roundText,
        "[납입금명]": c.납입금명요약 ?? "",
        "[은행명]": bankName,
        "[계좌번호]": accountNum,
        "[미납액]": (c.total||0).toLocaleString("ko-KR"),
      };

      let msg = String(template ?? "");
      for(const k of Object.keys(repl)){
        msg = msg.split(k).join(repl[k] ?? "");
      }
      return normalizeSpacesPerLine(msg);
    }

    function buildAllSmsText(){
      return cases.map(c => {
        const header = `${c.학년} ${c.반} ${c.번호 ?? ""}번 ${c.이름}`.replace(/\s+/g," ").trim();
        return `▶ ${header}\n${buildSmsForCase(c)}\n`;
      }).join("\n").trim();
    }

    /***********************
     * 안내문 렌더링(캔버스)
     ***********************/
    const DIG_KOR = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];
    function fourToKor(n){
      const s = String(n).padStart(4,"0");
      const units = ["천","백","십",""];
      let out = "";
      for(let i=0;i<4;i++){
        const d = Number(s[i]);
        if(d === 0) continue;
        out += DIG_KOR[d] + units[i];
      }
      return out;
    }
    function numberToKor(n){
      n = Math.floor(Math.abs(Number(n) || 0));
      if(n === 0) return "영";
      const big = ["", "만", "억", "조", "경"];
      let idx = 0;
      let out = "";
      while(n > 0){
        const part = n % 10000;
        if(part > 0){
          out = fourToKor(part) + big[idx] + out;
        }
        n = Math.floor(n/10000);
        idx++;
      }
      return out;
    }

    function getNoticeLabelColor(){
      const theme = el("labelTheme").value;
      if(theme === "gray") return "#BFBFBF";
      return "#D9EEFF";
    }

    function drawSpacedText(ctx, text, centerX, yBaseline, spacingPx){
      const chars = Array.from(String(text || ""));
      const widths = chars.map(ch => ctx.measureText(ch).width);
      const total = widths.reduce((a,b)=>a+b,0) + spacingPx * Math.max(0, chars.length-1);
      let x = centerX - total/2;
      for(let i=0;i<chars.length;i++){
        ctx.fillText(chars[i], x, yBaseline);
        x += widths[i] + spacingPx;
      }
      return total;
    }

    function renderNoticeToCanvas(caseObj, canvas, opts={}){
      const baseW = opts.baseW || 1080;
      const baseH = opts.baseH || 1350;
      const scale = opts.scale || 1;

      canvas.width = Math.round(baseW * scale);
      canvas.height = Math.round(baseH * scale);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(scale, 0, 0, scale, 0, 0);

      const family = `"맑은 고딕","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif`;

      const schoolName = el("schoolName").value.trim();
      const roundText = el("roundText").value.trim();
      const remarkRaw = el("noticeRemark").value.trim();
      const remarkText = remarkRaw || roundText;

      const dueDate = parseDateInput(el("dueDate").value);
      const docDate = parseDateInput(el("docDate").value) || new Date();
      const principalTitle = schoolName ? (schoolName + "장") : "학교장";

      const boxMargin = num("cfg_boxMargin", 86);
      const boxBottomMargin = num("cfg_boxBottomMargin", 78);
      const titleTop = num("cfg_titleTop", 38);
      const boxTopGap = num("cfg_boxTopGap", 28);

      const outerLine = num("cfg_outerLine", 2.2);
      const innerLine = num("cfg_innerLine", 1.1);

      const topRowH = num("cfg_topRowH", 62);
      const moneyRowH = num("cfg_moneyRowH", 56);

      const headH = num("cfg_headH", 56);
      const rowH = num("cfg_rowH", 56);
      const sumH = num("cfg_sumH", 56);
      const slots = getSlots();

      const col1Ratio = Math.max(0.30, Math.min(0.60, num("cfg_col1", 0.44)));
      const col2Ratio = Math.max(0.18, Math.min(0.40, num("cfg_col2", 0.28)));

      const titleSize = num("cfg_titleSize", 52);
      const titleSpacing = num("cfg_titleSpacing", 12);

      const labelSize = num("cfg_labelSize", 28);
      const valueSize = num("cfg_valueSize", 28);
      const tableSize = num("cfg_tableSize", 26);
      const dateSize = num("cfg_dateSize", 26);

      const labelBg = getNoticeLabelColor();
      const stroke = "#222";

      // 배경
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,baseW,baseH);

      // 제목 + 밑줄
      ctx.fillStyle = "#111";
      ctx.textAlign = "center";
      ctx.textBaseline = "alphabetic";
      ctx.font = `800 ${Math.round(titleSize)}px ${family}`;
      const titleBaseline = titleTop + titleSize + 6;
      const titleWidth = drawSpacedText(ctx, "미납안내문", baseW/2, titleBaseline, titleSpacing);

      const underlineY = titleBaseline + 14;
      ctx.strokeStyle = stroke;
      ctx.lineWidth = outerLine;
      ctx.beginPath();
      ctx.moveTo(baseW/2 - titleWidth/2, underlineY);
      ctx.lineTo(baseW/2 + titleWidth/2, underlineY);
      ctx.stroke();

      // 박스
      const boxX = boxMargin;
      const boxY = underlineY + boxTopGap;
      const boxW = baseW - boxMargin*2;
      const boxH = baseH - boxY - boxBottomMargin;

      ctx.lineWidth = outerLine;
      ctx.strokeStyle = stroke;
      ctx.strokeRect(boxX, boxY, boxW, boxH);

      function cell(x, y, w, h, fill){
        if(fill){
          ctx.fillStyle = fill;
          ctx.fillRect(x,y,w,h);
        }
        ctx.strokeStyle = stroke;
        ctx.lineWidth = innerLine;
        ctx.strokeRect(x,y,w,h);
      }

      let y = boxY;

      const labelWRatio = 0.34;
      const labelW = Math.round(boxW * labelWRatio);
      const valW = boxW - labelW;

      ctx.textBaseline = "middle";

      // 1행: 학번 (샘플처럼: "1학년 달반 - 2번")
      cell(boxX, y, labelW, topRowH, labelBg);
      cell(boxX+labelW, y, valW, topRowH, "#fff");
      ctx.fillStyle="#111";
      ctx.textAlign="center";
      ctx.font = `700 ${labelSize}px ${family}`;
      ctx.fillText("학   번", boxX + labelW/2, y + topRowH/2);

      ctx.textAlign="left";
      const noText = (caseObj.번호 ?? "") ? `${caseObj.번호}번` : "";
      const classLine = `${caseObj.학년 ?? ""} ${caseObj.반 ?? ""} - ${noText}`.replace(/\s+/g," ").trim();
      let curSize = valueSize;
      ctx.font = `600 ${curSize}px ${family}`;
      while(curSize > 18 && ctx.measureText(classLine).width > (valW - 36)){
        curSize -= 1;
        ctx.font = `600 ${curSize}px ${family}`;
      }
      ctx.fillText(classLine, boxX + labelW + 18, y + topRowH/2);
      y += topRowH;

      // 2행: 이름
      cell(boxX, y, labelW, topRowH, labelBg);
      cell(boxX+labelW, y, valW, topRowH, "#fff");
      ctx.textAlign="center";
      ctx.font = `700 ${labelSize}px ${family}`;
      ctx.fillText("이   름", boxX + labelW/2, y + topRowH/2);

      ctx.textAlign="left";
      ctx.font = `600 ${valueSize}px ${family}`;
      ctx.fillText(String(caseObj.이름||""), boxX + labelW + 18, y + topRowH/2);
      y += topRowH;

      // 일금
      cell(boxX, y, boxW, moneyRowH, "#fff");
      ctx.textAlign="center";
      ctx.font = `600 ${valueSize}px ${family}`;
      ctx.fillText(`일금 ${numberToKor(caseObj.total)} 원정`, boxX + boxW/2, y + moneyRowH/2);
      y += moneyRowH;

      // 표(구분/금액/비고)
      const col1 = Math.round(boxW * col1Ratio);
      const col2 = Math.round(boxW * col2Ratio);
      const col3 = boxW - col1 - col2;

      cell(boxX, y, col1, headH, labelBg);
      cell(boxX+col1, y, col2, headH, labelBg);
      cell(boxX+col1+col2, y, col3, headH, labelBg);

      ctx.textAlign="center";
      ctx.font = `700 ${tableSize}px ${family}`;
      ctx.fillText("구   분", boxX + col1/2, y + headH/2);
      ctx.fillText("금   액", boxX + col1 + col2/2, y + headH/2);
      ctx.fillText("비   고", boxX + col1 + col2 + col3/2, y + headH/2);
      y += headH;

      for(let i=0;i<slots;i++){
        cell(boxX, y, col1, rowH, "#fff");
        cell(boxX+col1, y, col2, rowH, "#fff");
        cell(boxX+col1+col2, y, col3, rowH, "#fff");

        const it = caseObj.items[i];
        if(it){
          let nm = String(it.납입금명||"");
          let s = tableSize;
          ctx.textAlign="center";
          ctx.font = `600 ${s}px ${family}`;
          while(s > 16 && ctx.measureText(nm).width > (col1 - 18)){
            s -= 1;
            ctx.font = `600 ${s}px ${family}`;
          }
          ctx.fillText(nm, boxX + col1/2, y + rowH/2);

          ctx.textAlign="right";
          ctx.font = `600 ${tableSize}px ${family}`;
          ctx.fillText((it.미납액||0).toLocaleString("ko-KR"), boxX + col1 + col2 - 14, y + rowH/2);

          if(remarkText){
            ctx.textAlign="center";
            ctx.fillText(remarkText, boxX + col1 + col2 + col3/2, y + rowH/2);
          }
        }
        y += rowH;
      }

      // 합계
      cell(boxX, y, col1, sumH, "#fff");
      cell(boxX+col1, y, col2, sumH, "#fff");
      cell(boxX+col1+col2, y, col3, sumH, "#fff");

      ctx.font = `700 ${tableSize}px ${family}`;
      ctx.textAlign="center";
      ctx.fillText("합   계", boxX + col1/2, y + sumH/2);

      ctx.textAlign="right";
      ctx.fillText(caseObj.total.toLocaleString("ko-KR"), boxX + col1 + col2 - 14, y + sumH/2);
      y += sumH;

      // 하단 문구
      ctx.font = `600 23px ${family}`;
      ctx.textAlign="left";
      ctx.textBaseline="alphabetic";
      ctx.fillText("※ 위의 금액이 미납되어 있습니다.", boxX + 10, y + 34);

      const dueLine = dueDate
        ? `${fmtKoreanDate(dueDate, false)} 까지 금액을 납부하여 주십시오.`
        : "납부 기한을 입력하면 여기에 표시됩니다.";
      ctx.fillText(dueLine, boxX + 10, y + 66);

      // 날짜/학교장
      const boxBottom = boxY + boxH;
      ctx.textAlign="center";
      ctx.font = `600 ${dateSize}px ${family}`;
      ctx.fillText(fmtKoreanDate(docDate, true), boxX + boxW/2, boxBottom - 150);

      ctx.font = `800 34px ${family}`;
      ctx.fillText(principalTitle, boxX + boxW/2, boxBottom - 92);

      ctx.restore();
      return canvas;
    }

    function chunkItemsForPages(caseObj){
      const slots = getSlots();
      const items = Array.isArray(caseObj.items) ? caseObj.items : [];
      const pages = [];
      if(items.length === 0){
        pages.push({ ...caseObj, items: [] });
        return pages;
      }
      for(let i=0; i<items.length; i+=slots){
        pages.push({ ...caseObj, items: items.slice(i, i+slots) });
      }
      return pages;
    }

    /***********************
     * 테이블/선택/프리뷰
     ***********************/
    function renderRawTable(){
      const tbody = el("rawTbody");
      tbody.innerHTML = "";
      if(!rawRows.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }
      for(const r of rawRows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.학년)}</td>
          <td>${escapeHtml(r.반)}</td>
          <td>${r.번호 ?? ""}</td>
          <td>${escapeHtml(r.이름)}</td>
          <td>${escapeHtml(r.납입금명)}</td>
          <td class="numeric">${(r.미납액||0).toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderCaseTable(){
      const tbody = el("caseTbody");
      tbody.innerHTML = "";
      if(!cases.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }
      for(const c of cases){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(c.학년)}</td>
          <td>${escapeHtml(c.반)}</td>
          <td>${c.번호 ?? ""}</td>
          <td>${escapeHtml(c.이름)}</td>
          <td>${escapeHtml(c.납입금명요약)}</td>
          <td class="numeric">${c.total.toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function populateCaseSelect(){
      const sel = el("caseSelect");
      sel.innerHTML = "";
      if(!cases.length){
        sel.disabled = true;
        selectedCaseKey = "";
        sel.innerHTML = `<option value="">먼저 엑셀을 업로드하세요</option>`;
        return;
      }
      sel.disabled = false;
      for(const c of cases){
        const opt = document.createElement("option");
        opt.value = c.key;
        const label = `${c.학년} ${c.반} ${c.번호 ?? ""}번 ${c.이름}`.replace(/\s+/g," ").trim();
        opt.textContent = `${label} (${c.total.toLocaleString("ko-KR")}원)`;
        sel.appendChild(opt);
      }
      selectedCaseKey = cases[0].key;
      sel.value = selectedCaseKey;
    }

    function getSelectedCase(){
      return cases.find(x => x.key === selectedCaseKey) || null;
    }

    function updatePreview(){
      const c = getSelectedCase();
      const canvas = el("previewCanvas");
      if(!c){
        canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
        el("smsPreview").value = "";
        return;
      }
      renderNoticeToCanvas(c, canvas, { baseW: 1080, baseH: 1350, scale: 1 });
      el("smsPreview").value = buildSmsForCase(c);
    }

    function renderAll(){
      renderRawTable();
      renderCaseTable();
      populateCaseSelect();
      enableActions(!!cases.length);
      updatePreview();
    }

    /***********************
     * 다운로드 유틸
     ***********************/
    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function canvasToBlob(canvas, type="image/png", quality){
      return new Promise((resolve) => canvas.toBlob((b) => resolve(b), type, quality));
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    /***********************
     * ✅ 문구 엑셀 생성(.xlsx)
     ***********************/
    function buildMessageWorkbookArrayBuffer(){
      const schoolName = el("schoolName").value.trim();
      const bankName   = el("bankName").value.trim();
      const accountNum = el("accountNumber").value.trim();
      const roundText  = el("roundText").value.trim();

      const wb = XLSX.utils.book_new();

      // 시트1: 문자문구
      const header1 = ["학년","반","번호","이름","납입금명(요약)","총 미납액","문자문구"];
      const rows1 = cases.map(c => ([
        c.학년 ?? "",
        c.반 ?? "",
        (c.번호 ?? "") ? `${c.번호}번` : "",
        c.이름 ?? "",
        c.납입금명요약 ?? "",
        c.total ?? 0,
        buildSmsForCase(c),
      ]));
      const ws1 = XLSX.utils.aoa_to_sheet([header1, ...rows1]);

      // 보기 좋게 열 폭
      ws1["!cols"] = [
        { wch: 10 }, { wch: 10 }, { wch: 8 }, { wch: 10 }, { wch: 30 }, { wch: 12 }, { wch: 60 }
      ];
      XLSX.utils.book_append_sheet(wb, ws1, "문자문구");

      // 시트2: 추출원본(6개만)
      const header2 = ["학년","반","번호","이름","납입금명","미납액"];
      const rows2 = rawRows.map(r => ([
        r.학년 ?? "",
        r.반 ?? "",
        (r.번호 ?? "") ? `${r.번호}번` : "",
        r.이름 ?? "",
        r.납입금명 ?? "",
        r.미납액 ?? 0,
      ]));
      const ws2 = XLSX.utils.aoa_to_sheet([header2, ...rows2]);
      ws2["!cols"] = [{wch:10},{wch:10},{wch:8},{wch:10},{wch:22},{wch:12}];
      XLSX.utils.book_append_sheet(wb, ws2, "추출원본");

      // 메타를 따로 넣고 싶으면 시트 추가 가능(하지만 지금은 심플하게)
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      return out;
    }

    function downloadXlsxOnly(){
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const buf = buildMessageWorkbookArrayBuffer();
      const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      downloadBlob(blob, `미납_문구_${dateISO}.xlsx`);
    }

    /***********************
     * PNG ZIP만
     ***********************/
    async function buildPngZipBlob(progressCb){
      const zip = new JSZip();
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const scale = Number(el("exportScale").value) || 1;

      const noticesFolder = zip.folder("notices");
      const tempCanvas = document.createElement("canvas");

      let totalPages = 0;
      const allPages = [];
      for(const c of cases){
        const pages = chunkItemsForPages(c);
        for(let i=0;i<pages.length;i++){
          allPages.push({ base: c, page: pages[i], idx: i+1, cnt: pages.length });
        }
      }
      totalPages = allPages.length;

      for(let k=0;k<allPages.length;k++){
        const { base, page, idx, cnt } = allPages[k];

        renderNoticeToCanvas(page, tempCanvas, { baseW: 1080, baseH: 1350, scale });
        const blob = await canvasToBlob(tempCanvas, "image/png");

        const safeName = `${dateISO}_${base.학년}${base.반}_${base.번호 ?? ""}번_${base.이름}`
          .replace(/[\/\\?%*:|"<>]/g, "_")
          .replace(/\s+/g, " ")
          .trim();

        const suffix = (cnt > 1) ? `_p${idx}` : "";
        noticesFolder.file(`${safeName}${suffix}.png`, blob);

        if(progressCb) progressCb(k+1, totalPages);
        await sleep(0);
      }

      return await zip.generateAsync({ type: "blob" });
    }

    async function downloadPngZipOnly(){
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      setStatus(`PNG ZIP 생성중…`, "");
      const zipBlob = await buildPngZipBlob((cur,total) => {
        setStatus(`PNG ZIP 생성중… (${cur}/${total})`, "");
      });
      downloadBlob(zipBlob, `미납안내문_PNG_${dateISO}.zip`);
      setStatus("PNG ZIP 다운로드 준비 완료 ✅", "ok");
    }

    /***********************
     * PDF만
     ***********************/
    async function buildPdfBlob(progressCb){
      const { jsPDF } = window.jspdf;

      const pageW = 1080, pageH = 1350;
      const doc = new jsPDF({ orientation: "portrait", unit: "px", format: [pageW, pageH] });

      const scale = Number(el("exportScale").value) || 1;
      const tempCanvas = document.createElement("canvas");

      const allPages = [];
      for(const c of cases){
        const pages = chunkItemsForPages(c);
        for(let i=0;i<pages.length;i++){
          allPages.push({ page: pages[i] });
        }
      }

      for(let i=0;i<allPages.length;i++){
        const p = allPages[i].page;

        renderNoticeToCanvas(p, tempCanvas, { baseW: pageW, baseH: pageH, scale });
        const imgData = tempCanvas.toDataURL("image/jpeg", 0.92);

        if(i > 0) doc.addPage([pageW, pageH], "portrait");
        doc.addImage(imgData, "JPEG", 0, 0, pageW, pageH);

        if(progressCb) progressCb(i+1, allPages.length);
        await sleep(0);
      }

      const ab = doc.output("arraybuffer");
      return new Blob([ab], { type: "application/pdf" });
    }

    async function downloadPdfOnly(){
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);

      setStatus("PDF 생성중…", "");
      const pdfBlob = await buildPdfBlob((cur,total) => {
        setStatus(`PDF 생성중… (${cur}/${total})`, "");
      });
      downloadBlob(pdfBlob, `미납안내문_${dateISO}.pdf`);
      setStatus("PDF 다운로드 준비 완료 ✅", "ok");
    }

    /***********************
     * ✅ 전체 결과 ZIP(엑셀 + PNG + PDF)
     ***********************/
    async function downloadAllInOneZip(){
      const btn = el("btnDownloadAllZip");
      disableWhile(btn, true);

      try{
        const d = parseDateInput(el("docDate").value) || new Date();
        const dateISO = toISODate(d);

        const zip = new JSZip();

        // 1) 엑셀
        setStatus("전체 ZIP 생성중… (1/3) 문구 엑셀 생성", "");
        const xlsxBuf = buildMessageWorkbookArrayBuffer();
        zip.file(`미납_문구_${dateISO}.xlsx`, xlsxBuf);

        // 2) PNG들
        setStatus("전체 ZIP 생성중… (2/3) 안내문 PNG 생성", "");
        const noticesFolder = zip.folder("notices");
        const scale = Number(el("exportScale").value) || 1;
        const tempCanvas = document.createElement("canvas");

        const pagesList = [];
        for(const c of cases){
          const pages = chunkItemsForPages(c);
          for(let i=0;i<pages.length;i++){
            pagesList.push({ base: c, page: pages[i], idx: i+1, cnt: pages.length });
          }
        }

        for(let i=0;i<pagesList.length;i++){
          const { base, page, idx, cnt } = pagesList[i];

          renderNoticeToCanvas(page, tempCanvas, { baseW: 1080, baseH: 1350, scale });
          const blob = await canvasToBlob(tempCanvas, "image/png");

          const safeName = `${dateISO}_${base.학년}${base.반}_${base.번호 ?? ""}번_${base.이름}`
            .replace(/[\/\\?%*:|"<>]/g, "_")
            .replace(/\s+/g, " ")
            .trim();

          const suffix = (cnt > 1) ? `_p${idx}` : "";
          noticesFolder.file(`${safeName}${suffix}.png`, blob);

          setStatus(`전체 ZIP 생성중… (2/3) 안내문 PNG 생성 (${i+1}/${pagesList.length})`, "");
          await sleep(0);
        }

        // 3) PDF
        setStatus("전체 ZIP 생성중… (3/3) 안내문 PDF 생성", "");
        const pdfBlob = await buildPdfBlob((cur,total) => {
          setStatus(`전체 ZIP 생성중… (3/3) 안내문 PDF 생성 (${cur}/${total})`, "");
        });
        zip.file(`미납안내문_${dateISO}.pdf`, pdfBlob);

        // ZIP 완성
        setStatus("전체 ZIP 압축 중…", "");
        const zipBlob = await zip.generateAsync({ type: "blob" });
        downloadBlob(zipBlob, `미납_전체결과_${dateISO}.zip`);
        setStatus("전체 결과 ZIP 다운로드 준비 완료 ✅", "ok");

      }catch(err){
        console.error(err);
        setStatus(String(err?.message || err), "err");
      }finally{
        disableWhile(btn, false);
      }
    }

    /***********************
     * 선택 학생 1장 PNG / 복사
     ***********************/
    async function downloadOnePng(){
      const c = getSelectedCase();
      if(!c) return;

      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const scale = Number(el("exportScale").value) || 1;

      const canvas = document.createElement("canvas");
      const pages = chunkItemsForPages(c);
      const first = pages[0];

      renderNoticeToCanvas(first, canvas, { baseW: 1080, baseH: 1350, scale });
      const blob = await canvasToBlob(canvas, "image/png");

      const safeName = `${dateISO}_${c.학년}${c.반}_${c.번호 ?? ""}번_${c.이름}`
        .replace(/[\/\\?%*:|"<>]/g, "_")
        .replace(/\s+/g, " ")
        .trim();

      downloadBlob(blob, `${safeName}.png`);
    }

    async function copySelectedSms(){
      const c = getSelectedCase();
      if(!c) return;
      const msg = buildSmsForCase(c);
      try{
        await navigator.clipboard.writeText(msg);
        setStatus("선택 학생 문자 문구를 클립보드에 복사했습니다 ✅", "ok");
      }catch(_){
        el("smsPreview").focus();
        el("smsPreview").select();
        document.execCommand("copy");
        setStatus("복사 완료(대체 방식) ✅", "ok");
      }
    }

    async function copyAllSms(){
      const text = buildAllSmsText();
      try{
        await navigator.clipboard.writeText(text);
        setStatus("전체 문자 문구를 클립보드에 복사했습니다 ✅", "ok");
      }catch(_){
        // fallback: 임시 textarea
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        setStatus("전체 복사 완료(대체 방식) ✅", "ok");
      }
    }

    /***********************
     * 업로드 처리(파일 선택/드롭 공통)
     ***********************/
    async function handleExcelFile(file){
      if(!file) return;
      try{
        setStatus(`엑셀 읽는 중…\n- 파일: ${file.name}`, "");
        const buf = await file.arrayBuffer();
        rawRows = parseXlsx(buf);

        if(!rawRows.length){
          throw new Error("추출된 데이터가 없습니다. (이름/납입금명/미납액이 있는 행을 확인하세요)");
        }

        cases = buildCasesFromRaw(rawRows);
        renderAll();
        setStatus(`추출 완료 ✅\n- 행 단위: ${rawRows.length}건\n- 학생별 통합: ${cases.length}건`, "ok");
        saveSettings();
      }catch(err){
        console.error(err);
        rawRows = [];
        cases = [];
        selectedCaseKey = "";
        renderAll();
        el("smsPreview").value = "";
        setStatus(String(err?.message || err), "err");
      }
    }

    /***********************
     * 드래그&드롭 UI
     ***********************/
    function setupDropzone(){
      const dz = el("dropZone");
      const input = el("excelFile");

      function openPicker(){ input.click(); }

      dz.addEventListener("click", openPicker);
      dz.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openPicker();
        }
      });

      input.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        await handleExcelFile(file);
        // 같은 파일 다시 선택 가능하게
        input.value = "";
      });

      dz.addEventListener("dragenter", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dz.classList.add("is-dragover");
      });
      dz.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dz.classList.add("is-dragover");
      });
      dz.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dz.classList.remove("is-dragover");
      });
      dz.addEventListener("drop", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        dz.classList.remove("is-dragover");

        const file = e.dataTransfer?.files?.[0];
        if(!file) return;
        if(!/\.xlsx?$/.test(file.name.toLowerCase())){
          setStatus("엑셀(.xlsx/.xls) 파일만 업로드할 수 있습니다.", "err");
          return;
        }
        await handleExcelFile(file);
      });
    }

    /***********************
     * 이벤트
     ***********************/
    el("btnApplySamplePreset").addEventListener("click", () => {
      applyPreset(SAMPLE_PRESET, true);
      setStatus("샘플 프리셋 적용 완료 ✅", "ok");
    });

    el("btnLoadSample").addEventListener("click", () => {
      // 샘플(번호 포함)
      rawRows = [
        { 학년:"1학년", 반:"달반", 번호:2, 이름:"김가온", 납입금명:"우유급식비", 미납액:15710 },
        { 학년:"3학년", 반:"달반", 번호:5, 이름:"노승민", 납입금명:"우유급식비", 미납액:44170 },
        { 학년:"3학년", 반:"별반", 번호:4, 이름:"김민지", 납입금명:"우유급식비", 미납액:36290 },
        { 학년:"3학년", 반:"별반", 번호:4, 이름:"김민지", 납입금명:"우유급식비", 미납액:44170 },
      ];
      cases = buildCasesFromRaw(rawRows);
      renderAll();
      setStatus("샘플 데이터 로드 완료 ✅", "ok");
      saveSettings();
    });

    el("btnReset").addEventListener("click", () => {
      rawRows = [];
      cases = [];
      selectedCaseKey = "";

      el("schoolName").value = "";
      el("bankName").value = "";
      el("accountNumber").value = "";
      el("roundText").value = "";
      el("noticeRemark").value = "";
      el("dueDate").value = "";
      el("docDate").value = toISODate(new Date());
      el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;

      applyPreset(SAMPLE_PRESET, false);

      localStorage.removeItem(STORAGE_KEY);
      saveSettings();

      renderAll();
      el("previewCanvas").getContext("2d").clearRect(0,0,el("previewCanvas").width, el("previewCanvas").height);
      el("smsPreview").value = "";
      setStatus("초기화 완료. 엑셀을 다시 업로드하세요.", "");
    });

    el("caseSelect").addEventListener("change", (ev) => {
      selectedCaseKey = ev.target.value;
      updatePreview();
      saveSettings();
    });

    el("btnDownloadAllZip").addEventListener("click", () => cases.length && downloadAllInOneZip());
    el("btnCopyAllSms").addEventListener("click", () => cases.length && copyAllSms());

    el("btnDownloadXlsxOnly").addEventListener("click", () => cases.length && downloadXlsxOnly());
    el("btnDownloadPngZipOnly").addEventListener("click", () => cases.length && downloadPngZipOnly());
    el("btnDownloadPdfOnly").addEventListener("click", () => cases.length && downloadPdfOnly());

    el("btnOnePng").addEventListener("click", async () => downloadOnePng());
    el("btnCopySms").addEventListener("click", async () => copySelectedSms());

    // 변경 감지 → 미리보기 업데이트 + 저장
    const watchIds = [
      "schoolName","bankName","accountNumber","roundText","noticeRemark",
      "dueDate","docDate","labelTheme","exportScale","smsTemplate",
      "cfg_boxMargin","cfg_boxBottomMargin","cfg_titleTop","cfg_boxTopGap",
      "cfg_outerLine","cfg_innerLine","cfg_topRowH","cfg_moneyRowH",
      "cfg_headH","cfg_rowH","cfg_sumH","cfg_slots",
      "cfg_col1","cfg_col2","cfg_titleSize","cfg_titleSpacing",
      "cfg_labelSize","cfg_valueSize","cfg_tableSize","cfg_dateSize"
    ];
    for(const id of watchIds){
      el(id).addEventListener("input", () => { updatePreview(); saveSettings(); });
      el(id).addEventListener("change", () => { updatePreview(); saveSettings(); });
    }

    /***********************
     * 초기 로드
     ***********************/
    (function init(){
      setupDropzone();

      const hasSaved = loadSettings();
      if(!el("smsTemplate").value.trim()) el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;
      if(!el("docDate").value) el("docDate").value = toISODate(new Date());

      if(!hasSaved){
        applyPreset(SAMPLE_PRESET, false);
        saveSettings();
      }

      enableActions(false);
      renderAll();
      setStatus("대기중… 엑셀 드래그/클릭 업로드 또는 샘플 데이터로 시작하세요.", "");
    })();
  </script>

  <!-- ✅ 요청하신 공통 JS (</body> 직전) -->
  <script src="/static/disable-copy.js"></script>
  <script src="/static/footer.js"></script>
  <script src="/static/global-loader.js?v=1"></script>
</body>
</html>
