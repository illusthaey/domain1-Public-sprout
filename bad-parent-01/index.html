<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>세입 미납자 독촉 업무 경감 기능</title>

  <!-- ✅ 사이트 공통 CSS 그대로 -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- 라이브러리(CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>

    #excelFile { display:none; }

    .dropzone{
      border: 2px dashed #d4d4d8;
      background: #fafafa;
      border-radius: 12px;
      padding: 14px 16px;
      cursor: pointer;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
    }
    .dropzone:hover{ background:#f9fafb; }
    .dropzone:active{ transform: scale(0.998); }
    .dropzone.is-dragover{
      border-color: #6b7280;
      background: #eef2ff;
    }
    .dropzone .dz-title{
      font-weight: 700;
      color: #111;
      margin: 0 0 6px;
      font-size: 1.02rem;
    }
    .dropzone .dz-sub{
      margin: 0;
      color: #555;
      font-size: 0.95rem;
    }
    .dropzone .dz-sub code{
      background:#fff;
      border:1px solid #e5e7eb;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.92rem;
    }
    .dropzone .dz-file{
      margin: 10px 0 0;
      font-size: 0.95rem;
      color: #111;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btnbar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .status-box{
      white-space: pre-line;
      font-size: 1rem;
      color: #333;
    }
    .status-ok{
      border-color: #bbf7d0 !important;
      background: #f0fdf4 !important;
    }
    .status-err{
      border-color: #fecaca !important;
      background: #fff1f2 !important;
    }

    textarea{
      width: 100%;
      max-width: 100%;
      resize: vertical;
      overflow-y: auto;
    }
    #smsTemplate{ min-height: 320px; }
    #smsPreview{ min-height: 360px; }

    .canvasbox{
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #fff;
      padding: 12px;
    }
    canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #e5e5e5;
    }

    .preview-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .preview-grid{
        grid-template-columns: 1fr 1fr;
        align-items: start;
      }
    }

    .mini-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-top: 10px;
    }

    /* footer 위 홈 버튼: 흰 배경 고정 */
    .home-link-wrap{
      background:#fff;
      max-width: 880px;
      margin: 16px auto 0;
      padding: 0 16px 10px;
      display:flex;
      justify-content:flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <main class="container">
    <h1>미수납자 독촉 문자 문구 및 미납 안내장 파일 생성기</h1>
    <p class="muted">
      ·에듀파인 학교회계-수입관리-출납관리-미수납관리에서 미수납대상 엑셀파일 다운로드하고 여기에 올리면, 학생별 독촉 문자 문구 및 미납안내장 PDF/PNG 파일 둘 다 자동 생성해줌.
    </p>

    <!-- 1) 업로드 -->
    <section class="section">
      <div class="row between">
        <h2 class="local-h2 local-tight" style="margin:0;">1. 미수납 대상 정보 업로드</h2>
      </div>

      <p class="muted local-tight">
        ·학년, 반, 번호, 이름, 미납 내역, 미납 금액 데이터만 추출함.
      </p>

      <input id="excelFile" type="file" accept=".xlsx,.xls" />

      <div id="dropZone" class="dropzone" role="button" tabindex="0" aria-label="엑셀 파일 드롭존">
        <p class="dz-title">엑셀 파일을 드래그해서 놓기</p>
        <p class="dz-sub">또는 여기를 마우스로 클릭하면 폴더 경로 열림. <code>.xlsx</code></p>
        <p class="dz-file" id="selectedFileName">선택된 파일 없음</p>
      </div>

      <div class="btnbar">
        <button class="btn primary" id="btnExtract" type="button" disabled>미수납자 정보 추출하기</button>
        <button class="btn" id="btnClearFile" type="button" disabled>파일 지우기</button>
        <button class="btn" id="btnReset" type="button">추출내역 삭제하기</button>
      </div>

      <div id="statusBox" class="card status-box" style="margin-top:12px;">
        기다리는 중. 엑셀 파일을 올리고 나서 추출하기를 누르십시오.
      </div>
    </section>

    <!-- 2) 설정 -->
    <section class="section">
      <div class="row between">
        <h2 class="local-h2 local-tight" style="margin:0;">2. 기본 설정</h2>
        <div class="row gap">
          <button class="btn" id="btnApplyPreset" type="button">기본 프리셋 적용</button>
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>학교명</label>
          <input id="schoolName" type="text" placeholder="예시: 교행초등학교" />
        </div>
        <div class="field">
          <label>부과 년월 (선택입력)</label>
          <input id="roundText" type="text" placeholder="예시: 2025년 2학기" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>은행명</label>
          <input id="bankName" type="text" placeholder="예) 농협" />
        </div>
        <div class="field">
          <label>계좌번호</label>
          <input id="accountNumber" type="text" placeholder="예) 000-0000-0000-00" />
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>안내문 라벨 색상</label>
          <select id="labelTheme">
            <option value="gray" selected>샘플(회색)</option>
            <option value="blue">파스텔 블루</option>
          </select>
        </div>
        <div class="field">
          <label>내보내기 배율(선명도)</label>
          <select id="exportScale">
            <option value="1" selected>1x (기본)</option>
            <option value="2">2x (더 선명)</option>
          </select>
        </div>
      </div>

      <div class="grid two">
        <div class="field">
          <label>납부 기한(안내문 문구)</label>
          <input id="dueDate" type="date" />
        </div>
        <div class="field">
          <label>안내문 작성일(하단 날짜)</label>
          <input id="docDate" type="date" />
        </div>
      </div>

      <details class="shot-details">
        <summary class="shot-summary">고급 설정(미세 조정)</summary>

        <div class="mini-grid">
          <div class="field"><label>박스 여백(px)</label><input id="cfg_boxMargin" type="number" min="20" max="140" step="1"></div>
          <div class="field"><label>박스 하단 여백(px)</label><input id="cfg_boxBottomMargin" type="number" min="20" max="160" step="1"></div>
          <div class="field"><label>제목 위 여백(px)</label><input id="cfg_titleTop" type="number" min="10" max="120" step="1"></div>
          <div class="field"><label>밑줄→박스 간격(px)</label><input id="cfg_boxTopGap" type="number" min="10" max="140" step="1"></div>

          <div class="field"><label>외곽선 굵기</label><input id="cfg_outerLine" type="number" min="1" max="4" step="0.1"></div>
          <div class="field"><label>내부선 굵기</label><input id="cfg_innerLine" type="number" min="0.8" max="3" step="0.1"></div>

          <div class="field"><label>상단 2행 높이(px)</label><input id="cfg_topRowH" type="number" min="40" max="90" step="1"></div>
          <div class="field"><label>일금 행 높이(px)</label><input id="cfg_moneyRowH" type="number" min="40" max="90" step="1"></div>

          <div class="field"><label>표 헤더 높이(px)</label><input id="cfg_headH" type="number" min="40" max="90" step="1"></div>
          <div class="field"><label>표 본문 행 높이(px)</label><input id="cfg_rowH" type="number" min="40" max="90" step="1"></div>
          <div class="field"><label>합계 행 높이(px)</label><input id="cfg_sumH" type="number" min="40" max="90" step="1"></div>
          <div class="field"><label>표 슬롯(빈줄 포함)</label><input id="cfg_slots" type="number" min="6" max="20" step="1"></div>

          <div class="field"><label>구분 칸 비율(0~1)</label><input id="cfg_col1" type="number" min="0.30" max="0.60" step="0.01"></div>
          <div class="field"><label>금액 칸 비율(0~1)</label><input id="cfg_col2" type="number" min="0.18" max="0.40" step="0.01"></div>

          <div class="field"><label>제목 크기(px)</label><input id="cfg_titleSize" type="number" min="38" max="70" step="1"></div>
          <div class="field"><label>제목 자간(px)</label><input id="cfg_titleSpacing" type="number" min="0" max="24" step="1"></div>

          <div class="field"><label>라벨 글자 크기(px)</label><input id="cfg_labelSize" type="number" min="20" max="40" step="1"></div>
          <div class="field"><label>값 글자 크기(px)</label><input id="cfg_valueSize" type="number" min="20" max="40" step="1"></div>
          <div class="field"><label>표 글자 크기(px)</label><input id="cfg_tableSize" type="number" min="18" max="36" step="1"></div>
          <div class="field"><label>하단 날짜 크기(px)</label><input id="cfg_dateSize" type="number" min="18" max="36" step="1"></div>
        </div>
      </details>
    </section>

    <!-- 3) 문자 템플릿 & 다운로드 -->
    <section class="section">
      <h2 class="local-h2 local-tight">3) 문자 템플릿 & 다운로드</h2>
      <p class="muted">
        치환: [학교명] [학년] [반] [번호] [이름] [차수] [납입금명] [은행명] [계좌번호] [미납액]
      </p>

      <textarea id="smsTemplate"></textarea>

      <div class="btnbar">
        <button class="btn primary" id="btnDownloadAllZip" type="button" disabled>
          전체 결과 ZIP 다운로드 (문구 엑셀 + PNG + PDF)
        </button>
        <button class="btn" id="btnCopyAllSms" type="button" disabled>
          전체 문자 문구 복사
        </button>
      </div>

      <details class="shot-details" style="margin-top:12px;">
        <summary class="shot-summary">개별 다운로드(선택)</summary>
        <div class="btnbar">
          <button class="btn" id="btnDownloadXlsxOnly" type="button" disabled>문구 엑셀만(.xlsx)</button>
          <button class="btn" id="btnDownloadPngZipOnly" type="button" disabled>안내문 PNG ZIP만</button>
          <button class="btn" id="btnDownloadPdfOnly" type="button" disabled>안내문 PDF만</button>
        </div>
      </details>
    </section>

    <!-- 4) 추출 결과 -->
    <section class="section">
      <h2 class="local-h2 local-tight">4) 추출 결과</h2>

      <h3 class="local-h3 local-tight">행 단위(7개만)</h3>
      <div class="table-wrap">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>학년</th>
              <th>반</th>
              <th>번호</th>
              <th>이름</th>
              <th>납입금명</th>
              <th>차수(행)</th>
              <th class="numeric">미납액</th>
            </tr>
          </thead>
          <tbody id="rawTbody">
            <tr><td colspan="7" class="muted">아직 데이터가 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <h3 class="local-h3 local-tight" style="margin-top:18px;">학생별 통합</h3>
      <div class="table-wrap">
        <table class="sheetlike">
          <thead>
            <tr>
              <th>학년</th>
              <th>반</th>
              <th>번호</th>
              <th>이름</th>
              <th>차수(요약)</th>
              <th>납입금명(요약)</th>
              <th class="numeric">총 미납액</th>
            </tr>
          </thead>
          <tbody id="caseTbody">
            <tr><td colspan="7" class="muted">아직 데이터가 없습니다.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 5) 미리보기 -->
    <section class="section">
      <h2 class="local-h2 local-tight">5) 학생 개인별 미리보기</h2>

      <div class="grid two">
        <div class="field">
          <label>학생 선택</label>
          <select id="caseSelect" disabled>
            <option value="">먼저 엑셀을 업로드하고 추출하세요</option>
          </select>
        </div>
        <div class="field">
          <label>선택 학생 작업</label>
          <div class="btnbar">
            <button class="btn" id="btnOnePng" type="button" disabled>안내문 PNG 1장</button>
            <button class="btn" id="btnCopySms" type="button" disabled>문자 복사</button>
          </div>
        </div>
      </div>

      <div class="preview-grid" style="margin-top:12px;">
        <div class="canvasbox">
          <canvas id="previewCanvas" width="1080" height="1350"></canvas>
          <p class="note">엑셀에서 추출된 값이 그대로 안내문에 렌더링됩니다.</p>
        </div>

        <div class="card">
          <h3 class="local-h3 local-tight">선택 학생 문자 문구</h3>
          <textarea id="smsPreview" readonly></textarea>
          <p class="note">‘문자 복사’ 버튼으로 클립보드에 저장됩니다.</p>
        </div>
      </div>
    </section>

    <p class="muted" style="margin-top:18px;">
      ※ 정적 페이지: 브라우저에서만 동작합니다. 엑셀은 로컬에서만 읽습니다.
    </p>
  </main>

  <!-- ✅ 요청: 메인으로 돌아가기 버튼은 footer 위에, 흰색으로 항상 표시 -->
  <div class="home-link-wrap">
    <a class="btn" href="/">메인으로 돌아가기</a>
  </div>

  <script>
    /***********************
     * 공통
     ***********************/
    const STORAGE_KEY = "eduFine_unpaid_notice_fixed_render_v2";

    const DEFAULT_SMS_TEMPLATE =
`안녕하세요,
[학교명] 행정실입니다.

[학년] [반] [번호] [이름] 학생 [차수] [납입금명] 미납 금액 이체 안내드립니다.

이체하실 계좌: [은행명] [계좌번호] [학교명]
이체하실 금액: [미납액]

원활한 업무처리를 위하여 반드시 학생 이름으로 이체 부탁드립니다.

감사합니다.`;

    const el = (id) => document.getElementById(id);

    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function parseDateInput(value){
      if(!value) return null;
      const [y,m,d] = value.split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
    function fmtKoreanDate(d, pad=false){
      if(!d) return "";
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      const day = d.getDate();
      if(pad){
        return `${y}년 ${String(m).padStart(2,"0")}월 ${String(day).padStart(2,"0")}일`;
      }
      return `${y}년 ${m}월 ${day}일`;
    }

    function setStatus(msg, kind=""){
      const box = el("statusBox");
      box.classList.remove("status-ok","status-err");
      if(kind === "ok") box.classList.add("status-ok");
      if(kind === "err") box.classList.add("status-err");
      box.textContent = msg;
    }

    function disableWhile(btn, on=true, text="처리중…"){
      if(!btn) return;
      if(on){
        btn.dataset._oldText = btn.textContent;
        btn.disabled = true;
        btn.textContent = text;
      }else{
        btn.disabled = false;
        if(btn.dataset._oldText) btn.textContent = btn.dataset._oldText;
        delete btn.dataset._oldText;
      }
    }

    function saveSettings(){
      const ids = [
        "schoolName","bankName","accountNumber","roundText",
        "dueDate","docDate","labelTheme","exportScale","smsTemplate",
        "cfg_boxMargin","cfg_boxBottomMargin","cfg_titleTop","cfg_boxTopGap",
        "cfg_outerLine","cfg_innerLine","cfg_topRowH","cfg_moneyRowH",
        "cfg_headH","cfg_rowH","cfg_sumH","cfg_slots",
        "cfg_col1","cfg_col2","cfg_titleSize","cfg_titleSpacing",
        "cfg_labelSize","cfg_valueSize","cfg_tableSize","cfg_dateSize"
      ];
      const obj = {};
      for(const id of ids){
        obj[id] = el(id)?.value ?? "";
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        for(const [k,v] of Object.entries(obj)){
          if(el(k) && v !== null && v !== undefined) el(k).value = v;
        }
        return true;
      }catch(_){
        return false;
      }
    }

    /***********************
     * 기본 프리셋(레이아웃)
     ***********************/
    const BASE_PRESET = {
      labelTheme: "gray",
      exportScale: "1",
      cfg_boxMargin: "86",
      cfg_boxBottomMargin: "78",
      cfg_titleTop: "38",
      cfg_boxTopGap: "28",
      cfg_outerLine: "2.2",
      cfg_innerLine: "1.1",
      cfg_topRowH: "62",
      cfg_moneyRowH: "56",
      cfg_headH: "56",
      cfg_rowH: "56",
      cfg_sumH: "56",
      cfg_slots: "10",
      cfg_col1: "0.44",
      cfg_col2: "0.28",
      cfg_titleSize: "52",
      cfg_titleSpacing: "12",
      cfg_labelSize: "28",
      cfg_valueSize: "28",
      cfg_tableSize: "26",
      cfg_dateSize: "26",
    };

    function applyPreset(preset, save=true){
      for(const [k,v] of Object.entries(preset)){
        if(el(k)) el(k).value = v;
      }
      updatePreview();
      if(save) saveSettings();
    }

    /***********************
     * 상태 데이터
     ***********************/
    let pendingFile = null;   // 업로드만 된 파일(추출 전)
    let rawRows = [];         // {학년, 반, 번호, 이름, 납입금명, 차수, 미납액}
    let cases = [];           // 학생별 통합
    let selectedCaseKey = "";

    /***********************
     * 유틸
     ***********************/
    function toIntMoney(v){
      if(v === null || v === undefined || v === "") return 0;
      const n = Number(v);
      if(Number.isFinite(n)) return Math.round(n);
      const s = String(v).replace(/,/g,"").trim();
      const nn = Number(s);
      return Number.isFinite(nn) ? Math.round(nn) : 0;
    }

    // 제외: 주간 야간 _ -
    function cleanSchoolToken(s){
      let out = String(s ?? "")
        .replace(/주간/g, "")
        .replace(/야간/g, "")
        .replace(/[_-]/g, "")
        .replace(/\s+/g, " ")
        .trim();
      out = out.replace(/\b\d+\s*번\b/g, "").replace(/\s+/g," ").trim();
      return out;
    }

    function normalizeGradeClass(gradeIn, classIn){
      let g = cleanSchoolToken(gradeIn);
      let c = cleanSchoolToken(classIn);

      const gHas = /(\d+)\s*학년/.test(g);
      const cHas = /(\d+)\s*학년/.test(c);
      if(!gHas && cHas){
        const tmp = g; g = c; c = tmp;
      }

      const m = g.match(/(\d+)\s*학년/);
      if(m){
        const gradePart = `${m[1]}학년`;
        let rest = g.replace(m[0], "").trim().replace(/\s+/g," ");
        g = gradePart;
        if(rest){
          if(!c) c = rest;
          else if(!c.includes(rest)) c = `${rest} ${c}`.trim();
        }
      }
      return { 학년: g, 반: c };
    }

    function parseStudentNo(v){
      const s = String(v ?? "").trim();
      const m = s.match(/(\d{1,3})/);
      return m ? Number(m[1]) : null;
    }

    function normalizeSpacesPerLine(text){
      return String(text ?? "")
        .split("\n")
        .map(line => line.replace(/[ \t]+/g, " ").replace(/\s+$/g,""))
        .join("\n")
        .trim();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function num(id, fallback){
      const v = Number(el(id)?.value);
      return Number.isFinite(v) ? v : fallback;
    }

    function getSlots(){
      return Math.max(6, Math.min(20, Math.floor(num("cfg_slots", 10))));
    }

    function enableActions(enable){
      el("btnDownloadAllZip").disabled = !enable;
      el("btnCopyAllSms").disabled = !enable;

      el("btnDownloadXlsxOnly").disabled = !enable;
      el("btnDownloadPngZipOnly").disabled = !enable;
      el("btnDownloadPdfOnly").disabled = !enable;

      el("btnOnePng").disabled = !enable;
      el("btnCopySms").disabled = !enable;
    }

    function clearResults(){
      rawRows = [];
      cases = [];
      selectedCaseKey = "";
      renderAll();
      enableActions(false);
      el("smsPreview").value = "";
      const canvas = el("previewCanvas");
      canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
    }

    function setPendingFile(file){
      pendingFile = file || null;
      el("selectedFileName").textContent = pendingFile ? pendingFile.name : "선택된 파일 없음";
      el("btnExtract").disabled = !pendingFile;
      el("btnClearFile").disabled = !pendingFile;

      clearResults();

      if(pendingFile){
        setStatus(
          `파일 선택됨 ✅\n- ${pendingFile.name}\n\n이제 [추출하기] 버튼을 누르면 추출합니다.`,
          ""
        );
      }else{
        setStatus("대기중… 엑셀을 올린 뒤 추출하기를 누르세요.", "");
      }
    }

    /***********************
     * XLSX 파싱(필요 7개만)
     ***********************/
    function normalizeHeader(h){
      return String(h ?? "").trim().replace(/\s+/g,"").replace(/[_-]/g,"_");
    }

    function findHeaderRow(rows){
      const limit = Math.min(rows.length, 40);
      for(let i=0;i<limit;i++){
        const row = (rows[i] || []).map(normalizeHeader);
        const hasName = row.some(x => /이름|성명/.test(x));
        const hasItem = row.some(x => /납입.*명|부과.*명|항목명|납입금명/.test(x));
        const hasAmt  = row.some(x => /미납/.test(x));
        if(hasName && hasItem && hasAmt) return i;
      }
      return 0;
    }

    function pickIndexSmart(headersNorm, candidates){
      for(const cand of candidates){
        const inc = cand.include || [];
        const exc = cand.exclude || [];
        const idx = headersNorm.findIndex(h =>
          inc.some(re => re.test(h)) && !exc.some(re => re.test(h))
        );
        if(idx !== -1) return idx;
      }
      return -1;
    }

    function parseXlsx(arrayBuffer){
      const wb = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
      if(!rows || rows.length === 0) throw new Error("시트에 데이터가 없습니다.");

      const headerRowIdx = findHeaderRow(rows);
      const headerRaw = (rows[headerRowIdx] || []).map(v => String(v ?? "").trim());
      const headerNorm = headerRaw.map(normalizeHeader);

      const idxGrade = pickIndexSmart(headerNorm, [
        { include: [/주야.*학년/i, /계열.*학년/i, /^학년$/i, /학년/i] },
      ]);
      const idxClass = pickIndexSmart(headerNorm, [
        { include: [/학과.*반/i, /^반$/i, /반/i], exclude: [/방법/i] },
      ]);
      const idxNo = pickIndexSmart(headerNorm, [
        { include: [/^번호$/i, /^출석번호$/i, /^학생번호$/i, /^학번$/i] },
        { include: [/출석번호/i, /학생번호/i, /학번/i, /번호/i], exclude: [/계좌/i, /통장/i, /가상/i, /연락/i, /전화/i, /휴대/i] },
      ]);
      const idxName = pickIndexSmart(headerNorm, [
        { include: [/^이름$/i, /^성명$/i] },
        { include: [/학생.*이름/i, /이름/i, /성명/i], exclude: [/보호자/i, /학부모/i, /담당/i, /결재/i] },
      ]);
      const idxItem = pickIndexSmart(headerNorm, [
        { include: [/^납입금명$/i] },
        { include: [/납입.*명/i, /부과.*명/i, /항목명/i, /과금.*명/i], exclude: [/계좌/i, /은행/i] },
      ]);
      const idxAmt = pickIndexSmart(headerNorm, [
        { include: [/^미납액$/i] },
        { include: [/미납.*액/i, /미납.*금/i, /미납/i], exclude: [/일수/i] },
      ]);

      // ✅ 차수(행) 컬럼: 있으면 추출, 없으면 "" (UI 기본값 사용)
      const idxTerm = pickIndexSmart(headerNorm, [
        { include: [/^차수$/i, /차수/i] },
        { include: [/학기/i, /년도학기/i, /학년도/i], exclude: [/미사용/i] },
        { include: [/부과기간/i, /적용기간/i, /부과.*기간/i] },
        { include: [/비고/i], exclude: [/결재/i] },
      ]);

      if([idxGrade, idxClass, idxNo, idxName, idxItem, idxAmt].some(x => x === -1)){
        throw new Error(
          "필수 컬럼을 찾지 못했습니다.\n" +
          "필요: 학년/반/번호/이름/납입금명/미납액\n" +
          "※ 엑셀 헤더명이 특이하면 헤더 줄을 확인해주세요."
        );
      }

      const out = [];
      for(let r=headerRowIdx+1; r<rows.length; r++){
        const row = rows[r] || [];
        const norm = normalizeGradeClass(row[idxGrade], row[idxClass]);
        const no = parseStudentNo(row[idxNo]);
        const name = String(row[idxName] ?? "").trim();
        const item = String(row[idxItem] ?? "").trim();
        const amt  = toIntMoney(row[idxAmt]);

        let term = "";
        if(idxTerm !== -1){
          term = String(row[idxTerm] ?? "")
            .replace(/[_-]/g, " ")
            .replace(/\s+/g, " ")
            .trim();
        }

        if(!norm.학년 && !norm.반 && (no===null) && !name && !item && !amt && !term) continue;
        if(!name || !item) continue;

        out.push({ 학년: norm.학년, 반: norm.반, 번호: no, 이름: name, 납입금명: item, 차수: term, 미납액: amt });
      }

      const meta = {
        sheetName,
        headerRowIdx,
        matchedHeaders: {
          학년: headerRaw[idxGrade] || `(col ${idxGrade+1})`,
          반: headerRaw[idxClass] || `(col ${idxClass+1})`,
          번호: headerRaw[idxNo] || `(col ${idxNo+1})`,
          이름: headerRaw[idxName] || `(col ${idxName+1})`,
          납입금명: headerRaw[idxItem] || `(col ${idxItem+1})`,
          미납액: headerRaw[idxAmt] || `(col ${idxAmt+1})`,
          차수: (idxTerm !== -1) ? (headerRaw[idxTerm] || `(col ${idxTerm+1})`) : "(없음 → 차수 기본값 사용)",
        }
      };

      return { rows: out, meta };
    }

    function buildCasesFromRaw(rows){
      const map = new Map();
      for(const rr of rows){
        const key = `${rr.학년}||${rr.반}||${rr.번호 ?? ""}||${rr.이름}`;
        if(!map.has(key)){
          map.set(key, {
            key,
            학년: rr.학년,
            반: rr.반,
            번호: rr.번호,
            이름: rr.이름,
            items: [],
            total: 0
          });
        }
        const c = map.get(key);
        c.items.push({ 납입금명: rr.납입금명, 미납액: rr.미납액, 차수: rr.차수 || "" });
        c.total += rr.미납액;
      }

      const list = Array.from(map.values());
      for(const c of list){
        // 납입금명 요약
        const uniqItems = [];
        const seenItem = new Set();
        for(const it of c.items){
          if(!seenItem.has(it.납입금명)){
            seenItem.add(it.납입금명);
            uniqItems.push(it.납입금명);
          }
        }
        c.납입금명요약 = uniqItems.join(", ");

        // 차수 요약
        const uniqTerms = [];
        const seenTerm = new Set();
        for(const it of c.items){
          const t = String(it.차수 || "").trim();
          if(!t) continue;
          if(!seenTerm.has(t)){
            seenTerm.add(t);
            uniqTerms.push(t);
          }
        }
        c.차수요약 = uniqTerms.join(", ");
      }

      function gradeNum(g){
        const m = String(g||"").match(/(\d+)/);
        return m ? Number(m[1]) : 999;
      }

      list.sort((a,b) => {
        const ag = gradeNum(a.학년), bg = gradeNum(b.학년);
        if(ag !== bg) return ag - bg;
        const ac = (a.반||"").localeCompare(b.반||"", "ko");
        if(ac !== 0) return ac;
        const an = (a.번호 ?? 999) - (b.번호 ?? 999);
        if(an !== 0) return an;
        return (a.이름||"").localeCompare((b.이름||""), "ko");
      });

      return list;
    }

    /***********************
     * 문자 생성
     ***********************/
    function buildSmsForCase(c){
      const schoolName = el("schoolName").value.trim();
      const bankName   = el("bankName").value.trim();
      const accountNum = el("accountNumber").value.trim();
      const roundText  = el("roundText").value.trim();
      const template   = el("smsTemplate").value;

      // ✅ 차수는 "엑셀 차수요약" 우선, 없으면 UI 기본값
      const termText = (c.차수요약 && c.차수요약.trim()) ? c.차수요약.trim() : roundText;

      const repl = {
        "[학교명]": schoolName,
        "[학년]": c.학년 ?? "",
        "[반]": c.반 ?? "",
        "[번호]": (c.번호 ?? "") ? `${c.번호}번` : "",
        "[이름]": c.이름 ?? "",
        "[차수]": termText,
        "[납입금명]": c.납입금명요약 ?? "",
        "[은행명]": bankName,
        "[계좌번호]": accountNum,
        "[미납액]": (c.total||0).toLocaleString("ko-KR"),
      };

      let msg = String(template ?? "");
      for(const k of Object.keys(repl)){
        msg = msg.split(k).join(repl[k] ?? "");
      }
      return normalizeSpacesPerLine(msg);
    }

    function buildAllSmsText(){
      return cases.map(c => {
        const header = `${c.학년} ${c.반} ${c.번호 ?? ""}번 ${c.이름}`.replace(/\s+/g," ").trim();
        return `▶ ${header}\n${buildSmsForCase(c)}\n`;
      }).join("\n").trim();
    }

    /***********************
     * 안내문 렌더링(캔버스)
     * ✅ FIX: 셀 채우기(fillStyle)가 텍스트 색을 덮지 않도록
     *        cell()에서 save/restore 처리 -> 텍스트가 흰색으로 찍히는 버그 해결
     ***********************/
    const DIG_KOR = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];
    function fourToKor(n){
      const s = String(n).padStart(4,"0");
      const units = ["천","백","십",""];
      let out = "";
      for(let i=0;i<4;i++){
        const d = Number(s[i]);
        if(d === 0) continue;
        out += DIG_KOR[d] + units[i];
      }
      return out;
    }
    function numberToKor(n){
      n = Math.floor(Math.abs(Number(n) || 0));
      if(n === 0) return "영";
      const big = ["", "만", "억", "조", "경"];
      let idx = 0;
      let out = "";
      while(n > 0){
        const part = n % 10000;
        if(part > 0){
          out = fourToKor(part) + big[idx] + out;
        }
        n = Math.floor(n/10000);
        idx++;
      }
      return out;
    }

    function getNoticeLabelColor(){
      const theme = el("labelTheme").value;
      if(theme === "gray") return "#BFBFBF";
      return "#D9EEFF";
    }

    function drawSpacedText(ctx, text, centerX, yBaseline, spacingPx){
      const chars = Array.from(String(text || ""));
      const widths = chars.map(ch => ctx.measureText(ch).width);
      const total = widths.reduce((a,b)=>a+b,0) + spacingPx * Math.max(0, chars.length-1);
      let x = centerX - total/2;
      for(let i=0;i<chars.length;i++){
        ctx.fillText(chars[i], x, yBaseline);
        x += widths[i] + spacingPx;
      }
      return total;
    }

    function renderNoticeToCanvas(caseObj, canvas, opts={}){
      const baseW = opts.baseW || 1080;
      const baseH = opts.baseH || 1350;
      const scale = opts.scale || 1;

      canvas.width = Math.round(baseW * scale);
      canvas.height = Math.round(baseH * scale);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(scale, 0, 0, scale, 0, 0);

      const family = `"맑은 고딕","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif`;
      const TEXT = "#111";
      const stroke = "#222";

      const schoolName = el("schoolName").value.trim();
      const roundText = el("roundText").value.trim();

      const dueDate = parseDateInput(el("dueDate").value);
      const docDate = parseDateInput(el("docDate").value) || new Date();
      const principalTitle = schoolName ? (schoolName + "장") : "학교장";

      const boxMargin = num("cfg_boxMargin", 86);
      const boxBottomMargin = num("cfg_boxBottomMargin", 78);
      const titleTop = num("cfg_titleTop", 38);
      const boxTopGap = num("cfg_boxTopGap", 28);

      const outerLine = num("cfg_outerLine", 2.2);
      const innerLine = num("cfg_innerLine", 1.1);

      const topRowH = num("cfg_topRowH", 62);
      const moneyRowH = num("cfg_moneyRowH", 56);

      const headH = num("cfg_headH", 56);
      const rowH = num("cfg_rowH", 56);
      const sumH = num("cfg_sumH", 56);
      const slots = getSlots();

      const col1Ratio = Math.max(0.30, Math.min(0.60, num("cfg_col1", 0.44)));
      const col2Ratio = Math.max(0.18, Math.min(0.40, num("cfg_col2", 0.28)));

      const titleSize = num("cfg_titleSize", 52);
      const titleSpacing = num("cfg_titleSpacing", 12);

      const labelSize = num("cfg_labelSize", 28);
      const valueSize = num("cfg_valueSize", 28);
      const tableSize = num("cfg_tableSize", 26);
      const dateSize = num("cfg_dateSize", 26);

      const labelBg = getNoticeLabelColor();

      // 배경
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,baseW,baseH);

      // 제목 + 밑줄
      ctx.fillStyle = TEXT;
      ctx.textAlign = "center";
      ctx.textBaseline = "alphabetic";
      ctx.font = `800 ${Math.round(titleSize)}px ${family}`;
      const titleBaseline = titleTop + titleSize + 6;
      const titleWidth = drawSpacedText(ctx, "미납안내문", baseW/2, titleBaseline, titleSpacing);

      const underlineY = titleBaseline + 14;
      ctx.strokeStyle = stroke;
      ctx.lineWidth = outerLine;
      ctx.beginPath();
      ctx.moveTo(baseW/2 - titleWidth/2, underlineY);
      ctx.lineTo(baseW/2 + titleWidth/2, underlineY);
      ctx.stroke();

      // 박스
      const boxX = boxMargin;
      const boxY = underlineY + boxTopGap;
      const boxW = baseW - boxMargin*2;
      const boxH = baseH - boxY - boxBottomMargin;

      ctx.lineWidth = outerLine;
      ctx.strokeStyle = stroke;
      ctx.strokeRect(boxX, boxY, boxW, boxH);

      function cell(x, y, w, h, fill){
        if(fill){
          ctx.save();
          ctx.fillStyle = fill;
          ctx.fillRect(x,y,w,h);
          ctx.restore();
        }
        ctx.save();
        ctx.strokeStyle = stroke;
        ctx.lineWidth = innerLine;
        ctx.strokeRect(x,y,w,h);
        ctx.restore();
      }

      let y = boxY;
      const labelWRatio = 0.34;
      const labelW = Math.round(boxW * labelWRatio);
      const valW = boxW - labelW;

      ctx.textBaseline = "middle";

      // 1행: 학번
      cell(boxX, y, labelW, topRowH, labelBg);
      cell(boxX+labelW, y, valW, topRowH, "#fff");

      ctx.fillStyle = TEXT;
      ctx.textAlign="center";
      ctx.font = `700 ${labelSize}px ${family}`;
      ctx.fillText("학   번", boxX + labelW/2, y + topRowH/2);

      ctx.textAlign="left";
      const noText = (caseObj.번호 ?? "") ? `${caseObj.번호}번` : "";
      const classLine = `${caseObj.학년 ?? ""} ${caseObj.반 ?? ""} - ${noText}`.replace(/\s+/g," ").trim();
      let curSize = valueSize;
      ctx.font = `600 ${curSize}px ${family}`;
      while(curSize > 18 && ctx.measureText(classLine).width > (valW - 36)){
        curSize -= 1;
        ctx.font = `600 ${curSize}px ${family}`;
      }
      ctx.fillText(classLine, boxX + labelW + 18, y + topRowH/2);
      y += topRowH;

      // 2행: 이름
      cell(boxX, y, labelW, topRowH, labelBg);
      cell(boxX+labelW, y, valW, topRowH, "#fff");

      ctx.fillStyle = TEXT;
      ctx.textAlign="center";
      ctx.font = `700 ${labelSize}px ${family}`;
      ctx.fillText("이   름", boxX + labelW/2, y + topRowH/2);

      ctx.textAlign="left";
      ctx.font = `600 ${valueSize}px ${family}`;
      ctx.fillText(String(caseObj.이름||""), boxX + labelW + 18, y + topRowH/2);
      y += topRowH;

      // 일금
      cell(boxX, y, boxW, moneyRowH, "#fff");
      ctx.fillStyle = TEXT;
      ctx.textAlign="center";
      ctx.font = `600 ${valueSize}px ${family}`;
      ctx.fillText(`일금 ${numberToKor(caseObj.total)} 원정`, boxX + boxW/2, y + moneyRowH/2);
      y += moneyRowH;

      // 표(구분/금액/비고)
      const col1 = Math.round(boxW * col1Ratio);
      const col2 = Math.round(boxW * col2Ratio);
      const col3 = boxW - col1 - col2;

      cell(boxX, y, col1, headH, labelBg);
      cell(boxX+col1, y, col2, headH, labelBg);
      cell(boxX+col1+col2, y, col3, headH, labelBg);

      ctx.fillStyle = TEXT;
      ctx.textAlign="center";
      ctx.font = `700 ${tableSize}px ${family}`;
      ctx.fillText("구   분", boxX + col1/2, y + headH/2);
      ctx.fillText("금   액", boxX + col1 + col2/2, y + headH/2);
      ctx.fillText("비   고", boxX + col1 + col2 + col3/2, y + headH/2);
      y += headH;

      for(let i=0;i<slots;i++){
        cell(boxX, y, col1, rowH, "#fff");
        cell(boxX+col1, y, col2, rowH, "#fff");
        cell(boxX+col1+col2, y, col3, rowH, "#fff");

        const it = caseObj.items[i];
        if(it){
          ctx.fillStyle = TEXT;

          // 구분
          let nm = String(it.납입금명||"");
          let s = tableSize;
          ctx.textAlign="center";
          ctx.font = `600 ${s}px ${family}`;
          while(s > 16 && ctx.measureText(nm).width > (col1 - 18)){
            s -= 1;
            ctx.font = `600 ${s}px ${family}`;
          }
          ctx.fillText(nm, boxX + col1/2, y + rowH/2);

          // 금액
          ctx.textAlign="right";
          ctx.font = `600 ${tableSize}px ${family}`;
          ctx.fillText((it.미납액||0).toLocaleString("ko-KR"), boxX + col1 + col2 - 14, y + rowH/2);

          // 비고(행 차수 우선, 없으면 차수 기본값)
          const remark = (String(it.차수 || "").trim()) || (roundText || "");
          if(remark){
            ctx.textAlign="center";
            ctx.fillText(remark, boxX + col1 + col2 + col3/2, y + rowH/2);
          }
        }
        y += rowH;
      }

      // 합계
      cell(boxX, y, col1, sumH, "#fff");
      cell(boxX+col1, y, col2, sumH, "#fff");
      cell(boxX+col1+col2, y, col3, sumH, "#fff");

      ctx.fillStyle = TEXT;
      ctx.font = `700 ${tableSize}px ${family}`;
      ctx.textAlign="center";
      ctx.fillText("합   계", boxX + col1/2, y + sumH/2);

      ctx.textAlign="right";
      ctx.fillText(caseObj.total.toLocaleString("ko-KR"), boxX + col1 + col2 - 14, y + sumH/2);
      y += sumH;

      // 하단 문구
      ctx.fillStyle = TEXT;
      ctx.font = `600 23px ${family}`;
      ctx.textAlign="left";
      ctx.textBaseline="alphabetic";
      ctx.fillText("※ 위의 금액이 미납되어 있습니다.", boxX + 10, y + 34);

      const dueLine = dueDate
        ? `${fmtKoreanDate(dueDate, false)} 까지 금액을 납부하여 주십시오.`
        : "납부 기한을 입력하면 여기에 표시됩니다.";
      ctx.fillText(dueLine, boxX + 10, y + 66);

      // 날짜/학교장
      const boxBottom = boxY + boxH;
      ctx.textAlign="center";
      ctx.font = `600 ${dateSize}px ${family}`;
      ctx.fillText(fmtKoreanDate(docDate, true), boxX + boxW/2, boxBottom - 150);

      ctx.font = `800 34px ${family}`;
      ctx.fillText(principalTitle, boxX + boxW/2, boxBottom - 92);

      ctx.restore();
      return canvas;
    }

    function chunkItemsForPages(caseObj){
      const slots = getSlots();
      const items = Array.isArray(caseObj.items) ? caseObj.items : [];
      const pages = [];
      if(items.length === 0){
        pages.push({ ...caseObj, items: [] });
        return pages;
      }
      for(let i=0; i<items.length; i+=slots){
        pages.push({ ...caseObj, items: items.slice(i, i+slots) });
      }
      return pages;
    }

    /***********************
     * 렌더(테이블/셀렉트/프리뷰)
     ***********************/
    function renderRawTable(){
      const tbody = el("rawTbody");
      tbody.innerHTML = "";
      if(!rawRows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }
      for(const r of rawRows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.학년)}</td>
          <td>${escapeHtml(r.반)}</td>
          <td>${r.번호 ?? ""}</td>
          <td>${escapeHtml(r.이름)}</td>
          <td>${escapeHtml(r.납입금명)}</td>
          <td>${escapeHtml(r.차수 || "")}</td>
          <td class="numeric">${(r.미납액||0).toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderCaseTable(){
      const tbody = el("caseTbody");
      tbody.innerHTML = "";
      if(!cases.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">아직 데이터가 없습니다.</td></tr>`;
        return;
      }
      for(const c of cases){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(c.학년)}</td>
          <td>${escapeHtml(c.반)}</td>
          <td>${c.번호 ?? ""}</td>
          <td>${escapeHtml(c.이름)}</td>
          <td>${escapeHtml(c.차수요약 || "")}</td>
          <td>${escapeHtml(c.납입금명요약 || "")}</td>
          <td class="numeric">${c.total.toLocaleString("ko-KR")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function populateCaseSelect(){
      const sel = el("caseSelect");
      sel.innerHTML = "";
      if(!cases.length){
        sel.disabled = true;
        selectedCaseKey = "";
        sel.innerHTML = `<option value="">먼저 엑셀을 업로드하고 추출하세요</option>`;
        return;
      }
      sel.disabled = false;
      for(const c of cases){
        const opt = document.createElement("option");
        opt.value = c.key;
        const label = `${c.학년} ${c.반} ${c.번호 ?? ""}번 ${c.이름}`.replace(/\s+/g," ").trim();
        opt.textContent = `${label} (${c.total.toLocaleString("ko-KR")}원)`;
        sel.appendChild(opt);
      }
      selectedCaseKey = cases[0].key;
      sel.value = selectedCaseKey;
    }

    function getSelectedCase(){
      return cases.find(x => x.key === selectedCaseKey) || null;
    }

    function updatePreview(){
      const c = getSelectedCase();
      const canvas = el("previewCanvas");
      if(!c){
        canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
        el("smsPreview").value = "";
        return;
      }
      renderNoticeToCanvas(c, canvas, { baseW: 1080, baseH: 1350, scale: 1 });
      el("smsPreview").value = buildSmsForCase(c);
    }

    function renderAll(){
      renderRawTable();
      renderCaseTable();
      populateCaseSelect();
      enableActions(!!cases.length);
      updatePreview();
    }

    /***********************
     * 다운로드(전체 ZIP / 개별)
     ***********************/
    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function canvasToBlob(canvas, type="image/png", quality){
      return new Promise((resolve) => canvas.toBlob((b) => resolve(b), type, quality));
    }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    function buildMessageWorkbookArrayBuffer(){
      const wb = XLSX.utils.book_new();

      // 문자문구 시트
      const header1 = ["학년","반","번호","이름","차수(요약)","납입금명(요약)","총 미납액","문자문구"];
      const rows1 = cases.map(c => ([
        c.학년 ?? "",
        c.반 ?? "",
        (c.번호 ?? "") ? `${c.번호}번` : "",
        c.이름 ?? "",
        c.차수요약 ?? "",
        c.납입금명요약 ?? "",
        c.total ?? 0,
        buildSmsForCase(c),
      ]));
      const ws1 = XLSX.utils.aoa_to_sheet([header1, ...rows1]);
      ws1["!cols"] = [{wch:10},{wch:10},{wch:8},{wch:10},{wch:16},{wch:30},{wch:12},{wch:60}];
      XLSX.utils.book_append_sheet(wb, ws1, "문자문구");

      // 추출원본 시트(7개만)
      const header2 = ["학년","반","번호","이름","납입금명","차수(행)","미납액"];
      const rows2 = rawRows.map(r => ([
        r.학년 ?? "",
        r.반 ?? "",
        (r.번호 ?? "") ? `${r.번호}번` : "",
        r.이름 ?? "",
        r.납입금명 ?? "",
        r.차수 ?? "",
        r.미납액 ?? 0,
      ]));
      const ws2 = XLSX.utils.aoa_to_sheet([header2, ...rows2]);
      ws2["!cols"] = [{wch:10},{wch:10},{wch:8},{wch:10},{wch:22},{wch:18},{wch:12}];
      XLSX.utils.book_append_sheet(wb, ws2, "추출원본");

      return XLSX.write(wb, { bookType: "xlsx", type: "array" });
    }

    function downloadXlsxOnly(){
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const buf = buildMessageWorkbookArrayBuffer();
      const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      downloadBlob(blob, `미납_문구_${dateISO}.xlsx`);
    }

    async function buildPdfBlob(progressCb){
      const { jsPDF } = window.jspdf;
      const pageW = 1080, pageH = 1350;
      const doc = new jsPDF({ orientation: "portrait", unit: "px", format: [pageW, pageH] });

      const scale = Number(el("exportScale").value) || 1;
      const tempCanvas = document.createElement("canvas");

      const allPages = [];
      for(const c of cases){
        const pages = chunkItemsForPages(c);
        for(const p of pages) allPages.push(p);
      }

      for(let i=0;i<allPages.length;i++){
        const p = allPages[i];
        renderNoticeToCanvas(p, tempCanvas, { baseW: pageW, baseH: pageH, scale });
        const imgData = tempCanvas.toDataURL("image/jpeg", 0.92);

        if(i > 0) doc.addPage([pageW, pageH], "portrait");
        doc.addImage(imgData, "JPEG", 0, 0, pageW, pageH);

        if(progressCb) progressCb(i+1, allPages.length);
        await sleep(0);
      }

      const ab = doc.output("arraybuffer");
      return new Blob([ab], { type: "application/pdf" });
    }

    async function downloadPdfOnly(){
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      setStatus("PDF 생성중…", "");
      const pdfBlob = await buildPdfBlob((cur,total) => {
        setStatus(`PDF 생성중… (${cur}/${total})`, "");
      });
      downloadBlob(pdfBlob, `미납안내문_${dateISO}.pdf`);
      setStatus("PDF 다운로드 준비 완료 ✅", "ok");
    }

    async function downloadPngZipOnly(){
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const zip = new JSZip();
      const folder = zip.folder("notices");

      const scale = Number(el("exportScale").value) || 1;
      const tempCanvas = document.createElement("canvas");

      const pagesList = [];
      for(const c of cases){
        const pages = chunkItemsForPages(c);
        for(let i=0;i<pages.length;i++){
          pagesList.push({ base: c, page: pages[i], idx: i+1, cnt: pages.length });
        }
      }

      for(let i=0;i<pagesList.length;i++){
        const { base, page, idx, cnt } = pagesList[i];
        renderNoticeToCanvas(page, tempCanvas, { baseW: 1080, baseH: 1350, scale });
        const blob = await canvasToBlob(tempCanvas, "image/png");

        const safeName = `${dateISO}_${base.학년}${base.반}_${base.번호 ?? ""}번_${base.이름}`
          .replace(/[\/\\?%*:|"<>]/g, "_")
          .replace(/\s+/g, " ")
          .trim();

        const suffix = (cnt > 1) ? `_p${idx}` : "";
        folder.file(`${safeName}${suffix}.png`, blob);

        setStatus(`PNG ZIP 생성중… (${i+1}/${pagesList.length})`, "");
        await sleep(0);
      }

      const zipBlob = await zip.generateAsync({ type: "blob" });
      downloadBlob(zipBlob, `미납안내문_PNG_${dateISO}.zip`);
      setStatus("PNG ZIP 다운로드 준비 완료 ✅", "ok");
    }

    async function downloadAllInOneZip(){
      const btn = el("btnDownloadAllZip");
      disableWhile(btn, true, "ZIP 생성중…");

      try{
        const d = parseDateInput(el("docDate").value) || new Date();
        const dateISO = toISODate(d);

        const zip = new JSZip();

        // 1) 엑셀
        setStatus("전체 ZIP 생성중… (1/3) 문구 엑셀 생성", "");
        const xlsxBuf = buildMessageWorkbookArrayBuffer();
        zip.file(`미납_문구_${dateISO}.xlsx`, xlsxBuf);

        // 2) PNG
        setStatus("전체 ZIP 생성중… (2/3) 안내문 PNG 생성", "");
        const noticesFolder = zip.folder("notices");

        const scale = Number(el("exportScale").value) || 1;
        const tempCanvas = document.createElement("canvas");

        const pagesList = [];
        for(const c of cases){
          const pages = chunkItemsForPages(c);
          for(let i=0;i<pages.length;i++){
            pagesList.push({ base: c, page: pages[i], idx: i+1, cnt: pages.length });
          }
        }

        for(let i=0;i<pagesList.length;i++){
          const { base, page, idx, cnt } = pagesList[i];
          renderNoticeToCanvas(page, tempCanvas, { baseW: 1080, baseH: 1350, scale });
          const blob = await canvasToBlob(tempCanvas, "image/png");

          const safeName = `${dateISO}_${base.학년}${base.반}_${base.번호 ?? ""}번_${base.이름}`
            .replace(/[\/\\?%*:|"<>]/g, "_")
            .replace(/\s+/g, " ")
            .trim();

          const suffix = (cnt > 1) ? `_p${idx}` : "";
          noticesFolder.file(`${safeName}${suffix}.png`, blob);

          setStatus(`전체 ZIP 생성중… (2/3) 안내문 PNG 생성 (${i+1}/${pagesList.length})`, "");
          await sleep(0);
        }

        // 3) PDF
        setStatus("전체 ZIP 생성중… (3/3) 안내문 PDF 생성", "");
        const pdfBlob = await buildPdfBlob((cur,total) => {
          setStatus(`전체 ZIP 생성중… (3/3) 안내문 PDF 생성 (${cur}/${total})`, "");
        });
        zip.file(`미납안내문_${dateISO}.pdf`, pdfBlob);

        // ZIP
        setStatus("전체 ZIP 압축 중…", "");
        const zipBlob = await zip.generateAsync({ type: "blob" });
        downloadBlob(zipBlob, `미납_전체결과_${dateISO}.zip`);
        setStatus("전체 결과 ZIP 다운로드 준비 완료 ✅", "ok");

      }catch(err){
        console.error(err);
        setStatus(String(err?.message || err), "err");
      }finally{
        disableWhile(btn, false);
      }
    }

    async function downloadOnePng(){
      const c = getSelectedCase();
      if(!c) return;
      const d = parseDateInput(el("docDate").value) || new Date();
      const dateISO = toISODate(d);
      const scale = Number(el("exportScale").value) || 1;

      const canvas = document.createElement("canvas");
      const first = chunkItemsForPages(c)[0];
      renderNoticeToCanvas(first, canvas, { baseW: 1080, baseH: 1350, scale });

      const blob = await canvasToBlob(canvas, "image/png");
      const safeName = `${dateISO}_${c.학년}${c.반}_${c.번호 ?? ""}번_${c.이름}`
        .replace(/[\/\\?%*:|"<>]/g, "_")
        .replace(/\s+/g, " ")
        .trim();

      downloadBlob(blob, `${safeName}.png`);
    }

    async function copySelectedSms(){
      const c = getSelectedCase();
      if(!c) return;
      const msg = buildSmsForCase(c);
      try{
        await navigator.clipboard.writeText(msg);
        setStatus("선택 학생 문자 문구를 클립보드에 복사했습니다 ✅", "ok");
      }catch(_){
        el("smsPreview").focus();
        el("smsPreview").select();
        document.execCommand("copy");
        setStatus("복사 완료(대체 방식) ✅", "ok");
      }
    }

    async function copyAllSms(){
      const text = buildAllSmsText();
      try{
        await navigator.clipboard.writeText(text);
        setStatus("전체 문자 문구를 클립보드에 복사했습니다 ✅", "ok");
      }catch(_){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        setStatus("전체 복사 완료(대체 방식) ✅", "ok");
      }
    }

    /***********************
     * 업로드/드롭: 파일만 pending 저장(추출은 버튼)
     ***********************/
    function setupDropzone(){
      const dz = el("dropZone");
      const input = el("excelFile");

      function openPicker(){ input.click(); }

      dz.addEventListener("click", openPicker);
      dz.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openPicker();
        }
      });

      input.addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if(!file) return;
        if(!/\.xlsx?$/.test(file.name.toLowerCase())){
          setStatus("엑셀(.xlsx/.xls) 파일만 업로드할 수 있습니다.", "err");
          input.value = "";
          return;
        }
        setPendingFile(file);
        input.value = "";
      });

      dz.addEventListener("dragenter", (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add("is-dragover"); });
      dz.addEventListener("dragover",  (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add("is-dragover"); });
      dz.addEventListener("dragleave", (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.remove("is-dragover"); });

      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dz.classList.remove("is-dragover");

        const file = e.dataTransfer?.files?.[0];
        if(!file) return;
        if(!/\.xlsx?$/.test(file.name.toLowerCase())){
          setStatus("엑셀(.xlsx/.xls) 파일만 업로드할 수 있습니다.", "err");
          return;
        }
        setPendingFile(file);
      });
    }

    /***********************
     * 추출 실행(버튼)
     ***********************/
    async function runExtract(){
      if(!pendingFile){
        setStatus("먼저 엑셀 파일을 업로드하세요.", "err");
        return;
      }

      const btn = el("btnExtract");
      disableWhile(btn, true, "추출중…");

      try{
        setStatus(`엑셀 읽는 중…\n- ${pendingFile.name}`, "");
        const buf = await pendingFile.arrayBuffer();

        const parsed = parseXlsx(buf);
        rawRows = parsed.rows;

        if(!rawRows.length){
          throw new Error("추출된 데이터가 없습니다. (이름/납입금명/미납액이 있는 행을 확인하세요)");
        }

        cases = buildCasesFromRaw(rawRows);
        renderAll();

        // ✅ 어떤 헤더로 매칭했는지 표시(검증용)
        const m = parsed.meta.matchedHeaders;
        const withTermCount = rawRows.filter(r => String(r.차수||"").trim()).length;
        const defaultTerm = el("roundText").value.trim();

        setStatus(
          `추출 완료 ✅\n- 행 단위: ${rawRows.length}건\n- 학생별 통합: ${cases.length}건\n- 차수(행) 값이 있는 행: ${withTermCount}건\n- 차수 기본값: ${defaultTerm ? defaultTerm : "(비어있음)"}\n\n[매칭된 헤더]\n- 학년: ${m.학년}\n- 반: ${m.반}\n- 번호: ${m.번호}\n- 이름: ${m.이름}\n- 납입금명: ${m.납입금명}\n- 차수: ${m.차수}\n- 미납액: ${m.미납액}`,
          "ok"
        );

        saveSettings();
      }catch(err){
        console.error(err);
        clearResults();
        setStatus(String(err?.message || err), "err");
      }finally{
        disableWhile(btn, false);
      }
    }

    /***********************
     * 이벤트
     ***********************/
    el("btnApplyPreset").addEventListener("click", () => {
      applyPreset(BASE_PRESET, true);
      setStatus("기본 프리셋 적용 완료 ✅", "ok");
    });

    el("btnReset").addEventListener("click", () => {
      setPendingFile(null);
      clearResults();

      el("schoolName").value = "";
      el("bankName").value = "";
      el("accountNumber").value = "";
      el("roundText").value = "";
      el("dueDate").value = "";
      el("docDate").value = toISODate(new Date());
      el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;

      applyPreset(BASE_PRESET, false);
      localStorage.removeItem(STORAGE_KEY);
      saveSettings();

      setStatus("초기화 완료. 엑셀을 업로드하고 추출하기를 누르세요.", "");
    });

    el("btnExtract").addEventListener("click", () => runExtract());
    el("btnClearFile").addEventListener("click", () => setPendingFile(null));

    el("caseSelect").addEventListener("change", (ev) => {
      selectedCaseKey = ev.target.value;
      updatePreview();
      saveSettings();
    });

    el("btnDownloadAllZip").addEventListener("click", () => cases.length && downloadAllInOneZip());
    el("btnCopyAllSms").addEventListener("click", () => cases.length && copyAllSms());

    el("btnDownloadXlsxOnly").addEventListener("click", () => cases.length && downloadXlsxOnly());
    el("btnDownloadPngZipOnly").addEventListener("click", () => cases.length && downloadPngZipOnly());
    el("btnDownloadPdfOnly").addEventListener("click", () => cases.length && downloadPdfOnly());

    el("btnOnePng").addEventListener("click", () => downloadOnePng());
    el("btnCopySms").addEventListener("click", () => copySelectedSms());

    // 변경 감지 → 미리보기 업데이트 + 저장
    const watchIds = [
      "schoolName","bankName","accountNumber","roundText",
      "dueDate","docDate","labelTheme","exportScale","smsTemplate",
      "cfg_boxMargin","cfg_boxBottomMargin","cfg_titleTop","cfg_boxTopGap",
      "cfg_outerLine","cfg_innerLine","cfg_topRowH","cfg_moneyRowH",
      "cfg_headH","cfg_rowH","cfg_sumH","cfg_slots",
      "cfg_col1","cfg_col2","cfg_titleSize","cfg_titleSpacing",
      "cfg_labelSize","cfg_valueSize","cfg_tableSize","cfg_dateSize"
    ];
    for(const id of watchIds){
      el(id).addEventListener("input", () => { updatePreview(); saveSettings(); });
      el(id).addEventListener("change", () => { updatePreview(); saveSettings(); });
    }

    /***********************
     * 초기 로드
     ***********************/
    (function init(){
      setupDropzone();

      const hasSaved = loadSettings();
      if(!el("smsTemplate").value.trim()) el("smsTemplate").value = DEFAULT_SMS_TEMPLATE;
      if(!el("docDate").value) el("docDate").value = toISODate(new Date());

      if(!hasSaved){
        applyPreset(BASE_PRESET, false);
        saveSettings();
      }

      enableActions(false);
      setPendingFile(null);
      setStatus("대기중… 엑셀 업로드 후 ‘추출하기’를 누르세요.", "");
    })();
  </script>

  <!-- ✅ 요청하신 공통 JS (</body> 직전) -->
  <script src="/static/disable-copy.js"></script>
  <script src="/static/footer.js"></script>
  <script src="/static/global-loader.js?v=1"></script>
</body>
</html>
